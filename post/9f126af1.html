<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"timewait7.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="我为你设计一个简易HTTP服务器项目，这个项目涵盖了C语言在企业级开发中的核心技能，并包含了运维调试实践。 阶段1：基础框架搭建 - 单线程HTTP服务器1.1 创建项目目录结构12mkdir -p http-server&#x2F;&#123;src,include,logs,static&#125;cd http-server    1.2 实现日志模块（logger.h）123456789101112">
<meta property="og:type" content="article">
<meta property="og:title" content="C实践-HTTP服务器">
<meta property="og:url" content="http://timewait7.github.io/post/9f126af1.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="我为你设计一个简易HTTP服务器项目，这个项目涵盖了C语言在企业级开发中的核心技能，并包含了运维调试实践。 阶段1：基础框架搭建 - 单线程HTTP服务器1.1 创建项目目录结构12mkdir -p http-server&#x2F;&#123;src,include,logs,static&#125;cd http-server    1.2 实现日志模块（logger.h）123456789101112">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-12-17T11:13:03.000Z">
<meta property="article:modified_time" content="2025-12-19T15:29:03.021Z">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://timewait7.github.io/post/9f126af1.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://timewait7.github.io/post/9f126af1.html","path":"post/9f126af1.html","title":"C实践-HTTP服务器"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>C实践-HTTP服务器 | Hexo</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-archives"><a href="/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="Searching..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%98%B6%E6%AE%B51%EF%BC%9A%E5%9F%BA%E7%A1%80%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA-%E5%8D%95%E7%BA%BF%E7%A8%8BHTTP%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">1.</span> <span class="nav-text">阶段1：基础框架搭建 - 单线程HTTP服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 创建项目目录结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E5%AE%9E%E7%8E%B0%E6%97%A5%E5%BF%97%E6%A8%A1%E5%9D%97%EF%BC%88logger-h%EF%BC%89"><span class="nav-number">1.2.</span> <span class="nav-text">1.2 实现日志模块（logger.h）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-%E5%AE%9E%E7%8E%B0%E6%97%A5%E5%BF%97%E6%A8%A1%E5%9D%97%EF%BC%88logger-c%EF%BC%89"><span class="nav-number">1.3.</span> <span class="nav-text">1.3 实现日志模块（logger.c）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-%E5%AE%9E%E7%8E%B0%E4%B8%BB%E7%A8%8B%E5%BA%8F%EF%BC%88main-c%EF%BC%89"><span class="nav-number">1.4.</span> <span class="nav-text">1.4 实现主程序（main.c）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-%E5%88%9B%E5%BB%BAMakefile"><span class="nav-number">1.5.</span> <span class="nav-text">1.5 创建Makefile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-6-%E5%88%9B%E5%BB%BA%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6"><span class="nav-number">1.6.</span> <span class="nav-text">1.6 创建静态文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-7-%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC"><span class="nav-number">1.7.</span> <span class="nav-text">1.7 测试脚本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-8-%E7%BC%96%E8%AF%91%E5%92%8C%E8%BF%90%E8%A1%8C"><span class="nav-number">1.8.</span> <span class="nav-text">1.8 编译和运行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-9-%E8%B0%83%E8%AF%95%E6%8C%87%E5%8D%97"><span class="nav-number">1.9.</span> <span class="nav-text">1.9 调试指南</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-10-%E6%80%BB%E7%BB%93"><span class="nav-number">1.10.</span> <span class="nav-text">1.10 总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%98%B6%E6%AE%B52%EF%BC%9A%E5%AE%9E%E7%8E%B0%E5%AE%8C%E6%95%B4%E7%9A%84%E8%AF%B7%E6%B1%82%E8%A7%A3%E6%9E%90%E5%92%8C%E5%93%8D%E5%BA%94%E6%9E%84%E5%BB%BA"><span class="nav-number">2.</span> <span class="nav-text">阶段2：实现完整的请求解析和响应构建</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E5%88%9B%E5%BB%BA%E8%AF%B7%E6%B1%82%E8%A7%A3%E6%9E%90%E6%A8%A1%E5%9D%97"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 创建请求解析模块</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-1-%E8%AF%B7%E6%B1%82%E5%A4%B4%E6%96%87%E4%BB%B6%EF%BC%88request-h%EF%BC%89"><span class="nav-number">2.1.0.1.</span> <span class="nav-text">2.1.1 请求头文件（request.h）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-2-%E8%AF%B7%E6%B1%82%E8%A7%A3%E6%9E%90%E5%AE%9E%E7%8E%B0%EF%BC%88request-c%EF%BC%89"><span class="nav-number">2.1.1.</span> <span class="nav-text">2.1.2 请求解析实现（request.c）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E5%88%9B%E5%BB%BA%E5%93%8D%E5%BA%94%E6%9E%84%E5%BB%BA%E6%A8%A1%E5%9D%97"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 创建响应构建模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-1-%E5%93%8D%E5%BA%94%E5%A4%B4%E6%96%87%E4%BB%B6%EF%BC%88response-h%EF%BC%89"><span class="nav-number">2.2.1.</span> <span class="nav-text">2.2.1 响应头文件（response.h）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-2-%E5%93%8D%E5%BA%94%E6%9E%84%E5%BB%BA%E5%AE%9E%E7%8E%B0%EF%BC%88response-c%EF%BC%89"><span class="nav-number">2.2.2.</span> <span class="nav-text">2.2.2 响应构建实现（response.c）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-%E6%9B%B4%E6%96%B0%E4%B8%BB%E7%A8%8B%E5%BA%8F%E4%BB%A5%E4%BD%BF%E7%94%A8%E6%96%B0%E7%9A%84%E6%A8%A1%E5%9D%97"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 更新主程序以使用新的模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-1-%E6%9B%B4%E6%96%B0main-c"><span class="nav-number">2.3.1.</span> <span class="nav-text">2.3.1 更新main.c</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-%E6%9B%B4%E6%96%B0Makefile"><span class="nav-number">2.4.</span> <span class="nav-text">2.4 更新Makefile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-%E5%88%9B%E5%BB%BA%E7%A4%BA%E4%BE%8B%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E5%92%8C%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC"><span class="nav-number">2.5.</span> <span class="nav-text">2.5 创建示例静态文件和测试脚本</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-1-%E5%88%9B%E5%BB%BA%E7%A4%BA%E4%BE%8B%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95"><span class="nav-number">2.5.1.</span> <span class="nav-text">2.5.1 创建示例静态文件目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-2-%E5%88%9B%E5%BB%BA%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC"><span class="nav-number">2.5.2.</span> <span class="nav-text">2.5.2 创建测试脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-6-%E7%BC%96%E8%AF%91%E5%92%8C%E6%B5%8B%E8%AF%95"><span class="nav-number">2.6.</span> <span class="nav-text">2.6 编译和测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-1-%E5%88%9D%E5%A7%8B%E5%8C%96%E9%A1%B9%E7%9B%AE"><span class="nav-number">2.6.1.</span> <span class="nav-text">2.6.1 初始化项目</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-2-%E8%BF%90%E8%A1%8C%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">2.6.2.</span> <span class="nav-text">2.6.2 运行服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-3-%E6%B5%8B%E8%AF%95%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">2.6.3.</span> <span class="nav-text">2.6.3 测试服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-4-%E8%B0%83%E8%AF%95%E5%92%8C%E4%BC%98%E5%8C%96"><span class="nav-number">2.6.4.</span> <span class="nav-text">2.6.4 调试和优化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-7-%E6%80%BB%E7%BB%93"><span class="nav-number">2.7.</span> <span class="nav-text">2.7 总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%8A%9F%E8%83%BD%EF%BC%9A"><span class="nav-number">2.7.1.</span> <span class="nav-text">实现的功能：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%A6%E5%88%B0%E7%9A%84%E6%8A%80%E8%83%BD%EF%BC%9A"><span class="nav-number">2.7.2.</span> <span class="nav-text">学到的技能：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E7%BB%B4%E5%92%8C%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7%EF%BC%9A"><span class="nav-number">2.7.3.</span> <span class="nav-text">运维和调试技巧：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%98%B6%E6%AE%B53%EF%BC%9A%E5%AE%9E%E7%8E%B0%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%92%8C%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%94%AF%E6%8C%81"><span class="nav-number">3.</span> <span class="nav-text">阶段3：实现线程池和多线程支持</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E5%88%9B%E5%BB%BA%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%A8%A1%E5%9D%97"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 创建线程池模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-1-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%A4%B4%E6%96%87%E4%BB%B6%EF%BC%88thread-pool-h%EF%BC%89"><span class="nav-number">3.1.1.</span> <span class="nav-text">3.1.1 线程池头文件（thread_pool.h）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-2-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%AE%9E%E7%8E%B0%EF%BC%88thread-pool-c%EF%BC%89"><span class="nav-number">3.1.2.</span> <span class="nav-text">3.1.2 线程池实现（thread_pool.c）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E6%9B%B4%E6%96%B0%E8%BF%9E%E6%8E%A5%E5%A4%84%E7%90%86%E5%99%A8%E6%A8%A1%E5%9D%97"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 更新连接处理器模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-1-%E8%BF%9E%E6%8E%A5%E5%A4%84%E7%90%86%E5%99%A8%E5%A4%B4%E6%96%87%E4%BB%B6%EF%BC%88connection-h%EF%BC%89"><span class="nav-number">3.2.1.</span> <span class="nav-text">3.2.1 连接处理器头文件（connection.h）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-2-%E8%BF%9E%E6%8E%A5%E5%A4%84%E7%90%86%E5%99%A8%E5%AE%9E%E7%8E%B0%EF%BC%88connection-c%EF%BC%89"><span class="nav-number">3.2.2.</span> <span class="nav-text">3.2.2 连接处理器实现（connection.c）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E6%9B%B4%E6%96%B0%E4%B8%BB%E7%A8%8B%E5%BA%8F%E4%BB%A5%E4%BD%BF%E7%94%A8%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 更新主程序以使用线程池</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-1-%E6%9B%B4%E6%96%B0main-c%EF%BC%88%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%89%88%E6%9C%AC%EF%BC%89"><span class="nav-number">3.3.1.</span> <span class="nav-text">3.3.1 更新main.c（线程池版本）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-%E6%9B%B4%E6%96%B0Makefile"><span class="nav-number">3.4.</span> <span class="nav-text">3.4 更新Makefile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-%E5%88%9B%E5%BB%BA%E6%B5%8B%E8%AF%95%E5%92%8C%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E8%84%9A%E6%9C%AC"><span class="nav-number">3.5.</span> <span class="nav-text">3.5 创建测试和性能分析脚本</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-1-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC"><span class="nav-number">3.5.1.</span> <span class="nav-text">3.5.1 线程池测试脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-2-%E6%80%A7%E8%83%BD%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC"><span class="nav-number">3.5.2.</span> <span class="nav-text">3.5.2 性能基准测试脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-3-%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC"><span class="nav-number">3.5.3.</span> <span class="nav-text">3.5.3 压力测试脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-6-%E7%BC%96%E8%AF%91%E5%92%8C%E6%B5%8B%E8%AF%95"><span class="nav-number">3.6.</span> <span class="nav-text">3.6 编译和测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-1-%E5%88%9D%E5%A7%8B%E5%8C%96%E9%A1%B9%E7%9B%AE"><span class="nav-number">3.6.1.</span> <span class="nav-text">3.6.1 初始化项目</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-2-%E8%BF%90%E8%A1%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">3.6.2.</span> <span class="nav-text">3.6.2 运行线程池服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-3-%E8%BF%90%E8%A1%8C%E6%B5%8B%E8%AF%95"><span class="nav-number">3.6.3.</span> <span class="nav-text">3.6.3 运行测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-4-%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%92%8C%E8%B0%83%E8%AF%95"><span class="nav-number">3.6.4.</span> <span class="nav-text">3.6.4 性能分析和调试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-5-%E6%B5%8B%E8%AF%95%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%84%9A%E6%9C%AC"><span class="nav-number">3.6.5.</span> <span class="nav-text">3.6.5 测试客户端脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-7-%E6%80%BB%E7%BB%93"><span class="nav-number">3.7.</span> <span class="nav-text">3.7 总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%8A%9F%E8%83%BD%EF%BC%9A-1"><span class="nav-number">3.7.1.</span> <span class="nav-text">实现的功能：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%A6%E5%88%B0%E7%9A%84%E6%8A%80%E8%83%BD%EF%BC%9A-1"><span class="nav-number">3.7.2.</span> <span class="nav-text">学到的技能：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E7%BB%B4%E5%92%8C%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7%EF%BC%9A-1"><span class="nav-number">3.7.3.</span> <span class="nav-text">运维和调试技巧：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94%E7%BB%93%E6%9E%9C%EF%BC%9A"><span class="nav-number">3.7.4.</span> <span class="nav-text">性能对比结果：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%98%B6%E6%AE%B54%EF%BC%9A%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E3%80%81SSL%E6%94%AF%E6%8C%81%E5%92%8C%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD"><span class="nav-number">4.</span> <span class="nav-text">阶段4：配置管理、SSL支持和高级功能</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 配置文件管理模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-1-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%A4%B4%E6%96%87%E4%BB%B6%EF%BC%88config-h%EF%BC%89"><span class="nav-number">4.1.1.</span> <span class="nav-text">4.1.1 配置文件头文件（config.h）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-2-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%AE%9E%E7%8E%B0%EF%BC%88config-c%EF%BC%89"><span class="nav-number">4.1.2.</span> <span class="nav-text">4.1.2 配置文件实现（config.c）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-SSL-TLS%E6%94%AF%E6%8C%81%E6%A8%A1%E5%9D%97"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 SSL&#x2F;TLS支持模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-1-SSL%E5%A4%B4%E6%96%87%E4%BB%B6%EF%BC%88ssl-wrapper-h%EF%BC%89"><span class="nav-number">4.2.1.</span> <span class="nav-text">4.2.1 SSL头文件（ssl_wrapper.h）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-2-SSL%E5%AE%9E%E7%8E%B0%EF%BC%88ssl-wrapper-c%EF%BC%89"><span class="nav-number">4.2.2.</span> <span class="nav-text">4.2.2 SSL实现（ssl_wrapper.c）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-%E6%9B%B4%E6%96%B0%E4%B8%BB%E7%A8%8B%E5%BA%8F%E4%BB%A5%E6%94%AF%E6%8C%81%E9%85%8D%E7%BD%AE%E5%92%8CSSL"><span class="nav-number">4.3.</span> <span class="nav-text">4.3 更新主程序以支持配置和SSL</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-1-%E6%9B%B4%E6%96%B0main-c%EF%BC%88%E5%AE%8C%E6%95%B4%E7%89%88%EF%BC%89"><span class="nav-number">4.3.1.</span> <span class="nav-text">4.3.1 更新main.c（完整版）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%A4%BA%E4%BE%8B"><span class="nav-number">4.4.</span> <span class="nav-text">4.4 创建配置文件示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-1-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%A4%BA%E4%BE%8B"><span class="nav-number">4.4.1.</span> <span class="nav-text">4.4.1 配置文件示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-2-%E5%88%9B%E5%BB%BA%E8%87%AA%E7%AD%BE%E5%90%8D%E8%AF%81%E4%B9%A6%E8%84%9A%E6%9C%AC"><span class="nav-number">4.4.2.</span> <span class="nav-text">4.4.2 创建自签名证书脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-5-%E6%9B%B4%E6%96%B0Makefile"><span class="nav-number">4.5.</span> <span class="nav-text">4.5 更新Makefile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-6-%E5%88%9B%E5%BB%BA%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC"><span class="nav-number">4.6.</span> <span class="nav-text">4.6 创建测试脚本</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6-1-%E5%AE%8C%E6%95%B4%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC"><span class="nav-number">4.6.1.</span> <span class="nav-text">4.6.1 完整测试脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6-2-SSL%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC"><span class="nav-number">4.6.2.</span> <span class="nav-text">4.6.2 SSL测试脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6-3-%E9%85%8D%E7%BD%AE%E9%87%8D%E8%BD%BD%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC"><span class="nav-number">4.6.3.</span> <span class="nav-text">4.6.3 配置重载测试脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-7-%E7%BC%96%E8%AF%91%E5%92%8C%E6%B5%8B%E8%AF%95"><span class="nav-number">4.7.</span> <span class="nav-text">4.7 编译和测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-7-1-%E5%88%9D%E5%A7%8B%E5%8C%96%E9%A1%B9%E7%9B%AE"><span class="nav-number">4.7.1.</span> <span class="nav-text">4.7.1 初始化项目</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-7-2-%E8%BF%90%E8%A1%8C%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">4.7.2.</span> <span class="nav-text">4.7.2 运行服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-7-3-%E8%BF%90%E8%A1%8C%E6%B5%8B%E8%AF%95"><span class="nav-number">4.7.3.</span> <span class="nav-text">4.7.3 运行测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-7-4-%E9%AB%98%E7%BA%A7%E8%B0%83%E8%AF%95%E5%92%8C%E7%9B%91%E6%8E%A7"><span class="nav-number">4.7.4.</span> <span class="nav-text">4.7.4 高级调试和监控</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-8-%E6%80%BB%E7%BB%93"><span class="nav-number">4.8.</span> <span class="nav-text">4.8 总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%8A%9F%E8%83%BD%EF%BC%9A-2"><span class="nav-number">4.8.1.</span> <span class="nav-text">实现的功能：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%A6%E5%88%B0%E7%9A%84%E6%8A%80%E8%83%BD%EF%BC%9A-2"><span class="nav-number">4.8.2.</span> <span class="nav-text">学到的技能：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E7%BB%B4%E5%92%8C%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7%EF%BC%9A-2"><span class="nav-number">4.8.3.</span> <span class="nav-text">运维和调试技巧：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%9A"><span class="nav-number">4.8.4.</span> <span class="nav-text">实际应用场景：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%98%B6%E6%AE%B55%EF%BC%9A%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7%E6%89%A9%E5%B1%95"><span class="nav-number">5.</span> <span class="nav-text">阶段5：高级特性扩展</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-%E7%BC%93%E5%AD%98%E7%B3%BB%E7%BB%9F"><span class="nav-number">5.1.</span> <span class="nav-text">5.1 缓存系统</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-1-%E7%BC%93%E5%AD%98%E5%A4%B4%E6%96%87%E4%BB%B6%EF%BC%88cache-h%EF%BC%89"><span class="nav-number">5.1.1.</span> <span class="nav-text">5.1.1 缓存头文件（cache.h）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-2-%E7%BC%93%E5%AD%98%E5%AE%9E%E7%8E%B0%EF%BC%88cache-c%EF%BC%89"><span class="nav-number">5.1.2.</span> <span class="nav-text">5.1.2 缓存实现（cache.c）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-WebSocket%E6%94%AF%E6%8C%81"><span class="nav-number">5.2.</span> <span class="nav-text">5.2 WebSocket支持</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-1-WebSocket%E5%A4%B4%E6%96%87%E4%BB%B6%EF%BC%88websocket-h%EF%BC%89"><span class="nav-number">5.2.1.</span> <span class="nav-text">5.2.1 WebSocket头文件（websocket.h）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-2-WebSocket%E5%AE%9E%E7%8E%B0%EF%BC%88websocket-c%EF%BC%89"><span class="nav-number">5.2.2.</span> <span class="nav-text">5.2.2 WebSocket实现（websocket.c）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-API%E7%BD%91%E5%85%B3%E7%89%B9%E6%80%A7"><span class="nav-number">5.3.</span> <span class="nav-text">5.3 API网关特性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-1-API%E7%BD%91%E5%85%B3%E5%A4%B4%E6%96%87%E4%BB%B6%EF%BC%88gateway-h%EF%BC%89"><span class="nav-number">5.3.1.</span> <span class="nav-text">5.3.1 API网关头文件（gateway.h）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-2-API%E7%BD%91%E5%85%B3%E5%AE%9E%E7%8E%B0%EF%BC%88gateway-c%EF%BC%89"><span class="nav-number">5.3.2.</span> <span class="nav-text">5.3.2 API网关实现（gateway.c）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-4-%E9%9B%86%E6%88%90%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7%E5%88%B0%E4%B8%BB%E7%A8%8B%E5%BA%8F"><span class="nav-number">5.4.</span> <span class="nav-text">5.4 集成高级特性到主程序</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-1-%E6%9B%B4%E6%96%B0%E9%85%8D%E7%BD%AE%E7%BB%93%E6%9E%84"><span class="nav-number">5.4.1.</span> <span class="nav-text">5.4.1 更新配置结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-2-%E6%9B%B4%E6%96%B0%E4%B8%BB%E7%A8%8B%E5%BA%8F"><span class="nav-number">5.4.2.</span> <span class="nav-text">5.4.2 更新主程序</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-5-%E5%88%9B%E5%BB%BA%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC"><span class="nav-number">5.5.</span> <span class="nav-text">5.5 创建测试脚本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-6-%E6%80%BB%E7%BB%93"><span class="nav-number">5.6.</span> <span class="nav-text">5.6 总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%8A%9F%E8%83%BD%EF%BC%9A-3"><span class="nav-number">5.6.1.</span> <span class="nav-text">实现的功能：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%A6%E5%88%B0%E7%9A%84%E6%8A%80%E8%83%BD%EF%BC%9A-3"><span class="nav-number">5.6.2.</span> <span class="nav-text">学到的技能：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%9A-1"><span class="nav-number">5.6.3.</span> <span class="nav-text">实际应用场景：</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/">
          <span class="site-state-item-count">52</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://timewait7.github.io/post/9f126af1.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="C实践-HTTP服务器 | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          C实践-HTTP服务器
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-12-17 19:13:03" itemprop="dateCreated datePublished" datetime="2025-12-17T19:13:03+08:00">2025-12-17</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>37k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>2:13</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>我为你设计一个<strong>简易HTTP服务器</strong>项目，这个项目涵盖了C语言在企业级开发中的核心技能，并包含了运维调试实践。</p>
<h1 id="阶段1：基础框架搭建-单线程HTTP服务器"><a href="#阶段1：基础框架搭建-单线程HTTP服务器" class="headerlink" title="阶段1：基础框架搭建 - 单线程HTTP服务器"></a>阶段1：基础框架搭建 - 单线程HTTP服务器</h1><h2 id="1-1-创建项目目录结构"><a href="#1-1-创建项目目录结构" class="headerlink" title="1.1 创建项目目录结构"></a>1.1 创建项目目录结构</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p http-server/&#123;src,include,logs,static&#125;</span><br><span class="line"><span class="built_in">cd</span> http-server</span><br></pre></td></tr></table></figure>



<h2 id="1-2-实现日志模块（logger-h）"><a href="#1-2-实现日志模块（logger-h）" class="headerlink" title="1.2 实现日志模块（logger.h）"></a>1.2 实现日志模块（logger.h）</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/logger.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> LOGGER_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGGER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 日志级别枚举</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    LOG_LEVEL_DEBUG = <span class="number">0</span>,</span><br><span class="line">    LOG_LEVEL_INFO,</span><br><span class="line">    LOG_LEVEL_WARNING,</span><br><span class="line">    LOG_LEVEL_ERROR</span><br><span class="line">&#125; LogLevel;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 日志模块初始化</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">logger_init</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *log_file, LogLevel level)</span>;</span><br><span class="line"><span class="comment">// 记录日志</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">logger_log</span><span class="params">(LogLevel level, <span class="type">const</span> <span class="type">char</span> *file, <span class="type">int</span> line, <span class="type">const</span> <span class="type">char</span> *format, ...)</span>;</span><br><span class="line"><span class="comment">// 清理日志模块</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">logger_cleanup</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 便捷宏定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_DEBUG(format, ...) logger_log(LOG_LEVEL_DEBUG, __FILE__, __LINE__, format, ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_INFO(format, ...)  logger_log(LOG_LEVEL_INFO, __FILE__, __LINE__, format, ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_WARNING(format, ...) logger_log(LOG_LEVEL_WARNING, __FILE__, __LINE__, format, ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_ERROR(format, ...) logger_log(LOG_LEVEL_ERROR, __FILE__, __LINE__, format, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// LOGGER_H</span></span></span><br></pre></td></tr></table></figure>



<h2 id="1-3-实现日志模块（logger-c）"><a href="#1-3-实现日志模块（logger-c）" class="headerlink" title="1.3 实现日志模块（logger.c）"></a>1.3 实现日志模块（logger.c）</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/logger.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/logger.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line"><span class="type">static</span> FILE *log_fp = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">static</span> LogLevel current_log_level = LOG_LEVEL_INFO;</span><br><span class="line"><span class="type">static</span> <span class="type">pthread_mutex_t</span> log_mutex = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取当前时间字符串</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span>* <span class="title function_">get_current_time</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> time_buffer[<span class="number">64</span>];</span><br><span class="line">    <span class="type">time_t</span> raw_time;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tm</span> *<span class="title">time_info</span>;</span></span><br><span class="line">    </span><br><span class="line">    time(&amp;raw_time);</span><br><span class="line">    time_info = localtime(&amp;raw_time);</span><br><span class="line">    </span><br><span class="line">    strftime(time_buffer, <span class="keyword">sizeof</span>(time_buffer), <span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>, time_info);</span><br><span class="line">    <span class="keyword">return</span> time_buffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取日志级别字符串</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span>* <span class="title function_">get_level_string</span><span class="params">(LogLevel level)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (level) &#123;</span><br><span class="line">        <span class="keyword">case</span> LOG_LEVEL_DEBUG:   <span class="keyword">return</span> <span class="string">&quot;DEBUG&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> LOG_LEVEL_INFO:    <span class="keyword">return</span> <span class="string">&quot;INFO&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> LOG_LEVEL_WARNING: <span class="keyword">return</span> <span class="string">&quot;WARNING&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> LOG_LEVEL_ERROR:   <span class="keyword">return</span> <span class="string">&quot;ERROR&quot;</span>;</span><br><span class="line">        <span class="keyword">default</span>:                <span class="keyword">return</span> <span class="string">&quot;UNKNOWN&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化日志系统</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">logger_init</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *log_file, LogLevel level)</span> &#123;</span><br><span class="line">    pthread_mutex_lock(&amp;log_mutex);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果已经初始化，先关闭</span></span><br><span class="line">    <span class="keyword">if</span> (log_fp &amp;&amp; log_fp != <span class="built_in">stderr</span> &amp;&amp; log_fp != <span class="built_in">stdout</span>) &#123;</span><br><span class="line">        fclose(log_fp);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    current_log_level = level;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (log_file == <span class="literal">NULL</span> || <span class="built_in">strcmp</span>(log_file, <span class="string">&quot;stdout&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        log_fp = <span class="built_in">stdout</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(log_file, <span class="string">&quot;stderr&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        log_fp = <span class="built_in">stderr</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log_fp = fopen(log_file, <span class="string">&quot;a&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (log_fp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Failed to open log file: %s, using stdout\n&quot;</span>, log_file);</span><br><span class="line">            log_fp = <span class="built_in">stdout</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_unlock(&amp;log_mutex);</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Logger initialized with level: %s&quot;</span>, get_level_string(level));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录日志</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">logger_log</span><span class="params">(LogLevel level, <span class="type">const</span> <span class="type">char</span> *file, <span class="type">int</span> line, <span class="type">const</span> <span class="type">char</span> *format, ...)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (level &lt; current_log_level) &#123;</span><br><span class="line">        <span class="keyword">return</span>;  <span class="comment">// 低于当前日志级别，不记录</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_lock(&amp;log_mutex);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (log_fp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        log_fp = <span class="built_in">stdout</span>;  <span class="comment">// 默认输出到stdout</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取文件名（去掉路径）</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *filename = <span class="built_in">strrchr</span>(file, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (filename == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        filename = file;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        filename++;  <span class="comment">// 跳过&#x27;/&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 输出日志头</span></span><br><span class="line">    <span class="built_in">fprintf</span>(log_fp, <span class="string">&quot;[%s] [%s] [%s:%d] &quot;</span>,</span><br><span class="line">            get_current_time(),</span><br><span class="line">            get_level_string(level),</span><br><span class="line">            filename,</span><br><span class="line">            line);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 输出日志内容</span></span><br><span class="line">    va_list args;</span><br><span class="line">    va_start(args, format);</span><br><span class="line">    <span class="built_in">vfprintf</span>(log_fp, format, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">fprintf</span>(log_fp, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    fflush(log_fp);  <span class="comment">// 立即刷新，确保日志不丢失</span></span><br><span class="line">    </span><br><span class="line">    pthread_mutex_unlock(&amp;log_mutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清理日志系统</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">logger_cleanup</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    pthread_mutex_lock(&amp;log_mutex);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (log_fp &amp;&amp; log_fp != <span class="built_in">stdout</span> &amp;&amp; log_fp != <span class="built_in">stderr</span>) &#123;</span><br><span class="line">        fclose(log_fp);</span><br><span class="line">        log_fp = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_unlock(&amp;log_mutex);</span><br><span class="line">    pthread_mutex_destroy(&amp;log_mutex);</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Logger cleanup completed&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="1-4-实现主程序（main-c）"><a href="#1-4-实现主程序（main-c）" class="headerlink" title="1.4 实现主程序（main.c）"></a>1.4 实现主程序（main.c）</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/logger.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFAULT_PORT 8080</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE 4096</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BACKLOG 10  <span class="comment">// 最大等待连接数</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局变量，用于优雅关闭</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">volatile</span> <span class="type">int</span> running = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 信号处理函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">signal_handler</span><span class="params">(<span class="type">int</span> sig)</span> &#123;</span><br><span class="line">    LOG_INFO(<span class="string">&quot;Received signal %d, shutting down gracefully...&quot;</span>, sig);</span><br><span class="line">    running = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简单的HTTP响应函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">send_http_response</span><span class="params">(<span class="type">int</span> client_socket, <span class="type">int</span> status_code, <span class="type">const</span> <span class="type">char</span> *status_msg, </span></span><br><span class="line"><span class="params">                       <span class="type">const</span> <span class="type">char</span> *content_type, <span class="type">const</span> <span class="type">char</span> *body)</span> &#123;</span><br><span class="line">    <span class="type">char</span> response[BUFFER_SIZE];</span><br><span class="line">    <span class="type">int</span> content_length = <span class="built_in">strlen</span>(body);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建HTTP响应头</span></span><br><span class="line">    <span class="type">int</span> header_len = <span class="built_in">snprintf</span>(response, <span class="keyword">sizeof</span>(response),</span><br><span class="line">        <span class="string">&quot;HTTP/1.1 %d %s\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Content-Type: %s\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Content-Length: %d\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Connection: close\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Server: Simple-C-Server/1.0\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;\r\n&quot;</span>,  <span class="comment">// 注意：空行分隔头和体</span></span><br><span class="line">        status_code, status_msg, content_type, content_length);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发送响应头</span></span><br><span class="line">    send(client_socket, response, header_len, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发送响应体</span></span><br><span class="line">    send(client_socket, body, content_length, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理客户端连接</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handle_client</span><span class="params">(<span class="type">int</span> client_socket, <span class="keyword">struct</span> sockaddr_in *client_addr)</span> &#123;</span><br><span class="line">    <span class="type">char</span> buffer[BUFFER_SIZE];</span><br><span class="line">    <span class="type">ssize_t</span> bytes_received;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取客户端IP和端口</span></span><br><span class="line">    <span class="type">char</span> client_ip[INET_ADDRSTRLEN];</span><br><span class="line">    inet_ntop(AF_INET, &amp;(client_addr-&gt;sin_addr), client_ip, INET_ADDRSTRLEN);</span><br><span class="line">    <span class="type">int</span> client_port = ntohs(client_addr-&gt;sin_port);</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;New connection from %s:%d&quot;</span>, client_ip, client_port);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 接收HTTP请求</span></span><br><span class="line">    bytes_received = recv(client_socket, buffer, BUFFER_SIZE - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (bytes_received &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        buffer[bytes_received] = <span class="string">&#x27;\0&#x27;</span>;  <span class="comment">// 确保字符串终止</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 简单的请求解析</span></span><br><span class="line">        LOG_DEBUG(<span class="string">&quot;Received request:\n%.*s&quot;</span>, (<span class="type">int</span>)bytes_received, buffer);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查是否是GET请求</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strncmp</span>(buffer, <span class="string">&quot;GET &quot;</span>, <span class="number">4</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">char</span> *path_start = buffer + <span class="number">4</span>;</span><br><span class="line">            <span class="type">char</span> *path_end = <span class="built_in">strchr</span>(path_start, <span class="string">&#x27; &#x27;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (path_end) &#123;</span><br><span class="line">                *path_end = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                LOG_INFO(<span class="string">&quot;GET request for path: %s&quot;</span>, path_start);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 简单的路由处理</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">strcmp</span>(path_start, <span class="string">&quot;/&quot;</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(path_start, <span class="string">&quot;/index.html&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="type">const</span> <span class="type">char</span> *html_content = </span><br><span class="line">                        <span class="string">&quot;&lt;!DOCTYPE html&gt;&quot;</span></span><br><span class="line">                        <span class="string">&quot;&lt;html&gt;&quot;</span></span><br><span class="line">                        <span class="string">&quot;&lt;head&gt;&quot;</span></span><br><span class="line">                        <span class="string">&quot;&lt;title&gt;Simple HTTP Server&lt;/title&gt;&quot;</span></span><br><span class="line">                        <span class="string">&quot;&lt;style&gt;&quot;</span></span><br><span class="line">                        <span class="string">&quot;body &#123; font-family: Arial, sans-serif; text-align: center; margin-top: 50px; &#125;&quot;</span></span><br><span class="line">                        <span class="string">&quot;h1 &#123; color: #333; &#125;&quot;</span></span><br><span class="line">                        <span class="string">&quot;.info &#123; background: #f0f0f0; padding: 20px; margin: 20px auto; width: 60%; border-radius: 10px; &#125;&quot;</span></span><br><span class="line">                        <span class="string">&quot;&lt;/style&gt;&quot;</span></span><br><span class="line">                        <span class="string">&quot;&lt;/head&gt;&quot;</span></span><br><span class="line">                        <span class="string">&quot;&lt;body&gt;&quot;</span></span><br><span class="line">                        <span class="string">&quot;&lt;h1&gt;Welcome to Simple HTTP Server&lt;/h1&gt;&quot;</span></span><br><span class="line">                        <span class="string">&quot;&lt;div class=&#x27;info&#x27;&gt;&quot;</span></span><br><span class="line">                        <span class="string">&quot;&lt;p&gt;This is a simple HTTP server written in C&lt;/p&gt;&quot;</span></span><br><span class="line">                        <span class="string">&quot;&lt;p&gt;Server Time: &quot;</span> __TIME__ <span class="string">&quot; &quot;</span> __DATE__ <span class="string">&quot;&lt;/p&gt;&quot;</span></span><br><span class="line">                        <span class="string">&quot;&lt;/div&gt;&quot;</span></span><br><span class="line">                        <span class="string">&quot;&lt;/body&gt;&quot;</span></span><br><span class="line">                        <span class="string">&quot;&lt;/html&gt;&quot;</span>;</span><br><span class="line">                    </span><br><span class="line">                    send_http_response(client_socket, <span class="number">200</span>, <span class="string">&quot;OK&quot;</span>, <span class="string">&quot;text/html&quot;</span>, html_content);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(path_start, <span class="string">&quot;/hello&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="type">const</span> <span class="type">char</span> *json_content = </span><br><span class="line">                        <span class="string">&quot;&#123;\&quot;message\&quot;: \&quot;Hello, World!\&quot;, \&quot;status\&quot;: \&quot;success\&quot;&#125;&quot;</span>;</span><br><span class="line">                    send_http_response(client_socket, <span class="number">200</span>, <span class="string">&quot;OK&quot;</span>, <span class="string">&quot;application/json&quot;</span>, json_content);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">const</span> <span class="type">char</span> *error_content = </span><br><span class="line">                        <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;p&gt;The requested resource was not found.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>;</span><br><span class="line">                    send_http_response(client_socket, <span class="number">404</span>, <span class="string">&quot;Not Found&quot;</span>, <span class="string">&quot;text/html&quot;</span>, error_content);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 不支持的方法</span></span><br><span class="line">            <span class="type">const</span> <span class="type">char</span> *error_content = </span><br><span class="line">                <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;405 Method Not Allowed&lt;/h1&gt;&lt;p&gt;Only GET method is supported.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>;</span><br><span class="line">            send_http_response(client_socket, <span class="number">405</span>, <span class="string">&quot;Method Not Allowed&quot;</span>, <span class="string">&quot;text/html&quot;</span>, error_content);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bytes_received == <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_INFO(<span class="string">&quot;Client disconnected: %s:%d&quot;</span>, client_ip, client_port);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Error receiving data from %s:%d&quot;</span>, client_ip, client_port);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 关闭客户端连接</span></span><br><span class="line">    close(client_socket);</span><br><span class="line">    LOG_INFO(<span class="string">&quot;Connection closed: %s:%d&quot;</span>, client_ip, client_port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">int</span> server_fd, client_socket;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server_addr</span>, <span class="title">client_addr</span>;</span></span><br><span class="line">    <span class="type">socklen_t</span> client_len = <span class="keyword">sizeof</span>(client_addr);</span><br><span class="line">    <span class="type">int</span> port = DEFAULT_PORT;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 解析命令行参数</span></span><br><span class="line">    <span class="keyword">if</span> (argc &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        port = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">if</span> (port &lt;= <span class="number">0</span> || port &gt; <span class="number">65535</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Invalid port number: %s\n&quot;</span>, argv[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化日志系统</span></span><br><span class="line">    logger_init(<span class="string">&quot;logs/server.log&quot;</span>, LOG_LEVEL_INFO);</span><br><span class="line">    LOG_INFO(<span class="string">&quot;Starting HTTP server on port %d&quot;</span>, port);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置信号处理</span></span><br><span class="line">    signal(SIGINT, signal_handler);   <span class="comment">// Ctrl+C</span></span><br><span class="line">    signal(SIGTERM, signal_handler);  <span class="comment">// kill命令</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建socket</span></span><br><span class="line">    server_fd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (server_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to create socket&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置socket选项</span></span><br><span class="line">    <span class="type">int</span> opt = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (setsockopt(server_fd, SOL_SOCKET, SO_REUSEADDR, &amp;opt, <span class="keyword">sizeof</span>(opt)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to set socket options&quot;</span>);</span><br><span class="line">        close(server_fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 配置服务器地址</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;server_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(server_addr));</span><br><span class="line">    server_addr.sin_family = AF_INET;</span><br><span class="line">    server_addr.sin_addr.s_addr = INADDR_ANY;  <span class="comment">// 监听所有接口</span></span><br><span class="line">    server_addr.sin_port = htons(port);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 绑定socket</span></span><br><span class="line">    <span class="keyword">if</span> (bind(server_fd, (<span class="keyword">struct</span> sockaddr *)&amp;server_addr, <span class="keyword">sizeof</span>(server_addr)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to bind socket to port %d&quot;</span>, port);</span><br><span class="line">        close(server_fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 监听连接</span></span><br><span class="line">    <span class="keyword">if</span> (listen(server_fd, BACKLOG) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to listen on socket&quot;</span>);</span><br><span class="line">        close(server_fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Server is listening on port %d...&quot;</span>, port);</span><br><span class="line">    LOG_INFO(<span class="string">&quot;Press Ctrl+C to stop the server&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 主循环</span></span><br><span class="line">    <span class="keyword">while</span> (running) &#123;</span><br><span class="line">        <span class="comment">// 接受客户端连接</span></span><br><span class="line">        client_socket = accept(server_fd, (<span class="keyword">struct</span> sockaddr *)&amp;client_addr, &amp;client_len);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (client_socket &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (running) &#123;  <span class="comment">// 如果不是因为关闭导致的错误</span></span><br><span class="line">                LOG_ERROR(<span class="string">&quot;Failed to accept connection&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 处理客户端请求</span></span><br><span class="line">        handle_client(client_socket, &amp;client_addr);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清理资源</span></span><br><span class="line">    LOG_INFO(<span class="string">&quot;Shutting down server...&quot;</span>);</span><br><span class="line">    close(server_fd);</span><br><span class="line">    logger_cleanup();</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Server shutdown complete&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="1-5-创建Makefile"><a href="#1-5-创建Makefile" class="headerlink" title="1.5 创建Makefile"></a>1.5 创建Makefile</h2><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Makefile</span></span><br><span class="line">CC = gcc</span><br><span class="line">CFLAGS = -Wall -Wextra -g -O0</span><br><span class="line">LDFLAGS = </span><br><span class="line">TARGET = http_server</span><br><span class="line">SRC_DIR = src</span><br><span class="line">INCLUDE_DIR = <span class="keyword">include</span></span><br><span class="line">BUILD_DIR = build</span><br><span class="line">SRCS = <span class="variable">$(<span class="built_in">wildcard</span> <span class="variable">$(SRC_DIR)</span>/*.c)</span></span><br><span class="line">OBJS = $(SRCS:<span class="variable">$(SRC_DIR)</span>/%.c=<span class="variable">$(BUILD_DIR)</span>/%.o)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认目标</span></span><br><span class="line"><span class="section">all: <span class="variable">$(BUILD_DIR)</span> <span class="variable">$(TARGET)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建构建目录</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>:</span><br><span class="line">	mkdir -p <span class="variable">$(BUILD_DIR)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 链接可执行文件</span></span><br><span class="line"><span class="variable">$(TARGET)</span>: <span class="variable">$(OBJS)</span></span><br><span class="line">	<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> <span class="variable">$^</span> -o <span class="variable">$@</span> <span class="variable">$(LDFLAGS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译源文件</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/%.o: <span class="variable">$(SRC_DIR)</span>/%.c</span><br><span class="line">	<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> -I<span class="variable">$(INCLUDE_DIR)</span> -c <span class="variable">$&lt;</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -rf <span class="variable">$(BUILD_DIR)</span> <span class="variable">$(TARGET)</span> logs/*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行服务器（默认端口8080）</span></span><br><span class="line"><span class="section">run: <span class="variable">$(TARGET)</span></span></span><br><span class="line">	./<span class="variable">$(TARGET)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调试运行</span></span><br><span class="line"><span class="section">debug: <span class="variable">$(TARGET)</span></span></span><br><span class="line">	gdb -ex run --args ./<span class="variable">$(TARGET)</span> 8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查内存泄漏</span></span><br><span class="line"><span class="section">valgrind: <span class="variable">$(TARGET)</span></span></span><br><span class="line">	valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes ./<span class="variable">$(TARGET)</span> 8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建日志目录</span></span><br><span class="line"><span class="section">init:</span></span><br><span class="line">	mkdir -p logs static</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: all clean run debug valgrind init</span></span><br></pre></td></tr></table></figure>



<h2 id="1-6-创建静态文件"><a href="#1-6-创建静态文件" class="headerlink" title="1.6 创建静态文件"></a>1.6 创建静态文件</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- static/index.html --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Simple HTTP Server<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">body</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-family</span>: <span class="string">&#x27;Segoe UI&#x27;</span>, Tahoma, Geneva, Verdana, sans-serif;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">max-width</span>: <span class="number">800px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin</span>: <span class="number">0</span> auto;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">line-height</span>: <span class="number">1.6</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: <span class="number">#f5f5f5</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">header</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">135deg</span>, <span class="number">#667eea</span> <span class="number">0%</span>, <span class="number">#764ba2</span> <span class="number">100%</span>);</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: white;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">40px</span> <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">text-align</span>: center;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-bottom</span>: <span class="number">30px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.card</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: white;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin</span>: <span class="number">20px</span> <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">2px</span> <span class="number">10px</span> <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.1</span>);</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.endpoints</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">display</span>: grid;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">grid-template-columns</span>: <span class="built_in">repeat</span>(auto-fit, <span class="built_in">minmax</span>(<span class="number">200px</span>, <span class="number">1</span>fr));</span></span><br><span class="line"><span class="language-css">            <span class="attribute">gap</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin</span>: <span class="number">20px</span> <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.endpoint</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="number">#e3f2fd</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">6px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-left</span>: <span class="number">4px</span> solid <span class="number">#2196f3</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">code</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="number">#f4f4f4</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">2px</span> <span class="number">6px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-family</span>: <span class="string">&#x27;Courier New&#x27;</span>, monospace;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>🚀 Simple HTTP Server<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>A lightweight HTTP server written in C<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;card&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>📊 Server Information<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">strong</span>&gt;</span>Server Time:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;server-time&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">strong</span>&gt;</span>Request Count:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;request-count&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;card&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>🔌 Available Endpoints<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;endpoints&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;endpoint&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h3</span>&gt;</span><span class="tag">&lt;<span class="name">code</span>&gt;</span>GET /<span class="tag">&lt;/<span class="name">code</span>&gt;</span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>This homepage<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;endpoint&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h3</span>&gt;</span><span class="tag">&lt;<span class="name">code</span>&gt;</span>GET /hello<span class="tag">&lt;/<span class="name">code</span>&gt;</span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>JSON greeting message<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;endpoint&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h3</span>&gt;</span><span class="tag">&lt;<span class="name">code</span>&gt;</span>GET /status<span class="tag">&lt;/<span class="name">code</span>&gt;</span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>Server status information<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;endpoint&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h3</span>&gt;</span><span class="tag">&lt;<span class="name">code</span>&gt;</span>GET /api/data<span class="tag">&lt;/<span class="name">code</span>&gt;</span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>Sample API endpoint<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;card&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>🛠️ Testing Tools<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;testEndpoint(&#x27;/hello&#x27;)&quot;</span>&gt;</span>Test /hello<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;testEndpoint(&#x27;/status&#x27;)&quot;</span>&gt;</span>Test /status<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;testEndpoint(&#x27;/api/data&#x27;)&quot;</span>&gt;</span>Test /api/data<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;test-result&quot;</span> <span class="attr">style</span>=<span class="string">&quot;margin-top: 15px;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;server-time&#x27;</span>).<span class="property">textContent</span> = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toLocaleString</span>();</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> count = <span class="number">0</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            count++;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;request-count&#x27;</span>).<span class="property">textContent</span> = count;</span></span><br><span class="line"><span class="language-javascript">        &#125;, <span class="number">2000</span>);</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">testEndpoint</span>(<span class="params">endpoint</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> resultDiv = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;test-result&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            resultDiv.<span class="property">innerHTML</span> = <span class="string">&#x27;&lt;p&gt;Testing... &lt;span class=&quot;loading&quot;&gt;⏳&lt;/span&gt;&lt;/p&gt;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(endpoint);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> text = <span class="keyword">await</span> response.<span class="title function_">text</span>();</span></span><br><span class="line"><span class="language-javascript">                </span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">let</span> formattedText;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">const</span> json = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(text);</span></span><br><span class="line"><span class="language-javascript">                    formattedText = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(json, <span class="literal">null</span>, <span class="number">2</span>);</span></span><br><span class="line"><span class="language-javascript">                &#125; <span class="keyword">catch</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    formattedText = text;</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                </span></span><br><span class="line"><span class="language-javascript">                resultDiv.<span class="property">innerHTML</span> = <span class="string">`</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                    &lt;p&gt;&lt;strong&gt;Status:&lt;/strong&gt; <span class="subst">$&#123;response.status&#125;</span> <span class="subst">$&#123;response.statusText&#125;</span>&lt;/p&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                    &lt;pre style=&quot;background: #f4f4f4; padding: 10px; border-radius: 5px; overflow: auto; max-height: 200px;&quot;&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript"><span class="subst">$&#123;formattedText&#125;</span></span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                    &lt;/pre&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                `</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125; <span class="keyword">catch</span> (error) &#123;</span></span><br><span class="line"><span class="language-javascript">                resultDiv.<span class="property">innerHTML</span> = <span class="string">`&lt;p style=&quot;color: red;&quot;&gt;Error: <span class="subst">$&#123;error.message&#125;</span>&lt;/p&gt;`</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="1-7-测试脚本"><a href="#1-7-测试脚本" class="headerlink" title="1.7 测试脚本"></a>1.7 测试脚本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># scripts/test_server.sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 编译服务器 ===&quot;</span></span><br><span class="line">make clean</span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 启动服务器（后台运行）===&quot;</span></span><br><span class="line">./http_server 8080 &amp;</span><br><span class="line">SERVER_PID=$!</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;服务器进程ID: <span class="variable">$SERVER_PID</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 等待服务器启动</span></span><br><span class="line"><span class="built_in">sleep</span> 2</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 测试1: 访问首页 ===&quot;</span></span><br><span class="line">curl -s http://localhost:8080/ | <span class="built_in">head</span> -20</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 测试2: 访问/hello端点 ===&quot;</span></span><br><span class="line">curl -s http://localhost:8080/hello</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 测试3: 访问不存在的页面 ===&quot;</span></span><br><span class="line">curl -s -w <span class="string">&quot;HTTP状态码: %&#123;http_code&#125;\n&quot;</span> http://localhost:8080/notfound</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 测试4: 发送HEAD请求 ===&quot;</span></span><br><span class="line">curl -I http://localhost:8080/</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 测试5: 查看日志文件 ===&quot;</span></span><br><span class="line"><span class="built_in">tail</span> -n 10 logs/server.log</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 停止服务器 ===&quot;</span></span><br><span class="line"><span class="built_in">kill</span> <span class="variable">$SERVER_PID</span></span><br><span class="line"><span class="built_in">wait</span> <span class="variable">$SERVER_PID</span> 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;测试完成&quot;</span></span><br></pre></td></tr></table></figure>



<h2 id="1-8-编译和运行"><a href="#1-8-编译和运行" class="headerlink" title="1.8 编译和运行"></a>1.8 编译和运行</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 初始化项目</span></span><br><span class="line">make init</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 编译</span></span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 运行服务器</span></span><br><span class="line">./http_server 8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用make命令</span></span><br><span class="line">make run</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 在另一个终端测试</span></span><br><span class="line">curl http://localhost:8080/</span><br><span class="line">curl http://localhost:8080/hello</span><br></pre></td></tr></table></figure>



<h2 id="1-9-调试指南"><a href="#1-9-调试指南" class="headerlink" title="1.9 调试指南"></a>1.9 调试指南</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 使用gdb调试</span></span><br><span class="line">make debug</span><br><span class="line"><span class="comment"># 在gdb中：</span></span><br><span class="line"><span class="comment">#   b main       # 在main函数设置断点</span></span><br><span class="line"><span class="comment">#   r            # 运行</span></span><br><span class="line"><span class="comment">#   n            # 下一步</span></span><br><span class="line"><span class="comment">#   p variable   # 打印变量</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 内存泄漏检查</span></span><br><span class="line">make valgrind</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 查看实时日志</span></span><br><span class="line"><span class="built_in">tail</span> -f logs/server.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 压力测试</span></span><br><span class="line">ab -n 1000 -c 10 http://localhost:8080/</span><br></pre></td></tr></table></figure>



<h2 id="1-10-总结"><a href="#1-10-总结" class="headerlink" title="1.10 总结"></a>1.10 总结</h2><p>现在你已经完成了一个基本的单线程HTTP服务器！这个阶段涵盖了：</p>
<ol>
<li><strong>Socket编程</strong> - 网络通信基础</li>
<li><strong>HTTP协议基础</strong> - 请求&#x2F;响应格式</li>
<li><strong>日志系统</strong> - 调试和监控</li>
<li><strong>信号处理</strong> - 优雅关闭</li>
<li><strong>Makefile</strong> - 构建自动化</li>
<li><strong>调试技巧</strong> - gdb, valgrind, 日志分析</li>
</ol>
<p><strong>常见问题解决</strong>：</p>
<ol>
<li><strong>端口占用错误</strong>：换一个端口，如 <code>./http_server 8888</code></li>
<li><strong>权限问题</strong>：如果你使用1024以下端口，需要sudo权限</li>
<li><strong>连接拒绝</strong>：检查防火墙设置</li>
</ol>
<p>在阶段2中，我们将实现请求解析模块，使服务器能够正确解析HTTP请求头和方法。现在可以先测试阶段1的功能，确保一切正常后再继续。</p>
<h1 id="阶段2：实现完整的请求解析和响应构建"><a href="#阶段2：实现完整的请求解析和响应构建" class="headerlink" title="阶段2：实现完整的请求解析和响应构建"></a>阶段2：实现完整的请求解析和响应构建</h1><p>在这个阶段，我们将完善HTTP请求解析、添加更多HTTP方法支持，并改进响应构建机制。</p>
<h2 id="2-1-创建请求解析模块"><a href="#2-1-创建请求解析模块" class="headerlink" title="2.1 创建请求解析模块"></a>2.1 创建请求解析模块</h2><h4 id="2-1-1-请求头文件（request-h）"><a href="#2-1-1-请求头文件（request-h）" class="headerlink" title="2.1.1 请求头文件（request.h）"></a>2.1.1 请求头文件（request.h）</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/request.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> REQUEST_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REQUEST_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// HTTP方法枚举</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    HTTP_GET,</span><br><span class="line">    HTTP_POST,</span><br><span class="line">    HTTP_PUT,</span><br><span class="line">    HTTP_DELETE,</span><br><span class="line">    HTTP_HEAD,</span><br><span class="line">    HTTP_OPTIONS,</span><br><span class="line">    HTTP_PATCH,</span><br><span class="line">    HTTP_UNKNOWN</span><br><span class="line">&#125; HttpMethod;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HTTP版本枚举</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    HTTP_1_0,</span><br><span class="line">    HTTP_1_1,</span><br><span class="line">    HTTP_2_0,</span><br><span class="line">    HTTP_UNKNOWN_VERSION</span><br><span class="line">&#125; HttpVersion;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请求头键值对</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">HttpHeader</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> *key;</span><br><span class="line">    <span class="type">char</span> *value;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">HttpHeader</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; HttpHeader;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HTTP请求结构体</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    HttpMethod method;</span><br><span class="line">    <span class="type">char</span> *path;</span><br><span class="line">    <span class="type">char</span> *query_string;</span><br><span class="line">    HttpVersion version;</span><br><span class="line">    HttpHeader *headers;</span><br><span class="line">    <span class="type">char</span> *body;</span><br><span class="line">    <span class="type">size_t</span> content_length;</span><br><span class="line">    <span class="type">int</span> is_valid;  <span class="comment">// 是否有效请求</span></span><br><span class="line">&#125; HttpRequest;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析HTTP请求</span></span><br><span class="line">HttpRequest* <span class="title function_">parse_http_request</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *raw_request, <span class="type">size_t</span> length)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取请求头值</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="title function_">get_header_value</span><span class="params">(<span class="type">const</span> HttpRequest *req, <span class="type">const</span> <span class="type">char</span> *key)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放请求结构体</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">free_http_request</span><span class="params">(HttpRequest *req)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法字符串转换</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="title function_">http_method_to_string</span><span class="params">(HttpMethod method)</span>;</span><br><span class="line">HttpMethod <span class="title function_">string_to_http_method</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *method_str)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 版本字符串转换</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="title function_">http_version_to_string</span><span class="params">(HttpVersion version)</span>;</span><br><span class="line">HttpVersion <span class="title function_">string_to_http_version</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *version_str)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// URL解码</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">url_decode</span><span class="params">(<span class="type">char</span> *dest, <span class="type">const</span> <span class="type">char</span> *src)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// REQUEST_H</span></span></span><br></pre></td></tr></table></figure>



<h3 id="2-1-2-请求解析实现（request-c）"><a href="#2-1-2-请求解析实现（request-c）" class="headerlink" title="2.1.2 请求解析实现（request.c）"></a>2.1.2 请求解析实现（request.c）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/request.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;strings.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/request.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/logger.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 内部辅助函数声明</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span>* <span class="title function_">trim_whitespace</span><span class="params">(<span class="type">char</span> *str)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span>* <span class="title function_">strdup_trimmed</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *str)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">parse_request_line</span><span class="params">(HttpRequest *req, <span class="type">char</span> *line)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">parse_headers</span><span class="params">(HttpRequest *req, <span class="type">char</span> *headers_text)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">parse_body</span><span class="params">(HttpRequest *req, <span class="type">const</span> <span class="type">char</span> *body_text, <span class="type">size_t</span> length)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">add_header</span><span class="params">(HttpRequest *req, <span class="type">const</span> <span class="type">char</span> *key, <span class="type">const</span> <span class="type">char</span> *value)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析HTTP请求</span></span><br><span class="line">HttpRequest* <span class="title function_">parse_http_request</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *raw_request, <span class="type">size_t</span> length)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (raw_request == <span class="literal">NULL</span> || length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    HttpRequest *req = (HttpRequest*)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(HttpRequest));</span><br><span class="line">    <span class="keyword">if</span> (req == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to allocate memory for HttpRequest&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化</span></span><br><span class="line">    req-&gt;method = HTTP_UNKNOWN;</span><br><span class="line">    req-&gt;path = <span class="literal">NULL</span>;</span><br><span class="line">    req-&gt;query_string = <span class="literal">NULL</span>;</span><br><span class="line">    req-&gt;version = HTTP_UNKNOWN_VERSION;</span><br><span class="line">    req-&gt;headers = <span class="literal">NULL</span>;</span><br><span class="line">    req-&gt;body = <span class="literal">NULL</span>;</span><br><span class="line">    req-&gt;content_length = <span class="number">0</span>;</span><br><span class="line">    req-&gt;is_valid = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复制请求数据以便处理</span></span><br><span class="line">    <span class="type">char</span> *request_copy = (<span class="type">char</span>*)<span class="built_in">malloc</span>(length + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (request_copy == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to allocate memory for request copy&quot;</span>);</span><br><span class="line">        <span class="built_in">free</span>(req);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(request_copy, raw_request, length);</span><br><span class="line">    request_copy[length] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 找到请求行结束位置</span></span><br><span class="line">    <span class="type">char</span> *line_end = <span class="built_in">strstr</span>(request_copy, <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (line_end == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Invalid HTTP request: no CRLF found&quot;</span>);</span><br><span class="line">        <span class="built_in">free</span>(request_copy);</span><br><span class="line">        <span class="built_in">free</span>(req);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    *line_end = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析请求行</span></span><br><span class="line">    parse_request_line(req, request_copy);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!req-&gt;is_valid) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to parse request line&quot;</span>);</span><br><span class="line">        <span class="built_in">free</span>(request_copy);</span><br><span class="line">        <span class="built_in">free</span>(req);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析请求头</span></span><br><span class="line">    <span class="type">char</span> *headers_start = line_end + <span class="number">2</span>;</span><br><span class="line">    <span class="type">char</span> *body_start = <span class="built_in">strstr</span>(headers_start, <span class="string">&quot;\r\n\r\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (body_start != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *body_start = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        body_start += <span class="number">4</span>;  <span class="comment">// 跳过空行</span></span><br><span class="line">        parse_headers(req, headers_start);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 解析请求体</span></span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *content_length_str = get_header_value(req, <span class="string">&quot;Content-Length&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (content_length_str != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            req-&gt;content_length = atol(content_length_str);</span><br><span class="line">            <span class="keyword">if</span> (req-&gt;content_length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                parse_body(req, body_start, req-&gt;content_length);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 没有请求体</span></span><br><span class="line">        parse_headers(req, headers_start);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(request_copy);</span><br><span class="line">    req-&gt;is_valid = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> req;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析请求行</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">parse_request_line</span><span class="params">(HttpRequest *req, <span class="type">char</span> *line)</span> &#123;</span><br><span class="line">    <span class="type">char</span> *method_end = <span class="built_in">strchr</span>(line, <span class="string">&#x27; &#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (method_end == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Invalid request line: no method end&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    *method_end = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 解析方法</span></span><br><span class="line">    req-&gt;method = string_to_http_method(line);</span><br><span class="line">    <span class="keyword">if</span> (req-&gt;method == HTTP_UNKNOWN) &#123;</span><br><span class="line">        LOG_WARNING(<span class="string">&quot;Unknown HTTP method: %s&quot;</span>, line);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> *path_start = method_end + <span class="number">1</span>;</span><br><span class="line">    <span class="type">char</span> *path_end = <span class="built_in">strchr</span>(path_start, <span class="string">&#x27; &#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (path_end == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Invalid request line: no path end&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    *path_end = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 分离查询字符串</span></span><br><span class="line">    <span class="type">char</span> *query_start = <span class="built_in">strchr</span>(path_start, <span class="string">&#x27;?&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (query_start != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *query_start = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        req-&gt;query_string = strdup(query_start + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 解码URL路径</span></span><br><span class="line">    <span class="type">char</span> decoded_path[<span class="number">1024</span>];</span><br><span class="line">    url_decode(decoded_path, path_start);</span><br><span class="line">    req-&gt;path = strdup(decoded_path);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 解析HTTP版本</span></span><br><span class="line">    <span class="type">char</span> *version_start = path_end + <span class="number">1</span>;</span><br><span class="line">    req-&gt;version = string_to_http_version(version_start);</span><br><span class="line">    </span><br><span class="line">    req-&gt;is_valid = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析请求头</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">parse_headers</span><span class="params">(HttpRequest *req, <span class="type">char</span> *headers_text)</span> &#123;</span><br><span class="line">    <span class="type">char</span> *line = strtok(headers_text, <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (line != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="type">char</span> *colon = <span class="built_in">strchr</span>(line, <span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (colon != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            *colon = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            <span class="type">char</span> *key = trim_whitespace(line);</span><br><span class="line">            <span class="type">char</span> *value = trim_whitespace(colon + <span class="number">1</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (key != <span class="literal">NULL</span> &amp;&amp; value != <span class="literal">NULL</span> &amp;&amp; <span class="built_in">strlen</span>(key) &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">strlen</span>(value) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                add_header(req, key, value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        line = strtok(<span class="literal">NULL</span>, <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析请求体</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">parse_body</span><span class="params">(HttpRequest *req, <span class="type">const</span> <span class="type">char</span> *body_text, <span class="type">size_t</span> length)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    req-&gt;body = (<span class="type">char</span>*)<span class="built_in">malloc</span>(length + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (req-&gt;body == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to allocate memory for request body&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memcpy</span>(req-&gt;body, body_text, length);</span><br><span class="line">    req-&gt;body[length] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加请求头</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">add_header</span><span class="params">(HttpRequest *req, <span class="type">const</span> <span class="type">char</span> *key, <span class="type">const</span> <span class="type">char</span> *value)</span> &#123;</span><br><span class="line">    HttpHeader *header = (HttpHeader*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(HttpHeader));</span><br><span class="line">    <span class="keyword">if</span> (header == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to allocate memory for header&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    header-&gt;key = strdup_trimmed(key);</span><br><span class="line">    header-&gt;value = strdup_trimmed(value);</span><br><span class="line">    header-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加到链表末尾</span></span><br><span class="line">    <span class="keyword">if</span> (req-&gt;headers == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        req-&gt;headers = header;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        HttpHeader *current = req-&gt;headers;</span><br><span class="line">        <span class="keyword">while</span> (current-&gt;next != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            current = current-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        current-&gt;next = header;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取请求头值</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="title function_">get_header_value</span><span class="params">(<span class="type">const</span> HttpRequest *req, <span class="type">const</span> <span class="type">char</span> *key)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (req == <span class="literal">NULL</span> || key == <span class="literal">NULL</span> || req-&gt;headers == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    HttpHeader *current = req-&gt;headers;</span><br><span class="line">    <span class="keyword">while</span> (current != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (strcasecmp(current-&gt;key, key) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> current-&gt;value;</span><br><span class="line">        &#125;</span><br><span class="line">        current = current-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放请求结构体</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">free_http_request</span><span class="params">(HttpRequest *req)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (req == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (req-&gt;path != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">free</span>(req-&gt;path);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (req-&gt;query_string != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">free</span>(req-&gt;query_string);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (req-&gt;body != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">free</span>(req-&gt;body);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放请求头链表</span></span><br><span class="line">    HttpHeader *current = req-&gt;headers;</span><br><span class="line">    <span class="keyword">while</span> (current != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        HttpHeader *next = current-&gt;next;</span><br><span class="line">        <span class="keyword">if</span> (current-&gt;key != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">free</span>(current-&gt;key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (current-&gt;value != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">free</span>(current-&gt;value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">free</span>(current);</span><br><span class="line">        current = next;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">free</span>(req);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法字符串转换</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="title function_">http_method_to_string</span><span class="params">(HttpMethod method)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (method) &#123;</span><br><span class="line">        <span class="keyword">case</span> HTTP_GET: <span class="keyword">return</span> <span class="string">&quot;GET&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> HTTP_POST: <span class="keyword">return</span> <span class="string">&quot;POST&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> HTTP_PUT: <span class="keyword">return</span> <span class="string">&quot;PUT&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> HTTP_DELETE: <span class="keyword">return</span> <span class="string">&quot;DELETE&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> HTTP_HEAD: <span class="keyword">return</span> <span class="string">&quot;HEAD&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> HTTP_OPTIONS: <span class="keyword">return</span> <span class="string">&quot;OPTIONS&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> HTTP_PATCH: <span class="keyword">return</span> <span class="string">&quot;PATCH&quot;</span>;</span><br><span class="line">        <span class="keyword">default</span>: <span class="keyword">return</span> <span class="string">&quot;UNKNOWN&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HttpMethod <span class="title function_">string_to_http_method</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *method_str)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(method_str, <span class="string">&quot;GET&quot;</span>) == <span class="number">0</span>) <span class="keyword">return</span> HTTP_GET;</span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(method_str, <span class="string">&quot;POST&quot;</span>) == <span class="number">0</span>) <span class="keyword">return</span> HTTP_POST;</span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(method_str, <span class="string">&quot;PUT&quot;</span>) == <span class="number">0</span>) <span class="keyword">return</span> HTTP_PUT;</span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(method_str, <span class="string">&quot;DELETE&quot;</span>) == <span class="number">0</span>) <span class="keyword">return</span> HTTP_DELETE;</span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(method_str, <span class="string">&quot;HEAD&quot;</span>) == <span class="number">0</span>) <span class="keyword">return</span> HTTP_HEAD;</span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(method_str, <span class="string">&quot;OPTIONS&quot;</span>) == <span class="number">0</span>) <span class="keyword">return</span> HTTP_OPTIONS;</span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(method_str, <span class="string">&quot;PATCH&quot;</span>) == <span class="number">0</span>) <span class="keyword">return</span> HTTP_PATCH;</span><br><span class="line">    <span class="keyword">return</span> HTTP_UNKNOWN;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 版本字符串转换</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="title function_">http_version_to_string</span><span class="params">(HttpVersion version)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (version) &#123;</span><br><span class="line">        <span class="keyword">case</span> HTTP_1_0: <span class="keyword">return</span> <span class="string">&quot;HTTP/1.0&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> HTTP_1_1: <span class="keyword">return</span> <span class="string">&quot;HTTP/1.1&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> HTTP_2_0: <span class="keyword">return</span> <span class="string">&quot;HTTP/2.0&quot;</span>;</span><br><span class="line">        <span class="keyword">default</span>: <span class="keyword">return</span> <span class="string">&quot;HTTP/UNKNOWN&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HttpVersion <span class="title function_">string_to_http_version</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *version_str)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(version_str, <span class="string">&quot;HTTP/1.0&quot;</span>) == <span class="number">0</span>) <span class="keyword">return</span> HTTP_1_0;</span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(version_str, <span class="string">&quot;HTTP/1.1&quot;</span>) == <span class="number">0</span>) <span class="keyword">return</span> HTTP_1_1;</span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(version_str, <span class="string">&quot;HTTP/2.0&quot;</span>) == <span class="number">0</span>) <span class="keyword">return</span> HTTP_2_0;</span><br><span class="line">    <span class="keyword">return</span> HTTP_UNKNOWN_VERSION;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// URL解码</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">url_decode</span><span class="params">(<span class="type">char</span> *dest, <span class="type">const</span> <span class="type">char</span> *src)</span> &#123;</span><br><span class="line">    <span class="type">char</span> a, b;</span><br><span class="line">    <span class="keyword">while</span> (*src) &#123;</span><br><span class="line">        <span class="keyword">if</span> (*src == <span class="string">&#x27;%&#x27;</span> &amp;&amp; </span><br><span class="line">            ((a = src[<span class="number">1</span>]) &amp;&amp; (b = src[<span class="number">2</span>])) &amp;&amp; </span><br><span class="line">            (<span class="built_in">isxdigit</span>(a) &amp;&amp; <span class="built_in">isxdigit</span>(b))) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (a &gt;= <span class="string">&#x27;a&#x27;</span>) a -= <span class="string">&#x27;a&#x27;</span> - <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">            <span class="keyword">if</span> (a &gt;= <span class="string">&#x27;A&#x27;</span>) a -= (<span class="string">&#x27;A&#x27;</span> - <span class="number">10</span>);</span><br><span class="line">            <span class="keyword">else</span> a -= <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (b &gt;= <span class="string">&#x27;a&#x27;</span>) b -= <span class="string">&#x27;a&#x27;</span> - <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">            <span class="keyword">if</span> (b &gt;= <span class="string">&#x27;A&#x27;</span>) b -= (<span class="string">&#x27;A&#x27;</span> - <span class="number">10</span>);</span><br><span class="line">            <span class="keyword">else</span> b -= <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">            </span><br><span class="line">            *dest++ = <span class="number">16</span> * a + b;</span><br><span class="line">            src += <span class="number">3</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (*src == <span class="string">&#x27;+&#x27;</span>) &#123;</span><br><span class="line">            *dest++ = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">            src++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            *dest++ = *src++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    *dest = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 辅助函数：去除字符串首尾空白字符</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span>* <span class="title function_">trim_whitespace</span><span class="params">(<span class="type">char</span> *str)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 去除开头的空白字符</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">isspace</span>((<span class="type">unsigned</span> <span class="type">char</span>)*str)) &#123;</span><br><span class="line">        str++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (*str == <span class="number">0</span>) <span class="keyword">return</span> str;  <span class="comment">// 全部是空白字符</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 去除末尾的空白字符</span></span><br><span class="line">    <span class="type">char</span> *end = str + <span class="built_in">strlen</span>(str) - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (end &gt; str &amp;&amp; <span class="built_in">isspace</span>((<span class="type">unsigned</span> <span class="type">char</span>)*end)) &#123;</span><br><span class="line">        end--;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    *(end + <span class="number">1</span>) = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 辅助函数：复制并修剪字符串</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span>* <span class="title function_">strdup_trimmed</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *str)</span> &#123;</span><br><span class="line">    <span class="type">char</span> *trimmed = strdup(str);</span><br><span class="line">    <span class="keyword">if</span> (trimmed != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        trim_whitespace(trimmed);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> trimmed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-2-创建响应构建模块"><a href="#2-2-创建响应构建模块" class="headerlink" title="2.2 创建响应构建模块"></a>2.2 创建响应构建模块</h2><h3 id="2-2-1-响应头文件（response-h）"><a href="#2-2-1-响应头文件（response-h）" class="headerlink" title="2.2.1 响应头文件（response.h）"></a>2.2.1 响应头文件（response.h）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/response.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> RESPONSE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RESPONSE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/request.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// HTTP状态码枚举</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    HTTP_200_OK = <span class="number">200</span>,</span><br><span class="line">    HTTP_201_CREATED = <span class="number">201</span>,</span><br><span class="line">    HTTP_204_NO_CONTENT = <span class="number">204</span>,</span><br><span class="line">    HTTP_301_MOVED_PERMANENTLY = <span class="number">301</span>,</span><br><span class="line">    HTTP_302_FOUND = <span class="number">302</span>,</span><br><span class="line">    HTTP_304_NOT_MODIFIED = <span class="number">304</span>,</span><br><span class="line">    HTTP_400_BAD_REQUEST = <span class="number">400</span>,</span><br><span class="line">    HTTP_401_UNAUTHORIZED = <span class="number">401</span>,</span><br><span class="line">    HTTP_403_FORBIDDEN = <span class="number">403</span>,</span><br><span class="line">    HTTP_404_NOT_FOUND = <span class="number">404</span>,</span><br><span class="line">    HTTP_405_METHOD_NOT_ALLOWED = <span class="number">405</span>,</span><br><span class="line">    HTTP_500_INTERNAL_SERVER_ERROR = <span class="number">500</span>,</span><br><span class="line">    HTTP_501_NOT_IMPLEMENTED = <span class="number">501</span>,</span><br><span class="line">    HTTP_503_SERVICE_UNAVAILABLE = <span class="number">503</span></span><br><span class="line">&#125; HttpStatusCode;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 响应头键值对</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ResponseHeader</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> *key;</span><br><span class="line">    <span class="type">char</span> *value;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ResponseHeader</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; ResponseHeader;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HTTP响应结构体</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    HttpVersion version;</span><br><span class="line">    HttpStatusCode status_code;</span><br><span class="line">    ResponseHeader *headers;</span><br><span class="line">    <span class="type">char</span> *body;</span><br><span class="line">    <span class="type">size_t</span> content_length;</span><br><span class="line">    <span class="type">int</span> should_free_body;  <span class="comment">// 是否应该释放body内存</span></span><br><span class="line">&#125; HttpResponse;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建HTTP响应</span></span><br><span class="line">HttpResponse* <span class="title function_">create_http_response</span><span class="params">(HttpVersion version, HttpStatusCode status_code)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加响应头</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">add_response_header</span><span class="params">(HttpResponse *resp, <span class="type">const</span> <span class="type">char</span> *key, <span class="type">const</span> <span class="type">char</span> *value)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置响应体</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_response_body</span><span class="params">(HttpResponse *resp, <span class="type">const</span> <span class="type">char</span> *body, <span class="type">size_t</span> length, <span class="type">int</span> should_free)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置响应体为字符串</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_response_body_string</span><span class="params">(HttpResponse *resp, <span class="type">const</span> <span class="type">char</span> *str)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置JSON响应体</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_response_json</span><span class="params">(HttpResponse *resp, <span class="type">const</span> <span class="type">char</span> *json_str)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置HTML响应体</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_response_html</span><span class="params">(HttpResponse *resp, <span class="type">const</span> <span class="type">char</span> *html_str)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置文件响应体</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">set_response_file</span><span class="params">(HttpResponse *resp, <span class="type">const</span> <span class="type">char</span> *filepath)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构建响应字符串</span></span><br><span class="line"><span class="type">char</span>* <span class="title function_">build_response_string</span><span class="params">(<span class="type">const</span> HttpResponse *resp, <span class="type">size_t</span> *total_length)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送响应</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">send_response</span><span class="params">(<span class="type">int</span> client_fd, <span class="type">const</span> HttpResponse *resp)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放响应结构体</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">free_http_response</span><span class="params">(HttpResponse *resp)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取状态码描述</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="title function_">get_status_message</span><span class="params">(HttpStatusCode code)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// RESPONSE_H</span></span></span><br></pre></td></tr></table></figure>



<h3 id="2-2-2-响应构建实现（response-c）"><a href="#2-2-2-响应构建实现（response-c）" class="headerlink" title="2.2.2 响应构建实现（response.c）"></a>2.2.2 响应构建实现（response.c）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/response.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/response.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/logger.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 内部辅助函数声明</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">add_default_headers</span><span class="params">(HttpResponse *resp)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span>* <span class="title function_">get_mime_type</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *filename)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">format_time</span><span class="params">(<span class="type">char</span> *buffer, <span class="type">size_t</span> size, <span class="type">time_t</span> timestamp)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建HTTP响应</span></span><br><span class="line">HttpResponse* <span class="title function_">create_http_response</span><span class="params">(HttpVersion version, HttpStatusCode status_code)</span> &#123;</span><br><span class="line">    HttpResponse *resp = (HttpResponse*)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(HttpResponse));</span><br><span class="line">    <span class="keyword">if</span> (resp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to allocate memory for HttpResponse&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    resp-&gt;version = version;</span><br><span class="line">    resp-&gt;status_code = status_code;</span><br><span class="line">    resp-&gt;headers = <span class="literal">NULL</span>;</span><br><span class="line">    resp-&gt;body = <span class="literal">NULL</span>;</span><br><span class="line">    resp-&gt;content_length = <span class="number">0</span>;</span><br><span class="line">    resp-&gt;should_free_body = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加默认头部</span></span><br><span class="line">    add_default_headers(resp);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> resp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加默认头部</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">add_default_headers</span><span class="params">(HttpResponse *resp)</span> &#123;</span><br><span class="line">    <span class="comment">// 添加服务器信息</span></span><br><span class="line">    add_response_header(resp, <span class="string">&quot;Server&quot;</span>, <span class="string">&quot;Simple-C-Server/1.0&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加日期</span></span><br><span class="line">    <span class="type">time_t</span> now = time(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="type">char</span> date_str[<span class="number">64</span>];</span><br><span class="line">    format_time(date_str, <span class="keyword">sizeof</span>(date_str), now);</span><br><span class="line">    add_response_header(resp, <span class="string">&quot;Date&quot;</span>, date_str);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 默认连接方式</span></span><br><span class="line">    add_response_header(resp, <span class="string">&quot;Connection&quot;</span>, <span class="string">&quot;close&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加响应头</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">add_response_header</span><span class="params">(HttpResponse *resp, <span class="type">const</span> <span class="type">char</span> *key, <span class="type">const</span> <span class="type">char</span> *value)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (resp == <span class="literal">NULL</span> || key == <span class="literal">NULL</span> || value == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ResponseHeader *header = (ResponseHeader*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(ResponseHeader));</span><br><span class="line">    <span class="keyword">if</span> (header == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to allocate memory for response header&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    header-&gt;key = strdup(key);</span><br><span class="line">    header-&gt;value = strdup(value);</span><br><span class="line">    header-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加到链表末尾</span></span><br><span class="line">    <span class="keyword">if</span> (resp-&gt;headers == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        resp-&gt;headers = header;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ResponseHeader *current = resp-&gt;headers;</span><br><span class="line">        <span class="keyword">while</span> (current-&gt;next != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            current = current-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        current-&gt;next = header;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置响应体</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_response_body</span><span class="params">(HttpResponse *resp, <span class="type">const</span> <span class="type">char</span> *body, <span class="type">size_t</span> length, <span class="type">int</span> should_free)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (resp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清理旧的响应体</span></span><br><span class="line">    <span class="keyword">if</span> (resp-&gt;body != <span class="literal">NULL</span> &amp;&amp; resp-&gt;should_free_body) &#123;</span><br><span class="line">        <span class="built_in">free</span>(resp-&gt;body);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    resp-&gt;body = (<span class="type">char</span>*)body;</span><br><span class="line">    resp-&gt;content_length = length;</span><br><span class="line">    resp-&gt;should_free_body = should_free;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 更新Content-Length头</span></span><br><span class="line">    <span class="type">char</span> length_str[<span class="number">32</span>];</span><br><span class="line">    <span class="built_in">snprintf</span>(length_str, <span class="keyword">sizeof</span>(length_str), <span class="string">&quot;%zu&quot;</span>, length);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 先移除旧的Content-Length头</span></span><br><span class="line">    ResponseHeader *prev = <span class="literal">NULL</span>;</span><br><span class="line">    ResponseHeader *current = resp-&gt;headers;</span><br><span class="line">    <span class="keyword">while</span> (current != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (strcasecmp(current-&gt;key, <span class="string">&quot;Content-Length&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (prev == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                resp-&gt;headers = current-&gt;next;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                prev-&gt;next = current-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">free</span>(current-&gt;key);</span><br><span class="line">            <span class="built_in">free</span>(current-&gt;value);</span><br><span class="line">            <span class="built_in">free</span>(current);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        prev = current;</span><br><span class="line">        current = current-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加新的Content-Length头</span></span><br><span class="line">    add_response_header(resp, <span class="string">&quot;Content-Length&quot;</span>, length_str);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置响应体为字符串</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_response_body_string</span><span class="params">(HttpResponse *resp, <span class="type">const</span> <span class="type">char</span> *str)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        set_response_body(resp, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        set_response_body(resp, str, <span class="built_in">strlen</span>(str), <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置JSON响应体</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_response_json</span><span class="params">(HttpResponse *resp, <span class="type">const</span> <span class="type">char</span> *json_str)</span> &#123;</span><br><span class="line">    set_response_body_string(resp, json_str);</span><br><span class="line">    add_response_header(resp, <span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json; charset=utf-8&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置HTML响应体</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_response_html</span><span class="params">(HttpResponse *resp, <span class="type">const</span> <span class="type">char</span> *html_str)</span> &#123;</span><br><span class="line">    set_response_body_string(resp, html_str);</span><br><span class="line">    add_response_header(resp, <span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/html; charset=utf-8&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置文件响应体</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">set_response_file</span><span class="params">(HttpResponse *resp, <span class="type">const</span> <span class="type">char</span> *filepath)</span> &#123;</span><br><span class="line">    FILE *file = fopen(filepath, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;  <span class="comment">// 文件不存在</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取文件大小</span></span><br><span class="line">    fseek(file, <span class="number">0</span>, SEEK_END);</span><br><span class="line">    <span class="type">long</span> file_size = ftell(file);</span><br><span class="line">    fseek(file, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 读取文件内容</span></span><br><span class="line">    <span class="type">char</span> *file_content = (<span class="type">char</span>*)<span class="built_in">malloc</span>(file_size);</span><br><span class="line">    <span class="keyword">if</span> (file_content == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        fclose(file);</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to allocate memory for file content&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">size_t</span> bytes_read = fread(file_content, <span class="number">1</span>, file_size, file);</span><br><span class="line">    fclose(file);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (bytes_read != (<span class="type">size_t</span>)file_size) &#123;</span><br><span class="line">        <span class="built_in">free</span>(file_content);</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to read entire file: %s&quot;</span>, filepath);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置响应体</span></span><br><span class="line">    set_response_body(resp, file_content, file_size, <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置Content-Type</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *mime_type = get_mime_type(filepath);</span><br><span class="line">    add_response_header(resp, <span class="string">&quot;Content-Type&quot;</span>, mime_type);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构建响应字符串</span></span><br><span class="line"><span class="type">char</span>* <span class="title function_">build_response_string</span><span class="params">(<span class="type">const</span> HttpResponse *resp, <span class="type">size_t</span> *total_length)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (resp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算响应字符串总长度</span></span><br><span class="line">    <span class="type">size_t</span> length = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 状态行长度</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *version_str = http_version_to_string(resp-&gt;version);</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *status_msg = get_status_message(resp-&gt;status_code);</span><br><span class="line">    length += <span class="built_in">strlen</span>(version_str) + <span class="number">1</span> + <span class="number">3</span> + <span class="number">1</span> + <span class="built_in">strlen</span>(status_msg) + <span class="number">2</span>;  <span class="comment">// &quot;HTTP/1.1 200 OK\r\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 头部长度</span></span><br><span class="line">    ResponseHeader *header = resp-&gt;headers;</span><br><span class="line">    <span class="keyword">while</span> (header != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        length += <span class="built_in">strlen</span>(header-&gt;key) + <span class="number">2</span> + <span class="built_in">strlen</span>(header-&gt;value) + <span class="number">2</span>;  <span class="comment">// &quot;Key: Value\r\n&quot;</span></span><br><span class="line">        header = header-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 空行</span></span><br><span class="line">    length += <span class="number">2</span>;  <span class="comment">// &quot;\r\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 响应体长度</span></span><br><span class="line">    length += resp-&gt;content_length;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 分配内存</span></span><br><span class="line">    <span class="type">char</span> *response_str = (<span class="type">char</span>*)<span class="built_in">malloc</span>(length + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (response_str == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to allocate memory for response string&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建响应字符串</span></span><br><span class="line">    <span class="type">char</span> *ptr = response_str;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 状态行</span></span><br><span class="line">    <span class="type">int</span> written = <span class="built_in">snprintf</span>(ptr, length - (ptr - response_str), </span><br><span class="line">                          <span class="string">&quot;%s %d %s\r\n&quot;</span>, </span><br><span class="line">                          version_str, resp-&gt;status_code, status_msg);</span><br><span class="line">    ptr += written;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 头部</span></span><br><span class="line">    header = resp-&gt;headers;</span><br><span class="line">    <span class="keyword">while</span> (header != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        written = <span class="built_in">snprintf</span>(ptr, length - (ptr - response_str), </span><br><span class="line">                          <span class="string">&quot;%s: %s\r\n&quot;</span>, header-&gt;key, header-&gt;value);</span><br><span class="line">        ptr += written;</span><br><span class="line">        header = header-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 空行</span></span><br><span class="line">    written = <span class="built_in">snprintf</span>(ptr, length - (ptr - response_str), <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">    ptr += written;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 响应体</span></span><br><span class="line">    <span class="keyword">if</span> (resp-&gt;body != <span class="literal">NULL</span> &amp;&amp; resp-&gt;content_length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(ptr, resp-&gt;body, resp-&gt;content_length);</span><br><span class="line">        ptr += resp-&gt;content_length;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    *ptr = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (total_length != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *total_length = length;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> response_str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送响应</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">send_response</span><span class="params">(<span class="type">int</span> client_fd, <span class="type">const</span> HttpResponse *resp)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (resp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">size_t</span> total_length;</span><br><span class="line">    <span class="type">char</span> *response_str = build_response_string(resp, &amp;total_length);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (response_str == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">ssize_t</span> bytes_sent = send(client_fd, response_str, total_length, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">free</span>(response_str);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (bytes_sent &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to send response to client&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放响应结构体</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">free_http_response</span><span class="params">(HttpResponse *resp)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (resp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放头部链表</span></span><br><span class="line">    ResponseHeader *current = resp-&gt;headers;</span><br><span class="line">    <span class="keyword">while</span> (current != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ResponseHeader *next = current-&gt;next;</span><br><span class="line">        <span class="built_in">free</span>(current-&gt;key);</span><br><span class="line">        <span class="built_in">free</span>(current-&gt;value);</span><br><span class="line">        <span class="built_in">free</span>(current);</span><br><span class="line">        current = next;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放响应体</span></span><br><span class="line">    <span class="keyword">if</span> (resp-&gt;body != <span class="literal">NULL</span> &amp;&amp; resp-&gt;should_free_body) &#123;</span><br><span class="line">        <span class="built_in">free</span>(resp-&gt;body);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">free</span>(resp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取MIME类型</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span>* <span class="title function_">get_mime_type</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *filename)</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *ext = <span class="built_in">strrchr</span>(filename, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ext == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;application/octet-stream&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ext, <span class="string">&quot;.html&quot;</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(ext, <span class="string">&quot;.htm&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;text/html&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ext, <span class="string">&quot;.css&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;text/css&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ext, <span class="string">&quot;.js&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;application/javascript&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ext, <span class="string">&quot;.json&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;application/json&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ext, <span class="string">&quot;.xml&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;application/xml&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ext, <span class="string">&quot;.txt&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;text/plain&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ext, <span class="string">&quot;.jpg&quot;</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(ext, <span class="string">&quot;.jpeg&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;image/jpeg&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ext, <span class="string">&quot;.png&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;image/png&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ext, <span class="string">&quot;.gif&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;image/gif&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ext, <span class="string">&quot;.svg&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;image/svg+xml&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ext, <span class="string">&quot;.pdf&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;application/pdf&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ext, <span class="string">&quot;.zip&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;application/zip&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;application/octet-stream&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 格式化时间</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">format_time</span><span class="params">(<span class="type">char</span> *buffer, <span class="type">size_t</span> size, <span class="type">time_t</span> timestamp)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tm</span> *<span class="title">tm_info</span> =</span> gmtime(&amp;timestamp);</span><br><span class="line">    strftime(buffer, size, <span class="string">&quot;%a, %d %b %Y %H:%M:%S GMT&quot;</span>, tm_info);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取状态码描述</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="title function_">get_status_message</span><span class="params">(HttpStatusCode code)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">        <span class="keyword">case</span> HTTP_200_OK: <span class="keyword">return</span> <span class="string">&quot;OK&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> HTTP_201_CREATED: <span class="keyword">return</span> <span class="string">&quot;Created&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> HTTP_204_NO_CONTENT: <span class="keyword">return</span> <span class="string">&quot;No Content&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> HTTP_301_MOVED_PERMANENTLY: <span class="keyword">return</span> <span class="string">&quot;Moved Permanently&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> HTTP_302_FOUND: <span class="keyword">return</span> <span class="string">&quot;Found&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> HTTP_304_NOT_MODIFIED: <span class="keyword">return</span> <span class="string">&quot;Not Modified&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> HTTP_400_BAD_REQUEST: <span class="keyword">return</span> <span class="string">&quot;Bad Request&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> HTTP_401_UNAUTHORIZED: <span class="keyword">return</span> <span class="string">&quot;Unauthorized&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> HTTP_403_FORBIDDEN: <span class="keyword">return</span> <span class="string">&quot;Forbidden&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> HTTP_404_NOT_FOUND: <span class="keyword">return</span> <span class="string">&quot;Not Found&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> HTTP_405_METHOD_NOT_ALLOWED: <span class="keyword">return</span> <span class="string">&quot;Method Not Allowed&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> HTTP_500_INTERNAL_SERVER_ERROR: <span class="keyword">return</span> <span class="string">&quot;Internal Server Error&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> HTTP_501_NOT_IMPLEMENTED: <span class="keyword">return</span> <span class="string">&quot;Not Implemented&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> HTTP_503_SERVICE_UNAVAILABLE: <span class="keyword">return</span> <span class="string">&quot;Service Unavailable&quot;</span>;</span><br><span class="line">        <span class="keyword">default</span>: <span class="keyword">return</span> <span class="string">&quot;Unknown&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-3-更新主程序以使用新的模块"><a href="#2-3-更新主程序以使用新的模块" class="headerlink" title="2.3 更新主程序以使用新的模块"></a>2.3 更新主程序以使用新的模块</h2><h3 id="2-3-1-更新main-c"><a href="#2-3-1-更新main-c" class="headerlink" title="2.3.1 更新main.c"></a>2.3.1 更新main.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.c (更新版)</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/logger.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/request.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/response.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFAULT_PORT 8080</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE 8192  <span class="comment">// 增加到8KB以处理大请求</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BACKLOG 10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_PATH_LENGTH 1024</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">volatile</span> <span class="type">int</span> running = <span class="number">1</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span> server_root[<span class="number">1024</span>] = <span class="string">&quot;.&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 信号处理函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">signal_handler</span><span class="params">(<span class="type">int</span> sig)</span> &#123;</span><br><span class="line">    LOG_INFO(<span class="string">&quot;Received signal %d, shutting down gracefully...&quot;</span>, sig);</span><br><span class="line">    running = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取文件扩展名</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="title function_">get_file_extension</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *filename)</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *dot = <span class="built_in">strrchr</span>(filename, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!dot || dot == filename) <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> dot + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查文件是否存在且可读</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">file_exists</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">    <span class="keyword">return</span> (stat(path, &amp;st) == <span class="number">0</span> &amp;&amp; S_ISREG(st.st_mode) &amp;&amp; access(path, R_OK) == <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务静态文件</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">serve_static_file</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *filepath, HttpResponse *resp)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!file_exists(filepath)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> set_response_file(resp, filepath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理API端点</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handle_api_endpoint</span><span class="params">(<span class="type">const</span> HttpRequest *req, HttpResponse *resp)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(req-&gt;path, <span class="string">&quot;/api/status&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">char</span> status_json[<span class="number">512</span>];</span><br><span class="line">        <span class="built_in">snprintf</span>(status_json, <span class="keyword">sizeof</span>(status_json),</span><br><span class="line">            <span class="string">&quot;&#123;\&quot;status\&quot;: \&quot;running\&quot;, &quot;</span></span><br><span class="line">            <span class="string">&quot;\&quot;server\&quot;: \&quot;Simple-C-HTTP-Server\&quot;, &quot;</span></span><br><span class="line">            <span class="string">&quot;\&quot;version\&quot;: \&quot;1.0\&quot;, &quot;</span></span><br><span class="line">            <span class="string">&quot;\&quot;timestamp\&quot;: %ld, &quot;</span></span><br><span class="line">            <span class="string">&quot;\&quot;uptime\&quot;: \&quot;unknown\&quot;&#125;&quot;</span>,</span><br><span class="line">            time(<span class="literal">NULL</span>));</span><br><span class="line">        set_response_json(resp, status_json);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(req-&gt;path, <span class="string">&quot;/api/echo&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (req-&gt;method == HTTP_POST &amp;&amp; req-&gt;body != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// 原样返回POST的body</span></span><br><span class="line">            <span class="type">char</span> *echo_response = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="built_in">strlen</span>(req-&gt;body) + <span class="number">100</span>);</span><br><span class="line">            <span class="keyword">if</span> (echo_response) &#123;</span><br><span class="line">                <span class="built_in">snprintf</span>(echo_response, <span class="built_in">strlen</span>(req-&gt;body) + <span class="number">100</span>,</span><br><span class="line">                        <span class="string">&quot;&#123;\&quot;method\&quot;: \&quot;POST\&quot;, \&quot;received\&quot;: %s&#125;&quot;</span>,</span><br><span class="line">                        req-&gt;body);</span><br><span class="line">                set_response_json(resp, echo_response);</span><br><span class="line">                <span class="built_in">free</span>(echo_response);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                resp-&gt;status_code = HTTP_500_INTERNAL_SERVER_ERROR;</span><br><span class="line">                set_response_json(resp, <span class="string">&quot;&#123;\&quot;error\&quot;: \&quot;Memory allocation failed\&quot;&#125;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resp-&gt;status_code = HTTP_405_METHOD_NOT_ALLOWED;</span><br><span class="line">            set_response_json(resp, <span class="string">&quot;&#123;\&quot;error\&quot;: \&quot;Method not allowed. Use POST.\&quot;&#125;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resp-&gt;status_code = HTTP_404_NOT_FOUND;</span><br><span class="line">        set_response_json(resp, <span class="string">&quot;&#123;\&quot;error\&quot;: \&quot;API endpoint not found\&quot;&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理静态文件请求</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handle_static_file</span><span class="params">(<span class="type">const</span> HttpRequest *req, HttpResponse *resp)</span> &#123;</span><br><span class="line">    <span class="type">char</span> filepath[MAX_PATH_LENGTH];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建文件路径</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(req-&gt;path, <span class="string">&quot;/&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">snprintf</span>(filepath, <span class="keyword">sizeof</span>(filepath), <span class="string">&quot;%s/static/index.html&quot;</span>, server_root);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">snprintf</span>(filepath, <span class="keyword">sizeof</span>(filepath), <span class="string">&quot;%s/static%s&quot;</span>, server_root, req-&gt;path);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 安全检查：防止目录遍历攻击</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(req-&gt;path, <span class="string">&quot;..&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        resp-&gt;status_code = HTTP_403_FORBIDDEN;</span><br><span class="line">        set_response_html(resp, <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;p&gt;Access denied.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 尝试服务文件</span></span><br><span class="line">    <span class="keyword">if</span> (serve_static_file(filepath, resp) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 文件不存在，返回404</span></span><br><span class="line">        resp-&gt;status_code = HTTP_404_NOT_FOUND;</span><br><span class="line">        </span><br><span class="line">        <span class="type">char</span> error_page[<span class="number">512</span>];</span><br><span class="line">        <span class="built_in">snprintf</span>(error_page, <span class="keyword">sizeof</span>(error_page),</span><br><span class="line">            <span class="string">&quot;&lt;html&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;body&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;h1&gt;404 Not Found&lt;/h1&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;p&gt;The requested resource &#x27;%s&#x27; was not found on this server.&lt;/p&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;hr&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;p&gt;&lt;em&gt;Simple-C-HTTP-Server/1.0&lt;/em&gt;&lt;/p&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;/body&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;/html&gt;&quot;</span>,</span><br><span class="line">            req-&gt;path);</span><br><span class="line">        </span><br><span class="line">        set_response_html(resp, error_page);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理HTTP请求</span></span><br><span class="line">HttpResponse* <span class="title function_">handle_http_request</span><span class="params">(<span class="type">const</span> HttpRequest *req)</span> &#123;</span><br><span class="line">    <span class="comment">// 创建响应</span></span><br><span class="line">    HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_200_OK);</span><br><span class="line">    <span class="keyword">if</span> (resp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据请求路径和方法处理</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strncmp</span>(req-&gt;path, <span class="string">&quot;/api/&quot;</span>, <span class="number">5</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// API端点</span></span><br><span class="line">        handle_api_endpoint(req, resp);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (req-&gt;method == HTTP_GET || req-&gt;method == HTTP_HEAD) &#123;</span><br><span class="line">        <span class="comment">// 静态文件服务</span></span><br><span class="line">        handle_static_file(req, resp);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果是HEAD请求，移除响应体</span></span><br><span class="line">        <span class="keyword">if</span> (req-&gt;method == HTTP_HEAD) &#123;</span><br><span class="line">            <span class="built_in">free</span>(resp-&gt;body);</span><br><span class="line">            resp-&gt;body = <span class="literal">NULL</span>;</span><br><span class="line">            resp-&gt;content_length = <span class="number">0</span>;</span><br><span class="line">            resp-&gt;should_free_body = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (req-&gt;method == HTTP_OPTIONS) &#123;</span><br><span class="line">        <span class="comment">// 处理OPTIONS请求</span></span><br><span class="line">        add_response_header(resp, <span class="string">&quot;Allow&quot;</span>, <span class="string">&quot;GET, HEAD, POST, OPTIONS&quot;</span>);</span><br><span class="line">        resp-&gt;status_code = HTTP_204_NO_CONTENT;</span><br><span class="line">        set_response_body(resp, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (req-&gt;method == HTTP_POST &amp;&amp; <span class="built_in">strcmp</span>(req-&gt;path, <span class="string">&quot;/api/echo&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// POST请求已经在handle_api_endpoint中处理</span></span><br><span class="line">        handle_api_endpoint(req, resp);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 不支持的方法</span></span><br><span class="line">        resp-&gt;status_code = HTTP_405_METHOD_NOT_ALLOWED;</span><br><span class="line">        add_response_header(resp, <span class="string">&quot;Allow&quot;</span>, <span class="string">&quot;GET, HEAD, POST, OPTIONS&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">char</span> error_page[<span class="number">512</span>];</span><br><span class="line">        <span class="built_in">snprintf</span>(error_page, <span class="keyword">sizeof</span>(error_page),</span><br><span class="line">            <span class="string">&quot;&lt;html&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;head&gt;&lt;title&gt;405 Method Not Allowed&lt;/title&gt;&lt;/head&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;body&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;h1&gt;405 Method Not Allowed&lt;/h1&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;p&gt;The method %s is not allowed for the requested resource.&lt;/p&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;hr&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;p&gt;&lt;em&gt;Simple-C-HTTP-Server/1.0&lt;/em&gt;&lt;/p&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;/body&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;/html&gt;&quot;</span>,</span><br><span class="line">            http_method_to_string(req-&gt;method));</span><br><span class="line">        </span><br><span class="line">        set_response_html(resp, error_page);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> resp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理客户端连接</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handle_client</span><span class="params">(<span class="type">int</span> client_socket, <span class="keyword">struct</span> sockaddr_in *client_addr)</span> &#123;</span><br><span class="line">    <span class="type">char</span> buffer[BUFFER_SIZE];</span><br><span class="line">    <span class="type">ssize_t</span> bytes_received;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取客户端IP和端口</span></span><br><span class="line">    <span class="type">char</span> client_ip[INET_ADDRSTRLEN];</span><br><span class="line">    inet_ntop(AF_INET, &amp;(client_addr-&gt;sin_addr), client_ip, INET_ADDRSTRLEN);</span><br><span class="line">    <span class="type">int</span> client_port = ntohs(client_addr-&gt;sin_port);</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;New connection from %s:%d&quot;</span>, client_ip, client_port);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 接收HTTP请求</span></span><br><span class="line">    bytes_received = recv(client_socket, buffer, BUFFER_SIZE - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (bytes_received &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        buffer[bytes_received] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 记录原始请求（调试用）</span></span><br><span class="line">        LOG_DEBUG(<span class="string">&quot;Raw request from %s:%d:\n%.*s&quot;</span>, </span><br><span class="line">                 client_ip, client_port, </span><br><span class="line">                 (<span class="type">int</span>)bytes_received &gt; <span class="number">200</span> ? <span class="number">200</span> : (<span class="type">int</span>)bytes_received, </span><br><span class="line">                 buffer);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 解析HTTP请求</span></span><br><span class="line">        HttpRequest *req = parse_http_request(buffer, bytes_received);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (req == <span class="literal">NULL</span> || !req-&gt;is_valid) &#123;</span><br><span class="line">            LOG_WARNING(<span class="string">&quot;Invalid HTTP request from %s:%d&quot;</span>, client_ip, client_port);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 发送400错误响应</span></span><br><span class="line">            HttpResponse *error_resp = create_http_response(HTTP_1_1, HTTP_400_BAD_REQUEST);</span><br><span class="line">            <span class="keyword">if</span> (error_resp != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                set_response_html(error_resp, </span><br><span class="line">                    <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;400 Bad Request&lt;/h1&gt;&lt;p&gt;Invalid HTTP request.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line">                send_response(client_socket, error_resp);</span><br><span class="line">                free_http_response(error_resp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 记录请求信息</span></span><br><span class="line">            LOG_INFO(<span class="string">&quot;Request: %s %s (Version: %s) from %s:%d&quot;</span>, </span><br><span class="line">                     http_method_to_string(req-&gt;method),</span><br><span class="line">                     req-&gt;path,</span><br><span class="line">                     http_version_to_string(req-&gt;version),</span><br><span class="line">                     client_ip, client_port);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 处理请求并生成响应</span></span><br><span class="line">            HttpResponse *resp = handle_http_request(req);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (resp != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="comment">// 发送响应</span></span><br><span class="line">                send_response(client_socket, resp);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 记录响应信息</span></span><br><span class="line">                LOG_INFO(<span class="string">&quot;Response: %d %s to %s:%d&quot;</span>, </span><br><span class="line">                         resp-&gt;status_code,</span><br><span class="line">                         get_status_message(resp-&gt;status_code),</span><br><span class="line">                         client_ip, client_port);</span><br><span class="line">                </span><br><span class="line">                free_http_response(resp);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                LOG_ERROR(<span class="string">&quot;Failed to create response for %s:%d&quot;</span>, client_ip, client_port);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            free_http_request(req);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bytes_received == <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_INFO(<span class="string">&quot;Client disconnected: %s:%d&quot;</span>, client_ip, client_port);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Error receiving data from %s:%d: %s&quot;</span>, </span><br><span class="line">                 client_ip, client_port, strerror(errno));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 关闭客户端连接</span></span><br><span class="line">    close(client_socket);</span><br><span class="line">    LOG_INFO(<span class="string">&quot;Connection closed: %s:%d&quot;</span>, client_ip, client_port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置服务器根目录</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_server_root</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *root)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (root != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        realpath(root, server_root);</span><br><span class="line">        LOG_INFO(<span class="string">&quot;Server root set to: %s&quot;</span>, server_root);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">int</span> server_fd, client_socket;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server_addr</span>, <span class="title">client_addr</span>;</span></span><br><span class="line">    <span class="type">socklen_t</span> client_len = <span class="keyword">sizeof</span>(client_addr);</span><br><span class="line">    <span class="type">int</span> port = DEFAULT_PORT;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 解析命令行参数</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; argc; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-p&quot;</span>) == <span class="number">0</span> &amp;&amp; i + <span class="number">1</span> &lt; argc) &#123;</span><br><span class="line">            port = atoi(argv[++i]);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-r&quot;</span>) == <span class="number">0</span> &amp;&amp; i + <span class="number">1</span> &lt; argc) &#123;</span><br><span class="line">            set_server_root(argv[++i]);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-h&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Usage: %s [-p port] [-r root_directory]\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Options:\n&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;  -p PORT      Port to listen on (default: %d)\n&quot;</span>, DEFAULT_PORT);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;  -r DIR       Server root directory (default: current directory)\n&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;  -h           Show this help message\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (port &lt;= <span class="number">0</span> || port &gt; <span class="number">65535</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Invalid port number: %d\n&quot;</span>, port);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化日志系统</span></span><br><span class="line">    logger_init(<span class="string">&quot;logs/server.log&quot;</span>, LOG_LEVEL_INFO);</span><br><span class="line">    LOG_INFO(<span class="string">&quot;Starting HTTP server v1.0&quot;</span>);</span><br><span class="line">    LOG_INFO(<span class="string">&quot;Server root: %s&quot;</span>, server_root);</span><br><span class="line">    LOG_INFO(<span class="string">&quot;Listening on port %d&quot;</span>, port);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置信号处理</span></span><br><span class="line">    signal(SIGINT, signal_handler);</span><br><span class="line">    signal(SIGTERM, signal_handler);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建socket</span></span><br><span class="line">    server_fd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (server_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to create socket: %s&quot;</span>, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置socket选项</span></span><br><span class="line">    <span class="type">int</span> opt = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (setsockopt(server_fd, SOL_SOCKET, SO_REUSEADDR, &amp;opt, <span class="keyword">sizeof</span>(opt)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to set socket options: %s&quot;</span>, strerror(errno));</span><br><span class="line">        close(server_fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 配置服务器地址</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;server_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(server_addr));</span><br><span class="line">    server_addr.sin_family = AF_INET;</span><br><span class="line">    server_addr.sin_addr.s_addr = INADDR_ANY;</span><br><span class="line">    server_addr.sin_port = htons(port);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 绑定socket</span></span><br><span class="line">    <span class="keyword">if</span> (bind(server_fd, (<span class="keyword">struct</span> sockaddr *)&amp;server_addr, <span class="keyword">sizeof</span>(server_addr)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to bind socket to port %d: %s&quot;</span>, port, strerror(errno));</span><br><span class="line">        close(server_fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 监听连接</span></span><br><span class="line">    <span class="keyword">if</span> (listen(server_fd, BACKLOG) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to listen on socket: %s&quot;</span>, strerror(errno));</span><br><span class="line">        close(server_fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Server is listening on port %d...&quot;</span>, port);</span><br><span class="line">    LOG_INFO(<span class="string">&quot;Press Ctrl+C to stop the server&quot;</span>);</span><br><span class="line">    LOG_INFO(<span class="string">&quot;==========================================&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 主循环</span></span><br><span class="line">    <span class="keyword">while</span> (running) &#123;</span><br><span class="line">        <span class="comment">// 接受客户端连接</span></span><br><span class="line">        client_socket = accept(server_fd, (<span class="keyword">struct</span> sockaddr *)&amp;client_addr, &amp;client_len);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (client_socket &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (running) &#123;</span><br><span class="line">                LOG_ERROR(<span class="string">&quot;Failed to accept connection: %s&quot;</span>, strerror(errno));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 处理客户端请求</span></span><br><span class="line">        handle_client(client_socket, &amp;client_addr);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清理资源</span></span><br><span class="line">    LOG_INFO(<span class="string">&quot;Shutting down server...&quot;</span>);</span><br><span class="line">    close(server_fd);</span><br><span class="line">    logger_cleanup();</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Server shutdown complete&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-4-更新Makefile"><a href="#2-4-更新Makefile" class="headerlink" title="2.4 更新Makefile"></a>2.4 更新Makefile</h2><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Makefile (更新版)</span></span><br><span class="line">CC = gcc</span><br><span class="line">CFLAGS = -Wall -Wextra -g -O0 -I./<span class="keyword">include</span></span><br><span class="line">LDFLAGS = </span><br><span class="line">TARGET = http_server</span><br><span class="line">SRC_DIR = src</span><br><span class="line">INCLUDE_DIR = <span class="keyword">include</span></span><br><span class="line">BUILD_DIR = build</span><br><span class="line">SRCS = <span class="variable">$(SRC_DIR)</span>/logger.c <span class="variable">$(SRC_DIR)</span>/request.c <span class="variable">$(SRC_DIR)</span>/response.c <span class="variable">$(SRC_DIR)</span>/main.c</span><br><span class="line">OBJS = $(SRCS:<span class="variable">$(SRC_DIR)</span>/%.c=<span class="variable">$(BUILD_DIR)</span>/%.o)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认目标</span></span><br><span class="line"><span class="section">all: <span class="variable">$(BUILD_DIR)</span> <span class="variable">$(TARGET)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建构建目录</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>:</span><br><span class="line">	mkdir -p <span class="variable">$(BUILD_DIR)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 链接可执行文件</span></span><br><span class="line"><span class="variable">$(TARGET)</span>: <span class="variable">$(OBJS)</span></span><br><span class="line">	<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> <span class="variable">$^</span> -o <span class="variable">$@</span> <span class="variable">$(LDFLAGS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译源文件</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/%.o: <span class="variable">$(SRC_DIR)</span>/%.c</span><br><span class="line">	<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> -c <span class="variable">$&lt;</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -rf <span class="variable">$(BUILD_DIR)</span> <span class="variable">$(TARGET)</span> logs/* static/*.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行服务器（默认端口8080）</span></span><br><span class="line"><span class="section">run: <span class="variable">$(TARGET)</span></span></span><br><span class="line">	./<span class="variable">$(TARGET)</span> -p 8080 -r .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调试运行</span></span><br><span class="line"><span class="section">debug: <span class="variable">$(TARGET)</span></span></span><br><span class="line">	gdb -ex run --args ./<span class="variable">$(TARGET)</span> -p 8080 -r .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查内存泄漏</span></span><br><span class="line"><span class="section">valgrind: <span class="variable">$(TARGET)</span></span></span><br><span class="line">	valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes ./<span class="variable">$(TARGET)</span> -p 8080 -r .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建必要的目录</span></span><br><span class="line"><span class="section">init:</span></span><br><span class="line">	mkdir -p logs static <span class="variable">$(BUILD_DIR)</span></span><br><span class="line">	cp -n static_examples/* static/ 2&gt;/dev/null || true</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建测试目录和文件</span></span><br><span class="line"><span class="section">setup-test:</span></span><br><span class="line">	mkdir -p static</span><br><span class="line">	cp -n static_examples/* static/ 2&gt;/dev/null || echo <span class="string">&quot;Creating test files...&quot;</span></span><br><span class="line">	echo <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Test Page&lt;/h1&gt;&lt;p&gt;This is a test.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span> &gt; static/test.html</span><br><span class="line">	echo <span class="string">&quot;body &#123; color: blue; &#125;&quot;</span> &gt; static/style.css</span><br><span class="line">	echo &#x27;&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;test&quot;</span>&#125;&#x27; &gt; static/data.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行测试套件</span></span><br><span class="line"><span class="section">test: <span class="variable">$(TARGET)</span></span></span><br><span class="line">	@echo <span class="string">&quot;=== Running HTTP server tests ===&quot;</span></span><br><span class="line">	@./scripts/test_server.sh</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: all clean run debug valgrind init setup-test test</span></span><br></pre></td></tr></table></figure>



<h2 id="2-5-创建示例静态文件和测试脚本"><a href="#2-5-创建示例静态文件和测试脚本" class="headerlink" title="2.5 创建示例静态文件和测试脚本"></a>2.5 创建示例静态文件和测试脚本</h2><h3 id="2-5-1-创建示例静态文件目录"><a href="#2-5-1-创建示例静态文件目录" class="headerlink" title="2.5.1 创建示例静态文件目录"></a>2.5.1 创建示例静态文件目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p static_examples</span><br></pre></td></tr></table></figure>



<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- static_examples/index.html --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Simple HTTP Server - Home<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        * &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">box-sizing</span>: border-box;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">body</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-family</span>: <span class="string">&#x27;Segoe UI&#x27;</span>, Tahoma, Geneva, Verdana, sans-serif;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">line-height</span>: <span class="number">1.6</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#333</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">135deg</span>, <span class="number">#667eea</span> <span class="number">0%</span>, <span class="number">#764ba2</span> <span class="number">100%</span>);</span></span><br><span class="line"><span class="language-css">            <span class="attribute">min-height</span>: <span class="number">100vh</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.container</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">max-width</span>: <span class="number">1200px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin</span>: <span class="number">0</span> auto;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">header</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.9</span>);</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">40px</span> <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">text-align</span>: center;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-bottom</span>: <span class="number">30px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">10px</span> <span class="number">30px</span> <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.1</span>);</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">header</span> <span class="selector-tag">h1</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#333</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">2.5em</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-bottom</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">header</span> <span class="selector-tag">p</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#666</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">1.2em</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.server-status</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: white;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">25px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-bottom</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">5px</span> <span class="number">15px</span> <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.05</span>);</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.status-item</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">justify-content</span>: space-between;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">10px</span> <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="number">#eee</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.status-item</span><span class="selector-pseudo">:last-child</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-bottom</span>: none;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.status-label</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-weight</span>: bold;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#555</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.status-value</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#667eea</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.api-tester</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: white;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">25px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-bottom</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">5px</span> <span class="number">15px</span> <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.05</span>);</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.api-tester</span> <span class="selector-tag">h2</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#333</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-bottom</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.endpoint</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="number">#f8f9fa</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-bottom</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-left</span>: <span class="number">4px</span> solid <span class="number">#667eea</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.endpoint-header</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">align-items</span>: center;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-bottom</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.method</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">display</span>: inline-block;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">5px</span> <span class="number">12px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-weight</span>: bold;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-right</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">0.9em</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.method</span><span class="selector-class">.get</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="number">#d4edda</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#155724</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.method</span><span class="selector-class">.post</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="number">#d1ecf1</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#0c5460</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.endpoint-path</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-family</span>: <span class="string">&#x27;Courier New&#x27;</span>, monospace;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">1.1em</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#333</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.endpoint-description</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#666</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-bottom</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.test-button</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="number">#667eea</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: white;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border</span>: none;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">10px</span> <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">5px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">cursor</span>: pointer;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">1em</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">transition</span>: background <span class="number">0.3s</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.test-button</span><span class="selector-pseudo">:hover</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="number">#764ba2</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.result-container</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-top</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="number">#f8f9fa</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">display</span>: none;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.result-header</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">justify-content</span>: space-between;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">align-items</span>: center;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-bottom</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.status-code</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">3px</span> <span class="number">8px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">3px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-weight</span>: bold;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">0.9em</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.status-code</span><span class="selector-class">.success</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="number">#d4edda</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#155724</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.status-code</span><span class="selector-class">.error</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="number">#f8d7da</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#721c24</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.result-content</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">max-height</span>: <span class="number">300px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">overflow-y</span>: auto;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: white;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">5px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#dee2e6</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-family</span>: <span class="string">&#x27;Courier New&#x27;</span>, monospace;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">0.9em</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">white-space</span>: pre-wrap;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">word-wrap</span>: break-word;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">footer</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">text-align</span>: center;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: white;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-top</span>: <span class="number">40px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="keyword">@media</span> (<span class="attribute">max-width</span>: <span class="number">768px</span>) &#123;</span></span><br><span class="line"><span class="language-css">            <span class="selector-class">.container</span> &#123;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">padding</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">            &#125;</span></span><br><span class="line"><span class="language-css">            </span></span><br><span class="line"><span class="language-css">            <span class="selector-tag">header</span> <span class="selector-tag">h1</span> &#123;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">font-size</span>: <span class="number">2em</span>;</span></span><br><span class="line"><span class="language-css">            &#125;</span></span><br><span class="line"><span class="language-css">            </span></span><br><span class="line"><span class="language-css">            <span class="selector-class">.endpoint-header</span> &#123;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">flex-direction</span>: column;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">align-items</span>: flex-start;</span></span><br><span class="line"><span class="language-css">            &#125;</span></span><br><span class="line"><span class="language-css">            </span></span><br><span class="line"><span class="language-css">            <span class="selector-class">.method</span> &#123;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">margin-bottom</span>: <span class="number">5px</span>;</span></span><br><span class="line"><span class="language-css">            &#125;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h1</span>&gt;</span>🚀 Simple HTTP Server<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>A lightweight HTTP server written in C<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;server-status&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h2</span>&gt;</span>📊 Server Status<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;status-item&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;status-label&quot;</span>&gt;</span>Server Name:<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;status-value&quot;</span> <span class="attr">id</span>=<span class="string">&quot;server-name&quot;</span>&gt;</span>Simple-C-HTTP-Server<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;status-item&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;status-label&quot;</span>&gt;</span>Version:<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;status-value&quot;</span> <span class="attr">id</span>=<span class="string">&quot;server-version&quot;</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;status-item&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;status-label&quot;</span>&gt;</span>Current Time:<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;status-value&quot;</span> <span class="attr">id</span>=<span class="string">&quot;current-time&quot;</span>&gt;</span>Loading...<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;status-item&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;status-label&quot;</span>&gt;</span>Connection:<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;status-value&quot;</span> <span class="attr">id</span>=<span class="string">&quot;connection-status&quot;</span>&gt;</span>Active<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;api-tester&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h2</span>&gt;</span>🔌 API Endpoints Tester<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">            </span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;endpoint&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;endpoint-header&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;method get&quot;</span>&gt;</span>GET<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;endpoint-path&quot;</span>&gt;</span>/api/status<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;endpoint-description&quot;</span>&gt;</span>Get server status information in JSON format<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;test-button&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;testEndpoint(&#x27;GET&#x27;, &#x27;/api/status&#x27;)&quot;</span>&gt;</span>Test Endpoint<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            </span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;endpoint&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;endpoint-header&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;method post&quot;</span>&gt;</span>POST<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;endpoint-path&quot;</span>&gt;</span>/api/echo<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;endpoint-description&quot;</span>&gt;</span>Echo back POST data as JSON<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;echo-data&quot;</span> <span class="attr">placeholder</span>=<span class="string">&#x27;Enter JSON data: &#123;&quot;message&quot;: &quot;hello&quot;&#125;&#x27;</span> </span></span><br><span class="line"><span class="tag">                       <span class="attr">style</span>=<span class="string">&quot;width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;test-button&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;testEchoEndpoint()&quot;</span>&gt;</span>Test Echo<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            </span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;endpoint&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;endpoint-header&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;method get&quot;</span>&gt;</span>GET<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;endpoint-path&quot;</span>&gt;</span>/static/style.css<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;endpoint-description&quot;</span>&gt;</span>Get static CSS file<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;test-button&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;testEndpoint(&#x27;GET&#x27;, &#x27;/static/style.css&#x27;)&quot;</span>&gt;</span>Test Endpoint<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            </span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;result-container&quot;</span> <span class="attr">class</span>=<span class="string">&quot;result-container&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;result-header&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span>&gt;</span>Response:<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;status-code&quot;</span> <span class="attr">id</span>=<span class="string">&quot;status-code&quot;</span>&gt;</span>200 OK<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;result-content&quot;</span> <span class="attr">id</span>=<span class="string">&quot;result-content&quot;</span>&gt;</span></span><br><span class="line">                    Response will appear here...</span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">footer</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>Simple C HTTP Server <span class="symbol">&amp;copy;</span> 2024 | Built for learning purposes<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">footer</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 更新时间</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">updateTime</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> now = <span class="keyword">new</span> <span class="title class_">Date</span>();</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;current-time&#x27;</span>).<span class="property">textContent</span> = now.<span class="title function_">toLocaleString</span>();</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 更新初始时间</span></span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">updateTime</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="built_in">setInterval</span>(updateTime, <span class="number">1000</span>);</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 显示测试结果</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">showResult</span>(<span class="params">statusCode, statusText, content</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> resultContainer = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;result-container&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> statusCodeElement = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;status-code&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> resultContent = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;result-content&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 格式化JSON响应</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> formattedContent = content;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> json = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(content);</span></span><br><span class="line"><span class="language-javascript">                formattedContent = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(json, <span class="literal">null</span>, <span class="number">2</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125; <span class="keyword">catch</span> (e) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 不是JSON，保持原样</span></span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 设置状态码</span></span></span><br><span class="line"><span class="language-javascript">            statusCodeElement.<span class="property">textContent</span> = <span class="string">`<span class="subst">$&#123;statusCode&#125;</span> <span class="subst">$&#123;statusText&#125;</span>`</span>;</span></span><br><span class="line"><span class="language-javascript">            statusCodeElement.<span class="property">className</span> = <span class="string">&#x27;status-code &#x27;</span> + </span></span><br><span class="line"><span class="language-javascript">                (statusCode &gt;= <span class="number">200</span> &amp;&amp; statusCode &lt; <span class="number">400</span> ? <span class="string">&#x27;success&#x27;</span> : <span class="string">&#x27;error&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 设置内容</span></span></span><br><span class="line"><span class="language-javascript">            resultContent.<span class="property">textContent</span> = formattedContent;</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 显示容器</span></span></span><br><span class="line"><span class="language-javascript">            resultContainer.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;block&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 滚动到结果</span></span></span><br><span class="line"><span class="language-javascript">            resultContainer.<span class="title function_">scrollIntoView</span>(&#123; <span class="attr">behavior</span>: <span class="string">&#x27;smooth&#x27;</span> &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 测试端点</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">testEndpoint</span>(<span class="params">method, endpoint</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> resultContainer = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;result-container&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            resultContainer.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(endpoint, &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">method</span>: method</span></span><br><span class="line"><span class="language-javascript">                &#125;);</span></span><br><span class="line"><span class="language-javascript">                </span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> text = <span class="keyword">await</span> response.<span class="title function_">text</span>();</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">showResult</span>(response.<span class="property">status</span>, response.<span class="property">statusText</span>, text);</span></span><br><span class="line"><span class="language-javascript">            &#125; <span class="keyword">catch</span> (error) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">showResult</span>(<span class="number">0</span>, <span class="string">&#x27;Error&#x27;</span>, <span class="string">&#x27;Failed to connect to server: &#x27;</span> + error.<span class="property">message</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 测试echo端点</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">testEchoEndpoint</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> input = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;echo-data&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> data = input.<span class="property">value</span>.<span class="title function_">trim</span>();</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 如果没有输入，使用默认值</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (!data) &#123;</span></span><br><span class="line"><span class="language-javascript">                data = <span class="string">&#x27;&#123;&quot;message&quot;: &quot;Hello from browser!&quot;&#125;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                input.<span class="property">value</span> = data;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 验证JSON格式</span></span></span><br><span class="line"><span class="language-javascript">                <span class="title class_">JSON</span>.<span class="title function_">parse</span>(data);</span></span><br><span class="line"><span class="language-javascript">                </span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;/api/echo&#x27;</span>, &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">headers</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span></span><br><span class="line"><span class="language-javascript">                    &#125;,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">body</span>: data</span></span><br><span class="line"><span class="language-javascript">                &#125;);</span></span><br><span class="line"><span class="language-javascript">                </span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> text = <span class="keyword">await</span> response.<span class="title function_">text</span>();</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">showResult</span>(response.<span class="property">status</span>, response.<span class="property">statusText</span>, text);</span></span><br><span class="line"><span class="language-javascript">            &#125; <span class="keyword">catch</span> (error) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (error <span class="keyword">instanceof</span> <span class="title class_">SyntaxError</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">showResult</span>(<span class="number">400</span>, <span class="string">&#x27;Bad Request&#x27;</span>, <span class="string">&#x27;Invalid JSON format&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">showResult</span>(<span class="number">0</span>, <span class="string">&#x27;Error&#x27;</span>, <span class="string">&#x27;Failed to connect to server: &#x27;</span> + error.<span class="property">message</span>);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 页面加载时自动测试状态端点</span></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;load&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">testEndpoint</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/api/status&#x27;</span>), <span class="number">1000</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* static_examples/style.css */</span></span><br><span class="line"><span class="comment">/* This file is referenced by index.html */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Additional styles for the test page */</span></span><br><span class="line"><span class="selector-class">.code-block</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#f4f4f4</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">font-family</span>: <span class="string">&#x27;Courier New&#x27;</span>, monospace;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">15px</span> <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">overflow-x</span>: auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.code-block</span> pre &#123;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.highlight</span> &#123;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="number">#fff3cd</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">2px</span> <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">3px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.info-box</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#e7f3fe</span>;</span><br><span class="line">    <span class="attribute">border-left</span>: <span class="number">4px</span> solid <span class="number">#2196F3</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">20px</span> <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">0</span> <span class="number">5px</span> <span class="number">5px</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.warning-box</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#fff3cd</span>;</span><br><span class="line">    <span class="attribute">border-left</span>: <span class="number">4px</span> solid <span class="number">#ffc107</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">20px</span> <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">0</span> <span class="number">5px</span> <span class="number">5px</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.example-request</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#e8f5e9</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">15px</span> <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">border-left</span>: <span class="number">4px</span> solid <span class="number">#4caf50</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.example-response</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#fce4ec</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">15px</span> <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">border-left</span>: <span class="number">4px</span> solid <span class="number">#e91e63</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Responsive table */</span></span><br><span class="line"><span class="selector-class">.responsive-table</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">overflow-x</span>: auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.responsive-table</span> <span class="selector-tag">table</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">border-collapse</span>: collapse;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.responsive-table</span> <span class="selector-tag">th</span>,</span><br><span class="line"><span class="selector-class">.responsive-table</span> <span class="selector-tag">td</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">12px</span> <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">text-align</span>: left;</span><br><span class="line">    <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="number">#ddd</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.responsive-table</span> <span class="selector-tag">th</span> &#123;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="number">#667eea</span>;</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.responsive-table</span> <span class="selector-tag">tr</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="number">#f5f5f5</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* static_examples/data.json */</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Simple C HTTP Server&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;features&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;HTTP/1.1 compliant&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;GET, POST, HEAD, OPTIONS methods&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;Static file serving&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;JSON API endpoints&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;Configurable logging&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;Graceful shutdown&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;endpoints&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;/&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Home page&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;/api/status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Server status&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;/api/echo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Echo POST data&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;/static/*&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Static files&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;operational&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="2-5-2-创建测试脚本"><a href="#2-5-2-创建测试脚本" class="headerlink" title="2.5.2 创建测试脚本"></a>2.5.2 创建测试脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># scripts/test_server.sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 编译服务器 ===&quot;</span></span><br><span class="line">make clean</span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 检查编译结果 ===&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">&quot;http_server&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;编译失败!&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 启动测试服务器（后台运行）===&quot;</span></span><br><span class="line">./http_server -p 8081 -r . &amp;</span><br><span class="line">SERVER_PID=$!</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;服务器进程ID: <span class="variable">$SERVER_PID</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 等待服务器启动</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n等待服务器启动...&quot;</span></span><br><span class="line"><span class="built_in">sleep</span> 3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查服务器是否运行</span></span><br><span class="line"><span class="keyword">if</span> ! <span class="built_in">kill</span> -0 <span class="variable">$SERVER_PID</span> 2&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;服务器启动失败!&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 开始测试 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试函数</span></span><br><span class="line"><span class="function"><span class="title">test_endpoint</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> method=<span class="variable">$1</span></span><br><span class="line">    <span class="built_in">local</span> endpoint=<span class="variable">$2</span></span><br><span class="line">    <span class="built_in">local</span> data=<span class="variable">$3</span></span><br><span class="line">    <span class="built_in">local</span> expected_status=<span class="variable">$4</span></span><br><span class="line">    <span class="built_in">local</span> test_name=<span class="variable">$5</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\n--- 测试: <span class="variable">$test_name</span> ---&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;请求: <span class="variable">$method</span> <span class="variable">$endpoint</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$data</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        response=$(curl -s -w <span class="string">&quot;\nHTTP状态码: %&#123;http_code&#125;&quot;</span> -X <span class="variable">$method</span> -H <span class="string">&quot;Content-Type: application/json&quot;</span> -d <span class="string">&quot;<span class="variable">$data</span>&quot;</span> <span class="string">&quot;http://localhost:8081<span class="variable">$endpoint</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        response=$(curl -s -w <span class="string">&quot;\nHTTP状态码: %&#123;http_code&#125;&quot;</span> -X <span class="variable">$method</span> <span class="string">&quot;http://localhost:8081<span class="variable">$endpoint</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 提取状态码</span></span><br><span class="line">    status_code=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$response</span>&quot;</span> | <span class="built_in">tail</span> -n 1 | grep -o <span class="string">&#x27;[0-9]*&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$status_code</span>&quot;</span> = <span class="string">&quot;<span class="variable">$expected_status</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;✓ 通过: 状态码 <span class="variable">$status_code</span> 符合预期&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;✗ 失败: 期望 <span class="variable">$expected_status</span>, 得到 <span class="variable">$status_code</span>&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;响应内容:&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$response</span>&quot;</span> | <span class="built_in">head</span> -n -1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行测试</span></span><br><span class="line">test_endpoint <span class="string">&quot;GET&quot;</span> <span class="string">&quot;/&quot;</span> <span class="string">&quot;&quot;</span> <span class="string">&quot;200&quot;</span> <span class="string">&quot;首页&quot;</span></span><br><span class="line">test_endpoint <span class="string">&quot;GET&quot;</span> <span class="string">&quot;/api/status&quot;</span> <span class="string">&quot;&quot;</span> <span class="string">&quot;200&quot;</span> <span class="string">&quot;API状态&quot;</span></span><br><span class="line">test_endpoint <span class="string">&quot;GET&quot;</span> <span class="string">&quot;/static/index.html&quot;</span> <span class="string">&quot;&quot;</span> <span class="string">&quot;200&quot;</span> <span class="string">&quot;静态HTML文件&quot;</span></span><br><span class="line">test_endpoint <span class="string">&quot;GET&quot;</span> <span class="string">&quot;/static/style.css&quot;</span> <span class="string">&quot;&quot;</span> <span class="string">&quot;200&quot;</span> <span class="string">&quot;静态CSS文件&quot;</span></span><br><span class="line">test_endpoint <span class="string">&quot;GET&quot;</span> <span class="string">&quot;/static/data.json&quot;</span> <span class="string">&quot;&quot;</span> <span class="string">&quot;200&quot;</span> <span class="string">&quot;静态JSON文件&quot;</span></span><br><span class="line">test_endpoint <span class="string">&quot;GET&quot;</span> <span class="string">&quot;/nonexistent&quot;</span> <span class="string">&quot;&quot;</span> <span class="string">&quot;404&quot;</span> <span class="string">&quot;不存在的页面&quot;</span></span><br><span class="line">test_endpoint <span class="string">&quot;POST&quot;</span> <span class="string">&quot;/api/echo&quot;</span> <span class="string">&#x27;&#123;&quot;test&quot;: &quot;data&quot;&#125;&#x27;</span> <span class="string">&quot;200&quot;</span> <span class="string">&quot;Echo API&quot;</span></span><br><span class="line">test_endpoint <span class="string">&quot;OPTIONS&quot;</span> <span class="string">&quot;/&quot;</span> <span class="string">&quot;&quot;</span> <span class="string">&quot;204&quot;</span> <span class="string">&quot;OPTIONS方法&quot;</span></span><br><span class="line">test_endpoint <span class="string">&quot;HEAD&quot;</span> <span class="string">&quot;/&quot;</span> <span class="string">&quot;&quot;</span> <span class="string">&quot;200&quot;</span> <span class="string">&quot;HEAD方法&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 测试文件上传和下载 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;创建测试文件...&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;This is a test file content.&quot;</span> &gt; /tmp/test_upload.txt</span><br><span class="line">curl -s -X POST --data-binary @/tmp/test_upload.txt http://localhost:8081/api/echo &gt; /tmp/test_download.txt</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> cmp -s /tmp/test_upload.txt /tmp/test_download.txt; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✓ 文件内容正确传输&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✗ 文件内容不一致&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 查看服务器日志 ===&quot;</span></span><br><span class="line"><span class="built_in">tail</span> -n 20 logs/server.log</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 停止测试服务器 ===&quot;</span></span><br><span class="line"><span class="built_in">kill</span> <span class="variable">$SERVER_PID</span></span><br><span class="line"><span class="built_in">wait</span> <span class="variable">$SERVER_PID</span> 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 清理临时文件 ===&quot;</span></span><br><span class="line"><span class="built_in">rm</span> -f /tmp/test_upload.txt /tmp/test_download.txt</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 测试完成 ===&quot;</span></span><br></pre></td></tr></table></figure>



<h2 id="2-6-编译和测试"><a href="#2-6-编译和测试" class="headerlink" title="2.6 编译和测试"></a>2.6 编译和测试</h2><h3 id="2-6-1-初始化项目"><a href="#2-6-1-初始化项目" class="headerlink" title="2.6.1 初始化项目"></a>2.6.1 初始化项目</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建目录结构</span></span><br><span class="line">make init</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置测试文件</span></span><br><span class="line">make setup-test</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译项目</span></span><br><span class="line">make</span><br></pre></td></tr></table></figure>



<h3 id="2-6-2-运行服务器"><a href="#2-6-2-运行服务器" class="headerlink" title="2.6.2 运行服务器"></a>2.6.2 运行服务器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行服务器</span></span><br><span class="line">./http_server -p 8080 -r .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用make命令</span></span><br><span class="line">make run</span><br></pre></td></tr></table></figure>



<h3 id="2-6-3-测试服务器"><a href="#2-6-3-测试服务器" class="headerlink" title="2.6.3 测试服务器"></a>2.6.3 测试服务器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行测试套件</span></span><br><span class="line">make <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 手动测试</span></span><br><span class="line">curl http://localhost:8080/</span><br><span class="line">curl http://localhost:8080/api/status</span><br><span class="line">curl -X POST http://localhost:8080/api/echo -d <span class="string">&#x27;&#123;&quot;message&quot;: &quot;test&quot;&#125;&#x27;</span></span><br><span class="line">curl -X OPTIONS http://localhost:8080/</span><br><span class="line">curl -I http://localhost:8080/  <span class="comment"># HEAD请求</span></span><br></pre></td></tr></table></figure>



<h3 id="2-6-4-调试和优化"><a href="#2-6-4-调试和优化" class="headerlink" title="2.6.4 调试和优化"></a>2.6.4 调试和优化</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用gdb调试</span></span><br><span class="line">make debug</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内存泄漏检查</span></span><br><span class="line">make valgrind</span><br><span class="line"></span><br><span class="line"><span class="comment"># 性能测试</span></span><br><span class="line">ab -n 1000 -c 10 http://localhost:8080/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看实时日志</span></span><br><span class="line"><span class="built_in">tail</span> -f logs/server.log</span><br></pre></td></tr></table></figure>



<h2 id="2-7-总结"><a href="#2-7-总结" class="headerlink" title="2.7 总结"></a>2.7 总结</h2><p>在这个阶段，我们实现了完整的HTTP请求解析和响应构建系统：</p>
<h3 id="实现的功能："><a href="#实现的功能：" class="headerlink" title="实现的功能："></a>实现的功能：</h3><ol>
<li><strong>完整的HTTP请求解析</strong>：支持GET、POST、HEAD、OPTIONS等方法</li>
<li><strong>请求头解析</strong>：解析所有HTTP头部，支持链式存储</li>
<li><strong>URL解码</strong>：正确处理URL编码的路径和参数</li>
<li><strong>响应构建器</strong>：模块化的响应构建系统</li>
<li><strong>多MIME类型支持</strong>：自动识别文件类型</li>
<li><strong>API端点</strong>：实现了&#x2F;status和&#x2F;echo两个API端点</li>
<li><strong>静态文件服务</strong>：支持HTML、CSS、JS、JSON等文件类型</li>
<li><strong>错误处理</strong>：完善的错误响应（404、405、500等）</li>
</ol>
<h3 id="学到的技能："><a href="#学到的技能：" class="headerlink" title="学到的技能："></a>学到的技能：</h3><ol>
<li><strong>数据结构设计</strong>：链表（请求头、响应头）</li>
<li><strong>内存管理</strong>：动态分配和释放，避免内存泄漏</li>
<li><strong>字符串处理</strong>：复杂的字符串解析和操作</li>
<li><strong>模块化设计</strong>：分离请求、响应、日志等模块</li>
<li><strong>HTTP协议细节</strong>：深入理解HTTP&#x2F;1.1协议</li>
<li><strong>调试技巧</strong>：使用gdb、valgrind等工具</li>
</ol>
<h3 id="运维和调试技巧："><a href="#运维和调试技巧：" class="headerlink" title="运维和调试技巧："></a>运维和调试技巧：</h3><ol>
<li><strong>结构化日志</strong>：便于问题排查</li>
<li><strong>内存检查</strong>：使用valgrind检测内存泄漏</li>
<li><strong>性能测试</strong>：使用ab进行压力测试</li>
<li><strong>错误处理</strong>：完善的错误响应和日志记录</li>
</ol>
<p>现在你已经拥有了一个功能完整的HTTP服务器！在阶段3中，我们将实现线程池来提高服务器的并发处理能力。</p>
<h1 id="阶段3：实现线程池和多线程支持"><a href="#阶段3：实现线程池和多线程支持" class="headerlink" title="阶段3：实现线程池和多线程支持"></a>阶段3：实现线程池和多线程支持</h1><p>在这个阶段，我们将实现线程池来支持并发处理多个客户端连接，大大提高服务器的性能。</p>
<h2 id="3-1-创建线程池模块"><a href="#3-1-创建线程池模块" class="headerlink" title="3.1 创建线程池模块"></a>3.1 创建线程池模块</h2><h3 id="3-1-1-线程池头文件（thread-pool-h）"><a href="#3-1-1-线程池头文件（thread-pool-h）" class="headerlink" title="3.1.1 线程池头文件（thread_pool.h）"></a>3.1.1 线程池头文件（thread_pool.h）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/thread_pool.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> THREAD_POOL_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> THREAD_POOL_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 任务结构体</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Task</span> &#123;</span></span><br><span class="line">    <span class="type">void</span> (*function)(<span class="type">void</span> *arg);  <span class="comment">// 任务函数指针</span></span><br><span class="line">    <span class="type">void</span> *arg;                    <span class="comment">// 任务参数</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Task</span> *<span class="title">next</span>;</span>            <span class="comment">// 下一个任务</span></span><br><span class="line">&#125; Task;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线程池结构体</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">pthread_mutex_t</span> lock;         <span class="comment">// 互斥锁</span></span><br><span class="line">    <span class="type">pthread_cond_t</span> notify;        <span class="comment">// 条件变量</span></span><br><span class="line">    <span class="type">pthread_t</span> *threads;           <span class="comment">// 线程数组</span></span><br><span class="line">    Task *task_queue;             <span class="comment">// 任务队列头</span></span><br><span class="line">    Task *task_queue_tail;        <span class="comment">// 任务队列尾</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> thread_count;             <span class="comment">// 线程数量</span></span><br><span class="line">    <span class="type">int</span> queue_size;               <span class="comment">// 任务队列大小</span></span><br><span class="line">    <span class="type">int</span> task_count;               <span class="comment">// 当前任务数量</span></span><br><span class="line">    <span class="type">int</span> shutdown;                 <span class="comment">// 关闭标志</span></span><br><span class="line">    <span class="type">int</span> started;                  <span class="comment">// 已启动线程数量</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> min_threads;              <span class="comment">// 最小线程数</span></span><br><span class="line">    <span class="type">int</span> max_threads;              <span class="comment">// 最大线程数</span></span><br><span class="line">    <span class="type">int</span> active_threads;           <span class="comment">// 活动线程数</span></span><br><span class="line">    <span class="type">int</span> idle_threads;             <span class="comment">// 空闲线程数</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">long</span> total_tasks;             <span class="comment">// 总任务数</span></span><br><span class="line">    <span class="type">long</span> completed_tasks;         <span class="comment">// 完成任务数</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">start_time</span>;</span>    <span class="comment">// 启动时间</span></span><br><span class="line">&#125; ThreadPool;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 工作线程参数</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    ThreadPool *pool;</span><br><span class="line">    <span class="type">int</span> thread_id;</span><br><span class="line">&#125; WorkerThread;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建线程池</span></span><br><span class="line">ThreadPool* <span class="title function_">thread_pool_create</span><span class="params">(<span class="type">int</span> min_threads, <span class="type">int</span> max_threads, <span class="type">int</span> queue_size)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向线程池添加任务</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">thread_pool_add_task</span><span class="params">(ThreadPool *pool, <span class="type">void</span> (*function)(<span class="type">void</span> *), <span class="type">void</span> *arg)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取线程池状态</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">thread_pool_get_stats</span><span class="params">(ThreadPool *pool, </span></span><br><span class="line"><span class="params">                          <span class="type">int</span> *active_threads, </span></span><br><span class="line"><span class="params">                          <span class="type">int</span> *idle_threads,</span></span><br><span class="line"><span class="params">                          <span class="type">int</span> *queue_size,</span></span><br><span class="line"><span class="params">                          <span class="type">long</span> *total_tasks,</span></span><br><span class="line"><span class="params">                          <span class="type">long</span> *completed_tasks,</span></span><br><span class="line"><span class="params">                          <span class="type">double</span> *uptime)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 销毁线程池</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">thread_pool_destroy</span><span class="params">(ThreadPool *pool, <span class="type">int</span> graceful)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 等待所有任务完成</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">thread_pool_wait</span><span class="params">(ThreadPool *pool)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调整线程池大小</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">thread_pool_resize</span><span class="params">(ThreadPool *pool, <span class="type">int</span> min_threads, <span class="type">int</span> max_threads)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// THREAD_POOL_H</span></span></span><br></pre></td></tr></table></figure>



<h3 id="3-1-2-线程池实现（thread-pool-c）"><a href="#3-1-2-线程池实现（thread-pool-c）" class="headerlink" title="3.1.2 线程池实现（thread_pool.c）"></a>3.1.2 线程池实现（thread_pool.c）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/thread_pool.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/thread_pool.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/logger.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 静态函数声明</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">worker_thread</span><span class="params">(<span class="type">void</span> *thread_pool)</span>;</span><br><span class="line"><span class="type">static</span> Task* <span class="title function_">create_task</span><span class="params">(<span class="type">void</span> (*function)(<span class="type">void</span> *), <span class="type">void</span> *arg)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">free_task</span><span class="params">(Task *task)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">add_task_to_queue</span><span class="params">(ThreadPool *pool, Task *task)</span>;</span><br><span class="line"><span class="type">static</span> Task* <span class="title function_">get_task_from_queue</span><span class="params">(ThreadPool *pool)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">adjust_thread_pool</span><span class="params">(ThreadPool *pool)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算时间差（毫秒）</span></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">timeval_diff_ms</span><span class="params">(<span class="keyword">struct</span> timeval *start, <span class="keyword">struct</span> timeval *end)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (end-&gt;tv_sec - start-&gt;tv_sec) * <span class="number">1000</span> + </span><br><span class="line">           (end-&gt;tv_usec - start-&gt;tv_usec) / <span class="number">1000</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建任务</span></span><br><span class="line"><span class="type">static</span> Task* <span class="title function_">create_task</span><span class="params">(<span class="type">void</span> (*function)(<span class="type">void</span> *), <span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">    Task *task = (Task*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Task));</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to allocate memory for task&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    task-&gt;function = function;</span><br><span class="line">    task-&gt;arg = arg;</span><br><span class="line">    task-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> task;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放任务</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">free_task</span><span class="params">(Task *task)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (task != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">free</span>(task);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建线程池</span></span><br><span class="line">ThreadPool* <span class="title function_">thread_pool_create</span><span class="params">(<span class="type">int</span> min_threads, <span class="type">int</span> max_threads, <span class="type">int</span> queue_size)</span> &#123;</span><br><span class="line">    ThreadPool *pool = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 参数检查</span></span><br><span class="line">    <span class="keyword">if</span> (min_threads &lt;= <span class="number">0</span> || max_threads &lt;= <span class="number">0</span> || min_threads &gt; max_threads || queue_size &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Invalid thread pool parameters&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 分配内存</span></span><br><span class="line">    pool = (ThreadPool*)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(ThreadPool));</span><br><span class="line">    <span class="keyword">if</span> (pool == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to allocate memory for thread pool&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化字段</span></span><br><span class="line">    pool-&gt;min_threads = min_threads;</span><br><span class="line">    pool-&gt;max_threads = max_threads;</span><br><span class="line">    pool-&gt;queue_size = queue_size;</span><br><span class="line">    pool-&gt;thread_count = min_threads;</span><br><span class="line">    pool-&gt;active_threads = <span class="number">0</span>;</span><br><span class="line">    pool-&gt;idle_threads = <span class="number">0</span>;</span><br><span class="line">    pool-&gt;task_count = <span class="number">0</span>;</span><br><span class="line">    pool-&gt;total_tasks = <span class="number">0</span>;</span><br><span class="line">    pool-&gt;completed_tasks = <span class="number">0</span>;</span><br><span class="line">    pool-&gt;shutdown = <span class="number">0</span>;</span><br><span class="line">    pool-&gt;started = <span class="number">0</span>;</span><br><span class="line">    pool-&gt;task_queue = <span class="literal">NULL</span>;</span><br><span class="line">    pool-&gt;task_queue_tail = <span class="literal">NULL</span>;</span><br><span class="line">    gettimeofday(&amp;pool-&gt;start_time, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化互斥锁和条件变量</span></span><br><span class="line">    <span class="keyword">if</span> (pthread_mutex_init(&amp;pool-&gt;lock, <span class="literal">NULL</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to initialize mutex&quot;</span>);</span><br><span class="line">        <span class="built_in">free</span>(pool);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (pthread_cond_init(&amp;pool-&gt;notify, <span class="literal">NULL</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to initialize condition variable&quot;</span>);</span><br><span class="line">        pthread_mutex_destroy(&amp;pool-&gt;lock);</span><br><span class="line">        <span class="built_in">free</span>(pool);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 分配线程数组</span></span><br><span class="line">    pool-&gt;threads = (<span class="type">pthread_t</span>*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">pthread_t</span>) * max_threads);</span><br><span class="line">    <span class="keyword">if</span> (pool-&gt;threads == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to allocate memory for threads&quot;</span>);</span><br><span class="line">        pthread_mutex_destroy(&amp;pool-&gt;lock);</span><br><span class="line">        pthread_cond_destroy(&amp;pool-&gt;notify);</span><br><span class="line">        <span class="built_in">free</span>(pool);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建工作线程</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; min_threads; i++) &#123;</span><br><span class="line">        WorkerThread *worker = (WorkerThread*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(WorkerThread));</span><br><span class="line">        <span class="keyword">if</span> (worker == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            LOG_ERROR(<span class="string">&quot;Failed to allocate memory for worker thread&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        worker-&gt;pool = pool;</span><br><span class="line">        worker-&gt;thread_id = i;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (pthread_create(&amp;pool-&gt;threads[i], <span class="literal">NULL</span>, worker_thread, (<span class="type">void</span>*)worker) != <span class="number">0</span>) &#123;</span><br><span class="line">            LOG_ERROR(<span class="string">&quot;Failed to create worker thread %d&quot;</span>, i);</span><br><span class="line">            <span class="built_in">free</span>(worker);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        pool-&gt;started++;</span><br><span class="line">        LOG_DEBUG(<span class="string">&quot;Created worker thread %d&quot;</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Thread pool created: min=%d, max=%d, queue=%d&quot;</span>, </span><br><span class="line">             min_threads, max_threads, queue_size);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> pool;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 工作线程函数</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">worker_thread</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">    WorkerThread *worker = (WorkerThread*)arg;</span><br><span class="line">    ThreadPool *pool = worker-&gt;pool;</span><br><span class="line">    <span class="type">int</span> thread_id = worker-&gt;thread_id;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放worker结构体，我们不再需要它</span></span><br><span class="line">    <span class="built_in">free</span>(worker);</span><br><span class="line">    </span><br><span class="line">    LOG_DEBUG(<span class="string">&quot;Worker thread %d started&quot;</span>, thread_id);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        pthread_mutex_lock(&amp;pool-&gt;lock);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 等待任务或关闭信号</span></span><br><span class="line">        <span class="keyword">while</span> (pool-&gt;task_count == <span class="number">0</span> &amp;&amp; !pool-&gt;shutdown) &#123;</span><br><span class="line">            pool-&gt;idle_threads++;</span><br><span class="line">            pthread_cond_wait(&amp;pool-&gt;notify, &amp;pool-&gt;lock);</span><br><span class="line">            pool-&gt;idle_threads--;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查是否应该退出</span></span><br><span class="line">        <span class="keyword">if</span> (pool-&gt;shutdown) &#123;</span><br><span class="line">            pthread_mutex_unlock(&amp;pool-&gt;lock);</span><br><span class="line">            LOG_DEBUG(<span class="string">&quot;Worker thread %d exiting&quot;</span>, thread_id);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取任务</span></span><br><span class="line">        Task *task = get_task_from_queue(pool);</span><br><span class="line">        <span class="keyword">if</span> (task == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            pthread_mutex_unlock(&amp;pool-&gt;lock);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        pool-&gt;active_threads++;</span><br><span class="line">        pthread_mutex_unlock(&amp;pool-&gt;lock);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 执行任务</span></span><br><span class="line">        LOG_DEBUG(<span class="string">&quot;Worker thread %d executing task&quot;</span>, thread_id);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 记录任务开始时间</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">task_start</span>, <span class="title">task_end</span>;</span></span><br><span class="line">        gettimeofday(&amp;task_start, <span class="literal">NULL</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 执行任务函数</span></span><br><span class="line">        <span class="keyword">if</span> (task-&gt;function != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            task-&gt;function(task-&gt;arg);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 记录任务结束时间</span></span><br><span class="line">        gettimeofday(&amp;task_end, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="type">long</span> task_time = timeval_diff_ms(&amp;task_start, &amp;task_end);</span><br><span class="line">        </span><br><span class="line">        pthread_mutex_lock(&amp;pool-&gt;lock);</span><br><span class="line">        pool-&gt;active_threads--;</span><br><span class="line">        pool-&gt;completed_tasks++;</span><br><span class="line">        pthread_mutex_unlock(&amp;pool-&gt;lock);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 记录长任务（&gt;100ms）</span></span><br><span class="line">        <span class="keyword">if</span> (task_time &gt; <span class="number">100</span>) &#123;</span><br><span class="line">            LOG_WARNING(<span class="string">&quot;Task took %ld ms to complete (thread %d)&quot;</span>, task_time, thread_id);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 释放任务</span></span><br><span class="line">        free_task(task);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_lock(&amp;pool-&gt;lock);</span><br><span class="line">    pool-&gt;started--;</span><br><span class="line">    pthread_mutex_unlock(&amp;pool-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向任务队列添加任务</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">add_task_to_queue</span><span class="params">(ThreadPool *pool, Task *task)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (pool == <span class="literal">NULL</span> || task == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_lock(&amp;pool-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查队列是否已满（如果queue_size为0表示无限制）</span></span><br><span class="line">    <span class="keyword">if</span> (pool-&gt;queue_size &gt; <span class="number">0</span> &amp;&amp; pool-&gt;task_count &gt;= pool-&gt;queue_size) &#123;</span><br><span class="line">        pthread_mutex_unlock(&amp;pool-&gt;lock);</span><br><span class="line">        LOG_WARNING(<span class="string">&quot;Task queue is full&quot;</span>);</span><br><span class="line">        free_task(task);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加到队列尾部</span></span><br><span class="line">    <span class="keyword">if</span> (pool-&gt;task_queue == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        pool-&gt;task_queue = task;</span><br><span class="line">        pool-&gt;task_queue_tail = task;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pool-&gt;task_queue_tail-&gt;next = task;</span><br><span class="line">        pool-&gt;task_queue_tail = task;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pool-&gt;task_count++;</span><br><span class="line">    pool-&gt;total_tasks++;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_unlock(&amp;pool-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 通知一个等待的线程</span></span><br><span class="line">    pthread_cond_signal(&amp;pool-&gt;notify);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从任务队列获取任务</span></span><br><span class="line"><span class="type">static</span> Task* <span class="title function_">get_task_from_queue</span><span class="params">(ThreadPool *pool)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (pool == <span class="literal">NULL</span> || pool-&gt;task_count == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Task *task = pool-&gt;task_queue;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (task != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        pool-&gt;task_queue = task-&gt;next;</span><br><span class="line">        pool-&gt;task_count--;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (pool-&gt;task_queue == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            pool-&gt;task_queue_tail = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        task-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> task;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向线程池添加任务</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">thread_pool_add_task</span><span class="params">(ThreadPool *pool, <span class="type">void</span> (*function)(<span class="type">void</span> *), <span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (pool == <span class="literal">NULL</span> || function == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (pool-&gt;shutdown) &#123;</span><br><span class="line">        LOG_WARNING(<span class="string">&quot;Cannot add task to shutdown thread pool&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建任务</span></span><br><span class="line">    Task *task = create_task(function, arg);</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加到队列</span></span><br><span class="line">    <span class="type">int</span> result = add_task_to_queue(pool, task);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果需要，调整线程池大小</span></span><br><span class="line">    <span class="keyword">if</span> (result == <span class="number">0</span>) &#123;</span><br><span class="line">        adjust_thread_pool(pool);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调整线程池大小（根据负载动态调整）</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">adjust_thread_pool</span><span class="params">(ThreadPool *pool)</span> &#123;</span><br><span class="line">    pthread_mutex_lock(&amp;pool-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算平均任务等待时间</span></span><br><span class="line">    <span class="type">long</span> avg_wait_time = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (pool-&gt;completed_tasks &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">now</span>;</span></span><br><span class="line">        gettimeofday(&amp;now, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="type">long</span> uptime_ms = timeval_diff_ms(&amp;pool-&gt;start_time, &amp;now);</span><br><span class="line">        avg_wait_time = uptime_ms / pool-&gt;completed_tasks;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 动态调整线程数</span></span><br><span class="line">    <span class="keyword">if</span> (pool-&gt;task_count &gt; pool-&gt;active_threads * <span class="number">2</span> &amp;&amp; </span><br><span class="line">        pool-&gt;thread_count &lt; pool-&gt;max_threads) &#123;</span><br><span class="line">        <span class="comment">// 需要更多线程</span></span><br><span class="line">        <span class="type">int</span> threads_to_add = pool-&gt;task_count / <span class="number">2</span> - pool-&gt;active_threads;</span><br><span class="line">        <span class="keyword">if</span> (threads_to_add &gt; pool-&gt;max_threads - pool-&gt;thread_count) &#123;</span><br><span class="line">            threads_to_add = pool-&gt;max_threads - pool-&gt;thread_count;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; threads_to_add; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pool-&gt;started &gt;= pool-&gt;max_threads) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            WorkerThread *worker = (WorkerThread*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(WorkerThread));</span><br><span class="line">            <span class="keyword">if</span> (worker == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                LOG_ERROR(<span class="string">&quot;Failed to allocate memory for new worker thread&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            worker-&gt;pool = pool;</span><br><span class="line">            worker-&gt;thread_id = pool-&gt;started;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (pthread_create(&amp;pool-&gt;threads[pool-&gt;started], <span class="literal">NULL</span>, worker_thread, (<span class="type">void</span>*)worker) != <span class="number">0</span>) &#123;</span><br><span class="line">                LOG_ERROR(<span class="string">&quot;Failed to create new worker thread&quot;</span>);</span><br><span class="line">                <span class="built_in">free</span>(worker);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            pool-&gt;started++;</span><br><span class="line">            pool-&gt;thread_count++;</span><br><span class="line">            LOG_DEBUG(<span class="string">&quot;Added new worker thread, total: %d&quot;</span>, pool-&gt;thread_count);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pool-&gt;idle_threads &gt; pool-&gt;min_threads / <span class="number">2</span> &amp;&amp; </span><br><span class="line">               pool-&gt;thread_count &gt; pool-&gt;min_threads) &#123;</span><br><span class="line">        <span class="comment">// 线程过多，但这里我们不能直接杀死线程</span></span><br><span class="line">        <span class="comment">// 在实际应用中，可以实现优雅的线程退出机制</span></span><br><span class="line">        LOG_DEBUG(<span class="string">&quot;Thread pool has %d idle threads, consider reducing thread count&quot;</span>, pool-&gt;idle_threads);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_unlock(&amp;pool-&gt;lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取线程池状态</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">thread_pool_get_stats</span><span class="params">(ThreadPool *pool, </span></span><br><span class="line"><span class="params">                          <span class="type">int</span> *active_threads, </span></span><br><span class="line"><span class="params">                          <span class="type">int</span> *idle_threads,</span></span><br><span class="line"><span class="params">                          <span class="type">int</span> *queue_size,</span></span><br><span class="line"><span class="params">                          <span class="type">long</span> *total_tasks,</span></span><br><span class="line"><span class="params">                          <span class="type">long</span> *completed_tasks,</span></span><br><span class="line"><span class="params">                          <span class="type">double</span> *uptime)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (pool == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_lock(&amp;pool-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (active_threads != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *active_threads = pool-&gt;active_threads;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (idle_threads != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *idle_threads = pool-&gt;idle_threads;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (queue_size != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *queue_size = pool-&gt;task_count;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (total_tasks != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *total_tasks = pool-&gt;total_tasks;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (completed_tasks != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *completed_tasks = pool-&gt;completed_tasks;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (uptime != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">now</span>;</span></span><br><span class="line">        gettimeofday(&amp;now, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="type">long</span> uptime_ms = timeval_diff_ms(&amp;pool-&gt;start_time, &amp;now);</span><br><span class="line">        *uptime = uptime_ms / <span class="number">1000.0</span>;  <span class="comment">// 转换为秒</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_unlock(&amp;pool-&gt;lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 等待所有任务完成</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">thread_pool_wait</span><span class="params">(ThreadPool *pool)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (pool == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> wait_count = <span class="number">0</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> max_wait = <span class="number">100</span>;  <span class="comment">// 最大等待次数</span></span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> wait_interval = <span class="number">100000</span>;  <span class="comment">// 100ms</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (wait_count &lt; max_wait) &#123;</span><br><span class="line">        pthread_mutex_lock(&amp;pool-&gt;lock);</span><br><span class="line">        <span class="type">int</span> tasks_remaining = pool-&gt;task_count;</span><br><span class="line">        pthread_mutex_unlock(&amp;pool-&gt;lock);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (tasks_remaining == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        usleep(wait_interval);</span><br><span class="line">        wait_count++;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (wait_count % <span class="number">10</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            LOG_DEBUG(<span class="string">&quot;Waiting for %d tasks to complete...&quot;</span>, tasks_remaining);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    LOG_WARNING(<span class="string">&quot;Timeout waiting for tasks to complete&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 销毁线程池</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">thread_pool_destroy</span><span class="params">(ThreadPool *pool, <span class="type">int</span> graceful)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (pool == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Destroying thread pool (graceful=%d)&quot;</span>, graceful);</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_lock(&amp;pool-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (pool-&gt;shutdown) &#123;</span><br><span class="line">        pthread_mutex_unlock(&amp;pool-&gt;lock);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pool-&gt;shutdown = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (graceful) &#123;</span><br><span class="line">        <span class="comment">// 等待所有任务完成</span></span><br><span class="line">        pthread_mutex_unlock(&amp;pool-&gt;lock);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (thread_pool_wait(pool) != <span class="number">0</span>) &#123;</span><br><span class="line">            LOG_WARNING(<span class="string">&quot;Some tasks may not have completed before shutdown&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        pthread_mutex_lock(&amp;pool-&gt;lock);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 通知所有线程退出</span></span><br><span class="line">    pthread_cond_broadcast(&amp;pool-&gt;notify);</span><br><span class="line">    pthread_mutex_unlock(&amp;pool-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 等待所有线程退出</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pool-&gt;started; i++) &#123;</span><br><span class="line">        pthread_join(pool-&gt;threads[i], <span class="literal">NULL</span>);</span><br><span class="line">        LOG_DEBUG(<span class="string">&quot;Thread %d joined&quot;</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清理任务队列</span></span><br><span class="line">    pthread_mutex_lock(&amp;pool-&gt;lock);</span><br><span class="line">    Task *task = pool-&gt;task_queue;</span><br><span class="line">    <span class="keyword">while</span> (task != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        Task *next = task-&gt;next;</span><br><span class="line">        free_task(task);</span><br><span class="line">        task = next;</span><br><span class="line">    &#125;</span><br><span class="line">    pool-&gt;task_queue = <span class="literal">NULL</span>;</span><br><span class="line">    pool-&gt;task_queue_tail = <span class="literal">NULL</span>;</span><br><span class="line">    pthread_mutex_unlock(&amp;pool-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 销毁互斥锁和条件变量</span></span><br><span class="line">    pthread_mutex_destroy(&amp;pool-&gt;lock);</span><br><span class="line">    pthread_cond_destroy(&amp;pool-&gt;notify);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放线程数组</span></span><br><span class="line">    <span class="keyword">if</span> (pool-&gt;threads != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">free</span>(pool-&gt;threads);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算最终统计信息</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">end_time</span>;</span></span><br><span class="line">    gettimeofday(&amp;end_time, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="type">double</span> uptime = timeval_diff_ms(&amp;pool-&gt;start_time, &amp;end_time) / <span class="number">1000.0</span>;</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Thread pool destroyed: uptime=%.2fs, total_tasks=%ld, completed_tasks=%ld&quot;</span>,</span><br><span class="line">             uptime, pool-&gt;total_tasks, pool-&gt;completed_tasks);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放线程池结构体</span></span><br><span class="line">    <span class="built_in">free</span>(pool);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调整线程池大小</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">thread_pool_resize</span><span class="params">(ThreadPool *pool, <span class="type">int</span> min_threads, <span class="type">int</span> max_threads)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (pool == <span class="literal">NULL</span> || min_threads &lt;= <span class="number">0</span> || max_threads &lt;= <span class="number">0</span> || min_threads &gt; max_threads) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_lock(&amp;pool-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    pool-&gt;min_threads = min_threads;</span><br><span class="line">    pool-&gt;max_threads = max_threads;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果当前线程数小于新的最小线程数，创建新线程</span></span><br><span class="line">    <span class="keyword">while</span> (pool-&gt;thread_count &lt; min_threads &amp;&amp; pool-&gt;started &lt; max_threads) &#123;</span><br><span class="line">        WorkerThread *worker = (WorkerThread*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(WorkerThread));</span><br><span class="line">        <span class="keyword">if</span> (worker == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            LOG_ERROR(<span class="string">&quot;Failed to allocate memory for new worker thread&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        worker-&gt;pool = pool;</span><br><span class="line">        worker-&gt;thread_id = pool-&gt;started;</span><br><span class="line">        </span><br><span class="line">        pthread_mutex_unlock(&amp;pool-&gt;lock);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (pthread_create(&amp;pool-&gt;threads[pool-&gt;started], <span class="literal">NULL</span>, worker_thread, (<span class="type">void</span>*)worker) != <span class="number">0</span>) &#123;</span><br><span class="line">            LOG_ERROR(<span class="string">&quot;Failed to create new worker thread&quot;</span>);</span><br><span class="line">            <span class="built_in">free</span>(worker);</span><br><span class="line">            pthread_mutex_lock(&amp;pool-&gt;lock);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        pthread_mutex_lock(&amp;pool-&gt;lock);</span><br><span class="line">        pool-&gt;started++;</span><br><span class="line">        pool-&gt;thread_count++;</span><br><span class="line">        LOG_DEBUG(<span class="string">&quot;Added new worker thread during resize, total: %d&quot;</span>, pool-&gt;thread_count);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_unlock(&amp;pool-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Thread pool resized: min=%d, max=%d&quot;</span>, min_threads, max_threads);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-2-更新连接处理器模块"><a href="#3-2-更新连接处理器模块" class="headerlink" title="3.2 更新连接处理器模块"></a>3.2 更新连接处理器模块</h2><h3 id="3-2-1-连接处理器头文件（connection-h）"><a href="#3-2-1-连接处理器头文件（connection-h）" class="headerlink" title="3.2.1 连接处理器头文件（connection.h）"></a>3.2.1 连接处理器头文件（connection.h）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/connection.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONNECTION_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONNECTION_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/request.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/response.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接上下文结构体</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> client_socket;              <span class="comment">// 客户端socket</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client_addr</span>;</span> <span class="comment">// 客户端地址</span></span><br><span class="line">    ThreadPool *thread_pool;        <span class="comment">// 线程池指针</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">accept_time</span>;</span>     <span class="comment">// 接受连接的时间</span></span><br><span class="line">&#125; ConnectionContext;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理连接（线程池任务函数）</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handle_connection_task</span><span class="params">(<span class="type">void</span> *arg)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建连接上下文</span></span><br><span class="line">ConnectionContext* <span class="title function_">create_connection_context</span><span class="params">(<span class="type">int</span> client_socket, </span></span><br><span class="line"><span class="params">                                           <span class="keyword">struct</span> sockaddr_in *client_addr,</span></span><br><span class="line"><span class="params">                                           ThreadPool *thread_pool)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放连接上下文</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">free_connection_context</span><span class="params">(ConnectionContext *context)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取客户端IP地址字符串</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="title function_">get_client_ip</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> sockaddr_in *addr)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取客户端端口</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">get_client_port</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> sockaddr_in *addr)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置socket为非阻塞模式</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">set_socket_nonblocking</span><span class="params">(<span class="type">int</span> sockfd)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置socket为阻塞模式</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">set_socket_blocking</span><span class="params">(<span class="type">int</span> sockfd)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置socket接收超时</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">set_socket_receive_timeout</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">int</span> seconds)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置socket发送超时</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">set_socket_send_timeout</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">int</span> seconds)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// CONNECTION_H</span></span></span><br></pre></td></tr></table></figure>



<h3 id="3-2-2-连接处理器实现（connection-c）"><a href="#3-2-2-连接处理器实现（connection-c）" class="headerlink" title="3.2.2 连接处理器实现（connection.c）"></a>3.2.2 连接处理器实现（connection.c）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/connection.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/connection.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/logger.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/request.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/response.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建连接上下文</span></span><br><span class="line">ConnectionContext* <span class="title function_">create_connection_context</span><span class="params">(<span class="type">int</span> client_socket, </span></span><br><span class="line"><span class="params">                                           <span class="keyword">struct</span> sockaddr_in *client_addr,</span></span><br><span class="line"><span class="params">                                           ThreadPool *thread_pool)</span> &#123;</span><br><span class="line">    ConnectionContext *context = (ConnectionContext*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(ConnectionContext));</span><br><span class="line">    <span class="keyword">if</span> (context == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to allocate memory for connection context&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    context-&gt;client_socket = client_socket;</span><br><span class="line">    context-&gt;client_addr = *client_addr;</span><br><span class="line">    context-&gt;thread_pool = thread_pool;</span><br><span class="line">    gettimeofday(&amp;context-&gt;accept_time, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放连接上下文</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">free_connection_context</span><span class="params">(ConnectionContext *context)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (context != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">free</span>(context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取客户端IP地址字符串</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="title function_">get_client_ip</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> sockaddr_in *addr)</span> &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> ip_str[INET_ADDRSTRLEN];</span><br><span class="line">    inet_ntop(AF_INET, &amp;(addr-&gt;sin_addr), ip_str, INET_ADDRSTRLEN);</span><br><span class="line">    <span class="keyword">return</span> ip_str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取客户端端口</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">get_client_port</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> sockaddr_in *addr)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ntohs(addr-&gt;sin_port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置socket为非阻塞模式</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">set_socket_nonblocking</span><span class="params">(<span class="type">int</span> sockfd)</span> &#123;</span><br><span class="line">    <span class="type">int</span> flags = fcntl(sockfd, F_GETFL, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (flags == <span class="number">-1</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to get socket flags: %s&quot;</span>, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    flags |= O_NONBLOCK;</span><br><span class="line">    <span class="keyword">if</span> (fcntl(sockfd, F_SETFL, flags) == <span class="number">-1</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to set socket non-blocking: %s&quot;</span>, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置socket为阻塞模式</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">set_socket_blocking</span><span class="params">(<span class="type">int</span> sockfd)</span> &#123;</span><br><span class="line">    <span class="type">int</span> flags = fcntl(sockfd, F_GETFL, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (flags == <span class="number">-1</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to get socket flags: %s&quot;</span>, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    flags &amp;= ~O_NONBLOCK;</span><br><span class="line">    <span class="keyword">if</span> (fcntl(sockfd, F_SETFL, flags) == <span class="number">-1</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to set socket blocking: %s&quot;</span>, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置socket接收超时</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">set_socket_receive_timeout</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">int</span> seconds)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">timeout</span>;</span></span><br><span class="line">    timeout.tv_sec = seconds;</span><br><span class="line">    timeout.tv_usec = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (setsockopt(sockfd, SOL_SOCKET, SO_RCVTIMEO, &amp;timeout, <span class="keyword">sizeof</span>(timeout)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to set socket receive timeout: %s&quot;</span>, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置socket发送超时</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">set_socket_send_timeout</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">int</span> seconds)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">timeout</span>;</span></span><br><span class="line">    timeout.tv_sec = seconds;</span><br><span class="line">    timeout.tv_usec = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (setsockopt(sockfd, SOL_SOCKET, SO_SNDTIMEO, &amp;timeout, <span class="keyword">sizeof</span>(timeout)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to set socket send timeout: %s&quot;</span>, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取完整HTTP请求（处理分块读取）</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">read_complete_request</span><span class="params">(<span class="type">int</span> client_socket, <span class="type">char</span> *buffer, <span class="type">size_t</span> buffer_size, </span></span><br><span class="line"><span class="params">                         <span class="keyword">struct</span> sockaddr_in *client_addr)</span> &#123;</span><br><span class="line">    <span class="type">ssize_t</span> total_bytes = <span class="number">0</span>;</span><br><span class="line">    <span class="type">ssize_t</span> bytes_received;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置接收超时</span></span><br><span class="line">    set_socket_receive_timeout(client_socket, <span class="number">10</span>);  <span class="comment">// 10秒超时</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 循环读取直到收到完整请求</span></span><br><span class="line">    <span class="keyword">while</span> (total_bytes &lt; (<span class="type">ssize_t</span>)buffer_size - <span class="number">1</span>) &#123;</span><br><span class="line">        bytes_received = recv(client_socket, buffer + total_bytes, </span><br><span class="line">                             buffer_size - total_bytes - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (bytes_received &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            total_bytes += bytes_received;</span><br><span class="line">            buffer[total_bytes] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 检查是否收到了完整的HTTP请求（以空行结束）</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strstr</span>(buffer, <span class="string">&quot;\r\n\r\n&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="comment">// 如果有Content-Length，检查是否收到了完整body</span></span><br><span class="line">                <span class="type">char</span> *content_length_start = <span class="built_in">strstr</span>(buffer, <span class="string">&quot;Content-Length: &quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (content_length_start != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    <span class="type">long</span> content_length = strtol(content_length_start + <span class="number">16</span>, <span class="literal">NULL</span>, <span class="number">10</span>);</span><br><span class="line">                    <span class="type">char</span> *body_start = <span class="built_in">strstr</span>(buffer, <span class="string">&quot;\r\n\r\n&quot;</span>);</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (body_start != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                        body_start += <span class="number">4</span>;  <span class="comment">// 跳过空行</span></span><br><span class="line">                        <span class="type">size_t</span> body_received = total_bytes - (body_start - buffer);</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">if</span> (body_received &gt;= (<span class="type">size_t</span>)content_length) &#123;</span><br><span class="line">                            <span class="comment">// 收到了完整的body</span></span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 没有Content-Length，假设请求是完整的</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bytes_received == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 客户端关闭连接</span></span><br><span class="line">            LOG_DEBUG(<span class="string">&quot;Client closed connection while reading&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 读取错误</span></span><br><span class="line">            <span class="keyword">if</span> (errno == EAGAIN || errno == EWOULDBLOCK) &#123;</span><br><span class="line">                <span class="comment">// 超时，返回已读取的数据</span></span><br><span class="line">                LOG_WARNING(<span class="string">&quot;Socket read timeout from %s:%d&quot;</span>, </span><br><span class="line">                           get_client_ip(client_addr), get_client_port(client_addr));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                LOG_ERROR(<span class="string">&quot;Failed to read from socket: %s&quot;</span>, strerror(errno));</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> total_bytes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理HTTP请求并生成响应</span></span><br><span class="line">HttpResponse* <span class="title function_">process_http_request</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *request_data, <span class="type">size_t</span> request_length,</span></span><br><span class="line"><span class="params">                                  <span class="type">const</span> <span class="type">char</span> *client_ip, <span class="type">int</span> client_port)</span> &#123;</span><br><span class="line">    <span class="comment">// 解析HTTP请求</span></span><br><span class="line">    HttpRequest *req = parse_http_request(request_data, request_length);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (req == <span class="literal">NULL</span> || !req-&gt;is_valid) &#123;</span><br><span class="line">        LOG_WARNING(<span class="string">&quot;Invalid HTTP request from %s:%d&quot;</span>, client_ip, client_port);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 发送400错误响应</span></span><br><span class="line">        HttpResponse *error_resp = create_http_response(HTTP_1_1, HTTP_400_BAD_REQUEST);</span><br><span class="line">        <span class="keyword">if</span> (error_resp != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            set_response_html(error_resp, </span><br><span class="line">                <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;400 Bad Request&lt;/h1&gt;&lt;p&gt;Invalid HTTP request.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (req != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            free_http_request(req);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> error_resp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 记录请求信息</span></span><br><span class="line">    LOG_INFO(<span class="string">&quot;Request: %s %s (Version: %s) from %s:%d&quot;</span>, </span><br><span class="line">             http_method_to_string(req-&gt;method),</span><br><span class="line">             req-&gt;path,</span><br><span class="line">             http_version_to_string(req-&gt;version),</span><br><span class="line">             client_ip, client_port);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建响应</span></span><br><span class="line">    HttpResponse *resp = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据请求路径和方法处理</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strncmp</span>(req-&gt;path, <span class="string">&quot;/api/&quot;</span>, <span class="number">5</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// API端点</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(req-&gt;path, <span class="string">&quot;/api/status&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">char</span> status_json[<span class="number">512</span>];</span><br><span class="line">            <span class="built_in">snprintf</span>(status_json, <span class="keyword">sizeof</span>(status_json),</span><br><span class="line">                <span class="string">&quot;&#123;\&quot;status\&quot;: \&quot;running\&quot;, &quot;</span></span><br><span class="line">                <span class="string">&quot;\&quot;server\&quot;: \&quot;Threaded-C-HTTP-Server\&quot;, &quot;</span></span><br><span class="line">                <span class="string">&quot;\&quot;version\&quot;: \&quot;1.0\&quot;, &quot;</span></span><br><span class="line">                <span class="string">&quot;\&quot;timestamp\&quot;: %ld&#125;&quot;</span>,</span><br><span class="line">                time(<span class="literal">NULL</span>));</span><br><span class="line">            </span><br><span class="line">            resp = create_http_response(HTTP_1_1, HTTP_200_OK);</span><br><span class="line">            set_response_json(resp, status_json);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(req-&gt;path, <span class="string">&quot;/api/echo&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (req-&gt;method == HTTP_POST &amp;&amp; req-&gt;body != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="comment">// 原样返回POST的body</span></span><br><span class="line">                <span class="type">char</span> echo_response[<span class="number">1024</span>];</span><br><span class="line">                <span class="built_in">snprintf</span>(echo_response, <span class="keyword">sizeof</span>(echo_response),</span><br><span class="line">                        <span class="string">&quot;&#123;\&quot;method\&quot;: \&quot;POST\&quot;, \&quot;received\&quot;: %s, \&quot;status\&quot;: \&quot;success\&quot;&#125;&quot;</span>,</span><br><span class="line">                        req-&gt;body);</span><br><span class="line">                </span><br><span class="line">                resp = create_http_response(HTTP_1_1, HTTP_200_OK);</span><br><span class="line">                set_response_json(resp, echo_response);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                resp = create_http_response(HTTP_1_1, HTTP_405_METHOD_NOT_ALLOWED);</span><br><span class="line">                set_response_json(resp, <span class="string">&quot;&#123;\&quot;error\&quot;: \&quot;Method not allowed. Use POST.\&quot;&#125;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(req-&gt;path, <span class="string">&quot;/api/threadpool&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 线程池状态端点</span></span><br><span class="line">            resp = create_http_response(HTTP_1_1, HTTP_200_OK);</span><br><span class="line">            </span><br><span class="line">            <span class="type">char</span> threadpool_json[<span class="number">1024</span>];</span><br><span class="line">            <span class="built_in">snprintf</span>(threadpool_json, <span class="keyword">sizeof</span>(threadpool_json),</span><br><span class="line">                <span class="string">&quot;&#123;\&quot;endpoint\&quot;: \&quot;threadpool\&quot;, &quot;</span></span><br><span class="line">                <span class="string">&quot;\&quot;description\&quot;: \&quot;Thread pool information\&quot;, &quot;</span></span><br><span class="line">                <span class="string">&quot;\&quot;available\&quot;: true&#125;&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            set_response_json(resp, threadpool_json);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resp = create_http_response(HTTP_1_1, HTTP_404_NOT_FOUND);</span><br><span class="line">            set_response_json(resp, <span class="string">&quot;&#123;\&quot;error\&quot;: \&quot;API endpoint not found\&quot;&#125;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(req-&gt;path, <span class="string">&quot;/&quot;</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(req-&gt;path, <span class="string">&quot;/index.html&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 首页</span></span><br><span class="line">        resp = create_http_response(HTTP_1_1, HTTP_200_OK);</span><br><span class="line">        </span><br><span class="line">        <span class="type">char</span> *html_content = </span><br><span class="line">            <span class="string">&quot;&lt;!DOCTYPE html&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;html&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;head&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;title&gt;Threaded HTTP Server&lt;/title&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;style&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;body &#123; font-family: Arial, sans-serif; text-align: center; margin-top: 50px; &#125;&quot;</span></span><br><span class="line">            <span class="string">&quot;h1 &#123; color: #333; &#125;&quot;</span></span><br><span class="line">            <span class="string">&quot;.thread-info &#123; background: #e3f2fd; padding: 20px; margin: 20px auto; width: 60%; border-radius: 10px; &#125;&quot;</span></span><br><span class="line">            <span class="string">&quot;.stats &#123; background: #f5f5f5; padding: 15px; margin: 15px; border-radius: 5px; &#125;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;/style&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;/head&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;body&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;h1&gt;Welcome to Threaded HTTP Server&lt;/h1&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;div class=&#x27;thread-info&#x27;&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;h2&gt;Multi-Threaded Server&lt;/h2&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;p&gt;This server uses a thread pool to handle multiple connections concurrently.&lt;/p&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;/div&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;div class=&#x27;stats&#x27;&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;p&gt;&lt;strong&gt;Client IP:&lt;/strong&gt; %s&lt;/p&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;p&gt;&lt;strong&gt;Client Port:&lt;/strong&gt; %d&lt;/p&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;p&gt;&lt;strong&gt;Request Method:&lt;/strong&gt; %s&lt;/p&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;p&gt;&lt;strong&gt;Request Path:&lt;/strong&gt; %s&lt;/p&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;/div&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;/body&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;/html&gt;&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="type">char</span> formatted_html[<span class="number">2048</span>];</span><br><span class="line">        <span class="built_in">snprintf</span>(formatted_html, <span class="keyword">sizeof</span>(formatted_html), html_content,</span><br><span class="line">                client_ip, client_port,</span><br><span class="line">                http_method_to_string(req-&gt;method),</span><br><span class="line">                req-&gt;path);</span><br><span class="line">        </span><br><span class="line">        set_response_html(resp, formatted_html);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(req-&gt;path, <span class="string">&quot;/slow&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 慢速端点，用于测试并发处理</span></span><br><span class="line">        resp = create_http_response(HTTP_1_1, HTTP_200_OK);</span><br><span class="line">        </span><br><span class="line">        LOG_INFO(<span class="string">&quot;Processing slow request from %s:%d&quot;</span>, client_ip, client_port);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 模拟处理时间（2秒）</span></span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">char</span> *slow_response = </span><br><span class="line">            <span class="string">&quot;&#123;\&quot;endpoint\&quot;: \&quot;slow\&quot;, &quot;</span></span><br><span class="line">            <span class="string">&quot;\&quot;message\&quot;: \&quot;This request was intentionally delayed for 2 seconds\&quot;, &quot;</span></span><br><span class="line">            <span class="string">&quot;\&quot;purpose\&quot;: \&quot;Testing concurrent request handling\&quot;, &quot;</span></span><br><span class="line">            <span class="string">&quot;\&quot;status\&quot;: \&quot;completed\&quot;&#125;&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        set_response_json(resp, slow_response);</span><br><span class="line">        </span><br><span class="line">        LOG_INFO(<span class="string">&quot;Slow request completed for %s:%d&quot;</span>, client_ip, client_port);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 其他路径返回404</span></span><br><span class="line">        resp = create_http_response(HTTP_1_1, HTTP_404_NOT_FOUND);</span><br><span class="line">        </span><br><span class="line">        <span class="type">char</span> error_page[<span class="number">512</span>];</span><br><span class="line">        <span class="built_in">snprintf</span>(error_page, <span class="keyword">sizeof</span>(error_page),</span><br><span class="line">            <span class="string">&quot;&lt;html&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;body&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;h1&gt;404 Not Found&lt;/h1&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;p&gt;The requested resource &#x27;%s&#x27; was not found on this server.&lt;/p&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;hr&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;p&gt;&lt;em&gt;Threaded-C-HTTP-Server/1.0&lt;/em&gt;&lt;/p&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;/body&gt;&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;/html&gt;&quot;</span>,</span><br><span class="line">            req-&gt;path);</span><br><span class="line">        </span><br><span class="line">        set_response_html(resp, error_page);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放请求</span></span><br><span class="line">    free_http_request(req);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> resp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理连接（线程池任务函数）</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handle_connection_task</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">    ConnectionContext *context = (ConnectionContext*)arg;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (context == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Connection context is NULL&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> client_socket = context-&gt;client_socket;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client_addr</span> =</span> context-&gt;client_addr;</span><br><span class="line">    ThreadPool *thread_pool = context-&gt;thread_pool;</span><br><span class="line">    </span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *client_ip = get_client_ip(&amp;client_addr);</span><br><span class="line">    <span class="type">int</span> client_port = get_client_port(&amp;client_addr);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算连接等待时间</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">process_time</span>;</span></span><br><span class="line">    gettimeofday(&amp;process_time, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="type">long</span> wait_time = timeval_diff_ms(&amp;context-&gt;accept_time, &amp;process_time);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (wait_time &gt; <span class="number">100</span>) &#123;</span><br><span class="line">        LOG_WARNING(<span class="string">&quot;Connection from %s:%d waited %ld ms in queue&quot;</span>, </span><br><span class="line">                   client_ip, client_port, wait_time);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 读取HTTP请求</span></span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">8192</span>];</span><br><span class="line">    <span class="type">int</span> bytes_received = read_complete_request(client_socket, buffer, <span class="keyword">sizeof</span>(buffer), &amp;client_addr);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (bytes_received &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 处理HTTP请求并生成响应</span></span><br><span class="line">        HttpResponse *resp = process_http_request(buffer, bytes_received, client_ip, client_port);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (resp != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// 发送响应</span></span><br><span class="line">            <span class="keyword">if</span> (send_response(client_socket, resp) == <span class="number">0</span>) &#123;</span><br><span class="line">                LOG_INFO(<span class="string">&quot;Response sent to %s:%d - Status: %d&quot;</span>, </span><br><span class="line">                         client_ip, client_port, resp-&gt;status_code);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                LOG_ERROR(<span class="string">&quot;Failed to send response to %s:%d&quot;</span>, client_ip, client_port);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            free_http_response(resp);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LOG_ERROR(<span class="string">&quot;Failed to create response for %s:%d&quot;</span>, client_ip, client_port);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 发送500错误</span></span><br><span class="line">            HttpResponse *error_resp = create_http_response(HTTP_1_1, HTTP_500_INTERNAL_SERVER_ERROR);</span><br><span class="line">            <span class="keyword">if</span> (error_resp != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                set_response_html(error_resp, </span><br><span class="line">                    <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;500 Internal Server Error&lt;/h1&gt;&lt;p&gt;Failed to process request.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line">                send_response(client_socket, error_resp);</span><br><span class="line">                free_http_response(error_resp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bytes_received == <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_INFO(<span class="string">&quot;Client %s:%d closed connection&quot;</span>, client_ip, client_port);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to read request from %s:%d&quot;</span>, client_ip, client_port);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 关闭客户端连接</span></span><br><span class="line">    close(client_socket);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算总处理时间</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">end_time</span>;</span></span><br><span class="line">    gettimeofday(&amp;end_time, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="type">long</span> total_time = timeval_diff_ms(&amp;context-&gt;accept_time, &amp;end_time);</span><br><span class="line">    </span><br><span class="line">    LOG_DEBUG(<span class="string">&quot;Connection from %s:%d processed in %ld ms (waited %ld ms)&quot;</span>, </span><br><span class="line">             client_ip, client_port, total_time, wait_time);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放连接上下文</span></span><br><span class="line">    free_connection_context(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-3-更新主程序以使用线程池"><a href="#3-3-更新主程序以使用线程池" class="headerlink" title="3.3 更新主程序以使用线程池"></a>3.3 更新主程序以使用线程池</h2><h3 id="3-3-1-更新main-c（线程池版本）"><a href="#3-3-1-更新main-c（线程池版本）" class="headerlink" title="3.3.1 更新main.c（线程池版本）"></a>3.3.1 更新main.c（线程池版本）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.c（线程池版本）</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/logger.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/thread_pool.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/connection.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFAULT_PORT 8080</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFAULT_MIN_THREADS 4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFAULT_MAX_THREADS 32</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFAULT_QUEUE_SIZE 256</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BACKLOG 1024  <span class="comment">// 增加积压连接数</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">volatile</span> <span class="type">int</span> running = <span class="number">1</span>;</span><br><span class="line"><span class="type">static</span> ThreadPool *thread_pool = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务器配置结构体</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> port;</span><br><span class="line">    <span class="type">int</span> min_threads;</span><br><span class="line">    <span class="type">int</span> max_threads;</span><br><span class="line">    <span class="type">int</span> queue_size;</span><br><span class="line">    <span class="type">int</span> enable_stats;</span><br><span class="line">    <span class="type">int</span> max_connections;</span><br><span class="line">&#125; ServerConfig;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认配置</span></span><br><span class="line"><span class="type">static</span> ServerConfig server_config = &#123;</span><br><span class="line">    .port = DEFAULT_PORT,</span><br><span class="line">    .min_threads = DEFAULT_MIN_THREADS,</span><br><span class="line">    .max_threads = DEFAULT_MAX_THREADS,</span><br><span class="line">    .queue_size = DEFAULT_QUEUE_SIZE,</span><br><span class="line">    .enable_stats = <span class="number">1</span>,</span><br><span class="line">    .max_connections = <span class="number">10000</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 统计信息</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">long</span> total_connections;</span><br><span class="line">    <span class="type">long</span> active_connections;</span><br><span class="line">    <span class="type">long</span> completed_connections;</span><br><span class="line">    <span class="type">long</span> rejected_connections;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">start_time</span>;</span></span><br><span class="line">&#125; ServerStats;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> ServerStats server_stats = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 信号处理函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">signal_handler</span><span class="params">(<span class="type">int</span> sig)</span> &#123;</span><br><span class="line">    LOG_INFO(<span class="string">&quot;Received signal %d, shutting down gracefully...&quot;</span>, sig);</span><br><span class="line">    running = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印使用说明</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_usage</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *program_name)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Usage: %s [OPTIONS]\n&quot;</span>, program_name);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nOptions:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  -p PORT        Port to listen on (default: %d)\n&quot;</span>, DEFAULT_PORT);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  -t MIN:MAX     Thread pool min and max threads (default: %d:%d)\n&quot;</span>, </span><br><span class="line">           DEFAULT_MIN_THREADS, DEFAULT_MAX_THREADS);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  -q SIZE        Task queue size (default: %d)\n&quot;</span>, DEFAULT_QUEUE_SIZE);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  -c MAX         Maximum connections (default: %d)\n&quot;</span>, server_config.max_connections);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  -s             Disable statistics endpoint\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  -h             Show this help message\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nExamples:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  %s -p 8080 -t 8:64 -q 512\n&quot;</span>, program_name);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  %s -p 80 -t 16:128 -c 10000\n&quot;</span>, program_name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析命令行参数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">parse_arguments</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; argc; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-p&quot;</span>) == <span class="number">0</span> &amp;&amp; i + <span class="number">1</span> &lt; argc) &#123;</span><br><span class="line">            server_config.port = atoi(argv[++i]);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-t&quot;</span>) == <span class="number">0</span> &amp;&amp; i + <span class="number">1</span> &lt; argc) &#123;</span><br><span class="line">            <span class="type">char</span> *token = strtok(argv[++i], <span class="string">&quot;:&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (token != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                server_config.min_threads = atoi(token);</span><br><span class="line">                token = strtok(<span class="literal">NULL</span>, <span class="string">&quot;:&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (token != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    server_config.max_threads = atoi(token);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-q&quot;</span>) == <span class="number">0</span> &amp;&amp; i + <span class="number">1</span> &lt; argc) &#123;</span><br><span class="line">            server_config.queue_size = atoi(argv[++i]);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-c&quot;</span>) == <span class="number">0</span> &amp;&amp; i + <span class="number">1</span> &lt; argc) &#123;</span><br><span class="line">            server_config.max_connections = atoi(argv[++i]);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-s&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            server_config.enable_stats = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-h&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            print_usage(argv[<span class="number">0</span>]);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Unknown option: %s\n&quot;</span>, argv[i]);</span><br><span class="line">            print_usage(argv[<span class="number">0</span>]);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 验证参数</span></span><br><span class="line">    <span class="keyword">if</span> (server_config.port &lt;= <span class="number">0</span> || server_config.port &gt; <span class="number">65535</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Invalid port number: %d\n&quot;</span>, server_config.port);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (server_config.min_threads &lt;= <span class="number">0</span> || server_config.max_threads &lt;= <span class="number">0</span> ||</span><br><span class="line">        server_config.min_threads &gt; server_config.max_threads) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Invalid thread pool configuration\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (server_config.queue_size &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Invalid queue size: %d\n&quot;</span>, server_config.queue_size);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (server_config.max_connections &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Invalid max connections: %d\n&quot;</span>, server_config.max_connections);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化服务器统计</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">init_server_stats</span><span class="params">()</span> &#123;</span><br><span class="line">    server_stats.total_connections = <span class="number">0</span>;</span><br><span class="line">    server_stats.active_connections = <span class="number">0</span>;</span><br><span class="line">    server_stats.completed_connections = <span class="number">0</span>;</span><br><span class="line">    server_stats.rejected_connections = <span class="number">0</span>;</span><br><span class="line">    gettimeofday(&amp;server_stats.start_time, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印服务器状态</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_server_status</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> active_threads, idle_threads, queue_size;</span><br><span class="line">    <span class="type">long</span> total_tasks, completed_tasks;</span><br><span class="line">    <span class="type">double</span> uptime;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取线程池状态</span></span><br><span class="line">    thread_pool_get_stats(thread_pool, </span><br><span class="line">                         &amp;active_threads, </span><br><span class="line">                         &amp;idle_threads,</span><br><span class="line">                         &amp;queue_size,</span><br><span class="line">                         &amp;total_tasks,</span><br><span class="line">                         &amp;completed_tasks,</span><br><span class="line">                         &amp;uptime);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n=== Server Status ===\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Uptime: %.2f seconds\n&quot;</span>, uptime);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Thread Pool: %d active, %d idle, %d in queue\n&quot;</span>, </span><br><span class="line">           active_threads, idle_threads, queue_size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Connections: %ld total, %ld active, %ld completed, %ld rejected\n&quot;</span>,</span><br><span class="line">           server_stats.total_connections,</span><br><span class="line">           server_stats.active_connections,</span><br><span class="line">           server_stats.completed_connections,</span><br><span class="line">           server_stats.rejected_connections);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Tasks: %ld total, %ld completed\n&quot;</span>, total_tasks, completed_tasks);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;====================\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理统计端点请求</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handle_stats_request</span><span class="params">(<span class="type">int</span> client_socket, <span class="keyword">struct</span> sockaddr_in *client_addr)</span> &#123;</span><br><span class="line">    <span class="type">char</span> client_ip[INET_ADDRSTRLEN];</span><br><span class="line">    inet_ntop(AF_INET, &amp;(client_addr-&gt;sin_addr), client_ip, INET_ADDRSTRLEN);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取线程池状态</span></span><br><span class="line">    <span class="type">int</span> active_threads, idle_threads, queue_size;</span><br><span class="line">    <span class="type">long</span> total_tasks, completed_tasks;</span><br><span class="line">    <span class="type">double</span> uptime;</span><br><span class="line">    </span><br><span class="line">    thread_pool_get_stats(thread_pool, </span><br><span class="line">                         &amp;active_threads, </span><br><span class="line">                         &amp;idle_threads,</span><br><span class="line">                         &amp;queue_size,</span><br><span class="line">                         &amp;total_tasks,</span><br><span class="line">                         &amp;completed_tasks,</span><br><span class="line">                         &amp;uptime);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建JSON响应</span></span><br><span class="line">    <span class="type">char</span> json_response[<span class="number">2048</span>];</span><br><span class="line">    <span class="built_in">snprintf</span>(json_response, <span class="keyword">sizeof</span>(json_response),</span><br><span class="line">        <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">        <span class="string">&quot;  \&quot;server\&quot;: \&quot;Threaded-HTTP-Server\&quot;,\n&quot;</span></span><br><span class="line">        <span class="string">&quot;  \&quot;version\&quot;: \&quot;2.0\&quot;,\n&quot;</span></span><br><span class="line">        <span class="string">&quot;  \&quot;status\&quot;: \&quot;running\&quot;,\n&quot;</span></span><br><span class="line">        <span class="string">&quot;  \&quot;timestamp\&quot;: %ld,\n&quot;</span></span><br><span class="line">        <span class="string">&quot;  \&quot;uptime\&quot;: %.2f,\n&quot;</span></span><br><span class="line">        <span class="string">&quot;  \&quot;connections\&quot;: &#123;\n&quot;</span></span><br><span class="line">        <span class="string">&quot;    \&quot;total\&quot;: %ld,\n&quot;</span></span><br><span class="line">        <span class="string">&quot;    \&quot;active\&quot;: %ld,\n&quot;</span></span><br><span class="line">        <span class="string">&quot;    \&quot;completed\&quot;: %ld,\n&quot;</span></span><br><span class="line">        <span class="string">&quot;    \&quot;rejected\&quot;: %ld\n&quot;</span></span><br><span class="line">        <span class="string">&quot;  &#125;,\n&quot;</span></span><br><span class="line">        <span class="string">&quot;  \&quot;thread_pool\&quot;: &#123;\n&quot;</span></span><br><span class="line">        <span class="string">&quot;    \&quot;active_threads\&quot;: %d,\n&quot;</span></span><br><span class="line">        <span class="string">&quot;    \&quot;idle_threads\&quot;: %d,\n&quot;</span></span><br><span class="line">        <span class="string">&quot;    \&quot;queue_size\&quot;: %d,\n&quot;</span></span><br><span class="line">        <span class="string">&quot;    \&quot;total_tasks\&quot;: %ld,\n&quot;</span></span><br><span class="line">        <span class="string">&quot;    \&quot;completed_tasks\&quot;: %ld\n&quot;</span></span><br><span class="line">        <span class="string">&quot;  &#125;,\n&quot;</span></span><br><span class="line">        <span class="string">&quot;  \&quot;client\&quot;: \&quot;%s:%d\&quot;\n&quot;</span></span><br><span class="line">        <span class="string">&quot;&#125;&quot;</span>,</span><br><span class="line">        time(<span class="literal">NULL</span>),</span><br><span class="line">        uptime,</span><br><span class="line">        server_stats.total_connections,</span><br><span class="line">        server_stats.active_connections,</span><br><span class="line">        server_stats.completed_connections,</span><br><span class="line">        server_stats.rejected_connections,</span><br><span class="line">        active_threads,</span><br><span class="line">        idle_threads,</span><br><span class="line">        queue_size,</span><br><span class="line">        total_tasks,</span><br><span class="line">        completed_tasks,</span><br><span class="line">        client_ip,</span><br><span class="line">        ntohs(client_addr-&gt;sin_port));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发送HTTP响应</span></span><br><span class="line">    <span class="type">char</span> http_response[<span class="number">4096</span>];</span><br><span class="line">    <span class="type">int</span> response_length = <span class="built_in">snprintf</span>(http_response, <span class="keyword">sizeof</span>(http_response),</span><br><span class="line">        <span class="string">&quot;HTTP/1.1 200 OK\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Content-Type: application/json\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Content-Length: %lu\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Connection: close\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Server: Threaded-C-HTTP-Server/2.0\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;%s&quot;</span>,</span><br><span class="line">        <span class="built_in">strlen</span>(json_response),</span><br><span class="line">        json_response);</span><br><span class="line">    </span><br><span class="line">    send(client_socket, http_response, response_length, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主服务器循环</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">run_server_loop</span><span class="params">(<span class="type">int</span> server_fd)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client_addr</span>;</span></span><br><span class="line">    <span class="type">socklen_t</span> client_len = <span class="keyword">sizeof</span>(client_addr);</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Server is listening on port %d...&quot;</span>, server_config.port);</span><br><span class="line">    LOG_INFO(<span class="string">&quot;Thread pool: %d-%d threads, queue size: %d&quot;</span>, </span><br><span class="line">             server_config.min_threads, </span><br><span class="line">             server_config.max_threads, </span><br><span class="line">             server_config.queue_size);</span><br><span class="line">    LOG_INFO(<span class="string">&quot;Max connections: %d&quot;</span>, server_config.max_connections);</span><br><span class="line">    LOG_INFO(<span class="string">&quot;Press Ctrl+C to stop the server&quot;</span>);</span><br><span class="line">    LOG_INFO(<span class="string">&quot;==========================================&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置socket为非阻塞，用于accept</span></span><br><span class="line">    set_socket_nonblocking(server_fd);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (running) &#123;</span><br><span class="line">        <span class="comment">// 接受客户端连接</span></span><br><span class="line">        <span class="type">int</span> client_socket = accept(server_fd, (<span class="keyword">struct</span> sockaddr *)&amp;client_addr, &amp;client_len);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (client_socket &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (errno == EAGAIN || errno == EWOULDBLOCK) &#123;</span><br><span class="line">                <span class="comment">// 没有新连接，继续循环</span></span><br><span class="line">                usleep(<span class="number">10000</span>);  <span class="comment">// 10ms</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (running) &#123;</span><br><span class="line">                LOG_ERROR(<span class="string">&quot;Failed to accept connection: %s&quot;</span>, strerror(errno));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新连接统计</span></span><br><span class="line">        server_stats.total_connections++;</span><br><span class="line">        server_stats.active_connections++;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查是否超过最大连接数</span></span><br><span class="line">        <span class="keyword">if</span> (server_stats.active_connections &gt; server_config.max_connections) &#123;</span><br><span class="line">            LOG_WARNING(<span class="string">&quot;Max connections exceeded (%ld &gt; %d), rejecting connection&quot;</span>,</span><br><span class="line">                       server_stats.active_connections, server_config.max_connections);</span><br><span class="line">            </span><br><span class="line">            server_stats.rejected_connections++;</span><br><span class="line">            server_stats.active_connections--;</span><br><span class="line">            </span><br><span class="line">            close(client_socket);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查是否为统计端点请求</span></span><br><span class="line">        <span class="type">char</span> client_ip[INET_ADDRSTRLEN];</span><br><span class="line">        inet_ntop(AF_INET, &amp;(client_addr.sin_addr), client_ip, INET_ADDRSTRLEN);</span><br><span class="line">        <span class="type">int</span> client_port = ntohs(client_addr.sin_port);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (server_config.enable_stats &amp;&amp; <span class="built_in">strcmp</span>(client_ip, <span class="string">&quot;127.0.0.1&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 检查请求类型（简化检查）</span></span><br><span class="line">            <span class="type">char</span> buffer[<span class="number">128</span>];</span><br><span class="line">            recv(client_socket, buffer, <span class="keyword">sizeof</span>(buffer) - <span class="number">1</span>, MSG_PEEK);</span><br><span class="line">            buffer[<span class="keyword">sizeof</span>(buffer) - <span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strstr</span>(buffer, <span class="string">&quot;GET /stats&quot;</span>) != <span class="literal">NULL</span> || </span><br><span class="line">                <span class="built_in">strstr</span>(buffer, <span class="string">&quot;GET /status&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                LOG_INFO(<span class="string">&quot;Serving stats request from %s:%d&quot;</span>, client_ip, client_port);</span><br><span class="line">                handle_stats_request(client_socket, &amp;client_addr);</span><br><span class="line">                close(client_socket);</span><br><span class="line">                </span><br><span class="line">                server_stats.completed_connections++;</span><br><span class="line">                server_stats.active_connections--;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        LOG_INFO(<span class="string">&quot;Accepted connection from %s:%d (active: %ld)&quot;</span>, </span><br><span class="line">                 client_ip, client_port, server_stats.active_connections);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置socket选项</span></span><br><span class="line">        set_socket_receive_timeout(client_socket, <span class="number">10</span>);  <span class="comment">// 10秒接收超时</span></span><br><span class="line">        set_socket_send_timeout(client_socket, <span class="number">10</span>);     <span class="comment">// 10秒发送超时</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建连接上下文</span></span><br><span class="line">        ConnectionContext *context = create_connection_context(client_socket, </span><br><span class="line">                                                              &amp;client_addr, </span><br><span class="line">                                                              thread_pool);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (context == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            LOG_ERROR(<span class="string">&quot;Failed to create connection context for %s:%d&quot;</span>, </span><br><span class="line">                     client_ip, client_port);</span><br><span class="line">            close(client_socket);</span><br><span class="line">            </span><br><span class="line">            server_stats.completed_connections++;</span><br><span class="line">            server_stats.active_connections--;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 添加任务到线程池</span></span><br><span class="line">        <span class="keyword">if</span> (thread_pool_add_task(thread_pool, handle_connection_task, context) != <span class="number">0</span>) &#123;</span><br><span class="line">            LOG_ERROR(<span class="string">&quot;Failed to add task to thread pool for %s:%d&quot;</span>, </span><br><span class="line">                     client_ip, client_port);</span><br><span class="line">            free_connection_context(context);</span><br><span class="line">            close(client_socket);</span><br><span class="line">            </span><br><span class="line">            server_stats.completed_connections++;</span><br><span class="line">            server_stats.active_connections--;</span><br><span class="line">            </span><br><span class="line">            server_stats.rejected_connections++;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 定期打印状态</span></span><br><span class="line">        <span class="keyword">if</span> (server_stats.total_connections % <span class="number">100</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            print_server_status();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">int</span> server_fd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server_addr</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 解析命令行参数</span></span><br><span class="line">    parse_arguments(argc, argv);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化日志系统</span></span><br><span class="line">    logger_init(<span class="string">&quot;logs/server.log&quot;</span>, LOG_LEVEL_INFO);</span><br><span class="line">    LOG_INFO(<span class="string">&quot;Starting Threaded HTTP Server v2.0&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化统计信息</span></span><br><span class="line">    init_server_stats();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置信号处理</span></span><br><span class="line">    signal(SIGINT, signal_handler);</span><br><span class="line">    signal(SIGTERM, signal_handler);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建线程池</span></span><br><span class="line">    thread_pool = thread_pool_create(server_config.min_threads, </span><br><span class="line">                                     server_config.max_threads, </span><br><span class="line">                                     server_config.queue_size);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (thread_pool == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to create thread pool&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建socket</span></span><br><span class="line">    server_fd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (server_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to create socket: %s&quot;</span>, strerror(errno));</span><br><span class="line">        thread_pool_destroy(thread_pool, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置socket选项</span></span><br><span class="line">    <span class="type">int</span> opt = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (setsockopt(server_fd, SOL_SOCKET, SO_REUSEADDR, &amp;opt, <span class="keyword">sizeof</span>(opt)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to set socket options: %s&quot;</span>, strerror(errno));</span><br><span class="line">        close(server_fd);</span><br><span class="line">        thread_pool_destroy(thread_pool, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置TCP_NODELAY禁用Nagle算法</span></span><br><span class="line">    <span class="keyword">if</span> (setsockopt(server_fd, IPPROTO_TCP, TCP_NODELAY, &amp;opt, <span class="keyword">sizeof</span>(opt)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_WARNING(<span class="string">&quot;Failed to set TCP_NODELAY: %s&quot;</span>, strerror(errno));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 配置服务器地址</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;server_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(server_addr));</span><br><span class="line">    server_addr.sin_family = AF_INET;</span><br><span class="line">    server_addr.sin_addr.s_addr = INADDR_ANY;</span><br><span class="line">    server_addr.sin_port = htons(server_config.port);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 绑定socket</span></span><br><span class="line">    <span class="keyword">if</span> (bind(server_fd, (<span class="keyword">struct</span> sockaddr *)&amp;server_addr, <span class="keyword">sizeof</span>(server_addr)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to bind socket to port %d: %s&quot;</span>, server_config.port, strerror(errno));</span><br><span class="line">        close(server_fd);</span><br><span class="line">        thread_pool_destroy(thread_pool, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 监听连接</span></span><br><span class="line">    <span class="keyword">if</span> (listen(server_fd, BACKLOG) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to listen on socket: %s&quot;</span>, strerror(errno));</span><br><span class="line">        close(server_fd);</span><br><span class="line">        thread_pool_destroy(thread_pool, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 运行主服务器循环</span></span><br><span class="line">    run_server_loop(server_fd);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清理资源</span></span><br><span class="line">    LOG_INFO(<span class="string">&quot;Shutting down server...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 关闭监听socket</span></span><br><span class="line">    close(server_fd);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 等待所有任务完成</span></span><br><span class="line">    LOG_INFO(<span class="string">&quot;Waiting for all tasks to complete...&quot;</span>);</span><br><span class="line">    thread_pool_wait(thread_pool);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 销毁线程池</span></span><br><span class="line">    thread_pool_destroy(thread_pool, <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 打印最终统计信息</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">end_time</span>;</span></span><br><span class="line">    gettimeofday(&amp;end_time, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="type">double</span> uptime = timeval_diff_ms(&amp;server_stats.start_time, &amp;end_time) / <span class="number">1000.0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n=== Final Server Statistics ===\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Total uptime: %.2f seconds\n&quot;</span>, uptime);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Total connections: %ld\n&quot;</span>, server_stats.total_connections);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Completed connections: %ld\n&quot;</span>, server_stats.completed_connections);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Rejected connections: %ld\n&quot;</span>, server_stats.rejected_connections);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Average connections/second: %.2f\n&quot;</span>, </span><br><span class="line">           server_stats.completed_connections / uptime);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;================================\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    logger_cleanup();</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Server shutdown complete&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-4-更新Makefile"><a href="#3-4-更新Makefile" class="headerlink" title="3.4 更新Makefile"></a>3.4 更新Makefile</h2><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Makefile（线程池版本）</span></span><br><span class="line">CC = gcc</span><br><span class="line">CFLAGS = -Wall -Wextra -g -O0 -I./<span class="keyword">include</span> -D_GNU_SOURCE</span><br><span class="line">LDFLAGS = -pthread</span><br><span class="line">TARGET = http_server</span><br><span class="line">SRC_DIR = src</span><br><span class="line">INCLUDE_DIR = <span class="keyword">include</span></span><br><span class="line">BUILD_DIR = build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 源文件列表</span></span><br><span class="line">SRCS = <span class="variable">$(SRC_DIR)</span>/logger.c \</span><br><span class="line">       <span class="variable">$(SRC_DIR)</span>/request.c \</span><br><span class="line">       <span class="variable">$(SRC_DIR)</span>/response.c \</span><br><span class="line">       <span class="variable">$(SRC_DIR)</span>/thread_pool.c \</span><br><span class="line">       <span class="variable">$(SRC_DIR)</span>/connection.c \</span><br><span class="line">       <span class="variable">$(SRC_DIR)</span>/main.c</span><br><span class="line"></span><br><span class="line">OBJS = $(SRCS:<span class="variable">$(SRC_DIR)</span>/%.c=<span class="variable">$(BUILD_DIR)</span>/%.o)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认目标</span></span><br><span class="line"><span class="section">all: <span class="variable">$(BUILD_DIR)</span> <span class="variable">$(TARGET)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建构建目录</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>:</span><br><span class="line">	mkdir -p <span class="variable">$(BUILD_DIR)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 链接可执行文件</span></span><br><span class="line"><span class="variable">$(TARGET)</span>: <span class="variable">$(OBJS)</span></span><br><span class="line">	<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> <span class="variable">$^</span> -o <span class="variable">$@</span> <span class="variable">$(LDFLAGS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译源文件</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/%.o: <span class="variable">$(SRC_DIR)</span>/%.c</span><br><span class="line">	<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> -c <span class="variable">$&lt;</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -rf <span class="variable">$(BUILD_DIR)</span> <span class="variable">$(TARGET)</span> logs/* core vgcore.* gmon.out</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行服务器（默认配置）</span></span><br><span class="line"><span class="section">run: <span class="variable">$(TARGET)</span></span></span><br><span class="line">	./<span class="variable">$(TARGET)</span> -p 8080 -t 4:16 -q 256</span><br><span class="line"></span><br><span class="line"><span class="comment"># 高性能配置</span></span><br><span class="line"><span class="section">run-high: <span class="variable">$(TARGET)</span></span></span><br><span class="line">	./<span class="variable">$(TARGET)</span> -p 8080 -t 8:64 -q 1024 -c 10000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调试运行</span></span><br><span class="line"><span class="section">debug: <span class="variable">$(TARGET)</span></span></span><br><span class="line">	gdb -ex run --args ./<span class="variable">$(TARGET)</span> -p 8080 -t 2:4 -q 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查内存泄漏</span></span><br><span class="line"><span class="section">valgrind: <span class="variable">$(TARGET)</span></span></span><br><span class="line">	valgrind --leak-check=full \</span><br><span class="line">	         --show-leak-kinds=all \</span><br><span class="line">	         --track-origins=yes \</span><br><span class="line">	         --log-file=logs/valgrind.log \</span><br><span class="line">	         ./<span class="variable">$(TARGET)</span> -p 8081 -t 2:2 -q 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建必要的目录</span></span><br><span class="line"><span class="section">init:</span></span><br><span class="line">	mkdir -p logs static <span class="variable">$(BUILD_DIR)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行测试套件</span></span><br><span class="line"><span class="section">test: <span class="variable">$(TARGET)</span></span></span><br><span class="line">	@echo <span class="string">&quot;=== Running thread pool tests ===&quot;</span></span><br><span class="line">	@./scripts/test_thread_pool.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 压力测试</span></span><br><span class="line"><span class="section">benchmark: <span class="variable">$(TARGET)</span></span></span><br><span class="line">	@echo <span class="string">&quot;=== Starting benchmark ===&quot;</span></span><br><span class="line">	@./scripts/benchmark.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 性能分析</span></span><br><span class="line"><span class="section">profile: <span class="variable">$(TARGET)</span></span></span><br><span class="line">	./<span class="variable">$(TARGET)</span> -p 8082 -t 4:8 -q 100 &amp;</span><br><span class="line">	SERVER_PID=$$!; \</span><br><span class="line">	sleep 2; \</span><br><span class="line">	ab -n 10000 -c 100 http://localhost:8082/; \</span><br><span class="line">	kill $$SERVER_PID; \</span><br><span class="line">	wait $$SERVER_PID 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: all clean run debug valgrind init test benchmark profile</span></span><br></pre></td></tr></table></figure>



<h2 id="3-5-创建测试和性能分析脚本"><a href="#3-5-创建测试和性能分析脚本" class="headerlink" title="3.5 创建测试和性能分析脚本"></a>3.5 创建测试和性能分析脚本</h2><h3 id="3-5-1-线程池测试脚本"><a href="#3-5-1-线程池测试脚本" class="headerlink" title="3.5.1 线程池测试脚本"></a>3.5.1 线程池测试脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># scripts/test_thread_pool.sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 编译服务器 ===&quot;</span></span><br><span class="line">make clean</span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 检查编译结果 ===&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">&quot;http_server&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;编译失败!&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 启动测试服务器（后台运行）===&quot;</span></span><br><span class="line">./http_server -p 8082 -t 2:8 -q 10 &amp;</span><br><span class="line">SERVER_PID=$!</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;服务器进程ID: <span class="variable">$SERVER_PID</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 等待服务器启动</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n等待服务器启动...&quot;</span></span><br><span class="line"><span class="built_in">sleep</span> 3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查服务器是否运行</span></span><br><span class="line"><span class="keyword">if</span> ! <span class="built_in">kill</span> -0 <span class="variable">$SERVER_PID</span> 2&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;服务器启动失败!&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 测试1: 基本功能测试 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">test_endpoint</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> method=<span class="variable">$1</span></span><br><span class="line">    <span class="built_in">local</span> endpoint=<span class="variable">$2</span></span><br><span class="line">    <span class="built_in">local</span> data=<span class="variable">$3</span></span><br><span class="line">    <span class="built_in">local</span> test_name=<span class="variable">$4</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\n--- 测试: <span class="variable">$test_name</span> ---&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;请求: <span class="variable">$method</span> <span class="variable">$endpoint</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$data</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        response=$(curl -s -w <span class="string">&quot;\nHTTP状态码: %&#123;http_code&#125;\n&quot;</span> -X <span class="variable">$method</span> -H <span class="string">&quot;Content-Type: application/json&quot;</span> -d <span class="string">&quot;<span class="variable">$data</span>&quot;</span> <span class="string">&quot;http://localhost:8082<span class="variable">$endpoint</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        response=$(curl -s -w <span class="string">&quot;\nHTTP状态码: %&#123;http_code&#125;\n&quot;</span> -X <span class="variable">$method</span> <span class="string">&quot;http://localhost:8082<span class="variable">$endpoint</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;响应:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$response</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test_endpoint <span class="string">&quot;GET&quot;</span> <span class="string">&quot;/&quot;</span> <span class="string">&quot;&quot;</span> <span class="string">&quot;首页&quot;</span></span><br><span class="line">test_endpoint <span class="string">&quot;GET&quot;</span> <span class="string">&quot;/api/status&quot;</span> <span class="string">&quot;&quot;</span> <span class="string">&quot;状态API&quot;</span></span><br><span class="line">test_endpoint <span class="string">&quot;POST&quot;</span> <span class="string">&quot;/api/echo&quot;</span> <span class="string">&#x27;&#123;&quot;test&quot;: &quot;thread pool&quot;&#125;&#x27;</span> <span class="string">&quot;Echo API&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 测试2: 并发连接测试 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建测试脚本文件</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /tmp/test_concurrent.sh &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..5&#125;; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;客户端 <span class="variable">$i</span> 发送请求...&quot;</span></span><br><span class="line">    curl -s <span class="string">&quot;http://localhost:8082/slow&quot;</span> &gt; /tmp/response_<span class="variable">$i</span>.txt &amp;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">wait</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;所有客户端完成&quot;</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> +x /tmp/test_concurrent.sh</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;启动5个并发客户端请求/slow端点...&quot;</span></span><br><span class="line">time /tmp/test_concurrent.sh</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 测试3: 线程池统计信息 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;查看服务器统计信息:&quot;</span></span><br><span class="line">curl -s <span class="string">&quot;http://localhost:8082/stats&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 测试4: 连接拒绝测试 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;尝试建立大量连接...&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..20&#125;; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">timeout</span> 1 curl -s <span class="string">&quot;http://localhost:8082/&quot;</span> &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;20个并发连接已发起&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sleep</span> 2</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 查看服务器日志 ===&quot;</span></span><br><span class="line"><span class="built_in">tail</span> -n 20 logs/server.log</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 停止测试服务器 ===&quot;</span></span><br><span class="line"><span class="built_in">kill</span> <span class="variable">$SERVER_PID</span></span><br><span class="line"><span class="built_in">wait</span> <span class="variable">$SERVER_PID</span> 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 清理临时文件 ===&quot;</span></span><br><span class="line"><span class="built_in">rm</span> -f /tmp/test_concurrent.sh /tmp/response_*.txt</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 测试完成 ===&quot;</span></span><br></pre></td></tr></table></figure>



<h3 id="3-5-2-性能基准测试脚本"><a href="#3-5-2-性能基准测试脚本" class="headerlink" title="3.5.2 性能基准测试脚本"></a>3.5.2 性能基准测试脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># scripts/benchmark.sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== HTTP服务器性能基准测试 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译</span></span><br><span class="line">make clean</span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">&quot;http_server&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;编译失败!&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试配置</span></span><br><span class="line"><span class="built_in">declare</span> -A configs=(</span><br><span class="line">    [<span class="string">&quot;单线程&quot;</span>]=<span class="string">&quot;-p 8083 -t 1:1 -q 10&quot;</span></span><br><span class="line">    [<span class="string">&quot;小线程池&quot;</span>]=<span class="string">&quot;-p 8084 -t 2:4 -q 100&quot;</span></span><br><span class="line">    [<span class="string">&quot;中线程池&quot;</span>]=<span class="string">&quot;-p 8085 -t 4:16 -q 256&quot;</span></span><br><span class="line">    [<span class="string">&quot;大线程池&quot;</span>]=<span class="string">&quot;-p 8086 -t 8:32 -q 512&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试函数</span></span><br><span class="line"><span class="function"><span class="title">run_benchmark</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> config_name=<span class="variable">$1</span></span><br><span class="line">    <span class="built_in">local</span> config_args=<span class="variable">$2</span></span><br><span class="line">    <span class="built_in">local</span> requests=1000</span><br><span class="line">    <span class="built_in">local</span> concurrency=50</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== 测试配置: <span class="variable">$config_name</span> ===&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;参数: <span class="variable">$config_args</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 启动服务器</span></span><br><span class="line">    ./http_server <span class="variable">$config_args</span> &amp;</span><br><span class="line">    SERVER_PID=$!</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 等待服务器启动</span></span><br><span class="line">    <span class="built_in">sleep</span> 3</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 运行基准测试</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;运行基准测试: <span class="variable">$requests</span> 请求, <span class="variable">$concurrency</span> 并发&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 预热</span></span><br><span class="line">    curl -s <span class="string">&quot;http://localhost:<span class="variable">$&#123;config_args:3:4&#125;</span>/&quot;</span> &gt; /dev/null</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 运行ab测试</span></span><br><span class="line">    ab -n <span class="variable">$requests</span> -c <span class="variable">$concurrency</span> \</span><br><span class="line">       -e logs/ab_results_<span class="variable">$&#123;config_name&#125;</span>.csv \</span><br><span class="line">       <span class="string">&quot;http://localhost:<span class="variable">$&#123;config_args:3:4&#125;</span>/&quot;</span> &gt; logs/ab_output_<span class="variable">$&#123;config_name&#125;</span>.txt 2&gt;&amp;1</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 提取关键指标</span></span><br><span class="line">    rps=$(grep <span class="string">&quot;Requests per second&quot;</span> logs/ab_output_<span class="variable">$&#123;config_name&#125;</span>.txt | awk <span class="string">&#x27;&#123;print $4&#125;&#x27;</span>)</span><br><span class="line">    avg_time=$(grep <span class="string">&quot;Time per request&quot;</span> logs/ab_output_<span class="variable">$&#123;config_name&#125;</span>.txt | grep -v <span class="string">&quot;concurrent&quot;</span> | awk <span class="string">&#x27;&#123;print $4&#125;&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;性能结果:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  每秒请求数: <span class="variable">$rps</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  平均响应时间: <span class="variable">$avg_time</span> ms&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 停止服务器</span></span><br><span class="line">    <span class="built_in">kill</span> <span class="variable">$SERVER_PID</span></span><br><span class="line">    <span class="built_in">wait</span> <span class="variable">$SERVER_PID</span> 2&gt;/dev/null</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">sleep</span> 2</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建日志目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p logs</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;开始基准测试...&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行所有配置测试</span></span><br><span class="line"><span class="keyword">for</span> config_name <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;!configs[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    run_benchmark <span class="string">&quot;<span class="variable">$config_name</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;configs[$config_name]&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成对比报告</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 性能对比报告 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">printf</span> <span class="string">&quot;%-15s %-15s %-15s\n&quot;</span> <span class="string">&quot;配置&quot;</span> <span class="string">&quot;请求/秒&quot;</span> <span class="string">&quot;平均响应(ms)&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;------------------------------------------------&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> config_name <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;!configs[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [ -f <span class="string">&quot;logs/ab_output_<span class="variable">$&#123;config_name&#125;</span>.txt&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        rps=$(grep <span class="string">&quot;Requests per second&quot;</span> logs/ab_output_<span class="variable">$&#123;config_name&#125;</span>.txt | awk <span class="string">&#x27;&#123;print $4&#125;&#x27;</span>)</span><br><span class="line">        avg_time=$(grep <span class="string">&quot;Time per request&quot;</span> logs/ab_output_<span class="variable">$&#123;config_name&#125;</span>.txt | grep -v <span class="string">&quot;concurrent&quot;</span> | awk <span class="string">&#x27;&#123;print $4&#125;&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&quot;%-15s %-15s %-15s\n&quot;</span> <span class="string">&quot;<span class="variable">$config_name</span>&quot;</span> <span class="string">&quot;<span class="variable">$rps</span>&quot;</span> <span class="string">&quot;<span class="variable">$avg_time</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 详细报告 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;查看详细结果:&quot;</span></span><br><span class="line"><span class="keyword">for</span> config_name <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;!configs[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  <span class="variable">$config_name</span>: logs/ab_output_<span class="variable">$&#123;config_name&#125;</span>.txt&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;基准测试完成!&quot;</span></span><br></pre></td></tr></table></figure>



<h3 id="3-5-3-压力测试脚本"><a href="#3-5-3-压力测试脚本" class="headerlink" title="3.5.3 压力测试脚本"></a>3.5.3 压力测试脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># scripts/stress_test.sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 压力测试 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译</span></span><br><span class="line">make clean</span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">&quot;http_server&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;编译失败!&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;启动高性能服务器配置...&quot;</span></span><br><span class="line">./http_server -p 8087 -t 16:64 -q 2048 -c 50000 &amp;</span><br><span class="line">SERVER_PID=$!</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;服务器进程ID: <span class="variable">$SERVER_PID</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;等待服务器启动...&quot;</span></span><br><span class="line"><span class="built_in">sleep</span> 5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查服务器状态</span></span><br><span class="line"><span class="keyword">if</span> ! <span class="built_in">kill</span> -0 <span class="variable">$SERVER_PID</span> 2&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;服务器启动失败!&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;服务器运行中，开始压力测试...&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试1: 高并发连接</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 测试1: 高并发连接 (1000并发) ===&quot;</span></span><br><span class="line">ab -n 10000 -c 1000 -k <span class="string">&quot;http://localhost:8087/&quot;</span> &gt; logs/stress_test1.txt 2&gt;&amp;1</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;完成&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试2: 持续负载</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 测试2: 持续负载 (60秒) ===&quot;</span></span><br><span class="line">siege -b -t60S -c100 <span class="string">&quot;http://localhost:8087/&quot;</span> &gt; logs/stress_test2.txt 2&gt;&amp;1</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;完成&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试3: 混合请求</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 测试3: 混合请求类型 ===&quot;</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /tmp/mixed_requests.lua &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">wrk.method = <span class="string">&quot;GET&quot;</span></span><br><span class="line">wrk.headers[<span class="string">&quot;Content-Type&quot;</span>] = <span class="string">&quot;application/json&quot;</span></span><br><span class="line"></span><br><span class="line">request = <span class="keyword">function</span>()</span><br><span class="line">    <span class="built_in">local</span> paths = &#123;<span class="string">&quot;/&quot;</span>, <span class="string">&quot;/api/status&quot;</span>, <span class="string">&quot;/api/echo&quot;</span>&#125;</span><br><span class="line">    <span class="built_in">local</span> path = paths[math.random(<span class="comment">#paths)]</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> path == <span class="string">&quot;/api/echo&quot;</span> <span class="keyword">then</span></span><br><span class="line">        wrk.method = <span class="string">&quot;POST&quot;</span></span><br><span class="line">        wrk.body = <span class="string">&#x27;&#123;&quot;test&quot;: &quot;data_&#x27;</span> .. math.random(1000) .. <span class="string">&#x27;&quot;&#125;&#x27;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        wrk.method = <span class="string">&quot;GET&quot;</span></span><br><span class="line">        wrk.body = nil</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">return</span> wrk.format(nil, path)</span><br><span class="line">end</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">wrk -t12 -c400 -d30s --script=/tmp/mixed_requests.lua http://localhost:8087/ &gt; logs/stress_test3.txt 2&gt;&amp;1</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;完成&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看服务器统计</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 服务器统计信息 ===&quot;</span></span><br><span class="line">curl -s <span class="string">&quot;http://localhost:8087/stats&quot;</span> | python3 -m json.tool 2&gt;/dev/null || curl -s <span class="string">&quot;http://localhost:8087/stats&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 服务器日志摘要 ===&quot;</span></span><br><span class="line"><span class="built_in">tail</span> -n 50 logs/server.log | grep -E <span class="string">&quot;(ERROR|WARNING|INFO.*connection)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止服务器</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 停止服务器 ===&quot;</span></span><br><span class="line"><span class="built_in">kill</span> <span class="variable">$SERVER_PID</span></span><br><span class="line"><span class="built_in">wait</span> <span class="variable">$SERVER_PID</span> 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成报告</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 压力测试报告 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;测试1 - 高并发连接:&quot;</span></span><br><span class="line">grep -A5 <span class="string">&quot;Server Software&quot;</span> logs/stress_test1.txt</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;测试2 - 持续负载:&quot;</span></span><br><span class="line"><span class="built_in">tail</span> -n 10 logs/stress_test2.txt</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;测试3 - 混合请求:&quot;</span></span><br><span class="line"><span class="built_in">tail</span> -n 10 logs/stress_test3.txt</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n压力测试完成!&quot;</span></span><br></pre></td></tr></table></figure>



<h2 id="3-6-编译和测试"><a href="#3-6-编译和测试" class="headerlink" title="3.6 编译和测试"></a>3.6 编译和测试</h2><h3 id="3-6-1-初始化项目"><a href="#3-6-1-初始化项目" class="headerlink" title="3.6.1 初始化项目"></a>3.6.1 初始化项目</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建目录结构</span></span><br><span class="line">make init</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译项目</span></span><br><span class="line">make</span><br></pre></td></tr></table></figure>



<h3 id="3-6-2-运行线程池服务器"><a href="#3-6-2-运行线程池服务器" class="headerlink" title="3.6.2 运行线程池服务器"></a>3.6.2 运行线程池服务器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认配置运行</span></span><br><span class="line">./http_server -p 8080 -t 4:16 -q 256</span><br><span class="line"></span><br><span class="line"><span class="comment"># 高性能配置</span></span><br><span class="line">./http_server -p 8080 -t 8:64 -q 1024 -c 10000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用make命令</span></span><br><span class="line">make run</span><br><span class="line">make run-high</span><br></pre></td></tr></table></figure>



<h3 id="3-6-3-运行测试"><a href="#3-6-3-运行测试" class="headerlink" title="3.6.3 运行测试"></a>3.6.3 运行测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行线程池测试</span></span><br><span class="line">make <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行基准测试</span></span><br><span class="line">make benchmark</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行压力测试</span></span><br><span class="line">./scripts/stress_test.sh</span><br></pre></td></tr></table></figure>



<h3 id="3-6-4-性能分析和调试"><a href="#3-6-4-性能分析和调试" class="headerlink" title="3.6.4 性能分析和调试"></a>3.6.4 性能分析和调试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用gdb调试线程池</span></span><br><span class="line">make debug</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内存泄漏检查</span></span><br><span class="line">make valgrind</span><br><span class="line"></span><br><span class="line"><span class="comment"># 性能分析</span></span><br><span class="line">make profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看实时统计</span></span><br><span class="line">watch -n 1 <span class="string">&quot;curl -s http://localhost:8080/stats | python3 -m json.tool&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 监控系统资源</span></span><br><span class="line">top -p $(pgrep -f http_server)</span><br></pre></td></tr></table></figure>



<h3 id="3-6-5-测试客户端脚本"><a href="#3-6-5-测试客户端脚本" class="headerlink" title="3.6.5 测试客户端脚本"></a>3.6.5 测试客户端脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># scripts/test_client.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试并发客户端</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 并发客户端测试 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动多个客户端</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..10&#125;; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;客户端 <span class="variable">$i</span> 启动...&quot;</span></span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> &#123;1..5&#125;; <span class="keyword">do</span></span><br><span class="line">            response=$(curl -s -w <span class="string">&quot; 时间: %&#123;time_total&#125;s\n&quot;</span> <span class="string">&quot;http://localhost:8080/&quot;</span>)</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;客户端 <span class="variable">$i</span> 请求 <span class="variable">$j</span> 完成&quot;</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    ) &amp;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">wait</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;所有客户端完成&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试不同端点</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 测试不同端点 ===&quot;</span></span><br><span class="line"></span><br><span class="line">endpoints=(<span class="string">&quot;/&quot;</span> <span class="string">&quot;/api/status&quot;</span> <span class="string">&quot;/slow&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> endpoint <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;endpoints[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;测试端点: <span class="variable">$endpoint</span>&quot;</span></span><br><span class="line">    time curl -s <span class="string">&quot;http://localhost:8080<span class="variable">$endpoint</span>&quot;</span> &gt; /dev/null</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试POST请求</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 测试POST请求 ===&quot;</span></span><br><span class="line">curl -X POST -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">     -d <span class="string">&#x27;&#123;&quot;name&quot;: &quot;test&quot;, &quot;value&quot;: 123&#125;&#x27;</span> \</span><br><span class="line">     <span class="string">&quot;http://localhost:8080/api/echo&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n测试完成&quot;</span></span><br></pre></td></tr></table></figure>



<h2 id="3-7-总结"><a href="#3-7-总结" class="headerlink" title="3.7 总结"></a>3.7 总结</h2><p>在这个阶段，我们实现了一个完整的线程池系统，极大地提高了服务器的并发处理能力：</p>
<h3 id="实现的功能：-1"><a href="#实现的功能：-1" class="headerlink" title="实现的功能："></a>实现的功能：</h3><ol>
<li><strong>动态线程池</strong>：<ul>
<li>支持最小和最大线程数配置</li>
<li>根据负载动态调整线程数量</li>
<li>任务队列管理</li>
</ul>
</li>
<li><strong>连接管理</strong>：<ul>
<li>连接上下文管理</li>
<li>异步连接处理</li>
<li>连接统计和监控</li>
</ul>
</li>
<li><strong>性能优化</strong>：<ul>
<li>非阻塞I&#x2F;O操作</li>
<li>连接超时设置</li>
<li>统计信息收集</li>
</ul>
</li>
<li><strong>监控端点</strong>：<ul>
<li><code>/stats</code> 端点提供服务器统计信息</li>
<li>详细的线程池状态监控</li>
</ul>
</li>
</ol>
<h3 id="学到的技能：-1"><a href="#学到的技能：-1" class="headerlink" title="学到的技能："></a>学到的技能：</h3><ol>
<li><strong>多线程编程</strong>：<ul>
<li>pthread线程库使用</li>
<li>线程同步（互斥锁、条件变量）</li>
<li>线程安全设计</li>
</ul>
</li>
<li><strong>并发模型</strong>：<ul>
<li>生产者-消费者模式</li>
<li>线程池设计模式</li>
<li>任务队列管理</li>
</ul>
</li>
<li><strong>性能调优</strong>：<ul>
<li>动态线程调整策略</li>
<li>连接池管理</li>
<li>性能基准测试</li>
</ul>
</li>
<li><strong>系统监控</strong>：<ul>
<li>资源使用统计</li>
<li>性能指标收集</li>
<li>实时状态监控</li>
</ul>
</li>
</ol>
<h3 id="运维和调试技巧：-1"><a href="#运维和调试技巧：-1" class="headerlink" title="运维和调试技巧："></a>运维和调试技巧：</h3><ol>
<li><strong>线程调试</strong>：<ul>
<li>使用gdb调试多线程程序</li>
<li>线程竞争条件检测</li>
<li>死锁分析和预防</li>
</ul>
</li>
<li><strong>性能分析</strong>：<ul>
<li>使用ab进行压力测试</li>
<li>使用siege进行持续负载测试</li>
<li>使用wrk进行混合请求测试</li>
</ul>
</li>
<li><strong>资源监控</strong>：<ul>
<li>线程池状态监控</li>
<li>连接统计跟踪</li>
<li>内存使用分析</li>
</ul>
</li>
<li><strong>故障排查</strong>：<ul>
<li>连接泄漏检测</li>
<li>线程池饱和处理</li>
<li>优雅降级策略</li>
</ul>
</li>
</ol>
<h3 id="性能对比结果："><a href="#性能对比结果：" class="headerlink" title="性能对比结果："></a>性能对比结果：</h3><p>通过基准测试，你可以观察到：</p>
<ul>
<li>单线程服务器 vs 线程池服务器的性能差异</li>
<li>不同线程池配置的性能表现</li>
<li>并发连接处理能力</li>
</ul>
<p>现在你已经拥有了一个高性能、可扩展的多线程HTTP服务器！在阶段4中，我们将添加配置管理、SSL支持和更多高级功能。</p>
<h1 id="阶段4：配置管理、SSL支持和高级功能"><a href="#阶段4：配置管理、SSL支持和高级功能" class="headerlink" title="阶段4：配置管理、SSL支持和高级功能"></a>阶段4：配置管理、SSL支持和高级功能</h1><p>在这个阶段，我们将添加配置文件管理、SSL&#x2F;TLS支持、更完善的错误处理和资源管理，以及更多监控功能。</p>
<h2 id="4-1-配置文件管理模块"><a href="#4-1-配置文件管理模块" class="headerlink" title="4.1 配置文件管理模块"></a>4.1 配置文件管理模块</h2><h3 id="4-1-1-配置文件头文件（config-h）"><a href="#4-1-1-配置文件头文件（config-h）" class="headerlink" title="4.1.1 配置文件头文件（config.h）"></a>4.1.1 配置文件头文件（config.h）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/config.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 日志级别枚举</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    CONFIG_LOG_DEBUG = <span class="number">0</span>,</span><br><span class="line">    CONFIG_LOG_INFO,</span><br><span class="line">    CONFIG_LOG_WARNING,</span><br><span class="line">    CONFIG_LOG_ERROR,</span><br><span class="line">    CONFIG_LOG_NONE</span><br><span class="line">&#125; ConfigLogLevel;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SSL配置</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> enabled;                <span class="comment">// 是否启用SSL</span></span><br><span class="line">    <span class="type">char</span> cert_file[<span class="number">512</span>];        <span class="comment">// 证书文件路径</span></span><br><span class="line">    <span class="type">char</span> key_file[<span class="number">512</span>];         <span class="comment">// 私钥文件路径</span></span><br><span class="line">    <span class="type">char</span> ca_file[<span class="number">512</span>];          <span class="comment">// CA证书文件路径（可选）</span></span><br><span class="line">    <span class="type">int</span> verify_client;          <span class="comment">// 是否验证客户端证书</span></span><br><span class="line">    <span class="type">int</span> ssl_protocol;           <span class="comment">// SSL协议版本</span></span><br><span class="line">&#125; SSLConfig;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线程池配置</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> min_threads;           <span class="comment">// 最小线程数</span></span><br><span class="line">    <span class="type">int</span> max_threads;           <span class="comment">// 最大线程数</span></span><br><span class="line">    <span class="type">int</span> queue_size;            <span class="comment">// 任务队列大小</span></span><br><span class="line">    <span class="type">int</span> keep_alive_time;       <span class="comment">// 线程保活时间（秒）</span></span><br><span class="line">    <span class="type">int</span> shutdown_timeout;      <span class="comment">// 关闭超时时间（秒）</span></span><br><span class="line">&#125; ThreadPoolConfig;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务器配置</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// 基本配置</span></span><br><span class="line">    <span class="type">int</span> port;                   <span class="comment">// 监听端口</span></span><br><span class="line">    <span class="type">char</span> host[<span class="number">256</span>];             <span class="comment">// 绑定主机</span></span><br><span class="line">    <span class="type">int</span> backlog;                <span class="comment">// 连接队列大小</span></span><br><span class="line">    <span class="type">int</span> max_connections;        <span class="comment">// 最大连接数</span></span><br><span class="line">    <span class="type">int</span> timeout;                <span class="comment">// 连接超时（秒）</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 文件服务配置</span></span><br><span class="line">    <span class="type">char</span> document_root[<span class="number">512</span>];    <span class="comment">// 文档根目录</span></span><br><span class="line">    <span class="type">char</span> index_files[<span class="number">256</span>];      <span class="comment">// 默认索引文件</span></span><br><span class="line">    <span class="type">int</span> directory_listing;      <span class="comment">// 是否启用目录列表</span></span><br><span class="line">    <span class="type">int</span> follow_symlinks;        <span class="comment">// 是否跟随符号链接</span></span><br><span class="line">    <span class="type">size_t</span> max_upload_size;     <span class="comment">// 最大上传文件大小</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 日志配置</span></span><br><span class="line">    <span class="type">char</span> log_file[<span class="number">512</span>];         <span class="comment">// 日志文件路径</span></span><br><span class="line">    ConfigLogLevel log_level;   <span class="comment">// 日志级别</span></span><br><span class="line">    <span class="type">int</span> log_max_size;           <span class="comment">// 日志最大大小（MB）</span></span><br><span class="line">    <span class="type">int</span> log_backup_count;       <span class="comment">// 日志备份数量</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 性能配置</span></span><br><span class="line">    <span class="type">int</span> tcp_nodelay;            <span class="comment">// 禁用Nagle算法</span></span><br><span class="line">    <span class="type">int</span> tcp_keepalive;          <span class="comment">// 启用TCP keepalive</span></span><br><span class="line">    <span class="type">int</span> reuse_addr;             <span class="comment">// 地址重用</span></span><br><span class="line">    <span class="type">int</span> reuse_port;             <span class="comment">// 端口重用</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 安全配置</span></span><br><span class="line">    <span class="type">int</span> enable_limits;          <span class="comment">// 启用限制</span></span><br><span class="line">    <span class="type">int</span> max_requests_per_ip;    <span class="comment">// 每个IP最大请求数</span></span><br><span class="line">    <span class="type">int</span> rate_limit;             <span class="comment">// 请求速率限制（请求/秒）</span></span><br><span class="line">    <span class="type">int</span> enable_cors;            <span class="comment">// 启用CORS</span></span><br><span class="line">    <span class="type">char</span> cors_origin[<span class="number">256</span>];      <span class="comment">// CORS允许的来源</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SSL配置</span></span><br><span class="line">    SSLConfig ssl;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 线程池配置</span></span><br><span class="line">    ThreadPoolConfig thread_pool;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 热重载标志</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">int</span> reload_flag;</span><br><span class="line">    <span class="type">pthread_mutex_t</span> reload_mutex;</span><br><span class="line">    <span class="type">char</span> config_file[<span class="number">512</span>];      <span class="comment">// 配置文件路径</span></span><br><span class="line">    <span class="type">time_t</span> last_modified;       <span class="comment">// 最后修改时间</span></span><br><span class="line">&#125; ServerConfig;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建默认配置</span></span><br><span class="line">ServerConfig* <span class="title function_">config_create_default</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从文件加载配置</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">config_load_from_file</span><span class="params">(ServerConfig *config, <span class="type">const</span> <span class="type">char</span> *filename)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从命令行参数加载配置</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">config_load_from_args</span><span class="params">(ServerConfig *config, <span class="type">int</span> argc, <span class="type">char</span> *argv[])</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存配置到文件</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">config_save_to_file</span><span class="params">(<span class="type">const</span> ServerConfig *config, <span class="type">const</span> <span class="type">char</span> *filename)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证配置</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">config_validate</span><span class="params">(<span class="type">const</span> ServerConfig *config)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印配置</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">config_print</span><span class="params">(<span class="type">const</span> ServerConfig *config)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放配置资源</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">config_destroy</span><span class="params">(ServerConfig *config)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查是否需要重载配置</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">config_should_reload</span><span class="params">(ServerConfig *config)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重载配置</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">config_reload</span><span class="params">(ServerConfig *config)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取配置字符串值</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="title function_">config_get_string</span><span class="params">(<span class="type">const</span> ServerConfig *config, <span class="type">const</span> <span class="type">char</span> *key, <span class="type">const</span> <span class="type">char</span> *default_value)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取配置整数值</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">config_get_int</span><span class="params">(<span class="type">const</span> ServerConfig *config, <span class="type">const</span> <span class="type">char</span> *key, <span class="type">int</span> default_value)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取配置布尔值</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">config_get_bool</span><span class="params">(<span class="type">const</span> ServerConfig *config, <span class="type">const</span> <span class="type">char</span> *key, <span class="type">int</span> default_value)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置热重载回调</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">config_set_reload_callback</span><span class="params">(<span class="type">void</span> (*callback)(ServerConfig *))</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// CONFIG_H</span></span></span><br></pre></td></tr></table></figure>



<h3 id="4-1-2-配置文件实现（config-c）"><a href="#4-1-2-配置文件实现（config-c）" class="headerlink" title="4.1.2 配置文件实现（config.c）"></a>4.1.2 配置文件实现（config.c）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/config.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/logger.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 内部函数声明</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">trim_whitespace</span><span class="params">(<span class="type">char</span> *str)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span>* <span class="title function_">strdup_trimmed</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *str)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">parse_config_line</span><span class="params">(<span class="type">char</span> *line, <span class="type">char</span> **key, <span class="type">char</span> **value)</span>;</span><br><span class="line"><span class="type">static</span> ConfigLogLevel <span class="title function_">parse_log_level</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *level_str)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span>* <span class="title function_">log_level_to_string</span><span class="params">(ConfigLogLevel level)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">string_to_bool</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *str)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">set_default_values</span><span class="params">(ServerConfig *config)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建默认配置</span></span><br><span class="line">ServerConfig* <span class="title function_">config_create_default</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    ServerConfig *config = (ServerConfig*)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(ServerConfig));</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to allocate memory for config&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    set_default_values(config);</span><br><span class="line">    pthread_mutex_init(&amp;config-&gt;reload_mutex, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置默认值</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">set_default_values</span><span class="params">(ServerConfig *config)</span> &#123;</span><br><span class="line">    <span class="comment">// 基本配置</span></span><br><span class="line">    config-&gt;port = <span class="number">8080</span>;</span><br><span class="line">    <span class="built_in">strcpy</span>(config-&gt;host, <span class="string">&quot;0.0.0.0&quot;</span>);</span><br><span class="line">    config-&gt;backlog = <span class="number">1024</span>;</span><br><span class="line">    config-&gt;max_connections = <span class="number">10000</span>;</span><br><span class="line">    config-&gt;timeout = <span class="number">30</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 文件服务配置</span></span><br><span class="line">    <span class="built_in">strcpy</span>(config-&gt;document_root, <span class="string">&quot;.&quot;</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(config-&gt;index_files, <span class="string">&quot;index.html,index.htm&quot;</span>);</span><br><span class="line">    config-&gt;directory_listing = <span class="number">0</span>;</span><br><span class="line">    config-&gt;follow_symlinks = <span class="number">0</span>;</span><br><span class="line">    config-&gt;max_upload_size = <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>; <span class="comment">// 10MB</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 日志配置</span></span><br><span class="line">    <span class="built_in">strcpy</span>(config-&gt;log_file, <span class="string">&quot;logs/server.log&quot;</span>);</span><br><span class="line">    config-&gt;log_level = CONFIG_LOG_INFO;</span><br><span class="line">    config-&gt;log_max_size = <span class="number">10</span>; <span class="comment">// 10MB</span></span><br><span class="line">    config-&gt;log_backup_count = <span class="number">5</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 性能配置</span></span><br><span class="line">    config-&gt;tcp_nodelay = <span class="number">1</span>;</span><br><span class="line">    config-&gt;tcp_keepalive = <span class="number">1</span>;</span><br><span class="line">    config-&gt;reuse_addr = <span class="number">1</span>;</span><br><span class="line">    config-&gt;reuse_port = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 安全配置</span></span><br><span class="line">    config-&gt;enable_limits = <span class="number">0</span>;</span><br><span class="line">    config-&gt;max_requests_per_ip = <span class="number">1000</span>;</span><br><span class="line">    config-&gt;rate_limit = <span class="number">100</span>; <span class="comment">// 100请求/秒</span></span><br><span class="line">    config-&gt;enable_cors = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">strcpy</span>(config-&gt;cors_origin, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SSL配置</span></span><br><span class="line">    config-&gt;ssl.enabled = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">strcpy</span>(config-&gt;ssl.cert_file, <span class="string">&quot;cert.pem&quot;</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(config-&gt;ssl.key_file, <span class="string">&quot;key.pem&quot;</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(config-&gt;ssl.ca_file, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    config-&gt;ssl.verify_client = <span class="number">0</span>;</span><br><span class="line">    config-&gt;ssl.ssl_protocol = <span class="number">0</span>; <span class="comment">// 0 = 自动选择最佳</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 线程池配置</span></span><br><span class="line">    config-&gt;thread_pool.min_threads = <span class="number">4</span>;</span><br><span class="line">    config-&gt;thread_pool.max_threads = <span class="number">32</span>;</span><br><span class="line">    config-&gt;thread_pool.queue_size = <span class="number">256</span>;</span><br><span class="line">    config-&gt;thread_pool.keep_alive_time = <span class="number">60</span>;</span><br><span class="line">    config-&gt;thread_pool.shutdown_timeout = <span class="number">10</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 热重载相关</span></span><br><span class="line">    config-&gt;reload_flag = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">strcpy</span>(config-&gt;config_file, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    config-&gt;last_modified = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从文件加载配置</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">config_load_from_file</span><span class="params">(ServerConfig *config, <span class="type">const</span> <span class="type">char</span> *filename)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="literal">NULL</span> || filename == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Invalid parameters for config_load_from_file&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    FILE *file = fopen(filename, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to open config file: %s (%s)&quot;</span>, filename, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Loading configuration from: %s&quot;</span>, filename);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 保存配置文件路径</span></span><br><span class="line">    <span class="built_in">strncpy</span>(config-&gt;config_file, filename, <span class="keyword">sizeof</span>(config-&gt;config_file) - <span class="number">1</span>);</span><br><span class="line">    config-&gt;config_file[<span class="keyword">sizeof</span>(config-&gt;config_file) - <span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取文件修改时间</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">file_stat</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (stat(filename, &amp;file_stat) == <span class="number">0</span>) &#123;</span><br><span class="line">        config-&gt;last_modified = file_stat.st_mtime;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> line[<span class="number">1024</span>];</span><br><span class="line">    <span class="type">int</span> line_number = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> errors = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (fgets(line, <span class="keyword">sizeof</span>(line), file) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        line_number++;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 跳过注释和空行</span></span><br><span class="line">        trim_whitespace(line);</span><br><span class="line">        <span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;#&#x27;</span> || line[<span class="number">0</span>] == <span class="string">&#x27;;&#x27;</span> || line[<span class="number">0</span>] == <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 解析键值对</span></span><br><span class="line">        <span class="type">char</span> *key = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="type">char</span> *value = <span class="literal">NULL</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (parse_config_line(line, &amp;key, &amp;value) != <span class="number">0</span>) &#123;</span><br><span class="line">            LOG_WARNING(<span class="string">&quot;Invalid config line %d: %s&quot;</span>, line_number, line);</span><br><span class="line">            errors++;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 处理配置项</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;port&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;port = atoi(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;host&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">strncpy</span>(config-&gt;host, value, <span class="keyword">sizeof</span>(config-&gt;host) - <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;backlog&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;backlog = atoi(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;max_connections&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;max_connections = atoi(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;timeout&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;timeout = atoi(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;document_root&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">strncpy</span>(config-&gt;document_root, value, <span class="keyword">sizeof</span>(config-&gt;document_root) - <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;index_files&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">strncpy</span>(config-&gt;index_files, value, <span class="keyword">sizeof</span>(config-&gt;index_files) - <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;directory_listing&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;directory_listing = string_to_bool(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;follow_symlinks&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;follow_symlinks = string_to_bool(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;max_upload_size&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;max_upload_size = atoll(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;log_file&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">strncpy</span>(config-&gt;log_file, value, <span class="keyword">sizeof</span>(config-&gt;log_file) - <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;log_level&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;log_level = parse_log_level(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;log_max_size&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;log_max_size = atoi(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;log_backup_count&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;log_backup_count = atoi(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;tcp_nodelay&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;tcp_nodelay = string_to_bool(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;tcp_keepalive&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;tcp_keepalive = string_to_bool(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;reuse_addr&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;reuse_addr = string_to_bool(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;reuse_port&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;reuse_port = string_to_bool(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;enable_limits&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;enable_limits = string_to_bool(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;max_requests_per_ip&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;max_requests_per_ip = atoi(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;rate_limit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;rate_limit = atoi(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;enable_cors&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;enable_cors = string_to_bool(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;cors_origin&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">strncpy</span>(config-&gt;cors_origin, value, <span class="keyword">sizeof</span>(config-&gt;cors_origin) - <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;ssl_enabled&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;ssl.enabled = string_to_bool(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;ssl_cert_file&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">strncpy</span>(config-&gt;ssl.cert_file, value, <span class="keyword">sizeof</span>(config-&gt;ssl.cert_file) - <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;ssl_key_file&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">strncpy</span>(config-&gt;ssl.key_file, value, <span class="keyword">sizeof</span>(config-&gt;ssl.key_file) - <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;ssl_ca_file&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">strncpy</span>(config-&gt;ssl.ca_file, value, <span class="keyword">sizeof</span>(config-&gt;ssl.ca_file) - <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;ssl_verify_client&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;ssl.verify_client = string_to_bool(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;ssl_protocol&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;ssl.ssl_protocol = atoi(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;min_threads&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;thread_pool.min_threads = atoi(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;max_threads&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;thread_pool.max_threads = atoi(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;queue_size&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;thread_pool.queue_size = atoi(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;keep_alive_time&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;thread_pool.keep_alive_time = atoi(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;shutdown_timeout&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;thread_pool.shutdown_timeout = atoi(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LOG_WARNING(<span class="string">&quot;Unknown config key &#x27;%s&#x27; on line %d&quot;</span>, key, line_number);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">free</span>(key);</span><br><span class="line">        <span class="built_in">free</span>(value);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    fclose(file);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (errors &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_WARNING(<span class="string">&quot;Configuration file %s had %d errors&quot;</span>, filename, errors);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Configuration loaded successfully from %s&quot;</span>, filename);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从命令行参数加载配置</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">config_load_from_args</span><span class="params">(ServerConfig *config, <span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="literal">NULL</span> || argc &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; argc; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-c&quot;</span>) == <span class="number">0</span> &amp;&amp; i + <span class="number">1</span> &lt; argc) &#123;</span><br><span class="line">            <span class="comment">// 从配置文件加载</span></span><br><span class="line">            <span class="keyword">if</span> (config_load_from_file(config, argv[++i]) != <span class="number">0</span>) &#123;</span><br><span class="line">                LOG_ERROR(<span class="string">&quot;Failed to load config file: %s&quot;</span>, argv[i]);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-p&quot;</span>) == <span class="number">0</span> &amp;&amp; i + <span class="number">1</span> &lt; argc) &#123;</span><br><span class="line">            config-&gt;port = atoi(argv[++i]);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-h&quot;</span>) == <span class="number">0</span> &amp;&amp; i + <span class="number">1</span> &lt; argc) &#123;</span><br><span class="line">            <span class="built_in">strncpy</span>(config-&gt;host, argv[++i], <span class="keyword">sizeof</span>(config-&gt;host) - <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-r&quot;</span>) == <span class="number">0</span> &amp;&amp; i + <span class="number">1</span> &lt; argc) &#123;</span><br><span class="line">            <span class="built_in">strncpy</span>(config-&gt;document_root, argv[++i], <span class="keyword">sizeof</span>(config-&gt;document_root) - <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-t&quot;</span>) == <span class="number">0</span> &amp;&amp; i + <span class="number">1</span> &lt; argc) &#123;</span><br><span class="line">            <span class="type">char</span> *threads = argv[++i];</span><br><span class="line">            <span class="type">char</span> *colon = <span class="built_in">strchr</span>(threads, <span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (colon != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                *colon = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                config-&gt;thread_pool.min_threads = atoi(threads);</span><br><span class="line">                config-&gt;thread_pool.max_threads = atoi(colon + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-q&quot;</span>) == <span class="number">0</span> &amp;&amp; i + <span class="number">1</span> &lt; argc) &#123;</span><br><span class="line">            config-&gt;thread_pool.queue_size = atoi(argv[++i]);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-l&quot;</span>) == <span class="number">0</span> &amp;&amp; i + <span class="number">1</span> &lt; argc) &#123;</span><br><span class="line">            config-&gt;log_level = parse_log_level(argv[++i]);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--ssl&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            config-&gt;ssl.enabled = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--ssl-cert&quot;</span>) == <span class="number">0</span> &amp;&amp; i + <span class="number">1</span> &lt; argc) &#123;</span><br><span class="line">            <span class="built_in">strncpy</span>(config-&gt;ssl.cert_file, argv[++i], <span class="keyword">sizeof</span>(config-&gt;ssl.cert_file) - <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--ssl-key&quot;</span>) == <span class="number">0</span> &amp;&amp; i + <span class="number">1</span> &lt; argc) &#123;</span><br><span class="line">            <span class="built_in">strncpy</span>(config-&gt;ssl.key_file, argv[++i], <span class="keyword">sizeof</span>(config-&gt;ssl.key_file) - <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--help&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Usage: %s [OPTIONS]\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\nOptions:\n&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;  -c FILE       Load configuration from FILE\n&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;  -p PORT       Port to listen on (default: %d)\n&quot;</span>, config-&gt;port);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;  -h HOST       Host to bind to (default: %s)\n&quot;</span>, config-&gt;host);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;  -r ROOT       Document root directory (default: %s)\n&quot;</span>, config-&gt;document_root);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;  -t MIN:MAX    Thread pool min and max threads (default: %d:%d)\n&quot;</span>, </span><br><span class="line">                   config-&gt;thread_pool.min_threads, config-&gt;thread_pool.max_threads);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;  -q SIZE       Task queue size (default: %d)\n&quot;</span>, config-&gt;thread_pool.queue_size);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;  -l LEVEL      Log level: debug, info, warning, error (default: info)\n&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;  --ssl         Enable SSL/TLS\n&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;  --ssl-cert FILE   SSL certificate file\n&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;  --ssl-key FILE    SSL private key file\n&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;  --help        Show this help message\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">// 特殊返回值表示显示帮助</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LOG_WARNING(<span class="string">&quot;Unknown command line option: %s&quot;</span>, argv[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析配置行</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">parse_config_line</span><span class="params">(<span class="type">char</span> *line, <span class="type">char</span> **key, <span class="type">char</span> **value)</span> &#123;</span><br><span class="line">    <span class="type">char</span> *equal_sign = <span class="built_in">strchr</span>(line, <span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (equal_sign == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">// 没有等号，无效行</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    *equal_sign = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="type">char</span> *key_part = line;</span><br><span class="line">    <span class="type">char</span> *value_part = equal_sign + <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    trim_whitespace(key_part);</span><br><span class="line">    trim_whitespace(value_part);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span>(key_part) == <span class="number">0</span> || <span class="built_in">strlen</span>(value_part) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">// 键或值为空，无效行</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    *key = strdup_trimmed(key_part);</span><br><span class="line">    *value = strdup_trimmed(value_part);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修剪空白字符</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">trim_whitespace</span><span class="params">(<span class="type">char</span> *str)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 去除开头的空白字符</span></span><br><span class="line">    <span class="type">char</span> *start = str;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">isspace</span>((<span class="type">unsigned</span> <span class="type">char</span>)*start)) &#123;</span><br><span class="line">        start++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果整个字符串都是空白</span></span><br><span class="line">    <span class="keyword">if</span> (*start == <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">        str[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 移动字符串到开头</span></span><br><span class="line">    <span class="keyword">if</span> (start != str) &#123;</span><br><span class="line">        <span class="type">char</span> *dst = str;</span><br><span class="line">        <span class="keyword">while</span> (*start != <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">            *dst++ = *start++;</span><br><span class="line">        &#125;</span><br><span class="line">        *dst = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 去除末尾的空白字符</span></span><br><span class="line">    <span class="type">char</span> *end = str + <span class="built_in">strlen</span>(str) - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (end &gt; str &amp;&amp; <span class="built_in">isspace</span>((<span class="type">unsigned</span> <span class="type">char</span>)*end)) &#123;</span><br><span class="line">        end--;</span><br><span class="line">    &#125;</span><br><span class="line">    *(end + <span class="number">1</span>) = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复制并修剪字符串</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span>* <span class="title function_">strdup_trimmed</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *str)</span> &#123;</span><br><span class="line">    <span class="type">char</span> *trimmed = strdup(str);</span><br><span class="line">    <span class="keyword">if</span> (trimmed != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        trim_whitespace(trimmed);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> trimmed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析日志级别</span></span><br><span class="line"><span class="type">static</span> ConfigLogLevel <span class="title function_">parse_log_level</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *level_str)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(level_str, <span class="string">&quot;debug&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> CONFIG_LOG_DEBUG;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strcasecmp(level_str, <span class="string">&quot;info&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> CONFIG_LOG_INFO;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strcasecmp(level_str, <span class="string">&quot;warning&quot;</span>) == <span class="number">0</span> || strcasecmp(level_str, <span class="string">&quot;warn&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> CONFIG_LOG_WARNING;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strcasecmp(level_str, <span class="string">&quot;error&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> CONFIG_LOG_ERROR;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strcasecmp(level_str, <span class="string">&quot;none&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> CONFIG_LOG_NONE;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        LOG_WARNING(<span class="string">&quot;Unknown log level: %s, defaulting to INFO&quot;</span>, level_str);</span><br><span class="line">        <span class="keyword">return</span> CONFIG_LOG_INFO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 日志级别转字符串</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span>* <span class="title function_">log_level_to_string</span><span class="params">(ConfigLogLevel level)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (level) &#123;</span><br><span class="line">        <span class="keyword">case</span> CONFIG_LOG_DEBUG: <span class="keyword">return</span> <span class="string">&quot;debug&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> CONFIG_LOG_INFO: <span class="keyword">return</span> <span class="string">&quot;info&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> CONFIG_LOG_WARNING: <span class="keyword">return</span> <span class="string">&quot;warning&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> CONFIG_LOG_ERROR: <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> CONFIG_LOG_NONE: <span class="keyword">return</span> <span class="string">&quot;none&quot;</span>;</span><br><span class="line">        <span class="keyword">default</span>: <span class="keyword">return</span> <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 字符串转布尔值</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">string_to_bool</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *str)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(str, <span class="string">&quot;true&quot;</span>) == <span class="number">0</span> ||</span><br><span class="line">        strcasecmp(str, <span class="string">&quot;yes&quot;</span>) == <span class="number">0</span> ||</span><br><span class="line">        strcasecmp(str, <span class="string">&quot;on&quot;</span>) == <span class="number">0</span> ||</span><br><span class="line">        strcasecmp(str, <span class="string">&quot;1&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(str, <span class="string">&quot;false&quot;</span>) == <span class="number">0</span> ||</span><br><span class="line">        strcasecmp(str, <span class="string">&quot;no&quot;</span>) == <span class="number">0</span> ||</span><br><span class="line">        strcasecmp(str, <span class="string">&quot;off&quot;</span>) == <span class="number">0</span> ||</span><br><span class="line">        strcasecmp(str, <span class="string">&quot;0&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    LOG_WARNING(<span class="string">&quot;Invalid boolean value: %s, defaulting to false&quot;</span>, str);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证配置</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">config_validate</span><span class="params">(<span class="type">const</span> ServerConfig *config)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Config is NULL&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查端口</span></span><br><span class="line">    <span class="keyword">if</span> (config-&gt;port &lt;= <span class="number">0</span> || config-&gt;port &gt; <span class="number">65535</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Invalid port: %d&quot;</span>, config-&gt;port);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查线程池配置</span></span><br><span class="line">    <span class="keyword">if</span> (config-&gt;thread_pool.min_threads &lt;= <span class="number">0</span> ||</span><br><span class="line">        config-&gt;thread_pool.max_threads &lt;= <span class="number">0</span> ||</span><br><span class="line">        config-&gt;thread_pool.min_threads &gt; config-&gt;thread_pool.max_threads) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Invalid thread pool configuration: min=%d, max=%d&quot;</span>,</span><br><span class="line">                 config-&gt;thread_pool.min_threads, config-&gt;thread_pool.max_threads);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查队列大小</span></span><br><span class="line">    <span class="keyword">if</span> (config-&gt;thread_pool.queue_size &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Invalid queue size: %d&quot;</span>, config-&gt;thread_pool.queue_size);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查SSL配置</span></span><br><span class="line">    <span class="keyword">if</span> (config-&gt;ssl.enabled) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">        <span class="keyword">if</span> (stat(config-&gt;ssl.cert_file, &amp;st) != <span class="number">0</span>) &#123;</span><br><span class="line">            LOG_ERROR(<span class="string">&quot;SSL certificate file not found: %s&quot;</span>, config-&gt;ssl.cert_file);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (stat(config-&gt;ssl.key_file, &amp;st) != <span class="number">0</span>) &#123;</span><br><span class="line">            LOG_ERROR(<span class="string">&quot;SSL key file not found: %s&quot;</span>, config-&gt;ssl.key_file);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (config-&gt;ssl.ca_file[<span class="number">0</span>] != <span class="string">&#x27;\0&#x27;</span> &amp;&amp; stat(config-&gt;ssl.ca_file, &amp;st) != <span class="number">0</span>) &#123;</span><br><span class="line">            LOG_ERROR(<span class="string">&quot;SSL CA file not found: %s&quot;</span>, config-&gt;ssl.ca_file);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查文档根目录</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (stat(config-&gt;document_root, &amp;st) != <span class="number">0</span> || !S_ISDIR(st.st_mode)) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Document root not found or not a directory: %s&quot;</span>, config-&gt;document_root);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Configuration validation passed&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印配置</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">config_print</span><span class="params">(<span class="type">const</span> ServerConfig *config)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Config is NULL\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n=== Server Configuration ===\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Basic:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  Port: %d\n&quot;</span>, config-&gt;port);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  Host: %s\n&quot;</span>, config-&gt;host);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  Backlog: %d\n&quot;</span>, config-&gt;backlog);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  Max connections: %d\n&quot;</span>, config-&gt;max_connections);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  Timeout: %d seconds\n&quot;</span>, config-&gt;timeout);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nFile Service:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  Document root: %s\n&quot;</span>, config-&gt;document_root);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  Index files: %s\n&quot;</span>, config-&gt;index_files);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  Directory listing: %s\n&quot;</span>, config-&gt;directory_listing ? <span class="string">&quot;enabled&quot;</span> : <span class="string">&quot;disabled&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  Follow symlinks: %s\n&quot;</span>, config-&gt;follow_symlinks ? <span class="string">&quot;enabled&quot;</span> : <span class="string">&quot;disabled&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  Max upload size: %zu bytes\n&quot;</span>, config-&gt;max_upload_size);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nLogging:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  Log file: %s\n&quot;</span>, config-&gt;log_file);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  Log level: %s\n&quot;</span>, log_level_to_string(config-&gt;log_level));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  Log max size: %d MB\n&quot;</span>, config-&gt;log_max_size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  Log backup count: %d\n&quot;</span>, config-&gt;log_backup_count);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nPerformance:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  TCP_NODELAY: %s\n&quot;</span>, config-&gt;tcp_nodelay ? <span class="string">&quot;enabled&quot;</span> : <span class="string">&quot;disabled&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  TCP_KEEPALIVE: %s\n&quot;</span>, config-&gt;tcp_keepalive ? <span class="string">&quot;enabled&quot;</span> : <span class="string">&quot;disabled&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  SO_REUSEADDR: %s\n&quot;</span>, config-&gt;reuse_addr ? <span class="string">&quot;enabled&quot;</span> : <span class="string">&quot;disabled&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  SO_REUSEPORT: %s\n&quot;</span>, config-&gt;reuse_port ? <span class="string">&quot;enabled&quot;</span> : <span class="string">&quot;disabled&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nSecurity:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  Rate limiting: %s\n&quot;</span>, config-&gt;enable_limits ? <span class="string">&quot;enabled&quot;</span> : <span class="string">&quot;disabled&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  Max requests per IP: %d\n&quot;</span>, config-&gt;max_requests_per_ip);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  Rate limit: %d req/sec\n&quot;</span>, config-&gt;rate_limit);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  CORS: %s\n&quot;</span>, config-&gt;enable_cors ? <span class="string">&quot;enabled&quot;</span> : <span class="string">&quot;disabled&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (config-&gt;enable_cors) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  CORS origin: %s\n&quot;</span>, config-&gt;cors_origin);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nSSL/TLS:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  SSL enabled: %s\n&quot;</span>, config-&gt;ssl.enabled ? <span class="string">&quot;yes&quot;</span> : <span class="string">&quot;no&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (config-&gt;ssl.enabled) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  Certificate file: %s\n&quot;</span>, config-&gt;ssl.cert_file);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  Key file: %s\n&quot;</span>, config-&gt;ssl.key_file);</span><br><span class="line">        <span class="keyword">if</span> (config-&gt;ssl.ca_file[<span class="number">0</span>] != <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;  CA file: %s\n&quot;</span>, config-&gt;ssl.ca_file);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  Client verification: %s\n&quot;</span>, config-&gt;ssl.verify_client ? <span class="string">&quot;enabled&quot;</span> : <span class="string">&quot;disabled&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nThread Pool:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  Min threads: %d\n&quot;</span>, config-&gt;thread_pool.min_threads);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  Max threads: %d\n&quot;</span>, config-&gt;thread_pool.max_threads);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  Queue size: %d\n&quot;</span>, config-&gt;thread_pool.queue_size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  Keep-alive time: %d seconds\n&quot;</span>, config-&gt;thread_pool.keep_alive_time);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  Shutdown timeout: %d seconds\n&quot;</span>, config-&gt;thread_pool.shutdown_timeout);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;================================\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存配置到文件</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">config_save_to_file</span><span class="params">(<span class="type">const</span> ServerConfig *config, <span class="type">const</span> <span class="type">char</span> *filename)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="literal">NULL</span> || filename == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    FILE *file = fopen(filename, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to open config file for writing: %s&quot;</span>, filename);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;# Server Configuration\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;# Generated on: %s\n\n&quot;</span>, ctime(&amp;(<span class="type">time_t</span>)&#123;time(<span class="literal">NULL</span>)&#125;));</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;# Basic configuration\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;port = %d\n&quot;</span>, config-&gt;port);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;host = %s\n&quot;</span>, config-&gt;host);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;backlog = %d\n&quot;</span>, config-&gt;backlog);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;max_connections = %d\n&quot;</span>, config-&gt;max_connections);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;timeout = %d\n&quot;</span>, config-&gt;timeout);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;\n# File service configuration\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;document_root = %s\n&quot;</span>, config-&gt;document_root);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;index_files = %s\n&quot;</span>, config-&gt;index_files);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;directory_listing = %s\n&quot;</span>, config-&gt;directory_listing ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;follow_symlinks = %s\n&quot;</span>, config-&gt;follow_symlinks ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;max_upload_size = %zu\n&quot;</span>, config-&gt;max_upload_size);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;\n# Logging configuration\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;log_file = %s\n&quot;</span>, config-&gt;log_file);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;log_level = %s\n&quot;</span>, log_level_to_string(config-&gt;log_level));</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;log_max_size = %d\n&quot;</span>, config-&gt;log_max_size);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;log_backup_count = %d\n&quot;</span>, config-&gt;log_backup_count);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;\n# Performance configuration\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;tcp_nodelay = %s\n&quot;</span>, config-&gt;tcp_nodelay ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;tcp_keepalive = %s\n&quot;</span>, config-&gt;tcp_keepalive ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;reuse_addr = %s\n&quot;</span>, config-&gt;reuse_addr ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;reuse_port = %s\n&quot;</span>, config-&gt;reuse_port ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;\n# Security configuration\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;enable_limits = %s\n&quot;</span>, config-&gt;enable_limits ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;max_requests_per_ip = %d\n&quot;</span>, config-&gt;max_requests_per_ip);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;rate_limit = %d\n&quot;</span>, config-&gt;rate_limit);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;enable_cors = %s\n&quot;</span>, config-&gt;enable_cors ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;cors_origin = %s\n&quot;</span>, config-&gt;cors_origin);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;\n# SSL/TLS configuration\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;ssl_enabled = %s\n&quot;</span>, config-&gt;ssl.enabled ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;ssl_cert_file = %s\n&quot;</span>, config-&gt;ssl.cert_file);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;ssl_key_file = %s\n&quot;</span>, config-&gt;ssl.key_file);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;ssl_ca_file = %s\n&quot;</span>, config-&gt;ssl.ca_file);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;ssl_verify_client = %s\n&quot;</span>, config-&gt;ssl.verify_client ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;ssl_protocol = %d\n&quot;</span>, config-&gt;ssl.ssl_protocol);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;\n# Thread pool configuration\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;min_threads = %d\n&quot;</span>, config-&gt;thread_pool.min_threads);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;max_threads = %d\n&quot;</span>, config-&gt;thread_pool.max_threads);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;queue_size = %d\n&quot;</span>, config-&gt;thread_pool.queue_size);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;keep_alive_time = %d\n&quot;</span>, config-&gt;thread_pool.keep_alive_time);</span><br><span class="line">    <span class="built_in">fprintf</span>(file, <span class="string">&quot;shutdown_timeout = %d\n&quot;</span>, config-&gt;thread_pool.shutdown_timeout);</span><br><span class="line">    </span><br><span class="line">    fclose(file);</span><br><span class="line">    LOG_INFO(<span class="string">&quot;Configuration saved to: %s&quot;</span>, filename);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查是否需要重载配置</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">config_should_reload</span><span class="params">(ServerConfig *config)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="literal">NULL</span> || config-&gt;config_file[<span class="number">0</span>] == <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">file_stat</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (stat(config-&gt;config_file, &amp;file_stat) != <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to stat config file: %s&quot;</span>, config-&gt;config_file);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (file_stat.st_mtime &gt; config-&gt;last_modified) &#123;</span><br><span class="line">        config-&gt;last_modified = file_stat.st_mtime;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> config-&gt;reload_flag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重载配置</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">config_reload</span><span class="params">(ServerConfig *config)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="literal">NULL</span> || config-&gt;config_file[<span class="number">0</span>] == <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_lock(&amp;config-&gt;reload_mutex);</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Reloading configuration from: %s&quot;</span>, config-&gt;config_file);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 保存旧配置</span></span><br><span class="line">    ServerConfig old_config = *config;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 重置为新配置的默认值</span></span><br><span class="line">    set_default_values(config);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 从文件加载新配置</span></span><br><span class="line">    <span class="keyword">if</span> (config_load_from_file(config, config-&gt;config_file) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 加载失败，恢复旧配置</span></span><br><span class="line">        *config = old_config;</span><br><span class="line">        pthread_mutex_unlock(&amp;config-&gt;reload_mutex);</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to reload configuration, using old config&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 验证新配置</span></span><br><span class="line">    <span class="keyword">if</span> (config_validate(config) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 验证失败，恢复旧配置</span></span><br><span class="line">        *config = old_config;</span><br><span class="line">        pthread_mutex_unlock(&amp;config-&gt;reload_mutex);</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;New configuration validation failed, using old config&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    config-&gt;reload_flag = <span class="number">0</span>;</span><br><span class="line">    pthread_mutex_unlock(&amp;config-&gt;reload_mutex);</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Configuration reloaded successfully&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取配置字符串值</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="title function_">config_get_string</span><span class="params">(<span class="type">const</span> ServerConfig *config, <span class="type">const</span> <span class="type">char</span> *key, <span class="type">const</span> <span class="type">char</span> *default_value)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="literal">NULL</span> || key == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> default_value;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这里可以根据key返回对应的字符串值</span></span><br><span class="line">    <span class="comment">// 简化实现，实际中可能需要更复杂的查找逻辑</span></span><br><span class="line">    (<span class="type">void</span>)config; <span class="comment">// 避免未使用参数警告</span></span><br><span class="line">    (<span class="type">void</span>)key;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> default_value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取配置整数值</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">config_get_int</span><span class="params">(<span class="type">const</span> ServerConfig *config, <span class="type">const</span> <span class="type">char</span> *key, <span class="type">int</span> default_value)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="literal">NULL</span> || key == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> default_value;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这里可以根据key返回对应的整数值</span></span><br><span class="line">    <span class="comment">// 简化实现</span></span><br><span class="line">    (<span class="type">void</span>)config;</span><br><span class="line">    (<span class="type">void</span>)key;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> default_value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取配置布尔值</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">config_get_bool</span><span class="params">(<span class="type">const</span> ServerConfig *config, <span class="type">const</span> <span class="type">char</span> *key, <span class="type">int</span> default_value)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="literal">NULL</span> || key == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> default_value;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这里可以根据key返回对应的布尔值</span></span><br><span class="line">    <span class="comment">// 简化实现</span></span><br><span class="line">    (<span class="type">void</span>)config;</span><br><span class="line">    (<span class="type">void</span>)key;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> default_value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放配置资源</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">config_destroy</span><span class="params">(ServerConfig *config)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (config != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        pthread_mutex_destroy(&amp;config-&gt;reload_mutex);</span><br><span class="line">        <span class="built_in">free</span>(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-2-SSL-TLS支持模块"><a href="#4-2-SSL-TLS支持模块" class="headerlink" title="4.2 SSL&#x2F;TLS支持模块"></a>4.2 SSL&#x2F;TLS支持模块</h2><h3 id="4-2-1-SSL头文件（ssl-wrapper-h）"><a href="#4-2-1-SSL头文件（ssl-wrapper-h）" class="headerlink" title="4.2.1 SSL头文件（ssl_wrapper.h）"></a>4.2.1 SSL头文件（ssl_wrapper.h）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/ssl_wrapper.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> SSL_WRAPPER_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SSL_WRAPPER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/ssl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/bio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/rand.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/config.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// SSL上下文结构体</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    SSL_CTX *ctx;               <span class="comment">// SSL上下文</span></span><br><span class="line">    <span class="type">int</span> enabled;                <span class="comment">// 是否启用SSL</span></span><br><span class="line">    <span class="type">int</span> verify_client;          <span class="comment">// 是否验证客户端</span></span><br><span class="line">    <span class="type">char</span> cert_file[<span class="number">512</span>];        <span class="comment">// 证书文件</span></span><br><span class="line">    <span class="type">char</span> key_file[<span class="number">512</span>];         <span class="comment">// 私钥文件</span></span><br><span class="line">    <span class="type">char</span> ca_file[<span class="number">512</span>];          <span class="comment">// CA证书文件</span></span><br><span class="line">&#125; SSLContext;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SSL连接结构体</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    SSL *ssl;                   <span class="comment">// SSL对象</span></span><br><span class="line">    <span class="type">int</span> socket;                 <span class="comment">// 底层socket</span></span><br><span class="line">    <span class="type">int</span> ssl_enabled;            <span class="comment">// 是否启用SSL</span></span><br><span class="line">&#125; SSLConnection;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化SSL库</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ssl_initialize</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清理SSL库</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ssl_cleanup</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建SSL上下文</span></span><br><span class="line">SSLContext* <span class="title function_">ssl_context_create</span><span class="params">(<span class="type">const</span> SSLConfig *config)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载证书和私钥</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ssl_context_load_certificates</span><span class="params">(SSLContext *context)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 销毁SSL上下文</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ssl_context_destroy</span><span class="params">(SSLContext *context)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建SSL连接</span></span><br><span class="line">SSLConnection* <span class="title function_">ssl_connection_create</span><span class="params">(SSLContext *context, <span class="type">int</span> socket)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接受SSL连接（服务器端）</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ssl_connection_accept</span><span class="params">(SSLConnection *conn)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接SSL（客户端）</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ssl_connection_connect</span><span class="params">(SSLConnection *conn)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SSL读取数据</span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">ssl_connection_read</span><span class="params">(SSLConnection *conn, <span class="type">void</span> *buffer, <span class="type">size_t</span> length)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SSL写入数据</span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">ssl_connection_write</span><span class="params">(SSLConnection *conn, <span class="type">const</span> <span class="type">void</span> *buffer, <span class="type">size_t</span> length)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭SSL连接</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ssl_connection_close</span><span class="params">(SSLConnection *conn)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取SSL错误信息</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="title function_">ssl_get_error_string</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取SSL协议版本</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="title function_">ssl_get_protocol_version</span><span class="params">(SSLConnection *conn)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取SSL密码套件</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="title function_">ssl_get_cipher</span><span class="params">(SSLConnection *conn)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证证书</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ssl_verify_certificate</span><span class="params">(SSLConnection *conn)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// SSL_WRAPPER_H</span></span></span><br></pre></td></tr></table></figure>



<h3 id="4-2-2-SSL实现（ssl-wrapper-c）"><a href="#4-2-2-SSL实现（ssl-wrapper-c）" class="headerlink" title="4.2.2 SSL实现（ssl_wrapper.c）"></a>4.2.2 SSL实现（ssl_wrapper.c）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/ssl_wrapper.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/ssl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/rand.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/bio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/x509v3.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/ssl_wrapper.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/logger.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局SSL初始化标志</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> ssl_initialized = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化SSL库</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ssl_initialize</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ssl_initialized) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化OpenSSL库</span></span><br><span class="line">    SSL_library_init();</span><br><span class="line">    SSL_load_error_strings();</span><br><span class="line">    OpenSSL_add_all_algorithms();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化随机数生成器</span></span><br><span class="line">    <span class="keyword">if</span> (RAND_poll() != <span class="number">1</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to seed OpenSSL random number generator&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ssl_initialized = <span class="number">1</span>;</span><br><span class="line">    LOG_INFO(<span class="string">&quot;SSL library initialized successfully&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清理SSL库</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ssl_cleanup</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!ssl_initialized) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清理OpenSSL</span></span><br><span class="line">    ERR_free_strings();</span><br><span class="line">    EVP_cleanup();</span><br><span class="line">    </span><br><span class="line">    ssl_initialized = <span class="number">0</span>;</span><br><span class="line">    LOG_INFO(<span class="string">&quot;SSL library cleanup completed&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建SSL上下文</span></span><br><span class="line">SSLContext* <span class="title function_">ssl_context_create</span><span class="params">(<span class="type">const</span> SSLConfig *config)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;SSL configuration is NULL&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!config-&gt;enabled) &#123;</span><br><span class="line">        LOG_INFO(<span class="string">&quot;SSL is disabled&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 确保SSL库已初始化</span></span><br><span class="line">    <span class="keyword">if</span> (ssl_initialize() != <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to initialize SSL library&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    SSLContext *context = (SSLContext*)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(SSLContext));</span><br><span class="line">    <span class="keyword">if</span> (context == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to allocate memory for SSL context&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    context-&gt;enabled = config-&gt;enabled;</span><br><span class="line">    context-&gt;verify_client = config-&gt;verify_client;</span><br><span class="line">    <span class="built_in">strncpy</span>(context-&gt;cert_file, config-&gt;cert_file, <span class="keyword">sizeof</span>(context-&gt;cert_file) - <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">strncpy</span>(context-&gt;key_file, config-&gt;key_file, <span class="keyword">sizeof</span>(context-&gt;key_file) - <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">strncpy</span>(context-&gt;ca_file, config-&gt;ca_file, <span class="keyword">sizeof</span>(context-&gt;ca_file) - <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建SSL上下文</span></span><br><span class="line">    <span class="type">const</span> SSL_METHOD *method = TLS_server_method();</span><br><span class="line">    <span class="keyword">if</span> (method == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to create SSL method&quot;</span>);</span><br><span class="line">        <span class="built_in">free</span>(context);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    context-&gt;ctx = SSL_CTX_new(method);</span><br><span class="line">    <span class="keyword">if</span> (context-&gt;ctx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to create SSL context: %s&quot;</span>, ssl_get_error_string());</span><br><span class="line">        <span class="built_in">free</span>(context);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置SSL选项</span></span><br><span class="line">    SSL_CTX_set_options(context-&gt;ctx, </span><br><span class="line">                       SSL_OP_ALL |                <span class="comment">// 启用所有已知bug的解决方法</span></span><br><span class="line">                       SSL_OP_NO_SSLv2 |          <span class="comment">// 禁用不安全的SSLv2</span></span><br><span class="line">                       SSL_OP_NO_SSLv3 |          <span class="comment">// 禁用不安全的SSLv3</span></span><br><span class="line">                       SSL_OP_NO_COMPRESSION |    <span class="comment">// 禁用压缩（防止CRIME攻击）</span></span><br><span class="line">                       SSL_OP_CIPHER_SERVER_PREFERENCE); <span class="comment">// 使用服务器偏好的密码套件顺序</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置会话缓存模式</span></span><br><span class="line">    SSL_CTX_set_session_cache_mode(context-&gt;ctx, SSL_SESS_CACHE_SERVER);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 加载证书和私钥</span></span><br><span class="line">    <span class="keyword">if</span> (ssl_context_load_certificates(context) != <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to load SSL certificates&quot;</span>);</span><br><span class="line">        ssl_context_destroy(context);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;SSL context created successfully&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载证书和私钥</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ssl_context_load_certificates</span><span class="params">(SSLContext *context)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (context == <span class="literal">NULL</span> || context-&gt;ctx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 加载服务器证书</span></span><br><span class="line">    <span class="keyword">if</span> (SSL_CTX_use_certificate_file(context-&gt;ctx, context-&gt;cert_file, SSL_FILETYPE_PEM) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to load certificate file %s: %s&quot;</span>, </span><br><span class="line">                 context-&gt;cert_file, ssl_get_error_string());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 加载私钥</span></span><br><span class="line">    <span class="keyword">if</span> (SSL_CTX_use_PrivateKey_file(context-&gt;ctx, context-&gt;key_file, SSL_FILETYPE_PEM) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to load private key file %s: %s&quot;</span>, </span><br><span class="line">                 context-&gt;key_file, ssl_get_error_string());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 验证私钥是否与证书匹配</span></span><br><span class="line">    <span class="keyword">if</span> (!SSL_CTX_check_private_key(context-&gt;ctx)) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Private key does not match certificate&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果提供了CA证书，加载它</span></span><br><span class="line">    <span class="keyword">if</span> (context-&gt;ca_file[<span class="number">0</span>] != <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (SSL_CTX_load_verify_locations(context-&gt;ctx, context-&gt;ca_file, <span class="literal">NULL</span>) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            LOG_ERROR(<span class="string">&quot;Failed to load CA certificate file %s: %s&quot;</span>, </span><br><span class="line">                     context-&gt;ca_file, ssl_get_error_string());</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置验证模式</span></span><br><span class="line">    <span class="keyword">if</span> (context-&gt;verify_client) &#123;</span><br><span class="line">        SSL_CTX_set_verify(context-&gt;ctx, SSL_VERIFY_PEER | SSL_VERIFY_FAIL_IF_NO_PEER_CERT, <span class="literal">NULL</span>);</span><br><span class="line">        SSL_CTX_set_verify_depth(context-&gt;ctx, <span class="number">4</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置客户端CA列表（可选）</span></span><br><span class="line">        STACK_OF(X509_NAME) *cert_names = SSL_load_client_CA_file(context-&gt;ca_file);</span><br><span class="line">        <span class="keyword">if</span> (cert_names != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            SSL_CTX_set_client_CA_list(context-&gt;ctx, cert_names);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        SSL_CTX_set_verify(context-&gt;ctx, SSL_VERIFY_NONE, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置密码套件</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *ciphers = <span class="string">&quot;ECDHE-ECDSA-AES256-GCM-SHA384:&quot;</span></span><br><span class="line">                         <span class="string">&quot;ECDHE-RSA-AES256-GCM-SHA384:&quot;</span></span><br><span class="line">                         <span class="string">&quot;ECDHE-ECDSA-AES128-GCM-SHA256:&quot;</span></span><br><span class="line">                         <span class="string">&quot;ECDHE-RSA-AES128-GCM-SHA256:&quot;</span></span><br><span class="line">                         <span class="string">&quot;DHE-RSA-AES256-GCM-SHA384:&quot;</span></span><br><span class="line">                         <span class="string">&quot;DHE-RSA-AES128-GCM-SHA256&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (SSL_CTX_set_cipher_list(context-&gt;ctx, ciphers) != <span class="number">1</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to set cipher list: %s&quot;</span>, ssl_get_error_string());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 启用前向保密（Forward Secrecy）</span></span><br><span class="line">    SSL_CTX_set_ecdh_auto(context-&gt;ctx, <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;SSL certificates loaded successfully&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 销毁SSL上下文</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ssl_context_destroy</span><span class="params">(SSLContext *context)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (context == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (context-&gt;ctx != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        SSL_CTX_free(context-&gt;ctx);</span><br><span class="line">        context-&gt;ctx = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">free</span>(context);</span><br><span class="line">    LOG_INFO(<span class="string">&quot;SSL context destroyed&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建SSL连接</span></span><br><span class="line">SSLConnection* <span class="title function_">ssl_connection_create</span><span class="params">(SSLContext *context, <span class="type">int</span> socket)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (context == <span class="literal">NULL</span> || socket &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    SSLConnection *conn = (SSLConnection*)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(SSLConnection));</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to allocate memory for SSL connection&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    conn-&gt;socket = socket;</span><br><span class="line">    conn-&gt;ssl_enabled = context-&gt;enabled;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!context-&gt;enabled) &#123;</span><br><span class="line">        conn-&gt;ssl = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> conn;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建SSL对象</span></span><br><span class="line">    conn-&gt;ssl = SSL_new(context-&gt;ctx);</span><br><span class="line">    <span class="keyword">if</span> (conn-&gt;ssl == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to create SSL object: %s&quot;</span>, ssl_get_error_string());</span><br><span class="line">        <span class="built_in">free</span>(conn);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将socket与SSL对象关联</span></span><br><span class="line">    <span class="keyword">if</span> (SSL_set_fd(conn-&gt;ssl, socket) != <span class="number">1</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to set socket for SSL: %s&quot;</span>, ssl_get_error_string());</span><br><span class="line">        SSL_free(conn-&gt;ssl);</span><br><span class="line">        <span class="built_in">free</span>(conn);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> conn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接受SSL连接（服务器端）</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ssl_connection_accept</span><span class="params">(SSLConnection *conn)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="literal">NULL</span> || conn-&gt;ssl == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> result = SSL_accept(conn-&gt;ssl);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (result &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> ssl_err = SSL_get_error(conn-&gt;ssl, result);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> (ssl_err) &#123;</span><br><span class="line">            <span class="keyword">case</span> SSL_ERROR_WANT_READ:</span><br><span class="line">            <span class="keyword">case</span> SSL_ERROR_WANT_WRITE:</span><br><span class="line">                <span class="comment">// 需要重试</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">case</span> SSL_ERROR_SYSCALL:</span><br><span class="line">                <span class="keyword">if</span> (ERR_peek_error() == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (result == <span class="number">0</span>) &#123;</span><br><span class="line">                        LOG_DEBUG(<span class="string">&quot;SSL connection closed by peer during handshake&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        LOG_ERROR(<span class="string">&quot;SSL syscall error: %s&quot;</span>, strerror(errno));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    LOG_ERROR(<span class="string">&quot;SSL handshake error: %s&quot;</span>, ssl_get_error_string());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                LOG_ERROR(<span class="string">&quot;SSL handshake failed: %s&quot;</span>, ssl_get_error_string());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    LOG_DEBUG(<span class="string">&quot;SSL handshake completed successfully&quot;</span>);</span><br><span class="line">    LOG_DEBUG(<span class="string">&quot;SSL protocol: %s, cipher: %s&quot;</span>, </span><br><span class="line">              ssl_get_protocol_version(conn), </span><br><span class="line">              ssl_get_cipher(conn));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接SSL（客户端）</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ssl_connection_connect</span><span class="params">(SSLConnection *conn)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="literal">NULL</span> || conn-&gt;ssl == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> result = SSL_connect(conn-&gt;ssl);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (result &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;SSL connect failed: %s&quot;</span>, ssl_get_error_string());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SSL读取数据</span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">ssl_connection_read</span><span class="params">(SSLConnection *conn, <span class="type">void</span> *buffer, <span class="type">size_t</span> length)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="literal">NULL</span> || buffer == <span class="literal">NULL</span> || length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!conn-&gt;ssl_enabled || conn-&gt;ssl == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// 非SSL模式，使用普通recv</span></span><br><span class="line">        <span class="keyword">return</span> recv(conn-&gt;socket, buffer, length, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> bytes_read = SSL_read(conn-&gt;ssl, buffer, length);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (bytes_read &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> ssl_err = SSL_get_error(conn-&gt;ssl, bytes_read);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> (ssl_err) &#123;</span><br><span class="line">            <span class="keyword">case</span> SSL_ERROR_WANT_READ:</span><br><span class="line">            <span class="keyword">case</span> SSL_ERROR_WANT_WRITE:</span><br><span class="line">                <span class="comment">// 需要重试</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">case</span> SSL_ERROR_ZERO_RETURN:</span><br><span class="line">                <span class="comment">// 连接关闭</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">case</span> SSL_ERROR_SYSCALL:</span><br><span class="line">                <span class="keyword">if</span> (ERR_peek_error() == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (bytes_read == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// EOF</span></span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        LOG_ERROR(<span class="string">&quot;SSL syscall error during read: %s&quot;</span>, strerror(errno));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    LOG_ERROR(<span class="string">&quot;SSL read error: %s&quot;</span>, ssl_get_error_string());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                LOG_ERROR(<span class="string">&quot;SSL read failed: %s&quot;</span>, ssl_get_error_string());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> bytes_read;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SSL写入数据</span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">ssl_connection_write</span><span class="params">(SSLConnection *conn, <span class="type">const</span> <span class="type">void</span> *buffer, <span class="type">size_t</span> length)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="literal">NULL</span> || buffer == <span class="literal">NULL</span> || length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!conn-&gt;ssl_enabled || conn-&gt;ssl == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// 非SSL模式，使用普通send</span></span><br><span class="line">        <span class="keyword">return</span> send(conn-&gt;socket, buffer, length, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> bytes_written = SSL_write(conn-&gt;ssl, buffer, length);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (bytes_written &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> ssl_err = SSL_get_error(conn-&gt;ssl, bytes_written);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> (ssl_err) &#123;</span><br><span class="line">            <span class="keyword">case</span> SSL_ERROR_WANT_READ:</span><br><span class="line">            <span class="keyword">case</span> SSL_ERROR_WANT_WRITE:</span><br><span class="line">                <span class="comment">// 需要重试</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">case</span> SSL_ERROR_SYSCALL:</span><br><span class="line">                <span class="keyword">if</span> (ERR_peek_error() == <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG_ERROR(<span class="string">&quot;SSL syscall error during write: %s&quot;</span>, strerror(errno));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    LOG_ERROR(<span class="string">&quot;SSL write error: %s&quot;</span>, ssl_get_error_string());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                LOG_ERROR(<span class="string">&quot;SSL write failed: %s&quot;</span>, ssl_get_error_string());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> bytes_written;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭SSL连接</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ssl_connection_close</span><span class="params">(SSLConnection *conn)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (conn-&gt;ssl != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// 发送关闭通知</span></span><br><span class="line">        SSL_shutdown(conn-&gt;ssl);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 释放SSL资源</span></span><br><span class="line">        SSL_free(conn-&gt;ssl);</span><br><span class="line">        conn-&gt;ssl = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 关闭底层socket</span></span><br><span class="line">    <span class="keyword">if</span> (conn-&gt;socket &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        close(conn-&gt;socket);</span><br><span class="line">        conn-&gt;socket = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">free</span>(conn);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取SSL错误信息</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="title function_">ssl_get_error_string</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> err_code = ERR_get_error();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (err_code == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;No SSL error&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> error_buffer[<span class="number">256</span>];</span><br><span class="line">    ERR_error_string_n(err_code, error_buffer, <span class="keyword">sizeof</span>(error_buffer));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> error_buffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取SSL协议版本</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="title function_">ssl_get_protocol_version</span><span class="params">(SSLConnection *conn)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="literal">NULL</span> || conn-&gt;ssl == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Unknown&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> SSL_get_version(conn-&gt;ssl);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取SSL密码套件</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="title function_">ssl_get_cipher</span><span class="params">(SSLConnection *conn)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="literal">NULL</span> || conn-&gt;ssl == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Unknown&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> SSL_get_cipher(conn-&gt;ssl);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证证书</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ssl_verify_certificate</span><span class="params">(SSLConnection *conn)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="literal">NULL</span> || conn-&gt;ssl == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    X509 *cert = SSL_get_peer_certificate(conn-&gt;ssl);</span><br><span class="line">    <span class="keyword">if</span> (cert == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_WARNING(<span class="string">&quot;No client certificate provided&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 验证证书</span></span><br><span class="line">    <span class="type">long</span> verify_result = SSL_get_verify_result(conn-&gt;ssl);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (verify_result != X509_V_OK) &#123;</span><br><span class="line">        LOG_WARNING(<span class="string">&quot;Certificate verification failed: %s&quot;</span>, </span><br><span class="line">                   X509_verify_cert_error_string(verify_result));</span><br><span class="line">        X509_free(cert);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取证书信息</span></span><br><span class="line">    <span class="type">char</span> subject[<span class="number">256</span>];</span><br><span class="line">    X509_NAME_oneline(X509_get_subject_name(cert), subject, <span class="keyword">sizeof</span>(subject));</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> issuer[<span class="number">256</span>];</span><br><span class="line">    X509_NAME_oneline(X509_get_issuer_name(cert), issuer, <span class="keyword">sizeof</span>(issuer));</span><br><span class="line">    </span><br><span class="line">    LOG_DEBUG(<span class="string">&quot;Client certificate verified: subject=%s, issuer=%s&quot;</span>, subject, issuer);</span><br><span class="line">    </span><br><span class="line">    X509_free(cert);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-3-更新主程序以支持配置和SSL"><a href="#4-3-更新主程序以支持配置和SSL" class="headerlink" title="4.3 更新主程序以支持配置和SSL"></a>4.3 更新主程序以支持配置和SSL</h2><h3 id="4-3-1-更新main-c（完整版）"><a href="#4-3-1-更新main-c（完整版）" class="headerlink" title="4.3.1 更新main.c（完整版）"></a>4.3.1 更新main.c（完整版）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.c（完整版）</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/logger.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/thread_pool.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/connection.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/ssl_wrapper.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/request.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/response.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">volatile</span> <span class="type">int</span> running = <span class="number">1</span>;</span><br><span class="line"><span class="type">static</span> ThreadPool *thread_pool = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">static</span> SSLContext *ssl_context = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">static</span> ServerConfig *server_config = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 信号处理函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">signal_handler</span><span class="params">(<span class="type">int</span> sig)</span> &#123;</span><br><span class="line">    LOG_INFO(<span class="string">&quot;Received signal %d, shutting down gracefully...&quot;</span>, sig);</span><br><span class="line">    running = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SIGHUP信号处理（配置重载）</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">signal_reload_handler</span><span class="params">(<span class="type">int</span> sig)</span> &#123;</span><br><span class="line">    LOG_INFO(<span class="string">&quot;Received signal %d, reloading configuration...&quot;</span>, sig);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (server_config != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        server_config-&gt;reload_flag = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化信号处理</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup_signals</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    signal(SIGINT, signal_handler);   <span class="comment">// Ctrl+C</span></span><br><span class="line">    signal(SIGTERM, signal_handler);  <span class="comment">// kill命令</span></span><br><span class="line">    signal(SIGPIPE, SIG_IGN);         <span class="comment">// 忽略SIGPIPE</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 配置重载信号</span></span><br><span class="line">    signal(SIGHUP, signal_reload_handler);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建服务器socket</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">create_server_socket</span><span class="params">(<span class="type">const</span> ServerConfig *config)</span> &#123;</span><br><span class="line">    <span class="type">int</span> server_fd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server_addr</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建socket</span></span><br><span class="line">    server_fd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (server_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to create socket: %s&quot;</span>, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置socket选项</span></span><br><span class="line">    <span class="keyword">if</span> (config-&gt;reuse_addr) &#123;</span><br><span class="line">        <span class="type">int</span> opt = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (setsockopt(server_fd, SOL_SOCKET, SO_REUSEADDR, &amp;opt, <span class="keyword">sizeof</span>(opt)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            LOG_WARNING(<span class="string">&quot;Failed to set SO_REUSEADDR: %s&quot;</span>, strerror(errno));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (config-&gt;reuse_port) &#123;</span><br><span class="line">        <span class="type">int</span> opt = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (setsockopt(server_fd, SOL_SOCKET, SO_REUSEPORT, &amp;opt, <span class="keyword">sizeof</span>(opt)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            LOG_WARNING(<span class="string">&quot;Failed to set SO_REUSEPORT: %s&quot;</span>, strerror(errno));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (config-&gt;tcp_nodelay) &#123;</span><br><span class="line">        <span class="type">int</span> opt = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (setsockopt(server_fd, IPPROTO_TCP, TCP_NODELAY, &amp;opt, <span class="keyword">sizeof</span>(opt)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            LOG_WARNING(<span class="string">&quot;Failed to set TCP_NODELAY: %s&quot;</span>, strerror(errno));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (config-&gt;tcp_keepalive) &#123;</span><br><span class="line">        <span class="type">int</span> opt = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (setsockopt(server_fd, SOL_SOCKET, SO_KEEPALIVE, &amp;opt, <span class="keyword">sizeof</span>(opt)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            LOG_WARNING(<span class="string">&quot;Failed to set SO_KEEPALIVE: %s&quot;</span>, strerror(errno));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 配置服务器地址</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;server_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(server_addr));</span><br><span class="line">    server_addr.sin_family = AF_INET;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(config-&gt;host, <span class="string">&quot;0.0.0.0&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        server_addr.sin_addr.s_addr = INADDR_ANY;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (inet_pton(AF_INET, config-&gt;host, &amp;server_addr.sin_addr) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            LOG_ERROR(<span class="string">&quot;Invalid host address: %s&quot;</span>, config-&gt;host);</span><br><span class="line">            close(server_fd);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    server_addr.sin_port = htons(config-&gt;port);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 绑定socket</span></span><br><span class="line">    <span class="keyword">if</span> (bind(server_fd, (<span class="keyword">struct</span> sockaddr *)&amp;server_addr, <span class="keyword">sizeof</span>(server_addr)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to bind socket to %s:%d: %s&quot;</span>, </span><br><span class="line">                 config-&gt;host, config-&gt;port, strerror(errno));</span><br><span class="line">        close(server_fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 监听连接</span></span><br><span class="line">    <span class="keyword">if</span> (listen(server_fd, config-&gt;backlog) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to listen on socket: %s&quot;</span>, strerror(errno));</span><br><span class="line">        close(server_fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> server_fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理目录列表请求</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handle_directory_listing</span><span class="params">(<span class="type">int</span> client_fd, <span class="type">const</span> <span class="type">char</span> *path, <span class="type">const</span> <span class="type">char</span> *request_path)</span> &#123;</span><br><span class="line">    DIR *dir = opendir(path);</span><br><span class="line">    <span class="keyword">if</span> (dir == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_500_INTERNAL_SERVER_ERROR);</span><br><span class="line">        set_response_html(resp, <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;500 Internal Server Error&lt;/h1&gt;&lt;p&gt;Failed to open directory.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line">        send_response(client_fd, resp);</span><br><span class="line">        free_http_response(resp);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 生成HTML目录列表</span></span><br><span class="line">    <span class="type">char</span> html[<span class="number">8192</span>];</span><br><span class="line">    <span class="type">char</span> *ptr = html;</span><br><span class="line">    </span><br><span class="line">    ptr += <span class="built_in">snprintf</span>(ptr, <span class="keyword">sizeof</span>(html) - (ptr - html),</span><br><span class="line">                   <span class="string">&quot;&lt;!DOCTYPE html&gt;\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;&lt;html&gt;\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;&lt;head&gt;\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;&lt;title&gt;Directory listing for %s&lt;/title&gt;\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;&lt;style&gt;\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;body &#123; font-family: Arial, sans-serif; margin: 40px; &#125;\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;h1 &#123; color: #333; &#125;\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;ul &#123; list-style-type: none; padding: 0; &#125;\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;li &#123; padding: 5px 0; &#125;\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;a &#123; text-decoration: none; color: #0366d6; &#125;\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;a:hover &#123; text-decoration: underline; &#125;\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;.file-size &#123; color: #666; font-size: 0.9em; margin-left: 10px; &#125;\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;.directory &#123; font-weight: bold; &#125;\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;&lt;/style&gt;\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;&lt;/head&gt;\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;&lt;body&gt;\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;&lt;h1&gt;Directory listing for %s&lt;/h1&gt;\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;&lt;ul&gt;\n&quot;</span>, request_path, request_path);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加上级目录链接（如果不是根目录）</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(request_path, <span class="string">&quot;/&quot;</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">char</span> parent_path[<span class="number">512</span>];</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *last_slash = <span class="built_in">strrchr</span>(request_path, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (last_slash != <span class="literal">NULL</span> &amp;&amp; last_slash != request_path) &#123;</span><br><span class="line">            <span class="built_in">strncpy</span>(parent_path, request_path, last_slash - request_path);</span><br><span class="line">            parent_path[last_slash - request_path] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">strcpy</span>(parent_path, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ptr += <span class="built_in">snprintf</span>(ptr, <span class="keyword">sizeof</span>(html) - (ptr - html),</span><br><span class="line">                       <span class="string">&quot;&lt;li&gt;&lt;a href=\&quot;%s\&quot; class=\&quot;directory\&quot;&gt;../&lt;/a&gt;&lt;/li&gt;\n&quot;</span>, parent_path);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 遍历目录项</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> *<span class="title">entry</span>;</span></span><br><span class="line">    <span class="keyword">while</span> ((entry = readdir(dir)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(entry-&gt;d_name, <span class="string">&quot;.&quot;</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(entry-&gt;d_name, <span class="string">&quot;..&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">char</span> full_path[<span class="number">1024</span>];</span><br><span class="line">        <span class="built_in">snprintf</span>(full_path, <span class="keyword">sizeof</span>(full_path), <span class="string">&quot;%s/%s&quot;</span>, path, entry-&gt;d_name);</span><br><span class="line">        </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">        <span class="keyword">if</span> (stat(full_path, &amp;st) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">char</span> encoded_name[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">char</span> *escaped_name = entry-&gt;d_name;</span><br><span class="line">        <span class="comment">// URL编码（简化版）</span></span><br><span class="line">        <span class="built_in">snprintf</span>(encoded_name, <span class="keyword">sizeof</span>(encoded_name), <span class="string">&quot;%s%s&quot;</span>, </span><br><span class="line">                request_path, entry-&gt;d_name);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (S_ISDIR(st.st_mode)) &#123;</span><br><span class="line">            ptr += <span class="built_in">snprintf</span>(ptr, <span class="keyword">sizeof</span>(html) - (ptr - html),</span><br><span class="line">                           <span class="string">&quot;&lt;li&gt;&lt;a href=\&quot;%s/\&quot; class=\&quot;directory\&quot;&gt;%s/&lt;/a&gt;&lt;/li&gt;\n&quot;</span>,</span><br><span class="line">                           encoded_name, entry-&gt;d_name);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 格式化文件大小</span></span><br><span class="line">            <span class="type">char</span> size_str[<span class="number">32</span>];</span><br><span class="line">            <span class="keyword">if</span> (st.st_size &lt; <span class="number">1024</span>) &#123;</span><br><span class="line">                <span class="built_in">snprintf</span>(size_str, <span class="keyword">sizeof</span>(size_str), <span class="string">&quot;%ld B&quot;</span>, st.st_size);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (st.st_size &lt; <span class="number">1024</span> * <span class="number">1024</span>) &#123;</span><br><span class="line">                <span class="built_in">snprintf</span>(size_str, <span class="keyword">sizeof</span>(size_str), <span class="string">&quot;%.1f KB&quot;</span>, st.st_size / <span class="number">1024.0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">snprintf</span>(size_str, <span class="keyword">sizeof</span>(size_str), <span class="string">&quot;%.1f MB&quot;</span>, st.st_size / (<span class="number">1024.0</span> * <span class="number">1024.0</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            ptr += <span class="built_in">snprintf</span>(ptr, <span class="keyword">sizeof</span>(html) - (ptr - html),</span><br><span class="line">                           <span class="string">&quot;&lt;li&gt;&lt;a href=\&quot;%s\&quot;&gt;%s&lt;/a&gt;&lt;span class=\&quot;file-size\&quot;&gt;%s&lt;/span&gt;&lt;/li&gt;\n&quot;</span>,</span><br><span class="line">                           encoded_name, entry-&gt;d_name, size_str);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    closedir(dir);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">snprintf</span>(ptr, <span class="keyword">sizeof</span>(html) - (ptr - html),</span><br><span class="line">            <span class="string">&quot;&lt;/ul&gt;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;hr&gt;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;p&gt;&lt;em&gt;Simple HTTP Server&lt;/em&gt;&lt;/p&gt;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;/body&gt;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;/html&gt;\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发送响应</span></span><br><span class="line">    HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_200_OK);</span><br><span class="line">    set_response_html(resp, html);</span><br><span class="line">    send_response(client_fd, resp);</span><br><span class="line">    free_http_response(resp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理静态文件请求</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handle_static_file</span><span class="params">(SSLConnection *ssl_conn, <span class="type">const</span> <span class="type">char</span> *path, <span class="type">const</span> <span class="type">char</span> *request_path)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (server_config == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> full_path[<span class="number">1024</span>];</span><br><span class="line">    <span class="built_in">snprintf</span>(full_path, <span class="keyword">sizeof</span>(full_path), <span class="string">&quot;%s%s&quot;</span>, </span><br><span class="line">             server_config-&gt;document_root, path);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 安全检查：防止目录遍历攻击</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(path, <span class="string">&quot;..&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_403_FORBIDDEN);</span><br><span class="line">        set_response_html(resp, <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;p&gt;Access denied.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line">        send_response(ssl_conn-&gt;socket, resp);</span><br><span class="line">        free_http_response(resp);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (stat(full_path, &amp;st) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 文件不存在，返回404</span></span><br><span class="line">        HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_404_NOT_FOUND);</span><br><span class="line">        </span><br><span class="line">        <span class="type">char</span> error_page[<span class="number">1024</span>];</span><br><span class="line">        <span class="built_in">snprintf</span>(error_page, <span class="keyword">sizeof</span>(error_page),</span><br><span class="line">                <span class="string">&quot;&lt;html&gt;&quot;</span></span><br><span class="line">                <span class="string">&quot;&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;&quot;</span></span><br><span class="line">                <span class="string">&quot;&lt;body&gt;&quot;</span></span><br><span class="line">                <span class="string">&quot;&lt;h1&gt;404 Not Found&lt;/h1&gt;&quot;</span></span><br><span class="line">                <span class="string">&quot;&lt;p&gt;The requested resource &#x27;%s&#x27; was not found on this server.&lt;/p&gt;&quot;</span></span><br><span class="line">                <span class="string">&quot;&lt;hr&gt;&quot;</span></span><br><span class="line">                <span class="string">&quot;&lt;p&gt;&lt;em&gt;Simple HTTP Server&lt;/em&gt;&lt;/p&gt;&quot;</span></span><br><span class="line">                <span class="string">&quot;&lt;/body&gt;&quot;</span></span><br><span class="line">                <span class="string">&quot;&lt;/html&gt;&quot;</span>,</span><br><span class="line">                path);</span><br><span class="line">        </span><br><span class="line">        set_response_html(resp, error_page);</span><br><span class="line">        send_response(ssl_conn-&gt;socket, resp);</span><br><span class="line">        free_http_response(resp);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果是目录，检查是否启用目录列表</span></span><br><span class="line">    <span class="keyword">if</span> (S_ISDIR(st.st_mode)) &#123;</span><br><span class="line">        <span class="comment">// 检查是否有默认索引文件</span></span><br><span class="line">        <span class="type">char</span> *index_files = server_config-&gt;index_files;</span><br><span class="line">        <span class="type">char</span> *token = strtok(index_files, <span class="string">&quot;,&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (token != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="type">char</span> index_path[<span class="number">1024</span>];</span><br><span class="line">            <span class="built_in">snprintf</span>(index_path, <span class="keyword">sizeof</span>(index_path), <span class="string">&quot;%s/%s&quot;</span>, full_path, token);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (stat(index_path, &amp;st) == <span class="number">0</span> &amp;&amp; S_ISREG(st.st_mode)) &#123;</span><br><span class="line">                <span class="comment">// 找到索引文件，重定向</span></span><br><span class="line">                <span class="type">char</span> redirect_path[<span class="number">2048</span>];</span><br><span class="line">                <span class="built_in">snprintf</span>(redirect_path, <span class="keyword">sizeof</span>(redirect_path), <span class="string">&quot;%s/%s&quot;</span>, path, token);</span><br><span class="line">                </span><br><span class="line">                HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_301_MOVED_PERMANENTLY);</span><br><span class="line">                add_response_header(resp, <span class="string">&quot;Location&quot;</span>, redirect_path);</span><br><span class="line">                set_response_html(resp, <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;301 Moved Permanently&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line">                send_response(ssl_conn-&gt;socket, resp);</span><br><span class="line">                free_http_response(resp);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            token = strtok(<span class="literal">NULL</span>, <span class="string">&quot;,&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 没有找到索引文件，检查是否启用目录列表</span></span><br><span class="line">        <span class="keyword">if</span> (server_config-&gt;directory_listing) &#123;</span><br><span class="line">            handle_directory_listing(ssl_conn-&gt;socket, full_path, path);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 目录列表禁用，返回403</span></span><br><span class="line">            HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_403_FORBIDDEN);</span><br><span class="line">            set_response_html(resp, <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;p&gt;Directory listing is disabled.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line">            send_response(ssl_conn-&gt;socket, resp);</span><br><span class="line">            free_http_response(resp);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 是普通文件，尝试打开</span></span><br><span class="line">    FILE *file = fopen(full_path, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_500_INTERNAL_SERVER_ERROR);</span><br><span class="line">        set_response_html(resp, <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;500 Internal Server Error&lt;/h1&gt;&lt;p&gt;Failed to open file.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line">        send_response(ssl_conn-&gt;socket, resp);</span><br><span class="line">        free_http_response(resp);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取文件大小</span></span><br><span class="line">    fseek(file, <span class="number">0</span>, SEEK_END);</span><br><span class="line">    <span class="type">long</span> file_size = ftell(file);</span><br><span class="line">    fseek(file, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查文件大小是否超过限制</span></span><br><span class="line">    <span class="keyword">if</span> (file_size &gt; server_config-&gt;max_upload_size) &#123;</span><br><span class="line">        fclose(file);</span><br><span class="line">        HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_413_REQUEST_ENTITY_TOO_LARGE);</span><br><span class="line">        set_response_html(resp, <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;413 Request Entity Too Large&lt;/h1&gt;&lt;p&gt;File size exceeds limit.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line">        send_response(ssl_conn-&gt;socket, resp);</span><br><span class="line">        free_http_response(resp);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 读取文件内容</span></span><br><span class="line">    <span class="type">char</span> *file_content = (<span class="type">char</span>*)<span class="built_in">malloc</span>(file_size);</span><br><span class="line">    <span class="keyword">if</span> (file_content == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        fclose(file);</span><br><span class="line">        HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_500_INTERNAL_SERVER_ERROR);</span><br><span class="line">        set_response_html(resp, <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;500 Internal Server Error&lt;/h1&gt;&lt;p&gt;Memory allocation failed.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line">        send_response(ssl_conn-&gt;socket, resp);</span><br><span class="line">        free_http_response(resp);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">size_t</span> bytes_read = fread(file_content, <span class="number">1</span>, file_size, file);</span><br><span class="line">    fclose(file);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (bytes_read != (<span class="type">size_t</span>)file_size) &#123;</span><br><span class="line">        <span class="built_in">free</span>(file_content);</span><br><span class="line">        HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_500_INTERNAL_SERVER_ERROR);</span><br><span class="line">        set_response_html(resp, <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;500 Internal Server Error&lt;/h1&gt;&lt;p&gt;Failed to read file.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line">        send_response(ssl_conn-&gt;socket, resp);</span><br><span class="line">        free_http_response(resp);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据文件扩展名确定Content-Type</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *content_type = <span class="string">&quot;application/octet-stream&quot;</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *ext = <span class="built_in">strrchr</span>(full_path, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (ext != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ext, <span class="string">&quot;.html&quot;</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(ext, <span class="string">&quot;.htm&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            content_type = <span class="string">&quot;text/html&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ext, <span class="string">&quot;.css&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            content_type = <span class="string">&quot;text/css&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ext, <span class="string">&quot;.js&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            content_type = <span class="string">&quot;application/javascript&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ext, <span class="string">&quot;.json&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            content_type = <span class="string">&quot;application/json&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ext, <span class="string">&quot;.png&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            content_type = <span class="string">&quot;image/png&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ext, <span class="string">&quot;.jpg&quot;</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(ext, <span class="string">&quot;.jpeg&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            content_type = <span class="string">&quot;image/jpeg&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ext, <span class="string">&quot;.gif&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            content_type = <span class="string">&quot;image/gif&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ext, <span class="string">&quot;.txt&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            content_type = <span class="string">&quot;text/plain&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ext, <span class="string">&quot;.pdf&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            content_type = <span class="string">&quot;application/pdf&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建响应</span></span><br><span class="line">    HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_200_OK);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加CORS头部（如果启用）</span></span><br><span class="line">    <span class="keyword">if</span> (server_config-&gt;enable_cors) &#123;</span><br><span class="line">        add_response_header(resp, <span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, server_config-&gt;cors_origin);</span><br><span class="line">        add_response_header(resp, <span class="string">&quot;Access-Control-Allow-Methods&quot;</span>, <span class="string">&quot;GET, POST, OPTIONS&quot;</span>);</span><br><span class="line">        add_response_header(resp, <span class="string">&quot;Access-Control-Allow-Headers&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置缓存控制</span></span><br><span class="line">    add_response_header(resp, <span class="string">&quot;Cache-Control&quot;</span>, <span class="string">&quot;public, max-age=3600&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置响应体</span></span><br><span class="line">    set_response_body(resp, file_content, file_size, <span class="number">1</span>); <span class="comment">// 最后一个参数1表示需要释放内存</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置Content-Type</span></span><br><span class="line">    <span class="type">char</span> content_type_header[<span class="number">256</span>];</span><br><span class="line">    <span class="built_in">snprintf</span>(content_type_header, <span class="keyword">sizeof</span>(content_type_header), <span class="string">&quot;%s; charset=utf-8&quot;</span>, content_type);</span><br><span class="line">    add_response_header(resp, <span class="string">&quot;Content-Type&quot;</span>, content_type_header);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发送响应</span></span><br><span class="line">    send_response(ssl_conn-&gt;socket, resp);</span><br><span class="line">    free_http_response(resp);</span><br><span class="line">    </span><br><span class="line">    LOG_DEBUG(<span class="string">&quot;Served static file: %s (%ld bytes)&quot;</span>, full_path, file_size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理管理端点</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handle_admin_endpoint</span><span class="params">(SSLConnection *ssl_conn, <span class="type">const</span> <span class="type">char</span> *path)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(path, <span class="string">&quot;/admin/stats&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 获取统计信息</span></span><br><span class="line">        <span class="type">int</span> active_threads, idle_threads, queue_size;</span><br><span class="line">        <span class="type">long</span> total_tasks, completed_tasks;</span><br><span class="line">        <span class="type">double</span> uptime;</span><br><span class="line">        </span><br><span class="line">        thread_pool_get_stats(thread_pool, </span><br><span class="line">                             &amp;active_threads, &amp;idle_threads, &amp;queue_size,</span><br><span class="line">                             &amp;total_tasks, &amp;completed_tasks, &amp;uptime);</span><br><span class="line">        </span><br><span class="line">        <span class="type">char</span> json[<span class="number">2048</span>];</span><br><span class="line">        <span class="built_in">snprintf</span>(json, <span class="keyword">sizeof</span>(json),</span><br><span class="line">                <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                <span class="string">&quot;  \&quot;server\&quot;: &#123;\n&quot;</span></span><br><span class="line">                <span class="string">&quot;    \&quot;status\&quot;: \&quot;running\&quot;,\n&quot;</span></span><br><span class="line">                <span class="string">&quot;    \&quot;uptime\&quot;: %.2f,\n&quot;</span></span><br><span class="line">                <span class="string">&quot;    \&quot;ssl_enabled\&quot;: %s\n&quot;</span></span><br><span class="line">                <span class="string">&quot;  &#125;,\n&quot;</span></span><br><span class="line">                <span class="string">&quot;  \&quot;thread_pool\&quot;: &#123;\n&quot;</span></span><br><span class="line">                <span class="string">&quot;    \&quot;active_threads\&quot;: %d,\n&quot;</span></span><br><span class="line">                <span class="string">&quot;    \&quot;idle_threads\&quot;: %d,\n&quot;</span></span><br><span class="line">                <span class="string">&quot;    \&quot;queue_size\&quot;: %d,\n&quot;</span></span><br><span class="line">                <span class="string">&quot;    \&quot;total_tasks\&quot;: %ld,\n&quot;</span></span><br><span class="line">                <span class="string">&quot;    \&quot;completed_tasks\&quot;: %ld\n&quot;</span></span><br><span class="line">                <span class="string">&quot;  &#125;,\n&quot;</span></span><br><span class="line">                <span class="string">&quot;  \&quot;ssl\&quot;: &#123;\n&quot;</span></span><br><span class="line">                <span class="string">&quot;    \&quot;enabled\&quot;: %s,\n&quot;</span></span><br><span class="line">                <span class="string">&quot;    \&quot;protocol\&quot;: \&quot;%s\&quot;,\n&quot;</span></span><br><span class="line">                <span class="string">&quot;    \&quot;cipher\&quot;: \&quot;%s\&quot;\n&quot;</span></span><br><span class="line">                <span class="string">&quot;  &#125;\n&quot;</span></span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>,</span><br><span class="line">                uptime,</span><br><span class="line">                ssl_context &amp;&amp; ssl_context-&gt;enabled ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>,</span><br><span class="line">                active_threads, idle_threads, queue_size,</span><br><span class="line">                total_tasks, completed_tasks,</span><br><span class="line">                ssl_conn-&gt;ssl_enabled ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>,</span><br><span class="line">                ssl_conn-&gt;ssl_enabled ? ssl_get_protocol_version(ssl_conn) : <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">                ssl_conn-&gt;ssl_enabled ? ssl_get_cipher(ssl_conn) : <span class="string">&quot;N/A&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_200_OK);</span><br><span class="line">        set_response_json(resp, json);</span><br><span class="line">        send_response(ssl_conn-&gt;socket, resp);</span><br><span class="line">        free_http_response(resp);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(path, <span class="string">&quot;/admin/config&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 返回当前配置</span></span><br><span class="line">        <span class="type">char</span> json[<span class="number">4096</span>];</span><br><span class="line">        <span class="built_in">snprintf</span>(json, <span class="keyword">sizeof</span>(json),</span><br><span class="line">                <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                <span class="string">&quot;  \&quot;config\&quot;: &#123;\n&quot;</span></span><br><span class="line">                <span class="string">&quot;    \&quot;port\&quot;: %d,\n&quot;</span></span><br><span class="line">                <span class="string">&quot;    \&quot;host\&quot;: \&quot;%s\&quot;,\n&quot;</span></span><br><span class="line">                <span class="string">&quot;    \&quot;document_root\&quot;: \&quot;%s\&quot;,\n&quot;</span></span><br><span class="line">                <span class="string">&quot;    \&quot;ssl_enabled\&quot;: %s\n&quot;</span></span><br><span class="line">                <span class="string">&quot;  &#125;\n&quot;</span></span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>,</span><br><span class="line">                server_config-&gt;port,</span><br><span class="line">                server_config-&gt;host,</span><br><span class="line">                server_config-&gt;document_root,</span><br><span class="line">                server_config-&gt;ssl.enabled ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_200_OK);</span><br><span class="line">        set_response_json(resp, json);</span><br><span class="line">        send_response(ssl_conn-&gt;socket, resp);</span><br><span class="line">        free_http_response(resp);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(path, <span class="string">&quot;/admin/reload&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 重载配置</span></span><br><span class="line">        <span class="keyword">if</span> (config_reload(server_config) == <span class="number">0</span>) &#123;</span><br><span class="line">            HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_200_OK);</span><br><span class="line">            set_response_json(resp, <span class="string">&quot;&#123;\&quot;status\&quot;: \&quot;success\&quot;, \&quot;message\&quot;: \&quot;Configuration reloaded\&quot;&#125;&quot;</span>);</span><br><span class="line">            send_response(ssl_conn-&gt;socket, resp);</span><br><span class="line">            free_http_response(resp);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_500_INTERNAL_SERVER_ERROR);</span><br><span class="line">            set_response_json(resp, <span class="string">&quot;&#123;\&quot;status\&quot;: \&quot;error\&quot;, \&quot;message\&quot;: \&quot;Failed to reload configuration\&quot;&#125;&quot;</span>);</span><br><span class="line">            send_response(ssl_conn-&gt;socket, resp);</span><br><span class="line">            free_http_response(resp);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 未知管理端点</span></span><br><span class="line">        HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_404_NOT_FOUND);</span><br><span class="line">        set_response_json(resp, <span class="string">&quot;&#123;\&quot;status\&quot;: \&quot;error\&quot;, \&quot;message\&quot;: \&quot;Admin endpoint not found\&quot;&#125;&quot;</span>);</span><br><span class="line">        send_response(ssl_conn-&gt;socket, resp);</span><br><span class="line">        free_http_response(resp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理HTTP请求</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handle_http_request</span><span class="params">(SSLConnection *ssl_conn, <span class="type">const</span> <span class="type">char</span> *request_data, <span class="type">size_t</span> request_length,</span></span><br><span class="line"><span class="params">                        <span class="type">const</span> <span class="type">char</span> *client_ip, <span class="type">int</span> client_port)</span> &#123;</span><br><span class="line">    <span class="comment">// 解析HTTP请求</span></span><br><span class="line">    HttpRequest *req = parse_http_request(request_data, request_length);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (req == <span class="literal">NULL</span> || !req-&gt;is_valid) &#123;</span><br><span class="line">        LOG_WARNING(<span class="string">&quot;Invalid HTTP request from %s:%d&quot;</span>, client_ip, client_port);</span><br><span class="line">        </span><br><span class="line">        HttpResponse *error_resp = create_http_response(HTTP_1_1, HTTP_400_BAD_REQUEST);</span><br><span class="line">        <span class="keyword">if</span> (error_resp != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            set_response_html(error_resp, </span><br><span class="line">                <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;400 Bad Request&lt;/h1&gt;&lt;p&gt;Invalid HTTP request.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line">            send_response(ssl_conn-&gt;socket, error_resp);</span><br><span class="line">            free_http_response(error_resp);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (req != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            free_http_request(req);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 记录请求信息</span></span><br><span class="line">    LOG_INFO(<span class="string">&quot;Request: %s %s from %s:%d&quot;</span>, </span><br><span class="line">             http_method_to_string(req-&gt;method),</span><br><span class="line">             req-&gt;path,</span><br><span class="line">             client_ip, client_port);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据请求路径处理</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strncmp</span>(req-&gt;path, <span class="string">&quot;/admin/&quot;</span>, <span class="number">7</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 管理端点</span></span><br><span class="line">        handle_admin_endpoint(ssl_conn, req-&gt;path);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(req-&gt;path, <span class="string">&quot;/api/status&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// API状态端点</span></span><br><span class="line">        <span class="type">char</span> status_json[<span class="number">512</span>];</span><br><span class="line">        <span class="built_in">snprintf</span>(status_json, <span class="keyword">sizeof</span>(status_json),</span><br><span class="line">                <span class="string">&quot;&#123;\&quot;status\&quot;: \&quot;running\&quot;, &quot;</span></span><br><span class="line">                <span class="string">&quot;\&quot;server\&quot;: \&quot;Advanced-C-HTTP-Server\&quot;, &quot;</span></span><br><span class="line">                <span class="string">&quot;\&quot;version\&quot;: \&quot;4.0\&quot;, &quot;</span></span><br><span class="line">                <span class="string">&quot;\&quot;timestamp\&quot;: %ld, &quot;</span></span><br><span class="line">                <span class="string">&quot;\&quot;features\&quot;: [\&quot;config\&quot;, \&quot;ssl\&quot;, \&quot;threadpool\&quot;]&#125;&quot;</span>,</span><br><span class="line">                time(<span class="literal">NULL</span>));</span><br><span class="line">        </span><br><span class="line">        HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_200_OK);</span><br><span class="line">        set_response_json(resp, status_json);</span><br><span class="line">        send_response(ssl_conn-&gt;socket, resp);</span><br><span class="line">        free_http_response(resp);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(req-&gt;path, <span class="string">&quot;/api/echo&quot;</span>) == <span class="number">0</span> &amp;&amp; req-&gt;method == HTTP_POST) &#123;</span><br><span class="line">        <span class="comment">// Echo端点</span></span><br><span class="line">        <span class="type">char</span> echo_response[<span class="number">1024</span>];</span><br><span class="line">        <span class="built_in">snprintf</span>(echo_response, <span class="keyword">sizeof</span>(echo_response),</span><br><span class="line">                <span class="string">&quot;&#123;\&quot;method\&quot;: \&quot;POST\&quot;, &quot;</span></span><br><span class="line">                <span class="string">&quot;\&quot;received\&quot;: %s, &quot;</span></span><br><span class="line">                <span class="string">&quot;\&quot;timestamp\&quot;: %ld, &quot;</span></span><br><span class="line">                <span class="string">&quot;\&quot;client\&quot;: \&quot;%s:%d\&quot;&#125;&quot;</span>,</span><br><span class="line">                req-&gt;body ? req-&gt;body : <span class="string">&quot;null&quot;</span>,</span><br><span class="line">                time(<span class="literal">NULL</span>),</span><br><span class="line">                client_ip, client_port);</span><br><span class="line">        </span><br><span class="line">        HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_200_OK);</span><br><span class="line">        set_response_json(resp, echo_response);</span><br><span class="line">        send_response(ssl_conn-&gt;socket, resp);</span><br><span class="line">        free_http_response(resp);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (req-&gt;method == HTTP_GET || req-&gt;method == HTTP_HEAD) &#123;</span><br><span class="line">        <span class="comment">// 静态文件服务</span></span><br><span class="line">        handle_static_file(ssl_conn, req-&gt;path, req-&gt;path);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果是HEAD请求，移除响应体（已经在handle_static_file中处理了）</span></span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (req-&gt;method == HTTP_OPTIONS) &#123;</span><br><span class="line">        <span class="comment">// 处理OPTIONS请求</span></span><br><span class="line">        HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_204_NO_CONTENT);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 添加CORS头部（如果启用）</span></span><br><span class="line">        <span class="keyword">if</span> (server_config &amp;&amp; server_config-&gt;enable_cors) &#123;</span><br><span class="line">            add_response_header(resp, <span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, server_config-&gt;cors_origin);</span><br><span class="line">            add_response_header(resp, <span class="string">&quot;Access-Control-Allow-Methods&quot;</span>, <span class="string">&quot;GET, POST, OPTIONS, HEAD&quot;</span>);</span><br><span class="line">            add_response_header(resp, <span class="string">&quot;Access-Control-Allow-Headers&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>);</span><br><span class="line">            add_response_header(resp, <span class="string">&quot;Access-Control-Max-Age&quot;</span>, <span class="string">&quot;86400&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        add_response_header(resp, <span class="string">&quot;Allow&quot;</span>, <span class="string">&quot;GET, POST, HEAD, OPTIONS&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        send_response(ssl_conn-&gt;socket, resp);</span><br><span class="line">        free_http_response(resp);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 不支持的方法</span></span><br><span class="line">        HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_405_METHOD_NOT_ALLOWED);</span><br><span class="line">        add_response_header(resp, <span class="string">&quot;Allow&quot;</span>, <span class="string">&quot;GET, POST, HEAD, OPTIONS&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">char</span> error_page[<span class="number">512</span>];</span><br><span class="line">        <span class="built_in">snprintf</span>(error_page, <span class="keyword">sizeof</span>(error_page),</span><br><span class="line">                <span class="string">&quot;&lt;html&gt;&quot;</span></span><br><span class="line">                <span class="string">&quot;&lt;head&gt;&lt;title&gt;405 Method Not Allowed&lt;/title&gt;&lt;/head&gt;&quot;</span></span><br><span class="line">                <span class="string">&quot;&lt;body&gt;&quot;</span></span><br><span class="line">                <span class="string">&quot;&lt;h1&gt;405 Method Not Allowed&lt;/h1&gt;&quot;</span></span><br><span class="line">                <span class="string">&quot;&lt;p&gt;The method %s is not allowed for the requested resource.&lt;/p&gt;&quot;</span></span><br><span class="line">                <span class="string">&quot;&lt;hr&gt;&quot;</span></span><br><span class="line">                <span class="string">&quot;&lt;p&gt;&lt;em&gt;Advanced-C-HTTP-Server/4.0&lt;/em&gt;&lt;/p&gt;&quot;</span></span><br><span class="line">                <span class="string">&quot;&lt;/body&gt;&quot;</span></span><br><span class="line">                <span class="string">&quot;&lt;/html&gt;&quot;</span>,</span><br><span class="line">                http_method_to_string(req-&gt;method));</span><br><span class="line">        </span><br><span class="line">        set_response_html(resp, error_page);</span><br><span class="line">        send_response(ssl_conn-&gt;socket, resp);</span><br><span class="line">        free_http_response(resp);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放请求</span></span><br><span class="line">    free_http_request(req);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理客户端连接（线程池任务函数）</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handle_client_task</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">    ConnectionContext *context = (ConnectionContext*)arg;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (context == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Connection context is NULL&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> client_socket = context-&gt;client_socket;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client_addr</span> =</span> context-&gt;client_addr;</span><br><span class="line">    </span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *client_ip = get_client_ip(&amp;client_addr);</span><br><span class="line">    <span class="type">int</span> client_port = get_client_port(&amp;client_addr);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建SSL连接</span></span><br><span class="line">    SSLConnection *ssl_conn = ssl_connection_create(ssl_context, client_socket);</span><br><span class="line">    <span class="keyword">if</span> (ssl_conn == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to create SSL connection for %s:%d&quot;</span>, client_ip, client_port);</span><br><span class="line">        close(client_socket);</span><br><span class="line">        free_connection_context(context);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果是SSL连接，执行握手</span></span><br><span class="line">    <span class="keyword">if</span> (ssl_conn-&gt;ssl_enabled &amp;&amp; ssl_conn-&gt;ssl != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_DEBUG(<span class="string">&quot;Performing SSL handshake with %s:%d&quot;</span>, client_ip, client_port);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (ssl_connection_accept(ssl_conn) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            LOG_ERROR(<span class="string">&quot;SSL handshake failed for %s:%d&quot;</span>, client_ip, client_port);</span><br><span class="line">            ssl_connection_close(ssl_conn);</span><br><span class="line">            free_connection_context(context);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        LOG_INFO(<span class="string">&quot;SSL connection established with %s:%d (protocol: %s, cipher: %s)&quot;</span>,</span><br><span class="line">                client_ip, client_port,</span><br><span class="line">                ssl_get_protocol_version(ssl_conn),</span><br><span class="line">                ssl_get_cipher(ssl_conn));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 读取HTTP请求</span></span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">8192</span>];</span><br><span class="line">    <span class="type">ssize_t</span> total_bytes = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置接收超时</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">timeout</span>;</span></span><br><span class="line">    timeout.tv_sec = server_config ? server_config-&gt;timeout : <span class="number">30</span>;</span><br><span class="line">    timeout.tv_usec = <span class="number">0</span>;</span><br><span class="line">    setsockopt(client_socket, SOL_SOCKET, SO_RCVTIMEO, &amp;timeout, <span class="keyword">sizeof</span>(timeout));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 读取数据直到收到完整请求或超时</span></span><br><span class="line">    <span class="keyword">while</span> (total_bytes &lt; (<span class="type">ssize_t</span>)<span class="keyword">sizeof</span>(buffer) - <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="type">ssize_t</span> bytes_read = ssl_connection_read(ssl_conn, </span><br><span class="line">                                                buffer + total_bytes, </span><br><span class="line">                                                <span class="keyword">sizeof</span>(buffer) - total_bytes - <span class="number">1</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (bytes_read &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            total_bytes += bytes_read;</span><br><span class="line">            buffer[total_bytes] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 检查是否收到了完整的HTTP请求</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strstr</span>(buffer, <span class="string">&quot;\r\n\r\n&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="comment">// 简单检查是否完整</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bytes_read == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 连接关闭</span></span><br><span class="line">            LOG_DEBUG(<span class="string">&quot;Client %s:%d closed connection&quot;</span>, client_ip, client_port);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 读取错误</span></span><br><span class="line">            LOG_ERROR(<span class="string">&quot;Failed to read from %s:%d: %s&quot;</span>, </span><br><span class="line">                     client_ip, client_port, </span><br><span class="line">                     ssl_conn-&gt;ssl_enabled ? ssl_get_error_string() : strerror(errno));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (total_bytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 处理HTTP请求</span></span><br><span class="line">        handle_http_request(ssl_conn, buffer, total_bytes, client_ip, client_port);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 关闭连接</span></span><br><span class="line">    ssl_connection_close(ssl_conn);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放上下文</span></span><br><span class="line">    free_connection_context(context);</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Connection from %s:%d processed&quot;</span>, client_ip, client_port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主服务器循环</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">run_server_loop</span><span class="params">(<span class="type">int</span> server_fd)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client_addr</span>;</span></span><br><span class="line">    <span class="type">socklen_t</span> client_len = <span class="keyword">sizeof</span>(client_addr);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">last_config_check</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Server is listening on %s:%d%s&quot;</span>, </span><br><span class="line">             server_config-&gt;host, server_config-&gt;port,</span><br><span class="line">             server_config-&gt;ssl.enabled ? <span class="string">&quot; (SSL)&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (server_config-&gt;ssl.enabled) &#123;</span><br><span class="line">        LOG_INFO(<span class="string">&quot;SSL enabled: cert=%s, key=%s&quot;</span>, </span><br><span class="line">                 server_config-&gt;ssl.cert_file,</span><br><span class="line">                 server_config-&gt;ssl.key_file);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Document root: %s&quot;</span>, server_config-&gt;document_root);</span><br><span class="line">    LOG_INFO(<span class="string">&quot;Thread pool: %d-%d threads, queue: %d&quot;</span>, </span><br><span class="line">             server_config-&gt;thread_pool.min_threads,</span><br><span class="line">             server_config-&gt;thread_pool.max_threads,</span><br><span class="line">             server_config-&gt;thread_pool.queue_size);</span><br><span class="line">    LOG_INFO(<span class="string">&quot;Press Ctrl+C to stop the server&quot;</span>);</span><br><span class="line">    LOG_INFO(<span class="string">&quot;Send SIGHUP to reload configuration&quot;</span>);</span><br><span class="line">    LOG_INFO(<span class="string">&quot;==========================================&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置socket为非阻塞，用于accept</span></span><br><span class="line">    set_socket_nonblocking(server_fd);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (running) &#123;</span><br><span class="line">        <span class="comment">// 检查是否需要重载配置</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">now</span>;</span></span><br><span class="line">        gettimeofday(&amp;now, <span class="literal">NULL</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (now.tv_sec - last_config_check.tv_sec &gt;= <span class="number">5</span>) &#123; <span class="comment">// 每5秒检查一次</span></span><br><span class="line">            last_config_check = now;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (config_should_reload(server_config)) &#123;</span><br><span class="line">                LOG_INFO(<span class="string">&quot;Configuration file changed, reloading...&quot;</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 创建新配置</span></span><br><span class="line">                ServerConfig *new_config = config_create_default();</span><br><span class="line">                <span class="keyword">if</span> (new_config != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (config_load_from_file(new_config, server_config-&gt;config_file) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                        config_validate(new_config) == <span class="number">0</span>) &#123;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// 验证成功，应用新配置</span></span><br><span class="line">                        LOG_INFO(<span class="string">&quot;New configuration applied&quot;</span>);</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// 注意：这里我们只更新部分可以热重载的配置</span></span><br><span class="line">                        <span class="comment">// 对于线程池配置等，需要更复杂的处理</span></span><br><span class="line">                        </span><br><span class="line">                        config_destroy(server_config);</span><br><span class="line">                        server_config = new_config;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        LOG_ERROR(<span class="string">&quot;New configuration validation failed, keeping old config&quot;</span>);</span><br><span class="line">                        config_destroy(new_config);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 接受客户端连接</span></span><br><span class="line">        <span class="type">int</span> client_socket = accept(server_fd, (<span class="keyword">struct</span> sockaddr *)&amp;client_addr, &amp;client_len);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (client_socket &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (errno == EAGAIN || errno == EWOULDBLOCK) &#123;</span><br><span class="line">                <span class="comment">// 没有新连接，继续循环</span></span><br><span class="line">                usleep(<span class="number">10000</span>);  <span class="comment">// 10ms</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (running) &#123;</span><br><span class="line">                LOG_ERROR(<span class="string">&quot;Failed to accept connection: %s&quot;</span>, strerror(errno));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置socket选项</span></span><br><span class="line">        <span class="keyword">if</span> (server_config-&gt;tcp_nodelay) &#123;</span><br><span class="line">            <span class="type">int</span> opt = <span class="number">1</span>;</span><br><span class="line">            setsockopt(client_socket, IPPROTO_TCP, TCP_NODELAY, &amp;opt, <span class="keyword">sizeof</span>(opt));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建连接上下文</span></span><br><span class="line">        ConnectionContext *context = create_connection_context(client_socket, </span><br><span class="line">                                                              &amp;client_addr, </span><br><span class="line">                                                              thread_pool);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (context == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            LOG_ERROR(<span class="string">&quot;Failed to create connection context&quot;</span>);</span><br><span class="line">            close(client_socket);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 添加任务到线程池</span></span><br><span class="line">        <span class="keyword">if</span> (thread_pool_add_task(thread_pool, handle_client_task, context) != <span class="number">0</span>) &#123;</span><br><span class="line">            LOG_ERROR(<span class="string">&quot;Failed to add task to thread pool&quot;</span>);</span><br><span class="line">            free_connection_context(context);</span><br><span class="line">            close(client_socket);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主函数</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">int</span> server_fd;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建默认配置</span></span><br><span class="line">    server_config = config_create_default();</span><br><span class="line">    <span class="keyword">if</span> (server_config == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Failed to create server configuration\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 从命令行参数加载配置</span></span><br><span class="line">    <span class="type">int</span> help_requested = config_load_from_args(server_config, argc, argv);</span><br><span class="line">    <span class="keyword">if</span> (help_requested == <span class="number">1</span>) &#123;</span><br><span class="line">        config_destroy(server_config);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;  <span class="comment">// 显示帮助信息后退出</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (help_requested &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        config_destroy(server_config);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 验证配置</span></span><br><span class="line">    <span class="keyword">if</span> (config_validate(server_config) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Configuration validation failed\n&quot;</span>);</span><br><span class="line">        config_print(server_config);</span><br><span class="line">        config_destroy(server_config);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化日志系统</span></span><br><span class="line">    logger_init(server_config-&gt;log_file, </span><br><span class="line">               (LogLevel)server_config-&gt;log_level);  <span class="comment">// 注意类型转换</span></span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Starting Advanced HTTP Server v4.0&quot;</span>);</span><br><span class="line">    config_print(server_config);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置信号处理</span></span><br><span class="line">    setup_signals();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化SSL（如果需要）</span></span><br><span class="line">    <span class="keyword">if</span> (server_config-&gt;ssl.enabled) &#123;</span><br><span class="line">        ssl_context = ssl_context_create(&amp;server_config-&gt;ssl);</span><br><span class="line">        <span class="keyword">if</span> (ssl_context == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            LOG_ERROR(<span class="string">&quot;Failed to create SSL context&quot;</span>);</span><br><span class="line">            logger_cleanup();</span><br><span class="line">            config_destroy(server_config);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建线程池</span></span><br><span class="line">    thread_pool = thread_pool_create(</span><br><span class="line">        server_config-&gt;thread_pool.min_threads,</span><br><span class="line">        server_config-&gt;thread_pool.max_threads,</span><br><span class="line">        server_config-&gt;thread_pool.queue_size</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (thread_pool == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to create thread pool&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (ssl_context != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ssl_context_destroy(ssl_context);</span><br><span class="line">        &#125;</span><br><span class="line">        logger_cleanup();</span><br><span class="line">        config_destroy(server_config);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建服务器socket</span></span><br><span class="line">    server_fd = create_server_socket(server_config);</span><br><span class="line">    <span class="keyword">if</span> (server_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to create server socket&quot;</span>);</span><br><span class="line">        thread_pool_destroy(thread_pool, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (ssl_context != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ssl_context_destroy(ssl_context);</span><br><span class="line">        &#125;</span><br><span class="line">        logger_cleanup();</span><br><span class="line">        config_destroy(server_config);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 运行主服务器循环</span></span><br><span class="line">    run_server_loop(server_fd);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清理资源</span></span><br><span class="line">    LOG_INFO(<span class="string">&quot;Shutting down server...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 关闭服务器socket</span></span><br><span class="line">    close(server_fd);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 等待所有任务完成</span></span><br><span class="line">    LOG_INFO(<span class="string">&quot;Waiting for all tasks to complete...&quot;</span>);</span><br><span class="line">    thread_pool_wait(thread_pool);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 销毁线程池</span></span><br><span class="line">    thread_pool_destroy(thread_pool, <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清理SSL</span></span><br><span class="line">    <span class="keyword">if</span> (ssl_context != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ssl_context_destroy(ssl_context);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清理SSL库</span></span><br><span class="line">    ssl_cleanup();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 保存当前配置（可选）</span></span><br><span class="line">    <span class="keyword">if</span> (server_config-&gt;config_file[<span class="number">0</span>] != <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">        config_save_to_file(server_config, <span class="string">&quot;server.conf.backup&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放配置</span></span><br><span class="line">    config_destroy(server_config);</span><br><span class="line">    </span><br><span class="line">    logger_cleanup();</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Server shutdown complete&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-4-创建配置文件示例"><a href="#4-4-创建配置文件示例" class="headerlink" title="4.4 创建配置文件示例"></a>4.4 创建配置文件示例</h2><h3 id="4-4-1-配置文件示例"><a href="#4-4-1-配置文件示例" class="headerlink" title="4.4.1 配置文件示例"></a>4.4.1 配置文件示例</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># server.conf - 高级HTTP服务器配置</span></span><br><span class="line"><span class="comment"># 基本配置</span></span><br><span class="line"><span class="attr">port</span> = <span class="number">8443</span></span><br><span class="line"><span class="attr">host</span> = <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line"><span class="attr">backlog</span> = <span class="number">1024</span></span><br><span class="line"><span class="attr">max_connections</span> = <span class="number">10000</span></span><br><span class="line"><span class="attr">timeout</span> = <span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件服务配置</span></span><br><span class="line"><span class="attr">document_root</span> = ./static</span><br><span class="line"><span class="attr">index_files</span> = index.html,index.htm</span><br><span class="line"><span class="attr">directory_listing</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">follow_symlinks</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">max_upload_size</span> = <span class="number">10485760</span>  <span class="comment"># 10MB</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志配置</span></span><br><span class="line"><span class="attr">log_file</span> = logs/server.log</span><br><span class="line"><span class="attr">log_level</span> = info</span><br><span class="line"><span class="attr">log_max_size</span> = <span class="number">10</span>    <span class="comment"># MB</span></span><br><span class="line"><span class="attr">log_backup_count</span> = <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 性能配置</span></span><br><span class="line"><span class="attr">tcp_nodelay</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">tcp_keepalive</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">reuse_addr</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">reuse_port</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安全配置</span></span><br><span class="line"><span class="attr">enable_limits</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">max_requests_per_ip</span> = <span class="number">1000</span></span><br><span class="line"><span class="attr">rate_limit</span> = <span class="number">100</span>    <span class="comment"># 请求/秒</span></span><br><span class="line"><span class="attr">enable_cors</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">cors_origin</span> = *</span><br><span class="line"></span><br><span class="line"><span class="comment"># SSL/TLS配置</span></span><br><span class="line"><span class="attr">ssl_enabled</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">ssl_cert_file</span> = cert.pem</span><br><span class="line"><span class="attr">ssl_key_file</span> = key.pem</span><br><span class="line"><span class="attr">ssl_ca_file</span> = </span><br><span class="line"><span class="attr">ssl_verify_client</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">ssl_protocol</span> = <span class="number">0</span>    <span class="comment"># 0 = 自动选择最佳</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 线程池配置</span></span><br><span class="line"><span class="attr">min_threads</span> = <span class="number">4</span></span><br><span class="line"><span class="attr">max_threads</span> = <span class="number">32</span></span><br><span class="line"><span class="attr">queue_size</span> = <span class="number">256</span></span><br><span class="line"><span class="attr">keep_alive_time</span> = <span class="number">60</span></span><br><span class="line"><span class="attr">shutdown_timeout</span> = <span class="number">10</span></span><br></pre></td></tr></table></figure>



<h3 id="4-4-2-创建自签名证书脚本"><a href="#4-4-2-创建自签名证书脚本" class="headerlink" title="4.4.2 创建自签名证书脚本"></a>4.4.2 创建自签名证书脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># scripts/create_ssl_cert.sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 创建自签名SSL证书 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查是否已安装OpenSSL</span></span><br><span class="line"><span class="keyword">if</span> ! <span class="built_in">command</span> -v openssl &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;错误: OpenSSL未安装&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;请安装OpenSSL:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  Ubuntu/Debian: sudo apt-get install openssl&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  CentOS/RHEL: sudo yum install openssl&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建证书目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p ssl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成私钥</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;1. 生成RSA私钥...&quot;</span></span><br><span class="line">openssl genrsa -out ssl/key.pem 2048</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成证书签名请求</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;2. 生成证书签名请求(CSR)...&quot;</span></span><br><span class="line"><span class="built_in">cat</span> &gt; ssl/csr.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[req]</span></span><br><span class="line"><span class="string">default_bits = 2048</span></span><br><span class="line"><span class="string">prompt = no</span></span><br><span class="line"><span class="string">default_md = sha256</span></span><br><span class="line"><span class="string">distinguished_name = dn</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[dn]</span></span><br><span class="line"><span class="string">C=CN</span></span><br><span class="line"><span class="string">ST=Beijing</span></span><br><span class="line"><span class="string">L=Beijing</span></span><br><span class="line"><span class="string">O=Test Company</span></span><br><span class="line"><span class="string">OU=Development</span></span><br><span class="line"><span class="string">CN=localhost</span></span><br><span class="line"><span class="string">emailAddress=admin@example.com</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">openssl req -new -key ssl/key.pem -out ssl/csr.pem -config ssl/csr.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成自签名证书</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;3. 生成自签名证书...&quot;</span></span><br><span class="line"><span class="built_in">cat</span> &gt; ssl/cert.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">authorityKeyIdentifier=keyid,issuer</span></span><br><span class="line"><span class="string">basicConstraints=CA:FALSE</span></span><br><span class="line"><span class="string">keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment</span></span><br><span class="line"><span class="string">subjectAltName = @alt_names</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[alt_names]</span></span><br><span class="line"><span class="string">DNS.1 = localhost</span></span><br><span class="line"><span class="string">DNS.2 = 127.0.0.1</span></span><br><span class="line"><span class="string">IP.1 = 127.0.0.1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">openssl x509 -req -<span class="keyword">in</span> ssl/csr.pem -signkey ssl/key.pem -out ssl/cert.pem \</span><br><span class="line">    -days 365 -sha256 -extfile ssl/cert.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理临时文件</span></span><br><span class="line"><span class="built_in">rm</span> -f ssl/csr.pem ssl/csr.conf ssl/cert.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成PEM格式的证书（包含私钥和证书）</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;4. 生成PEM文件...&quot;</span></span><br><span class="line"><span class="built_in">cat</span> ssl/key.pem ssl/cert.pem &gt; ssl/server.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成客户端证书（可选）</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;5. 生成客户端证书...&quot;</span></span><br><span class="line">openssl genrsa -out ssl/client.key 2048</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; ssl/client.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[req]</span></span><br><span class="line"><span class="string">default_bits = 2048</span></span><br><span class="line"><span class="string">prompt = no</span></span><br><span class="line"><span class="string">default_md = sha256</span></span><br><span class="line"><span class="string">distinguished_name = dn</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[dn]</span></span><br><span class="line"><span class="string">C=CN</span></span><br><span class="line"><span class="string">ST=Beijing</span></span><br><span class="line"><span class="string">L=Beijing</span></span><br><span class="line"><span class="string">O=Test Company</span></span><br><span class="line"><span class="string">OU=Client</span></span><br><span class="line"><span class="string">CN=testclient</span></span><br><span class="line"><span class="string">emailAddress=client@example.com</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">openssl req -new -key ssl/client.key -out ssl/client.csr -config ssl/client.conf</span><br><span class="line">openssl x509 -req -<span class="keyword">in</span> ssl/client.csr -CA ssl/cert.pem -CAkey ssl/key.pem \</span><br><span class="line">    -CAcreateserial -out ssl/client.crt -days 365 -sha256</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理客户端临时文件</span></span><br><span class="line"><span class="built_in">rm</span> -f ssl/client.conf ssl/client.csr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建证书信息文件</span></span><br><span class="line"><span class="built_in">cat</span> &gt; ssl/README.md &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string"># SSL证书文件说明</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 服务器证书</span></span><br><span class="line"><span class="string">- cert.pem: 服务器证书（公钥）</span></span><br><span class="line"><span class="string">- key.pem: 服务器私钥</span></span><br><span class="line"><span class="string">- server.pem: 包含证书和私钥的PEM文件</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 客户端证书（用于双向认证）</span></span><br><span class="line"><span class="string">- client.crt: 客户端证书</span></span><br><span class="line"><span class="string">- client.key: 客户端私钥</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 使用说明</span></span><br><span class="line"><span class="string">1. 配置server.conf:</span></span><br><span class="line"><span class="string">   ssl_enabled = true</span></span><br><span class="line"><span class="string">   ssl_cert_file = ssl/cert.pem</span></span><br><span class="line"><span class="string">   ssl_key_file = ssl/key.pem</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. 启动服务器:</span></span><br><span class="line"><span class="string">   ./http_server -c server.conf</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3. 测试HTTPS连接:</span></span><br><span class="line"><span class="string">   curl -k https://localhost:8443/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 证书信息</span></span><br><span class="line"><span class="string">- 颁发给: localhost</span></span><br><span class="line"><span class="string">- 有效期: 365天</span></span><br><span class="line"><span class="string">- 密钥长度: 2048位</span></span><br><span class="line"><span class="string">- 签名算法: SHA256</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">注意：这是自签名证书，浏览器会显示安全警告。</span></span><br><span class="line"><span class="string">在生产环境中，请使用CA签发的证书。</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 证书生成完成 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;证书文件保存在 ssl/ 目录中&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;文件列表:&quot;</span></span><br><span class="line"><span class="built_in">ls</span> -la ssl/</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;测试命令:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;  curl -k https://localhost:8443/&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;查看证书信息:&quot;</span></span><br><span class="line">openssl x509 -<span class="keyword">in</span> ssl/cert.pem -text -noout | grep -A2 <span class="string">&quot;Subject:&quot;</span></span><br></pre></td></tr></table></figure>



<h2 id="4-5-更新Makefile"><a href="#4-5-更新Makefile" class="headerlink" title="4.5 更新Makefile"></a>4.5 更新Makefile</h2><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Makefile（完整版）</span></span><br><span class="line">CC = gcc</span><br><span class="line">CFLAGS = -Wall -Wextra -g -O0 -I./<span class="keyword">include</span> -D_GNU_SOURCE -DOPENSSL_API_COMPAT=0x10100000L</span><br><span class="line">LDFLAGS = -pthread -lssl -lcrypto</span><br><span class="line">TARGET = http_server</span><br><span class="line">SRC_DIR = src</span><br><span class="line">INCLUDE_DIR = <span class="keyword">include</span></span><br><span class="line">BUILD_DIR = build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 源文件列表</span></span><br><span class="line">SRCS = <span class="variable">$(SRC_DIR)</span>/logger.c \</span><br><span class="line">       <span class="variable">$(SRC_DIR)</span>/request.c \</span><br><span class="line">       <span class="variable">$(SRC_DIR)</span>/response.c \</span><br><span class="line">       <span class="variable">$(SRC_DIR)</span>/thread_pool.c \</span><br><span class="line">       <span class="variable">$(SRC_DIR)</span>/connection.c \</span><br><span class="line">       <span class="variable">$(SRC_DIR)</span>/config.c \</span><br><span class="line">       <span class="variable">$(SRC_DIR)</span>/ssl_wrapper.c \</span><br><span class="line">       <span class="variable">$(SRC_DIR)</span>/main.c</span><br><span class="line"></span><br><span class="line">OBJS = $(SRCS:<span class="variable">$(SRC_DIR)</span>/%.c=<span class="variable">$(BUILD_DIR)</span>/%.o)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认目标</span></span><br><span class="line"><span class="section">all: <span class="variable">$(BUILD_DIR)</span> <span class="variable">$(TARGET)</span> ssl</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建构建目录</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>:</span><br><span class="line">	mkdir -p <span class="variable">$(BUILD_DIR)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 链接可执行文件</span></span><br><span class="line"><span class="variable">$(TARGET)</span>: <span class="variable">$(OBJS)</span></span><br><span class="line">	<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> <span class="variable">$^</span> -o <span class="variable">$@</span> <span class="variable">$(LDFLAGS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译源文件</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/%.o: <span class="variable">$(SRC_DIR)</span>/%.c</span><br><span class="line">	<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> -c <span class="variable">$&lt;</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -rf <span class="variable">$(BUILD_DIR)</span> <span class="variable">$(TARGET)</span> logs/* core vgcore.* gmon.out</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行服务器（默认配置）</span></span><br><span class="line"><span class="section">run: <span class="variable">$(TARGET)</span> ssl</span></span><br><span class="line">	./<span class="variable">$(TARGET)</span> -c config/server.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行HTTP（非SSL）</span></span><br><span class="line"><span class="section">run-http: <span class="variable">$(TARGET)</span></span></span><br><span class="line">	./<span class="variable">$(TARGET)</span> -p 8080 -t 4:16 -q 256</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行HTTPS（SSL）</span></span><br><span class="line"><span class="section">run-https: <span class="variable">$(TARGET)</span> ssl</span></span><br><span class="line">	./<span class="variable">$(TARGET)</span> -c config/server-ssl.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调试运行</span></span><br><span class="line"><span class="section">debug: <span class="variable">$(TARGET)</span></span></span><br><span class="line">	gdb -ex run --args ./<span class="variable">$(TARGET)</span> -c config/server.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查内存泄漏</span></span><br><span class="line"><span class="section">valgrind: <span class="variable">$(TARGET)</span></span></span><br><span class="line">	valgrind --leak-check=full \</span><br><span class="line">	         --show-leak-kinds=all \</span><br><span class="line">	         --track-origins=yes \</span><br><span class="line">	         --log-file=logs/valgrind.log \</span><br><span class="line">	         ./<span class="variable">$(TARGET)</span> -p 8081 -t 2:2 -q 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建SSL证书</span></span><br><span class="line"><span class="section">ssl:</span></span><br><span class="line">	@if [ ! -f ssl/cert.pem ]; then \</span><br><span class="line">		echo <span class="string">&quot;创建SSL证书...&quot;</span>; \</span><br><span class="line">		./scripts/create_ssl_cert.sh; \</span><br><span class="line">	<span class="keyword">else</span> \</span><br><span class="line">		echo <span class="string">&quot;SSL证书已存在&quot;</span>; \</span><br><span class="line">	fi</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建必要的目录</span></span><br><span class="line"><span class="section">init:</span></span><br><span class="line">	mkdir -p logs static ssl config <span class="variable">$(BUILD_DIR)</span></span><br><span class="line">	cp -n config_examples/* config/ 2&gt;/dev/null || true</span><br><span class="line">	cp -n static_examples/* static/ 2&gt;/dev/null || echo <span class="string">&quot;创建示例文件...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建配置目录和文件</span></span><br><span class="line"><span class="section">setup-config:</span></span><br><span class="line">	mkdir -p config</span><br><span class="line">	cp -n config_examples/* config/ 2&gt;/dev/null || echo <span class="string">&quot;创建配置文件...&quot;</span></span><br><span class="line">	@echo <span class="string">&quot;配置文件已创建到 config/ 目录&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行测试套件</span></span><br><span class="line"><span class="section">test: <span class="variable">$(TARGET)</span> ssl</span></span><br><span class="line">	@echo <span class="string">&quot;=== 运行完整测试 ===&quot;</span></span><br><span class="line">	@./scripts/test_complete.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行HTTPS测试</span></span><br><span class="line"><span class="section">test-ssl: <span class="variable">$(TARGET)</span> ssl</span></span><br><span class="line">	@echo <span class="string">&quot;=== 测试SSL功能 ===&quot;</span></span><br><span class="line">	@./scripts/test_ssl.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置重载测试</span></span><br><span class="line"><span class="section">test-reload: <span class="variable">$(TARGET)</span></span></span><br><span class="line">	@echo <span class="string">&quot;=== 测试配置重载 ===&quot;</span></span><br><span class="line">	@./scripts/test_reload.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 性能基准测试</span></span><br><span class="line"><span class="section">benchmark: <span class="variable">$(TARGET)</span></span></span><br><span class="line">	@echo <span class="string">&quot;=== 性能基准测试 ===&quot;</span></span><br><span class="line">	@./scripts/benchmark_complete.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 覆盖率测试</span></span><br><span class="line"><span class="section">coverage: clean</span></span><br><span class="line">	<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> -fprofile-arcs -ftest-coverage <span class="variable">$(SRCS)</span> -o <span class="variable">$(TARGET)</span> <span class="variable">$(LDFLAGS)</span></span><br><span class="line">	./scripts/test_coverage.sh</span><br><span class="line">	gcov <span class="variable">$(SRCS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖（Ubuntu/Debian）</span></span><br><span class="line"><span class="section">install-deps-ubuntu:</span></span><br><span class="line">	sudo apt-get update</span><br><span class="line">	sudo apt-get install -y libssl-dev build-essential gdb valgrind curl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖（CentOS/RHEL）</span></span><br><span class="line"><span class="section">install-deps-centos:</span></span><br><span class="line">	sudo yum install -y openssl-devel gcc make gdb valgrind curl</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: all clean run run-http run-https debug valgrind ssl init setup-config test test-ssl test-reload benchmark coverage install-deps-ubuntu install-deps-centos</span></span><br></pre></td></tr></table></figure>



<h2 id="4-6-创建测试脚本"><a href="#4-6-创建测试脚本" class="headerlink" title="4.6 创建测试脚本"></a>4.6 创建测试脚本</h2><h3 id="4-6-1-完整测试脚本"><a href="#4-6-1-完整测试脚本" class="headerlink" title="4.6.1 完整测试脚本"></a>4.6.1 完整测试脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># scripts/test_complete.sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 高级HTTP服务器完整测试 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译</span></span><br><span class="line">make clean</span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">&quot;http_server&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;编译失败!&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建测试目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p logs static</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建测试文件</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Test Page&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span> &gt; static/index.html</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;&#123;&quot;test&quot;: &quot;data&quot;&#125;&#x27;</span> &gt; static/test.json</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 测试1: HTTP服务器（非SSL）===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;启动HTTP服务器...&quot;</span></span><br><span class="line">./http_server -p 8080 -t 2:4 -q 10 &amp;</span><br><span class="line">HTTP_PID=$!</span><br><span class="line"><span class="built_in">sleep</span> 2</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;测试基本功能...&quot;</span></span><br><span class="line">curl -s http://localhost:8080/ | grep -q <span class="string">&quot;Test Page&quot;</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;✓ 首页正常&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;✗ 首页失败&quot;</span></span><br><span class="line">curl -s http://localhost:8080/test.json | grep -q <span class="string">&quot;test&quot;</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;✓ JSON文件正常&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;✗ JSON文件失败&quot;</span></span><br><span class="line">curl -s http://localhost:8080/admin/stats | grep -q <span class="string">&quot;server&quot;</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;✓ 管理端点正常&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;✗ 管理端点失败&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">kill</span> <span class="variable">$HTTP_PID</span></span><br><span class="line"><span class="built_in">wait</span> <span class="variable">$HTTP_PID</span> 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 测试2: HTTPS服务器（SSL）===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;创建SSL证书...&quot;</span></span><br><span class="line">./scripts/create_ssl_cert.sh &gt; /dev/null 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;启动HTTPS服务器...&quot;</span></span><br><span class="line">./http_server -p 8443 --ssl --ssl-cert ssl/cert.pem --ssl-key ssl/key.pem -t 2:4 -q 10 &amp;</span><br><span class="line">HTTPS_PID=$!</span><br><span class="line"><span class="built_in">sleep</span> 3</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;测试HTTPS连接...&quot;</span></span><br><span class="line">curl -k -s https://localhost:8443/ | grep -q <span class="string">&quot;Test Page&quot;</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;✓ HTTPS首页正常&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;✗ HTTPS首页失败&quot;</span></span><br><span class="line">curl -k -s https://localhost:8443/admin/stats | grep -q <span class="string">&quot;ssl&quot;</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;✓ HTTPS管理端点正常&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;✗ HTTPS管理端点失败&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">kill</span> <span class="variable">$HTTPS_PID</span></span><br><span class="line"><span class="built_in">wait</span> <span class="variable">$HTTPS_PID</span> 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 测试3: 配置文件 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;创建配置文件...&quot;</span></span><br><span class="line"><span class="built_in">cat</span> &gt; test.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">port = 8888</span></span><br><span class="line"><span class="string">host = 127.0.0.1</span></span><br><span class="line"><span class="string">document_root = ./static</span></span><br><span class="line"><span class="string">log_level = debug</span></span><br><span class="line"><span class="string">ssl_enabled = false</span></span><br><span class="line"><span class="string">min_threads = 2</span></span><br><span class="line"><span class="string">max_threads = 8</span></span><br><span class="line"><span class="string">queue_size = 20</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;使用配置文件启动服务器...&quot;</span></span><br><span class="line">./http_server -c test.conf &amp;</span><br><span class="line">CONF_PID=$!</span><br><span class="line"><span class="built_in">sleep</span> 2</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;测试配置服务器...&quot;</span></span><br><span class="line">curl -s http://127.0.0.1:8888/ | grep -q <span class="string">&quot;Test Page&quot;</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;✓ 配置服务器正常&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;✗ 配置服务器失败&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">kill</span> <span class="variable">$CONF_PID</span></span><br><span class="line"><span class="built_in">wait</span> <span class="variable">$CONF_PID</span> 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 测试4: 并发性能 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;启动性能测试服务器...&quot;</span></span><br><span class="line">./http_server -p 9999 -t 4:16 -q 100 &amp;</span><br><span class="line">PERF_PID=$!</span><br><span class="line"><span class="built_in">sleep</span> 2</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;运行并发测试...&quot;</span></span><br><span class="line">ab -n 1000 -c 50 http://localhost:9999/ &gt; logs/ab_test.log 2&gt;&amp;1</span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✓ 并发测试完成&quot;</span></span><br><span class="line">    grep <span class="string">&quot;Requests per second&quot;</span> logs/ab_test.log</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✗ 并发测试失败&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">kill</span> <span class="variable">$PERF_PID</span></span><br><span class="line"><span class="built_in">wait</span> <span class="variable">$PERF_PID</span> 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 测试5: 错误处理 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;启动错误测试服务器...&quot;</span></span><br><span class="line">./http_server -p 7777 -t 2:2 -q 5 &amp;</span><br><span class="line">ERR_PID=$!</span><br><span class="line"><span class="built_in">sleep</span> 2</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;测试错误请求...&quot;</span></span><br><span class="line">curl -s http://localhost:7777/nonexistent | grep -q <span class="string">&quot;404&quot;</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;✓ 404错误处理正常&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;✗ 404错误处理失败&quot;</span></span><br><span class="line">curl -s -X POST http://localhost:7777/ | grep -q <span class="string">&quot;405&quot;</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;✓ 405错误处理正常&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;✗ 405错误处理失败&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">kill</span> <span class="variable">$ERR_PID</span></span><br><span class="line"><span class="built_in">wait</span> <span class="variable">$ERR_PID</span> 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理</span></span><br><span class="line"><span class="built_in">rm</span> -f test.conf</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 查看日志 ===&quot;</span></span><br><span class="line"><span class="built_in">tail</span> -n 20 logs/server.log</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 测试完成 ===&quot;</span></span><br></pre></td></tr></table></figure>



<h3 id="4-6-2-SSL测试脚本"><a href="#4-6-2-SSL测试脚本" class="headerlink" title="4.6.2 SSL测试脚本"></a>4.6.2 SSL测试脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># scripts/test_ssl.sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== SSL/TLS功能测试 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译</span></span><br><span class="line">make clean</span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">&quot;http_server&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;编译失败!&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 确保有SSL证书</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">&quot;ssl/cert.pem&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;创建SSL证书...&quot;</span></span><br><span class="line">    ./scripts/create_ssl_cert.sh &gt; /dev/null 2&gt;&amp;1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 测试1: 基本HTTPS连接 ===&quot;</span></span><br><span class="line">./http_server -p 8443 --ssl --ssl-cert ssl/cert.pem --ssl-key ssl/key.pem -t 2:2 -q 5 &amp;</span><br><span class="line">SERVER_PID=$!</span><br><span class="line"><span class="built_in">sleep</span> 3</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;测试HTTPS请求...&quot;</span></span><br><span class="line">curl -k -s https://localhost:8443/ &gt; /dev/null &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;✓ HTTPS连接成功&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;✗ HTTPS连接失败&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试SSL信息</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 测试2: SSL信息端点 ===&quot;</span></span><br><span class="line">curl -k -s https://localhost:8443/admin/stats | python3 -c <span class="string">&quot;</span></span><br><span class="line"><span class="string">import json, sys</span></span><br><span class="line"><span class="string">data = json.load(sys.stdin)</span></span><br><span class="line"><span class="string">ssl_info = data.get(&#x27;ssl&#x27;, &#123;&#125;)</span></span><br><span class="line"><span class="string">print(f&#x27;SSL启用: &#123;ssl_info.get(\&quot;enabled\&quot;, False)&#125;&#x27;)</span></span><br><span class="line"><span class="string">print(f&#x27;协议: &#123;ssl_info.get(\&quot;protocol\&quot;, \&quot;N/A\&quot;)&#125;&#x27;)</span></span><br><span class="line"><span class="string">print(f&#x27;密码套件: &#123;ssl_info.get(\&quot;cipher\&quot;, \&quot;N/A\&quot;)&#125;&#x27;)</span></span><br><span class="line"><span class="string">&quot;</span> 2&gt;/dev/null || curl -k -s https://localhost:8443/admin/stats | grep ssl</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 测试3: 客户端证书验证 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;注意：此测试需要配置客户端证书验证&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 测试4: SSL连接性能 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;运行SSL性能测试...&quot;</span></span><br><span class="line">time curl -k -s https://localhost:8443/ &gt; /dev/null</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;第一次连接完成&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试会话重用</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;测试SSL会话重用...&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..3&#125;; <span class="keyword">do</span></span><br><span class="line">    time curl -k -s https://localhost:8443/ &gt; /dev/null</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 测试5: OpenSSL s_client连接测试 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;使用OpenSSL测试连接...&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Q&quot;</span> | openssl s_client -connect localhost:8443 -brief 2&gt;&amp;1 | grep -E <span class="string">&quot;(Protocol|Cipher|Verification)&quot;</span> | <span class="built_in">head</span> -5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止服务器</span></span><br><span class="line"><span class="built_in">kill</span> <span class="variable">$SERVER_PID</span></span><br><span class="line"><span class="built_in">wait</span> <span class="variable">$SERVER_PID</span> 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 测试6: 配置热重载SSL证书 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;此测试需要修改证书文件并发送SIGHUP信号&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== SSL测试完成 ===&quot;</span></span><br></pre></td></tr></table></figure>



<h3 id="4-6-3-配置重载测试脚本"><a href="#4-6-3-配置重载测试脚本" class="headerlink" title="4.6.3 配置重载测试脚本"></a>4.6.3 配置重载测试脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># scripts/test_reload.sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 配置热重载测试 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译</span></span><br><span class="line">make clean</span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">&quot;http_server&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;编译失败!&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建测试配置文件</span></span><br><span class="line"><span class="built_in">cat</span> &gt; test_reload.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">port = 8888</span></span><br><span class="line"><span class="string">host = 127.0.0.1</span></span><br><span class="line"><span class="string">document_root = ./static</span></span><br><span class="line"><span class="string">log_level = info</span></span><br><span class="line"><span class="string">log_file = logs/reload_test.log</span></span><br><span class="line"><span class="string">ssl_enabled = false</span></span><br><span class="line"><span class="string">min_threads = 2</span></span><br><span class="line"><span class="string">max_threads = 4</span></span><br><span class="line"><span class="string">queue_size = 10</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建测试文件</span></span><br><span class="line"><span class="built_in">mkdir</span> -p static</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Version 1&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span> &gt; static/index.html</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 步骤1: 启动服务器 ===&quot;</span></span><br><span class="line">./http_server -c test_reload.conf &amp;</span><br><span class="line">SERVER_PID=$!</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;服务器PID: <span class="variable">$SERVER_PID</span>&quot;</span></span><br><span class="line"><span class="built_in">sleep</span> 3</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;初始请求测试...&quot;</span></span><br><span class="line">curl -s http://127.0.0.1:8888/ | grep -q <span class="string">&quot;Version 1&quot;</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;✓ 初始版本正常&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;✗ 初始版本失败&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 步骤2: 修改配置文件 ===&quot;</span></span><br><span class="line"><span class="built_in">cat</span> &gt; test_reload.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">port = 8888</span></span><br><span class="line"><span class="string">host = 127.0.0.1</span></span><br><span class="line"><span class="string">document_root = ./static</span></span><br><span class="line"><span class="string">log_level = debug  # 修改日志级别</span></span><br><span class="line"><span class="string">log_file = logs/reload_test.log</span></span><br><span class="line"><span class="string">ssl_enabled = false</span></span><br><span class="line"><span class="string">min_threads = 3    # 修改线程数</span></span><br><span class="line"><span class="string">max_threads = 6</span></span><br><span class="line"><span class="string">queue_size = 20    # 修改队列大小</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;配置文件已修改&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;等待配置文件修改时间戳更新...&quot;</span></span><br><span class="line"><span class="built_in">touch</span> test_reload.conf</span><br><span class="line"><span class="built_in">sleep</span> 2</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 步骤3: 发送重载信号 ===&quot;</span></span><br><span class="line"><span class="built_in">kill</span> -HUP <span class="variable">$SERVER_PID</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;发送SIGHUP信号&quot;</span></span><br><span class="line"><span class="built_in">sleep</span> 2</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;检查日志文件...&quot;</span></span><br><span class="line"><span class="keyword">if</span> grep -q <span class="string">&quot;reload&quot;</span> logs/reload_test.log; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✓ 配置重载已触发&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✗ 配置重载未触发&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 步骤4: 修改网站内容 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Version 2&lt;/h1&gt;&lt;p&gt;Reloaded!&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span> &gt; static/index.html</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;等待服务器检测文件变化...&quot;</span></span><br><span class="line"><span class="built_in">sleep</span> 5</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;测试新内容...&quot;</span></span><br><span class="line">curl -s http://127.0.0.1:8888/ | grep -q <span class="string">&quot;Version 2&quot;</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;✓ 新版本正常&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;✗ 新版本失败&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 步骤5: 停止服务器 ===&quot;</span></span><br><span class="line"><span class="built_in">kill</span> <span class="variable">$SERVER_PID</span></span><br><span class="line"><span class="built_in">wait</span> <span class="variable">$SERVER_PID</span> 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 查看重载日志 ===&quot;</span></span><br><span class="line"><span class="built_in">tail</span> -n 10 logs/reload_test.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理</span></span><br><span class="line"><span class="built_in">rm</span> -f test_reload.conf</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 配置重载测试完成 ===&quot;</span></span><br></pre></td></tr></table></figure>



<h2 id="4-7-编译和测试"><a href="#4-7-编译和测试" class="headerlink" title="4.7 编译和测试"></a>4.7 编译和测试</h2><h3 id="4-7-1-初始化项目"><a href="#4-7-1-初始化项目" class="headerlink" title="4.7.1 初始化项目"></a>4.7.1 初始化项目</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装OpenSSL开发库（Ubuntu/Debian）</span></span><br><span class="line">sudo apt-get install libssl-dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者（CentOS/RHEL）</span></span><br><span class="line">sudo yum install openssl-devel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化项目</span></span><br><span class="line">make init</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建SSL证书</span></span><br><span class="line">make ssl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译项目</span></span><br><span class="line">make</span><br></pre></td></tr></table></figure>



<h3 id="4-7-2-运行服务器"><a href="#4-7-2-运行服务器" class="headerlink" title="4.7.2 运行服务器"></a>4.7.2 运行服务器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用配置文件运行HTTP</span></span><br><span class="line">./http_server -c config/server.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用配置文件运行HTTPS</span></span><br><span class="line">./http_server -c config/server-ssl.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 命令行参数运行</span></span><br><span class="line">./http_server -p 8080 --ssl --ssl-cert ssl/cert.pem --ssl-key ssl/key.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用make命令</span></span><br><span class="line">make run-http</span><br><span class="line">make run-https</span><br></pre></td></tr></table></figure>



<h3 id="4-7-3-运行测试"><a href="#4-7-3-运行测试" class="headerlink" title="4.7.3 运行测试"></a>4.7.3 运行测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行完整测试</span></span><br><span class="line">make <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行SSL测试</span></span><br><span class="line">make test-ssl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行配置重载测试</span></span><br><span class="line">make test-reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行性能测试</span></span><br><span class="line">make benchmark</span><br></pre></td></tr></table></figure>



<h3 id="4-7-4-高级调试和监控"><a href="#4-7-4-高级调试和监控" class="headerlink" title="4.7.4 高级调试和监控"></a>4.7.4 高级调试和监控</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. SSL调试</span></span><br><span class="line">openssl s_client -connect localhost:8443 -debug</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 配置热重载</span></span><br><span class="line"><span class="comment"># 修改配置文件后，发送SIGHUP信号</span></span><br><span class="line"><span class="built_in">kill</span> -HUP $(pidof http_server)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 查看SSL连接信息</span></span><br><span class="line">curl -k -v https://localhost:8443/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 内存泄漏检查（带SSL）</span></span><br><span class="line">make valgrind</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 性能分析</span></span><br><span class="line">perf record ./http_server -c config/server.conf</span><br><span class="line">perf report</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 查看实时统计</span></span><br><span class="line">watch -n 1 <span class="string">&quot;curl -s http://localhost:8080/admin/stats | python3 -m json.tool&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 监控SSL握手</span></span><br><span class="line">openssl s_server -accept 8444 -cert ssl/cert.pem -key ssl/key.pem -www</span><br></pre></td></tr></table></figure>



<h2 id="4-8-总结"><a href="#4-8-总结" class="headerlink" title="4.8 总结"></a>4.8 总结</h2><p>在这个阶段，我们实现了完整的配置管理和SSL&#x2F;TLS支持：</p>
<h3 id="实现的功能：-2"><a href="#实现的功能：-2" class="headerlink" title="实现的功能："></a>实现的功能：</h3><ol>
<li><strong>配置文件管理</strong>：<ul>
<li>支持INI格式配置文件</li>
<li>配置验证和默认值</li>
<li>配置热重载（SIGHUP信号）</li>
<li>命令行参数覆盖</li>
</ul>
</li>
<li><strong>SSL&#x2F;TLS支持</strong>：<ul>
<li>完整的SSL&#x2F;TLS实现</li>
<li>支持服务器证书和客户端证书验证</li>
<li>多种SSL选项配置</li>
<li>SSL会话重用</li>
</ul>
</li>
<li><strong>高级文件服务</strong>：<ul>
<li>目录列表支持</li>
<li>默认索引文件</li>
<li>文件大小限制</li>
<li>CORS支持</li>
</ul>
</li>
<li><strong>管理端点</strong>：<ul>
<li><code>/admin/stats</code> - 服务器统计</li>
<li><code>/admin/config</code> - 配置查看</li>
<li><code>/admin/reload</code> - 配置重载</li>
</ul>
</li>
<li><strong>安全增强</strong>：<ul>
<li>目录遍历攻击防护</li>
<li>文件上传大小限制</li>
<li>CORS配置</li>
<li>速率限制（基础）</li>
</ul>
</li>
</ol>
<h3 id="学到的技能：-2"><a href="#学到的技能：-2" class="headerlink" title="学到的技能："></a>学到的技能：</h3><ol>
<li><strong>配置管理</strong>：<ul>
<li>配置文件解析和验证</li>
<li>热重载实现</li>
<li>配置版本管理</li>
</ul>
</li>
<li><strong>SSL&#x2F;TLS编程</strong>：<ul>
<li>OpenSSL库使用</li>
<li>证书管理</li>
<li>SSL握手过程</li>
<li>加密通信</li>
</ul>
</li>
<li><strong>安全编程</strong>：<ul>
<li>输入验证和清理</li>
<li>文件路径安全</li>
<li>内存安全</li>
</ul>
</li>
<li><strong>系统管理</strong>：<ul>
<li>信号处理</li>
<li>进程管理</li>
<li>日志轮转</li>
</ul>
</li>
</ol>
<h3 id="运维和调试技巧：-2"><a href="#运维和调试技巧：-2" class="headerlink" title="运维和调试技巧："></a>运维和调试技巧：</h3><ol>
<li><strong>SSL调试</strong>：<ul>
<li>OpenSSL命令行工具</li>
<li>证书验证和调试</li>
<li>SSL握手问题排查</li>
</ul>
</li>
<li><strong>配置管理</strong>：<ul>
<li>配置文件版本控制</li>
<li>配置验证和测试</li>
<li>热重载测试</li>
</ul>
</li>
<li><strong>性能调优</strong>：<ul>
<li>SSL性能优化</li>
<li>连接池管理</li>
<li>内存使用优化</li>
</ul>
</li>
<li><strong>监控和告警</strong>：<ul>
<li>服务器状态监控</li>
<li>SSL证书过期监控</li>
<li>性能指标收集</li>
</ul>
</li>
</ol>
<h3 id="实际应用场景："><a href="#实际应用场景：" class="headerlink" title="实际应用场景："></a>实际应用场景：</h3><ol>
<li><strong>生产环境部署</strong>：<ul>
<li>使用正式CA证书</li>
<li>配置日志轮转</li>
<li>设置系统服务</li>
</ul>
</li>
<li><strong>开发环境</strong>：<ul>
<li>自签名证书</li>
<li>调试配置</li>
<li>快速迭代</li>
</ul>
</li>
<li><strong>测试环境</strong>：<ul>
<li>自动化测试</li>
<li>性能基准</li>
<li>安全扫描</li>
</ul>
</li>
</ol>
<p>现在你已经拥有了一个功能完整、安全可靠的HTTP服务器！这个项目涵盖了C语言在企业级开发中的大多数核心技能，包括：</p>
<ol>
<li><strong>网络编程</strong> - Socket、TCP&#x2F;IP、HTTP协议</li>
<li><strong>并发处理</strong> - 线程池、锁、条件变量</li>
<li><strong>内存管理</strong> - 动态分配、内存泄漏检测</li>
<li><strong>文件I&#x2F;O</strong> - 文件系统操作、目录遍历</li>
<li><strong>模块化设计</strong> - 清晰的模块划分和接口设计</li>
<li><strong>配置管理</strong> - 配置文件解析和热重载</li>
<li><strong>安全编程</strong> - SSL&#x2F;TLS、输入验证</li>
<li><strong>调试技巧</strong> - gdb、valgrind、性能分析</li>
</ol>
<h1 id="阶段5：高级特性扩展"><a href="#阶段5：高级特性扩展" class="headerlink" title="阶段5：高级特性扩展"></a>阶段5：高级特性扩展</h1><p>在这个阶段，我们将扩展服务器的功能，包括缓存系统、API网关特性、WebSocket支持、动态内容处理（CGI&#x2F;FastCGI）和更完善的安全功能。</p>
<h2 id="5-1-缓存系统"><a href="#5-1-缓存系统" class="headerlink" title="5.1 缓存系统"></a>5.1 缓存系统</h2><h3 id="5-1-1-缓存头文件（cache-h）"><a href="#5-1-1-缓存头文件（cache-h）" class="headerlink" title="5.1.1 缓存头文件（cache.h）"></a>5.1.1 缓存头文件（cache.h）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/cache.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CACHE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CACHE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 缓存项状态</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    CACHE_VALID,</span><br><span class="line">    CACHE_EXPIRED,</span><br><span class="line">    CACHE_STALE,</span><br><span class="line">    CACHE_INVALID</span><br><span class="line">&#125; CacheStatus;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 缓存项</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">CacheItem</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> *key;                   <span class="comment">// 缓存键（文件路径）</span></span><br><span class="line">    <span class="type">char</span> *data;                  <span class="comment">// 缓存数据</span></span><br><span class="line">    <span class="type">size_t</span> size;                 <span class="comment">// 数据大小</span></span><br><span class="line">    <span class="type">char</span> *etag;                  <span class="comment">// ETag</span></span><br><span class="line">    <span class="type">char</span> *content_type;          <span class="comment">// 内容类型</span></span><br><span class="line">    <span class="type">time_t</span> last_modified;        <span class="comment">// 最后修改时间（文件）</span></span><br><span class="line">    <span class="type">time_t</span> created_at;           <span class="comment">// 缓存创建时间</span></span><br><span class="line">    <span class="type">time_t</span> expires_at;           <span class="comment">// 缓存过期时间</span></span><br><span class="line">    <span class="type">int</span> hit_count;               <span class="comment">// 命中次数</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">CacheItem</span> *<span class="title">prev</span>;</span>      <span class="comment">// 前一个节点</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">CacheItem</span> *<span class="title">next</span>;</span>      <span class="comment">// 后一个节点</span></span><br><span class="line">&#125; CacheItem;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 缓存统计</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> total_size;           <span class="comment">// 总缓存大小</span></span><br><span class="line">    <span class="type">int</span> total_items;             <span class="comment">// 总缓存项数</span></span><br><span class="line">    <span class="type">int</span> hit_count;               <span class="comment">// 命中次数</span></span><br><span class="line">    <span class="type">int</span> miss_count;              <span class="comment">// 未命中次数</span></span><br><span class="line">    <span class="type">int</span> eviction_count;          <span class="comment">// 淘汰次数</span></span><br><span class="line">    <span class="type">time_t</span> startup_time;         <span class="comment">// 启动时间</span></span><br><span class="line">&#125; CacheStats;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 缓存配置</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> max_size;             <span class="comment">// 最大缓存大小（字节）</span></span><br><span class="line">    <span class="type">int</span> max_items;               <span class="comment">// 最大缓存项数</span></span><br><span class="line">    <span class="type">int</span> default_ttl;             <span class="comment">// 默认TTL（秒）</span></span><br><span class="line">    <span class="type">int</span> check_interval;          <span class="comment">// 检查间隔（秒）</span></span><br><span class="line">    <span class="type">int</span> enable_memory_cache;     <span class="comment">// 启用内存缓存</span></span><br><span class="line">    <span class="type">int</span> enable_disk_cache;       <span class="comment">// 启用磁盘缓存</span></span><br><span class="line">    <span class="type">char</span> disk_cache_path[<span class="number">512</span>];   <span class="comment">// 磁盘缓存路径</span></span><br><span class="line">&#125; CacheConfig;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 缓存系统</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    CacheItem *head;             <span class="comment">// 链表头（最近使用）</span></span><br><span class="line">    CacheItem *tail;             <span class="comment">// 链表尾（最久未用）</span></span><br><span class="line">    <span class="type">pthread_mutex_t</span> lock;        <span class="comment">// 互斥锁</span></span><br><span class="line">    <span class="type">pthread_t</span> cleaner_thread;    <span class="comment">// 清理线程</span></span><br><span class="line">    <span class="type">int</span> running;                 <span class="comment">// 运行标志</span></span><br><span class="line">    CacheConfig config;          <span class="comment">// 配置</span></span><br><span class="line">    CacheStats stats;            <span class="comment">// 统计信息</span></span><br><span class="line">    <span class="type">int</span> (*should_cache)(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">const</span> <span class="type">char</span> *content_type); <span class="comment">// 缓存策略函数</span></span><br><span class="line">&#125; CacheSystem;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化缓存系统</span></span><br><span class="line">CacheSystem* <span class="title function_">cache_init</span><span class="params">(<span class="type">const</span> CacheConfig *config)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取缓存项</span></span><br><span class="line">CacheItem* <span class="title function_">cache_get</span><span class="params">(CacheSystem *cache, <span class="type">const</span> <span class="type">char</span> *key)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加缓存项</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">cache_put</span><span class="params">(CacheSystem *cache, <span class="type">const</span> <span class="type">char</span> *key, </span></span><br><span class="line"><span class="params">              <span class="type">const</span> <span class="type">char</span> *data, <span class="type">size_t</span> size,</span></span><br><span class="line"><span class="params">              <span class="type">const</span> <span class="type">char</span> *content_type, <span class="type">time_t</span> last_modified)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除缓存项</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">cache_remove</span><span class="params">(CacheSystem *cache, <span class="type">const</span> <span class="type">char</span> *key)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清除缓存</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">cache_clear</span><span class="params">(CacheSystem *cache)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取缓存统计</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">cache_get_stats</span><span class="params">(CacheSystem *cache, CacheStats *stats)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查缓存有效性</span></span><br><span class="line">CacheStatus <span class="title function_">cache_check_validity</span><span class="params">(CacheItem *item, <span class="type">time_t</span> if_modified_since, <span class="type">const</span> <span class="type">char</span> *if_none_match)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新缓存项访问时间</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">cache_touch</span><span class="params">(CacheSystem *cache, CacheItem *item)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 缓存响应</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">cache_response</span><span class="params">(CacheSystem *cache, <span class="type">const</span> <span class="type">char</span> *key, </span></span><br><span class="line"><span class="params">                   <span class="type">const</span> <span class="type">char</span> *content, <span class="type">size_t</span> length,</span></span><br><span class="line"><span class="params">                   <span class="type">const</span> <span class="type">char</span> *content_type, <span class="type">time_t</span> last_modified)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清理过期缓存</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">cache_cleanup_expired</span><span class="params">(CacheSystem *cache)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调整缓存大小</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">cache_resize</span><span class="params">(CacheSystem *cache, <span class="type">size_t</span> max_size, <span class="type">int</span> max_items)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 销毁缓存系统</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">cache_destroy</span><span class="params">(CacheSystem *cache)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认缓存策略</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">default_cache_policy</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">const</span> <span class="type">char</span> *content_type)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成ETag</span></span><br><span class="line"><span class="type">char</span>* <span class="title function_">generate_etag</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *content, <span class="type">size_t</span> length, <span class="type">time_t</span> last_modified)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// CACHE_H</span></span></span><br></pre></td></tr></table></figure>



<h3 id="5-1-2-缓存实现（cache-c）"><a href="#5-1-2-缓存实现（cache-c）" class="headerlink" title="5.1.2 缓存实现（cache.c）"></a>5.1.2 缓存实现（cache.c）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/cache.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/md5.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/cache.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/logger.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 内部函数声明</span></span><br><span class="line"><span class="type">static</span> CacheItem* <span class="title function_">create_cache_item</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *key, <span class="type">const</span> <span class="type">char</span> *data, <span class="type">size_t</span> size,</span></span><br><span class="line"><span class="params">                                   <span class="type">const</span> <span class="type">char</span> *content_type, <span class="type">time_t</span> last_modified, <span class="type">int</span> ttl)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">destroy_cache_item</span><span class="params">(CacheItem *item)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">add_to_cache</span><span class="params">(CacheSystem *cache, CacheItem *item)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">remove_from_cache</span><span class="params">(CacheSystem *cache, CacheItem *item)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">move_to_front</span><span class="params">(CacheSystem *cache, CacheItem *item)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">evict_cache</span><span class="params">(CacheSystem *cache)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">cache_cleaner_thread</span><span class="params">(<span class="type">void</span> *arg)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">size_t</span> <span class="title function_">calculate_item_size</span><span class="params">(CacheItem *item)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化缓存系统</span></span><br><span class="line">CacheSystem* <span class="title function_">cache_init</span><span class="params">(<span class="type">const</span> CacheConfig *config)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Cache configuration is NULL&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    CacheSystem *cache = (CacheSystem*)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(CacheSystem));</span><br><span class="line">    <span class="keyword">if</span> (cache == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to allocate memory for cache system&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化配置</span></span><br><span class="line">    cache-&gt;config = *config;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化链表</span></span><br><span class="line">    cache-&gt;head = <span class="literal">NULL</span>;</span><br><span class="line">    cache-&gt;tail = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化统计信息</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;cache-&gt;stats, <span class="number">0</span>, <span class="keyword">sizeof</span>(CacheStats));</span><br><span class="line">    cache-&gt;stats.startup_time = time(<span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化互斥锁</span></span><br><span class="line">    <span class="keyword">if</span> (pthread_mutex_init(&amp;cache-&gt;lock, <span class="literal">NULL</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to initialize cache mutex&quot;</span>);</span><br><span class="line">        <span class="built_in">free</span>(cache);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置默认缓存策略</span></span><br><span class="line">    cache-&gt;should_cache = default_cache_policy;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建磁盘缓存目录</span></span><br><span class="line">    <span class="keyword">if</span> (config-&gt;enable_disk_cache) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">        <span class="keyword">if</span> (stat(config-&gt;disk_cache_path, &amp;st) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mkdir(config-&gt;disk_cache_path, <span class="number">0755</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">                LOG_WARNING(<span class="string">&quot;Failed to create disk cache directory: %s&quot;</span>, config-&gt;disk_cache_path);</span><br><span class="line">                cache-&gt;config.enable_disk_cache = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 启动清理线程</span></span><br><span class="line">    cache-&gt;running = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (pthread_create(&amp;cache-&gt;cleaner_thread, <span class="literal">NULL</span>, cache_cleaner_thread, cache) != <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to start cache cleaner thread&quot;</span>);</span><br><span class="line">        pthread_mutex_destroy(&amp;cache-&gt;lock);</span><br><span class="line">        <span class="built_in">free</span>(cache);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Cache system initialized: max_size=%zu, max_items=%d, ttl=%d&quot;</span>,</span><br><span class="line">             config-&gt;max_size, config-&gt;max_items, config-&gt;default_ttl);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> cache;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建缓存项</span></span><br><span class="line"><span class="type">static</span> CacheItem* <span class="title function_">create_cache_item</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *key, <span class="type">const</span> <span class="type">char</span> *data, <span class="type">size_t</span> size,</span></span><br><span class="line"><span class="params">                                   <span class="type">const</span> <span class="type">char</span> *content_type, <span class="type">time_t</span> last_modified, <span class="type">int</span> ttl)</span> &#123;</span><br><span class="line">    CacheItem *item = (CacheItem*)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(CacheItem));</span><br><span class="line">    <span class="keyword">if</span> (item == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to allocate memory for cache item&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置基本属性</span></span><br><span class="line">    item-&gt;key = strdup(key);</span><br><span class="line">    <span class="keyword">if</span> (item-&gt;key == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to duplicate key&quot;</span>);</span><br><span class="line">        <span class="built_in">free</span>(item);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    item-&gt;data = (<span class="type">char</span>*)<span class="built_in">malloc</span>(size);</span><br><span class="line">    <span class="keyword">if</span> (item-&gt;data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to allocate memory for cache data&quot;</span>);</span><br><span class="line">        <span class="built_in">free</span>(item-&gt;key);</span><br><span class="line">        <span class="built_in">free</span>(item);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memcpy</span>(item-&gt;data, data, size);</span><br><span class="line">    item-&gt;size = size;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (content_type != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        item-&gt;content_type = strdup(content_type);</span><br><span class="line">        <span class="keyword">if</span> (item-&gt;content_type == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            LOG_WARNING(<span class="string">&quot;Failed to duplicate content type&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    item-&gt;last_modified = last_modified;</span><br><span class="line">    item-&gt;created_at = time(<span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置过期时间</span></span><br><span class="line">    <span class="keyword">if</span> (ttl &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        item-&gt;expires_at = item-&gt;created_at + ttl;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        item-&gt;expires_at = <span class="number">0</span>; <span class="comment">// 永不过期</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 生成ETag</span></span><br><span class="line">    item-&gt;etag = generate_etag(data, size, last_modified);</span><br><span class="line">    item-&gt;hit_count = <span class="number">0</span>;</span><br><span class="line">    item-&gt;prev = <span class="literal">NULL</span>;</span><br><span class="line">    item-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 销毁缓存项</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">destroy_cache_item</span><span class="params">(CacheItem *item)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (item == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (item-&gt;key != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">free</span>(item-&gt;key);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (item-&gt;data != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">free</span>(item-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (item-&gt;etag != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">free</span>(item-&gt;etag);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (item-&gt;content_type != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">free</span>(item-&gt;content_type);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">free</span>(item);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加到缓存</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">add_to_cache</span><span class="params">(CacheSystem *cache, CacheItem *item)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cache == <span class="literal">NULL</span> || item == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加到链表头部</span></span><br><span class="line">    item-&gt;next = cache-&gt;head;</span><br><span class="line">    item-&gt;prev = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (cache-&gt;head != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        cache-&gt;head-&gt;prev = item;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    cache-&gt;head = item;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (cache-&gt;tail == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        cache-&gt;tail = item;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 更新统计信息</span></span><br><span class="line">    <span class="type">size_t</span> item_size = calculate_item_size(item);</span><br><span class="line">    cache-&gt;stats.total_size += item_size;</span><br><span class="line">    cache-&gt;stats.total_items++;</span><br><span class="line">    </span><br><span class="line">    LOG_DEBUG(<span class="string">&quot;Cache item added: %s (size=%zu)&quot;</span>, item-&gt;key, item_size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从缓存中移除</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">remove_from_cache</span><span class="params">(CacheSystem *cache, CacheItem *item)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cache == <span class="literal">NULL</span> || item == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 从链表中移除</span></span><br><span class="line">    <span class="keyword">if</span> (item-&gt;prev != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        item-&gt;prev-&gt;next = item-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (item-&gt;next != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        item-&gt;next-&gt;prev = item-&gt;prev;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (cache-&gt;head == item) &#123;</span><br><span class="line">        cache-&gt;head = item-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (cache-&gt;tail == item) &#123;</span><br><span class="line">        cache-&gt;tail = item-&gt;prev;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 更新统计信息</span></span><br><span class="line">    <span class="type">size_t</span> item_size = calculate_item_size(item);</span><br><span class="line">    cache-&gt;stats.total_size -= item_size;</span><br><span class="line">    cache-&gt;stats.total_items--;</span><br><span class="line">    cache-&gt;stats.eviction_count++;</span><br><span class="line">    </span><br><span class="line">    LOG_DEBUG(<span class="string">&quot;Cache item removed: %s&quot;</span>, item-&gt;key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移动到链表头部（LRU）</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">move_to_front</span><span class="params">(CacheSystem *cache, CacheItem *item)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cache == <span class="literal">NULL</span> || item == <span class="literal">NULL</span> || cache-&gt;head == item) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 从当前位置移除</span></span><br><span class="line">    remove_from_cache(cache, item);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加到头部</span></span><br><span class="line">    add_to_cache(cache, item);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 淘汰缓存（LRU策略）</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">evict_cache</span><span class="params">(CacheSystem *cache)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cache == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> ((cache-&gt;stats.total_items &gt; cache-&gt;config.max_items || </span><br><span class="line">            cache-&gt;stats.total_size &gt; cache-&gt;config.max_size) &amp;&amp; </span><br><span class="line">           cache-&gt;tail != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        CacheItem *to_evict = cache-&gt;tail;</span><br><span class="line">        </span><br><span class="line">        LOG_DEBUG(<span class="string">&quot;Evicting cache item: %s (hits=%d, size=%zu)&quot;</span>, </span><br><span class="line">                 to_evict-&gt;key, to_evict-&gt;hit_count, calculate_item_size(to_evict));</span><br><span class="line">        </span><br><span class="line">        remove_from_cache(cache, to_evict);</span><br><span class="line">        destroy_cache_item(to_evict);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取缓存项</span></span><br><span class="line">CacheItem* <span class="title function_">cache_get</span><span class="params">(CacheSystem *cache, <span class="type">const</span> <span class="type">char</span> *key)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cache == <span class="literal">NULL</span> || key == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_lock(&amp;cache-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 查找缓存项</span></span><br><span class="line">    CacheItem *item = cache-&gt;head;</span><br><span class="line">    <span class="keyword">while</span> (item != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(item-&gt;key, key) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 检查是否过期</span></span><br><span class="line">            <span class="type">time_t</span> now = time(<span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">if</span> (item-&gt;expires_at &gt; <span class="number">0</span> &amp;&amp; now &gt; item-&gt;expires_at) &#123;</span><br><span class="line">                LOG_DEBUG(<span class="string">&quot;Cache item expired: %s&quot;</span>, key);</span><br><span class="line">                cache-&gt;stats.miss_count++;</span><br><span class="line">                </span><br><span class="line">                remove_from_cache(cache, item);</span><br><span class="line">                destroy_cache_item(item);</span><br><span class="line">                item = <span class="literal">NULL</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 更新访问时间和命中计数</span></span><br><span class="line">                item-&gt;hit_count++;</span><br><span class="line">                cache-&gt;stats.hit_count++;</span><br><span class="line">                move_to_front(cache, item);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        item = item-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (item == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        cache-&gt;stats.miss_count++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_unlock(&amp;cache-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加缓存项</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">cache_put</span><span class="params">(CacheSystem *cache, <span class="type">const</span> <span class="type">char</span> *key, </span></span><br><span class="line"><span class="params">              <span class="type">const</span> <span class="type">char</span> *data, <span class="type">size_t</span> size,</span></span><br><span class="line"><span class="params">              <span class="type">const</span> <span class="type">char</span> *content_type, <span class="type">time_t</span> last_modified)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cache == <span class="literal">NULL</span> || key == <span class="literal">NULL</span> || data == <span class="literal">NULL</span> || size == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查是否应该缓存</span></span><br><span class="line">    <span class="keyword">if</span> (!cache-&gt;should_cache(key, content_type)) &#123;</span><br><span class="line">        LOG_DEBUG(<span class="string">&quot;Skipping cache for: %s&quot;</span>, key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_lock(&amp;cache-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查是否已存在</span></span><br><span class="line">    CacheItem *existing = <span class="literal">NULL</span>;</span><br><span class="line">    CacheItem *item = cache-&gt;head;</span><br><span class="line">    <span class="keyword">while</span> (item != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(item-&gt;key, key) == <span class="number">0</span>) &#123;</span><br><span class="line">            existing = item;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        item = item-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果已存在，先移除</span></span><br><span class="line">    <span class="keyword">if</span> (existing != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        remove_from_cache(cache, existing);</span><br><span class="line">        destroy_cache_item(existing);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建新缓存项</span></span><br><span class="line">    CacheItem *new_item = create_cache_item(key, data, size, content_type, </span><br><span class="line">                                           last_modified, cache-&gt;config.default_ttl);</span><br><span class="line">    <span class="keyword">if</span> (new_item == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        pthread_mutex_unlock(&amp;cache-&gt;lock);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加到缓存</span></span><br><span class="line">    add_to_cache(cache, new_item);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果超出限制，淘汰一些缓存项</span></span><br><span class="line">    evict_cache(cache);</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_unlock(&amp;cache-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    LOG_DEBUG(<span class="string">&quot;Cache put: %s (size=%zu)&quot;</span>, key, size);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除缓存项</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">cache_remove</span><span class="params">(CacheSystem *cache, <span class="type">const</span> <span class="type">char</span> *key)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cache == <span class="literal">NULL</span> || key == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_lock(&amp;cache-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    CacheItem *item = cache-&gt;head;</span><br><span class="line">    <span class="keyword">while</span> (item != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(item-&gt;key, key) == <span class="number">0</span>) &#123;</span><br><span class="line">            remove_from_cache(cache, item);</span><br><span class="line">            destroy_cache_item(item);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        item = item-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_unlock(&amp;cache-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清除缓存</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">cache_clear</span><span class="params">(CacheSystem *cache)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cache == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_lock(&amp;cache-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    CacheItem *item = cache-&gt;head;</span><br><span class="line">    <span class="keyword">while</span> (item != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        CacheItem *next = item-&gt;next;</span><br><span class="line">        destroy_cache_item(item);</span><br><span class="line">        item = next;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    cache-&gt;head = <span class="literal">NULL</span>;</span><br><span class="line">    cache-&gt;tail = <span class="literal">NULL</span>;</span><br><span class="line">    cache-&gt;stats.total_size = <span class="number">0</span>;</span><br><span class="line">    cache-&gt;stats.total_items = <span class="number">0</span>;</span><br><span class="line">    cache-&gt;stats.eviction_count = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_unlock(&amp;cache-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Cache cleared&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取缓存统计</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">cache_get_stats</span><span class="params">(CacheSystem *cache, CacheStats *stats)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cache == <span class="literal">NULL</span> || stats == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_lock(&amp;cache-&gt;lock);</span><br><span class="line">    *stats = cache-&gt;stats;</span><br><span class="line">    pthread_mutex_unlock(&amp;cache-&gt;lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查缓存有效性</span></span><br><span class="line">CacheStatus <span class="title function_">cache_check_validity</span><span class="params">(CacheItem *item, <span class="type">time_t</span> if_modified_since, <span class="type">const</span> <span class="type">char</span> *if_none_match)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (item == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> CACHE_INVALID;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">time_t</span> now = time(<span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查是否过期</span></span><br><span class="line">    <span class="keyword">if</span> (item-&gt;expires_at &gt; <span class="number">0</span> &amp;&amp; now &gt; item-&gt;expires_at) &#123;</span><br><span class="line">        <span class="keyword">return</span> CACHE_EXPIRED;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查If-Modified-Since</span></span><br><span class="line">    <span class="keyword">if</span> (if_modified_since &gt; <span class="number">0</span> &amp;&amp; item-&gt;last_modified &lt;= if_modified_since) &#123;</span><br><span class="line">        <span class="keyword">return</span> CACHE_STALE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查If-None-Match</span></span><br><span class="line">    <span class="keyword">if</span> (if_none_match != <span class="literal">NULL</span> &amp;&amp; item-&gt;etag != <span class="literal">NULL</span> &amp;&amp; </span><br><span class="line">        <span class="built_in">strcmp</span>(item-&gt;etag, if_none_match) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> CACHE_STALE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> CACHE_VALID;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新缓存项访问时间</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">cache_touch</span><span class="params">(CacheSystem *cache, CacheItem *item)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cache == <span class="literal">NULL</span> || item == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_lock(&amp;cache-&gt;lock);</span><br><span class="line">    item-&gt;hit_count++;</span><br><span class="line">    move_to_front(cache, item);</span><br><span class="line">    pthread_mutex_unlock(&amp;cache-&gt;lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 缓存响应</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">cache_response</span><span class="params">(CacheSystem *cache, <span class="type">const</span> <span class="type">char</span> *key, </span></span><br><span class="line"><span class="params">                   <span class="type">const</span> <span class="type">char</span> *content, <span class="type">size_t</span> length,</span></span><br><span class="line"><span class="params">                   <span class="type">const</span> <span class="type">char</span> *content_type, <span class="type">time_t</span> last_modified)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> cache_put(cache, key, content, length, content_type, last_modified);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清理过期缓存</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">cache_cleanup_expired</span><span class="params">(CacheSystem *cache)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cache == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_lock(&amp;cache-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    <span class="type">time_t</span> now = time(<span class="literal">NULL</span>);</span><br><span class="line">    CacheItem *item = cache-&gt;head;</span><br><span class="line">    CacheItem *next;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (item != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        next = item-&gt;next;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (item-&gt;expires_at &gt; <span class="number">0</span> &amp;&amp; now &gt; item-&gt;expires_at) &#123;</span><br><span class="line">            LOG_DEBUG(<span class="string">&quot;Cleaning expired cache item: %s&quot;</span>, item-&gt;key);</span><br><span class="line">            remove_from_cache(cache, item);</span><br><span class="line">            destroy_cache_item(item);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        item = next;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_unlock(&amp;cache-&gt;lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 缓存清理线程</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">cache_cleaner_thread</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">    CacheSystem *cache = (CacheSystem*)arg;</span><br><span class="line">    </span><br><span class="line">    LOG_DEBUG(<span class="string">&quot;Cache cleaner thread started&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (cache-&gt;running) &#123;</span><br><span class="line">        sleep(cache-&gt;config.check_interval);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!cache-&gt;running) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        cache_cleanup_expired(cache);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    LOG_DEBUG(<span class="string">&quot;Cache cleaner thread stopped&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调整缓存大小</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">cache_resize</span><span class="params">(CacheSystem *cache, <span class="type">size_t</span> max_size, <span class="type">int</span> max_items)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cache == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_lock(&amp;cache-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    cache-&gt;config.max_size = max_size;</span><br><span class="line">    cache-&gt;config.max_items = max_items;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果当前缓存超出限制，淘汰一些</span></span><br><span class="line">    evict_cache(cache);</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_unlock(&amp;cache-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Cache resized: max_size=%zu, max_items=%d&quot;</span>, max_size, max_items);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 销毁缓存系统</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">cache_destroy</span><span class="params">(CacheSystem *cache)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cache == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 停止清理线程</span></span><br><span class="line">    cache-&gt;running = <span class="number">0</span>;</span><br><span class="line">    pthread_join(cache-&gt;cleaner_thread, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清除所有缓存项</span></span><br><span class="line">    cache_clear(cache);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 销毁互斥锁</span></span><br><span class="line">    pthread_mutex_destroy(&amp;cache-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放内存</span></span><br><span class="line">    <span class="built_in">free</span>(cache);</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;Cache system destroyed&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算缓存项大小</span></span><br><span class="line"><span class="type">static</span> <span class="type">size_t</span> <span class="title function_">calculate_item_size</span><span class="params">(CacheItem *item)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (item == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">size_t</span> size = <span class="keyword">sizeof</span>(CacheItem);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (item-&gt;key != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        size += <span class="built_in">strlen</span>(item-&gt;key) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (item-&gt;data != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        size += item-&gt;size;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (item-&gt;etag != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        size += <span class="built_in">strlen</span>(item-&gt;etag) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (item-&gt;content_type != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        size += <span class="built_in">strlen</span>(item-&gt;content_type) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认缓存策略</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">default_cache_policy</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">const</span> <span class="type">char</span> *content_type)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (path == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 不缓存动态内容</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *dynamic_extensions[] = &#123;</span><br><span class="line">        <span class="string">&quot;.php&quot;</span>, <span class="string">&quot;.asp&quot;</span>, <span class="string">&quot;.jsp&quot;</span>, <span class="string">&quot;.cgi&quot;</span>, <span class="string">&quot;.pl&quot;</span>, <span class="string">&quot;.py&quot;</span>, <span class="string">&quot;.rb&quot;</span>, <span class="string">&quot;.do&quot;</span>, <span class="string">&quot;.action&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(dynamic_extensions) / <span class="keyword">sizeof</span>(dynamic_extensions[<span class="number">0</span>]); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strstr</span>(path, dynamic_extensions[i]) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据内容类型决定是否缓存</span></span><br><span class="line">    <span class="keyword">if</span> (content_type != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strstr</span>(content_type, <span class="string">&quot;text/html&quot;</span>) != <span class="literal">NULL</span> ||</span><br><span class="line">            <span class="built_in">strstr</span>(content_type, <span class="string">&quot;application/json&quot;</span>) != <span class="literal">NULL</span> ||</span><br><span class="line">            <span class="built_in">strstr</span>(content_type, <span class="string">&quot;text/css&quot;</span>) != <span class="literal">NULL</span> ||</span><br><span class="line">            <span class="built_in">strstr</span>(content_type, <span class="string">&quot;application/javascript&quot;</span>) != <span class="literal">NULL</span> ||</span><br><span class="line">            <span class="built_in">strstr</span>(content_type, <span class="string">&quot;image/&quot;</span>) != <span class="literal">NULL</span> ||</span><br><span class="line">            <span class="built_in">strstr</span>(content_type, <span class="string">&quot;font/&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成ETag</span></span><br><span class="line"><span class="type">char</span>* <span class="title function_">generate_etag</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *content, <span class="type">size_t</span> length, <span class="type">time_t</span> last_modified)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (content == <span class="literal">NULL</span> || length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 使用MD5生成ETag</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> digest[MD5_DIGEST_LENGTH];</span><br><span class="line">    <span class="type">char</span> *etag = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">33</span>); <span class="comment">// 32个字符 + 1个结束符</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (etag == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    MD5_CTX ctx;</span><br><span class="line">    MD5_Init(&amp;ctx);</span><br><span class="line">    MD5_Update(&amp;ctx, content, length);</span><br><span class="line">    MD5_Final(digest, &amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 转换为十六进制字符串</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MD5_DIGEST_LENGTH; i++) &#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(&amp;etag[i * <span class="number">2</span>], <span class="string">&quot;%02x&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)digest[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    etag[<span class="number">32</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> etag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-2-WebSocket支持"><a href="#5-2-WebSocket支持" class="headerlink" title="5.2 WebSocket支持"></a>5.2 WebSocket支持</h2><h3 id="5-2-1-WebSocket头文件（websocket-h）"><a href="#5-2-1-WebSocket头文件（websocket-h）" class="headerlink" title="5.2.1 WebSocket头文件（websocket.h）"></a>5.2.1 WebSocket头文件（websocket.h）</h3><p>c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/websocket.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> WEBSOCKET_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEBSOCKET_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/sha.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/evp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/bio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/buffer.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// WebSocket操作码</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    WS_OP_CONTINUATION = <span class="number">0x0</span>,</span><br><span class="line">    WS_OP_TEXT = <span class="number">0x1</span>,</span><br><span class="line">    WS_OP_BINARY = <span class="number">0x2</span>,</span><br><span class="line">    WS_OP_CLOSE = <span class="number">0x8</span>,</span><br><span class="line">    WS_OP_PING = <span class="number">0x9</span>,</span><br><span class="line">    WS_OP_PONG = <span class="number">0xA</span></span><br><span class="line">&#125; WsOpcode;</span><br><span class="line"></span><br><span class="line"><span class="comment">// WebSocket帧</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">uint8_t</span> fin : <span class="number">1</span>;           <span class="comment">// 是否为最终帧</span></span><br><span class="line">    <span class="type">uint8_t</span> rsv1 : <span class="number">1</span>;          <span class="comment">// 保留位1</span></span><br><span class="line">    <span class="type">uint8_t</span> rsv2 : <span class="number">1</span>;          <span class="comment">// 保留位2</span></span><br><span class="line">    <span class="type">uint8_t</span> rsv3 : <span class="number">1</span>;          <span class="comment">// 保留位3</span></span><br><span class="line">    <span class="type">uint8_t</span> opcode : <span class="number">4</span>;        <span class="comment">// 操作码</span></span><br><span class="line">    <span class="type">uint8_t</span> mask : <span class="number">1</span>;          <span class="comment">// 是否掩码</span></span><br><span class="line">    <span class="type">uint64_t</span> payload_len;      <span class="comment">// 载荷长度</span></span><br><span class="line">    <span class="type">uint8_t</span> masking_key[<span class="number">4</span>];    <span class="comment">// 掩码密钥</span></span><br><span class="line">    <span class="type">uint8_t</span> *payload_data;     <span class="comment">// 载荷数据</span></span><br><span class="line">    <span class="type">size_t</span> payload_size;       <span class="comment">// 载荷大小</span></span><br><span class="line">&#125; WsFrame;</span><br><span class="line"></span><br><span class="line"><span class="comment">// WebSocket连接</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> socket;                <span class="comment">// socket文件描述符</span></span><br><span class="line">    <span class="type">int</span> handshake_completed;   <span class="comment">// 握手是否完成</span></span><br><span class="line">    <span class="type">char</span> *path;                <span class="comment">// 请求路径</span></span><br><span class="line">    <span class="type">char</span> *origin;              <span class="comment">// 来源</span></span><br><span class="line">    <span class="type">char</span> *protocol;            <span class="comment">// 子协议</span></span><br><span class="line">    <span class="type">void</span> *user_data;           <span class="comment">// 用户数据</span></span><br><span class="line">    <span class="type">uint64_t</span> bytes_received;   <span class="comment">// 接收字节数</span></span><br><span class="line">    <span class="type">uint64_t</span> bytes_sent;       <span class="comment">// 发送字节数</span></span><br><span class="line">&#125; WsConnection;</span><br><span class="line"></span><br><span class="line"><span class="comment">// WebSocket服务器回调函数</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">void</span> (*on_open)(WsConnection *conn);</span><br><span class="line">    <span class="type">void</span> (*on_message)(WsConnection *conn, <span class="type">const</span> <span class="type">char</span> *message, <span class="type">size_t</span> length);</span><br><span class="line">    <span class="type">void</span> (*on_close)(WsConnection *conn);</span><br><span class="line">    <span class="type">void</span> (*on_error)(WsConnection *conn, <span class="type">const</span> <span class="type">char</span> *error);</span><br><span class="line">&#125; WsCallbacks;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成WebSocket握手响应</span></span><br><span class="line"><span class="type">char</span>* <span class="title function_">ws_generate_handshake_response</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *sec_websocket_key)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析WebSocket帧</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ws_parse_frame</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *data, <span class="type">size_t</span> length, WsFrame *frame)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构建WebSocket帧</span></span><br><span class="line"><span class="type">uint8_t</span>* <span class="title function_">ws_build_frame</span><span class="params">(<span class="type">const</span> WsFrame *frame, <span class="type">size_t</span> *output_length)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送WebSocket文本消息</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ws_send_text</span><span class="params">(WsConnection *conn, <span class="type">const</span> <span class="type">char</span> *text)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送WebSocket二进制消息</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ws_send_binary</span><span class="params">(WsConnection *conn, <span class="type">const</span> <span class="type">uint8_t</span> *data, <span class="type">size_t</span> length)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送WebSocket关闭帧</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ws_send_close</span><span class="params">(WsConnection *conn, <span class="type">uint16_t</span> code, <span class="type">const</span> <span class="type">char</span> *reason)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送WebSocket Ping帧</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ws_send_ping</span><span class="params">(WsConnection *conn)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送WebSocket Pong帧</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ws_send_pong</span><span class="params">(WsConnection *conn)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理WebSocket握手</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ws_handle_handshake</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *request, WsConnection *conn)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理WebSocket数据</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ws_handle_data</span><span class="params">(WsConnection *conn, <span class="type">const</span> <span class="type">uint8_t</span> *data, <span class="type">size_t</span> length, </span></span><br><span class="line"><span class="params">                   <span class="type">const</span> WsCallbacks *callbacks)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭WebSocket连接</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ws_close_connection</span><span class="params">(WsConnection *conn)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// WEBSOCKET_H</span></span></span><br></pre></td></tr></table></figure>



<h3 id="5-2-2-WebSocket实现（websocket-c）"><a href="#5-2-2-WebSocket实现（websocket-c）" class="headerlink" title="5.2.2 WebSocket实现（websocket.c）"></a>5.2.2 WebSocket实现（websocket.c）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/websocket.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/sha.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/evp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/bio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/buffer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/websocket.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/logger.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Base64编码</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span>* <span class="title function_">base64_encode</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *input, <span class="type">int</span> length)</span> &#123;</span><br><span class="line">    BIO *bmem, *b64;</span><br><span class="line">    BUF_MEM *bptr;</span><br><span class="line">    </span><br><span class="line">    b64 = BIO_new(BIO_f_base64());</span><br><span class="line">    bmem = BIO_new(BIO_s_mem());</span><br><span class="line">    b64 = BIO_push(b64, bmem);</span><br><span class="line">    </span><br><span class="line">    BIO_write(b64, input, length);</span><br><span class="line">    BIO_flush(b64);</span><br><span class="line">    BIO_get_mem_ptr(b64, &amp;bptr);</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> *buff = (<span class="type">char</span>*)<span class="built_in">malloc</span>(bptr-&gt;length + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (buff == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to allocate memory for base64 encoding&quot;</span>);</span><br><span class="line">        BIO_free_all(b64);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memcpy</span>(buff, bptr-&gt;data, bptr-&gt;length);</span><br><span class="line">    buff[bptr-&gt;length - <span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>; <span class="comment">// 去除换行符</span></span><br><span class="line">    </span><br><span class="line">    BIO_free_all(b64);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> buff;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成WebSocket握手响应</span></span><br><span class="line"><span class="type">char</span>* <span class="title function_">ws_generate_handshake_response</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *sec_websocket_key)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (sec_websocket_key == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// WebSocket握手魔术字符串</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *magic_string = <span class="string">&quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;</span>;</span><br><span class="line">    <span class="type">char</span> combined[<span class="number">512</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">snprintf</span>(combined, <span class="keyword">sizeof</span>(combined), <span class="string">&quot;%s%s&quot;</span>, sec_websocket_key, magic_string);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算SHA-1哈希</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> digest[SHA_DIGEST_LENGTH];</span><br><span class="line">    SHA1((<span class="type">unsigned</span> <span class="type">char</span>*)combined, <span class="built_in">strlen</span>(combined), digest);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Base64编码</span></span><br><span class="line">    <span class="type">char</span> *accept_key = base64_encode(digest, SHA_DIGEST_LENGTH);</span><br><span class="line">    <span class="keyword">if</span> (accept_key == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建HTTP响应</span></span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> response_template[] = </span><br><span class="line">        <span class="string">&quot;HTTP/1.1 101 Switching Protocols\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Upgrade: websocket\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Connection: Upgrade\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Sec-WebSocket-Accept: %s\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Sec-WebSocket-Version: 13\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> *response = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">1024</span>);</span><br><span class="line">    <span class="keyword">if</span> (response == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">free</span>(accept_key);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">snprintf</span>(response, <span class="number">1024</span>, response_template, accept_key);</span><br><span class="line">    <span class="built_in">free</span>(accept_key);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析WebSocket帧</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ws_parse_frame</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *data, <span class="type">size_t</span> length, WsFrame *frame)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (data == <span class="literal">NULL</span> || frame == <span class="literal">NULL</span> || length &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 解析第一个字节</span></span><br><span class="line">    frame-&gt;fin = (data[<span class="number">0</span>] &gt;&gt; <span class="number">7</span>) &amp; <span class="number">0x1</span>;</span><br><span class="line">    frame-&gt;rsv1 = (data[<span class="number">0</span>] &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x1</span>;</span><br><span class="line">    frame-&gt;rsv2 = (data[<span class="number">0</span>] &gt;&gt; <span class="number">5</span>) &amp; <span class="number">0x1</span>;</span><br><span class="line">    frame-&gt;rsv3 = (data[<span class="number">0</span>] &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0x1</span>;</span><br><span class="line">    frame-&gt;opcode = data[<span class="number">0</span>] &amp; <span class="number">0xF</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 解析第二个字节</span></span><br><span class="line">    frame-&gt;mask = (data[<span class="number">1</span>] &gt;&gt; <span class="number">7</span>) &amp; <span class="number">0x1</span>;</span><br><span class="line">    frame-&gt;payload_len = data[<span class="number">1</span>] &amp; <span class="number">0x7F</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">size_t</span> header_size = <span class="number">2</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 处理扩展载荷长度</span></span><br><span class="line">    <span class="keyword">if</span> (frame-&gt;payload_len == <span class="number">126</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (length &lt; <span class="number">4</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        frame-&gt;payload_len = (data[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>) | data[<span class="number">3</span>];</span><br><span class="line">        header_size += <span class="number">2</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (frame-&gt;payload_len == <span class="number">127</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (length &lt; <span class="number">10</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        frame-&gt;payload_len = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">            frame-&gt;payload_len = (frame-&gt;payload_len &lt;&lt; <span class="number">8</span>) | data[<span class="number">2</span> + i];</span><br><span class="line">        &#125;</span><br><span class="line">        header_size += <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 处理掩码密钥</span></span><br><span class="line">    <span class="keyword">if</span> (frame-&gt;mask) &#123;</span><br><span class="line">        <span class="keyword">if</span> (length &lt; header_size + <span class="number">4</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="built_in">memcpy</span>(frame-&gt;masking_key, data + header_size, <span class="number">4</span>);</span><br><span class="line">        header_size += <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查载荷数据是否完整</span></span><br><span class="line">    <span class="keyword">if</span> (length &lt; header_size + frame-&gt;payload_len) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>; <span class="comment">// 数据不完整</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 复制载荷数据</span></span><br><span class="line">    frame-&gt;payload_data = (<span class="type">uint8_t</span>*)<span class="built_in">malloc</span>(frame-&gt;payload_len);</span><br><span class="line">    <span class="keyword">if</span> (frame-&gt;payload_data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memcpy</span>(frame-&gt;payload_data, data + header_size, frame-&gt;payload_len);</span><br><span class="line">    frame-&gt;payload_size = frame-&gt;payload_len;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果数据被掩码，解码</span></span><br><span class="line">    <span class="keyword">if</span> (frame-&gt;mask) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; frame-&gt;payload_len; i++) &#123;</span><br><span class="line">            frame-&gt;payload_data[i] ^= frame-&gt;masking_key[i % <span class="number">4</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> header_size + frame-&gt;payload_len; <span class="comment">// 返回处理的字节数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构建WebSocket帧</span></span><br><span class="line"><span class="type">uint8_t</span>* <span class="title function_">ws_build_frame</span><span class="params">(<span class="type">const</span> WsFrame *frame, <span class="type">size_t</span> *output_length)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (frame == <span class="literal">NULL</span> || output_length == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算帧头大小</span></span><br><span class="line">    <span class="type">size_t</span> header_size = <span class="number">2</span>; <span class="comment">// 基本头部</span></span><br><span class="line">    <span class="keyword">if</span> (frame-&gt;payload_len &gt; <span class="number">125</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (frame-&gt;payload_len &lt;= <span class="number">65535</span>) &#123;</span><br><span class="line">            header_size += <span class="number">2</span>; <span class="comment">// 2字节扩展长度</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            header_size += <span class="number">8</span>; <span class="comment">// 8字节扩展长度</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (frame-&gt;mask) &#123;</span><br><span class="line">        header_size += <span class="number">4</span>; <span class="comment">// 掩码密钥</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 分配内存</span></span><br><span class="line">    <span class="type">uint8_t</span> *buffer = (<span class="type">uint8_t</span>*)<span class="built_in">malloc</span>(header_size + frame-&gt;payload_len);</span><br><span class="line">    <span class="keyword">if</span> (buffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to allocate memory for WebSocket frame&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建第一个字节</span></span><br><span class="line">    buffer[<span class="number">0</span>] = (frame-&gt;fin &lt;&lt; <span class="number">7</span>) |</span><br><span class="line">                (frame-&gt;rsv1 &lt;&lt; <span class="number">6</span>) |</span><br><span class="line">                (frame-&gt;rsv2 &lt;&lt; <span class="number">5</span>) |</span><br><span class="line">                (frame-&gt;rsv3 &lt;&lt; <span class="number">4</span>) |</span><br><span class="line">                (frame-&gt;opcode &amp; <span class="number">0xF</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建第二个字节</span></span><br><span class="line">    buffer[<span class="number">1</span>] = (frame-&gt;mask &lt;&lt; <span class="number">7</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置载荷长度</span></span><br><span class="line">    <span class="type">size_t</span> offset = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (frame-&gt;payload_len &lt;= <span class="number">125</span>) &#123;</span><br><span class="line">        buffer[<span class="number">1</span>] |= frame-&gt;payload_len;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (frame-&gt;payload_len &lt;= <span class="number">65535</span>) &#123;</span><br><span class="line">        buffer[<span class="number">1</span>] |= <span class="number">126</span>;</span><br><span class="line">        buffer[<span class="number">2</span>] = (frame-&gt;payload_len &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">        buffer[<span class="number">3</span>] = frame-&gt;payload_len &amp; <span class="number">0xFF</span>;</span><br><span class="line">        offset = <span class="number">4</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        buffer[<span class="number">1</span>] |= <span class="number">127</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">7</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            buffer[<span class="number">2</span> + (<span class="number">7</span> - i)] = (frame-&gt;payload_len &gt;&gt; (i * <span class="number">8</span>)) &amp; <span class="number">0xFF</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        offset = <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加掩码密钥</span></span><br><span class="line">    <span class="keyword">if</span> (frame-&gt;mask) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(buffer + offset, frame-&gt;masking_key, <span class="number">4</span>);</span><br><span class="line">        offset += <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加载荷数据</span></span><br><span class="line">    <span class="keyword">if</span> (frame-&gt;payload_len &gt; <span class="number">0</span> &amp;&amp; frame-&gt;payload_data != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果启用了掩码，先对数据进行掩码处理</span></span><br><span class="line">        <span class="keyword">if</span> (frame-&gt;mask) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; frame-&gt;payload_len; i++) &#123;</span><br><span class="line">                buffer[offset + i] = frame-&gt;payload_data[i] ^ frame-&gt;masking_key[i % <span class="number">4</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(buffer + offset, frame-&gt;payload_data, frame-&gt;payload_len);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    *output_length = header_size + frame-&gt;payload_len;</span><br><span class="line">    <span class="keyword">return</span> buffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送WebSocket文本消息</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ws_send_text</span><span class="params">(WsConnection *conn, <span class="type">const</span> <span class="type">char</span> *text)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="literal">NULL</span> || text == <span class="literal">NULL</span> || conn-&gt;socket &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">size_t</span> text_len = <span class="built_in">strlen</span>(text);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建帧</span></span><br><span class="line">    WsFrame frame;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;frame, <span class="number">0</span>, <span class="keyword">sizeof</span>(WsFrame));</span><br><span class="line">    </span><br><span class="line">    frame.fin = <span class="number">1</span>;</span><br><span class="line">    frame.opcode = WS_OP_TEXT;</span><br><span class="line">    frame.mask = <span class="number">0</span>; <span class="comment">// 服务器发送不需要掩码</span></span><br><span class="line">    frame.payload_len = text_len;</span><br><span class="line">    frame.payload_data = (<span class="type">uint8_t</span>*)text;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建帧数据</span></span><br><span class="line">    <span class="type">size_t</span> frame_len;</span><br><span class="line">    <span class="type">uint8_t</span> *frame_data = ws_build_frame(&amp;frame, &amp;frame_len);</span><br><span class="line">    <span class="keyword">if</span> (frame_data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发送</span></span><br><span class="line">    <span class="type">ssize_t</span> sent = send(conn-&gt;socket, frame_data, frame_len, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">free</span>(frame_data);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (sent != (<span class="type">ssize_t</span>)frame_len) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to send WebSocket text message&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    conn-&gt;bytes_sent += sent;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送WebSocket二进制消息</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ws_send_binary</span><span class="params">(WsConnection *conn, <span class="type">const</span> <span class="type">uint8_t</span> *data, <span class="type">size_t</span> length)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="literal">NULL</span> || data == <span class="literal">NULL</span> || length == <span class="number">0</span> || conn-&gt;socket &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建帧</span></span><br><span class="line">    WsFrame frame;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;frame, <span class="number">0</span>, <span class="keyword">sizeof</span>(WsFrame));</span><br><span class="line">    </span><br><span class="line">    frame.fin = <span class="number">1</span>;</span><br><span class="line">    frame.opcode = WS_OP_BINARY;</span><br><span class="line">    frame.mask = <span class="number">0</span>; <span class="comment">// 服务器发送不需要掩码</span></span><br><span class="line">    frame.payload_len = length;</span><br><span class="line">    frame.payload_data = (<span class="type">uint8_t</span>*)data; <span class="comment">// 注意：这里没有复制数据，直接引用</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 需要复制数据，因为原数据可能是const的</span></span><br><span class="line">    <span class="type">uint8_t</span> *data_copy = (<span class="type">uint8_t</span>*)<span class="built_in">malloc</span>(length);</span><br><span class="line">    <span class="keyword">if</span> (data_copy == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(data_copy, data, length);</span><br><span class="line">    frame.payload_data = data_copy;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建帧数据</span></span><br><span class="line">    <span class="type">size_t</span> frame_len;</span><br><span class="line">    <span class="type">uint8_t</span> *frame_data = ws_build_frame(&amp;frame, &amp;frame_len);</span><br><span class="line">    <span class="built_in">free</span>(data_copy);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (frame_data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发送</span></span><br><span class="line">    <span class="type">ssize_t</span> sent = send(conn-&gt;socket, frame_data, frame_len, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">free</span>(frame_data);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (sent != (<span class="type">ssize_t</span>)frame_len) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to send WebSocket binary message&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    conn-&gt;bytes_sent += sent;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送WebSocket关闭帧</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ws_send_close</span><span class="params">(WsConnection *conn, <span class="type">uint16_t</span> code, <span class="type">const</span> <span class="type">char</span> *reason)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="literal">NULL</span> || conn-&gt;socket &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建关闭帧载荷</span></span><br><span class="line">    <span class="type">size_t</span> payload_len = <span class="number">2</span>; <span class="comment">// 状态码</span></span><br><span class="line">    <span class="keyword">if</span> (reason != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        payload_len += <span class="built_in">strlen</span>(reason);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">uint8_t</span> *payload = (<span class="type">uint8_t</span>*)<span class="built_in">malloc</span>(payload_len);</span><br><span class="line">    <span class="keyword">if</span> (payload == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加状态码（网络字节序）</span></span><br><span class="line">    payload[<span class="number">0</span>] = (code &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">    payload[<span class="number">1</span>] = code &amp; <span class="number">0xFF</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加原因</span></span><br><span class="line">    <span class="keyword">if</span> (reason != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(payload + <span class="number">2</span>, reason, <span class="built_in">strlen</span>(reason));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建帧</span></span><br><span class="line">    WsFrame frame;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;frame, <span class="number">0</span>, <span class="keyword">sizeof</span>(WsFrame));</span><br><span class="line">    </span><br><span class="line">    frame.fin = <span class="number">1</span>;</span><br><span class="line">    frame.opcode = WS_OP_CLOSE;</span><br><span class="line">    frame.mask = <span class="number">0</span>;</span><br><span class="line">    frame.payload_len = payload_len;</span><br><span class="line">    frame.payload_data = payload;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建帧数据</span></span><br><span class="line">    <span class="type">size_t</span> frame_len;</span><br><span class="line">    <span class="type">uint8_t</span> *frame_data = ws_build_frame(&amp;frame, &amp;frame_len);</span><br><span class="line">    <span class="built_in">free</span>(payload);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (frame_data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发送</span></span><br><span class="line">    <span class="type">ssize_t</span> sent = send(conn-&gt;socket, frame_data, frame_len, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">free</span>(frame_data);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (sent != (<span class="type">ssize_t</span>)frame_len) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to send WebSocket close frame&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    conn-&gt;bytes_sent += sent;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送WebSocket Ping帧</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ws_send_ping</span><span class="params">(WsConnection *conn)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="literal">NULL</span> || conn-&gt;socket &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建Ping帧（可以包含应用数据，可选）</span></span><br><span class="line">    WsFrame frame;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;frame, <span class="number">0</span>, <span class="keyword">sizeof</span>(WsFrame));</span><br><span class="line">    </span><br><span class="line">    frame.fin = <span class="number">1</span>;</span><br><span class="line">    frame.opcode = WS_OP_PING;</span><br><span class="line">    frame.mask = <span class="number">0</span>;</span><br><span class="line">    frame.payload_len = <span class="number">0</span>;</span><br><span class="line">    frame.payload_data = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建帧数据</span></span><br><span class="line">    <span class="type">size_t</span> frame_len;</span><br><span class="line">    <span class="type">uint8_t</span> *frame_data = ws_build_frame(&amp;frame, &amp;frame_len);</span><br><span class="line">    <span class="keyword">if</span> (frame_data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发送</span></span><br><span class="line">    <span class="type">ssize_t</span> sent = send(conn-&gt;socket, frame_data, frame_len, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">free</span>(frame_data);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (sent != (<span class="type">ssize_t</span>)frame_len) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to send WebSocket ping frame&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    conn-&gt;bytes_sent += sent;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送WebSocket Pong帧</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ws_send_pong</span><span class="params">(WsConnection *conn)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="literal">NULL</span> || conn-&gt;socket &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建Pong帧</span></span><br><span class="line">    WsFrame frame;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;frame, <span class="number">0</span>, <span class="keyword">sizeof</span>(WsFrame));</span><br><span class="line">    </span><br><span class="line">    frame.fin = <span class="number">1</span>;</span><br><span class="line">    frame.opcode = WS_OP_PONG;</span><br><span class="line">    frame.mask = <span class="number">0</span>;</span><br><span class="line">    frame.payload_len = <span class="number">0</span>;</span><br><span class="line">    frame.payload_data = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建帧数据</span></span><br><span class="line">    <span class="type">size_t</span> frame_len;</span><br><span class="line">    <span class="type">uint8_t</span> *frame_data = ws_build_frame(&amp;frame, &amp;frame_len);</span><br><span class="line">    <span class="keyword">if</span> (frame_data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发送</span></span><br><span class="line">    <span class="type">ssize_t</span> sent = send(conn-&gt;socket, frame_data, frame_len, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">free</span>(frame_data);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (sent != (<span class="type">ssize_t</span>)frame_len) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to send WebSocket pong frame&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    conn-&gt;bytes_sent += sent;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理WebSocket握手</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ws_handle_handshake</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *request, WsConnection *conn)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (request == <span class="literal">NULL</span> || conn == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查是否为WebSocket升级请求</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(request, <span class="string">&quot;Upgrade: websocket&quot;</span>) == <span class="literal">NULL</span> ||</span><br><span class="line">        <span class="built_in">strstr</span>(request, <span class="string">&quot;Connection: Upgrade&quot;</span>) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 提取Sec-WebSocket-Key</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *key_start = <span class="built_in">strstr</span>(request, <span class="string">&quot;Sec-WebSocket-Key: &quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (key_start == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    key_start += <span class="built_in">strlen</span>(<span class="string">&quot;Sec-WebSocket-Key: &quot;</span>);</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *key_end = <span class="built_in">strstr</span>(key_start, <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (key_end == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> sec_key[<span class="number">256</span>];</span><br><span class="line">    <span class="type">size_t</span> key_len = key_end - key_start;</span><br><span class="line">    <span class="keyword">if</span> (key_len &gt;= <span class="keyword">sizeof</span>(sec_key)) &#123;</span><br><span class="line">        key_len = <span class="keyword">sizeof</span>(sec_key) - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">strncpy</span>(sec_key, key_start, key_len);</span><br><span class="line">    sec_key[key_len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 生成握手响应</span></span><br><span class="line">    <span class="type">char</span> *response = ws_generate_handshake_response(sec_key);</span><br><span class="line">    <span class="keyword">if</span> (response == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发送握手响应</span></span><br><span class="line">    <span class="type">size_t</span> response_len = <span class="built_in">strlen</span>(response);</span><br><span class="line">    <span class="type">ssize_t</span> sent = send(conn-&gt;socket, response, response_len, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">free</span>(response);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (sent != (<span class="type">ssize_t</span>)response_len) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to send WebSocket handshake response&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置握手完成标志</span></span><br><span class="line">    conn-&gt;handshake_completed = <span class="number">1</span>;</span><br><span class="line">    conn-&gt;bytes_sent += sent;</span><br><span class="line">    </span><br><span class="line">    LOG_DEBUG(<span class="string">&quot;WebSocket handshake completed&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理WebSocket数据</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ws_handle_data</span><span class="params">(WsConnection *conn, <span class="type">const</span> <span class="type">uint8_t</span> *data, <span class="type">size_t</span> length, </span></span><br><span class="line"><span class="params">                   <span class="type">const</span> WsCallbacks *callbacks)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="literal">NULL</span> || data == <span class="literal">NULL</span> || length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果没有握手完成，先处理握手</span></span><br><span class="line">    <span class="keyword">if</span> (!conn-&gt;handshake_completed) &#123;</span><br><span class="line">        <span class="comment">// 检查是否为HTTP请求</span></span><br><span class="line">        <span class="keyword">if</span> (length &gt;= <span class="number">3</span> &amp;&amp; <span class="built_in">memcmp</span>(data, <span class="string">&quot;GET&quot;</span>, <span class="number">3</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 转换为字符串处理握手</span></span><br><span class="line">            <span class="type">char</span> *request = (<span class="type">char</span>*)<span class="built_in">malloc</span>(length + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (request == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">memcpy</span>(request, data, length);</span><br><span class="line">            request[length] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="type">int</span> result = ws_handle_handshake(request, conn);</span><br><span class="line">            <span class="built_in">free</span>(request);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (result == <span class="number">0</span> &amp;&amp; callbacks != <span class="literal">NULL</span> &amp;&amp; callbacks-&gt;on_open != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                callbacks-&gt;on_open(conn);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 解析WebSocket帧</span></span><br><span class="line">    WsFrame frame;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;frame, <span class="number">0</span>, <span class="keyword">sizeof</span>(WsFrame));</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> processed = ws_parse_frame(data, length, &amp;frame);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (processed &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (processed == <span class="number">-2</span>) &#123;</span><br><span class="line">            <span class="comment">// 数据不完整</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    conn-&gt;bytes_received += processed;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据操作码处理</span></span><br><span class="line">    <span class="keyword">switch</span> (frame.opcode) &#123;</span><br><span class="line">        <span class="keyword">case</span> WS_OP_TEXT: &#123;</span><br><span class="line">            <span class="comment">// 文本消息</span></span><br><span class="line">            <span class="keyword">if</span> (callbacks != <span class="literal">NULL</span> &amp;&amp; callbacks-&gt;on_message != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="type">char</span> *text = (<span class="type">char</span>*)<span class="built_in">malloc</span>(frame.payload_len + <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (text != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    <span class="built_in">memcpy</span>(text, frame.payload_data, frame.payload_len);</span><br><span class="line">                    text[frame.payload_len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                    callbacks-&gt;on_message(conn, text, frame.payload_len);</span><br><span class="line">                    <span class="built_in">free</span>(text);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">case</span> WS_OP_BINARY: &#123;</span><br><span class="line">            <span class="comment">// 二进制消息</span></span><br><span class="line">            <span class="keyword">if</span> (callbacks != <span class="literal">NULL</span> &amp;&amp; callbacks-&gt;on_message != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                callbacks-&gt;on_message(conn, (<span class="type">char</span>*)frame.payload_data, frame.payload_len);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">case</span> WS_OP_CLOSE: &#123;</span><br><span class="line">            <span class="comment">// 关闭帧</span></span><br><span class="line">            LOG_DEBUG(<span class="string">&quot;WebSocket close frame received&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (callbacks != <span class="literal">NULL</span> &amp;&amp; callbacks-&gt;on_close != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                callbacks-&gt;on_close(conn);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 发送关闭确认</span></span><br><span class="line">            ws_send_close(conn, <span class="number">1000</span>, <span class="string">&quot;Normal closure&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">case</span> WS_OP_PING: &#123;</span><br><span class="line">            <span class="comment">// Ping帧，需要回复Pong</span></span><br><span class="line">            LOG_DEBUG(<span class="string">&quot;WebSocket ping received&quot;</span>);</span><br><span class="line">            ws_send_pong(conn);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">case</span> WS_OP_PONG: &#123;</span><br><span class="line">            <span class="comment">// Pong帧，心跳响应</span></span><br><span class="line">            LOG_DEBUG(<span class="string">&quot;WebSocket pong received&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            LOG_WARNING(<span class="string">&quot;Unknown WebSocket opcode: %d&quot;</span>, frame.opcode);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清理帧数据</span></span><br><span class="line">    <span class="keyword">if</span> (frame.payload_data != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">free</span>(frame.payload_data);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> processed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭WebSocket连接</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ws_close_connection</span><span class="params">(WsConnection *conn)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发送关闭帧</span></span><br><span class="line">    ws_send_close(conn, <span class="number">1000</span>, <span class="string">&quot;Server closing&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 关闭socket</span></span><br><span class="line">    <span class="keyword">if</span> (conn-&gt;socket &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        close(conn-&gt;socket);</span><br><span class="line">        conn-&gt;socket = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放资源</span></span><br><span class="line">    <span class="keyword">if</span> (conn-&gt;path != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">free</span>(conn-&gt;path);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (conn-&gt;origin != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">free</span>(conn-&gt;origin);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (conn-&gt;protocol != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">free</span>(conn-&gt;protocol);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">free</span>(conn);</span><br><span class="line">    </span><br><span class="line">    LOG_DEBUG(<span class="string">&quot;WebSocket connection closed&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-3-API网关特性"><a href="#5-3-API网关特性" class="headerlink" title="5.3 API网关特性"></a>5.3 API网关特性</h2><h3 id="5-3-1-API网关头文件（gateway-h）"><a href="#5-3-1-API网关头文件（gateway-h）" class="headerlink" title="5.3.1 API网关头文件（gateway.h）"></a>5.3.1 API网关头文件（gateway.h）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/gateway.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> GATEWAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GATEWAY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/request.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/response.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由匹配类型</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    ROUTE_EXACT,      <span class="comment">// 精确匹配</span></span><br><span class="line">    ROUTE_PREFIX,     <span class="comment">// 前缀匹配</span></span><br><span class="line">    ROUTE_REGEX,      <span class="comment">// 正则匹配</span></span><br><span class="line">    ROUTE_PARAM       <span class="comment">// 参数匹配</span></span><br><span class="line">&#125; RouteMatchType;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由处理函数类型</span></span><br><span class="line"><span class="keyword">typedef</span> HttpResponse* (*RouteHandler)(<span class="type">const</span> HttpRequest *req, <span class="type">void</span> *user_data);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由规则</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">RouteRule</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> *pattern;               <span class="comment">// 匹配模式</span></span><br><span class="line">    RouteMatchType match_type;   <span class="comment">// 匹配类型</span></span><br><span class="line">    RouteHandler handler;        <span class="comment">// 处理函数</span></span><br><span class="line">    <span class="type">void</span> *user_data;             <span class="comment">// 用户数据</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">RouteRule</span> *<span class="title">next</span>;</span>      <span class="comment">// 下一个路由</span></span><br><span class="line">&#125; RouteRule;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 中间件函数类型</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span> <span class="params">(*Middleware)</span><span class="params">(<span class="type">const</span> HttpRequest *req, HttpResponse *resp, <span class="type">void</span> *user_data)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 中间件</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">MiddlewareNode</span> &#123;</span></span><br><span class="line">    Middleware handler;          <span class="comment">// 中间件函数</span></span><br><span class="line">    <span class="type">void</span> *user_data;             <span class="comment">// 用户数据</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">MiddlewareNode</span> *<span class="title">next</span>;</span> <span class="comment">// 下一个中间件</span></span><br><span class="line">&#125; MiddlewareNode;</span><br><span class="line"></span><br><span class="line"><span class="comment">// API网关配置</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    RouteRule *routes;           <span class="comment">// 路由规则链表</span></span><br><span class="line">    MiddlewareNode *middlewares; <span class="comment">// 中间件链表</span></span><br><span class="line">    <span class="type">pthread_mutex_t</span> lock;        <span class="comment">// 互斥锁</span></span><br><span class="line">    <span class="type">int</span> enable_rate_limit;       <span class="comment">// 启用速率限制</span></span><br><span class="line">    <span class="type">int</span> enable_auth;             <span class="comment">// 启用认证</span></span><br><span class="line">    <span class="type">int</span> enable_caching;          <span class="comment">// 启用缓存</span></span><br><span class="line">    <span class="type">char</span> *auth_header;           <span class="comment">// 认证头部字段</span></span><br><span class="line">    <span class="type">int</span> rate_limit_per_minute;   <span class="comment">// 每分钟请求限制</span></span><br><span class="line">&#125; GatewayConfig;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 速率限制记录</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> *client_id;             <span class="comment">// 客户端标识</span></span><br><span class="line">    <span class="type">time_t</span> window_start;         <span class="comment">// 时间窗口开始时间</span></span><br><span class="line">    <span class="type">int</span> request_count;           <span class="comment">// 请求计数</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">RateLimitRecord</span> *<span class="title">next</span>;</span> <span class="comment">// 下一个记录</span></span><br><span class="line">&#125; RateLimitRecord;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化API网关</span></span><br><span class="line">GatewayConfig* <span class="title function_">gateway_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加路由</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">gateway_add_route</span><span class="params">(GatewayConfig *config, <span class="type">const</span> <span class="type">char</span> *pattern, </span></span><br><span class="line"><span class="params">                      RouteMatchType match_type, RouteHandler handler, <span class="type">void</span> *user_data)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加中间件</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">gateway_add_middleware</span><span class="params">(GatewayConfig *config, Middleware handler, <span class="type">void</span> *user_data)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 匹配路由</span></span><br><span class="line">RouteRule* <span class="title function_">gateway_match_route</span><span class="params">(GatewayConfig *config, <span class="type">const</span> <span class="type">char</span> *path)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理HTTP请求</span></span><br><span class="line">HttpResponse* <span class="title function_">gateway_handle_request</span><span class="params">(GatewayConfig *config, <span class="type">const</span> HttpRequest *req)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行中间件链</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">gateway_execute_middlewares</span><span class="params">(GatewayConfig *config, <span class="type">const</span> HttpRequest *req, HttpResponse *resp)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 应用速率限制</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">gateway_apply_rate_limit</span><span class="params">(GatewayConfig *config, <span class="type">const</span> HttpRequest *req)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证认证</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">gateway_authenticate</span><span class="params">(GatewayConfig *config, <span class="type">const</span> HttpRequest *req)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录API访问日志</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">gateway_log_access</span><span class="params">(<span class="type">const</span> HttpRequest *req, <span class="type">const</span> HttpResponse *resp, </span></span><br><span class="line"><span class="params">                       <span class="type">const</span> <span class="type">char</span> *client_ip, <span class="type">int</span> status)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清理API网关</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">gateway_cleanup</span><span class="params">(GatewayConfig *config)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 内置路由处理器示例</span></span><br><span class="line">HttpResponse* <span class="title function_">gateway_status_handler</span><span class="params">(<span class="type">const</span> HttpRequest *req, <span class="type">void</span> *user_data)</span>;</span><br><span class="line">HttpResponse* <span class="title function_">gateway_echo_handler</span><span class="params">(<span class="type">const</span> HttpRequest *req, <span class="type">void</span> *user_data)</span>;</span><br><span class="line">HttpResponse* <span class="title function_">gateway_file_handler</span><span class="params">(<span class="type">const</span> HttpRequest *req, <span class="type">void</span> *user_data)</span>;</span><br><span class="line">HttpResponse* <span class="title function_">gateway_proxy_handler</span><span class="params">(<span class="type">const</span> HttpRequest *req, <span class="type">void</span> *user_data)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// GATEWAY_H</span></span></span><br></pre></td></tr></table></figure>



<h3 id="5-3-2-API网关实现（gateway-c）"><a href="#5-3-2-API网关实现（gateway-c）" class="headerlink" title="5.3.2 API网关实现（gateway.c）"></a>5.3.2 API网关实现（gateway.c）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/gateway.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;regex.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/gateway.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/request.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/response.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/logger.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line"><span class="type">static</span> GatewayConfig *global_gateway = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">static</span> RateLimitRecord *rate_limit_records = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">pthread_mutex_t</span> rate_limit_lock = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化API网关</span></span><br><span class="line">GatewayConfig* <span class="title function_">gateway_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    GatewayConfig *config = (GatewayConfig*)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(GatewayConfig));</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to allocate memory for gateway config&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    config-&gt;routes = <span class="literal">NULL</span>;</span><br><span class="line">    config-&gt;middlewares = <span class="literal">NULL</span>;</span><br><span class="line">    config-&gt;enable_rate_limit = <span class="number">0</span>;</span><br><span class="line">    config-&gt;enable_auth = <span class="number">0</span>;</span><br><span class="line">    config-&gt;enable_caching = <span class="number">0</span>;</span><br><span class="line">    config-&gt;rate_limit_per_minute = <span class="number">60</span>; <span class="comment">// 默认60请求/分钟</span></span><br><span class="line">    config-&gt;auth_header = strdup(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (pthread_mutex_init(&amp;config-&gt;lock, <span class="literal">NULL</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        LOG_ERROR(<span class="string">&quot;Failed to initialize gateway mutex&quot;</span>);</span><br><span class="line">        <span class="built_in">free</span>(config-&gt;auth_header);</span><br><span class="line">        <span class="built_in">free</span>(config);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    global_gateway = config;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加默认路由</span></span><br><span class="line">    gateway_add_route(config, <span class="string">&quot;/api/status&quot;</span>, ROUTE_EXACT, gateway_status_handler, <span class="literal">NULL</span>);</span><br><span class="line">    gateway_add_route(config, <span class="string">&quot;/api/echo&quot;</span>, ROUTE_EXACT, gateway_echo_handler, <span class="literal">NULL</span>);</span><br><span class="line">    gateway_add_route(config, <span class="string">&quot;/api/files/*&quot;</span>, ROUTE_PREFIX, gateway_file_handler, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;API Gateway initialized&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建路由规则</span></span><br><span class="line"><span class="type">static</span> RouteRule* <span class="title function_">create_route_rule</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pattern, RouteMatchType match_type, </span></span><br><span class="line"><span class="params">                                    RouteHandler handler, <span class="type">void</span> *user_data)</span> &#123;</span><br><span class="line">    RouteRule *rule = (RouteRule*)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(RouteRule));</span><br><span class="line">    <span class="keyword">if</span> (rule == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    rule-&gt;pattern = strdup(pattern);</span><br><span class="line">    <span class="keyword">if</span> (rule-&gt;pattern == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">free</span>(rule);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    rule-&gt;match_type = match_type;</span><br><span class="line">    rule-&gt;handler = handler;</span><br><span class="line">    rule-&gt;user_data = user_data;</span><br><span class="line">    rule-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> rule;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加路由</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">gateway_add_route</span><span class="params">(GatewayConfig *config, <span class="type">const</span> <span class="type">char</span> *pattern, </span></span><br><span class="line"><span class="params">                      RouteMatchType match_type, RouteHandler handler, <span class="type">void</span> *user_data)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="literal">NULL</span> || pattern == <span class="literal">NULL</span> || handler == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_lock(&amp;config-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建新路由规则</span></span><br><span class="line">    RouteRule *new_rule = create_route_rule(pattern, match_type, handler, user_data);</span><br><span class="line">    <span class="keyword">if</span> (new_rule == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        pthread_mutex_unlock(&amp;config-&gt;lock);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加到链表头部</span></span><br><span class="line">    new_rule-&gt;next = config-&gt;routes;</span><br><span class="line">    config-&gt;routes = new_rule;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_unlock(&amp;config-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    LOG_DEBUG(<span class="string">&quot;Route added: %s (type=%d)&quot;</span>, pattern, match_type);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建中间件节点</span></span><br><span class="line"><span class="type">static</span> MiddlewareNode* <span class="title function_">create_middleware_node</span><span class="params">(Middleware handler, <span class="type">void</span> *user_data)</span> &#123;</span><br><span class="line">    MiddlewareNode *node = (MiddlewareNode*)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(MiddlewareNode));</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    node-&gt;handler = handler;</span><br><span class="line">    node-&gt;user_data = user_data;</span><br><span class="line">    node-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加中间件</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">gateway_add_middleware</span><span class="params">(GatewayConfig *config, Middleware handler, <span class="type">void</span> *user_data)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="literal">NULL</span> || handler == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_lock(&amp;config-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建新中间件节点</span></span><br><span class="line">    MiddlewareNode *new_node = create_middleware_node(handler, user_data);</span><br><span class="line">    <span class="keyword">if</span> (new_node == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        pthread_mutex_unlock(&amp;config-&gt;lock);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加到链表头部</span></span><br><span class="line">    new_node-&gt;next = config-&gt;middlewares;</span><br><span class="line">    config-&gt;middlewares = new_node;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_unlock(&amp;config-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    LOG_DEBUG(<span class="string">&quot;Middleware added&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 匹配路由</span></span><br><span class="line">RouteRule* <span class="title function_">gateway_match_route</span><span class="params">(GatewayConfig *config, <span class="type">const</span> <span class="type">char</span> *path)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="literal">NULL</span> || path == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_lock(&amp;config-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    RouteRule *rule = config-&gt;routes;</span><br><span class="line">    <span class="keyword">while</span> (rule != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (rule-&gt;match_type) &#123;</span><br><span class="line">            <span class="keyword">case</span> ROUTE_EXACT:</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">strcmp</span>(path, rule-&gt;pattern) == <span class="number">0</span>) &#123;</span><br><span class="line">                    pthread_mutex_unlock(&amp;config-&gt;lock);</span><br><span class="line">                    <span class="keyword">return</span> rule;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> ROUTE_PREFIX:</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">strncmp</span>(path, rule-&gt;pattern, <span class="built_in">strlen</span>(rule-&gt;pattern)) == <span class="number">0</span>) &#123;</span><br><span class="line">                    pthread_mutex_unlock(&amp;config-&gt;lock);</span><br><span class="line">                    <span class="keyword">return</span> rule;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> ROUTE_REGEX: &#123;</span><br><span class="line">                <span class="type">regex_t</span> regex;</span><br><span class="line">                <span class="type">int</span> ret = regcomp(&amp;regex, rule-&gt;pattern, REG_EXTENDED);</span><br><span class="line">                <span class="keyword">if</span> (ret == <span class="number">0</span>) &#123;</span><br><span class="line">                    ret = regexec(&amp;regex, path, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">                    regfree(&amp;regex);</span><br><span class="line">                    <span class="keyword">if</span> (ret == <span class="number">0</span>) &#123;</span><br><span class="line">                        pthread_mutex_unlock(&amp;config-&gt;lock);</span><br><span class="line">                        <span class="keyword">return</span> rule;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">case</span> ROUTE_PARAM:</span><br><span class="line">                <span class="comment">// 简单的参数匹配：/users/:id</span></span><br><span class="line">                <span class="comment">// 这里简化处理，实际需要更复杂的解析</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="type">const</span> <span class="type">char</span> *pattern_ptr = rule-&gt;pattern;</span><br><span class="line">                    <span class="type">const</span> <span class="type">char</span> *path_ptr = path;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">while</span> (*pattern_ptr &amp;&amp; *path_ptr) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (*pattern_ptr == <span class="string">&#x27;:&#x27;</span> &amp;&amp; *(pattern_ptr + <span class="number">1</span>) != <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">                            <span class="comment">// 跳过参数部分</span></span><br><span class="line">                            pattern_ptr += <span class="number">2</span>; <span class="comment">// 跳过&quot;:&quot;</span></span><br><span class="line">                            <span class="comment">// 跳过路径中的参数值</span></span><br><span class="line">                            <span class="keyword">while</span> (*path_ptr &amp;&amp; *path_ptr != <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">                                path_ptr++;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (*pattern_ptr == *path_ptr) &#123;</span><br><span class="line">                            pattern_ptr++;</span><br><span class="line">                            path_ptr++;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (*pattern_ptr == <span class="string">&#x27;\0&#x27;</span> &amp;&amp; *path_ptr == <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">                        pthread_mutex_unlock(&amp;config-&gt;lock);</span><br><span class="line">                        <span class="keyword">return</span> rule;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        rule = rule-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_unlock(&amp;config-&gt;lock);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行中间件链</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">gateway_execute_middlewares</span><span class="params">(GatewayConfig *config, <span class="type">const</span> HttpRequest *req, HttpResponse *resp)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="literal">NULL</span> || req == <span class="literal">NULL</span> || resp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_lock(&amp;config-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    MiddlewareNode *middleware = config-&gt;middlewares;</span><br><span class="line">    <span class="keyword">while</span> (middleware != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="type">int</span> result = middleware-&gt;handler(req, resp, middleware-&gt;user_data);</span><br><span class="line">        <span class="keyword">if</span> (result != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 中间件返回非0值，停止执行</span></span><br><span class="line">            pthread_mutex_unlock(&amp;config-&gt;lock);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        middleware = middleware-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_unlock(&amp;config-&gt;lock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取客户端标识</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span>* <span class="title function_">get_client_identifier</span><span class="params">(<span class="type">const</span> HttpRequest *req)</span> &#123;</span><br><span class="line">    <span class="comment">// 使用IP地址作为客户端标识</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *xff = get_header_value(req, <span class="string">&quot;X-Forwarded-For&quot;</span>);</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *real_ip = get_header_value(req, <span class="string">&quot;X-Real-IP&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> *identifier = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (real_ip != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        identifier = strdup(real_ip);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (xff != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// 取第一个IP</span></span><br><span class="line">        <span class="type">char</span> *comma = <span class="built_in">strchr</span>(xff, <span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (comma != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="type">size_t</span> len = comma - xff;</span><br><span class="line">            identifier = (<span class="type">char</span>*)<span class="built_in">malloc</span>(len + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (identifier != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="built_in">strncpy</span>(identifier, xff, len);</span><br><span class="line">                identifier[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            identifier = strdup(xff);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果没有代理头部，使用一个默认标识</span></span><br><span class="line">        identifier = strdup(<span class="string">&quot;unknown&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> identifier;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清理过期速率限制记录</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">cleanup_expired_rate_records</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    pthread_mutex_lock(&amp;rate_limit_lock);</span><br><span class="line">    </span><br><span class="line">    <span class="type">time_t</span> now = time(<span class="literal">NULL</span>);</span><br><span class="line">    RateLimitRecord **ptr = &amp;rate_limit_records;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (*ptr != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        RateLimitRecord *current = *ptr;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果时间窗口已过（超过1分钟），删除记录</span></span><br><span class="line">        <span class="keyword">if</span> (now - current-&gt;window_start &gt; <span class="number">60</span>) &#123;</span><br><span class="line">            *ptr = current-&gt;next;</span><br><span class="line">            <span class="built_in">free</span>(current-&gt;client_id);</span><br><span class="line">            <span class="built_in">free</span>(current);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ptr = &amp;current-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_unlock(&amp;rate_limit_lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 应用速率限制</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">gateway_apply_rate_limit</span><span class="params">(GatewayConfig *config, <span class="type">const</span> HttpRequest *req)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="literal">NULL</span> || !config-&gt;enable_rate_limit) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 速率限制未启用</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    cleanup_expired_rate_records();</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> *client_id = get_client_identifier(req);</span><br><span class="line">    <span class="keyword">if</span> (client_id == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">time_t</span> now = time(<span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_lock(&amp;rate_limit_lock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 查找现有记录</span></span><br><span class="line">    RateLimitRecord *record = rate_limit_records;</span><br><span class="line">    RateLimitRecord *prev = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (record != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(record-&gt;client_id, client_id) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        prev = record;</span><br><span class="line">        record = record-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (record == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// 创建新记录</span></span><br><span class="line">        record = (RateLimitRecord*)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(RateLimitRecord));</span><br><span class="line">        <span class="keyword">if</span> (record == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            pthread_mutex_unlock(&amp;rate_limit_lock);</span><br><span class="line">            <span class="built_in">free</span>(client_id);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        record-&gt;client_id = client_id;</span><br><span class="line">        record-&gt;window_start = now;</span><br><span class="line">        record-&gt;request_count = <span class="number">1</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 添加到链表</span></span><br><span class="line">        <span class="keyword">if</span> (prev == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            record-&gt;next = rate_limit_records;</span><br><span class="line">            rate_limit_records = record;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            record-&gt;next = prev-&gt;next;</span><br><span class="line">            prev-&gt;next = record;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        pthread_mutex_unlock(&amp;rate_limit_lock);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查时间窗口</span></span><br><span class="line">    <span class="keyword">if</span> (now - record-&gt;window_start &gt; <span class="number">60</span>) &#123;</span><br><span class="line">        <span class="comment">// 新时间窗口</span></span><br><span class="line">        record-&gt;window_start = now;</span><br><span class="line">        record-&gt;request_count = <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 增加计数</span></span><br><span class="line">        record-&gt;request_count++;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (record-&gt;request_count &gt; config-&gt;rate_limit_per_minute) &#123;</span><br><span class="line">            pthread_mutex_unlock(&amp;rate_limit_lock);</span><br><span class="line">            <span class="built_in">free</span>(client_id);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">// 超过限制</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_unlock(&amp;rate_limit_lock);</span><br><span class="line">    <span class="built_in">free</span>(client_id);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证认证</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">gateway_authenticate</span><span class="params">(GatewayConfig *config, <span class="type">const</span> HttpRequest *req)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="literal">NULL</span> || !config-&gt;enable_auth) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 认证未启用</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *auth_header = get_header_value(req, config-&gt;auth_header);</span><br><span class="line">    <span class="keyword">if</span> (auth_header == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">// 缺少认证头部</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 简单的Bearer Token验证</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *bearer_prefix = <span class="string">&quot;Bearer &quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strncmp</span>(auth_header, bearer_prefix, <span class="built_in">strlen</span>(bearer_prefix)) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *token = auth_header + <span class="built_in">strlen</span>(bearer_prefix);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 这里应该验证token的有效性</span></span><br><span class="line">        <span class="comment">// 简化处理：检查token是否为&quot;secret-token&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(token, <span class="string">&quot;secret-token&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 认证成功</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">// 认证失败</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理HTTP请求</span></span><br><span class="line">HttpResponse* <span class="title function_">gateway_handle_request</span><span class="params">(GatewayConfig *config, <span class="type">const</span> HttpRequest *req)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="literal">NULL</span> || req == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建默认响应</span></span><br><span class="line">    HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_200_OK);</span><br><span class="line">    <span class="keyword">if</span> (resp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行中间件</span></span><br><span class="line">    <span class="type">int</span> middleware_result = gateway_execute_middlewares(config, req, resp);</span><br><span class="line">    <span class="keyword">if</span> (middleware_result != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 中间件已设置响应</span></span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 应用速率限制</span></span><br><span class="line">    <span class="keyword">if</span> (gateway_apply_rate_limit(config, req) != <span class="number">0</span>) &#123;</span><br><span class="line">        resp-&gt;status_code = HTTP_429_TOO_MANY_REQUESTS;</span><br><span class="line">        set_response_json(resp, <span class="string">&quot;&#123;\&quot;error\&quot;: \&quot;Rate limit exceeded\&quot;&#125;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 验证认证</span></span><br><span class="line">    <span class="keyword">if</span> (gateway_authenticate(config, req) != <span class="number">0</span>) &#123;</span><br><span class="line">        resp-&gt;status_code = HTTP_401_UNAUTHORIZED;</span><br><span class="line">        set_response_json(resp, <span class="string">&quot;&#123;\&quot;error\&quot;: \&quot;Authentication required\&quot;&#125;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 匹配路由</span></span><br><span class="line">    RouteRule *route = gateway_match_route(config, req-&gt;path);</span><br><span class="line">    <span class="keyword">if</span> (route == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        resp-&gt;status_code = HTTP_404_NOT_FOUND;</span><br><span class="line">        set_response_json(resp, <span class="string">&quot;&#123;\&quot;error\&quot;: \&quot;Route not found\&quot;&#125;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行路由处理函数</span></span><br><span class="line">    HttpResponse *route_resp = route-&gt;handler(req, route-&gt;user_data);</span><br><span class="line">    <span class="keyword">if</span> (route_resp != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        free_http_response(resp);</span><br><span class="line">        <span class="keyword">return</span> route_resp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> resp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录API访问日志</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">gateway_log_access</span><span class="params">(<span class="type">const</span> HttpRequest *req, <span class="type">const</span> HttpResponse *resp, </span></span><br><span class="line"><span class="params">                       <span class="type">const</span> <span class="type">char</span> *client_ip, <span class="type">int</span> status)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (req == <span class="literal">NULL</span> || resp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">time_t</span> now = time(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="type">char</span> time_str[<span class="number">64</span>];</span><br><span class="line">    strftime(time_str, <span class="keyword">sizeof</span>(time_str), <span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>, localtime(&amp;now));</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;[API] %s - %s %s %d %d %s&quot;</span>, </span><br><span class="line">             time_str, client_ip ? client_ip : <span class="string">&quot;unknown&quot;</span>,</span><br><span class="line">             req-&gt;path, resp-&gt;status_code, (<span class="type">int</span>)resp-&gt;content_length,</span><br><span class="line">             http_method_to_string(req-&gt;method));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清理API网关</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">gateway_cleanup</span><span class="params">(GatewayConfig *config)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清理路由</span></span><br><span class="line">    RouteRule *route = config-&gt;routes;</span><br><span class="line">    <span class="keyword">while</span> (route != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        RouteRule *next = route-&gt;next;</span><br><span class="line">        <span class="built_in">free</span>(route-&gt;pattern);</span><br><span class="line">        <span class="built_in">free</span>(route);</span><br><span class="line">        route = next;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清理中间件</span></span><br><span class="line">    MiddlewareNode *middleware = config-&gt;middlewares;</span><br><span class="line">    <span class="keyword">while</span> (middleware != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        MiddlewareNode *next = middleware-&gt;next;</span><br><span class="line">        <span class="built_in">free</span>(middleware);</span><br><span class="line">        middleware = next;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清理认证头部</span></span><br><span class="line">    <span class="keyword">if</span> (config-&gt;auth_header != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">free</span>(config-&gt;auth_header);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 销毁互斥锁</span></span><br><span class="line">    pthread_mutex_destroy(&amp;config-&gt;lock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清理速率限制记录</span></span><br><span class="line">    pthread_mutex_lock(&amp;rate_limit_lock);</span><br><span class="line">    RateLimitRecord *record = rate_limit_records;</span><br><span class="line">    <span class="keyword">while</span> (record != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        RateLimitRecord *next = record-&gt;next;</span><br><span class="line">        <span class="built_in">free</span>(record-&gt;client_id);</span><br><span class="line">        <span class="built_in">free</span>(record);</span><br><span class="line">        record = next;</span><br><span class="line">    &#125;</span><br><span class="line">    rate_limit_records = <span class="literal">NULL</span>;</span><br><span class="line">    pthread_mutex_unlock(&amp;rate_limit_lock);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">free</span>(config);</span><br><span class="line">    global_gateway = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    LOG_INFO(<span class="string">&quot;API Gateway cleaned up&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 内置处理器：状态检查</span></span><br><span class="line">HttpResponse* <span class="title function_">gateway_status_handler</span><span class="params">(<span class="type">const</span> HttpRequest *req, <span class="type">void</span> *user_data)</span> &#123;</span><br><span class="line">    (<span class="type">void</span>)user_data;</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> json[<span class="number">512</span>];</span><br><span class="line">    <span class="built_in">snprintf</span>(json, <span class="keyword">sizeof</span>(json),</span><br><span class="line">            <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;  \&quot;status\&quot;: \&quot;online\&quot;,\n&quot;</span></span><br><span class="line">            <span class="string">&quot;  \&quot;service\&quot;: \&quot;API Gateway\&quot;,\n&quot;</span></span><br><span class="line">            <span class="string">&quot;  \&quot;version\&quot;: \&quot;1.0\&quot;,\n&quot;</span></span><br><span class="line">            <span class="string">&quot;  \&quot;timestamp\&quot;: %ld,\n&quot;</span></span><br><span class="line">            <span class="string">&quot;  \&quot;uptime\&quot;: \&quot;unknown\&quot;,\n&quot;</span></span><br><span class="line">            <span class="string">&quot;  \&quot;endpoints\&quot;: [\n&quot;</span></span><br><span class="line">            <span class="string">&quot;    \&quot;/api/status\&quot;,\n&quot;</span></span><br><span class="line">            <span class="string">&quot;    \&quot;/api/echo\&quot;,\n&quot;</span></span><br><span class="line">            <span class="string">&quot;    \&quot;/api/files/*\&quot;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;  ]\n&quot;</span></span><br><span class="line">            <span class="string">&quot;&#125;&quot;</span>,</span><br><span class="line">            time(<span class="literal">NULL</span>));</span><br><span class="line">    </span><br><span class="line">    HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_200_OK);</span><br><span class="line">    set_response_json(resp, json);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> resp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 内置处理器：回显</span></span><br><span class="line">HttpResponse* <span class="title function_">gateway_echo_handler</span><span class="params">(<span class="type">const</span> HttpRequest *req, <span class="type">void</span> *user_data)</span> &#123;</span><br><span class="line">    (<span class="type">void</span>)user_data;</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> json[<span class="number">1024</span>];</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *body = req-&gt;body ? req-&gt;body : <span class="string">&quot;null&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">snprintf</span>(json, <span class="keyword">sizeof</span>(json),</span><br><span class="line">            <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;  \&quot;method\&quot;: \&quot;%s\&quot;,\n&quot;</span></span><br><span class="line">            <span class="string">&quot;  \&quot;path\&quot;: \&quot;%s\&quot;,\n&quot;</span></span><br><span class="line">            <span class="string">&quot;  \&quot;headers\&quot;: &#123;\n&quot;</span>,</span><br><span class="line">            http_method_to_string(req-&gt;method),</span><br><span class="line">            req-&gt;path);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加请求头</span></span><br><span class="line">    <span class="type">char</span> temp[<span class="number">2048</span>];</span><br><span class="line">    <span class="type">char</span> *ptr = temp;</span><br><span class="line">    HttpHeader *header = req-&gt;headers;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (header != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ptr += <span class="built_in">snprintf</span>(ptr, <span class="keyword">sizeof</span>(temp) - (ptr - temp), </span><br><span class="line">                       <span class="string">&quot;    \&quot;%s\&quot;: \&quot;%s\&quot;,\n&quot;</span>, header-&gt;key, header-&gt;value);</span><br><span class="line">        header = header-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (ptr &gt; temp) &#123;</span><br><span class="line">        <span class="comment">// 移除最后一个逗号和换行</span></span><br><span class="line">        ptr -= <span class="number">2</span>;</span><br><span class="line">        *ptr = <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">        ptr++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">snprintf</span>(ptr, <span class="keyword">sizeof</span>(temp) - (ptr - temp),</span><br><span class="line">            <span class="string">&quot;  &#125;,\n&quot;</span></span><br><span class="line">            <span class="string">&quot;  \&quot;body\&quot;: %s,\n&quot;</span></span><br><span class="line">            <span class="string">&quot;  \&quot;timestamp\&quot;: %ld\n&quot;</span></span><br><span class="line">            <span class="string">&quot;&#125;&quot;</span>,</span><br><span class="line">            body, time(<span class="literal">NULL</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">strcat</span>(json, temp);</span><br><span class="line">    </span><br><span class="line">    HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_200_OK);</span><br><span class="line">    set_response_json(resp, json);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> resp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 内置处理器：文件服务</span></span><br><span class="line">HttpResponse* <span class="title function_">gateway_file_handler</span><span class="params">(<span class="type">const</span> HttpRequest *req, <span class="type">void</span> *user_data)</span> &#123;</span><br><span class="line">    (<span class="type">void</span>)user_data;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 从路径中提取文件名</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *base_path = <span class="string">&quot;/api/files/&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strncmp</span>(req-&gt;path, base_path, <span class="built_in">strlen</span>(base_path)) != <span class="number">0</span>) &#123;</span><br><span class="line">        HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_404_NOT_FOUND);</span><br><span class="line">        set_response_json(resp, <span class="string">&quot;&#123;\&quot;error\&quot;: \&quot;Invalid file path\&quot;&#125;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *filename = req-&gt;path + <span class="built_in">strlen</span>(base_path);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span>(filename) == <span class="number">0</span>) &#123;</span><br><span class="line">        HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_400_BAD_REQUEST);</span><br><span class="line">        set_response_json(resp, <span class="string">&quot;&#123;\&quot;error\&quot;: \&quot;Missing filename\&quot;&#125;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 安全检查：防止目录遍历</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(filename, <span class="string">&quot;..&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_403_FORBIDDEN);</span><br><span class="line">        set_response_json(resp, <span class="string">&quot;&#123;\&quot;error\&quot;: \&quot;Access denied\&quot;&#125;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建完整路径</span></span><br><span class="line">    <span class="type">char</span> full_path[<span class="number">1024</span>];</span><br><span class="line">    <span class="built_in">snprintf</span>(full_path, <span class="keyword">sizeof</span>(full_path), <span class="string">&quot;./uploads/%s&quot;</span>, filename);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查文件是否存在</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (stat(full_path, &amp;st) != <span class="number">0</span>) &#123;</span><br><span class="line">        HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_404_NOT_FOUND);</span><br><span class="line">        set_response_json(resp, <span class="string">&quot;&#123;\&quot;error\&quot;: \&quot;File not found\&quot;&#125;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (S_ISDIR(st.st_mode)) &#123;</span><br><span class="line">        HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_400_BAD_REQUEST);</span><br><span class="line">        set_response_json(resp, <span class="string">&quot;&#123;\&quot;error\&quot;: \&quot;Is a directory\&quot;&#125;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 读取文件</span></span><br><span class="line">    FILE *file = fopen(full_path, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_500_INTERNAL_SERVER_ERROR);</span><br><span class="line">        set_response_json(resp, <span class="string">&quot;&#123;\&quot;error\&quot;: \&quot;Failed to open file\&quot;&#125;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    fseek(file, <span class="number">0</span>, SEEK_END);</span><br><span class="line">    <span class="type">long</span> file_size = ftell(file);</span><br><span class="line">    fseek(file, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> *file_content = (<span class="type">char</span>*)<span class="built_in">malloc</span>(file_size);</span><br><span class="line">    <span class="keyword">if</span> (file_content == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        fclose(file);</span><br><span class="line">        HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_500_INTERNAL_SERVER_ERROR);</span><br><span class="line">        set_response_json(resp, <span class="string">&quot;&#123;\&quot;error\&quot;: \&quot;Memory allocation failed\&quot;&#125;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">size_t</span> bytes_read = fread(file_content, <span class="number">1</span>, file_size, file);</span><br><span class="line">    fclose(file);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (bytes_read != (<span class="type">size_t</span>)file_size) &#123;</span><br><span class="line">        <span class="built_in">free</span>(file_content);</span><br><span class="line">        HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_500_INTERNAL_SERVER_ERROR);</span><br><span class="line">        set_response_json(resp, <span class="string">&quot;&#123;\&quot;error\&quot;: \&quot;Failed to read file\&quot;&#125;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建响应</span></span><br><span class="line">    HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_200_OK);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据文件类型设置Content-Type</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *ext = <span class="built_in">strrchr</span>(filename, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ext != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ext, <span class="string">&quot;.json&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            set_response_json(resp, file_content);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ext, <span class="string">&quot;.txt&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            set_response_body_string(resp, file_content);</span><br><span class="line">            add_response_header(resp, <span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/plain&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            set_response_body(resp, file_content, file_size, <span class="number">1</span>);</span><br><span class="line">            add_response_header(resp, <span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/octet-stream&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        set_response_body(resp, file_content, file_size, <span class="number">1</span>);</span><br><span class="line">        add_response_header(resp, <span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/octet-stream&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加文件信息头部</span></span><br><span class="line">    <span class="type">char</span> size_str[<span class="number">32</span>];</span><br><span class="line">    <span class="built_in">snprintf</span>(size_str, <span class="keyword">sizeof</span>(size_str), <span class="string">&quot;%ld&quot;</span>, file_size);</span><br><span class="line">    add_response_header(resp, <span class="string">&quot;Content-Length&quot;</span>, size_str);</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> mtime_str[<span class="number">64</span>];</span><br><span class="line">    strftime(mtime_str, <span class="keyword">sizeof</span>(mtime_str), <span class="string">&quot;%a, %d %b %Y %H:%M:%S GMT&quot;</span>, gmtime(&amp;st.st_mtime));</span><br><span class="line">    add_response_header(resp, <span class="string">&quot;Last-Modified&quot;</span>, mtime_str);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> resp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 内置处理器：代理</span></span><br><span class="line">HttpResponse* <span class="title function_">gateway_proxy_handler</span><span class="params">(<span class="type">const</span> HttpRequest *req, <span class="type">void</span> *user_data)</span> &#123;</span><br><span class="line">    (<span class="type">void</span>)user_data;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这里应该实现代理逻辑</span></span><br><span class="line">    <span class="comment">// 由于时间关系，只返回一个简单的响应</span></span><br><span class="line">    </span><br><span class="line">    HttpResponse *resp = create_http_response(HTTP_1_1, HTTP_501_NOT_IMPLEMENTED);</span><br><span class="line">    set_response_json(resp, <span class="string">&quot;&#123;\&quot;error\&quot;: \&quot;Proxy handler not implemented\&quot;&#125;&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> resp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-4-集成高级特性到主程序"><a href="#5-4-集成高级特性到主程序" class="headerlink" title="5.4 集成高级特性到主程序"></a>5.4 集成高级特性到主程序</h2><p>由于代码已经很长，这里提供集成思路和关键修改：</p>
<h3 id="5-4-1-更新配置结构"><a href="#5-4-1-更新配置结构" class="headerlink" title="5.4.1 更新配置结构"></a>5.4.1 更新配置结构</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在ServerConfig中添加</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> enable_cache;           <span class="comment">// 启用缓存</span></span><br><span class="line">    CacheConfig cache_config;   <span class="comment">// 缓存配置</span></span><br><span class="line">    <span class="type">int</span> enable_gateway;         <span class="comment">// 启用API网关</span></span><br><span class="line">    <span class="type">int</span> enable_websocket;       <span class="comment">// 启用WebSocket</span></span><br><span class="line">    <span class="type">char</span> websocket_path[<span class="number">256</span>];   <span class="comment">// WebSocket路径</span></span><br><span class="line">&#125; AdvancedConfig;</span><br></pre></td></tr></table></figure>



<h3 id="5-4-2-更新主程序"><a href="#5-4-2-更新主程序" class="headerlink" title="5.4.2 更新主程序"></a>5.4.2 更新主程序</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在main.c中添加</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/cache.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/websocket.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../include/gateway.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line"><span class="type">static</span> CacheSystem *cache_system = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">static</span> GatewayConfig *gateway_config = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化高级特性</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">init_advanced_features</span><span class="params">(ServerConfig *config)</span> &#123;</span><br><span class="line">    <span class="comment">// 初始化缓存</span></span><br><span class="line">    <span class="keyword">if</span> (config-&gt;advanced.enable_cache) &#123;</span><br><span class="line">        cache_system = cache_init(&amp;config-&gt;advanced.cache_config);</span><br><span class="line">        <span class="keyword">if</span> (cache_system == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            LOG_WARNING(<span class="string">&quot;Failed to initialize cache system&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LOG_INFO(<span class="string">&quot;Cache system initialized&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化API网关</span></span><br><span class="line">    <span class="keyword">if</span> (config-&gt;advanced.enable_gateway) &#123;</span><br><span class="line">        gateway_config = gateway_init();</span><br><span class="line">        <span class="keyword">if</span> (gateway_config == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            LOG_WARNING(<span class="string">&quot;Failed to initialize API gateway&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LOG_INFO(<span class="string">&quot;API Gateway initialized&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理WebSocket连接</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handle_websocket_connection</span><span class="params">(<span class="type">int</span> client_socket, <span class="type">const</span> <span class="type">char</span> *request)</span> &#123;</span><br><span class="line">    WsConnection *ws_conn = (WsConnection*)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(WsConnection));</span><br><span class="line">    <span class="keyword">if</span> (ws_conn == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ws_conn-&gt;socket = client_socket;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// WebSocket回调</span></span><br><span class="line">    WsCallbacks callbacks = &#123;</span><br><span class="line">        .on_open = websocket_on_open,</span><br><span class="line">        .on_message = websocket_on_message,</span><br><span class="line">        .on_close = websocket_on_close,</span><br><span class="line">        .on_error = websocket_on_error</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 处理握手</span></span><br><span class="line">    <span class="type">char</span> *response = ws_generate_handshake_response(extract_ws_key(request));</span><br><span class="line">    <span class="keyword">if</span> (response != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        send(client_socket, response, <span class="built_in">strlen</span>(response), <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">free</span>(response);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 握手成功，开始处理数据</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="type">char</span> buffer[<span class="number">4096</span>];</span><br><span class="line">            <span class="type">ssize_t</span> bytes = recv(client_socket, buffer, <span class="keyword">sizeof</span>(buffer), <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (bytes &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            ws_handle_data(ws_conn, (<span class="type">uint8_t</span>*)buffer, bytes, &amp;callbacks);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ws_close_connection(ws_conn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-5-创建测试脚本"><a href="#5-5-创建测试脚本" class="headerlink" title="5.5 创建测试脚本"></a>5.5 创建测试脚本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># scripts/test_advanced.sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 高级特性测试 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译</span></span><br><span class="line">make clean</span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">&quot;http_server&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;编译失败!&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建测试目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p logs uploads cache</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 测试1: 缓存系统 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;启动缓存测试服务器...&quot;</span></span><br><span class="line"><span class="built_in">cat</span> &gt; test_cache.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">port = 9090</span></span><br><span class="line"><span class="string">host = 127.0.0.1</span></span><br><span class="line"><span class="string">log_level = info</span></span><br><span class="line"><span class="string">enable_cache = true</span></span><br><span class="line"><span class="string">cache_max_size = 10485760</span></span><br><span class="line"><span class="string">cache_max_items = 100</span></span><br><span class="line"><span class="string">cache_default_ttl = 300</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">./http_server -c test_cache.conf &amp;</span><br><span class="line">CACHE_PID=$!</span><br><span class="line"><span class="built_in">sleep</span> 2</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;测试缓存功能...&quot;</span></span><br><span class="line"><span class="comment"># 第一次请求应该未命中</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;第一次请求（应未命中）:&quot;</span></span><br><span class="line">time curl -s http://127.0.0.1:9090/ &gt; /dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二次请求应该命中</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n第二次请求（应命中）:&quot;</span></span><br><span class="line">time curl -s http://127.0.0.1:9090/ &gt; /dev/null</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n查看缓存统计:&quot;</span></span><br><span class="line">curl -s http://127.0.0.1:9090/admin/cache | python3 -m json.tool 2&gt;/dev/null || \</span><br><span class="line">curl -s http://127.0.0.1:9090/admin/cache</span><br><span class="line"></span><br><span class="line"><span class="built_in">kill</span> <span class="variable">$CACHE_PID</span></span><br><span class="line"><span class="built_in">wait</span> <span class="variable">$CACHE_PID</span> 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 测试2: API网关 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;启动API网关测试服务器...&quot;</span></span><br><span class="line"><span class="built_in">cat</span> &gt; test_gateway.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">port = 9091</span></span><br><span class="line"><span class="string">host = 127.0.0.1</span></span><br><span class="line"><span class="string">log_level = info</span></span><br><span class="line"><span class="string">enable_gateway = true</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">./http_server -c test_gateway.conf &amp;</span><br><span class="line">GATEWAY_PID=$!</span><br><span class="line"><span class="built_in">sleep</span> 2</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;测试API网关路由...&quot;</span></span><br><span class="line">curl -s http://127.0.0.1:9091/api/status | grep -q <span class="string">&quot;online&quot;</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;✓ 状态端点正常&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;✗ 状态端点失败&quot;</span></span><br><span class="line">curl -s http://127.0.0.1:9091/api/echo -X POST -d <span class="string">&#x27;&#123;&quot;test&quot;: &quot;data&quot;&#125;&#x27;</span> | grep -q <span class="string">&quot;test&quot;</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;✓ Echo端点正常&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;✗ Echo端点失败&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试速率限制</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n测试速率限制...&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..5&#125;; <span class="keyword">do</span></span><br><span class="line">    curl -s -w <span class="string">&quot; 状态码: %&#123;http_code&#125;\n&quot;</span> http://127.0.0.1:9091/api/status &gt; /dev/null</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">kill</span> <span class="variable">$GATEWAY_PID</span></span><br><span class="line"><span class="built_in">wait</span> <span class="variable">$GATEWAY_PID</span> 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 测试3: WebSocket ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;注意：WebSocket测试需要手动进行&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;可以使用以下命令测试:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;  wscat -c ws://localhost:9092/ws&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;或使用浏览器WebSocket工具&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 清理 ===&quot;</span></span><br><span class="line"><span class="built_in">rm</span> -f test_cache.conf test_gateway.conf</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n=== 高级特性测试完成 ===&quot;</span></span><br></pre></td></tr></table></figure>



<h2 id="5-6-总结"><a href="#5-6-总结" class="headerlink" title="5.6 总结"></a>5.6 总结</h2><p>在这个阶段，我们扩展了服务器的核心功能：</p>
<h3 id="实现的功能：-3"><a href="#实现的功能：-3" class="headerlink" title="实现的功能："></a>实现的功能：</h3><ol>
<li><strong>缓存系统</strong>：<ul>
<li>LRU缓存淘汰策略</li>
<li>内存和磁盘缓存</li>
<li>ETag和Last-Modified支持</li>
<li>缓存统计和监控</li>
</ul>
</li>
<li><strong>WebSocket支持</strong>：<ul>
<li>RFC 6455标准实现</li>
<li>握手协议</li>
<li>帧解析和构建</li>
<li>心跳机制（Ping&#x2F;Pong）</li>
</ul>
</li>
<li><strong>API网关特性</strong>：<ul>
<li>路由匹配（精确、前缀、正则、参数）</li>
<li>中间件链</li>
<li>速率限制</li>
<li>认证和授权</li>
<li>访问日志</li>
</ul>
</li>
</ol>
<h3 id="学到的技能：-3"><a href="#学到的技能：-3" class="headerlink" title="学到的技能："></a>学到的技能：</h3><ol>
<li><strong>高性能缓存设计</strong>：<ul>
<li>LRU算法实现</li>
<li>内存管理优化</li>
<li>并发访问控制</li>
</ul>
</li>
<li><strong>实时通信协议</strong>：<ul>
<li>WebSocket协议栈</li>
<li>二进制帧处理</li>
<li>握手和升级机制</li>
</ul>
</li>
<li><strong>API网关架构</strong>：<ul>
<li>中间件模式</li>
<li>路由分发</li>
<li>请求过滤和转换</li>
</ul>
</li>
<li><strong>安全机制</strong>：<ul>
<li>速率限制算法</li>
<li>认证流程</li>
<li>输入验证和清理</li>
</ul>
</li>
</ol>
<h3 id="实际应用场景：-1"><a href="#实际应用场景：-1" class="headerlink" title="实际应用场景："></a>实际应用场景：</h3><ol>
<li><strong>缓存应用</strong>：<ul>
<li>静态资源加速</li>
<li>API响应缓存</li>
<li>会话存储</li>
</ul>
</li>
<li><strong>实时应用</strong>：<ul>
<li>聊天应用</li>
<li>实时数据推送</li>
<li>在线协作工具</li>
</ul>
</li>
<li><strong>微服务网关</strong>：<ul>
<li>服务路由</li>
<li>API聚合</li>
<li>熔断和降级</li>
</ul>
</li>
</ol>
<p>这个项目现在已经成为一个功能完整的企业级HTTP服务器，涵盖了现代Web服务器的大多数核心功能。你可以在此基础上继续扩展，比如：</p>
<ol>
<li><strong>HTTP&#x2F;2支持</strong></li>
<li><strong>gRPC集成</strong></li>
<li><strong>负载均衡器</strong></li>
<li><strong>服务发现</strong></li>
<li><strong>监控和告警集成</strong></li>
<li><strong>容器化部署</strong></li>
</ol>
<p>这个项目为你提供了深入学习C语言系统编程、网络编程和服务器架构的绝佳机会。</p>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">
    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/31cf01ae.html" rel="prev" title="Java实践:电商后台系统">
                  <i class="fa fa-angle-left"></i> Java实践:电商后台系统
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/95f568fe.html" rel="next" title="Shell实践-文件批处理器">
                  Shell实践-文件批处理器 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa-regular fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder"></span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Word count total">393k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">23:48</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>

  <script class="next-config" data-name="wavedrom" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/wavedrom.min.js","integrity":"sha256-INLAoJc6quTNfiMWkGZniYO2cxE8mHpddnLow1m6RFs="}}</script>
  <script class="next-config" data-name="wavedrom_skin" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/skins/default.js","integrity":"sha256-fduc/Zszk5ezWws2uInY/ALWVmIrmV6VTgXbsYSReFI="}}</script>
  <script src="/js/third-party/tags/wavedrom.js"></script>




  





</body>
</html>
