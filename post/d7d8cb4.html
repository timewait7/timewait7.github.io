<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"timewait7.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="我们将设计一个终端日志分析器，它可以分析nginx或apache的访问日志，统计访问信息。我们将使用grep、awk和sed等工具。设计思路：  首先，我们需要确定日志的格式。nginx和apache的日志格式可能不同，但常见的如combined格式，我们可以处理这种格式。 我们将通过命令行参数指定日志文件，并允许用户选择不同的分析功能，例如： 统计访问量最高的IP 统计访问量最高的URL 统计响">
<meta property="og:type" content="article">
<meta property="og:title" content="Shell实践-日志处理器">
<meta property="og:url" content="http://timewait7.github.io/post/d7d8cb4.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="我们将设计一个终端日志分析器，它可以分析nginx或apache的访问日志，统计访问信息。我们将使用grep、awk和sed等工具。设计思路：  首先，我们需要确定日志的格式。nginx和apache的日志格式可能不同，但常见的如combined格式，我们可以处理这种格式。 我们将通过命令行参数指定日志文件，并允许用户选择不同的分析功能，例如： 统计访问量最高的IP 统计访问量最高的URL 统计响">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-12-19T11:10:38.000Z">
<meta property="article:modified_time" content="2025-12-19T11:21:59.612Z">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://timewait7.github.io/post/d7d8cb4.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://timewait7.github.io/post/d7d8cb4.html","path":"post/d7d8cb4.html","title":"Shell实践-日志处理器"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Shell实践-日志处理器 | Hexo</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-archives"><a href="/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="Searching..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%88%E7%AB%AF%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E5%99%A8%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88"><span class="nav-number">1.</span> <span class="nav-text">终端日志分析器实现方案</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF"><span class="nav-number">1.1.</span> <span class="nav-text">一、设计思路</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%80%BB%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="nav-number">1.1.1.</span> <span class="nav-text">1. 总体架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.1.2.</span> <span class="nav-text">2. 核心功能设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%8A%80%E6%9C%AF%E6%A0%88"><span class="nav-number">1.1.3.</span> <span class="nav-text">3. 技术栈</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E9%80%90%E6%AD%A5%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.2.</span> <span class="nav-text">二、逐步实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC1%E6%AD%A5%EF%BC%9A%E5%88%9B%E5%BB%BA%E5%9F%BA%E7%A1%80%E8%84%9A%E6%9C%AC%E6%A1%86%E6%9E%B6"><span class="nav-number">1.2.1.</span> <span class="nav-text">第1步：创建基础脚本框架</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC2%E6%AD%A5%EF%BC%9A%E5%AE%9E%E7%8E%B0%E6%97%A5%E5%BF%97%E8%A7%A3%E6%9E%90%E5%87%BD%E6%95%B0"><span class="nav-number">1.2.2.</span> <span class="nav-text">第2步：实现日志解析函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC3%E6%AD%A5%EF%BC%9A%E5%AE%9E%E7%8E%B0%E5%9F%BA%E7%A1%80%E7%BB%9F%E8%AE%A1%E5%8A%9F%E8%83%BD"><span class="nav-number">1.2.3.</span> <span class="nav-text">第3步：实现基础统计功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC4%E6%AD%A5%EF%BC%9A%E5%AE%9E%E7%8E%B0%E6%9B%B4%E5%A4%9A%E5%88%86%E6%9E%90%E5%8A%9F%E8%83%BD"><span class="nav-number">1.2.4.</span> <span class="nav-text">第4步：实现更多分析功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC5%E6%AD%A5%EF%BC%9A%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%87%E6%BB%A4%E5%8A%9F%E8%83%BD"><span class="nav-number">1.2.5.</span> <span class="nav-text">第5步：实现自定义过滤功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC6%E6%AD%A5%EF%BC%9A%E5%AE%9E%E7%8E%B0%E4%B8%BB%E8%8F%9C%E5%8D%95%E5%92%8C%E8%BE%93%E5%87%BA%E5%8A%9F%E8%83%BD"><span class="nav-number">1.2.6.</span> <span class="nav-text">第6步：实现主菜单和输出功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC7%E6%AD%A5%EF%BC%9A%E6%B7%BB%E5%8A%A0%E8%84%9A%E6%9C%AC%E6%89%A7%E8%A1%8C%E9%83%A8%E5%88%86"><span class="nav-number">1.2.7.</span> <span class="nav-text">第7步：添加脚本执行部分</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.3.</span> <span class="nav-text">三、使用示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="nav-number">1.3.1.</span> <span class="nav-text">1. 基本使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E7%9B%B4%E6%8E%A5%E7%BB%9F%E8%AE%A1%E8%AE%BF%E9%97%AE%E9%87%8F%E6%9C%80%E9%AB%98%E7%9A%84IP"><span class="nav-number">1.3.2.</span> <span class="nav-text">2. 直接统计访问量最高的IP</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E8%BF%9B%E9%98%B6%E5%8A%9F%E8%83%BD%E6%89%A9%E5%B1%95%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.4.</span> <span class="nav-text">四、进阶功能扩展建议</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%B7%BB%E5%8A%A0%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90"><span class="nav-number">1.4.1.</span> <span class="nav-text">1. 添加性能分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%B7%BB%E5%8A%A0%E5%AE%89%E5%85%A8%E5%88%86%E6%9E%90"><span class="nav-number">1.4.2.</span> <span class="nav-text">2. 添加安全分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E5%AD%A6%E4%B9%A0%E8%A6%81%E7%82%B9%E6%80%BB%E7%BB%93"><span class="nav-number">1.5.</span> <span class="nav-text">五、学习要点总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E4%B8%8B%E4%B8%80%E6%AD%A5%E6%8F%90%E5%8D%87%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.6.</span> <span class="nav-text">六、下一步提升建议</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%88%E7%AB%AF%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E5%99%A8%E6%89%A9%E5%B1%95%E4%B8%8E%E5%AE%8C%E5%96%84"><span class="nav-number">2.</span> <span class="nav-text">终端日志分析器扩展与完善</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E6%89%A9%E5%B1%95%E5%8A%9F%E8%83%BD%E8%AE%BE%E8%AE%A1"><span class="nav-number">2.1.</span> <span class="nav-text">一、扩展功能设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E6%96%B0%E5%A2%9E%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97"><span class="nav-number">2.1.1.</span> <span class="nav-text">1.1 新增功能模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91"><span class="nav-number">2.1.2.</span> <span class="nav-text">1.2 优化方向</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E6%89%A9%E5%B1%95%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.2.</span> <span class="nav-text">二、扩展实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC1%E6%AD%A5%EF%BC%9A%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%92%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E5%87%BD%E6%95%B0"><span class="nav-number">2.2.1.</span> <span class="nav-text">第1步：添加配置文件和初始化函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC2%E6%AD%A5%EF%BC%9A%E4%BC%98%E5%8C%96%E6%97%A5%E5%BF%97%E8%A7%A3%E6%9E%90%E5%99%A8%EF%BC%8C%E6%94%AF%E6%8C%81%E5%A4%9A%E7%A7%8D%E6%A0%BC%E5%BC%8F"><span class="nav-number">2.2.2.</span> <span class="nav-text">第2步：优化日志解析器，支持多种格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC3%E6%AD%A5%EF%BC%9A%E6%B7%BB%E5%8A%A0%E5%AE%9E%E6%97%B6%E7%9B%91%E6%8E%A7%E5%8A%9F%E8%83%BD"><span class="nav-number">2.2.3.</span> <span class="nav-text">第3步：添加实时监控功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC4%E6%AD%A5%EF%BC%9A%E5%A2%9E%E5%BC%BA%E5%BC%82%E5%B8%B8%E6%A3%80%E6%B5%8B%E5%8A%9F%E8%83%BD"><span class="nav-number">2.2.4.</span> <span class="nav-text">第4步：增强异常检测功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC5%E6%AD%A5%EF%BC%9A%E6%B7%BB%E5%8A%A0%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%8A%9F%E8%83%BD"><span class="nav-number">2.2.5.</span> <span class="nav-text">第5步：添加性能分析功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC6%E6%AD%A5%EF%BC%9A%E6%B7%BB%E5%8A%A0%E6%8A%A5%E8%A1%A8%E7%94%9F%E6%88%90%E5%8A%9F%E8%83%BD"><span class="nav-number">2.2.6.</span> <span class="nav-text">第6步：添加报表生成功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC7%E6%AD%A5%EF%BC%9A%E6%B7%BB%E5%8A%A0%E5%A4%9A%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86%E5%92%8C%E6%89%B9%E9%87%8F%E5%88%86%E6%9E%90"><span class="nav-number">2.2.7.</span> <span class="nav-text">第7步：添加多文件处理和批量分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC8%E6%AD%A5%EF%BC%9A%E6%B7%BB%E5%8A%A0%E5%8F%AF%E8%A7%86%E5%8C%96%E5%9B%BE%E8%A1%A8%E5%8A%9F%E8%83%BD"><span class="nav-number">2.2.8.</span> <span class="nav-text">第8步：添加可视化图表功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC9%E6%AD%A5%EF%BC%9A%E6%B7%BB%E5%8A%A0%E9%AB%98%E7%BA%A7%E8%BF%87%E6%BB%A4%E5%92%8C%E6%9F%A5%E8%AF%A2%E5%8A%9F%E8%83%BD"><span class="nav-number">2.2.9.</span> <span class="nav-text">第9步：添加高级过滤和查询功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC10%E6%AD%A5%EF%BC%9A%E5%AE%8C%E5%96%84%E4%B8%BB%E8%8F%9C%E5%8D%95%E5%92%8C%E7%94%A8%E6%88%B7%E4%BD%93%E9%AA%8C"><span class="nav-number">2.2.10.</span> <span class="nav-text">第10步：完善主菜单和用户体验</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B%E5%92%8C%E6%B5%8B%E8%AF%95"><span class="nav-number">2.3.</span> <span class="nav-text">三、使用示例和测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE"><span class="nav-number">2.3.1.</span> <span class="nav-text">1. 安装和配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E9%AB%98%E7%BA%A7%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="nav-number">2.3.2.</span> <span class="nav-text">2. 高级使用示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%B5%8B%E8%AF%95%E5%A5%97%E4%BB%B6"><span class="nav-number">2.3.3.</span> <span class="nav-text">3. 测试套件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE"><span class="nav-number">2.4.</span> <span class="nav-text">四、性能优化建议</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%A4%A7%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86%E4%BC%98%E5%8C%96"><span class="nav-number">2.4.1.</span> <span class="nav-text">1. 大文件处理优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96"><span class="nav-number">2.4.2.</span> <span class="nav-text">2. 内存优化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E6%89%A9%E5%B1%95%E6%8F%92%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="nav-number">2.5.</span> <span class="nav-text">五、扩展插件系统</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E6%80%BB%E7%BB%93"><span class="nav-number">2.6.</span> <span class="nav-text">六、总结</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/">
          <span class="site-state-item-count">59</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>

    
        <div class="sidebar-inner sidebar-post-related">
          <div class="animated">
              <div class="links-of-blogroll-title"><i class="fa fa-signs-post fa-fw"></i>
    Related Posts
  </div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/post/1aa6cbcd.html" rel="bookmark">
        <time class="popular-posts-time">2025-10-04</time>
        <br>
      命令速查表
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/post/c25083a1.html" rel="bookmark">
        <time class="popular-posts-time">2025-12-17</time>
        <br>
      Java实践:个人博客
      </a>
    </li>
  </ul>

          </div>
        </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://timewait7.github.io/post/d7d8cb4.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Shell实践-日志处理器 | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Shell实践-日志处理器
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-12-19 19:10:38" itemprop="dateCreated datePublished" datetime="2025-12-19T19:10:38+08:00">2025-12-19</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>11k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>39 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>我们将设计一个终端日志分析器，它可以分析nginx或apache的访问日志，统计访问信息。我们将使用grep、awk和sed等工具。<br>设计思路：</p>
<ol>
<li>首先，我们需要确定日志的格式。nginx和apache的日志格式可能不同，但常见的如combined格式，我们可以处理这种格式。</li>
<li>我们将通过命令行参数指定日志文件，并允许用户选择不同的分析功能，例如：<ul>
<li>统计访问量最高的IP</li>
<li>统计访问量最高的URL</li>
<li>统计响应状态码的数量</li>
<li>统计每个IP的访问次数，并列出其访问的URL（可选）</li>
</ul>
</li>
<li>我们将使用函数来组织各个功能，使代码模块化。</li>
</ol>
<p>步骤：</p>
<ol>
<li>解析命令行参数，获取日志文件路径和选择的功能。</li>
<li>根据选择的功能，使用相应的命令进行处理。</li>
</ol>
<p>由于我们主要使用shell，我们可以用一个简单的脚本来实现，通过case语句来选择功能。</p>
<p>我们假设日志格式为combined，例如：<br>127.0.0.1 - - [01&#x2F;Jan&#x2F;2020:00:00:00 +0000] “GET &#x2F;index.html HTTP&#x2F;1.1” 200 1234</p>
<p>实现的功能：</p>
<ol>
<li>统计访问量最高的IP（按访问次数排序）</li>
<li>统计访问量最高的URL（按访问次数排序）</li>
<li>统计响应状态码的数量（按出现次数排序）</li>
<li>统计每个IP的访问次数，并列出其访问的URL（按IP分组，并列出每个IP访问的URL和次数）</li>
</ol>
<p>我们将逐个实现这些功能。</p>
<p>注意：由于日志文件可能很大，我们尽量使用流式处理，避免将整个文件读入内存。</p>
<p>让我们开始编写脚本。</p>
<h1 id="终端日志分析器实现方案"><a href="#终端日志分析器实现方案" class="headerlink" title="终端日志分析器实现方案"></a>终端日志分析器实现方案</h1><p>我将带你一步步实现一个功能完善的Nginx&#x2F;Apache日志分析器，帮助你提升Shell编程能力。</p>
<h2 id="一、设计思路"><a href="#一、设计思路" class="headerlink" title="一、设计思路"></a>一、设计思路</h2><h3 id="1-总体架构"><a href="#1-总体架构" class="headerlink" title="1. 总体架构"></a>1. 总体架构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────┐</span><br><span class="line">│               日志分析器                    │</span><br><span class="line">├─────────────────────────────────────────────┤</span><br><span class="line">│  1. 日志解析模块     2. 统计模块            │</span><br><span class="line">│  3. 过滤模块        4. 输出模块             │</span><br><span class="line">└─────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="2-核心功能设计"><a href="#2-核心功能设计" class="headerlink" title="2. 核心功能设计"></a>2. 核心功能设计</h3><ul>
<li><strong>基础统计</strong>：访问量、IP统计、状态码统计</li>
<li><strong>资源分析</strong>：热门页面、文件类型统计</li>
<li><strong>时间分析</strong>：时间段访问统计</li>
<li><strong>安全分析</strong>：异常访问检测</li>
<li><strong>自定义过滤</strong>：按条件筛选日志</li>
</ul>
<h3 id="3-技术栈"><a href="#3-技术栈" class="headerlink" title="3. 技术栈"></a>3. 技术栈</h3><ul>
<li><code>grep</code>：模式匹配和过滤</li>
<li><code>awk</code>：字段提取和统计分析</li>
<li><code>sed</code>：文本处理和格式转换</li>
<li><code>sort</code>&#x2F;<code>uniq</code>：排序和去重</li>
<li>函数化编程：模块化设计</li>
</ul>
<h2 id="二、逐步实现"><a href="#二、逐步实现" class="headerlink" title="二、逐步实现"></a>二、逐步实现</h2><h3 id="第1步：创建基础脚本框架"><a href="#第1步：创建基础脚本框架" class="headerlink" title="第1步：创建基础脚本框架"></a>第1步：创建基础脚本框架</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># log_analyzer.sh - Nginx/Apache日志分析器</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 颜色定义</span></span><br><span class="line">RED=<span class="string">&#x27;\033[0;31m&#x27;</span></span><br><span class="line">GREEN=<span class="string">&#x27;\033[0;32m&#x27;</span></span><br><span class="line">YELLOW=<span class="string">&#x27;\033[1;33m&#x27;</span></span><br><span class="line">BLUE=<span class="string">&#x27;\033[0;34m&#x27;</span></span><br><span class="line">NC=<span class="string">&#x27;\033[0m&#x27;</span> <span class="comment"># No Color</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局变量</span></span><br><span class="line">LOG_FILE=<span class="string">&quot;&quot;</span></span><br><span class="line">OUTPUT_FILE=<span class="string">&quot;&quot;</span></span><br><span class="line">LOG_TYPE=<span class="string">&quot;nginx&quot;</span>  <span class="comment"># 默认nginx格式</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示帮助信息</span></span><br><span class="line"><span class="function"><span class="title">show_help</span></span>() &#123;</span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">使用方式: $0 [选项] &lt;日志文件&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">选项:</span></span><br><span class="line"><span class="string">  -t, --type TYPE     日志类型 (nginx/apache)，默认: nginx</span></span><br><span class="line"><span class="string">  -o, --output FILE   输出结果到文件</span></span><br><span class="line"><span class="string">  -h, --help          显示此帮助信息</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">分析模式:</span></span><br><span class="line"><span class="string">  1) 基础统计</span></span><br><span class="line"><span class="string">  2) IP分析</span></span><br><span class="line"><span class="string">  3) 页面分析</span></span><br><span class="line"><span class="string">  4) 状态码分析</span></span><br><span class="line"><span class="string">  5) 时间段分析</span></span><br><span class="line"><span class="string">  6) 自定义过滤</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">示例:</span></span><br><span class="line"><span class="string">  $0 access.log</span></span><br><span class="line"><span class="string">  $0 -t apache -o report.txt access.log</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析命令行参数</span></span><br><span class="line"><span class="function"><span class="title">parse_args</span></span>() &#123;</span><br><span class="line">    <span class="keyword">while</span> [[ <span class="variable">$#</span> -gt 0 ]]; <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">            -t|--<span class="built_in">type</span>)</span><br><span class="line">                LOG_TYPE=<span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">                <span class="built_in">shift</span> 2</span><br><span class="line">                ;;</span><br><span class="line">            -o|--output)</span><br><span class="line">                OUTPUT_FILE=<span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">                <span class="built_in">shift</span> 2</span><br><span class="line">                ;;</span><br><span class="line">            -h|--<span class="built_in">help</span>)</span><br><span class="line">                show_help</span><br><span class="line">                <span class="built_in">exit</span> 0</span><br><span class="line">                ;;</span><br><span class="line">            *)</span><br><span class="line">                <span class="keyword">if</span> [[ -z <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> &amp;&amp; -f <span class="string">&quot;<span class="variable">$1</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">                    LOG_FILE=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>错误: 未知参数或文件不存在: $1<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">                    <span class="built_in">exit</span> 1</span><br><span class="line">                <span class="keyword">fi</span></span><br><span class="line">                <span class="built_in">shift</span></span><br><span class="line">                ;;</span><br><span class="line">        <span class="keyword">esac</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [[ -z <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>错误: 请指定日志文件<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">        show_help</span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="第2步：实现日志解析函数"><a href="#第2步：实现日志解析函数" class="headerlink" title="第2步：实现日志解析函数"></a>第2步：实现日志解析函数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根据日志类型解析日志行</span></span><br><span class="line"><span class="function"><span class="title">parse_log_line</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> line=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$LOG_TYPE</span>&quot;</span> == <span class="string">&quot;nginx&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># Nginx combined格式: $remote_addr - $remote_user [$time_local] &quot;$request&quot; $status $body_bytes_sent &quot;$http_referer&quot; &quot;$http_user_agent&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$line</span>&quot;</span> | awk <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">            gsub(/\[|\]|\&quot;/, &quot;&quot;, $0)</span></span><br><span class="line"><span class="string">            print $1,          # IP</span></span><br><span class="line"><span class="string">            $4&quot; &quot;$5,           # 时间</span></span><br><span class="line"><span class="string">            $6,                # 请求方法</span></span><br><span class="line"><span class="string">            $7,                # URL</span></span><br><span class="line"><span class="string">            $9,                # 状态码</span></span><br><span class="line"><span class="string">            $10,               # 字节数</span></span><br><span class="line"><span class="string">            $11,               # 来源</span></span><br><span class="line"><span class="string">            substr($0, index($0, $12))  # UserAgent</span></span><br><span class="line"><span class="string">        &#125;&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> [[ <span class="string">&quot;<span class="variable">$LOG_TYPE</span>&quot;</span> == <span class="string">&quot;apache&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># Apache combined格式</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$line</span>&quot;</span> | awk <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">            gsub(/\[|\]|\&quot;/, &quot;&quot;, $0)</span></span><br><span class="line"><span class="string">            print $1,          # IP</span></span><br><span class="line"><span class="string">            $4&quot; &quot;$5,           # 时间</span></span><br><span class="line"><span class="string">            $6,                # 请求方法</span></span><br><span class="line"><span class="string">            $7,                # URL</span></span><br><span class="line"><span class="string">            $9,                # 状态码</span></span><br><span class="line"><span class="string">            $10,               # 字节数</span></span><br><span class="line"><span class="string">            $11,               # 来源</span></span><br><span class="line"><span class="string">            substr($0, index($0, $12))  # UserAgent</span></span><br><span class="line"><span class="string">        &#125;&#x27;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>错误: 不支持的日志类型: $LOG_TYPE<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试日志解析</span></span><br><span class="line"><span class="function"><span class="title">test_parse</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;BLUE&#125;</span>测试日志解析...<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">local</span> test_line=<span class="string">&#x27;192.168.1.1 - - [10/Oct/2023:13:55:36 +0800] &quot;GET /index.html HTTP/1.1&quot; 200 1234 &quot;http://example.com&quot; &quot;Mozilla/5.0&quot;&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;原始日志: <span class="variable">$test_line</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;解析结果:&quot;</span></span><br><span class="line">    parse_log_line <span class="string">&quot;<span class="variable">$test_line</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="第3步：实现基础统计功能"><a href="#第3步：实现基础统计功能" class="headerlink" title="第3步：实现基础统计功能"></a>第3步：实现基础统计功能</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 基础访问统计</span></span><br><span class="line"><span class="function"><span class="title">basic_stats</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>=== 基础访问统计 ===<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">local</span> total_requests=$(<span class="built_in">wc</span> -l &lt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;总访问次数: <span class="variable">$total_requests</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 独立IP数</span></span><br><span class="line">    <span class="built_in">local</span> unique_ips=$(awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | <span class="built_in">sort</span> -u | <span class="built_in">wc</span> -l)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;独立IP数: <span class="variable">$unique_ips</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 总流量估算</span></span><br><span class="line">    <span class="built_in">local</span> total_bytes=$(awk <span class="string">&#x27;&#123;sum += $10&#125; END &#123;print sum&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> 2&gt;/dev/null)</span><br><span class="line">    <span class="keyword">if</span> [[ -n <span class="string">&quot;<span class="variable">$total_bytes</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;总传输流量: <span class="subst">$(numfmt --to=iec $total_bytes)</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 平均每秒请求数</span></span><br><span class="line">    <span class="built_in">local</span> first_time=$(awk <span class="string">&#x27;&#123;print $4&quot; &quot;$5&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | <span class="built_in">head</span> -1 | sed <span class="string">&#x27;s/\[//;s/\]//&#x27;</span>)</span><br><span class="line">    <span class="built_in">local</span> last_time=$(awk <span class="string">&#x27;&#123;print $4&quot; &quot;$5&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | <span class="built_in">tail</span> -1 | sed <span class="string">&#x27;s/\[//;s/\]//&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [[ -n <span class="string">&quot;<span class="variable">$first_time</span>&quot;</span> &amp;&amp; -n <span class="string">&quot;<span class="variable">$last_time</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">local</span> first_epoch=$(<span class="built_in">date</span> -d <span class="string">&quot;<span class="variable">$first_time</span>&quot;</span> +%s 2&gt;/dev/null || <span class="built_in">date</span> -d <span class="string">&quot;<span class="variable">$&#123;first_time/+0800/&#125;</span>&quot;</span> +%s)</span><br><span class="line">        <span class="built_in">local</span> last_epoch=$(<span class="built_in">date</span> -d <span class="string">&quot;<span class="variable">$last_time</span>&quot;</span> +%s 2&gt;/dev/null || <span class="built_in">date</span> -d <span class="string">&quot;<span class="variable">$&#123;last_time/+0800/&#125;</span>&quot;</span> +%s)</span><br><span class="line">        <span class="built_in">local</span> duration=$((last_epoch - first_epoch))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> [[ <span class="variable">$duration</span> -gt 0 ]]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">local</span> rps=$(<span class="built_in">echo</span> <span class="string">&quot;scale=2; <span class="variable">$total_requests</span> / <span class="variable">$duration</span>&quot;</span> | bc)</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;持续时间: <span class="variable">$&#123;duration&#125;</span>秒&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;平均RPS: <span class="variable">$rps</span> 请求/秒&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 统计访问量最高的IP（你要求的示例）</span></span><br><span class="line"><span class="function"><span class="title">top_ips</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> count=<span class="variable">$&#123;1:-10&#125;</span>  <span class="comment"># 默认显示前10个</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>=== 访问量最高的IP (Top <span class="variable">$count</span>) ===<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | \</span><br><span class="line">        <span class="built_in">sort</span> | \</span><br><span class="line">        <span class="built_in">uniq</span> -c | \</span><br><span class="line">        <span class="built_in">sort</span> -rn | \</span><br><span class="line">        <span class="built_in">head</span> -n <span class="string">&quot;<span class="variable">$count</span>&quot;</span> | \</span><br><span class="line">        awk <span class="string">&#x27;&#123;printf &quot;%-15s %-10s %s\n&quot;, $2, $1, &quot;次&quot;&#125;&#x27;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 扩展：统计IP所在地（需要安装geoiplookup）</span></span><br><span class="line"><span class="function"><span class="title">top_ips_with_location</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>=== 访问量最高的IP及所在地 ===<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | \</span><br><span class="line">        <span class="built_in">sort</span> | \</span><br><span class="line">        <span class="built_in">uniq</span> -c | \</span><br><span class="line">        <span class="built_in">sort</span> -rn | \</span><br><span class="line">        <span class="built_in">head</span> -n 10 | \</span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">read</span> count ip; <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">command</span> -v geoiplookup &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">                location=$(geoiplookup <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> | awk -F <span class="string">&#x27;: &#x27;</span> <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | <span class="built_in">head</span> -1)</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                location=<span class="string">&quot;(需要安装geoiplookup)&quot;</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">            <span class="built_in">printf</span> <span class="string">&quot;%-15s %-10s %-30s\n&quot;</span> <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> <span class="string">&quot;<span class="variable">$count</span>次&quot;</span> <span class="string">&quot;<span class="variable">$location</span>&quot;</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="第4步：实现更多分析功能"><a href="#第4步：实现更多分析功能" class="headerlink" title="第4步：实现更多分析功能"></a>第4步：实现更多分析功能</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 4. 统计热门页面</span></span><br><span class="line"><span class="function"><span class="title">top_pages</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> count=<span class="variable">$&#123;1:-10&#125;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>=== 访问量最高的页面 (Top <span class="variable">$count</span>) ===<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    awk <span class="string">&#x27;&#123;print $7&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | \</span><br><span class="line">        awk -F<span class="string">&#x27;?&#x27;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | \</span><br><span class="line">        <span class="built_in">sort</span> | \</span><br><span class="line">        <span class="built_in">uniq</span> -c | \</span><br><span class="line">        <span class="built_in">sort</span> -rn | \</span><br><span class="line">        <span class="built_in">head</span> -n <span class="string">&quot;<span class="variable">$count</span>&quot;</span> | \</span><br><span class="line">        awk <span class="string">&#x27;&#123;printf &quot;%-40s %-10s %s\n&quot;, $2, $1, &quot;次&quot;&#125;&#x27;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 统计HTTP状态码</span></span><br><span class="line"><span class="function"><span class="title">status_codes</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>=== HTTP状态码统计 ===<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    awk <span class="string">&#x27;&#123;print $9&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | \</span><br><span class="line">        <span class="built_in">sort</span> | \</span><br><span class="line">        <span class="built_in">uniq</span> -c | \</span><br><span class="line">        <span class="built_in">sort</span> -rn | \</span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">read</span> count code; <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">case</span> <span class="variable">$code</span> <span class="keyword">in</span></span><br><span class="line">                2*) color=<span class="variable">$GREEN</span> ;;</span><br><span class="line">                3*) color=<span class="variable">$BLUE</span> ;;</span><br><span class="line">                4*) color=<span class="variable">$YELLOW</span> ;;</span><br><span class="line">                5*) color=<span class="variable">$RED</span> ;;</span><br><span class="line">                *) color=<span class="variable">$NC</span> ;;</span><br><span class="line">            <span class="keyword">esac</span></span><br><span class="line">            <span class="built_in">printf</span> <span class="string">&quot;<span class="variable">$&#123;color&#125;</span>%-10s %-10s %s<span class="variable">$&#123;NC&#125;</span>\n&quot;</span> <span class="string">&quot;<span class="variable">$code</span>&quot;</span> <span class="string">&quot;<span class="variable">$count</span>次&quot;</span> <span class="string">&quot;<span class="subst">$(get_status_desc $code)</span>&quot;</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取状态码描述</span></span><br><span class="line"><span class="function"><span class="title">get_status_desc</span></span>() &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">        200) <span class="built_in">echo</span> <span class="string">&quot;OK&quot;</span> ;;</span><br><span class="line">        301) <span class="built_in">echo</span> <span class="string">&quot;Moved Permanently&quot;</span> ;;</span><br><span class="line">        302) <span class="built_in">echo</span> <span class="string">&quot;Found&quot;</span> ;;</span><br><span class="line">        304) <span class="built_in">echo</span> <span class="string">&quot;Not Modified&quot;</span> ;;</span><br><span class="line">        400) <span class="built_in">echo</span> <span class="string">&quot;Bad Request&quot;</span> ;;</span><br><span class="line">        403) <span class="built_in">echo</span> <span class="string">&quot;Forbidden&quot;</span> ;;</span><br><span class="line">        404) <span class="built_in">echo</span> <span class="string">&quot;Not Found&quot;</span> ;;</span><br><span class="line">        500) <span class="built_in">echo</span> <span class="string">&quot;Internal Server Error&quot;</span> ;;</span><br><span class="line">        502) <span class="built_in">echo</span> <span class="string">&quot;Bad Gateway&quot;</span> ;;</span><br><span class="line">        503) <span class="built_in">echo</span> <span class="string">&quot;Service Unavailable&quot;</span> ;;</span><br><span class="line">        *) <span class="built_in">echo</span> <span class="string">&quot;&quot;</span> ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 时间段分析（按小时统计）</span></span><br><span class="line"><span class="function"><span class="title">hourly_stats</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>=== 按小时访问统计 ===<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    awk <span class="string">&#x27;&#123;split($4, time, &quot;:&quot;); print time[2]&quot;:00&quot;&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | \</span><br><span class="line">        sed <span class="string">&#x27;s/\[//&#x27;</span> | \</span><br><span class="line">        <span class="built_in">sort</span> | \</span><br><span class="line">        <span class="built_in">uniq</span> -c | \</span><br><span class="line">        <span class="built_in">sort</span> -n | \</span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">read</span> count hour; <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">printf</span> <span class="string">&quot;%-10s %-10s [&quot;</span> <span class="string">&quot;<span class="variable">$hour</span>&quot;</span> <span class="string">&quot;<span class="variable">$count</span>次&quot;</span></span><br><span class="line">            <span class="comment"># 简单条形图</span></span><br><span class="line">            <span class="built_in">local</span> bars=$((count / <span class="number">10</span>))</span><br><span class="line">            <span class="keyword">for</span> ((i=<span class="number">0</span>; i&lt;bars &amp;&amp; i&lt;<span class="number">50</span>; i++)); <span class="keyword">do</span></span><br><span class="line">                <span class="built_in">echo</span> -n <span class="string">&quot;#&quot;</span></span><br><span class="line">            <span class="keyword">done</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;]&quot;</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 文件类型统计</span></span><br><span class="line"><span class="function"><span class="title">file_types</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>=== 文件类型统计 ===<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    awk <span class="string">&#x27;&#123;print $7&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | \</span><br><span class="line">        awk -F <span class="string">&#x27;.&#x27;</span> <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span> | \</span><br><span class="line">        awk -F <span class="string">&#x27;?&#x27;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | \</span><br><span class="line">        <span class="built_in">tr</span> <span class="string">&#x27;[:upper:]&#x27;</span> <span class="string">&#x27;[:lower:]&#x27;</span> | \</span><br><span class="line">        grep -E <span class="string">&#x27;^(html|htm|php|jsp|asp|js|css|jpg|jpeg|png|gif|svg|ico|pdf|doc|xls|ppt|txt|json|xml)$&#x27;</span> | \</span><br><span class="line">        <span class="built_in">sort</span> | \</span><br><span class="line">        <span class="built_in">uniq</span> -c | \</span><br><span class="line">        <span class="built_in">sort</span> -rn | \</span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">read</span> count <span class="built_in">type</span>; <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">printf</span> <span class="string">&quot;%-10s %-10s %s\n&quot;</span> <span class="string">&quot;<span class="variable">$type</span>&quot;</span> <span class="string">&quot;<span class="variable">$count</span>次&quot;</span> <span class="string">&quot;<span class="subst">$(get_filetype_desc $type)</span>&quot;</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">get_filetype_desc</span></span>() &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">        html|htm) <span class="built_in">echo</span> <span class="string">&quot;HTML页面&quot;</span> ;;</span><br><span class="line">        php|jsp|asp) <span class="built_in">echo</span> <span class="string">&quot;动态页面&quot;</span> ;;</span><br><span class="line">        js) <span class="built_in">echo</span> <span class="string">&quot;JavaScript文件&quot;</span> ;;</span><br><span class="line">        css) <span class="built_in">echo</span> <span class="string">&quot;样式表&quot;</span> ;;</span><br><span class="line">        jpg|jpeg|png|gif|svg|ico) <span class="built_in">echo</span> <span class="string">&quot;图片资源&quot;</span> ;;</span><br><span class="line">        pdf|doc|xls|ppt) <span class="built_in">echo</span> <span class="string">&quot;文档文件&quot;</span> ;;</span><br><span class="line">        txt) <span class="built_in">echo</span> <span class="string">&quot;文本文件&quot;</span> ;;</span><br><span class="line">        json|xml) <span class="built_in">echo</span> <span class="string">&quot;数据文件&quot;</span> ;;</span><br><span class="line">        *) <span class="built_in">echo</span> <span class="string">&quot;&quot;</span> ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="第5步：实现自定义过滤功能"><a href="#第5步：实现自定义过滤功能" class="headerlink" title="第5步：实现自定义过滤功能"></a>第5步：实现自定义过滤功能</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 8. 自定义过滤分析</span></span><br><span class="line"><span class="function"><span class="title">custom_filter</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>=== 自定义过滤分析 ===<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;选择过滤条件:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1) 按状态码过滤 (如 404, 500)&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;2) 按IP地址过滤&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;3) 按时间范围过滤&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;4) 按关键词过滤URL&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;5) 按HTTP方法过滤&quot;</span></span><br><span class="line">    <span class="built_in">read</span> -p <span class="string">&quot;请输入选择 [1-5]: &quot;</span> choice</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$choice</span> <span class="keyword">in</span></span><br><span class="line">        1)</span><br><span class="line">            <span class="built_in">read</span> -p <span class="string">&quot;请输入状态码 (如 404): &quot;</span> code</span><br><span class="line">            filter_by_status <span class="string">&quot;<span class="variable">$code</span>&quot;</span></span><br><span class="line">            ;;</span><br><span class="line">        2)</span><br><span class="line">            <span class="built_in">read</span> -p <span class="string">&quot;请输入IP地址或部分IP: &quot;</span> ip</span><br><span class="line">            filter_by_ip <span class="string">&quot;<span class="variable">$ip</span>&quot;</span></span><br><span class="line">            ;;</span><br><span class="line">        3)</span><br><span class="line">            <span class="built_in">read</span> -p <span class="string">&quot;请输入开始时间 (格式: 10/Oct/2023:13): &quot;</span> start</span><br><span class="line">            <span class="built_in">read</span> -p <span class="string">&quot;请输入结束时间 (格式: 10/Oct/2023:14): &quot;</span> end</span><br><span class="line">            filter_by_time <span class="string">&quot;<span class="variable">$start</span>&quot;</span> <span class="string">&quot;<span class="variable">$end</span>&quot;</span></span><br><span class="line">            ;;</span><br><span class="line">        4)</span><br><span class="line">            <span class="built_in">read</span> -p <span class="string">&quot;请输入URL关键词: &quot;</span> keyword</span><br><span class="line">            filter_by_url <span class="string">&quot;<span class="variable">$keyword</span>&quot;</span></span><br><span class="line">            ;;</span><br><span class="line">        5)</span><br><span class="line">            <span class="built_in">read</span> -p <span class="string">&quot;请输入HTTP方法 (GET/POST等): &quot;</span> method</span><br><span class="line">            filter_by_method <span class="string">&quot;<span class="variable">$method</span>&quot;</span></span><br><span class="line">            ;;</span><br><span class="line">        *)</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;无效选择&quot;</span></span><br><span class="line">            ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">filter_by_status</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> code=<span class="variable">$1</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>=== 状态码 <span class="variable">$code</span> 的访问记录 ===<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    grep <span class="string">&quot; <span class="variable">$code</span> &quot;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | \</span><br><span class="line">        awk -v code=<span class="string">&quot;<span class="variable">$code</span>&quot;</span> <span class="string">&#x27;$9 == code &#123;</span></span><br><span class="line"><span class="string">            printf &quot;%-15s %-10s %-50s %-10s %s\n&quot;, </span></span><br><span class="line"><span class="string">                   $1, $4, $7, $9, length($12)&gt;50?substr($12,1,50)&quot;...&quot;:$12</span></span><br><span class="line"><span class="string">        &#125;&#x27;</span> | <span class="built_in">head</span> -20</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">local</span> count=$(grep -c <span class="string">&quot; <span class="variable">$code</span> &quot;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\n总计: <span class="variable">$count</span> 条记录&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">filter_by_ip</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> ip=<span class="variable">$1</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>=== IP包含 &#x27;<span class="variable">$ip</span>&#x27; 的访问记录 ===<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    grep <span class="string">&quot;^<span class="variable">$ip</span>&quot;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | \</span><br><span class="line">        awk <span class="string">&#x27;&#123;printf &quot;%-15s %-10s %-50s %-10s %s\n&quot;, </span></span><br><span class="line"><span class="string">                   $1, $4, $7, $9, length($12)&gt;50?substr($12,1,50)&quot;...&quot;:$12&#125;&#x27;</span> | \</span><br><span class="line">        <span class="built_in">head</span> -20</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">local</span> count=$(grep -c <span class="string">&quot;^<span class="variable">$ip</span>&quot;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\n总计: <span class="variable">$count</span> 条记录&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">filter_by_time</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> start=<span class="variable">$1</span></span><br><span class="line">    <span class="built_in">local</span> end=<span class="variable">$2</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>=== 时间范围 <span class="variable">$start</span> 到 <span class="variable">$end</span> 的访问记录 ===<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 简化处理，实际需要更精确的时间解析</span></span><br><span class="line">    sed -n <span class="string">&quot;/\[<span class="variable">$start</span>/,/\[<span class="variable">$end</span>/p&quot;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | \</span><br><span class="line">        awk <span class="string">&#x27;&#123;printf &quot;%-15s %-10s %-50s %-10s %s\n&quot;, </span></span><br><span class="line"><span class="string">                   $1, $4, $7, $9, length($12)&gt;50?substr($12,1,50)&quot;...&quot;:$12&#125;&#x27;</span> | \</span><br><span class="line">        <span class="built_in">head</span> -20</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">filter_by_url</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> keyword=<span class="variable">$1</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>=== URL包含 &#x27;<span class="variable">$keyword</span>&#x27; 的访问记录 ===<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    grep <span class="string">&quot;\&quot;GET.*<span class="variable">$keyword</span>&quot;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | \</span><br><span class="line">        awk -v kw=<span class="string">&quot;<span class="variable">$keyword</span>&quot;</span> <span class="string">&#x27;&#123;printf &quot;%-15s %-10s %-50s %-10s %s\n&quot;, </span></span><br><span class="line"><span class="string">                   $1, $4, $7, $9, length($12)&gt;50?substr($12,1,50)&quot;...&quot;:$12&#125;&#x27;</span> | \</span><br><span class="line">        <span class="built_in">head</span> -20</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">local</span> count=$(grep -c <span class="string">&quot;\&quot;GET.*<span class="variable">$keyword</span>&quot;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\n总计: <span class="variable">$count</span> 条记录&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="第6步：实现主菜单和输出功能"><a href="#第6步：实现主菜单和输出功能" class="headerlink" title="第6步：实现主菜单和输出功能"></a>第6步：实现主菜单和输出功能</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 显示主菜单</span></span><br><span class="line"><span class="function"><span class="title">show_menu</span></span>() &#123;</span><br><span class="line">    clear</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;BLUE&#125;</span>========================================<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;BLUE&#125;</span>        Nginx/Apache 日志分析器         <span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;BLUE&#125;</span>========================================<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;日志文件: <span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;日志类型: <span class="variable">$LOG_TYPE</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;请选择分析模式:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot; 1) 基础访问统计&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot; 2) 访问量最高的IP&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot; 3) 访问量最高的IP（含地理位置）&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot; 4) 热门页面统计&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot; 5) HTTP状态码统计&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot; 6) 按小时访问统计&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot; 7) 文件类型统计&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot; 8) 自定义过滤分析&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot; 9) 运行所有分析&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot; 0) 退出&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行所有分析</span></span><br><span class="line"><span class="function"><span class="title">run_all_analysis</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>正在执行完整分析...<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    basic_stats</span><br><span class="line">    top_ips 20</span><br><span class="line">    top_pages 20</span><br><span class="line">    status_codes</span><br><span class="line">    hourly_stats</span><br><span class="line">    file_types</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>分析完成！<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出结果到文件</span></span><br><span class="line"><span class="function"><span class="title">output_to_file</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> [[ -n <span class="string">&quot;<span class="variable">$OUTPUT_FILE</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;日志分析报告&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;==============&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;日志文件: <span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;分析时间: <span class="subst">$(date)</span>&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 重定向所有输出到文件</span></span><br><span class="line">            basic_stats 2&gt;/dev/null</span><br><span class="line">            top_ips 20 2&gt;/dev/null</span><br><span class="line">            top_pages 20 2&gt;/dev/null</span><br><span class="line">            status_codes 2&gt;/dev/null</span><br><span class="line">            hourly_stats 2&gt;/dev/null</span><br><span class="line">            file_types 2&gt;/dev/null</span><br><span class="line">        &#125; &gt; <span class="string">&quot;<span class="variable">$OUTPUT_FILE</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>分析结果已保存到: $OUTPUT_FILE<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主函数</span></span><br><span class="line"><span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    parse_args <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查日志文件</span></span><br><span class="line">    <span class="keyword">if</span> [[ ! -f <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>错误: 日志文件不存在: $LOG_FILE<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查文件是否为空</span></span><br><span class="line">    <span class="keyword">if</span> [[ ! -s <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>错误: 日志文件为空<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>开始分析日志: $LOG_FILE<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 如果指定了输出文件，直接运行完整分析</span></span><br><span class="line">    <span class="keyword">if</span> [[ -n <span class="string">&quot;<span class="variable">$OUTPUT_FILE</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        run_all_analysis</span><br><span class="line">        output_to_file</span><br><span class="line">        <span class="built_in">exit</span> 0</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 交互式菜单</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">        show_menu</span><br><span class="line">        <span class="built_in">read</span> -p <span class="string">&quot;请输入选择 [0-9]: &quot;</span> choice</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">case</span> <span class="variable">$choice</span> <span class="keyword">in</span></span><br><span class="line">            1) basic_stats ;;</span><br><span class="line">            2) top_ips 20 ;;</span><br><span class="line">            3) top_ips_with_location ;;</span><br><span class="line">            4) top_pages 20 ;;</span><br><span class="line">            5) status_codes ;;</span><br><span class="line">            6) hourly_stats ;;</span><br><span class="line">            7) file_types ;;</span><br><span class="line">            8) custom_filter ;;</span><br><span class="line">            9) run_all_analysis ;;</span><br><span class="line">            0) </span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;感谢使用！&quot;</span></span><br><span class="line">                <span class="built_in">exit</span> 0</span><br><span class="line">                ;;</span><br><span class="line">            *)</span><br><span class="line">                <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>无效选择，请重新输入<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">                ;;</span><br><span class="line">        <span class="keyword">esac</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> [[ <span class="variable">$choice</span> -ne 0 ]]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="built_in">read</span> -p <span class="string">&quot;按回车键继续...&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="第7步：添加脚本执行部分"><a href="#第7步：添加脚本执行部分" class="headerlink" title="第7步：添加脚本执行部分"></a>第7步：添加脚本执行部分</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试函数（开发时使用）</span></span><br><span class="line"><span class="function"><span class="title">run_tests</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>运行测试...<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    test_parse</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;测试完成&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查是否直接运行脚本</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$&#123;BASH_SOURCE[0]&#125;</span>&quot;</span> == <span class="string">&quot;<span class="variable">$&#123;0&#125;</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># 如果第一个参数是test，运行测试</span></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> == <span class="string">&quot;test&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        run_tests</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        main <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>



<h2 id="三、使用示例"><a href="#三、使用示例" class="headerlink" title="三、使用示例"></a>三、使用示例</h2><h3 id="1-基本使用"><a href="#1-基本使用" class="headerlink" title="1. 基本使用"></a>1. 基本使用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 给脚本添加执行权限</span></span><br><span class="line"><span class="built_in">chmod</span> +x log_analyzer.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分析nginx日志</span></span><br><span class="line">./log_analyzer.sh /var/log/nginx/access.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分析apache日志</span></span><br><span class="line">./log_analyzer.sh -t apache /var/log/apache2/access.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出到文件</span></span><br><span class="line">./log_analyzer.sh -o report.txt access.log</span><br></pre></td></tr></table></figure>



<h3 id="2-直接统计访问量最高的IP"><a href="#2-直接统计访问量最高的IP" class="headerlink" title="2. 直接统计访问量最高的IP"></a>2. 直接统计访问量最高的IP</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 最简单的方式</span></span><br><span class="line">awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> access.log | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -rn | <span class="built_in">head</span> -10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用我们的脚本</span></span><br><span class="line">./log_analyzer.sh access.log</span><br><span class="line"><span class="comment"># 然后选择选项2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者创建专用脚本</span></span><br><span class="line"><span class="built_in">cat</span> &gt; top_ips.sh &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">LOG_FILE=<span class="string">&quot;<span class="variable">$&#123;1:-access.log&#125;</span>&quot;</span></span><br><span class="line">COUNT=<span class="string">&quot;<span class="variable">$&#123;2:-10&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 访问量最高的IP (Top <span class="variable">$COUNT</span>) ===&quot;</span></span><br><span class="line">awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | \</span><br><span class="line">    <span class="built_in">sort</span> | \</span><br><span class="line">    <span class="built_in">uniq</span> -c | \</span><br><span class="line">    <span class="built_in">sort</span> -rn | \</span><br><span class="line">    <span class="built_in">head</span> -n <span class="string">&quot;<span class="variable">$COUNT</span>&quot;</span> | \</span><br><span class="line">    awk <span class="string">&#x27;&#123;printf &quot;IP: %-15s 访问次数: %-10s\n&quot;, $2, $1&#125;&#x27;</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> +x top_ips.sh</span><br><span class="line">./top_ips.sh access.log 20</span><br></pre></td></tr></table></figure>



<h2 id="四、进阶功能扩展建议"><a href="#四、进阶功能扩展建议" class="headerlink" title="四、进阶功能扩展建议"></a>四、进阶功能扩展建议</h2><h3 id="1-添加性能分析"><a href="#1-添加性能分析" class="headerlink" title="1. 添加性能分析"></a>1. 添加性能分析</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">analyze_performance</span></span>() &#123;</span><br><span class="line">    <span class="comment"># 统计响应时间（如果日志包含）</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== 响应时间分析 ===&quot;</span></span><br><span class="line">    awk <span class="string">&#x27;&#123;if ($(NF-1) ~ /^[0-9.]+$/) print $(NF-1)&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | \</span><br><span class="line">        <span class="built_in">sort</span> -n | \</span><br><span class="line">        awk <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">            sum+=$1; </span></span><br><span class="line"><span class="string">            arr[NR]=$1</span></span><br><span class="line"><span class="string">        &#125; END &#123;</span></span><br><span class="line"><span class="string">            if(NR&gt;0) &#123;</span></span><br><span class="line"><span class="string">                printf &quot;平均响应时间: %.2fms\n&quot;, sum/NR;</span></span><br><span class="line"><span class="string">                printf &quot;最小响应时间: %.2fms\n&quot;, arr[1];</span></span><br><span class="line"><span class="string">                printf &quot;最大响应时间: %.2fms\n&quot;, arr[NR];</span></span><br><span class="line"><span class="string">                printf &quot;中位数响应时间: %.2fms\n&quot;, (NR%2==1)?arr[(NR+1)/2]:(arr[NR/2]+arr[NR/2+1])/2;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-添加安全分析"><a href="#2-添加安全分析" class="headerlink" title="2. 添加安全分析"></a>2. 添加安全分析</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">security_analysis</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== 安全分析 ===&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 扫描可疑请求</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. 扫描可疑URL:&quot;</span></span><br><span class="line">    grep -E <span class="string">&quot;(\.\./|\.\.\\|/etc/passwd|/bin/sh|cmd\.exe)&quot;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | <span class="built_in">head</span> -10</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 扫描扫描器特征</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\n2. 可能的扫描器:&quot;</span></span><br><span class="line">    grep -i <span class="string">&quot;scan|nmap|sqlmap|nikto|wpscan&quot;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | <span class="built_in">head</span> -10</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 暴力破解尝试</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\n3. 登录失败统计:&quot;</span></span><br><span class="line">    grep <span class="string">&quot;POST.*login&quot;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | grep <span class="string">&quot; 401 \| 403 &quot;</span> | \</span><br><span class="line">        awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -rn | <span class="built_in">head</span> -10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="五、学习要点总结"><a href="#五、学习要点总结" class="headerlink" title="五、学习要点总结"></a>五、学习要点总结</h2><p>通过这个项目，你学到了：</p>
<ol>
<li><strong>Shell脚本结构</strong>：合理的函数组织和模块化设计</li>
<li><strong>文本处理三剑客</strong>：<ul>
<li><code>grep</code>：模式匹配和过滤</li>
<li><code>awk</code>：强大的字段处理和统计分析</li>
<li><code>sed</code>：流编辑和文本转换</li>
</ul>
</li>
<li><strong>管道和重定向</strong>：组合多个命令实现复杂功能</li>
<li><strong>用户交互</strong>：菜单设计和参数解析</li>
<li><strong>性能考虑</strong>：流式处理大文件，避免内存溢出</li>
<li><strong>错误处理</strong>：增强脚本的健壮性</li>
</ol>
<h2 id="六、下一步提升建议"><a href="#六、下一步提升建议" class="headerlink" title="六、下一步提升建议"></a>六、下一步提升建议</h2><ol>
<li>添加对JSON格式日志的支持</li>
<li>实现实时日志监控功能</li>
<li>添加图形化报表输出（使用gnuplot）</li>
<li>支持分布式日志分析</li>
<li>添加邮件报警功能</li>
</ol>
<p>你可以从这个基础版本开始，逐步添加更多功能，在实践中不断提升Shell编程能力！</p>
<p>我们将在已有基础上继续扩展和完善日志分析器，增加更多实用功能，并优化代码结构。</p>
<p>扩展方向：</p>
<ol>
<li>增加更多分析维度（如：UserAgent分析、Referer分析、请求方法分析等）</li>
<li>增加趋势分析（如：按天统计、按周统计）</li>
<li>增加异常检测（如：异常状态码、异常请求量）</li>
<li>增加报表生成（如：HTML报表）</li>
<li>优化代码结构，提高可维护性</li>
</ol>
<p>由于代码较长，我们将逐步添加新功能。首先，我们调整代码结构，将不同的功能模块分类。</p>
<p>我们创建以下函数组：</p>
<ul>
<li>核心解析函数</li>
<li>基础统计函数</li>
<li>深入分析函数</li>
<li>安全分析函数</li>
<li>输出和报表函数</li>
</ul>
<p>同时，我们将添加配置文件，允许用户自定义日志格式（虽然目前只支持nginx和apache的combined格式，但可以扩展）。</p>
<p>由于时间关系，我们不会实现所有功能，但会给出框架和示例。</p>
<p>我们开始逐步改进：</p>
<p>第一步：重构代码，将函数分类，并引入配置文件的概念（这里用变量代替，实际可以写一个配置文件）。</p>
<p>第二步：增加UserAgent分析、请求方法分析、Referer分析。</p>
<p>第三步：增加按天统计、按周统计。</p>
<p>第四步：增加异常检测。</p>
<p>第五步：增加HTML报表生成。</p>
<p>由于代码量会很大，我们只实现部分功能，并给出扩展思路。</p>
<p>我们先从重构开始，将之前的函数整理到不同的模块中。</p>
<p>注意：为了保持清晰，我们将只给出新增和修改的代码部分，但会尽量保持完整性。</p>
<p>由于我们是在原脚本上扩展，我们重新组织脚本结构如下：</p>
<ol>
<li>初始化部分（颜色定义、全局变量、帮助函数）</li>
<li>参数解析</li>
<li>日志解析函数</li>
<li>分析模块<br>a. 基础统计<br>b. IP分析<br>c. 页面分析<br>d. 状态码分析<br>e. 时间段分析<br>f. 文件类型分析<br>g. 用户代理分析<br>h. 请求方法分析<br>i. 来源分析<br>j. 安全分析<br>k. 趋势分析</li>
<li>输出模块（包括文本输出和HTML输出）</li>
<li>主控模块</li>
</ol>
<p>我们一步一步来，先增加用户代理分析、请求方法分析、来源分析。</p>
<p>由于原脚本已经比较长，我们将以新增功能为主，并调整主菜单。</p>
<p>我们首先在分析模块中添加以下函数：</p>
<ul>
<li>user_agent_stats: 统计浏览器和操作系统</li>
<li>request_method_stats: 统计HTTP请求方法</li>
<li>referer_stats: 统计来源页面</li>
</ul>
<p>同时，我们添加一个趋势分析函数：</p>
<ul>
<li>daily_stats: 按天统计访问量</li>
</ul>
<p>然后，我们添加一个安全分析函数：</p>
<ul>
<li>security_analysis: 检测一些常见攻击模式</li>
</ul>
<p>最后，我们添加HTML报表生成功能。</p>
<p>由于这是一个终端日志分析器，我们可能不需要太复杂的HTML报表，但可以提供一个简单的HTML输出。</p>
<p>考虑到时间和篇幅，我们只实现部分功能，并给出扩展方法。</p>
<p>现在，让我们开始添加新功能。</p>
<h1 id="终端日志分析器扩展与完善"><a href="#终端日志分析器扩展与完善" class="headerlink" title="终端日志分析器扩展与完善"></a>终端日志分析器扩展与完善</h1><p>我将继续扩展和完善这个日志分析器，增加更多实用功能、优化性能和用户体验。</p>
<h2 id="一、扩展功能设计"><a href="#一、扩展功能设计" class="headerlink" title="一、扩展功能设计"></a>一、扩展功能设计</h2><h3 id="1-1-新增功能模块"><a href="#1-1-新增功能模块" class="headerlink" title="1.1 新增功能模块"></a>1.1 新增功能模块</h3><ul>
<li><strong>实时监控</strong>：动态显示日志变化</li>
<li><strong>异常检测</strong>：自动识别异常访问模式</li>
<li><strong>性能分析</strong>：响应时间和吞吐量统计</li>
<li><strong>报告生成</strong>：HTML和JSON格式输出</li>
<li><strong>分布式分析</strong>：多日志文件处理</li>
<li><strong>可视化</strong>：使用gnuplot生成图表</li>
</ul>
<h3 id="1-2-优化方向"><a href="#1-2-优化方向" class="headerlink" title="1.2 优化方向"></a>1.2 优化方向</h3><ul>
<li>提高大文件处理性能</li>
<li>添加配置文件支持</li>
<li>增加测试套件</li>
<li>支持更多日志格式</li>
<li>添加插件系统</li>
</ul>
<h2 id="二、扩展实现"><a href="#二、扩展实现" class="headerlink" title="二、扩展实现"></a>二、扩展实现</h2><h3 id="第1步：添加配置文件和初始化函数"><a href="#第1步：添加配置文件和初始化函数" class="headerlink" title="第1步：添加配置文件和初始化函数"></a>第1步：添加配置文件和初始化函数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># log_analyzer.sh - 扩展版日志分析器</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============== 配置部分 ==============</span></span><br><span class="line">CONFIG_DIR=<span class="string">&quot;<span class="variable">$&#123;HOME&#125;</span>/.log-analyzer&quot;</span></span><br><span class="line">CONFIG_FILE=<span class="string">&quot;<span class="variable">$&#123;CONFIG_DIR&#125;</span>/config&quot;</span></span><br><span class="line">DEFAULT_FORMATS=<span class="string">&quot;<span class="variable">$&#123;CONFIG_DIR&#125;</span>/formats.conf&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化配置</span></span><br><span class="line"><span class="function"><span class="title">init_config</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> [[ ! -d <span class="string">&quot;<span class="variable">$CONFIG_DIR</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$CONFIG_DIR</span>&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>创建配置目录: $CONFIG_DIR<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [[ ! -f <span class="string">&quot;<span class="variable">$CONFIG_FILE</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">cat</span> &gt; <span class="string">&quot;<span class="variable">$CONFIG_FILE</span>&quot;</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment"># 日志分析器配置文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认设置</span></span><br><span class="line">DEFAULT_LOG_TYPE=<span class="string">&quot;nginx&quot;</span></span><br><span class="line">DEFAULT_TOP_N=20</span><br><span class="line">DEFAULT_OUTPUT_FORMAT=<span class="string">&quot;text&quot;</span></span><br><span class="line">COLOR_OUTPUT=<span class="literal">true</span></span><br><span class="line">SAVE_HISTORY=<span class="literal">true</span></span><br><span class="line">MAX_HISTORY_DAYS=30</span><br><span class="line">HTML_TEMPLATE=<span class="string">&quot;<span class="variable">$&#123;HOME&#125;</span>/.log-analyzer/template.html&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 性能设置</span></span><br><span class="line">USE_PARALLEL=<span class="literal">true</span>    <span class="comment"># 使用并行处理</span></span><br><span class="line">PARALLEL_JOBS=4      <span class="comment"># 并行任务数</span></span><br><span class="line">CACHE_RESULTS=<span class="literal">true</span>   <span class="comment"># 缓存结果</span></span><br><span class="line">CACHE_TTL=300        <span class="comment"># 缓存有效期(秒)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通知设置</span></span><br><span class="line">ENABLE_ALERTS=<span class="literal">false</span></span><br><span class="line">ALERT_THRESHOLD_RPS=100</span><br><span class="line">ALERT_THRESHOLD_ERRORS=50</span><br><span class="line"></span><br><span class="line"><span class="comment"># API设置 (用于地理位置查询)</span></span><br><span class="line">ENABLE_GEOIP=<span class="literal">true</span></span><br><span class="line">GEOIP_SERVICE=<span class="string">&quot;ip-api&quot;</span>  <span class="comment"># ip-api或ipinfo</span></span><br><span class="line">IPINFO_TOKEN=<span class="string">&quot;&quot;</span></span><br><span class="line">EOF</span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>创建默认配置文件<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [[ ! -f <span class="string">&quot;<span class="variable">$DEFAULT_FORMATS</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">cat</span> &gt; <span class="string">&quot;<span class="variable">$DEFAULT_FORMATS</span>&quot;</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment"># 日志格式定义</span></span><br><span class="line"><span class="comment"># 格式: 名称 | 正则表达式 | 字段映射</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Nginx 标准格式</span></span><br><span class="line">nginx_standard|^(\S+) (\S+) (\S+) \[([^\]]+)\] <span class="string">&quot;(\S+) (\S+) (\S+)&quot;</span> (\d+) (\d+) <span class="string">&quot;([^&quot;</span>]*)<span class="string">&quot; &quot;</span>([^<span class="string">&quot;]*)&quot;</span>|ip,remote_user,time_local,request_method,request_uri,http_version,status,body_bytes_sent,http_referer,http_user_agent</span><br><span class="line"></span><br><span class="line"><span class="comment"># Nginx 组合格式</span></span><br><span class="line">nginx_combined|^(\S+) - (\S+) \[([^\]]+)\] <span class="string">&quot;(\S+) (\S+) (\S+)&quot;</span> (\d+) (\d+) <span class="string">&quot;([^&quot;</span>]*)<span class="string">&quot; &quot;</span>([^<span class="string">&quot;]*)&quot;</span>|ip,remote_user,time_local,request_method,request_uri,http_version,status,body_bytes_sent,http_referer,http_user_agent</span><br><span class="line"></span><br><span class="line"><span class="comment"># Apache 组合格式</span></span><br><span class="line">apache_combined|^(\S+) (\S+) (\S+) \[([^\]]+)\] <span class="string">&quot;(\S+) (\S+) (\S+)&quot;</span> (\d+) (\d+) <span class="string">&quot;([^&quot;</span>]*)<span class="string">&quot; &quot;</span>([^<span class="string">&quot;]*)&quot;</span>|ip,ident,remote_user,time_local,request_method,request_uri,http_version,status,body_bytes_sent,http_referer,http_user_agent</span><br><span class="line"></span><br><span class="line"><span class="comment"># ELB (AWS) 格式</span></span><br><span class="line">elb|^(\S+) (\S+) (\S+) (\S+) (\S+) (\S+) (\S+) (\S+) (\S+) (\S+) (\S+) (\S+) (\S+) (\S+) (\S+) (\S+) <span class="string">&quot;([^&quot;</span>]*)<span class="string">&quot; &quot;</span>([^<span class="string">&quot;]*)&quot;</span>|timestamp,elb,client_ip,backend_ip,request_processing_time,backend_processing_time,response_processing_time,elb_status_code,backend_status_code,received_bytes,sent_bytes,request_method,request_uri,http_version,user_agent,ssl_cipher,ssl_protocol</span><br><span class="line">EOF</span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>创建日志格式配置文件<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 加载配置</span></span><br><span class="line">    <span class="keyword">if</span> [[ -f <span class="string">&quot;<span class="variable">$CONFIG_FILE</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">source</span> <span class="string">&quot;<span class="variable">$CONFIG_FILE</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载配置文件</span></span><br><span class="line"><span class="function"><span class="title">load_config</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> key=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    <span class="built_in">local</span> default=<span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [[ -f <span class="string">&quot;<span class="variable">$CONFIG_FILE</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">local</span> value=$(grep <span class="string">&quot;^<span class="variable">$key</span>=&quot;</span> <span class="string">&quot;<span class="variable">$CONFIG_FILE</span>&quot;</span> | <span class="built_in">cut</span> -d<span class="string">&#x27;=&#x27;</span> -f2- | sed <span class="string">&quot;s/^[&#x27;\&quot;]//;s/[&#x27;\&quot;]$//&quot;</span>)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;value:-<span class="variable">$default</span>&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$default</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="第2步：优化日志解析器，支持多种格式"><a href="#第2步：优化日志解析器，支持多种格式" class="headerlink" title="第2步：优化日志解析器，支持多种格式"></a>第2步：优化日志解析器，支持多种格式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 增强的日志解析器</span></span><br><span class="line"><span class="function"><span class="title">parse_log_enhanced</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> line=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    <span class="built_in">local</span> format=<span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 加载格式定义</span></span><br><span class="line">    <span class="built_in">local</span> format_def=$(grep <span class="string">&quot;^<span class="variable">$&#123;format&#125;</span>|&quot;</span> <span class="string">&quot;<span class="variable">$DEFAULT_FORMATS</span>&quot;</span> 2&gt;/dev/null || <span class="built_in">echo</span> <span class="string">&quot;&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [[ -n <span class="string">&quot;<span class="variable">$format_def</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># 使用预定义格式</span></span><br><span class="line">        <span class="built_in">local</span> regex=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$format_def</span>&quot;</span> | <span class="built_in">cut</span> -d<span class="string">&#x27;|&#x27;</span> -f2)</span><br><span class="line">        <span class="built_in">local</span> fields=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$format_def</span>&quot;</span> | <span class="built_in">cut</span> -d<span class="string">&#x27;|&#x27;</span> -f3)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$line</span>&quot;</span> =~ <span class="variable">$regex</span> ]]; <span class="keyword">then</span></span><br><span class="line">            <span class="comment"># 解析字段</span></span><br><span class="line">            IFS=<span class="string">&#x27;,&#x27;</span> <span class="built_in">read</span> -r -a field_names &lt;&lt;&lt; <span class="string">&quot;<span class="variable">$fields</span>&quot;</span></span><br><span class="line">            <span class="built_in">local</span> result=<span class="string">&quot;&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;!field_names[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">                <span class="built_in">let</span> match_index=i+1</span><br><span class="line">                <span class="built_in">local</span> value=<span class="string">&quot;<span class="variable">$&#123;BASH_REMATCH[$match_index]&#125;</span>&quot;</span></span><br><span class="line">                result+=<span class="string">&quot;<span class="variable">$&#123;field_names[$i]&#125;</span>:<span class="variable">$value</span> &quot;</span></span><br><span class="line">            <span class="keyword">done</span></span><br><span class="line">            </span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$result</span>&quot;</span></span><br><span class="line">            <span class="built_in">return</span> 0</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment"># 回退到自动检测</span></span><br><span class="line">        parse_log_auto <span class="string">&quot;<span class="variable">$line</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自动检测日志格式</span></span><br><span class="line"><span class="function"><span class="title">parse_log_auto</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> line=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 尝试不同格式</span></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$line</span>&quot;</span> =~ ^([0-9\.]+)\ -\ (.*)\ \[([^\]]+)\]\ \&quot;([^\&quot;]+)\&quot;\ ([0-9]+)\ ([0-9]+) ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># Nginx/Apache 格式</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;ip:<span class="variable">$&#123;BASH_REMATCH[1]&#125;</span> time:<span class="variable">$&#123;BASH_REMATCH[3]&#125;</span> request:<span class="variable">$&#123;BASH_REMATCH[4]&#125;</span> status:<span class="variable">$&#123;BASH_REMATCH[5]&#125;</span> size:<span class="variable">$&#123;BASH_REMATCH[6]&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> [[ <span class="string">&quot;<span class="variable">$line</span>&quot;</span> =~ ^([0-9\.]+)\ ([^\ ]+)\ ([^\ ]+)\ \[([^\]]+)\]\ \&quot;([^\&quot;]+)\&quot;\ ([0-9]+)\ ([0-9]+) ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># ELB 格式</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;ip:<span class="variable">$&#123;BASH_REMATCH[1]&#125;</span> time:<span class="variable">$&#123;BASH_REMATCH[4]&#125;</span> request:<span class="variable">$&#123;BASH_REMATCH[5]&#125;</span> status:<span class="variable">$&#123;BASH_REMATCH[6]&#125;</span> size:<span class="variable">$&#123;BASH_REMATCH[7]&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> [[ <span class="string">&quot;<span class="variable">$line</span>&quot;</span> =~ ^([^\ ]+)\ ([^\ ]+)\ ([^\ ]+)\ ([^\ ]+)\ \[([^\]]+)\]\ ([^\ ]+)\ ([^\ ]+) ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># 其他常见格式</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;ip:<span class="variable">$&#123;BASH_REMATCH[1]&#125;</span> time:<span class="variable">$&#123;BASH_REMATCH[5]&#125;</span> method:<span class="variable">$&#123;BASH_REMATCH[6]&#125;</span> url:<span class="variable">$&#123;BASH_REMATCH[7]&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;unknown:无法解析的格式&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="第3步：添加实时监控功能"><a href="#第3步：添加实时监控功能" class="headerlink" title="第3步：添加实时监控功能"></a>第3步：添加实时监控功能</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 实时日志监控</span></span><br><span class="line"><span class="function"><span class="title">realtime_monitor</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>=== 实时日志监控 ===<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;监控文件: <span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;按 Ctrl+C 停止监控&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 显示最后几行</span></span><br><span class="line">    <span class="built_in">tail</span> -n 10 <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;等待新日志...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 使用inotifywait监听文件变化</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">command</span> -v inotifywait &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">tail</span> -f <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | <span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span></span><br><span class="line">            clear</span><br><span class="line">            show_realtime_stats <span class="string">&quot;<span class="variable">$line</span>&quot;</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment"># 回退到简单轮询</span></span><br><span class="line">        <span class="built_in">local</span> last_size=$(<span class="built_in">stat</span> -c%s <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">sleep</span> 2</span><br><span class="line">            <span class="built_in">local</span> current_size=$(<span class="built_in">stat</span> -c%s <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> [[ <span class="variable">$current_size</span> -gt <span class="variable">$last_size</span> ]]; <span class="keyword">then</span></span><br><span class="line">                clear</span><br><span class="line">                <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>发现新日志 (<span class="variable">$&#123;current_size&#125;</span> bytes)<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">                <span class="built_in">tail</span> -c $((current_size - last_size)) <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line">                last_size=<span class="variable">$current_size</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示实时统计</span></span><br><span class="line"><span class="function"><span class="title">show_realtime_stats</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> new_line=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 解析新行</span></span><br><span class="line">    <span class="built_in">local</span> parsed=$(parse_log_line <span class="string">&quot;<span class="variable">$new_line</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;新访问: <span class="variable">$parsed</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 更新计数器</span></span><br><span class="line">    <span class="built_in">local</span> ip=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$parsed</span>&quot;</span> | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class="line">    <span class="built_in">local</span> status=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$parsed</span>&quot;</span> | awk <span class="string">&#x27;&#123;print $5&#125;&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 简单内存统计（实际项目应用Redis等）</span></span><br><span class="line">    update_counter <span class="string">&quot;total_requests&quot;</span></span><br><span class="line">    update_counter <span class="string">&quot;ip_<span class="variable">$ip</span>&quot;</span></span><br><span class="line">    update_counter <span class="string">&quot;status_<span class="variable">$status</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 显示摘要</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;最近5分钟统计:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  总请求数: <span class="subst">$(get_counter total_requests)</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  独立IP数: <span class="subst">$(count_ip_entries)</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 简单的计数器（使用文件）</span></span><br><span class="line"><span class="function"><span class="title">update_counter</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> key=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    <span class="built_in">local</span> counter_file=<span class="string">&quot;<span class="variable">$&#123;CONFIG_DIR&#125;</span>/counter_<span class="variable">$&#123;key&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">local</span> count=$(<span class="built_in">cat</span> <span class="string">&quot;<span class="variable">$counter_file</span>&quot;</span> 2&gt;/dev/null || <span class="built_in">echo</span> <span class="string">&quot;0&quot;</span>)</span><br><span class="line">    <span class="built_in">echo</span> $((count + <span class="number">1</span>)) &gt; <span class="string">&quot;<span class="variable">$counter_file</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">get_counter</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> key=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> <span class="string">&quot;<span class="variable">$&#123;CONFIG_DIR&#125;</span>/counter_<span class="variable">$&#123;key&#125;</span>&quot;</span> 2&gt;/dev/null || <span class="built_in">echo</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">count_ip_entries</span></span>() &#123;</span><br><span class="line">    <span class="built_in">ls</span> <span class="string">&quot;<span class="variable">$&#123;CONFIG_DIR&#125;</span>&quot;</span>/counter_ip_* 2&gt;/dev/null | <span class="built_in">wc</span> -l</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="第4步：增强异常检测功能"><a href="#第4步：增强异常检测功能" class="headerlink" title="第4步：增强异常检测功能"></a>第4步：增强异常检测功能</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 智能异常检测</span></span><br><span class="line"><span class="function"><span class="title">anomaly_detection</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>=== 异常访问检测 ===<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">local</span> threshold_ip=$(($(wc -l &lt; &quot;<span class="variable">$LOG_FILE</span>&quot;) / <span class="number">100</span>))  <span class="comment"># 超过1%的IP为异常</span></span><br><span class="line">    <span class="built_in">local</span> threshold_url=1000  <span class="comment"># 同一URL访问阈值</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 1. 检测异常高频IP</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;1. 检测高频访问IP:&quot;</span></span><br><span class="line">    awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | \</span><br><span class="line">        <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -rn | \</span><br><span class="line">        awk -v threshold=<span class="string">&quot;<span class="variable">$threshold_ip</span>&quot;</span> <span class="string">&#x27;$1 &gt; threshold &#123;printf &quot;%-15s %-10s (超过阈值: %s)\n&quot;, $2, $1, threshold&#125;&#x27;</span> | \</span><br><span class="line">        <span class="built_in">head</span> -10</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. 检测扫描行为</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\n2. 检测扫描行为:&quot;</span></span><br><span class="line">    grep -E <span class="string">&quot;(admin|login|wp-admin|phpmyadmin|\.git|\.env|config)&quot;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | \</span><br><span class="line">        awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | \</span><br><span class="line">        <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -rn | \</span><br><span class="line">        <span class="built_in">head</span> -5 | <span class="keyword">while</span> <span class="built_in">read</span> count ip; <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;  IP: <span class="variable">$ip</span>, 扫描尝试: <span class="variable">$count</span> 次&quot;</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. 检测异常User-Agent</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\n3. 检测异常User-Agent:&quot;</span></span><br><span class="line">    awk -F<span class="string">&#x27;&quot;&#x27;</span> <span class="string">&#x27;&#123;print $6&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | \</span><br><span class="line">        grep -E <span class="string">&quot;(scanner|crawler|bot|spider|curl|wget|python|java)&quot;</span> | \</span><br><span class="line">        <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -rn | \</span><br><span class="line">        <span class="built_in">head</span> -5</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4. 检测错误爆发</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\n4. 检测错误爆发:&quot;</span></span><br><span class="line">    <span class="built_in">local</span> error_count=$(grep -c <span class="string">&quot; 5[0-9][0-9] &quot;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">local</span> total_count=$(<span class="built_in">wc</span> -l &lt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">local</span> error_rate=$(<span class="built_in">echo</span> <span class="string">&quot;scale=2; <span class="variable">$error_count</span> * 100 / <span class="variable">$total_count</span>&quot;</span> | bc)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (( $(echo &quot;<span class="variable">$error_rate</span> &gt; <span class="number">5</span>&quot; | bc -l) )); <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>警告: 错误率过高: <span class="variable">$&#123;error_rate&#125;</span>%<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">        grep <span class="string">&quot; 5[0-9][0-9] &quot;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | \</span><br><span class="line">            awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | \</span><br><span class="line">            <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -rn | \</span><br><span class="line">            <span class="built_in">head</span> -5</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;错误率正常: <span class="variable">$&#123;error_rate&#125;</span>%&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 5. 检测时间异常（凌晨访问高峰）</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\n5. 检测时间异常:&quot;</span></span><br><span class="line">    awk <span class="string">&#x27;&#123;split($4, time, &quot;:&quot;); hour=substr(time[2],1,2); print hour&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | \</span><br><span class="line">        sed <span class="string">&#x27;s/\[//&#x27;</span> | \</span><br><span class="line">        awk <span class="string">&#x27;$1 &lt; 6 || $1 &gt; 22 &#123;print $1&#125;&#x27;</span> | \</span><br><span class="line">        <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -rn | \</span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">read</span> count hour; <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">if</span> [[ <span class="variable">$count</span> -gt 100 ]]; <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>  警告: 非正常时间(<span class="variable">$&#123;hour&#125;</span>:00)访问: <span class="variable">$count</span> 次<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 机器学习检测（简单版本）</span></span><br><span class="line"><span class="function"><span class="title">ml_anomaly_detection</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>=== 智能异常检测 (机器学习) ===<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 提取特征</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;提取访问特征...&quot;</span></span><br><span class="line">    <span class="built_in">local</span> features_file=<span class="string">&quot;<span class="variable">$&#123;CONFIG_DIR&#125;</span>/features_<span class="subst">$(date +%s)</span>.csv&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 生成特征CSV</span></span><br><span class="line">    awk <span class="string">&#x27;</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        # 基本特征</span></span><br><span class="line"><span class="string">        ip = $1</span></span><br><span class="line"><span class="string">        split($4, time_parts, &quot;:&quot;)</span></span><br><span class="line"><span class="string">        hour = time_parts[2]</span></span><br><span class="line"><span class="string">        request = $7</span></span><br><span class="line"><span class="string">        status = $9</span></span><br><span class="line"><span class="string">        bytes = $10</span></span><br><span class="line"><span class="string">        referer = ($11 == &quot;-&quot; ? &quot;direct&quot; : &quot;external&quot;)</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        # 输出特征</span></span><br><span class="line"><span class="string">        print ip, hour, length(request), status, bytes, referer</span></span><br><span class="line"><span class="string">    &#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> &gt; <span class="string">&quot;<span class="variable">$features_file</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 简单聚类分析</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;分析访问模式...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 1. 计算每个IP的统计特征</span></span><br><span class="line">    awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$features_file</span>&quot;</span> | \</span><br><span class="line">        <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | \</span><br><span class="line">        awk <span class="string">&#x27;BEGIN &#123;</span></span><br><span class="line"><span class="string">            sum=0; sumsq=0; count=0</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            count++</span></span><br><span class="line"><span class="string">            sum+=$1</span></span><br><span class="line"><span class="string">            sumsq+=$1*$1</span></span><br><span class="line"><span class="string">            values[count]=$1</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        END &#123;</span></span><br><span class="line"><span class="string">            mean = sum/count</span></span><br><span class="line"><span class="string">            variance = (sumsq - sum*sum/count)/count</span></span><br><span class="line"><span class="string">            stddev = sqrt(variance)</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            print &quot;总IP数:&quot;, count</span></span><br><span class="line"><span class="string">            print &quot;平均访问次数:&quot;, mean</span></span><br><span class="line"><span class="string">            print &quot;标准差:&quot;, stddev</span></span><br><span class="line"><span class="string">            print &quot;&quot;</span></span><br><span class="line"><span class="string">            print &quot;异常IP (超过2个标准差):&quot;</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            for(i=1; i&lt;=count; i++) &#123;</span></span><br><span class="line"><span class="string">                if(values[i] &gt; mean + 2*stddev) &#123;</span></span><br><span class="line"><span class="string">                    print &quot;  IP访问次数:&quot;, values[i], &quot;(平均:&quot;, mean, &quot;)&quot;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;&#x27;</span> | <span class="built_in">tail</span> -n +7</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">rm</span> <span class="string">&quot;<span class="variable">$features_file</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="第5步：添加性能分析功能"><a href="#第5步：添加性能分析功能" class="headerlink" title="第5步：添加性能分析功能"></a>第5步：添加性能分析功能</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 性能分析模块</span></span><br><span class="line"><span class="function"><span class="title">performance_analysis</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>=== 性能分析 ===<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查日志是否包含响应时间</span></span><br><span class="line">    <span class="keyword">if</span> grep -q <span class="string">&quot;request_time\|upstream_response_time&quot;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span>; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;1. 响应时间分析:&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 提取响应时间（Nginx格式）</span></span><br><span class="line">        grep -o <span class="string">&#x27;request_time=[0-9.]*&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | \</span><br><span class="line">            sed <span class="string">&#x27;s/request_time=//&#x27;</span> | \</span><br><span class="line">            awk <span class="string">&#x27;</span></span><br><span class="line"><span class="string">            BEGIN &#123;</span></span><br><span class="line"><span class="string">                sum=0; count=0; min=999999; max=0</span></span><br><span class="line"><span class="string">                hist[0]=0; hist[1]=0; hist[2]=0; hist[3]=0; hist[4]=0</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">                t = $1 * 1000  # 转换为毫秒</span></span><br><span class="line"><span class="string">                sum += t</span></span><br><span class="line"><span class="string">                count++</span></span><br><span class="line"><span class="string">                if(t &lt; min) min = t</span></span><br><span class="line"><span class="string">                if(t &gt; max) max = t</span></span><br><span class="line"><span class="string">                </span></span><br><span class="line"><span class="string">                # 直方图分档</span></span><br><span class="line"><span class="string">                if(t &lt; 100) hist[0]++</span></span><br><span class="line"><span class="string">                else if(t &lt; 500) hist[1]++</span></span><br><span class="line"><span class="string">                else if(t &lt; 1000) hist[2]++</span></span><br><span class="line"><span class="string">                else if(t &lt; 5000) hist[3]++</span></span><br><span class="line"><span class="string">                else hist[4]++</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            END &#123;</span></span><br><span class="line"><span class="string">                if(count &gt; 0) &#123;</span></span><br><span class="line"><span class="string">                    printf &quot;  样本数: %d\n&quot;, count</span></span><br><span class="line"><span class="string">                    printf &quot;  平均响应时间: %.2fms\n&quot;, sum/count</span></span><br><span class="line"><span class="string">                    printf &quot;  最小响应时间: %.2fms\n&quot;, min</span></span><br><span class="line"><span class="string">                    printf &quot;  最大响应时间: %.2fms\n&quot;, max</span></span><br><span class="line"><span class="string">                    printf &quot;\n  响应时间分布:\n&quot;</span></span><br><span class="line"><span class="string">                    printf &quot;    &lt;100ms:    %d (%.1f%%)\n&quot;, hist[0], hist[0]*100/count</span></span><br><span class="line"><span class="string">                    printf &quot;    100-500ms: %d (%.1f%%)\n&quot;, hist[1], hist[1]*100/count</span></span><br><span class="line"><span class="string">                    printf &quot;    500ms-1s:  %d (%.1f%%)\n&quot;, hist[2], hist[2]*100/count</span></span><br><span class="line"><span class="string">                    printf &quot;    1-5s:      %d (%.1f%%)\n&quot;, hist[3], hist[3]*100/count</span></span><br><span class="line"><span class="string">                    printf &quot;    &gt;5s:       %d (%.1f%%)\n&quot;, hist[4], hist[4]*100/count</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;&#x27;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;1. 响应时间: 日志中未找到响应时间字段&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 吞吐量分析</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\n2. 吞吐量分析:&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 按分钟统计请求数</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;   按分钟请求数统计:&quot;</span></span><br><span class="line">    awk <span class="string">&#x27;&#123;split($4, a, &quot;:&quot;); print a[2]&quot;:&quot;a[3]&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | \</span><br><span class="line">        sed <span class="string">&#x27;s/\[//&#x27;</span> | \</span><br><span class="line">        <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | \</span><br><span class="line">        <span class="built_in">sort</span> -rn | \</span><br><span class="line">        <span class="built_in">head</span> -5 | <span class="keyword">while</span> <span class="built_in">read</span> count time; <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">printf</span> <span class="string">&quot;     %s: %d 请求/分钟\n&quot;</span> <span class="string">&quot;<span class="variable">$time</span>&quot;</span> <span class="string">&quot;<span class="variable">$count</span>&quot;</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 带宽分析</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\n3. 带宽使用分析:&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">local</span> total_bytes=$(awk <span class="string">&#x27;&#123;sum += $10&#125; END &#123;print sum&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> 2&gt;/dev/null)</span><br><span class="line">    <span class="built_in">local</span> total_requests=$(<span class="built_in">wc</span> -l &lt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [[ -n <span class="string">&quot;<span class="variable">$total_bytes</span>&quot;</span> &amp;&amp; <span class="string">&quot;<span class="variable">$total_bytes</span>&quot;</span> -gt 0 ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">local</span> avg_size=$((<span class="variable">$total_bytes</span> / <span class="variable">$total_requests</span>))</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;   平均响应大小: <span class="subst">$(numfmt --to=iec $avg_size)</span>&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;   总传输量: <span class="subst">$(numfmt --to=iec $total_bytes)</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 估算带宽</span></span><br><span class="line">        <span class="built_in">local</span> first_time=$(awk <span class="string">&#x27;&#123;print $4&quot; &quot;$5&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | <span class="built_in">head</span> -1 | sed <span class="string">&#x27;s/\[//;s/\]//&#x27;</span>)</span><br><span class="line">        <span class="built_in">local</span> last_time=$(awk <span class="string">&#x27;&#123;print $4&quot; &quot;$5&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | <span class="built_in">tail</span> -1 | sed <span class="string">&#x27;s/\[//;s/\]//&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> [[ -n <span class="string">&quot;<span class="variable">$first_time</span>&quot;</span> &amp;&amp; -n <span class="string">&quot;<span class="variable">$last_time</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">local</span> first_epoch=$(<span class="built_in">date</span> -d <span class="string">&quot;<span class="variable">$first_time</span>&quot;</span> +%s 2&gt;/dev/null)</span><br><span class="line">            <span class="built_in">local</span> last_epoch=$(<span class="built_in">date</span> -d <span class="string">&quot;<span class="variable">$last_time</span>&quot;</span> +%s 2&gt;/dev/null)</span><br><span class="line">            <span class="built_in">local</span> duration=$((last_epoch - first_epoch))</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> [[ <span class="variable">$duration</span> -gt 0 ]]; <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">local</span> avg_bps=$((total_bytes * <span class="number">8</span> / duration))</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;   平均带宽: <span class="subst">$(numfmt --to=iec-i $avg_bps)</span>/s&quot;</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;   峰值估算: <span class="subst">$(numfmt --to=iec-i $((avg_bps * 2)</span>))/s&quot;</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="第6步：添加报表生成功能"><a href="#第6步：添加报表生成功能" class="headerlink" title="第6步：添加报表生成功能"></a>第6步：添加报表生成功能</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成HTML报表</span></span><br><span class="line"><span class="function"><span class="title">generate_html_report</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> output_file=<span class="string">&quot;<span class="variable">$&#123;1:-report_$(date +%Y%m%d_%H%M%S).html&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>正在生成HTML报告: $output_file<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cat</span> &gt; <span class="string">&quot;<span class="variable">$output_file</span>&quot;</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;zh-CN&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;日志分析报告 - $(<span class="built_in">date</span>)&lt;/title&gt;</span><br><span class="line">    &lt;style&gt;</span><br><span class="line">        * &#123; margin: 0; padding: 0; box-sizing: border-box; &#125;</span><br><span class="line">        body &#123;</span><br><span class="line">            font-family: <span class="string">&#x27;Segoe UI&#x27;</span>, <span class="string">&#x27;Microsoft YaHei&#x27;</span>, sans-serif;</span><br><span class="line">            line-height: 1.6;</span><br><span class="line">            color: <span class="comment">#333;</span></span><br><span class="line">            background: <span class="comment">#f5f7fa;</span></span><br><span class="line">            padding: 20px;</span><br><span class="line">        &#125;</span><br><span class="line">        .container &#123;</span><br><span class="line">            max-width: 1200px;</span><br><span class="line">            margin: 0 auto;</span><br><span class="line">            background: white;</span><br><span class="line">            border-radius: 10px;</span><br><span class="line">            box-shadow: 0 2px 20px rgba(0,0,0,0.1);</span><br><span class="line">            padding: 30px;</span><br><span class="line">        &#125;</span><br><span class="line">        header &#123;</span><br><span class="line">            text-align: center;</span><br><span class="line">            margin-bottom: 40px;</span><br><span class="line">            padding-bottom: 20px;</span><br><span class="line">            border-bottom: 3px solid <span class="comment">#4a6fa5;</span></span><br><span class="line">        &#125;</span><br><span class="line">        h1 &#123;</span><br><span class="line">            color: <span class="comment">#2c3e50;</span></span><br><span class="line">            margin-bottom: 10px;</span><br><span class="line">        &#125;</span><br><span class="line">        .subtitle &#123;</span><br><span class="line">            color: <span class="comment">#7f8c8d;</span></span><br><span class="line">            font-size: 1.1em;</span><br><span class="line">        &#125;</span><br><span class="line">        .summary-grid &#123;</span><br><span class="line">            display: grid;</span><br><span class="line">            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));</span><br><span class="line">            gap: 20px;</span><br><span class="line">            margin-bottom: 30px;</span><br><span class="line">        &#125;</span><br><span class="line">        .card &#123;</span><br><span class="line">            background: linear-gradient(135deg, <span class="comment">#667eea 0%, #764ba2 100%);</span></span><br><span class="line">            color: white;</span><br><span class="line">            padding: 25px;</span><br><span class="line">            border-radius: 8px;</span><br><span class="line">            text-align: center;</span><br><span class="line">            transition: transform 0.3s;</span><br><span class="line">        &#125;</span><br><span class="line">        .card:hover &#123;</span><br><span class="line">            transform: translateY(-5px);</span><br><span class="line">        &#125;</span><br><span class="line">        .card h3 &#123;</span><br><span class="line">            font-size: 2.5em;</span><br><span class="line">            margin-bottom: 5px;</span><br><span class="line">        &#125;</span><br><span class="line">        .card p &#123;</span><br><span class="line">            opacity: 0.9;</span><br><span class="line">            font-size: 0.9em;</span><br><span class="line">        &#125;</span><br><span class="line">        section &#123;</span><br><span class="line">            margin-bottom: 40px;</span><br><span class="line">        &#125;</span><br><span class="line">        h2 &#123;</span><br><span class="line">            color: <span class="comment">#34495e;</span></span><br><span class="line">            margin-bottom: 20px;</span><br><span class="line">            padding-bottom: 10px;</span><br><span class="line">            border-bottom: 2px solid <span class="comment">#ecf0f1;</span></span><br><span class="line">        &#125;</span><br><span class="line">        table &#123;</span><br><span class="line">            width: 100%;</span><br><span class="line">            border-collapse: collapse;</span><br><span class="line">            margin-bottom: 20px;</span><br><span class="line">        &#125;</span><br><span class="line">        th, td &#123;</span><br><span class="line">            padding: 12px 15px;</span><br><span class="line">            text-align: left;</span><br><span class="line">            border-bottom: 1px solid <span class="comment">#ddd;</span></span><br><span class="line">        &#125;</span><br><span class="line">        th &#123;</span><br><span class="line">            background-color: <span class="comment">#f8f9fa;</span></span><br><span class="line">            font-weight: 600;</span><br><span class="line">            color: <span class="comment">#2c3e50;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">tr</span>:hover &#123;</span><br><span class="line">            background-color: <span class="comment">#f5f7fa;</span></span><br><span class="line">        &#125;</span><br><span class="line">        .status-2xx &#123; color: <span class="comment">#27ae60; &#125;</span></span><br><span class="line">        .status-3xx &#123; color: <span class="comment">#3498db; &#125;</span></span><br><span class="line">        .status-4xx &#123; color: <span class="comment">#f39c12; &#125;</span></span><br><span class="line">        .status-5xx &#123; color: <span class="comment">#e74c3c; &#125;</span></span><br><span class="line">        .chart-container &#123;</span><br><span class="line">            height: 300px;</span><br><span class="line">            margin: 20px 0;</span><br><span class="line">            position: relative;</span><br><span class="line">        &#125;</span><br><span class="line">        footer &#123;</span><br><span class="line">            text-align: center;</span><br><span class="line">            margin-top: 40px;</span><br><span class="line">            padding-top: 20px;</span><br><span class="line">            border-top: 1px solid <span class="comment">#ecf0f1;</span></span><br><span class="line">            color: <span class="comment">#7f8c8d;</span></span><br><span class="line">            font-size: 0.9em;</span><br><span class="line">        &#125;</span><br><span class="line">        @media (max-width: 768px) &#123;</span><br><span class="line">            .summary-grid &#123;</span><br><span class="line">                grid-template-columns: 1fr;</span><br><span class="line">            &#125;</span><br><span class="line">            th, td &#123;</span><br><span class="line">                padding: 8px 10px;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;https://cdn.jsdelivr.net/npm/chart.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;div class=<span class="string">&quot;container&quot;</span>&gt;</span><br><span class="line">        &lt;header&gt;</span><br><span class="line">            &lt;h1&gt;📊 服务器日志分析报告&lt;/h1&gt;</span><br><span class="line">            &lt;div class=<span class="string">&quot;subtitle&quot;</span>&gt;</span><br><span class="line">                生成时间: $(<span class="built_in">date</span> <span class="string">&quot;+%Y-%m-%d %H:%M:%S&quot;</span>) | </span><br><span class="line">                日志文件: $(<span class="built_in">basename</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span>) |</span><br><span class="line">                分析范围: $(get_time_range)</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/header&gt;</span><br><span class="line">EOF</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 生成摘要统计</span></span><br><span class="line">    <span class="built_in">cat</span> &gt;&gt; <span class="string">&quot;<span class="variable">$output_file</span>&quot;</span> &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;summary-grid&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;card&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;h3&gt;$(get_total_requests)&lt;/h3&gt;</span></span><br><span class="line"><span class="string">                &lt;p&gt;总访问次数&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;card&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;h3&gt;$(get_unique_ips)&lt;/h3&gt;</span></span><br><span class="line"><span class="string">                &lt;p&gt;独立IP地址&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;card&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;h3&gt;$(get_avg_response_time)ms&lt;/h3&gt;</span></span><br><span class="line"><span class="string">                &lt;p&gt;平均响应时间&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;card&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;h3&gt;$(get_error_rate)%&lt;/h3&gt;</span></span><br><span class="line"><span class="string">                &lt;p&gt;错误率&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 添加表格数据</span></span><br><span class="line">    <span class="built_in">cat</span> &gt;&gt; <span class="string">&quot;<span class="variable">$output_file</span>&quot;</span> &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">        &lt;section&gt;</span></span><br><span class="line"><span class="string">            &lt;h2&gt;📈 访问趋势&lt;/h2&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;chart-container&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;canvas id=&quot;hourlyChart&quot;&gt;&lt;/canvas&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            &lt;h2&gt;🌍 地理位置分布&lt;/h2&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;chart-container&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;canvas id=&quot;geoChart&quot;&gt;&lt;/canvas&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            &lt;h2&gt;🔝 Top 访问统计&lt;/h2&gt;</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            &lt;h3&gt;访问量最高的IP&lt;/h3&gt;</span></span><br><span class="line"><span class="string">            &lt;table&gt;</span></span><br><span class="line"><span class="string">                &lt;thead&gt;</span></span><br><span class="line"><span class="string">                    &lt;tr&gt;</span></span><br><span class="line"><span class="string">                        &lt;th&gt;IP地址&lt;/th&gt;</span></span><br><span class="line"><span class="string">                        &lt;th&gt;访问次数&lt;/th&gt;</span></span><br><span class="line"><span class="string">                        &lt;th&gt;占比&lt;/th&gt;</span></span><br><span class="line"><span class="string">                        &lt;th&gt;地理位置&lt;/th&gt;</span></span><br><span class="line"><span class="string">                    &lt;/tr&gt;</span></span><br><span class="line"><span class="string">                &lt;/thead&gt;</span></span><br><span class="line"><span class="string">                &lt;tbody&gt;</span></span><br><span class="line"><span class="string">                    $(generate_top_ips_table)</span></span><br><span class="line"><span class="string">                &lt;/tbody&gt;</span></span><br><span class="line"><span class="string">            &lt;/table&gt;</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            &lt;h3&gt;热门页面&lt;/h3&gt;</span></span><br><span class="line"><span class="string">            &lt;table&gt;</span></span><br><span class="line"><span class="string">                &lt;thead&gt;</span></span><br><span class="line"><span class="string">                    &lt;tr&gt;</span></span><br><span class="line"><span class="string">                        &lt;th&gt;页面URL&lt;/th&gt;</span></span><br><span class="line"><span class="string">                        &lt;th&gt;访问次数&lt;/th&gt;</span></span><br><span class="line"><span class="string">                        &lt;th&gt;占比&lt;/th&gt;</span></span><br><span class="line"><span class="string">                        &lt;th&gt;平均响应&lt;/th&gt;</span></span><br><span class="line"><span class="string">                    &lt;/tr&gt;</span></span><br><span class="line"><span class="string">                &lt;/thead&gt;</span></span><br><span class="line"><span class="string">                &lt;tbody&gt;</span></span><br><span class="line"><span class="string">                    $(generate_top_pages_table)</span></span><br><span class="line"><span class="string">                &lt;/tbody&gt;</span></span><br><span class="line"><span class="string">            &lt;/table&gt;</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            &lt;h3&gt;HTTP状态码分布&lt;/h3&gt;</span></span><br><span class="line"><span class="string">            &lt;table&gt;</span></span><br><span class="line"><span class="string">                &lt;thead&gt;</span></span><br><span class="line"><span class="string">                    &lt;tr&gt;</span></span><br><span class="line"><span class="string">                        &lt;th&gt;状态码&lt;/th&gt;</span></span><br><span class="line"><span class="string">                        &lt;th&gt;次数&lt;/th&gt;</span></span><br><span class="line"><span class="string">                        &lt;th&gt;占比&lt;/th&gt;</span></span><br><span class="line"><span class="string">                        &lt;th&gt;描述&lt;/th&gt;</span></span><br><span class="line"><span class="string">                    &lt;/tr&gt;</span></span><br><span class="line"><span class="string">                &lt;/thead&gt;</span></span><br><span class="line"><span class="string">                &lt;tbody&gt;</span></span><br><span class="line"><span class="string">                    $(generate_status_table)</span></span><br><span class="line"><span class="string">                &lt;/tbody&gt;</span></span><br><span class="line"><span class="string">            &lt;/table&gt;</span></span><br><span class="line"><span class="string">        &lt;/section&gt;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        &lt;section&gt;</span></span><br><span class="line"><span class="string">            &lt;h2&gt;⚠️ 安全检测&lt;/h2&gt;</span></span><br><span class="line"><span class="string">            $(generate_security_alerts)</span></span><br><span class="line"><span class="string">        &lt;/section&gt;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        &lt;section&gt;</span></span><br><span class="line"><span class="string">            &lt;h2&gt;📊 性能指标&lt;/h2&gt;</span></span><br><span class="line"><span class="string">            $(generate_performance_metrics)</span></span><br><span class="line"><span class="string">        &lt;/section&gt;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        &lt;footer&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;报告由日志分析器生成 | 版本: 2.0 | 处理时间: $(get_processing_time)s&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;注意：此报告仅供参考，建议结合其他监控工具使用&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;/footer&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    &lt;script&gt;</span></span><br><span class="line"><span class="string">        // 每小时访问图表</span></span><br><span class="line"><span class="string">        const hourlyCtx = document.getElementById(&#x27;hourlyChart&#x27;).getContext(&#x27;2d&#x27;);</span></span><br><span class="line"><span class="string">        new Chart(hourlyCtx, &#123;</span></span><br><span class="line"><span class="string">            type: &#x27;line&#x27;,</span></span><br><span class="line"><span class="string">            data: &#123;</span></span><br><span class="line"><span class="string">                labels: $(get_hourly_labels),</span></span><br><span class="line"><span class="string">                datasets: [&#123;</span></span><br><span class="line"><span class="string">                    label: &#x27;访问量&#x27;,</span></span><br><span class="line"><span class="string">                    data: $(get_hourly_data),</span></span><br><span class="line"><span class="string">                    borderColor: &#x27;#4a6fa5&#x27;,</span></span><br><span class="line"><span class="string">                    backgroundColor: &#x27;rgba(74, 111, 165, 0.1)&#x27;,</span></span><br><span class="line"><span class="string">                    fill: true,</span></span><br><span class="line"><span class="string">                    tension: 0.4</span></span><br><span class="line"><span class="string">                &#125;]</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            options: &#123;</span></span><br><span class="line"><span class="string">                responsive: true,</span></span><br><span class="line"><span class="string">                maintainAspectRatio: false,</span></span><br><span class="line"><span class="string">                plugins: &#123;</span></span><br><span class="line"><span class="string">                    legend: &#123; display: false &#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;);</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        // 地理位置图表</span></span><br><span class="line"><span class="string">        const geoCtx = document.getElementById(&#x27;geoChart&#x27;).getContext(&#x27;2d&#x27;);</span></span><br><span class="line"><span class="string">        new Chart(geoCtx, &#123;</span></span><br><span class="line"><span class="string">            type: &#x27;doughnut&#x27;,</span></span><br><span class="line"><span class="string">            data: &#123;</span></span><br><span class="line"><span class="string">                labels: $(get_geo_labels),</span></span><br><span class="line"><span class="string">                datasets: [&#123;</span></span><br><span class="line"><span class="string">                    data: $(get_geo_data),</span></span><br><span class="line"><span class="string">                    backgroundColor: [</span></span><br><span class="line"><span class="string">                        &#x27;#FF6384&#x27;, &#x27;#36A2EB&#x27;, &#x27;#FFCE56&#x27;, &#x27;#4BC0C0&#x27;,</span></span><br><span class="line"><span class="string">                        &#x27;#9966FF&#x27;, &#x27;#FF9F40&#x27;, &#x27;#8AC926&#x27;, &#x27;#1982C4&#x27;</span></span><br><span class="line"><span class="string">                    ]</span></span><br><span class="line"><span class="string">                &#125;]</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            options: &#123;</span></span><br><span class="line"><span class="string">                responsive: true,</span></span><br><span class="line"><span class="string">                maintainAspectRatio: false,</span></span><br><span class="line"><span class="string">                plugins: &#123;</span></span><br><span class="line"><span class="string">                    legend: &#123; position: &#x27;right&#x27; &#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;);</span></span><br><span class="line"><span class="string">    &lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>HTML报告已生成: $output_file<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;使用浏览器打开: file://<span class="subst">$(realpath <span class="string">&quot;<span class="variable">$output_file</span>&quot;</span>)</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 辅助函数用于HTML生成</span></span><br><span class="line"><span class="function"><span class="title">get_total_requests</span></span>() &#123;</span><br><span class="line">    <span class="built_in">wc</span> -l &lt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">get_unique_ips</span></span>() &#123;</span><br><span class="line">    awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | <span class="built_in">sort</span> -u | <span class="built_in">wc</span> -l</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">get_time_range</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> first=$(awk <span class="string">&#x27;&#123;print $4&quot; &quot;$5&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | <span class="built_in">head</span> -1 | sed <span class="string">&#x27;s/\[//;s/\]//&#x27;</span>)</span><br><span class="line">    <span class="built_in">local</span> last=$(awk <span class="string">&#x27;&#123;print $4&quot; &quot;$5&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | <span class="built_in">tail</span> -1 | sed <span class="string">&#x27;s/\[//;s/\]//&#x27;</span>)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$first</span> 至 <span class="variable">$last</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">get_avg_response_time</span></span>() &#123;</span><br><span class="line">    grep -o <span class="string">&#x27;request_time=[0-9.]*&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> 2&gt;/dev/null | \</span><br><span class="line">        sed <span class="string">&#x27;s/request_time=//&#x27;</span> | \</span><br><span class="line">        awk <span class="string">&#x27;&#123;sum+=$1; count++&#125; END &#123;if(count&gt;0) printf &quot;%.1f&quot;, sum/count*1000; else print &quot;N/A&quot;&#125;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">get_error_rate</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> total=$(<span class="built_in">wc</span> -l &lt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">local</span> errors=$(grep -c <span class="string">&quot; 5[0-9][0-9] &quot;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;scale=1; <span class="variable">$errors</span> * 100 / <span class="variable">$total</span>&quot;</span> | bc 2&gt;/dev/null || <span class="built_in">echo</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">get_processing_time</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$SECONDS</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">generate_top_ips_table</span></span>() &#123;</span><br><span class="line">    awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | \</span><br><span class="line">        <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -rn | \</span><br><span class="line">        <span class="built_in">head</span> -10 | \</span><br><span class="line">        awk <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">            total += $1</span></span><br><span class="line"><span class="string">            ips[NR] = $2</span></span><br><span class="line"><span class="string">            counts[NR] = $1</span></span><br><span class="line"><span class="string">        &#125; END &#123;</span></span><br><span class="line"><span class="string">            for(i=1; i&lt;=length(ips); i++) &#123;</span></span><br><span class="line"><span class="string">                percentage = counts[i] * 100 / total</span></span><br><span class="line"><span class="string">                printf &quot;&lt;tr&gt;&lt;td&gt;%s&lt;/td&gt;&lt;td&gt;%d&lt;/td&gt;&lt;td&gt;%.1f%%&lt;/td&gt;&lt;td&gt;%s&lt;/td&gt;&lt;/tr&gt;\n&quot;, </span></span><br><span class="line"><span class="string">                       ips[i], counts[i], percentage, &quot;待查询&quot;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成JSON报告</span></span><br><span class="line"><span class="function"><span class="title">generate_json_report</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> output_file=<span class="string">&quot;<span class="variable">$&#123;1:-report_$(date +%Y%m%d_%H%M%S).json&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>正在生成JSON报告: $output_file<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cat</span> &gt; <span class="string">&quot;<span class="variable">$output_file</span>&quot;</span> &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;metadata&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;log_file&quot;: &quot;$LOG_FILE&quot;,</span></span><br><span class="line"><span class="string">        &quot;generated_at&quot;: &quot;$(date -Iseconds)&quot;,</span></span><br><span class="line"><span class="string">        &quot;analyzer_version&quot;: &quot;2.0&quot;,</span></span><br><span class="line"><span class="string">        &quot;processing_time_seconds&quot;: $SECONDS</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;summary&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;total_requests&quot;: $(get_total_requests),</span></span><br><span class="line"><span class="string">        &quot;unique_ips&quot;: $(get_unique_ips),</span></span><br><span class="line"><span class="string">        &quot;time_range&quot;: &quot;$(get_time_range)&quot;,</span></span><br><span class="line"><span class="string">        &quot;data_transferred_bytes&quot;: $(get_total_bytes),</span></span><br><span class="line"><span class="string">        &quot;data_transferred_human&quot;: &quot;$(get_total_bytes_human)&quot;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;analysis&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;top_ips&quot;: $(get_top_ips_json 10),</span></span><br><span class="line"><span class="string">        &quot;top_pages&quot;: $(get_top_pages_json 10),</span></span><br><span class="line"><span class="string">        &quot;status_codes&quot;: $(get_status_codes_json),</span></span><br><span class="line"><span class="string">        &quot;hourly_distribution&quot;: $(get_hourly_distribution_json),</span></span><br><span class="line"><span class="string">        &quot;file_types&quot;: $(get_file_types_json),</span></span><br><span class="line"><span class="string">        &quot;security_alerts&quot;: $(get_security_alerts_json)</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;performance&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;response_time_ms&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;avg&quot;: $(get_avg_response_time),</span></span><br><span class="line"><span class="string">            &quot;p95&quot;: $(get_percentile_response_time 95),</span></span><br><span class="line"><span class="string">            &quot;p99&quot;: $(get_percentile_response_time 99)</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;throughput&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;requests_per_second&quot;: $(get_rps),</span></span><br><span class="line"><span class="string">            &quot;bytes_per_second&quot;: $(get_bps)</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>JSON报告已生成: $output_file<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># JSON数据获取函数</span></span><br><span class="line"><span class="function"><span class="title">get_top_ips_json</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> count=<span class="variable">$&#123;1:-10&#125;</span></span><br><span class="line">    awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | \</span><br><span class="line">        <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -rn | \</span><br><span class="line">        <span class="built_in">head</span> -n <span class="variable">$count</span> | \</span><br><span class="line">        awk <span class="string">&#x27;BEGIN &#123;print &quot;[&quot;&#125;</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">                if(NR&gt;1) printf &quot;,\n&quot;</span></span><br><span class="line"><span class="string">                printf &quot;  &#123;\&quot;ip\&quot;: \&quot;%s\&quot;, \&quot;count\&quot;: %d, \&quot;percentage\&quot;: %.2f&#125;&quot;, $2, $1, $1*100/&#x27;</span>$(get_total_requests)<span class="string">&#x27;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            END &#123;print &quot;\n]&quot;&#125;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">get_total_bytes</span></span>() &#123;</span><br><span class="line">    awk <span class="string">&#x27;&#123;sum += $10&#125; END &#123;print sum&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> 2&gt;/dev/null || <span class="built_in">echo</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">get_total_bytes_human</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> bytes=$(get_total_bytes)</span><br><span class="line">    <span class="built_in">numfmt</span> --to=iec <span class="variable">$bytes</span> 2&gt;/dev/null || <span class="built_in">echo</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="第7步：添加多文件处理和批量分析"><a href="#第7步：添加多文件处理和批量分析" class="headerlink" title="第7步：添加多文件处理和批量分析"></a>第7步：添加多文件处理和批量分析</h3><p>bash</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"># 多日志文件分析</span><br><span class="line">multi_file_analysis() &#123;</span><br><span class="line">    echo -e &quot;$&#123;GREEN&#125;=== 多文件批量分析 ===$&#123;NC&#125;&quot;</span><br><span class="line">    </span><br><span class="line">    read -p &quot;请输入日志文件模式 (如: access.log*): &quot; pattern</span><br><span class="line">    read -p &quot;请输入起始日期 (YYYY-MM-DD): &quot; start_date</span><br><span class="line">    read -p &quot;请输入结束日期 (YYYY-MM-DD): &quot; end_date</span><br><span class="line">    </span><br><span class="line">    local files=()</span><br><span class="line">    </span><br><span class="line">    # 查找匹配的文件</span><br><span class="line">    if [[ -n &quot;$pattern&quot; ]]; then</span><br><span class="line">        files=($pattern)</span><br><span class="line">    elif [[ -n &quot;$start_date&quot; &amp;&amp; -n &quot;$end_date&quot; ]]; then</span><br><span class="line">        # 按日期范围查找</span><br><span class="line">        local current_date=&quot;$start_date&quot;</span><br><span class="line">        while [[ &quot;$current_date&quot; &lt; &quot;$end_date&quot; || &quot;$current_date&quot; == &quot;$end_date&quot; ]]; do</span><br><span class="line">            local date_pattern=$(echo &quot;$current_date&quot; | sed &#x27;s/-//g&#x27;)</span><br><span class="line">            local log_file=&quot;access.log-$&#123;date_pattern&#125;&quot;</span><br><span class="line">            </span><br><span class="line">            if [[ -f &quot;$log_file&quot; ]]; then</span><br><span class="line">                files+=(&quot;$log_file&quot;)</span><br><span class="line">            fi</span><br><span class="line">            </span><br><span class="line">            current_date=$(date -I -d &quot;$current_date + 1 day&quot;)</span><br><span class="line">        done</span><br><span class="line">    else</span><br><span class="line">        # 默认查找最近7天的日志</span><br><span class="line">        for i in &#123;0..6&#125;; do</span><br><span class="line">            local date_str=$(date -d &quot;$i days ago&quot; +%Y%m%d)</span><br><span class="line">            local log_file=&quot;access.log-$date_str&quot;</span><br><span class="line">            </span><br><span class="line">            if [[ -f &quot;$log_file&quot; ]]; then</span><br><span class="line">                files+=(&quot;$log_file&quot;)</span><br><span class="line">            fi</span><br><span class="line">        done</span><br><span class="line">    fi</span><br><span class="line">    </span><br><span class="line">    if [[ $&#123;#files[@]&#125; -eq 0 ]]; then</span><br><span class="line">        echo -e &quot;$&#123;RED&#125;未找到匹配的日志文件$&#123;NC&#125;&quot;</span><br><span class="line">        return 1</span><br><span class="line">    fi</span><br><span class="line">    </span><br><span class="line">    echo &quot;找到 $&#123;#files[@]&#125; 个日志文件:&quot;</span><br><span class="line">    printf &quot;  %s\n&quot; &quot;$&#123;files[@]&#125;&quot;</span><br><span class="line">    echo &quot;&quot;</span><br><span class="line">    </span><br><span class="line">    # 合并分析</span><br><span class="line">    local combined_file=&quot;$&#123;CONFIG_DIR&#125;/combined_$(date +%s).log&quot;</span><br><span class="line">    cat &quot;$&#123;files[@]&#125;&quot; &gt; &quot;$combined_file&quot;</span><br><span class="line">    </span><br><span class="line">    LOG_FILE=&quot;$combined_file&quot;</span><br><span class="line">    </span><br><span class="line">    echo &quot;开始合并分析...&quot;</span><br><span class="line">    run_all_analysis</span><br><span class="line">    </span><br><span class="line">    # 清理临时文件</span><br><span class="line">    rm &quot;$combined_file&quot;</span><br><span class="line">    </span><br><span class="line">    echo -e &quot;$&#123;GREEN&#125;批量分析完成$&#123;NC&#125;&quot;</span><br><span class="line">    echo &quot;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 分布式日志分析（简单版本）</span><br><span class="line">distributed_analysis() &#123;</span><br><span class="line">    echo -e &quot;$&#123;GREEN&#125;=== 分布式日志分析 ===$&#123;NC&#125;&quot;</span><br><span class="line">    </span><br><span class="line">    read -p &quot;请输入服务器列表文件 (每行一个服务器): &quot; server_list</span><br><span class="line">    read -p &quot;请输入远程日志路径: &quot; remote_path</span><br><span class="line">    </span><br><span class="line">    if [[ ! -f &quot;$server_list&quot; ]]; then</span><br><span class="line">        echo -e &quot;$&#123;RED&#125;服务器列表文件不存在$&#123;NC&#125;&quot;</span><br><span class="line">        return 1</span><br><span class="line">    fi</span><br><span class="line">    </span><br><span class="line">    local temp_dir=&quot;$&#123;CONFIG_DIR&#125;/distributed_$(date +%s)&quot;</span><br><span class="line">    mkdir -p &quot;$temp_dir&quot;</span><br><span class="line">    </span><br><span class="line">    # 并行从各服务器拉取日志</span><br><span class="line">    echo &quot;从远程服务器拉取日志...&quot;</span><br><span class="line">    </span><br><span class="line">    local index=0</span><br><span class="line">    while read server; do</span><br><span class="line">        if [[ -n &quot;$server&quot; ]]; then</span><br><span class="line">            echo &quot;拉取 $server...&quot;</span><br><span class="line">            scp &quot;$&#123;server&#125;:$&#123;remote_path&#125;&quot; &quot;$&#123;temp_dir&#125;/server_$&#123;index&#125;.log&quot; 2&gt;/dev/null &amp;</span><br><span class="line">            let index++</span><br><span class="line">        fi</span><br><span class="line">    done &lt; &quot;$server_list&quot;</span><br><span class="line">    </span><br><span class="line">    wait</span><br><span class="line">    </span><br><span class="line">    # 合并分析</span><br><span class="line">    cat &quot;$&#123;temp_dir&#125;&quot;/*.log &gt; &quot;$&#123;temp_dir&#125;/all.log&quot;</span><br><span class="line">    LOG_FILE=&quot;$&#123;temp_dir&#125;/all.log&quot;</span><br><span class="line">    </span><br><span class="line">    echo &quot;开始分布式分析...&quot;</span><br><span class="line">    run_all_analysis</span><br><span class="line">    </span><br><span class="line">    # 生成对比报告</span><br><span class="line">    echo -e &quot;\n$&#123;GREEN&#125;=== 服务器对比 ===$&#123;NC&#125;&quot;</span><br><span class="line">    for file in &quot;$&#123;temp_dir&#125;&quot;/server_*.log; do</span><br><span class="line">        if [[ -f &quot;$file&quot; ]]; then</span><br><span class="line">            local server_num=$(basename &quot;$file&quot; | sed &#x27;s/server_//;s/.log//&#x27;)</span><br><span class="line">            local count=$(wc -l &lt; &quot;$file&quot;)</span><br><span class="line">            local errors=$(grep -c &quot; 5[0-9][0-9] &quot; &quot;$file&quot;)</span><br><span class="line">            local error_rate=$(echo &quot;scale=1; $errors * 100 / $count&quot; | bc 2&gt;/dev/null || echo &quot;0&quot;)</span><br><span class="line">            </span><br><span class="line">            echo &quot;服务器 $server_num: $count 请求, 错误率: $&#123;error_rate&#125;%&quot;</span><br><span class="line">        fi</span><br><span class="line">    done</span><br><span class="line">    </span><br><span class="line">    # 清理</span><br><span class="line">    rm -rf &quot;$temp_dir&quot;</span><br><span class="line">    echo &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="第8步：添加可视化图表功能"><a href="#第8步：添加可视化图表功能" class="headerlink" title="第8步：添加可视化图表功能"></a>第8步：添加可视化图表功能</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用gnuplot生成图表</span></span><br><span class="line"><span class="function"><span class="title">generate_charts</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>=== 生成可视化图表 ===<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ! <span class="built_in">command</span> -v gnuplot &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>请先安装gnuplot: sudo apt-get install gnuplot<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">local</span> output_dir=<span class="string">&quot;<span class="variable">$&#123;CONFIG_DIR&#125;</span>/charts_<span class="subst">$(date +%Y%m%d)</span>&quot;</span></span><br><span class="line">    <span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$output_dir</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 1. 生成每小时访问量图表</span></span><br><span class="line">    generate_hourly_chart <span class="string">&quot;<span class="variable">$output_dir</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. 生成状态码分布图表</span></span><br><span class="line">    generate_status_chart <span class="string">&quot;<span class="variable">$output_dir</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. 生成热门页面图表</span></span><br><span class="line">    generate_pages_chart <span class="string">&quot;<span class="variable">$output_dir</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4. 生成IP分布图表</span></span><br><span class="line">    generate_ips_chart <span class="string">&quot;<span class="variable">$output_dir</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>图表已生成到: $output_dir<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;查看命令: ls -la <span class="variable">$output_dir</span>/*.png&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">generate_hourly_chart</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> output_dir=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 准备数据</span></span><br><span class="line">    awk <span class="string">&#x27;&#123;split($4, time, &quot;:&quot;); print time[2]&quot;:00&quot;&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | \</span><br><span class="line">        sed <span class="string">&#x27;s/\[//&#x27;</span> | \</span><br><span class="line">        <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c &gt; <span class="string">&quot;<span class="variable">$&#123;output_dir&#125;</span>/hourly.dat&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 生成gnuplot脚本</span></span><br><span class="line">    <span class="built_in">cat</span> &gt; <span class="string">&quot;<span class="variable">$&#123;output_dir&#125;</span>/hourly.gnuplot&quot;</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="built_in">set</span> terminal pngcairo size 800,400 enhanced font <span class="string">&#x27;Arial,10&#x27;</span></span><br><span class="line"><span class="built_in">set</span> output <span class="string">&#x27;hourly_requests.png&#x27;</span></span><br><span class="line"><span class="built_in">set</span> title <span class="string">&#x27;每小时访问量&#x27;</span></span><br><span class="line"><span class="built_in">set</span> xlabel <span class="string">&#x27;时间 (小时)&#x27;</span></span><br><span class="line"><span class="built_in">set</span> ylabel <span class="string">&#x27;请求数&#x27;</span></span><br><span class="line"><span class="built_in">set</span> style data histograms</span><br><span class="line"><span class="built_in">set</span> style fill solid 0.8 border lt -1</span><br><span class="line"><span class="built_in">set</span> xtics rotate by -45</span><br><span class="line"><span class="built_in">set</span> grid ytics</span><br><span class="line"><span class="built_in">set</span> key off</span><br><span class="line">plot <span class="string">&#x27;hourly.dat&#x27;</span> using 1:xtic(2) with boxes lc rgb <span class="string">&#x27;#4a6fa5&#x27;</span> title <span class="string">&#x27;请求数&#x27;</span></span><br><span class="line">EOF</span><br><span class="line">    </span><br><span class="line">    gnuplot <span class="string">&quot;<span class="variable">$&#123;output_dir&#125;</span>/hourly.gnuplot&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">generate_status_chart</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> output_dir=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 准备数据</span></span><br><span class="line">    awk <span class="string">&#x27;&#123;print $9&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | \</span><br><span class="line">        <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -rn &gt; <span class="string">&quot;<span class="variable">$&#123;output_dir&#125;</span>/status.dat&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cat</span> &gt; <span class="string">&quot;<span class="variable">$&#123;output_dir&#125;</span>/status.gnuplot&quot;</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="built_in">set</span> terminal pngcairo size 600,400 enhanced font <span class="string">&#x27;Arial,10&#x27;</span></span><br><span class="line"><span class="built_in">set</span> output <span class="string">&#x27;status_codes.png&#x27;</span></span><br><span class="line"><span class="built_in">set</span> title <span class="string">&#x27;HTTP状态码分布&#x27;</span></span><br><span class="line"><span class="built_in">set</span> style data pie</span><br><span class="line"><span class="built_in">set</span> style fill solid</span><br><span class="line"><span class="built_in">set</span> key outside right</span><br><span class="line">plot <span class="string">&#x27;status.dat&#x27;</span> using 1:xtic(2) with pie</span><br><span class="line">EOF</span><br><span class="line">    </span><br><span class="line">    gnuplot <span class="string">&quot;<span class="variable">$&#123;output_dir&#125;</span>/status.gnuplot&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成ASCII图表（无需外部依赖）</span></span><br><span class="line"><span class="function"><span class="title">generate_ascii_chart</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>=== ASCII图表 ===<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 小时访问量ASCII图表</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;每小时访问量:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    awk <span class="string">&#x27;&#123;split($4, time, &quot;:&quot;); print time[2]&quot;:00&quot;&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | \</span><br><span class="line">        sed <span class="string">&#x27;s/\[//&#x27;</span> | \</span><br><span class="line">        <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -n | \</span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">read</span> count hour; <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">printf</span> <span class="string">&quot;%-10s [%4d] &quot;</span> <span class="string">&quot;<span class="variable">$hour</span>&quot;</span> <span class="string">&quot;<span class="variable">$count</span>&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="built_in">local</span> bar_length=$((count / <span class="number">10</span>))</span><br><span class="line">            <span class="keyword">for</span> ((i=<span class="number">0</span>; i&lt;bar_length &amp;&amp; i&lt;<span class="number">50</span>; i++)); <span class="keyword">do</span></span><br><span class="line">                <span class="keyword">if</span> [[ <span class="variable">$i</span> -lt 20 ]]; <span class="keyword">then</span></span><br><span class="line">                    <span class="built_in">echo</span> -ne <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>█<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">                <span class="keyword">elif</span> [[ <span class="variable">$i</span> -lt 35 ]]; <span class="keyword">then</span></span><br><span class="line">                    <span class="built_in">echo</span> -ne <span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>█<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="built_in">echo</span> -ne <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>█<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">                <span class="keyword">fi</span></span><br><span class="line">            <span class="keyword">done</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="第9步：添加高级过滤和查询功能"><a href="#第9步：添加高级过滤和查询功能" class="headerlink" title="第9步：添加高级过滤和查询功能"></a>第9步：添加高级过滤和查询功能</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 高级查询语言</span></span><br><span class="line"><span class="function"><span class="title">advanced_query</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>=== 高级查询模式 ===<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;支持的查询语法:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  ip:192.168.1.1                     - 按IP过滤&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  status:404                         - 按状态码过滤&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  method:GET                         - 按HTTP方法过滤&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  url:admin                          - URL包含关键词&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  time:&gt;10/Oct/2023:13:00            - 时间大于&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  time:&lt;10/Oct/2023:14:00            - 时间小于&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  size:&gt;1000                         - 响应大小大于&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  referer:google                     - 来源包含&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  useragent:chrome                   - 浏览器包含&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  AND, OR, NOT                       - 逻辑操作&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;示例: ip:192.168.1.1 AND status:404&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">read</span> -p <span class="string">&quot;请输入查询条件: &quot;</span> query</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [[ -z <span class="string">&quot;<span class="variable">$query</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">return</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 解析查询条件</span></span><br><span class="line">    parse_and_execute_query <span class="string">&quot;<span class="variable">$query</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">parse_and_execute_query</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> query=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 转换为awk表达式</span></span><br><span class="line">    <span class="built_in">local</span> awk_expr=<span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 替换逻辑操作符</span></span><br><span class="line">    query=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$query</span>&quot;</span> | sed <span class="string">&#x27;s/ AND / &amp;&amp; /g; s/ OR / || /g; s/ NOT / !/g&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 解析各个条件</span></span><br><span class="line">    <span class="keyword">while</span> [[ <span class="string">&quot;<span class="variable">$query</span>&quot;</span> =~ ([a-z]+):([^ ]+) ]]; <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">local</span> field=<span class="string">&quot;<span class="variable">$&#123;BASH_REMATCH[1]&#125;</span>&quot;</span></span><br><span class="line">        <span class="built_in">local</span> value=<span class="string">&quot;<span class="variable">$&#123;BASH_REMATCH[2]&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$field</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">            ip)</span><br><span class="line">                awk_expr+=<span class="string">&quot;\$1 ~ /<span class="variable">$value</span>/ &amp;&amp; &quot;</span></span><br><span class="line">                ;;</span><br><span class="line">            status)</span><br><span class="line">                awk_expr+=<span class="string">&quot;\$9 == \&quot;<span class="variable">$value</span>\&quot; &amp;&amp; &quot;</span></span><br><span class="line">                ;;</span><br><span class="line">            method)</span><br><span class="line">                awk_expr+=<span class="string">&quot;\$6 ~ /^\&quot;<span class="variable">$value</span>/ &amp;&amp; &quot;</span></span><br><span class="line">                ;;</span><br><span class="line">            url)</span><br><span class="line">                awk_expr+=<span class="string">&quot;\$7 ~ /<span class="variable">$value</span>/ &amp;&amp; &quot;</span></span><br><span class="line">                ;;</span><br><span class="line">            time)</span><br><span class="line">                <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$value</span>&quot;</span> =~ ^\&gt; ]]; <span class="keyword">then</span></span><br><span class="line">                    <span class="built_in">local</span> time_val=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$value</span>&quot;</span> | sed <span class="string">&#x27;s/^&gt;//&#x27;</span>)</span><br><span class="line">                    awk_expr+=<span class="string">&quot;\$4 &gt; \&quot;[<span class="variable">$time_val</span>]\&quot; &amp;&amp; &quot;</span></span><br><span class="line">                <span class="keyword">elif</span> [[ <span class="string">&quot;<span class="variable">$value</span>&quot;</span> =~ ^\&lt; ]]; <span class="keyword">then</span></span><br><span class="line">                    <span class="built_in">local</span> time_val=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$value</span>&quot;</span> | sed <span class="string">&#x27;s/^&lt;//&#x27;</span>)</span><br><span class="line">                    awk_expr+=<span class="string">&quot;\$4 &lt; \&quot;[<span class="variable">$time_val</span>]\&quot; &amp;&amp; &quot;</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    awk_expr+=<span class="string">&quot;\$4 ~ /<span class="variable">$value</span>/ &amp;&amp; &quot;</span></span><br><span class="line">                <span class="keyword">fi</span></span><br><span class="line">                ;;</span><br><span class="line">            size)</span><br><span class="line">                <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$value</span>&quot;</span> =~ ^\&gt; ]]; <span class="keyword">then</span></span><br><span class="line">                    <span class="built_in">local</span> size_val=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$value</span>&quot;</span> | sed <span class="string">&#x27;s/^&gt;//&#x27;</span>)</span><br><span class="line">                    awk_expr+=<span class="string">&quot;\$10 &gt; <span class="variable">$size_val</span> &amp;&amp; &quot;</span></span><br><span class="line">                <span class="keyword">elif</span> [[ <span class="string">&quot;<span class="variable">$value</span>&quot;</span> =~ ^\&lt; ]]; <span class="keyword">then</span></span><br><span class="line">                    <span class="built_in">local</span> size_val=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$value</span>&quot;</span> | sed <span class="string">&#x27;s/^&lt;//&#x27;</span>)</span><br><span class="line">                    awk_expr+=<span class="string">&quot;\$10 &lt; <span class="variable">$size_val</span> &amp;&amp; &quot;</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    awk_expr+=<span class="string">&quot;\$10 == <span class="variable">$value</span> &amp;&amp; &quot;</span></span><br><span class="line">                <span class="keyword">fi</span></span><br><span class="line">                ;;</span><br><span class="line">            referer)</span><br><span class="line">                awk_expr+=<span class="string">&quot;\$11 ~ /<span class="variable">$value</span>/ &amp;&amp; &quot;</span></span><br><span class="line">                ;;</span><br><span class="line">            useragent)</span><br><span class="line">                awk_expr+=<span class="string">&quot;\$12 ~ /<span class="variable">$value</span>/ &amp;&amp; &quot;</span></span><br><span class="line">                ;;</span><br><span class="line">        <span class="keyword">esac</span></span><br><span class="line">        </span><br><span class="line">        query=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$query</span>&quot;</span> | sed <span class="string">&quot;s/<span class="variable">$&#123;field&#125;</span>:<span class="variable">$&#123;value&#125;</span>//&quot;</span>)</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 移除最后的 &quot; &amp;&amp; &quot;</span></span><br><span class="line">    awk_expr=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$awk_expr</span>&quot;</span> | sed <span class="string">&#x27;s/ &amp;&amp; $//&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [[ -n <span class="string">&quot;<span class="variable">$awk_expr</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;BLUE&#125;</span>执行查询: $awk_expr<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 执行查询</span></span><br><span class="line">        <span class="built_in">eval</span> <span class="string">&quot;awk &#x27;<span class="variable">$awk_expr</span>&#x27; \&quot;<span class="variable">$LOG_FILE</span>\&quot; | head -20&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">local</span> count=$(<span class="built_in">eval</span> <span class="string">&quot;awk &#x27;<span class="variable">$awk_expr</span>&#x27; \&quot;<span class="variable">$LOG_FILE</span>\&quot; | wc -l&quot;</span>)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;匹配记录数: <span class="variable">$count</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>无法解析查询条件<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="第10步：完善主菜单和用户体验"><a href="#第10步：完善主菜单和用户体验" class="headerlink" title="第10步：完善主菜单和用户体验"></a>第10步：完善主菜单和用户体验</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 增强主菜单</span></span><br><span class="line"><span class="function"><span class="title">show_enhanced_menu</span></span>() &#123;</span><br><span class="line">    clear</span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">$&#123;BLUE&#125;╔═══════════════════════════════════════════════════════╗</span></span><br><span class="line"><span class="string">║               高级日志分析器 v2.0                     ║</span></span><br><span class="line"><span class="string">╠═══════════════════════════════════════════════════════╣</span></span><br><span class="line"><span class="string">║ 日志文件: $&#123;GREEN&#125;$(basename &quot;$LOG_FILE&quot;)$&#123;BLUE&#125;                         ║</span></span><br><span class="line"><span class="string">║ 文件大小: $(numfmt --to=iec $(stat -c%s &quot;$LOG_FILE&quot; 2&gt;/dev/null || echo 0))                            ║</span></span><br><span class="line"><span class="string">║ 记录条数: $(wc -l &lt; &quot;$LOG_FILE&quot; 2&gt;/dev/null || echo 0)                               ║</span></span><br><span class="line"><span class="string">╚═══════════════════════════════════════════════════════╝$&#123;NC&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">基础分析:</span></span><br><span class="line"><span class="string">  $&#123;GREEN&#125;1$&#123;NC&#125;) 📊 基础统计          $&#123;GREEN&#125;2$&#123;NC&#125;) 🌍 访问IP分析</span></span><br><span class="line"><span class="string">  $&#123;GREEN&#125;3$&#123;NC&#125;) 📄 页面分析          $&#123;GREEN&#125;4$&#123;NC&#125;) 🔢 状态码分析</span></span><br><span class="line"><span class="string">  $&#123;GREEN&#125;5$&#123;NC&#125;) ⏰ 时间分析          $&#123;GREEN&#125;6$&#123;NC&#125;) 📁 文件类型分析</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">高级分析:</span></span><br><span class="line"><span class="string">  $&#123;GREEN&#125;7$&#123;NC&#125;) 🚨 异常检测          $&#123;GREEN&#125;8$&#123;NC&#125;) ⚡ 性能分析</span></span><br><span class="line"><span class="string">  $&#123;GREEN&#125;9$&#123;NC&#125;) 🤖 智能分析          $&#123;GREEN&#125;10$&#123;NC&#125;) 🔍 自定义过滤</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">工具功能:</span></span><br><span class="line"><span class="string">  $&#123;GREEN&#125;11$&#123;NC&#125;) 📈 实时监控         $&#123;GREEN&#125;12$&#123;NC&#125;) 📋 生成报告</span></span><br><span class="line"><span class="string">  $&#123;GREEN&#125;13$&#123;NC&#125;) 🎨 可视化图表       $&#123;GREEN&#125;14$&#123;NC&#125;) 🔧 高级查询</span></span><br><span class="line"><span class="string">  $&#123;GREEN&#125;15$&#123;NC&#125;) 📂 批量分析         $&#123;GREEN&#125;16$&#123;NC&#125;) 🌐 分布式分析</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">系统设置:</span></span><br><span class="line"><span class="string">  $&#123;GREEN&#125;17$&#123;NC&#125;) ⚙️  配置文件        $&#123;GREEN&#125;18$&#123;NC&#125;) 🧪 运行测试</span></span><br><span class="line"><span class="string">  $&#123;GREEN&#125;19$&#123;NC&#125;) 📖 使用指南         $&#123;GREEN&#125;20$&#123;NC&#125;) 🚀 快速分析</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  $&#123;GREEN&#125;0$&#123;NC&#125;) 退出</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">请选择 [0-20]: </span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 快速分析模式</span></span><br><span class="line"><span class="function"><span class="title">quick_analysis</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>🚀 执行快速分析...<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 并行执行基础分析</span></span><br><span class="line">    basic_stats &amp;</span><br><span class="line">    top_ips 10 &amp;</span><br><span class="line">    status_codes &amp;</span><br><span class="line">    <span class="built_in">wait</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 执行关键检测</span></span><br><span class="line">    anomaly_detection</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>✅ 快速分析完成<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用指南</span></span><br><span class="line"><span class="function"><span class="title">show_guide</span></span>() &#123;</span><br><span class="line">    clear</span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">$&#123;GREEN&#125;📖 日志分析器使用指南$&#123;NC&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$&#123;BLUE&#125;1. 基本使用$&#123;NC&#125;</span></span><br><span class="line"><span class="string">  ./log_analyzer.sh access.log                    # 分析单个文件</span></span><br><span class="line"><span class="string">  ./log_analyzer.sh -t apache access.log         # 指定日志类型</span></span><br><span class="line"><span class="string">  ./log_analyzer.sh -o report.html access.log    # 输出到文件</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$&#123;BLUE&#125;2. 常用命令示例$&#123;NC&#125;</span></span><br><span class="line"><span class="string">  # 统计访问量最高的IP</span></span><br><span class="line"><span class="string">  awk &#x27;&#123;print \$1&#125;&#x27; access.log | sort | uniq -c | sort -rn | head -10</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # 查找404错误</span></span><br><span class="line"><span class="string">  grep &quot; 404 &quot; access.log | awk &#x27;&#123;print \$7&#125;&#x27; | sort | uniq -c | sort -rn</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # 按小时统计访问量</span></span><br><span class="line"><span class="string">  awk &#x27;&#123;split(\$4, a, &quot;:&quot;); print a[2]&quot;:00&quot;&#125;&#x27; access.log | sed &#x27;s/\[//&#x27; | sort | uniq -c</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$&#123;BLUE&#125;3. 性能技巧$&#123;NC&#125;</span></span><br><span class="line"><span class="string">  - 大文件使用 --parallel 选项</span></span><br><span class="line"><span class="string">  - 频繁查询可启用缓存</span></span><br><span class="line"><span class="string">  - 实时监控使用 tail -f</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$&#123;BLUE&#125;4. 扩展功能$&#123;NC&#125;</span></span><br><span class="line"><span class="string">  - 添加自定义日志格式: 编辑 ~/.log-analyzer/formats.conf</span></span><br><span class="line"><span class="string">  - 配置告警: 编辑 ~/.log-analyzer/config</span></span><br><span class="line"><span class="string">  - 使用插件: 将脚本放入 ~/.log-analyzer/plugins/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$&#123;BLUE&#125;5. 故障排除$&#123;NC&#125;</span></span><br><span class="line"><span class="string">  - 确保日志格式正确</span></span><br><span class="line"><span class="string">  - 检查文件权限</span></span><br><span class="line"><span class="string">  - 查看 ~/.log-analyzer/error.log</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">按任意键返回...</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    <span class="built_in">read</span> -n 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增强的主函数</span></span><br><span class="line"><span class="function"><span class="title">main_enhanced</span></span>() &#123;</span><br><span class="line">    init_config</span><br><span class="line">    parse_args <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查依赖</span></span><br><span class="line">    check_dependencies</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 欢迎信息</span></span><br><span class="line">    show_welcome</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">        show_enhanced_menu</span><br><span class="line">        <span class="built_in">read</span> -p <span class="string">&quot; &quot;</span> choice</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">case</span> <span class="variable">$choice</span> <span class="keyword">in</span></span><br><span class="line">            1) basic_stats ;;</span><br><span class="line">            2) top_ips 20 ;;</span><br><span class="line">            3) top_pages 20 ;;</span><br><span class="line">            4) status_codes ;;</span><br><span class="line">            5) hourly_stats ;;</span><br><span class="line">            6) file_types ;;</span><br><span class="line">            7) anomaly_detection ;;</span><br><span class="line">            8) performance_analysis ;;</span><br><span class="line">            9) ml_anomaly_detection ;;</span><br><span class="line">            10) custom_filter ;;</span><br><span class="line">            11) realtime_monitor ;;</span><br><span class="line">            12) </span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;选择报告格式:&quot;</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;  1) HTML报告&quot;</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;  2) JSON报告&quot;</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;  3) 文本报告&quot;</span></span><br><span class="line">                <span class="built_in">read</span> -p <span class="string">&quot;请选择: &quot;</span> report_choice</span><br><span class="line">                <span class="keyword">case</span> <span class="variable">$report_choice</span> <span class="keyword">in</span></span><br><span class="line">                    1) generate_html_report ;;</span><br><span class="line">                    2) generate_json_report ;;</span><br><span class="line">                    3) run_all_analysis ;;</span><br><span class="line">                <span class="keyword">esac</span></span><br><span class="line">                ;;</span><br><span class="line">            13) generate_charts ;;</span><br><span class="line">            14) advanced_query ;;</span><br><span class="line">            15) multi_file_analysis ;;</span><br><span class="line">            16) distributed_analysis ;;</span><br><span class="line">            17) edit_config ;;</span><br><span class="line">            18) run_tests ;;</span><br><span class="line">            19) show_guide ;;</span><br><span class="line">            20) quick_analysis ;;</span><br><span class="line">            0) </span><br><span class="line">                <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>感谢使用！<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">                cleanup</span><br><span class="line">                <span class="built_in">exit</span> 0</span><br><span class="line">                ;;</span><br><span class="line">            *)</span><br><span class="line">                <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>无效选择，请重新输入<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">                ;;</span><br><span class="line">        <span class="keyword">esac</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> [[ <span class="variable">$choice</span> -ne 0 ]]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="built_in">read</span> -p <span class="string">&quot;按回车键继续...&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 欢迎信息</span></span><br><span class="line"><span class="function"><span class="title">show_welcome</span></span>() &#123;</span><br><span class="line">    clear</span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">$&#123;BLUE&#125;</span></span><br><span class="line"><span class="string">╔══════════════════════════════════════════════════════════════╗</span></span><br><span class="line"><span class="string">║                                                              ║</span></span><br><span class="line"><span class="string">║    ███████╗ ██████╗ ██████╗     █████╗ ███╗   ██╗ █████╗    ║</span></span><br><span class="line"><span class="string">║    ██╔════╝██╔═══██╗██╔══██╗   ██╔══██╗████╗  ██║██╔══██╗   ║</span></span><br><span class="line"><span class="string">║    █████╗  ██║   ██║██████╔╝   ███████║██╔██╗ ██║███████║   ║</span></span><br><span class="line"><span class="string">║    ██╔══╝  ██║   ██║██╔══██╗   ██╔══██║██║╚██╗██║██╔══██║   ║</span></span><br><span class="line"><span class="string">║    ██║     ╚██████╔╝██║  ██║   ██║  ██║██║ ╚████║██║  ██║   ║</span></span><br><span class="line"><span class="string">║    ╚═╝      ╚═════╝ ╚═╝  ╚═╝   ╚═╝  ╚═╝╚═╝  ╚═══╝╚═╝  ╚═╝   ║</span></span><br><span class="line"><span class="string">║                                                              ║</span></span><br><span class="line"><span class="string">║                    日志分析器 v2.0                          ║</span></span><br><span class="line"><span class="string">║                                                              ║</span></span><br><span class="line"><span class="string">╚══════════════════════════════════════════════════════════════╝$&#123;NC&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$&#123;GREEN&#125;开始分析: $(basename &quot;$LOG_FILE&quot;)$&#123;NC&#125;</span></span><br><span class="line"><span class="string">$&#123;YELLOW&#125;提示: 输入 ? 查看帮助，按 Ctrl+C 退出$&#123;NC&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查依赖</span></span><br><span class="line"><span class="function"><span class="title">check_dependencies</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> deps_missing=<span class="literal">false</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;BLUE&#125;</span>检查依赖...<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 必需工具</span></span><br><span class="line">    <span class="keyword">for</span> cmd <span class="keyword">in</span> awk grep sed <span class="built_in">sort</span> <span class="built_in">uniq</span>; <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> ! <span class="built_in">command</span> -v <span class="variable">$cmd</span> &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>✗ 缺少必需工具: $cmd<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">            deps_missing=<span class="literal">true</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>✓ $cmd<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 可选工具</span></span><br><span class="line">    <span class="keyword">for</span> cmd <span class="keyword">in</span> gnuplot bc <span class="built_in">numfmt</span>; <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> ! <span class="built_in">command</span> -v <span class="variable">$cmd</span> &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>⚠ 可选工具未安装: $cmd<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>✓ <span class="variable">$cmd</span> (可选)<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="variable">$deps_missing</span>; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>请安装缺少的依赖后重试<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理函数</span></span><br><span class="line"><span class="function"><span class="title">cleanup</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>清理临时文件...<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">rm</span> -f <span class="string">&quot;<span class="variable">$&#123;CONFIG_DIR&#125;</span>&quot;</span>/counter_* 2&gt;/dev/null</span><br><span class="line">    <span class="built_in">rm</span> -f <span class="string">&quot;<span class="variable">$&#123;CONFIG_DIR&#125;</span>&quot;</span>/tmp_* 2&gt;/dev/null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑配置</span></span><br><span class="line"><span class="function"><span class="title">edit_config</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> [[ -f <span class="string">&quot;<span class="variable">$CONFIG_FILE</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="variable">$&#123;EDITOR:-vi&#125;</span> <span class="string">&quot;<span class="variable">$CONFIG_FILE</span>&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>配置已更新，重启后生效<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>配置文件不存在<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加信号处理</span></span><br><span class="line"><span class="built_in">trap</span> <span class="string">&#x27;cleanup; exit 0&#x27;</span> INT TERM</span><br><span class="line"><span class="built_in">trap</span> <span class="string">&#x27;echo -e &quot;\n$&#123;RED&#125;程序被中断$&#123;NC&#125;&quot;&#x27;</span> HUP</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主执行</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$&#123;BASH_SOURCE[0]&#125;</span>&quot;</span> == <span class="string">&quot;<span class="variable">$&#123;0&#125;</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    main_enhanced <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>



<h2 id="三、使用示例和测试"><a href="#三、使用示例和测试" class="headerlink" title="三、使用示例和测试"></a>三、使用示例和测试</h2><h3 id="1-安装和配置"><a href="#1-安装和配置" class="headerlink" title="1. 安装和配置"></a>1. 安装和配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 克隆项目</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/yourusername/log-analyzer.git</span><br><span class="line"><span class="built_in">cd</span> log-analyzer</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">sudo apt-get install gnuplot bc <span class="built_in">numfmt</span> inotify-tools</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建符号链接</span></span><br><span class="line"><span class="built_in">chmod</span> +x log_analyzer.sh</span><br><span class="line">sudo <span class="built_in">ln</span> -s $(<span class="built_in">pwd</span>)/log_analyzer.sh /usr/local/bin/log-analyzer</span><br></pre></td></tr></table></figure>



<h3 id="2-高级使用示例"><a href="#2-高级使用示例" class="headerlink" title="2. 高级使用示例"></a>2. 高级使用示例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 生成完整报告</span></span><br><span class="line">log-analyzer access.log -o full_report.html</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 实时监控异常</span></span><br><span class="line">log-analyzer --monitor access.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 批量分析多日日志</span></span><br><span class="line">log-analyzer --batch 2023-10-01 2023-10-07</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 使用高级查询</span></span><br><span class="line">log-analyzer --query <span class="string">&quot;status:404 AND url:admin&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 生成可视化图表</span></span><br><span class="line">log-analyzer --visualize access.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 性能测试</span></span><br><span class="line">time log-analyzer --performance access.log</span><br></pre></td></tr></table></figure>



<h3 id="3-测试套件"><a href="#3-测试套件" class="headerlink" title="3. 测试套件"></a>3. 测试套件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建测试脚本</span></span><br><span class="line"><span class="built_in">cat</span> &gt; test_log_analyzer.sh &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;运行测试套件...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试1: 基本功能</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;测试1: 基础统计&quot;</span></span><br><span class="line">./log_analyzer.sh test_data/access.log 2&gt;&amp;1 | grep -q <span class="string">&quot;总访问次数&quot;</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;✓ 通过&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;✗ 失败&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试2: IP统计</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;测试2: IP分析&quot;</span></span><br><span class="line">./log_analyzer.sh test_data/access.log --top-ips 5 2&gt;&amp;1 | grep -q <span class="string">&quot;192.168&quot;</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;✓ 通过&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;✗ 失败&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试3: 错误检测</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;测试3: 异常检测&quot;</span></span><br><span class="line">./log_analyzer.sh test_data/access.log --anomaly 2&gt;&amp;1 | grep -q <span class="string">&quot;异常&quot;</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;✓ 通过&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;✗ 失败&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;测试完成&quot;</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> +x test_log_analyzer.sh</span><br><span class="line">./test_log_analyzer.sh</span><br></pre></td></tr></table></figure>



<h2 id="四、性能优化建议"><a href="#四、性能优化建议" class="headerlink" title="四、性能优化建议"></a>四、性能优化建议</h2><h3 id="1-大文件处理优化"><a href="#1-大文件处理优化" class="headerlink" title="1. 大文件处理优化"></a>1. 大文件处理优化</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用并行处理</span></span><br><span class="line"><span class="function"><span class="title">process_large_file</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> file=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    <span class="built_in">local</span> num_cores=$(<span class="built_in">nproc</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 分割文件并行处理</span></span><br><span class="line">    <span class="built_in">split</span> -n <span class="string">&quot;l/<span class="variable">$num_cores</span>&quot;</span> <span class="string">&quot;<span class="variable">$file</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;CONFIG_DIR&#125;</span>/part_&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 并行处理每个部分</span></span><br><span class="line">    <span class="keyword">for</span> part <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;CONFIG_DIR&#125;</span>&quot;</span>/part_*; <span class="keyword">do</span></span><br><span class="line">        analyze_part <span class="string">&quot;<span class="variable">$part</span>&quot;</span> &amp;</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    <span class="built_in">wait</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 合并结果</span></span><br><span class="line">    merge_results</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用mmap加速读取</span></span><br><span class="line"><span class="function"><span class="title">fast_grep</span></span>() &#123;</span><br><span class="line">    grep --mmap <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用LC_ALL=C加速排序</span></span><br><span class="line"><span class="function"><span class="title">fast_sort</span></span>() &#123;</span><br><span class="line">    LC_ALL=C <span class="built_in">sort</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-内存优化"><a href="#2-内存优化" class="headerlink" title="2. 内存优化"></a>2. 内存优化</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 流式处理避免内存溢出</span></span><br><span class="line"><span class="function"><span class="title">stream_process</span></span>() &#123;</span><br><span class="line">    <span class="keyword">while</span> IFS= <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">        <span class="comment"># 立即处理每一行</span></span><br><span class="line">        process_line <span class="string">&quot;<span class="variable">$line</span>&quot;</span></span><br><span class="line">    <span class="keyword">done</span> &lt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用临时文件存储中间结果</span></span><br><span class="line"><span class="function"><span class="title">disk_based_processing</span></span>() &#123;</span><br><span class="line">    <span class="comment"># 第一步：提取IP到临时文件</span></span><br><span class="line">    awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> &gt; <span class="string">&quot;<span class="variable">$&#123;CONFIG_DIR&#125;</span>/ips.tmp&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 第二步：排序</span></span><br><span class="line">    <span class="built_in">sort</span> <span class="string">&quot;<span class="variable">$&#123;CONFIG_DIR&#125;</span>/ips.tmp&quot;</span> &gt; <span class="string">&quot;<span class="variable">$&#123;CONFIG_DIR&#125;</span>/ips_sorted.tmp&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 第三步：统计</span></span><br><span class="line">    <span class="built_in">uniq</span> -c <span class="string">&quot;<span class="variable">$&#123;CONFIG_DIR&#125;</span>/ips_sorted.tmp&quot;</span> &gt; <span class="string">&quot;<span class="variable">$&#123;CONFIG_DIR&#125;</span>/ips_count.tmp&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 清理</span></span><br><span class="line">    <span class="built_in">rm</span> -f <span class="string">&quot;<span class="variable">$&#123;CONFIG_DIR&#125;</span>&quot;</span>/*.tmp</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="五、扩展插件系统"><a href="#五、扩展插件系统" class="headerlink" title="五、扩展插件系统"></a>五、扩展插件系统</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 插件管理器</span></span><br><span class="line">PLUGIN_DIR=<span class="string">&quot;<span class="variable">$&#123;CONFIG_DIR&#125;</span>/plugins&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">load_plugins</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> [[ ! -d <span class="string">&quot;<span class="variable">$PLUGIN_DIR</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$PLUGIN_DIR</span>&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;# 插件示例&quot;</span> &gt; <span class="string">&quot;<span class="variable">$&#123;PLUGIN_DIR&#125;</span>/example.sh&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 加载所有插件</span></span><br><span class="line">    <span class="keyword">for</span> plugin <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;PLUGIN_DIR&#125;</span>&quot;</span>/*.sh; <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> [[ -f <span class="string">&quot;<span class="variable">$plugin</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">source</span> <span class="string">&quot;<span class="variable">$plugin</span>&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>加载插件: <span class="subst">$(basename <span class="string">&quot;<span class="variable">$plugin</span>&quot;</span>)</span><span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插件示例：地理位置查询插件</span></span><br><span class="line"><span class="built_in">cat</span> &gt; <span class="string">&quot;<span class="variable">$&#123;PLUGIN_DIR&#125;</span>/geoip.sh&quot;</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 地理位置查询插件</span></span><br><span class="line"><span class="function"><span class="title">geoip_lookup</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> ip=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 使用ip-api.com (免费)</span></span><br><span class="line">    <span class="built_in">local</span> result=$(curl -s <span class="string">&quot;http://ip-api.com/json/<span class="variable">$ip</span>&quot;</span> 2&gt;/dev/null)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$result</span>&quot;</span> | grep -q <span class="string">&#x27;&quot;status&quot;:&quot;success&quot;&#x27;</span>; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">local</span> country=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$result</span>&quot;</span> | grep -o <span class="string">&#x27;&quot;country&quot;:&quot;[^&quot;]*&quot;&#x27;</span> | <span class="built_in">cut</span> -d<span class="string">&#x27;&quot;&#x27;</span> -f4)</span><br><span class="line">        <span class="built_in">local</span> city=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$result</span>&quot;</span> | grep -o <span class="string">&#x27;&quot;city&quot;:&quot;[^&quot;]*&quot;&#x27;</span> | <span class="built_in">cut</span> -d<span class="string">&#x27;&quot;&#x27;</span> -f4)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$country</span>/<span class="variable">$city</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;未知&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 集成到分析器</span></span><br><span class="line"><span class="function"><span class="title">geoip_analysis</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>=== 地理位置分析 ===<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | <span class="built_in">sort</span> -u | <span class="built_in">head</span> -10 | \</span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">read</span> ip; <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">local</span> location=$(geoip_lookup <span class="string">&quot;<span class="variable">$ip</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$ip</span> -&gt; <span class="variable">$location</span>&quot;</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册插件函数</span></span><br><span class="line">register_plugin <span class="string">&quot;geoip_analysis&quot;</span> <span class="string">&quot;地理位置分析&quot;</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h2 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h2><p>通过这个扩展版本的日志分析器，我们实现了：</p>
<ol>
<li><strong>功能增强</strong>：<ul>
<li>实时监控和告警</li>
<li>智能异常检测</li>
<li>性能分析和可视化</li>
<li>多格式日志支持</li>
<li>批量处理能力</li>
</ul>
</li>
<li><strong>性能优化</strong>：<ul>
<li>并行处理支持</li>
<li>大文件优化</li>
<li>缓存机制</li>
<li>内存管理</li>
</ul>
</li>
<li><strong>用户体验</strong>：<ul>
<li>美观的HTML报告</li>
<li>交互式菜单</li>
<li>详细的文档</li>
<li>错误处理和恢复</li>
</ul>
</li>
<li><strong>可扩展性</strong>：<ul>
<li>插件系统</li>
<li>配置文件支持</li>
<li>模块化设计</li>
<li>API接口</li>
</ul>
</li>
</ol>
<p>这个工具现在不仅是一个简单的日志分析器，而是一个完整的日志分析平台，可以满足从基本统计到复杂分析的各种需求。你可以根据具体需求继续扩展它，比如添加数据库支持、集成监控系统等。</p>
<p>记住，Shell脚本的强大之处在于它的简洁性和灵活性，适合快速原型开发和自动化任务。对于更复杂的分析需求，可能需要考虑使用Python或其他高级语言，但这个Shell脚本版本已经足够强大，能够处理大多数日常的日志分析任务。</p>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">
    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/8ae117da.html" rel="prev" title="JavaScript实践-俄罗斯方块">
                  <i class="fa fa-angle-left"></i> JavaScript实践-俄罗斯方块
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa-regular fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder"></span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Word count total">426k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">25:50</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>

  <script class="next-config" data-name="wavedrom" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/wavedrom.min.js","integrity":"sha256-INLAoJc6quTNfiMWkGZniYO2cxE8mHpddnLow1m6RFs="}}</script>
  <script class="next-config" data-name="wavedrom_skin" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/skins/default.js","integrity":"sha256-fduc/Zszk5ezWws2uInY/ALWVmIrmV6VTgXbsYSReFI="}}</script>
  <script src="/js/third-party/tags/wavedrom.js"></script>




  





</body>
</html>
