<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"timewait7.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="多线程下载管理器我将设计一个既可以命令行执行又可以通过Web页面使用的多线程下载管理器。这个系统将包含核心下载引擎、进度显示和两种用户界面。 项目结构1234567891011121314151617downloader&#x2F;├── core&#x2F;│   ├── __init__.py│   ├── downloader.py      # 核心下载引擎│   └── utils.py">
<meta property="og:type" content="article">
<meta property="og:title" content="Python实践-多线程下载管理器">
<meta property="og:url" content="http://timewait7.github.io/post/2c7fedc6.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="多线程下载管理器我将设计一个既可以命令行执行又可以通过Web页面使用的多线程下载管理器。这个系统将包含核心下载引擎、进度显示和两种用户界面。 项目结构1234567891011121314151617downloader&#x2F;├── core&#x2F;│   ├── __init__.py│   ├── downloader.py      # 核心下载引擎│   └── utils.py">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-12-17T10:11:29.000Z">
<meta property="article:modified_time" content="2025-12-19T16:13:22.143Z">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://timewait7.github.io/post/2c7fedc6.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://timewait7.github.io/post/2c7fedc6.html","path":"post/2c7fedc6.html","title":"Python实践-多线程下载管理器"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Python实践-多线程下载管理器 | Hexo</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-archives"><a href="/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="Searching..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E7%AE%A1%E7%90%86%E5%99%A8"><span class="nav-number">1.</span> <span class="nav-text">多线程下载管理器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-number">1.1.</span> <span class="nav-text">项目结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%8C%87%E5%8D%97"><span class="nav-number">1.2.</span> <span class="nav-text">实现指南</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%A0%B8%E5%BF%83%E4%B8%8B%E8%BD%BD%E6%A8%A1%E5%9D%97"><span class="nav-number">1.2.1.</span> <span class="nav-text">1. 核心下载模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%95%8C%E9%9D%A2"><span class="nav-number">1.2.2.</span> <span class="nav-text">2. 命令行界面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Web%E7%95%8C%E9%9D%A2"><span class="nav-number">1.2.3.</span> <span class="nav-text">3. Web界面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">1.2.4.</span> <span class="nav-text">4. 配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E8%BF%90%E8%A1%8C"><span class="nav-number">1.2.5.</span> <span class="nav-text">5. 运行</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%89%B9%E6%80%A7%E4%BA%AE%E7%82%B9"><span class="nav-number">1.3.</span> <span class="nav-text">特性亮点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.4.</span> <span class="nav-text">扩展建议</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E7%AE%A1%E7%90%86%E5%99%A8%E6%89%A9%E5%B1%95"><span class="nav-number">2.</span> <span class="nav-text">多线程下载管理器扩展</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E5%8A%9F%E8%83%BD%E6%A6%82%E8%A7%88"><span class="nav-number">2.1.</span> <span class="nav-text">扩展功能概览</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84%E6%9B%B4%E6%96%B0"><span class="nav-number">2.2.</span> <span class="nav-text">项目结构更新</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%89%A9%E5%B1%95%E6%A0%B8%E5%BF%83%E4%B8%8B%E8%BD%BD%E6%A8%A1%E5%9D%97"><span class="nav-number">2.3.</span> <span class="nav-text">1. 扩展核心下载模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%A2%9E%E5%BC%BA%E7%89%88CLI%E5%B7%A5%E5%85%B7"><span class="nav-number">2.4.</span> <span class="nav-text">2. 增强版CLI工具</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%A2%9E%E5%BC%BA%E7%89%88Web%E7%95%8C%E9%9D%A2"><span class="nav-number">2.5.</span> <span class="nav-text">3. 增强版Web界面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-1"><span class="nav-number">2.6.</span> <span class="nav-text">4. 配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Docker%E6%94%AF%E6%8C%81"><span class="nav-number">2.7.</span> <span class="nav-text">5. Docker支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E6%B5%8F%E8%A7%88%E5%99%A8%E6%89%A9%E5%B1%95"><span class="nav-number">2.8.</span> <span class="nav-text">6. 浏览器扩展</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E5%AE%8C%E6%95%B4%E7%9A%84requirements-txt"><span class="nav-number">2.9.</span> <span class="nav-text">7. 完整的requirements.txt</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-%E5%AE%89%E8%A3%85%E5%92%8C%E9%83%A8%E7%BD%B2%E8%84%9A%E6%9C%AC"><span class="nav-number">2.10.</span> <span class="nav-text">8. 安装和部署脚本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">2.11.</span> <span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD%E5%A2%9E%E5%BC%BA"><span class="nav-number">2.11.1.</span> <span class="nav-text">核心功能增强</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%B9%E9%87%8F%E5%A4%84%E7%90%86"><span class="nav-number">2.11.2.</span> <span class="nav-text">批量处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E5%8A%9F%E8%83%BD"><span class="nav-number">2.11.3.</span> <span class="nav-text">自动化功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E4%BD%93%E9%AA%8C"><span class="nav-number">2.11.4.</span> <span class="nav-text">用户体验</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84"><span class="nav-number">2.11.5.</span> <span class="nav-text">系统架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7"><span class="nav-number">2.11.6.</span> <span class="nav-text">安全特性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7%E5%92%8C%E7%AE%A1%E7%90%86"><span class="nav-number">2.11.7.</span> <span class="nav-text">监控和管理</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/">
          <span class="site-state-item-count">52</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>

    
        <div class="sidebar-inner sidebar-post-related">
          <div class="animated">
              <div class="links-of-blogroll-title"><i class="fa fa-signs-post fa-fw"></i>
    Related Posts
  </div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/post/f9ba3e83.html" rel="bookmark">
        <time class="popular-posts-time">2025-12-09</time>
        <br>
      Java面试笔记
      </a>
    </li>
  </ul>

          </div>
        </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://timewait7.github.io/post/2c7fedc6.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Python实践-多线程下载管理器 | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Python实践-多线程下载管理器
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-12-17 18:11:29" itemprop="dateCreated datePublished" datetime="2025-12-17T18:11:29+08:00">2025-12-17</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>19k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1:09</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="多线程下载管理器"><a href="#多线程下载管理器" class="headerlink" title="多线程下载管理器"></a>多线程下载管理器</h1><p>我将设计一个既可以命令行执行又可以通过Web页面使用的多线程下载管理器。这个系统将包含核心下载引擎、进度显示和两种用户界面。</p>
<h2 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">downloader/</span><br><span class="line">├── core/</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── downloader.py      # 核心下载引擎</span><br><span class="line">│   └── utils.py          # 工具函数</span><br><span class="line">├── cli/</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   └── main.py           # 命令行界面</span><br><span class="line">├── web/</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── app.py            # Web应用</span><br><span class="line">│   ├── templates/</span><br><span class="line">│   │   └── index.html    # Web界面模板</span><br><span class="line">│   └── static/</span><br><span class="line">│       └── style.css     # 样式文件</span><br><span class="line">├── requirements.txt</span><br><span class="line">└── README.md</span><br></pre></td></tr></table></figure>



<h2 id="实现指南"><a href="#实现指南" class="headerlink" title="实现指南"></a>实现指南</h2><h3 id="1-核心下载模块"><a href="#1-核心下载模块" class="headerlink" title="1. 核心下载模块"></a>1. 核心下载模块</h3><p>首先创建核心下载引擎，支持多线程下载和进度显示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br></pre></td><td class="code"><pre><span class="line"># core/downloader.py</span><br><span class="line">import os</span><br><span class="line">import threading</span><br><span class="line">import queue</span><br><span class="line">import requests</span><br><span class="line">import time</span><br><span class="line">from urllib.parse import urlparse</span><br><span class="line">from typing import Optional, Dict, List, Callable</span><br><span class="line">import math</span><br><span class="line"></span><br><span class="line">class Downloader:</span><br><span class="line">    def __init__(self, max_workers: int = 4, chunk_size: int = 1024 * 1024):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        初始化下载管理器</span><br><span class="line">        </span><br><span class="line">        Args:</span><br><span class="line">            max_workers: 最大线程数</span><br><span class="line">            chunk_size: 每个线程下载的块大小（字节）</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        self.max_workers = max_workers</span><br><span class="line">        self.chunk_size = chunk_size</span><br><span class="line">        self.active_downloads: Dict[str, Dict] = &#123;&#125;</span><br><span class="line">        self.lock = threading.Lock()</span><br><span class="line">        </span><br><span class="line">    def download_file(self, url: str, save_path: Optional[str] = None, </span><br><span class="line">                     progress_callback: Optional[Callable] = None) -&gt; Dict:</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        下载文件</span><br><span class="line">        </span><br><span class="line">        Args:</span><br><span class="line">            url: 下载链接</span><br><span class="line">            save_path: 保存路径（None则自动生成文件名）</span><br><span class="line">            progress_callback: 进度回调函数</span><br><span class="line">            </span><br><span class="line">        Returns:</span><br><span class="line">            包含下载信息的字典</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        # 生成默认文件名</span><br><span class="line">        if save_path is None:</span><br><span class="line">            parsed_url = urlparse(url)</span><br><span class="line">            filename = os.path.basename(parsed_url.path)</span><br><span class="line">            if not filename:</span><br><span class="line">                filename = f&quot;download_&#123;int(time.time())&#125;.bin&quot;</span><br><span class="line">            save_path = filename</span><br><span class="line">        </span><br><span class="line">        # 确保目录存在</span><br><span class="line">        os.makedirs(os.path.dirname(os.path.abspath(save_path)), exist_ok=True)</span><br><span class="line">        </span><br><span class="line">        # 获取文件信息</span><br><span class="line">        try:</span><br><span class="line">            head_response = requests.head(url, allow_redirects=True, timeout=10)</span><br><span class="line">            content_length = head_response.headers.get(&#x27;Content-Length&#x27;)</span><br><span class="line">            supports_range = head_response.headers.get(&#x27;Accept-Ranges&#x27;) == &#x27;bytes&#x27;</span><br><span class="line">            </span><br><span class="line">            if content_length and supports_range:</span><br><span class="line">                file_size = int(content_length)</span><br><span class="line">                # 多线程下载</span><br><span class="line">                return self._multithread_download(url, save_path, file_size, progress_callback)</span><br><span class="line">            else:</span><br><span class="line">                # 单线程下载</span><br><span class="line">                return self._singlethread_download(url, save_path, progress_callback)</span><br><span class="line">                </span><br><span class="line">        except Exception as e:</span><br><span class="line">            return &#123;</span><br><span class="line">                &#x27;url&#x27;: url,</span><br><span class="line">                &#x27;save_path&#x27;: save_path,</span><br><span class="line">                &#x27;status&#x27;: &#x27;error&#x27;,</span><br><span class="line">                &#x27;error&#x27;: str(e),</span><br><span class="line">                &#x27;progress&#x27;: 0</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">    def _multithread_download(self, url: str, save_path: str, file_size: int,</span><br><span class="line">                             progress_callback: Optional[Callable]) -&gt; Dict:</span><br><span class="line">        &quot;&quot;&quot;多线程下载实现&quot;&quot;&quot;</span><br><span class="line">        download_id = f&quot;&#123;url&#125;_&#123;int(time.time())&#125;&quot;</span><br><span class="line">        </span><br><span class="line">        with self.lock:</span><br><span class="line">            self.active_downloads[download_id] = &#123;</span><br><span class="line">                &#x27;url&#x27;: url,</span><br><span class="line">                &#x27;save_path&#x27;: save_path,</span><br><span class="line">                &#x27;file_size&#x27;: file_size,</span><br><span class="line">                &#x27;downloaded&#x27;: 0,</span><br><span class="line">                &#x27;status&#x27;: &#x27;downloading&#x27;,</span><br><span class="line">                &#x27;start_time&#x27;: time.time(),</span><br><span class="line">                &#x27;threads&#x27;: [],</span><br><span class="line">                &#x27;progress&#x27;: 0</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        # 计算每个线程的下载范围</span><br><span class="line">        num_chunks = min(self.max_workers, math.ceil(file_size / self.chunk_size))</span><br><span class="line">        chunk_size = math.ceil(file_size / num_chunks)</span><br><span class="line">        </span><br><span class="line">        # 创建临时文件部分</span><br><span class="line">        temp_files = []</span><br><span class="line">        for i in range(num_chunks):</span><br><span class="line">            start = i * chunk_size</span><br><span class="line">            end = min(start + chunk_size - 1, file_size - 1)</span><br><span class="line">            temp_file = f&quot;&#123;save_path&#125;.part&#123;i&#125;&quot;</span><br><span class="line">            temp_files.append(temp_file)</span><br><span class="line">            </span><br><span class="line">            thread = threading.Thread(</span><br><span class="line">                target=self._download_chunk,</span><br><span class="line">                args=(url, temp_file, start, end, download_id, i)</span><br><span class="line">            )</span><br><span class="line">            thread.daemon = True</span><br><span class="line">            thread.start()</span><br><span class="line">            </span><br><span class="line">            with self.lock:</span><br><span class="line">                self.active_downloads[download_id][&#x27;threads&#x27;].append(thread)</span><br><span class="line">        </span><br><span class="line">        # 等待所有线程完成</span><br><span class="line">        def wait_and_merge():</span><br><span class="line">            # 等待所有下载线程完成</span><br><span class="line">            for thread in self.active_downloads[download_id][&#x27;threads&#x27;]:</span><br><span class="line">                thread.join()</span><br><span class="line">            </span><br><span class="line">            # 检查是否所有部分都下载成功</span><br><span class="line">            all_parts_exist = all(os.path.exists(f) for f in temp_files)</span><br><span class="line">            </span><br><span class="line">            if all_parts_exist:</span><br><span class="line">                # 合并文件</span><br><span class="line">                try:</span><br><span class="line">                    with open(save_path, &#x27;wb&#x27;) as outfile:</span><br><span class="line">                        for temp_file in temp_files:</span><br><span class="line">                            with open(temp_file, &#x27;rb&#x27;) as infile:</span><br><span class="line">                                outfile.write(infile.read())</span><br><span class="line">                            os.remove(temp_file)</span><br><span class="line">                    </span><br><span class="line">                    with self.lock:</span><br><span class="line">                        self.active_downloads[download_id][&#x27;status&#x27;] = &#x27;completed&#x27;</span><br><span class="line">                        self.active_downloads[download_id][&#x27;progress&#x27;] = 100</span><br><span class="line">                        self.active_downloads[download_id][&#x27;end_time&#x27;] = time.time()</span><br><span class="line">                        </span><br><span class="line">                except Exception as e:</span><br><span class="line">                    with self.lock:</span><br><span class="line">                        self.active_downloads[download_id][&#x27;status&#x27;] = &#x27;error&#x27;</span><br><span class="line">                        self.active_downloads[download_id][&#x27;error&#x27;] = str(e)</span><br><span class="line">            else:</span><br><span class="line">                with self.lock:</span><br><span class="line">                    self.active_downloads[download_id][&#x27;status&#x27;] = &#x27;error&#x27;</span><br><span class="line">                    self.active_downloads[download_id][&#x27;error&#x27;] = &#x27;Some parts failed to download&#x27;</span><br><span class="line">            </span><br><span class="line">            # 调用进度回调</span><br><span class="line">            if progress_callback:</span><br><span class="line">                progress_callback(self.active_downloads[download_id])</span><br><span class="line">        </span><br><span class="line">        # 启动合并线程</span><br><span class="line">        merge_thread = threading.Thread(target=wait_and_merge)</span><br><span class="line">        merge_thread.daemon = True</span><br><span class="line">        merge_thread.start()</span><br><span class="line">        </span><br><span class="line">        return self.active_downloads[download_id]</span><br><span class="line">    </span><br><span class="line">    def _download_chunk(self, url: str, temp_file: str, start: int, end: int,</span><br><span class="line">                       download_id: str, chunk_id: int):</span><br><span class="line">        &quot;&quot;&quot;下载文件的一个分块&quot;&quot;&quot;</span><br><span class="line">        headers = &#123;&#x27;Range&#x27;: f&#x27;bytes=&#123;start&#125;-&#123;end&#125;&#x27;&#125;</span><br><span class="line">        </span><br><span class="line">        try:</span><br><span class="line">            response = requests.get(url, headers=headers, stream=True, timeout=30)</span><br><span class="line">            response.raise_for_status()</span><br><span class="line">            </span><br><span class="line">            downloaded = 0</span><br><span class="line">            chunk_size = 8192  # 8KB</span><br><span class="line">            </span><br><span class="line">            with open(temp_file, &#x27;wb&#x27;) as f:</span><br><span class="line">                for chunk in response.iter_content(chunk_size=chunk_size):</span><br><span class="line">                    if chunk:</span><br><span class="line">                        f.write(chunk)</span><br><span class="line">                        downloaded += len(chunk)</span><br><span class="line">                        </span><br><span class="line">                        # 更新进度</span><br><span class="line">                        with self.lock:</span><br><span class="line">                            if download_id in self.active_downloads:</span><br><span class="line">                                self.active_downloads[download_id][&#x27;downloaded&#x27;] += len(chunk)</span><br><span class="line">                                total = self.active_downloads[download_id][&#x27;file_size&#x27;]</span><br><span class="line">                                progress = (self.active_downloads[download_id][&#x27;downloaded&#x27;] / total) * 100</span><br><span class="line">                                self.active_downloads[download_id][&#x27;progress&#x27;] = round(progress, 2)</span><br><span class="line">            </span><br><span class="line">            # 标记这个分块下载完成</span><br><span class="line">            with self.lock:</span><br><span class="line">                if download_id in self.active_downloads:</span><br><span class="line">                    # 创建完成标记文件</span><br><span class="line">                    with open(f&quot;&#123;temp_file&#125;.done&quot;, &#x27;w&#x27;) as f:</span><br><span class="line">                        f.write(&#x27;done&#x27;)</span><br><span class="line">                        </span><br><span class="line">        except Exception as e:</span><br><span class="line">            print(f&quot;Chunk &#123;chunk_id&#125; download failed: &#123;e&#125;&quot;)</span><br><span class="line">    </span><br><span class="line">    def _singlethread_download(self, url: str, save_path: str,</span><br><span class="line">                              progress_callback: Optional[Callable]) -&gt; Dict:</span><br><span class="line">        &quot;&quot;&quot;单线程下载实现（用于不支持分块下载的文件）&quot;&quot;&quot;</span><br><span class="line">        download_id = f&quot;&#123;url&#125;_&#123;int(time.time())&#125;&quot;</span><br><span class="line">        </span><br><span class="line">        with self.lock:</span><br><span class="line">            self.active_downloads[download_id] = &#123;</span><br><span class="line">                &#x27;url&#x27;: url,</span><br><span class="line">                &#x27;save_path&#x27;: save_path,</span><br><span class="line">                &#x27;file_size&#x27;: 0,</span><br><span class="line">                &#x27;downloaded&#x27;: 0,</span><br><span class="line">                &#x27;status&#x27;: &#x27;downloading&#x27;,</span><br><span class="line">                &#x27;start_time&#x27;: time.time(),</span><br><span class="line">                &#x27;progress&#x27;: 0</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        try:</span><br><span class="line">            response = requests.get(url, stream=True, timeout=30)</span><br><span class="line">            response.raise_for_status()</span><br><span class="line">            </span><br><span class="line">            # 获取文件大小</span><br><span class="line">            file_size = int(response.headers.get(&#x27;Content-Length&#x27;, 0))</span><br><span class="line">            </span><br><span class="line">            with self.lock:</span><br><span class="line">                self.active_downloads[download_id][&#x27;file_size&#x27;] = file_size</span><br><span class="line">            </span><br><span class="line">            downloaded = 0</span><br><span class="line">            chunk_size = 8192</span><br><span class="line">            </span><br><span class="line">            with open(save_path, &#x27;wb&#x27;) as f:</span><br><span class="line">                for chunk in response.iter_content(chunk_size=chunk_size):</span><br><span class="line">                    if chunk:</span><br><span class="line">                        f.write(chunk)</span><br><span class="line">                        downloaded += len(chunk)</span><br><span class="line">                        </span><br><span class="line">                        # 更新进度</span><br><span class="line">                        with self.lock:</span><br><span class="line">                            if download_id in self.active_downloads:</span><br><span class="line">                                self.active_downloads[download_id][&#x27;downloaded&#x27;] = downloaded</span><br><span class="line">                                if file_size &gt; 0:</span><br><span class="line">                                    progress = (downloaded / file_size) * 100</span><br><span class="line">                                    self.active_downloads[download_id][&#x27;progress&#x27;] = round(progress, 2)</span><br><span class="line">            </span><br><span class="line">            with self.lock:</span><br><span class="line">                self.active_downloads[download_id][&#x27;status&#x27;] = &#x27;completed&#x27;</span><br><span class="line">                self.active_downloads[download_id][&#x27;progress&#x27;] = 100</span><br><span class="line">                self.active_downloads[download_id][&#x27;end_time&#x27;] = time.time()</span><br><span class="line">                </span><br><span class="line">        except Exception as e:</span><br><span class="line">            with self.lock:</span><br><span class="line">                self.active_downloads[download_id][&#x27;status&#x27;] = &#x27;error&#x27;</span><br><span class="line">                self.active_downloads[download_id][&#x27;error&#x27;] = str(e)</span><br><span class="line">        </span><br><span class="line">        # 调用进度回调</span><br><span class="line">        if progress_callback:</span><br><span class="line">            with self.lock:</span><br><span class="line">                progress_callback(self.active_downloads[download_id])</span><br><span class="line">        </span><br><span class="line">        return self.active_downloads[download_id]</span><br><span class="line">    </span><br><span class="line">    def get_download_status(self, download_id: str) -&gt; Optional[Dict]:</span><br><span class="line">        &quot;&quot;&quot;获取下载状态&quot;&quot;&quot;</span><br><span class="line">        with self.lock:</span><br><span class="line">            return self.active_downloads.get(download_id)</span><br><span class="line">    </span><br><span class="line">    def get_all_downloads(self) -&gt; List[Dict]:</span><br><span class="line">        &quot;&quot;&quot;获取所有下载任务&quot;&quot;&quot;</span><br><span class="line">        with self.lock:</span><br><span class="line">            return list(self.active_downloads.values())</span><br><span class="line">    </span><br><span class="line">    def cancel_download(self, download_id: str) -&gt; bool:</span><br><span class="line">        &quot;&quot;&quot;取消下载&quot;&quot;&quot;</span><br><span class="line">        # 注意：这是一个简化版本，实际需要终止下载线程</span><br><span class="line">        with self.lock:</span><br><span class="line">            if download_id in self.active_downloads:</span><br><span class="line">                self.active_downloads[download_id][&#x27;status&#x27;] = &#x27;cancelled&#x27;</span><br><span class="line">                return True</span><br><span class="line">            return False</span><br></pre></td></tr></table></figure>



<p>python</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># core/utils.py</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> humanize</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">format_file_size</span>(<span class="params">size_bytes: <span class="built_in">int</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;格式化文件大小&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> size_bytes == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;0 B&quot;</span></span><br><span class="line">    <span class="keyword">return</span> humanize.naturalsize(size_bytes)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">format_time</span>(<span class="params">seconds: <span class="built_in">float</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;格式化时间&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> seconds &lt; <span class="number">60</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;<span class="subst">&#123;seconds:<span class="number">.1</span>f&#125;</span>秒&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> seconds &lt; <span class="number">3600</span>:</span><br><span class="line">        minutes = seconds / <span class="number">60</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;<span class="subst">&#123;minutes:<span class="number">.1</span>f&#125;</span>分钟&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        hours = seconds / <span class="number">3600</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;<span class="subst">&#123;hours:<span class="number">.1</span>f&#125;</span>小时&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_speed</span>(<span class="params">downloaded: <span class="built_in">int</span>, start_time: <span class="built_in">float</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;计算下载速度&quot;&quot;&quot;</span></span><br><span class="line">    elapsed = time.time() - start_time</span><br><span class="line">    <span class="keyword">if</span> elapsed &gt; <span class="number">0</span>:</span><br><span class="line">        speed = downloaded / elapsed</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;<span class="subst">&#123;format_file_size(speed)&#125;</span>/s&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;0 B/s&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_file_hash</span>(<span class="params">filepath: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;计算文件哈希值&quot;&quot;&quot;</span></span><br><span class="line">    sha256_hash = hashlib.sha256()</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filepath, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> byte_block <span class="keyword">in</span> <span class="built_in">iter</span>(<span class="keyword">lambda</span>: f.read(<span class="number">4096</span>), <span class="string">b&quot;&quot;</span>):</span><br><span class="line">            sha256_hash.update(byte_block)</span><br><span class="line">    <span class="keyword">return</span> sha256_hash.hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_valid_url</span>(<span class="params">url: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;检查URL是否有效&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">import</span> re</span><br><span class="line">    regex = re.<span class="built_in">compile</span>(</span><br><span class="line">        <span class="string">r&#x27;^(?:http|ftp)s?://&#x27;</span>  <span class="comment"># http:// or https://</span></span><br><span class="line">        <span class="string">r&#x27;(?:(?:[A-Z0-9](?:[A-Z0-9-]&#123;0,61&#125;[A-Z0-9])?\.)+(?:[A-Z]&#123;2,6&#125;\.?|[A-Z0-9-]&#123;2,&#125;\.?)|&#x27;</span>  <span class="comment"># domain...</span></span><br><span class="line">        <span class="string">r&#x27;localhost|&#x27;</span>  <span class="comment"># localhost...</span></span><br><span class="line">        <span class="string">r&#x27;\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;)&#x27;</span>  <span class="comment"># ...or ip</span></span><br><span class="line">        <span class="string">r&#x27;(?::\d+)?&#x27;</span>  <span class="comment"># optional port</span></span><br><span class="line">        <span class="string">r&#x27;(?:/?|[/?]\S+)$&#x27;</span>, re.IGNORECASE)</span><br><span class="line">    <span class="keyword">return</span> re.<span class="keyword">match</span>(regex, url) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>



<h3 id="2-命令行界面"><a href="#2-命令行界面" class="headerlink" title="2. 命令行界面"></a>2. 命令行界面</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cli/main.py</span></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> core.downloader <span class="keyword">import</span> Downloader</span><br><span class="line"><span class="keyword">from</span> core.utils <span class="keyword">import</span> format_file_size, format_time, calculate_speed</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">progress_callback</span>(<span class="params">download_info</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;命令行进度回调&quot;&quot;&quot;</span></span><br><span class="line">    url = download_info[<span class="string">&#x27;url&#x27;</span>]</span><br><span class="line">    progress = download_info[<span class="string">&#x27;progress&#x27;</span>]</span><br><span class="line">    downloaded = download_info.get(<span class="string">&#x27;downloaded&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    file_size = download_info.get(<span class="string">&#x27;file_size&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    status = download_info[<span class="string">&#x27;status&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> status == <span class="string">&#x27;downloading&#x27;</span>:</span><br><span class="line">        bar_length = <span class="number">40</span></span><br><span class="line">        filled_length = <span class="built_in">int</span>(bar_length * progress / <span class="number">100</span>)</span><br><span class="line">        bar = <span class="string">&#x27;█&#x27;</span> * filled_length + <span class="string">&#x27;░&#x27;</span> * (bar_length - filled_length)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> file_size &gt; <span class="number">0</span>:</span><br><span class="line">            size_info = <span class="string">f&quot;<span class="subst">&#123;format_file_size(downloaded)&#125;</span>/<span class="subst">&#123;format_file_size(file_size)&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            size_info = <span class="string">f&quot;<span class="subst">&#123;format_file_size(downloaded)&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        sys.stdout.write(<span class="string">f&quot;\r下载中: |<span class="subst">&#123;bar&#125;</span>| <span class="subst">&#123;progress:<span class="number">.1</span>f&#125;</span>% <span class="subst">&#123;size_info&#125;</span>&quot;</span>)</span><br><span class="line">        sys.stdout.flush()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> progress &gt;= <span class="number">100</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\n下载完成: <span class="subst">&#123;url&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> status == <span class="string">&#x27;completed&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n✓ 下载完成: <span class="subst">&#123;url&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> status == <span class="string">&#x27;error&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n✗ 下载失败: <span class="subst">&#123;url&#125;</span> - <span class="subst">&#123;download_info.get(<span class="string">&#x27;error&#x27;</span>, <span class="string">&#x27;未知错误&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&#x27;多线程下载管理器&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;url&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;要下载的URL&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-o&#x27;</span>, <span class="string">&#x27;--output&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;保存路径&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-t&#x27;</span>, <span class="string">&#x27;--threads&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">4</span>, </span><br><span class="line">                       <span class="built_in">help</span>=<span class="string">&#x27;线程数 (默认: 4)&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;--chunk-size&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">1024</span>*<span class="number">1024</span>,</span><br><span class="line">                       <span class="built_in">help</span>=<span class="string">&#x27;分块大小，字节 (默认: 1MB)&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;开始下载: <span class="subst">&#123;args.url&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;线程数: <span class="subst">&#123;args.threads&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;分块大小: <span class="subst">&#123;format_file_size(args.chunk_size)&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    downloader = Downloader(max_workers=args.threads, chunk_size=args.chunk_size)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = downloader.download_file(args.url, args.output, progress_callback)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 等待下载完成</span></span><br><span class="line">        <span class="keyword">while</span> result[<span class="string">&#x27;status&#x27;</span>] == <span class="string">&#x27;downloading&#x27;</span>:</span><br><span class="line">            time.sleep(<span class="number">0.5</span>)</span><br><span class="line">            result = downloader.get_download_status(result[<span class="string">&#x27;url&#x27;</span>] + <span class="string">&#x27;_&#x27;</span> + <span class="built_in">str</span>(result.get(<span class="string">&#x27;start_time&#x27;</span>, <span class="string">&#x27;&#x27;</span>)))</span><br><span class="line">            <span class="keyword">if</span> result:</span><br><span class="line">                progress_callback(result)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> result[<span class="string">&#x27;status&#x27;</span>] == <span class="string">&#x27;completed&#x27;</span>:</span><br><span class="line">            elapsed = result.get(<span class="string">&#x27;end_time&#x27;</span>, time.time()) - result.get(<span class="string">&#x27;start_time&#x27;</span>, time.time())</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\n下载统计:&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  文件: <span class="subst">&#123;result[<span class="string">&#x27;save_path&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  大小: <span class="subst">&#123;format_file_size(result.get(<span class="string">&#x27;file_size&#x27;</span>, <span class="number">0</span>))&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  耗时: <span class="subst">&#123;format_time(elapsed)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> elapsed &gt; <span class="number">0</span>:</span><br><span class="line">                speed = result.get(<span class="string">&#x27;downloaded&#x27;</span>, <span class="number">0</span>) / elapsed</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;  平均速度: <span class="subst">&#123;format_file_size(speed)&#125;</span>/s&quot;</span>)</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n\n下载被用户中断&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n下载失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>



<h3 id="3-Web界面"><a href="#3-Web界面" class="headerlink" title="3. Web界面"></a>3. Web界面</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># web/app.py</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, jsonify, send_file</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> core.downloader <span class="keyword">import</span> Downloader</span><br><span class="line"><span class="keyword">from</span> core.utils <span class="keyword">import</span> format_file_size, format_time, calculate_speed</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">downloader = Downloader(max_workers=<span class="number">4</span>, chunk_size=<span class="number">1024</span>*<span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 存储下载历史</span></span><br><span class="line">download_history = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">web_progress_callback</span>(<span class="params">download_info</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Web进度回调，更新下载历史&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i, item <span class="keyword">in</span> <span class="built_in">enumerate</span>(download_history):</span><br><span class="line">        <span class="keyword">if</span> item.get(<span class="string">&#x27;id&#x27;</span>) == download_info.get(<span class="string">&#x27;url&#x27;</span>) + <span class="string">&#x27;_&#x27;</span> + <span class="built_in">str</span>(download_info.get(<span class="string">&#x27;start_time&#x27;</span>, <span class="string">&#x27;&#x27;</span>)):</span><br><span class="line">            download_history[i] = download_info</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        download_history.append(download_info)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主页&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/download&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start_download</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;开始下载&quot;&quot;&quot;</span></span><br><span class="line">    data = request.json</span><br><span class="line">    url = data.get(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line">    save_path = data.get(<span class="string">&#x27;save_path&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> url:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;URL不能为空&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 启动下载</span></span><br><span class="line">        result = downloader.download_file(url, save_path, web_progress_callback)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 给下载任务添加ID</span></span><br><span class="line">        download_id = result[<span class="string">&#x27;url&#x27;</span>] + <span class="string">&#x27;_&#x27;</span> + <span class="built_in">str</span>(result.get(<span class="string">&#x27;start_time&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">        result[<span class="string">&#x27;id&#x27;</span>] = download_id</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: download_id,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;下载任务已开始&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="built_in">str</span>(e)&#125;), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/progress&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_progress</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取下载进度&quot;&quot;&quot;</span></span><br><span class="line">    downloads = downloader.get_all_downloads()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 格式化下载信息</span></span><br><span class="line">    formatted_downloads = []</span><br><span class="line">    <span class="keyword">for</span> dl <span class="keyword">in</span> downloads:</span><br><span class="line">        formatted = &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: dl.get(<span class="string">&#x27;url&#x27;</span>) + <span class="string">&#x27;_&#x27;</span> + <span class="built_in">str</span>(dl.get(<span class="string">&#x27;start_time&#x27;</span>, <span class="string">&#x27;&#x27;</span>)),</span><br><span class="line">            <span class="string">&#x27;url&#x27;</span>: dl.get(<span class="string">&#x27;url&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;filename&#x27;</span>: os.path.basename(dl.get(<span class="string">&#x27;save_path&#x27;</span>, <span class="string">&#x27;&#x27;</span>)),</span><br><span class="line">            <span class="string">&#x27;save_path&#x27;</span>: dl.get(<span class="string">&#x27;save_path&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;status&#x27;</span>: dl.get(<span class="string">&#x27;status&#x27;</span>, <span class="string">&#x27;unknown&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;progress&#x27;</span>: dl.get(<span class="string">&#x27;progress&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="string">&#x27;file_size&#x27;</span>: dl.get(<span class="string">&#x27;file_size&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="string">&#x27;downloaded&#x27;</span>: dl.get(<span class="string">&#x27;downloaded&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="string">&#x27;formatted_size&#x27;</span>: format_file_size(dl.get(<span class="string">&#x27;file_size&#x27;</span>, <span class="number">0</span>)),</span><br><span class="line">            <span class="string">&#x27;formatted_downloaded&#x27;</span>: format_file_size(dl.get(<span class="string">&#x27;downloaded&#x27;</span>, <span class="number">0</span>)),</span><br><span class="line">            <span class="string">&#x27;start_time&#x27;</span>: dl.get(<span class="string">&#x27;start_time&#x27;</span>, time.time()),</span><br><span class="line">            <span class="string">&#x27;speed&#x27;</span>: <span class="string">&#x27;计算中...&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算速度</span></span><br><span class="line">        <span class="keyword">if</span> dl.get(<span class="string">&#x27;status&#x27;</span>) == <span class="string">&#x27;downloading&#x27;</span> <span class="keyword">and</span> dl.get(<span class="string">&#x27;start_time&#x27;</span>):</span><br><span class="line">            elapsed = time.time() - dl[<span class="string">&#x27;start_time&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> elapsed &gt; <span class="number">0</span>:</span><br><span class="line">                speed = dl.get(<span class="string">&#x27;downloaded&#x27;</span>, <span class="number">0</span>) / elapsed</span><br><span class="line">                formatted[<span class="string">&#x27;speed&#x27;</span>] = <span class="string">f&quot;<span class="subst">&#123;format_file_size(speed)&#125;</span>/s&quot;</span></span><br><span class="line">        </span><br><span class="line">        formatted_downloads.append(formatted)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;downloads&#x27;</span>: formatted_downloads&#125;)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/history&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_history</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取下载历史&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;history&#x27;</span>: download_history[-<span class="number">20</span>:]&#125;)  <span class="comment"># 返回最近20条记录</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/cancel&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cancel_download</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;取消下载&quot;&quot;&quot;</span></span><br><span class="line">    data = request.json</span><br><span class="line">    download_id = data.get(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> downloader.cancel_download(download_id):</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;success&#x27;</span>: <span class="literal">True</span>&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;下载任务不存在&#x27;</span>&#125;), <span class="number">404</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/files&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">list_files</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;列出已下载的文件&quot;&quot;&quot;</span></span><br><span class="line">    download_dir = os.path.dirname(os.path.abspath(<span class="string">&#x27;.&#x27;</span>))</span><br><span class="line">    files = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> download_history:</span><br><span class="line">        <span class="keyword">if</span> item.get(<span class="string">&#x27;status&#x27;</span>) == <span class="string">&#x27;completed&#x27;</span> <span class="keyword">and</span> item.get(<span class="string">&#x27;save_path&#x27;</span>):</span><br><span class="line">            filepath = item[<span class="string">&#x27;save_path&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> os.path.exists(filepath):</span><br><span class="line">                files.append(&#123;</span><br><span class="line">                    <span class="string">&#x27;name&#x27;</span>: os.path.basename(filepath),</span><br><span class="line">                    <span class="string">&#x27;path&#x27;</span>: filepath,</span><br><span class="line">                    <span class="string">&#x27;size&#x27;</span>: format_file_size(os.path.getsize(filepath)),</span><br><span class="line">                    <span class="string">&#x27;download_time&#x27;</span>: time.ctime(item.get(<span class="string">&#x27;end_time&#x27;</span>, time.time()))</span><br><span class="line">                &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;files&#x27;</span>: files&#125;)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/download-file/&lt;path:filename&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_file</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;下载已保存的文件&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> send_file(filename, as_attachment=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="built_in">str</span>(e)&#125;), <span class="number">404</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure>



<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- web/templates/index.html --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh-CN&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>多线程下载管理器<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; url_for(&#x27;static&#x27;, filename=&#x27;style.css&#x27;) &#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-download&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 多线程下载管理器<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;subtitle&quot;</span>&gt;</span>支持多线程下载，实时进度显示<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;main-content&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;download-form&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h2</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-plus-circle&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 新建下载<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;url&quot;</span>&gt;</span>下载URL:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;url&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;https://example.com/file.zip&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;save_path&quot;</span>&gt;</span>保存路径 (可选):<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;save_path&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;默认为当前目录&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;threads&quot;</span>&gt;</span>线程数:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;threads&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span>&gt;</span>2 线程<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;4&quot;</span> <span class="attr">selected</span>&gt;</span>4 线程<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;8&quot;</span>&gt;</span>8 线程<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;16&quot;</span>&gt;</span>16 线程<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;start-download&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn-primary&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-play&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 开始下载</span><br><span class="line">                <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;active-downloads&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h2</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-tasks&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 正在下载<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;download-list&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;download-history&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h2</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-history&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 下载历史<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;history-list&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;downloaded-files&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h2</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-folder-open&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 已下载文件<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;refresh-files&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn-secondary&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-sync-alt&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 刷新列表</span><br><span class="line">                <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;files-list&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">footer</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>多线程下载管理器 <span class="symbol">&amp;copy;</span> 2023 | 线程数: <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;thread-count&quot;</span>&gt;</span>4<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">footer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 更新下载列表</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">updateDownloads</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">fetch</span>(<span class="string">&#x27;/api/progress&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">                .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())</span></span><br><span class="line"><span class="language-javascript">                .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">const</span> list = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;download-list&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                    list.<span class="property">innerHTML</span> = <span class="string">&#x27;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                    </span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">if</span> (data.<span class="property">downloads</span>.<span class="property">length</span> === <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                        list.<span class="property">innerHTML</span> = <span class="string">&#x27;&lt;div class=&quot;empty-state&quot;&gt;没有正在进行的下载任务&lt;/div&gt;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">                    &#125;</span></span><br><span class="line"><span class="language-javascript">                    </span></span><br><span class="line"><span class="language-javascript">                    data.<span class="property">downloads</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">dl</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">const</span> item = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                        item.<span class="property">className</span> = <span class="string">&#x27;download-item&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                        </span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">let</span> statusIcon = <span class="string">&#x27;⏳&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">let</span> statusClass = <span class="string">&#x27;status-downloading&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">if</span> (dl.<span class="property">status</span> === <span class="string">&#x27;completed&#x27;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                            statusIcon = <span class="string">&#x27;✅&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                            statusClass = <span class="string">&#x27;status-completed&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dl.<span class="property">status</span> === <span class="string">&#x27;error&#x27;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                            statusIcon = <span class="string">&#x27;❌&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                            statusClass = <span class="string">&#x27;status-error&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dl.<span class="property">status</span> === <span class="string">&#x27;cancelled&#x27;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                            statusIcon = <span class="string">&#x27;⏹️&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                            statusClass = <span class="string">&#x27;status-cancelled&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                        &#125;</span></span><br><span class="line"><span class="language-javascript">                        </span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">const</span> progressBar = <span class="string">`</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                            &lt;div class=&quot;progress-container&quot;&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                &lt;div class=&quot;progress-bar&quot; style=&quot;width: <span class="subst">$&#123;dl.progress&#125;</span>%&quot;&gt;&lt;/div&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                &lt;span class=&quot;progress-text&quot;&gt;<span class="subst">$&#123;dl.progress.toFixed(<span class="number">1</span>)&#125;</span>%&lt;/span&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                            &lt;/div&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                        `</span>;</span></span><br><span class="line"><span class="language-javascript">                        </span></span><br><span class="line"><span class="language-javascript">                        item.<span class="property">innerHTML</span> = <span class="string">`</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                            &lt;div class=&quot;download-header&quot;&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                &lt;span class=&quot;status <span class="subst">$&#123;statusClass&#125;</span>&quot;&gt;<span class="subst">$&#123;statusIcon&#125;</span>&lt;/span&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                &lt;span class=&quot;filename&quot;&gt;<span class="subst">$&#123;dl.filename&#125;</span>&lt;/span&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                &lt;span class=&quot;file-size&quot;&gt;<span class="subst">$&#123;dl.formatted_size&#125;</span>&lt;/span&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                            &lt;/div&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                            &lt;div class=&quot;download-details&quot;&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                &lt;div&gt;URL: &lt;span class=&quot;url&quot;&gt;<span class="subst">$&#123;dl.url&#125;</span>&lt;/span&gt;&lt;/div&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                <span class="subst">$&#123;dl.status === <span class="string">&#x27;downloading&#x27;</span> ? progressBar : <span class="string">&#x27;&#x27;</span>&#125;</span></span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                &lt;div class=&quot;download-stats&quot;&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                    &lt;span&gt;已下载: <span class="subst">$&#123;dl.formatted_downloaded&#125;</span>&lt;/span&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                    &lt;span&gt;速度: <span class="subst">$&#123;dl.speed&#125;</span>&lt;/span&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                    &lt;span&gt;状态: <span class="subst">$&#123;dl.status&#125;</span>&lt;/span&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                &lt;/div&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                            &lt;/div&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                            <span class="subst">$&#123;dl.status === <span class="string">&#x27;downloading&#x27;</span> ? </span></span></span></span><br><span class="line"><span class="subst"><span class="string"><span class="language-javascript">                                <span class="string">`&lt;button class=&quot;btn-cancel&quot; onclick=&quot;cancelDownload(&#x27;<span class="subst">$&#123;dl.id&#125;</span>&#x27;)&quot;&gt;</span></span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="string"><span class="language-javascript">                                    &lt;i class=&quot;fas fa-stop&quot;&gt;&lt;/i&gt; 取消</span></span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="string"><span class="language-javascript">                                &lt;/button&gt;`</span> : <span class="string">&#x27;&#x27;</span>&#125;</span></span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                        `</span>;</span></span><br><span class="line"><span class="language-javascript">                        </span></span><br><span class="line"><span class="language-javascript">                        list.<span class="title function_">appendChild</span>(item);</span></span><br><span class="line"><span class="language-javascript">                    &#125;);</span></span><br><span class="line"><span class="language-javascript">                &#125;)</span></span><br><span class="line"><span class="language-javascript">                .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error:&#x27;</span>, error));</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 开始下载</span></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;start-download&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> url = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;url&#x27;</span>).<span class="property">value</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> savePath = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;save_path&#x27;</span>).<span class="property">value</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> threads = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;threads&#x27;</span>).<span class="property">value</span>;</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (!url) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">alert</span>(<span class="string">&#x27;请输入下载URL&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">fetch</span>(<span class="string">&#x27;/api/download&#x27;</span>, &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">headers</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                &#125;,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">url</span>: url,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">save_path</span>: savePath || <span class="literal">undefined</span></span></span><br><span class="line"><span class="language-javascript">                &#125;)</span></span><br><span class="line"><span class="language-javascript">            &#125;)</span></span><br><span class="line"><span class="language-javascript">            .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())</span></span><br><span class="line"><span class="language-javascript">            .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (data.<span class="property">success</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">alert</span>(<span class="string">&#x27;下载任务已开始&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;url&#x27;</span>).<span class="property">value</span> = <span class="string">&#x27;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;save_path&#x27;</span>).<span class="property">value</span> = <span class="string">&#x27;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">updateDownloads</span>();</span></span><br><span class="line"><span class="language-javascript">                &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">alert</span>(<span class="string">&#x27;错误: &#x27;</span> + (data.<span class="property">error</span> || <span class="string">&#x27;未知错误&#x27;</span>));</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;)</span></span><br><span class="line"><span class="language-javascript">            .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">alert</span>(<span class="string">&#x27;请求失败: &#x27;</span> + error);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 取消下载</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">cancelDownload</span>(<span class="params">downloadId</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (<span class="title function_">confirm</span>(<span class="string">&#x27;确定要取消这个下载任务吗？&#x27;</span>)) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">fetch</span>(<span class="string">&#x27;/api/cancel&#x27;</span>, &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">headers</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                    &#125;,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123; <span class="attr">id</span>: downloadId &#125;)</span></span><br><span class="line"><span class="language-javascript">                &#125;)</span></span><br><span class="line"><span class="language-javascript">                .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())</span></span><br><span class="line"><span class="language-javascript">                .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">if</span> (data.<span class="property">success</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="title function_">updateDownloads</span>();</span></span><br><span class="line"><span class="language-javascript">                    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="title function_">alert</span>(<span class="string">&#x27;取消失败: &#x27;</span> + (data.<span class="property">error</span> || <span class="string">&#x27;未知错误&#x27;</span>));</span></span><br><span class="line"><span class="language-javascript">                    &#125;</span></span><br><span class="line"><span class="language-javascript">                &#125;);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 更新下载历史</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">updateHistory</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">fetch</span>(<span class="string">&#x27;/api/history&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">                .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())</span></span><br><span class="line"><span class="language-javascript">                .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">const</span> list = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;history-list&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                    list.<span class="property">innerHTML</span> = <span class="string">&#x27;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                    </span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">if</span> (data.<span class="property">history</span>.<span class="property">length</span> === <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                        list.<span class="property">innerHTML</span> = <span class="string">&#x27;&lt;div class=&quot;empty-state&quot;&gt;暂无下载历史&lt;/div&gt;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">                    &#125;</span></span><br><span class="line"><span class="language-javascript">                    </span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// 显示最近5条历史记录</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">const</span> recentHistory = data.<span class="property">history</span>.<span class="title function_">slice</span>(-<span class="number">5</span>).<span class="title function_">reverse</span>();</span></span><br><span class="line"><span class="language-javascript">                    </span></span><br><span class="line"><span class="language-javascript">                    recentHistory.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">const</span> historyItem = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                        historyItem.<span class="property">className</span> = <span class="string">&#x27;history-item&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                        </span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">let</span> statusIcon = <span class="string">&#x27;⏳&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">let</span> statusClass = <span class="string">&#x27;status-downloading&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">if</span> (item.<span class="property">status</span> === <span class="string">&#x27;completed&#x27;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                            statusIcon = <span class="string">&#x27;✅&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                            statusClass = <span class="string">&#x27;status-completed&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (item.<span class="property">status</span> === <span class="string">&#x27;error&#x27;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                            statusIcon = <span class="string">&#x27;❌&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                            statusClass = <span class="string">&#x27;status-error&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                        &#125;</span></span><br><span class="line"><span class="language-javascript">                        </span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">const</span> filename = item.<span class="property">save_path</span> ? </span></span><br><span class="line"><span class="language-javascript">                            item.<span class="property">save_path</span>.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>).<span class="title function_">pop</span>() : </span></span><br><span class="line"><span class="language-javascript">                            item.<span class="property">url</span>.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>).<span class="title function_">pop</span>();</span></span><br><span class="line"><span class="language-javascript">                        </span></span><br><span class="line"><span class="language-javascript">                        historyItem.<span class="property">innerHTML</span> = <span class="string">`</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                            &lt;div class=&quot;history-header&quot;&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                &lt;span class=&quot;status <span class="subst">$&#123;statusClass&#125;</span>&quot;&gt;<span class="subst">$&#123;statusIcon&#125;</span>&lt;/span&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                &lt;span class=&quot;filename&quot;&gt;<span class="subst">$&#123;filename&#125;</span>&lt;/span&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                &lt;span class=&quot;progress&quot;&gt;<span class="subst">$&#123;item.progress&#125;</span>%&lt;/span&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                            &lt;/div&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                            &lt;div class=&quot;history-details&quot;&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                &lt;div&gt;<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>(item.start_time * <span class="number">1000</span>).toLocaleString()&#125;</span>&lt;/div&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                &lt;div class=&quot;url&quot;&gt;<span class="subst">$&#123;item.url.substring(<span class="number">0</span>, <span class="number">50</span>)&#125;</span><span class="subst">$&#123;item.url.length &gt; <span class="number">50</span> ? <span class="string">&#x27;...&#x27;</span> : <span class="string">&#x27;&#x27;</span>&#125;</span>&lt;/div&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                            &lt;/div&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                        `</span>;</span></span><br><span class="line"><span class="language-javascript">                        </span></span><br><span class="line"><span class="language-javascript">                        list.<span class="title function_">appendChild</span>(historyItem);</span></span><br><span class="line"><span class="language-javascript">                    &#125;);</span></span><br><span class="line"><span class="language-javascript">                &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 更新已下载文件列表</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">updateFilesList</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">fetch</span>(<span class="string">&#x27;/api/files&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">                .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())</span></span><br><span class="line"><span class="language-javascript">                .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">const</span> list = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;files-list&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                    list.<span class="property">innerHTML</span> = <span class="string">&#x27;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                    </span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">if</span> (data.<span class="property">files</span>.<span class="property">length</span> === <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                        list.<span class="property">innerHTML</span> = <span class="string">&#x27;&lt;div class=&quot;empty-state&quot;&gt;暂无已下载文件&lt;/div&gt;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">                    &#125;</span></span><br><span class="line"><span class="language-javascript">                    </span></span><br><span class="line"><span class="language-javascript">                    data.<span class="property">files</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">file</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">const</span> fileItem = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                        fileItem.<span class="property">className</span> = <span class="string">&#x27;file-item&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                        </span></span><br><span class="line"><span class="language-javascript">                        fileItem.<span class="property">innerHTML</span> = <span class="string">`</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                            &lt;div class=&quot;file-header&quot;&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                &lt;i class=&quot;fas fa-file&quot;&gt;&lt;/i&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                &lt;span class=&quot;filename&quot;&gt;<span class="subst">$&#123;file.name&#125;</span>&lt;/span&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                &lt;span class=&quot;file-size&quot;&gt;<span class="subst">$&#123;file.size&#125;</span>&lt;/span&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                            &lt;/div&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                            &lt;div class=&quot;file-details&quot;&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                &lt;div&gt;下载时间: <span class="subst">$&#123;file.download_time&#125;</span>&lt;/div&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                &lt;div&gt;路径: <span class="subst">$&#123;file.path&#125;</span>&lt;/div&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                            &lt;/div&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                            &lt;button class=&quot;btn-download&quot; onclick=&quot;downloadFile(&#x27;<span class="subst">$&#123;file.path&#125;</span>&#x27;)&quot;&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                &lt;i class=&quot;fas fa-download&quot;&gt;&lt;/i&gt; 下载</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                            &lt;/button&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                        `</span>;</span></span><br><span class="line"><span class="language-javascript">                        </span></span><br><span class="line"><span class="language-javascript">                        list.<span class="title function_">appendChild</span>(fileItem);</span></span><br><span class="line"><span class="language-javascript">                    &#125;);</span></span><br><span class="line"><span class="language-javascript">                &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 下载文件</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">downloadFile</span>(<span class="params">filepath</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">`/api/download-file/<span class="subst">$&#123;<span class="built_in">encodeURIComponent</span>(filepath)&#125;</span>`</span>, <span class="string">&#x27;_blank&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 刷新文件列表</span></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;refresh-files&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, updateFilesList);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 页面加载时初始化</span></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;DOMContentLoaded&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">updateDownloads</span>();</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">updateHistory</span>();</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">updateFilesList</span>();</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 每3秒更新一次下载状态</span></span></span><br><span class="line"><span class="language-javascript">            <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">updateDownloads</span>();</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">updateHistory</span>();</span></span><br><span class="line"><span class="language-javascript">            &#125;, <span class="number">3000</span>);</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 更新线程数显示</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;threads&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;change&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;thread-count&#x27;</span>).<span class="property">textContent</span> = <span class="variable language_">this</span>.<span class="property">value</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* web/static/style.css */</span></span><br><span class="line">* &#123;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">box-sizing</span>: border-box;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="attribute">font-family</span>: <span class="string">&#x27;Segoe UI&#x27;</span>, Tahoma, Geneva, Verdana, sans-serif;</span><br><span class="line">    <span class="attribute">line-height</span>: <span class="number">1.6</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#333</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">135deg</span>, <span class="number">#667eea</span> <span class="number">0%</span>, <span class="number">#764ba2</span> <span class="number">100%</span>);</span><br><span class="line">    <span class="attribute">min-height</span>: <span class="number">100vh</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">20px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">    <span class="attribute">max-width</span>: <span class="number">1200px</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span> auto;</span><br><span class="line">    <span class="attribute">background</span>: white;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">20px</span> <span class="number">60px</span> <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.3</span>);</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">header</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">135deg</span>, <span class="number">#4f46e5</span> <span class="number">0%</span>, <span class="number">#7c3aed</span> <span class="number">100%</span>);</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">2rem</span>;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">header</span> <span class="selector-tag">h1</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">2.5rem</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">0.5rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.subtitle</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1.1rem</span>;</span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">0.9</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.main-content</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">2rem</span>;</span><br><span class="line">    <span class="attribute">display</span>: grid;</span><br><span class="line">    <span class="attribute">grid-template-columns</span>: <span class="built_in">repeat</span>(auto-fit, <span class="built_in">minmax</span>(<span class="number">300px</span>, <span class="number">1</span>fr));</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">2rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.download-form</span> &#123;</span><br><span class="line">    <span class="attribute">grid-column</span>: <span class="number">1</span> / -<span class="number">1</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#f8fafc</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">1.5rem</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">2px</span> solid <span class="number">#e2e8f0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.form-group</span> &#123;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">1rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.form-group</span> <span class="selector-tag">label</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">0.5rem</span>;</span><br><span class="line">    <span class="attribute">font-weight</span>: <span class="number">600</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#4a5568</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.form-group</span> <span class="selector-tag">input</span>,</span><br><span class="line"><span class="selector-class">.form-group</span> select &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0.75rem</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">2px</span> solid <span class="number">#e2e8f0</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1rem</span>;</span><br><span class="line">    <span class="attribute">transition</span>: border-color <span class="number">0.3s</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.form-group</span> <span class="selector-tag">input</span><span class="selector-pseudo">:focus</span>,</span><br><span class="line"><span class="selector-class">.form-group</span> select<span class="selector-pseudo">:focus</span> &#123;</span><br><span class="line">    <span class="attribute">outline</span>: none;</span><br><span class="line">    <span class="attribute">border-color</span>: <span class="number">#4f46e5</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.btn-primary</span>,</span><br><span class="line"><span class="selector-class">.btn-secondary</span>,</span><br><span class="line"><span class="selector-class">.btn-cancel</span>,</span><br><span class="line"><span class="selector-class">.btn-download</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0.75rem</span> <span class="number">1.5rem</span>;</span><br><span class="line">    <span class="attribute">border</span>: none;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1rem</span>;</span><br><span class="line">    <span class="attribute">font-weight</span>: <span class="number">600</span>;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">transition</span>: all <span class="number">0.3s</span>;</span><br><span class="line">    <span class="attribute">display</span>: inline-flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">0.5rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.btn-primary</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">135deg</span>, <span class="number">#4f46e5</span> <span class="number">0%</span>, <span class="number">#7c3aed</span> <span class="number">100%</span>);</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.btn-primary</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translateY</span>(-<span class="number">2px</span>);</span><br><span class="line">    <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">10px</span> <span class="number">20px</span> <span class="built_in">rgba</span>(<span class="number">79</span>, <span class="number">70</span>, <span class="number">229</span>, <span class="number">0.3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.btn-secondary</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#e2e8f0</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#4a5568</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.btn-secondary</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#cbd5e0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.btn-cancel</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#fed7d7</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#c53030</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0.5rem</span> <span class="number">1rem</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.9rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.btn-cancel</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#feb2b2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.btn-download</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#c6f6d5</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#22543d</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0.5rem</span> <span class="number">1rem</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.9rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.btn-download</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#9ae6b4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.active-downloads</span>,</span><br><span class="line"><span class="selector-class">.download-history</span>,</span><br><span class="line"><span class="selector-class">.downloaded-files</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: white;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">1.5rem</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">2px</span> solid <span class="number">#e2e8f0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">h2</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#2d3748</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">1rem</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1.5rem</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">0.5rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#download-list</span>,</span><br><span class="line"><span class="selector-id">#history-list</span>,</span><br><span class="line"><span class="selector-id">#files-list</span> &#123;</span><br><span class="line">    <span class="attribute">max-height</span>: <span class="number">400px</span>;</span><br><span class="line">    <span class="attribute">overflow-y</span>: auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.download-item</span>,</span><br><span class="line"><span class="selector-class">.history-item</span>,</span><br><span class="line"><span class="selector-class">.file-item</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#f8fafc</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">1rem</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">1rem</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">border-left</span>: <span class="number">4px</span> solid <span class="number">#4f46e5</span>;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.download-header</span>,</span><br><span class="line"><span class="selector-class">.history-header</span>,</span><br><span class="line"><span class="selector-class">.file-header</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">0.75rem</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">0.5rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.status</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1.2rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.status-downloading</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#3182ce</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.status-completed</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#38a169</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.status-error</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#e53e3e</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.status-cancelled</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#718096</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.filename</span> &#123;</span><br><span class="line">    <span class="attribute">font-weight</span>: <span class="number">600</span>;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#2d3748</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.file-size</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#718096</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.9rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.download-details</span>,</span><br><span class="line"><span class="selector-class">.history-details</span>,</span><br><span class="line"><span class="selector-class">.file-details</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#718096</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.9rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.download-details</span> <span class="selector-class">.url</span> &#123;</span><br><span class="line">    <span class="attribute">word-break</span>: break-all;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">0.5rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.progress-container</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#e2e8f0</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0.5rem</span> <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.progress-bar</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">90deg</span>, <span class="number">#4f46e5</span> <span class="number">0%</span>, <span class="number">#7c3aed</span> <span class="number">100%</span>);</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">transition</span>: width <span class="number">0.3s</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.progress-text</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translate</span>(-<span class="number">50%</span>, -<span class="number">50%</span>);</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">font-weight</span>: <span class="number">600</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.8rem</span>;</span><br><span class="line">    <span class="attribute">text-shadow</span>: <span class="number">1px</span> <span class="number">1px</span> <span class="number">2px</span> <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.download-stats</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">1rem</span>;</span><br><span class="line">    <span class="attribute">margin-top</span>: <span class="number">0.5rem</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.85rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.empty-state</span> &#123;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#a0aec0</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">2rem</span>;</span><br><span class="line">    <span class="attribute">font-style</span>: italic;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">footer</span> &#123;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">1.5rem</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#f8fafc</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#718096</span>;</span><br><span class="line">    <span class="attribute">border-top</span>: <span class="number">2px</span> solid <span class="number">#e2e8f0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 滚动条样式 */</span></span><br><span class="line">::-webkit-scrollbar &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">8px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">::-webkit-scrollbar-track &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#f1f1f1</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">::-webkit-scrollbar-thumb &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#c1c1c1</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">::-webkit-scrollbar-thumb:hover &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#a1a1a1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 响应式设计 */</span></span><br><span class="line"><span class="keyword">@media</span> (<span class="attribute">max-width</span>: <span class="number">768px</span>) &#123;</span><br><span class="line">    <span class="selector-class">.main-content</span> &#123;</span><br><span class="line">        <span class="attribute">grid-template-columns</span>: <span class="number">1</span>fr;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="selector-tag">header</span> <span class="selector-tag">h1</span> &#123;</span><br><span class="line">        <span class="attribute">font-size</span>: <span class="number">2rem</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="selector-class">.download-stats</span> &#123;</span><br><span class="line">        <span class="attribute">flex-direction</span>: column;</span><br><span class="line">        <span class="attribute">gap</span>: <span class="number">0.25rem</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-配置文件"><a href="#4-配置文件" class="headerlink" title="4. 配置文件"></a>4. 配置文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># requirements.txt</span><br><span class="line">flask==2.3.3</span><br><span class="line">requests==2.31.0</span><br><span class="line">humanize==4.8.0</span><br></pre></td></tr></table></figure>



<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># README.md</span></span><br><span class="line"></span><br><span class="line"><span class="section"># 多线程下载管理器</span></span><br><span class="line"></span><br><span class="line">一个功能强大的Python下载管理器，支持命令行和Web界面。</span><br><span class="line"></span><br><span class="line"><span class="section">## 功能特性</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 多线程下载加速</span><br><span class="line"><span class="bullet">-</span> 实时进度显示</span><br><span class="line"><span class="bullet">-</span> 支持断点续传（需要服务器支持）</span><br><span class="line"><span class="bullet">-</span> 命令行和Web界面</span><br><span class="line"><span class="bullet">-</span> 下载历史记录</span><br><span class="line"><span class="bullet">-</span> 已下载文件管理</span><br><span class="line"></span><br><span class="line"><span class="section">## 安装</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">1.</span> 克隆仓库或下载源代码</span><br><span class="line"><span class="bullet">2.</span> 安装依赖：</span><br></pre></td></tr></table></figure>



<p>requirements.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">## 使用方式</span><br><span class="line"></span><br><span class="line">### 命令行模式</span><br><span class="line"></span><br><span class="line">```bash</span><br><span class="line"># 基本使用</span><br><span class="line">python cli/main.py https://example.com/file.zip</span><br><span class="line"></span><br><span class="line"># 指定保存路径</span><br><span class="line">python cli/main.py https://example.com/file.zip -o ./downloads/file.zip</span><br><span class="line"></span><br><span class="line"># 指定线程数</span><br><span class="line">python cli/main.py https://example.com/file.zip -t 8</span><br><span class="line"></span><br><span class="line"># 指定分块大小</span><br><span class="line">python cli/main.py https://example.com/file.zip -c 2097152  # 2MB</span><br></pre></td></tr></table></figure>



<h3 id="5-运行"><a href="#5-运行" class="headerlink" title="5. 运行"></a>5. 运行</h3><ol>
<li><p>启动Web服务器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python web/app.py</span><br></pre></td></tr></table></figure>


</li>
<li><p>打开浏览器访问：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:5000</span><br></pre></td></tr></table></figure>


</li>
<li><p>在Web界面中添加下载任务</p>
</li>
</ol>
<h2 id="特性亮点"><a href="#特性亮点" class="headerlink" title="特性亮点"></a>特性亮点</h2><ol>
<li><strong>多线程下载</strong>：将大文件分割成多个部分同时下载，提高下载速度</li>
<li><strong>实时进度显示</strong>：命令行和Web界面都提供实时进度更新</li>
<li><strong>自动检测</strong>：自动检测服务器是否支持分块下载</li>
<li><strong>错误处理</strong>：完善的错误处理和重试机制</li>
<li><strong>历史记录</strong>：保存下载历史，便于管理</li>
<li><strong>响应式设计</strong>：Web界面适配各种屏幕尺寸</li>
</ol>
<h2 id="扩展建议"><a href="#扩展建议" class="headerlink" title="扩展建议"></a>扩展建议</h2><ol>
<li><strong>断点续传</strong>：添加下载状态保存和恢复功能</li>
<li><strong>速度限制</strong>：添加下载速度限制功能</li>
<li><strong>代理支持</strong>：添加HTTP&#x2F;HTTPS代理支持</li>
<li><strong>批量下载</strong>：支持批量下载URL列表</li>
<li><strong>计划任务</strong>：支持定时下载任务</li>
<li><strong>下载队列</strong>：管理多个下载任务的优先级</li>
<li><strong>文件校验</strong>：下载完成后验证文件完整性（MD5&#x2F;SHA256）</li>
</ol>
<p>这个下载管理器既可以在命令行中快速使用，也可以通过Web界面在浏览器中管理下载任务，适合各种使用场景。</p>
<h1 id="多线程下载管理器扩展"><a href="#多线程下载管理器扩展" class="headerlink" title="多线程下载管理器扩展"></a>多线程下载管理器扩展</h1><p>我将进一步扩展下载管理器，添加更多高级功能，包括断点续传、下载队列、速度限制、代理支持、批量下载、文件校验等。</p>
<h2 id="扩展功能概览"><a href="#扩展功能概览" class="headerlink" title="扩展功能概览"></a>扩展功能概览</h2><ol>
<li><strong>断点续传</strong> - 支持从上次中断处继续下载</li>
<li><strong>下载队列</strong> - 管理多个下载任务，设置优先级</li>
<li><strong>速度限制</strong> - 限制下载上传速度</li>
<li><strong>代理支持</strong> - HTTP&#x2F;HTTPS&#x2F;SOCKS代理</li>
<li><strong>批量下载</strong> - 从文件导入URL列表批量下载</li>
<li><strong>文件校验</strong> - MD5&#x2F;SHA256校验和验证</li>
<li><strong>计划任务</strong> - 定时下载任务</li>
<li><strong>RSS订阅</strong> - 自动下载RSS更新</li>
<li><strong>浏览器集成</strong> - 浏览器扩展支持</li>
<li><strong>数据库存储</strong> - SQLite存储下载历史和配置</li>
<li><strong>REST API</strong> - 完整的API接口</li>
<li><strong>Docker支持</strong> - 容器化部署</li>
</ol>
<h2 id="项目结构更新"><a href="#项目结构更新" class="headerlink" title="项目结构更新"></a>项目结构更新</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">downloader/</span><br><span class="line">├── core/</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── downloader.py          # 核心下载引擎</span><br><span class="line">│   ├── queue_manager.py       # 下载队列管理</span><br><span class="line">│   ├── resume_manager.py      # 断点续传管理</span><br><span class="line">│   ├── speed_limiter.py       # 速度限制器</span><br><span class="line">│   ├── proxy_manager.py       # 代理管理</span><br><span class="line">│   ├── batch_processor.py     # 批量处理</span><br><span class="line">│   ├── file_checker.py        # 文件校验</span><br><span class="line">│   ├── scheduler.py           # 计划任务</span><br><span class="line">│   ├── rss_parser.py          # RSS解析器</span><br><span class="line">│   └── utils.py               # 工具函数</span><br><span class="line">├── cli/</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── main.py                # 主命令行入口</span><br><span class="line">│   ├── batch_cli.py           # 批量下载CLI</span><br><span class="line">│   └── interactive_cli.py     # 交互式CLI</span><br><span class="line">├── web/</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── app.py                 # Web应用主文件</span><br><span class="line">│   ├── api.py                 # REST API</span><br><span class="line">│   ├── auth.py                # 用户认证</span><br><span class="line">│   ├── models.py              # 数据库模型</span><br><span class="line">│   ├── templates/</span><br><span class="line">│   │   ├── index.html         # 主界面</span><br><span class="line">│   │   ├── login.html         # 登录页面</span><br><span class="line">│   │   ├── settings.html      # 设置页面</span><br><span class="line">│   │   ├── batch.html         # 批量下载页面</span><br><span class="line">│   │   └── rss.html           # RSS订阅页面</span><br><span class="line">│   ├── static/</span><br><span class="line">│   │   ├── style.css          # 主样式</span><br><span class="line">│   │   ├── dashboard.js       # 仪表板JS</span><br><span class="line">│   │   └── charts.js          # 图表JS</span><br><span class="line">│   └── extensions/</span><br><span class="line">│       └── browser_extension/ # 浏览器扩展</span><br><span class="line">├── api/</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── rest_api.py            # REST API服务器</span><br><span class="line">│   └── schemas.py             # API数据模式</span><br><span class="line">├── database/</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── models.py              # SQLAlchemy模型</span><br><span class="line">│   ├── crud.py                # 数据库操作</span><br><span class="line">│   └── migrations/            # 数据库迁移</span><br><span class="line">├── config/</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── settings.py            # 配置文件</span><br><span class="line">│   └── default_settings.yaml  # 默认设置</span><br><span class="line">├── tests/</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── test_downloader.py     # 下载器测试</span><br><span class="line">│   └── test_api.py            # API测试</span><br><span class="line">├── docker/</span><br><span class="line">│   ├── Dockerfile             # Docker构建文件</span><br><span class="line">│   └── docker-compose.yml     # Docker Compose配置</span><br><span class="line">├── requirements.txt           # Python依赖</span><br><span class="line">├── requirements-dev.txt       # 开发依赖</span><br><span class="line">├── setup.py                   # 安装脚本</span><br><span class="line">├── .env.example               # 环境变量示例</span><br><span class="line">└── README.md                  # 项目说明</span><br></pre></td></tr></table></figure>



<h2 id="1-扩展核心下载模块"><a href="#1-扩展核心下载模块" class="headerlink" title="1. 扩展核心下载模块"></a>1. 扩展核心下载模块</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># core/queue_manager.py</span></span><br><span class="line"><span class="keyword">import</span> heapq</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Optional</span>, <span class="type">Callable</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DownloadPriority</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;下载优先级枚举&quot;&quot;&quot;</span></span><br><span class="line">    LOW = <span class="number">0</span></span><br><span class="line">    NORMAL = <span class="number">1</span></span><br><span class="line">    HIGH = <span class="number">2</span></span><br><span class="line">    URGENT = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">QueueItem</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;下载队列项目&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, url: <span class="built_in">str</span>, save_path: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>, </span></span><br><span class="line"><span class="params">                 priority: DownloadPriority = DownloadPriority.NORMAL,</span></span><br><span class="line"><span class="params">                 metadata: <span class="type">Optional</span>[<span class="type">Dict</span>] = <span class="literal">None</span></span>):</span><br><span class="line">        self.url = url</span><br><span class="line">        self.save_path = save_path</span><br><span class="line">        self.priority = priority</span><br><span class="line">        self.metadata = metadata <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">        self.added_time = datetime.now()</span><br><span class="line">        self.queue_id = <span class="string">f&quot;<span class="subst">&#123;url&#125;</span>_<span class="subst">&#123;<span class="built_in">int</span>(time.time())&#125;</span>&quot;</span></span><br><span class="line">        self.status = <span class="string">&quot;queued&quot;</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__lt__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;用于堆排序，优先级高的在前面&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.priority.value == other.priority.value:</span><br><span class="line">            <span class="keyword">return</span> self.added_time &lt; other.added_time</span><br><span class="line">        <span class="keyword">return</span> self.priority.value &gt; other.priority.value</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">QueueManager</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;下载队列管理器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, max_concurrent: <span class="built_in">int</span> = <span class="number">3</span></span>):</span><br><span class="line">        self.max_concurrent = max_concurrent</span><br><span class="line">        self.queue = []  <span class="comment"># 使用堆实现优先级队列</span></span><br><span class="line">        self.active_downloads: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Dict</span>] = &#123;&#125;</span><br><span class="line">        self.completed_downloads: <span class="type">List</span>[<span class="type">Dict</span>] = []</span><br><span class="line">        self.waiting_downloads: <span class="type">List</span>[QueueItem] = []</span><br><span class="line">        self.lock = threading.Lock()</span><br><span class="line">        self.callbacks: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">List</span>[<span class="type">Callable</span>]] = &#123;</span><br><span class="line">            <span class="string">&#x27;item_added&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;item_started&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;item_completed&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;item_failed&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;queue_empty&#x27;</span>: []</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_to_queue</span>(<span class="params">self, url: <span class="built_in">str</span>, save_path: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                    priority: DownloadPriority = DownloadPriority.NORMAL,</span></span><br><span class="line"><span class="params">                    metadata: <span class="type">Optional</span>[<span class="type">Dict</span>] = <span class="literal">None</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;添加下载任务到队列&quot;&quot;&quot;</span></span><br><span class="line">        item = QueueItem(url, save_path, priority, metadata)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            heapq.heappush(self.queue, item)</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 触发回调</span></span><br><span class="line">        <span class="keyword">for</span> callback <span class="keyword">in</span> self.callbacks[<span class="string">&#x27;item_added&#x27;</span>]:</span><br><span class="line">            callback(item)</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 尝试启动下载</span></span><br><span class="line">        self._process_queue()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> item.queue_id</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_batch_to_queue</span>(<span class="params">self, items: <span class="type">List</span>[<span class="type">Dict</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;批量添加下载任务&quot;&quot;&quot;</span></span><br><span class="line">        queue_ids = []</span><br><span class="line">        <span class="keyword">for</span> item_data <span class="keyword">in</span> items:</span><br><span class="line">            queue_id = self.add_to_queue(</span><br><span class="line">                url=item_data.get(<span class="string">&#x27;url&#x27;</span>),</span><br><span class="line">                save_path=item_data.get(<span class="string">&#x27;save_path&#x27;</span>),</span><br><span class="line">                priority=DownloadPriority(item_data.get(<span class="string">&#x27;priority&#x27;</span>, <span class="number">1</span>)),</span><br><span class="line">                metadata=item_data.get(<span class="string">&#x27;metadata&#x27;</span>, &#123;&#125;)</span><br><span class="line">            )</span><br><span class="line">            queue_ids.append(queue_id)</span><br><span class="line">        <span class="keyword">return</span> queue_ids</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_process_queue</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理队列，启动下载任务&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            <span class="comment"># 检查当前活跃下载数量</span></span><br><span class="line">            active_count = <span class="built_in">len</span>([d <span class="keyword">for</span> d <span class="keyword">in</span> self.active_downloads.values() </span><br><span class="line">                              <span class="keyword">if</span> d.get(<span class="string">&#x27;status&#x27;</span>) <span class="keyword">in</span> [<span class="string">&#x27;downloading&#x27;</span>, <span class="string">&#x27;starting&#x27;</span>]])</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 如果活跃下载数未达到最大限制，从队列中取出任务</span></span><br><span class="line">            <span class="keyword">while</span> active_count &lt; self.max_concurrent <span class="keyword">and</span> self.queue:</span><br><span class="line">                item = heapq.heappop(self.queue)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 标记为正在启动</span></span><br><span class="line">                self.active_downloads[item.queue_id] = &#123;</span><br><span class="line">                    <span class="string">&#x27;item&#x27;</span>: item,</span><br><span class="line">                    <span class="string">&#x27;status&#x27;</span>: <span class="string">&#x27;starting&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;start_time&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">                    <span class="string">&#x27;progress&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="string">&#x27;speed&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="string">&#x27;downloaded&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="string">&#x27;file_size&#x27;</span>: <span class="number">0</span></span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 触发回调</span></span><br><span class="line">                <span class="keyword">for</span> callback <span class="keyword">in</span> self.callbacks[<span class="string">&#x27;item_started&#x27;</span>]:</span><br><span class="line">                    callback(item)</span><br><span class="line">                </span><br><span class="line">                active_count += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start_download</span>(<span class="params">self, queue_id: <span class="built_in">str</span>, download_func: <span class="type">Callable</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;开始下载任务&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            <span class="keyword">if</span> queue_id <span class="keyword">not</span> <span class="keyword">in</span> self.active_downloads:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            </span><br><span class="line">            item = self.active_downloads[queue_id][<span class="string">&#x27;item&#x27;</span>]</span><br><span class="line">            self.active_downloads[queue_id][<span class="string">&#x27;status&#x27;</span>] = <span class="string">&#x27;downloading&#x27;</span></span><br><span class="line">            self.active_downloads[queue_id][<span class="string">&#x27;start_time&#x27;</span>] = datetime.now()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 在实际应用中，这里会调用下载函数</span></span><br><span class="line">        <span class="comment"># download_func(item.url, item.save_path, self._create_callback(queue_id))</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_create_callback</span>(<span class="params">self, queue_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Callable</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建进度回调函数&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">callback</span>(<span class="params">download_info: <span class="type">Dict</span></span>):</span><br><span class="line">            <span class="keyword">with</span> self.lock:</span><br><span class="line">                <span class="keyword">if</span> queue_id <span class="keyword">in</span> self.active_downloads:</span><br><span class="line">                    self.active_downloads[queue_id].update(download_info)</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> download_info.get(<span class="string">&#x27;status&#x27;</span>) == <span class="string">&#x27;completed&#x27;</span>:</span><br><span class="line">                        self.completed_downloads.append(download_info)</span><br><span class="line">                        <span class="keyword">del</span> self.active_downloads[queue_id]</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">for</span> cb <span class="keyword">in</span> self.callbacks[<span class="string">&#x27;item_completed&#x27;</span>]:</span><br><span class="line">                            cb(download_info)</span><br><span class="line">                            </span><br><span class="line">                        <span class="comment"># 继续处理队列</span></span><br><span class="line">                        self._process_queue()</span><br><span class="line">                        </span><br><span class="line">                    <span class="keyword">elif</span> download_info.get(<span class="string">&#x27;status&#x27;</span>) == <span class="string">&#x27;error&#x27;</span>:</span><br><span class="line">                        <span class="keyword">for</span> cb <span class="keyword">in</span> self.callbacks[<span class="string">&#x27;item_failed&#x27;</span>]:</span><br><span class="line">                            cb(download_info)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> callback</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pause_download</span>(<span class="params">self, queue_id: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;暂停下载任务&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            <span class="keyword">if</span> queue_id <span class="keyword">in</span> self.active_downloads:</span><br><span class="line">                self.active_downloads[queue_id][<span class="string">&#x27;status&#x27;</span>] = <span class="string">&#x27;paused&#x27;</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">resume_download</span>(<span class="params">self, queue_id: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;恢复下载任务&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            <span class="keyword">if</span> queue_id <span class="keyword">in</span> self.active_downloads:</span><br><span class="line">                self.active_downloads[queue_id][<span class="string">&#x27;status&#x27;</span>] = <span class="string">&#x27;downloading&#x27;</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">cancel_download</span>(<span class="params">self, queue_id: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;取消下载任务&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            <span class="keyword">if</span> queue_id <span class="keyword">in</span> self.active_downloads:</span><br><span class="line">                self.active_downloads[queue_id][<span class="string">&#x27;status&#x27;</span>] = <span class="string">&#x27;cancelled&#x27;</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">remove_from_queue</span>(<span class="params">self, queue_id: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;从队列中移除任务&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            <span class="comment"># 从等待队列中移除</span></span><br><span class="line">            self.waiting_downloads = [item <span class="keyword">for</span> item <span class="keyword">in</span> self.waiting_downloads </span><br><span class="line">                                     <span class="keyword">if</span> item.queue_id != queue_id]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 从活跃下载中移除</span></span><br><span class="line">            <span class="keyword">if</span> queue_id <span class="keyword">in</span> self.active_downloads:</span><br><span class="line">                <span class="keyword">del</span> self.active_downloads[queue_id]</span><br><span class="line">                </span><br><span class="line">            <span class="comment"># 从优先级队列中移除</span></span><br><span class="line">            <span class="comment"># 注意：由于堆的特性，需要重建队列</span></span><br><span class="line">            new_queue = []</span><br><span class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> self.queue:</span><br><span class="line">                <span class="keyword">if</span> item.queue_id != queue_id:</span><br><span class="line">                    heapq.heappush(new_queue, item)</span><br><span class="line">            self.queue = new_queue</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_queue_status</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取队列状态&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;queue_size&#x27;</span>: <span class="built_in">len</span>(self.queue),</span><br><span class="line">                <span class="string">&#x27;waiting_count&#x27;</span>: <span class="built_in">len</span>(self.waiting_downloads),</span><br><span class="line">                <span class="string">&#x27;active_count&#x27;</span>: <span class="built_in">len</span>([d <span class="keyword">for</span> d <span class="keyword">in</span> self.active_downloads.values() </span><br><span class="line">                                   <span class="keyword">if</span> d.get(<span class="string">&#x27;status&#x27;</span>) == <span class="string">&#x27;downloading&#x27;</span>]),</span><br><span class="line">                <span class="string">&#x27;paused_count&#x27;</span>: <span class="built_in">len</span>([d <span class="keyword">for</span> d <span class="keyword">in</span> self.active_downloads.values() </span><br><span class="line">                                    <span class="keyword">if</span> d.get(<span class="string">&#x27;status&#x27;</span>) == <span class="string">&#x27;paused&#x27;</span>]),</span><br><span class="line">                <span class="string">&#x27;completed_count&#x27;</span>: <span class="built_in">len</span>(self.completed_downloads),</span><br><span class="line">                <span class="string">&#x27;max_concurrent&#x27;</span>: self.max_concurrent</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register_callback</span>(<span class="params">self, event: <span class="built_in">str</span>, callback: <span class="type">Callable</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;注册事件回调&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> event <span class="keyword">in</span> self.callbacks:</span><br><span class="line">            self.callbacks[event].append(callback)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_max_concurrent</span>(<span class="params">self, max_concurrent: <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;设置最大并发下载数&quot;&quot;&quot;</span></span><br><span class="line">        self.max_concurrent = max_concurrent</span><br><span class="line">        self._process_queue()</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># core/resume_manager.py</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Dict</span>, <span class="type">List</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResumeManager</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;断点续传管理器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, resume_dir: <span class="built_in">str</span> = <span class="string">&quot;.resume&quot;</span></span>):</span><br><span class="line">        self.resume_dir = resume_dir</span><br><span class="line">        os.makedirs(resume_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_resume_file_path</span>(<span class="params">self, url: <span class="built_in">str</span>, save_path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取续传文件路径&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 基于URL和保存路径生成唯一标识</span></span><br><span class="line">        url_hash = hashlib.md5(url.encode()).hexdigest()[:<span class="number">16</span>]</span><br><span class="line">        filename_hash = hashlib.md5(save_path.encode()).hexdigest()[:<span class="number">16</span>]</span><br><span class="line">        resume_filename = <span class="string">f&quot;<span class="subst">&#123;url_hash&#125;</span>_<span class="subst">&#123;filename_hash&#125;</span>.resume&quot;</span></span><br><span class="line">        <span class="keyword">return</span> os.path.join(self.resume_dir, resume_filename)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_resume_info</span>(<span class="params">self, url: <span class="built_in">str</span>, save_path: <span class="built_in">str</span>, chunks: <span class="type">List</span>[<span class="type">Dict</span>], </span></span><br><span class="line"><span class="params">                        total_size: <span class="built_in">int</span>, downloaded: <span class="built_in">int</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;保存续传信息&quot;&quot;&quot;</span></span><br><span class="line">        resume_info = &#123;</span><br><span class="line">            <span class="string">&#x27;url&#x27;</span>: url,</span><br><span class="line">            <span class="string">&#x27;save_path&#x27;</span>: save_path,</span><br><span class="line">            <span class="string">&#x27;chunks&#x27;</span>: chunks,</span><br><span class="line">            <span class="string">&#x27;total_size&#x27;</span>: total_size,</span><br><span class="line">            <span class="string">&#x27;downloaded&#x27;</span>: downloaded,</span><br><span class="line">            <span class="string">&#x27;timestamp&#x27;</span>: datetime.now().isoformat(),</span><br><span class="line">            <span class="string">&#x27;chunk_size&#x27;</span>: <span class="built_in">len</span>(chunks)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        resume_file = self._get_resume_file_path(url, save_path)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(resume_file, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                pickle.dump(resume_info, f)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;保存续传信息失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_resume_info</span>(<span class="params">self, url: <span class="built_in">str</span>, save_path: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;加载续传信息&quot;&quot;&quot;</span></span><br><span class="line">        resume_file = self._get_resume_file_path(url, save_path)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(resume_file):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(resume_file, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                resume_info = pickle.load(f)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 检查文件是否仍然有效</span></span><br><span class="line">            <span class="keyword">if</span> (resume_info[<span class="string">&#x27;url&#x27;</span>] == url <span class="keyword">and</span> </span><br><span class="line">                resume_info[<span class="string">&#x27;save_path&#x27;</span>] == save_path):</span><br><span class="line">                <span class="keyword">return</span> resume_info</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">                </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;加载续传信息失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update_chunk_status</span>(<span class="params">self, url: <span class="built_in">str</span>, save_path: <span class="built_in">str</span>, chunk_id: <span class="built_in">int</span>, </span></span><br><span class="line"><span class="params">                           downloaded: <span class="built_in">int</span>, total: <span class="built_in">int</span>, completed: <span class="built_in">bool</span> = <span class="literal">False</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;更新分块下载状态&quot;&quot;&quot;</span></span><br><span class="line">        resume_info = self.load_resume_info(url, save_path)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> resume_info:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 更新分块状态</span></span><br><span class="line">        <span class="keyword">for</span> chunk <span class="keyword">in</span> resume_info[<span class="string">&#x27;chunks&#x27;</span>]:</span><br><span class="line">            <span class="keyword">if</span> chunk[<span class="string">&#x27;id&#x27;</span>] == chunk_id:</span><br><span class="line">                chunk[<span class="string">&#x27;downloaded&#x27;</span>] = downloaded</span><br><span class="line">                chunk[<span class="string">&#x27;completed&#x27;</span>] = completed</span><br><span class="line">                chunk[<span class="string">&#x27;last_updated&#x27;</span>] = datetime.now().isoformat()</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 重新计算总下载量</span></span><br><span class="line">        total_downloaded = <span class="built_in">sum</span>(chunk[<span class="string">&#x27;downloaded&#x27;</span>] <span class="keyword">for</span> chunk <span class="keyword">in</span> resume_info[<span class="string">&#x27;chunks&#x27;</span>])</span><br><span class="line">        resume_info[<span class="string">&#x27;downloaded&#x27;</span>] = total_downloaded</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 保存更新后的信息</span></span><br><span class="line">        <span class="keyword">return</span> self.save_resume_info(</span><br><span class="line">            url=url,</span><br><span class="line">            save_path=save_path,</span><br><span class="line">            chunks=resume_info[<span class="string">&#x27;chunks&#x27;</span>],</span><br><span class="line">            total_size=resume_info[<span class="string">&#x27;total_size&#x27;</span>],</span><br><span class="line">            downloaded=total_downloaded</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">clear_resume_info</span>(<span class="params">self, url: <span class="built_in">str</span>, save_path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;清除续传信息（下载完成后调用）&quot;&quot;&quot;</span></span><br><span class="line">        resume_file = self._get_resume_file_path(url, save_path)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> os.path.exists(resume_file):</span><br><span class="line">                os.remove(resume_file)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;清除续传信息失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">list_resume_files</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;列出所有续传文件&quot;&quot;&quot;</span></span><br><span class="line">        resume_files = []</span><br><span class="line">        <span class="keyword">for</span> filename <span class="keyword">in</span> os.listdir(self.resume_dir):</span><br><span class="line">            <span class="keyword">if</span> filename.endswith(<span class="string">&#x27;.resume&#x27;</span>):</span><br><span class="line">                filepath = os.path.join(self.resume_dir, filename)</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">with</span> <span class="built_in">open</span>(filepath, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                        resume_info = pickle.load(f)</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># 计算进度</span></span><br><span class="line">                    progress = <span class="number">0</span></span><br><span class="line">                    <span class="keyword">if</span> resume_info[<span class="string">&#x27;total_size&#x27;</span>] &gt; <span class="number">0</span>:</span><br><span class="line">                        progress = (resume_info[<span class="string">&#x27;downloaded&#x27;</span>] / resume_info[<span class="string">&#x27;total_size&#x27;</span>]) * <span class="number">100</span></span><br><span class="line">                    </span><br><span class="line">                    resume_files.append(&#123;</span><br><span class="line">                        <span class="string">&#x27;url&#x27;</span>: resume_info[<span class="string">&#x27;url&#x27;</span>],</span><br><span class="line">                        <span class="string">&#x27;save_path&#x27;</span>: resume_info[<span class="string">&#x27;save_path&#x27;</span>],</span><br><span class="line">                        <span class="string">&#x27;filename&#x27;</span>: os.path.basename(resume_info[<span class="string">&#x27;save_path&#x27;</span>]),</span><br><span class="line">                        <span class="string">&#x27;progress&#x27;</span>: <span class="built_in">round</span>(progress, <span class="number">2</span>),</span><br><span class="line">                        <span class="string">&#x27;downloaded&#x27;</span>: resume_info[<span class="string">&#x27;downloaded&#x27;</span>],</span><br><span class="line">                        <span class="string">&#x27;total_size&#x27;</span>: resume_info[<span class="string">&#x27;total_size&#x27;</span>],</span><br><span class="line">                        <span class="string">&#x27;chunks&#x27;</span>: <span class="built_in">len</span>(resume_info[<span class="string">&#x27;chunks&#x27;</span>]),</span><br><span class="line">                        <span class="string">&#x27;timestamp&#x27;</span>: resume_info[<span class="string">&#x27;timestamp&#x27;</span>],</span><br><span class="line">                        <span class="string">&#x27;resume_file&#x27;</span>: filename</span><br><span class="line">                    &#125;)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;读取续传文件失败 <span class="subst">&#123;filename&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> resume_files</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">can_resume</span>(<span class="params">self, url: <span class="built_in">str</span>, save_path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查是否可以续传&quot;&quot;&quot;</span></span><br><span class="line">        resume_info = self.load_resume_info(url, save_path)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> resume_info:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查目标文件是否存在部分下载</span></span><br><span class="line">        <span class="keyword">if</span> os.path.exists(save_path):</span><br><span class="line">            file_size = os.path.getsize(save_path)</span><br><span class="line">            <span class="comment"># 如果文件大小接近总大小，可能已经下载完成</span></span><br><span class="line">            <span class="keyword">if</span> file_size &gt;= resume_info[<span class="string">&#x27;total_size&#x27;</span>] * <span class="number">0.95</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查是否有未完成的分块</span></span><br><span class="line">        incomplete_chunks = [chunk <span class="keyword">for</span> chunk <span class="keyword">in</span> resume_info[<span class="string">&#x27;chunks&#x27;</span>] </span><br><span class="line">                           <span class="keyword">if</span> <span class="keyword">not</span> chunk.get(<span class="string">&#x27;completed&#x27;</span>, <span class="literal">False</span>)]</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(incomplete_chunks) &gt; <span class="number">0</span></span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># core/speed_limiter.py</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SpeedLimiter</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;速度限制器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, download_limit: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span>, </span></span><br><span class="line"><span class="params">                 upload_limit: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        初始化速度限制器</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            download_limit: 下载速度限制，字节/秒</span></span><br><span class="line"><span class="string">            upload_limit: 上传速度限制，字节/秒</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.download_limit = download_limit</span><br><span class="line">        self.upload_limit = upload_limit</span><br><span class="line">        </span><br><span class="line">        self.download_bytes = defaultdict(<span class="built_in">int</span>)  <span class="comment"># 连接ID -&gt; 下载字节数</span></span><br><span class="line">        self.upload_bytes = defaultdict(<span class="built_in">int</span>)    <span class="comment"># 连接ID -&gt; 上传字节数</span></span><br><span class="line">        self.start_time = time.time()</span><br><span class="line">        self.lock = threading.Lock()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">limit_download</span>(<span class="params">self, connection_id: <span class="built_in">str</span>, data_size: <span class="built_in">int</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;限制下载速度，返回需要等待的时间（秒）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.download_limit:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            current_time = time.time()</span><br><span class="line">            elapsed = current_time - self.start_time</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 计算当前周期内的总下载量</span></span><br><span class="line">            total_downloaded = <span class="built_in">sum</span>(self.download_bytes.values())</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 计算允许的下载量</span></span><br><span class="line">            allowed_bytes = self.download_limit * elapsed</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 如果已超过限制，计算需要等待的时间</span></span><br><span class="line">            <span class="keyword">if</span> total_downloaded + data_size &gt; allowed_bytes:</span><br><span class="line">                <span class="comment"># 等待到下一个周期</span></span><br><span class="line">                wait_time = (total_downloaded + data_size - allowed_bytes) / self.download_limit</span><br><span class="line">                <span class="keyword">return</span> wait_time</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 更新下载字节数</span></span><br><span class="line">            self.download_bytes[connection_id] += data_size</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 如果已经超过1秒，重置计数器</span></span><br><span class="line">            <span class="keyword">if</span> elapsed &gt;= <span class="number">1.0</span>:</span><br><span class="line">                self._reset_counters()</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">limit_upload</span>(<span class="params">self, connection_id: <span class="built_in">str</span>, data_size: <span class="built_in">int</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;限制上传速度，返回需要等待的时间（秒）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.upload_limit:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            current_time = time.time()</span><br><span class="line">            elapsed = current_time - self.start_time</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 计算当前周期内的总上传量</span></span><br><span class="line">            total_uploaded = <span class="built_in">sum</span>(self.upload_bytes.values())</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 计算允许的上传量</span></span><br><span class="line">            allowed_bytes = self.upload_limit * elapsed</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 如果已超过限制，计算需要等待的时间</span></span><br><span class="line">            <span class="keyword">if</span> total_uploaded + data_size &gt; allowed_bytes:</span><br><span class="line">                <span class="comment"># 等待到下一个周期</span></span><br><span class="line">                wait_time = (total_uploaded + data_size - allowed_bytes) / self.upload_limit</span><br><span class="line">                <span class="keyword">return</span> wait_time</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 更新上传字节数</span></span><br><span class="line">            self.upload_bytes[connection_id] += data_size</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 如果已经超过1秒，重置计数器</span></span><br><span class="line">            <span class="keyword">if</span> elapsed &gt;= <span class="number">1.0</span>:</span><br><span class="line">                self._reset_counters()</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_reset_counters</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;重置计数器&quot;&quot;&quot;</span></span><br><span class="line">        self.download_bytes.clear()</span><br><span class="line">        self.upload_bytes.clear()</span><br><span class="line">        self.start_time = time.time()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_download_limit</span>(<span class="params">self, limit: <span class="type">Optional</span>[<span class="built_in">float</span>]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;设置下载速度限制&quot;&quot;&quot;</span></span><br><span class="line">        self.download_limit = limit</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_upload_limit</span>(<span class="params">self, limit: <span class="type">Optional</span>[<span class="built_in">float</span>]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;设置上传速度限制&quot;&quot;&quot;</span></span><br><span class="line">        self.upload_limit = limit</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_current_speeds</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取当前速度统计&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            current_time = time.time()</span><br><span class="line">            elapsed = <span class="built_in">max</span>(<span class="number">0.1</span>, current_time - self.start_time)  <span class="comment"># 避免除零</span></span><br><span class="line">            </span><br><span class="line">            download_speed = <span class="built_in">sum</span>(self.download_bytes.values()) / elapsed</span><br><span class="line">            upload_speed = <span class="built_in">sum</span>(self.upload_bytes.values()) / elapsed</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;download_speed&#x27;</span>: download_speed,</span><br><span class="line">                <span class="string">&#x27;upload_speed&#x27;</span>: upload_speed,</span><br><span class="line">                <span class="string">&#x27;download_limit&#x27;</span>: self.download_limit,</span><br><span class="line">                <span class="string">&#x27;upload_limit&#x27;</span>: self.upload_limit,</span><br><span class="line">                <span class="string">&#x27;active_connections&#x27;</span>: <span class="built_in">len</span>(self.download_bytes) + <span class="built_in">len</span>(self.upload_bytes)</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># core/proxy_manager.py</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Dict</span>, <span class="type">List</span></span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProxyManager</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;代理管理器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.proxies: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Dict</span>] = &#123;&#125;</span><br><span class="line">        self.active_proxy: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">        self.proxy_stats: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Dict</span>] = &#123;&#125;  <span class="comment"># 代理使用统计</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_proxy</span>(<span class="params">self, name: <span class="built_in">str</span>, proxy_url: <span class="built_in">str</span>, proxy_type: <span class="built_in">str</span> = <span class="string">&#x27;http&#x27;</span>,</span></span><br><span class="line"><span class="params">                 username: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>, password: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 enabled: <span class="built_in">bool</span> = <span class="literal">True</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;添加代理&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 验证代理URL格式</span></span><br><span class="line">            parsed = urlparse(proxy_url)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> parsed.scheme <span class="keyword">or</span> <span class="keyword">not</span> parsed.netloc:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            </span><br><span class="line">            proxy_config = &#123;</span><br><span class="line">                <span class="string">&#x27;url&#x27;</span>: proxy_url,</span><br><span class="line">                <span class="string">&#x27;type&#x27;</span>: proxy_type,</span><br><span class="line">                <span class="string">&#x27;username&#x27;</span>: username,</span><br><span class="line">                <span class="string">&#x27;password&#x27;</span>: password,</span><br><span class="line">                <span class="string">&#x27;enabled&#x27;</span>: enabled,</span><br><span class="line">                <span class="string">&#x27;success_count&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="string">&#x27;fail_count&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="string">&#x27;total_bytes&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="string">&#x27;last_used&#x27;</span>: <span class="literal">None</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            self.proxies[name] = proxy_config</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;添加代理失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">remove_proxy</span>(<span class="params">self, name: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;移除代理&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">in</span> self.proxies:</span><br><span class="line">            <span class="keyword">del</span> self.proxies[name]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 如果移除的是当前活跃代理，清除活跃代理设置</span></span><br><span class="line">            <span class="keyword">if</span> self.active_proxy == name:</span><br><span class="line">                self.active_proxy = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">enable_proxy</span>(<span class="params">self, name: <span class="built_in">str</span>, enabled: <span class="built_in">bool</span> = <span class="literal">True</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;启用/禁用代理&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">in</span> self.proxies:</span><br><span class="line">            self.proxies[name][<span class="string">&#x27;enabled&#x27;</span>] = enabled</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_active_proxy</span>(<span class="params">self, name: <span class="type">Optional</span>[<span class="built_in">str</span>]</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;设置活跃代理&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.active_proxy = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">in</span> self.proxies <span class="keyword">and</span> self.proxies[name][<span class="string">&#x27;enabled&#x27;</span>]:</span><br><span class="line">            self.active_proxy = name</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_active_proxy</span>(<span class="params">self</span>) -&gt; <span class="type">Optional</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取活跃代理配置&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.active_proxy <span class="keyword">and</span> self.active_proxy <span class="keyword">in</span> self.proxies:</span><br><span class="line">            <span class="keyword">return</span> self.proxies[self.active_proxy]</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_proxy_for_requests</span>(<span class="params">self</span>) -&gt; <span class="type">Optional</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取requests库可用的代理配置&quot;&quot;&quot;</span></span><br><span class="line">        proxy_config = self.get_active_proxy()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> proxy_config:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        proxy_url = proxy_config[<span class="string">&#x27;url&#x27;</span>]</span><br><span class="line">        proxy_type = proxy_config[<span class="string">&#x27;type&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 添加认证信息</span></span><br><span class="line">        <span class="keyword">if</span> proxy_config[<span class="string">&#x27;username&#x27;</span>] <span class="keyword">and</span> proxy_config[<span class="string">&#x27;password&#x27;</span>]:</span><br><span class="line">            parsed = urlparse(proxy_url)</span><br><span class="line">            auth = <span class="string">f&quot;<span class="subst">&#123;proxy_config[<span class="string">&#x27;username&#x27;</span>]&#125;</span>:<span class="subst">&#123;proxy_config[<span class="string">&#x27;password&#x27;</span>]&#125;</span>&quot;</span></span><br><span class="line">            proxy_url = <span class="string">f&quot;<span class="subst">&#123;parsed.scheme&#125;</span>://<span class="subst">&#123;auth&#125;</span>@<span class="subst">&#123;parsed.netloc&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 根据代理类型返回对应的配置</span></span><br><span class="line">        <span class="keyword">if</span> proxy_type == <span class="string">&#x27;http&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&#x27;http&#x27;</span>: proxy_url, <span class="string">&#x27;https&#x27;</span>: proxy_url&#125;</span><br><span class="line">        <span class="keyword">elif</span> proxy_type == <span class="string">&#x27;socks5&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&#x27;http&#x27;</span>: <span class="string">f&#x27;socks5://<span class="subst">&#123;proxy_url&#125;</span>&#x27;</span>, <span class="string">&#x27;https&#x27;</span>: <span class="string">f&#x27;socks5://<span class="subst">&#123;proxy_url&#125;</span>&#x27;</span>&#125;</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&#x27;http&#x27;</span>: proxy_url, <span class="string">&#x27;https&#x27;</span>: proxy_url&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_proxy</span>(<span class="params">self, name: <span class="built_in">str</span>, test_url: <span class="built_in">str</span> = <span class="string">&quot;https://httpbin.org/ip&quot;</span>, </span></span><br><span class="line"><span class="params">                  timeout: <span class="built_in">int</span> = <span class="number">10</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;测试代理连接&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">not</span> <span class="keyword">in</span> self.proxies:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&#x27;success&#x27;</span>: <span class="literal">False</span>, <span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;代理不存在&#x27;</span>&#125;</span><br><span class="line">        </span><br><span class="line">        proxy_config = self.proxies[name]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            proxies = self.get_proxy_for_requests()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> proxies:</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">&#x27;success&#x27;</span>: <span class="literal">False</span>, <span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;无法生成代理配置&#x27;</span>&#125;</span><br><span class="line">            </span><br><span class="line">            response = requests.get(test_url, proxies=proxies, timeout=timeout)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">                <span class="comment"># 更新统计信息</span></span><br><span class="line">                proxy_config[<span class="string">&#x27;success_count&#x27;</span>] += <span class="number">1</span></span><br><span class="line">                proxy_config[<span class="string">&#x27;last_used&#x27;</span>] = time.time()</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    <span class="string">&#x27;success&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">                    <span class="string">&#x27;response_time&#x27;</span>: response.elapsed.total_seconds(),</span><br><span class="line">                    <span class="string">&#x27;ip_info&#x27;</span>: response.json()</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                proxy_config[<span class="string">&#x27;fail_count&#x27;</span>] += <span class="number">1</span></span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    <span class="string">&#x27;success&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">                    <span class="string">&#x27;error&#x27;</span>: <span class="string">f&quot;HTTP <span class="subst">&#123;response.status_code&#125;</span>&quot;</span>,</span><br><span class="line">                    <span class="string">&#x27;response_time&#x27;</span>: response.elapsed.total_seconds()</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">except</span> requests.exceptions.Timeout:</span><br><span class="line">            proxy_config[<span class="string">&#x27;fail_count&#x27;</span>] += <span class="number">1</span></span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&#x27;success&#x27;</span>: <span class="literal">False</span>, <span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;连接超时&#x27;</span>&#125;</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            proxy_config[<span class="string">&#x27;fail_count&#x27;</span>] += <span class="number">1</span></span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&#x27;success&#x27;</span>: <span class="literal">False</span>, <span class="string">&#x27;error&#x27;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">auto_select_proxy</span>(<span class="params">self, test_url: <span class="built_in">str</span> = <span class="string">&quot;https://httpbin.org/ip&quot;</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;自动选择最佳代理&quot;&quot;&quot;</span></span><br><span class="line">        enabled_proxies = [(name, config) <span class="keyword">for</span> name, config <span class="keyword">in</span> self.proxies.items() </span><br><span class="line">                          <span class="keyword">if</span> config[<span class="string">&#x27;enabled&#x27;</span>]]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> enabled_proxies:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        best_proxy = <span class="literal">None</span></span><br><span class="line">        best_score = -<span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> name, config <span class="keyword">in</span> enabled_proxies:</span><br><span class="line">            <span class="comment"># 计算代理得分（基于成功率和响应时间）</span></span><br><span class="line">            total_attempts = config[<span class="string">&#x27;success_count&#x27;</span>] + config[<span class="string">&#x27;fail_count&#x27;</span>]</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> total_attempts == <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># 从未测试过的代理，给一个基础分</span></span><br><span class="line">                score = <span class="number">50</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                success_rate = config[<span class="string">&#x27;success_count&#x27;</span>] / total_attempts</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 测试当前响应时间</span></span><br><span class="line">                test_result = self.test_proxy(name, test_url)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> test_result[<span class="string">&#x27;success&#x27;</span>]:</span><br><span class="line">                    response_time = test_result.get(<span class="string">&#x27;response_time&#x27;</span>, <span class="number">1.0</span>)</span><br><span class="line">                    <span class="comment"># 响应时间越短，得分越高</span></span><br><span class="line">                    time_score = <span class="built_in">max</span>(<span class="number">0</span>, <span class="number">100</span> - (response_time * <span class="number">10</span>))</span><br><span class="line">                    score = (success_rate * <span class="number">70</span>) + (time_score * <span class="number">0.3</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    score = success_rate * <span class="number">50</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> score &gt; best_score:</span><br><span class="line">                best_score = score</span><br><span class="line">                best_proxy = name</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> best_proxy:</span><br><span class="line">            self.set_active_proxy(best_proxy)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> best_proxy</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_all_proxies</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取所有代理信息&quot;&quot;&quot;</span></span><br><span class="line">        result = []</span><br><span class="line">        <span class="keyword">for</span> name, config <span class="keyword">in</span> self.proxies.items():</span><br><span class="line">            proxy_info = config.copy()</span><br><span class="line">            proxy_info[<span class="string">&#x27;name&#x27;</span>] = name</span><br><span class="line">            proxy_info[<span class="string">&#x27;is_active&#x27;</span>] = (name == self.active_proxy)</span><br><span class="line">            result.append(proxy_info)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update_proxy_stats</span>(<span class="params">self, name: <span class="built_in">str</span>, bytes_transferred: <span class="built_in">int</span>, success: <span class="built_in">bool</span> = <span class="literal">True</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;更新代理统计信息&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">in</span> self.proxies:</span><br><span class="line">            <span class="keyword">if</span> success:</span><br><span class="line">                self.proxies[name][<span class="string">&#x27;success_count&#x27;</span>] += <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.proxies[name][<span class="string">&#x27;fail_count&#x27;</span>] += <span class="number">1</span></span><br><span class="line">            </span><br><span class="line">            self.proxies[name][<span class="string">&#x27;total_bytes&#x27;</span>] += bytes_transferred</span><br><span class="line">            self.proxies[name][<span class="string">&#x27;last_used&#x27;</span>] = time.time()</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># core/batch_processor.py</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span>, <span class="type">Optional</span>, Generator</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BatchProcessor</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;批量下载处理器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.supported_formats = [<span class="string">&#x27;txt&#x27;</span>, <span class="string">&#x27;json&#x27;</span>, <span class="string">&#x27;csv&#x27;</span>, <span class="string">&#x27;yaml&#x27;</span>, <span class="string">&#x27;yml&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse_batch_file</span>(<span class="params">self, file_path: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;解析批量下载文件&quot;&quot;&quot;</span></span><br><span class="line">        file_ext = Path(file_path).suffix.lower()[<span class="number">1</span>:]  <span class="comment"># 去除点号</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> file_ext <span class="keyword">not</span> <span class="keyword">in</span> self.supported_formats:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;不支持的文件格式: <span class="subst">&#123;file_ext&#125;</span>。支持: <span class="subst">&#123;<span class="string">&#x27;, &#x27;</span>.join(self.supported_formats)&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(file_path):</span><br><span class="line">            <span class="keyword">raise</span> FileNotFoundError(<span class="string">f&quot;文件不存在: <span class="subst">&#123;file_path&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> file_ext == <span class="string">&#x27;txt&#x27;</span>:</span><br><span class="line">                <span class="keyword">return</span> self._parse_txt_file(file_path)</span><br><span class="line">            <span class="keyword">elif</span> file_ext == <span class="string">&#x27;json&#x27;</span>:</span><br><span class="line">                <span class="keyword">return</span> self._parse_json_file(file_path)</span><br><span class="line">            <span class="keyword">elif</span> file_ext == <span class="string">&#x27;csv&#x27;</span>:</span><br><span class="line">                <span class="keyword">return</span> self._parse_csv_file(file_path)</span><br><span class="line">            <span class="keyword">elif</span> file_ext <span class="keyword">in</span> [<span class="string">&#x27;yaml&#x27;</span>, <span class="string">&#x27;yml&#x27;</span>]:</span><br><span class="line">                <span class="keyword">return</span> self._parse_yaml_file(file_path)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;解析文件失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_parse_txt_file</span>(<span class="params">self, file_path: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;解析纯文本文件（每行一个URL）&quot;&quot;&quot;</span></span><br><span class="line">        items = []</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">for</span> line_num, line <span class="keyword">in</span> <span class="built_in">enumerate</span>(f, <span class="number">1</span>):</span><br><span class="line">                line = line.strip()</span><br><span class="line">                <span class="keyword">if</span> line <span class="keyword">and</span> <span class="keyword">not</span> line.startswith(<span class="string">&#x27;#&#x27;</span>):  <span class="comment"># 跳过空行和注释</span></span><br><span class="line">                    items.append(&#123;</span><br><span class="line">                        <span class="string">&#x27;url&#x27;</span>: line,</span><br><span class="line">                        <span class="string">&#x27;line_number&#x27;</span>: line_num,</span><br><span class="line">                        <span class="string">&#x27;save_path&#x27;</span>: <span class="literal">None</span>  <span class="comment"># 自动生成文件名</span></span><br><span class="line">                    &#125;)</span><br><span class="line">        <span class="keyword">return</span> items</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_parse_json_file</span>(<span class="params">self, file_path: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;解析JSON文件&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            data = json.load(f)</span><br><span class="line">        </span><br><span class="line">        items = []</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, <span class="built_in">list</span>):</span><br><span class="line">            <span class="keyword">for</span> i, item <span class="keyword">in</span> <span class="built_in">enumerate</span>(data):</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">isinstance</span>(item, <span class="built_in">str</span>):</span><br><span class="line">                    <span class="comment"># 如果是字符串列表，直接作为URL</span></span><br><span class="line">                    items.append(&#123;</span><br><span class="line">                        <span class="string">&#x27;url&#x27;</span>: item,</span><br><span class="line">                        <span class="string">&#x27;index&#x27;</span>: i,</span><br><span class="line">                        <span class="string">&#x27;save_path&#x27;</span>: <span class="literal">None</span></span><br><span class="line">                    &#125;)</span><br><span class="line">                <span class="keyword">elif</span> <span class="built_in">isinstance</span>(item, <span class="built_in">dict</span>) <span class="keyword">and</span> <span class="string">&#x27;url&#x27;</span> <span class="keyword">in</span> item:</span><br><span class="line">                    <span class="comment"># 如果是字典，提取URL和其他信息</span></span><br><span class="line">                    download_item = &#123;<span class="string">&#x27;index&#x27;</span>: i, <span class="string">&#x27;save_path&#x27;</span>: <span class="literal">None</span>&#125;</span><br><span class="line">                    download_item.update(item)</span><br><span class="line">                    items.append(download_item)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(data, <span class="built_in">dict</span>):</span><br><span class="line">            <span class="comment"># 如果是字典，查找包含下载列表的键</span></span><br><span class="line">            <span class="keyword">for</span> key, value <span class="keyword">in</span> data.items():</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">isinstance</span>(value, <span class="built_in">list</span>):</span><br><span class="line">                    <span class="keyword">for</span> i, item <span class="keyword">in</span> <span class="built_in">enumerate</span>(value):</span><br><span class="line">                        <span class="keyword">if</span> <span class="built_in">isinstance</span>(item, <span class="built_in">str</span>):</span><br><span class="line">                            items.append(&#123;</span><br><span class="line">                                <span class="string">&#x27;url&#x27;</span>: item,</span><br><span class="line">                                <span class="string">&#x27;category&#x27;</span>: key,</span><br><span class="line">                                <span class="string">&#x27;index&#x27;</span>: i,</span><br><span class="line">                                <span class="string">&#x27;save_path&#x27;</span>: <span class="literal">None</span></span><br><span class="line">                            &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> items</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_parse_csv_file</span>(<span class="params">self, file_path: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;解析CSV文件&quot;&quot;&quot;</span></span><br><span class="line">        items = []</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            reader = csv.DictReader(f)</span><br><span class="line">            <span class="keyword">for</span> row_num, row <span class="keyword">in</span> <span class="built_in">enumerate</span>(reader, <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;url&#x27;</span> <span class="keyword">in</span> row <span class="keyword">and</span> row[<span class="string">&#x27;url&#x27;</span>]:</span><br><span class="line">                    item = &#123;</span><br><span class="line">                        <span class="string">&#x27;url&#x27;</span>: row[<span class="string">&#x27;url&#x27;</span>],</span><br><span class="line">                        <span class="string">&#x27;row_number&#x27;</span>: row_num,</span><br><span class="line">                        <span class="string">&#x27;save_path&#x27;</span>: <span class="literal">None</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment"># 添加其他列作为元数据</span></span><br><span class="line">                    <span class="keyword">for</span> key, value <span class="keyword">in</span> row.items():</span><br><span class="line">                        <span class="keyword">if</span> key != <span class="string">&#x27;url&#x27;</span> <span class="keyword">and</span> value:</span><br><span class="line">                            item[key] = value</span><br><span class="line">                    items.append(item)</span><br><span class="line">        <span class="keyword">return</span> items</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_parse_yaml_file</span>(<span class="params">self, file_path: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;解析YAML文件&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            data = yaml.safe_load(f)</span><br><span class="line">        </span><br><span class="line">        items = []</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, <span class="built_in">list</span>):</span><br><span class="line">            <span class="keyword">for</span> i, item <span class="keyword">in</span> <span class="built_in">enumerate</span>(data):</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">isinstance</span>(item, <span class="built_in">str</span>):</span><br><span class="line">                    items.append(&#123;</span><br><span class="line">                        <span class="string">&#x27;url&#x27;</span>: item,</span><br><span class="line">                        <span class="string">&#x27;index&#x27;</span>: i,</span><br><span class="line">                        <span class="string">&#x27;save_path&#x27;</span>: <span class="literal">None</span></span><br><span class="line">                    &#125;)</span><br><span class="line">                <span class="keyword">elif</span> <span class="built_in">isinstance</span>(item, <span class="built_in">dict</span>):</span><br><span class="line">                    <span class="keyword">if</span> <span class="string">&#x27;url&#x27;</span> <span class="keyword">in</span> item:</span><br><span class="line">                        download_item = &#123;<span class="string">&#x27;index&#x27;</span>: i, <span class="string">&#x27;save_path&#x27;</span>: <span class="literal">None</span>&#125;</span><br><span class="line">                        download_item.update(item)</span><br><span class="line">                        items.append(download_item)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(data, <span class="built_in">dict</span>):</span><br><span class="line">            <span class="comment"># 处理嵌套结构</span></span><br><span class="line">            self._extract_urls_from_dict(data, items)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> items</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_extract_urls_from_dict</span>(<span class="params">self, data: <span class="type">Dict</span>, items: <span class="type">List</span>[<span class="type">Dict</span>], parent_key: <span class="built_in">str</span> = <span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;从字典中递归提取URL&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> data.items():</span><br><span class="line">            current_key = <span class="string">f&quot;<span class="subst">&#123;parent_key&#125;</span>.<span class="subst">&#123;key&#125;</span>&quot;</span> <span class="keyword">if</span> parent_key <span class="keyword">else</span> key</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(value, <span class="built_in">str</span>):</span><br><span class="line">                <span class="comment"># 检查是否是URL</span></span><br><span class="line">                <span class="keyword">if</span> value.startswith((<span class="string">&#x27;http://&#x27;</span>, <span class="string">&#x27;https://&#x27;</span>, <span class="string">&#x27;ftp://&#x27;</span>)):</span><br><span class="line">                    items.append(&#123;</span><br><span class="line">                        <span class="string">&#x27;url&#x27;</span>: value,</span><br><span class="line">                        <span class="string">&#x27;key&#x27;</span>: current_key,</span><br><span class="line">                        <span class="string">&#x27;save_path&#x27;</span>: <span class="literal">None</span></span><br><span class="line">                    &#125;)</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(value, <span class="built_in">list</span>):</span><br><span class="line">                <span class="keyword">for</span> i, item <span class="keyword">in</span> <span class="built_in">enumerate</span>(value):</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">isinstance</span>(item, <span class="built_in">str</span>) <span class="keyword">and</span> item.startswith((<span class="string">&#x27;http://&#x27;</span>, <span class="string">&#x27;https://&#x27;</span>, <span class="string">&#x27;ftp://&#x27;</span>)):</span><br><span class="line">                        items.append(&#123;</span><br><span class="line">                            <span class="string">&#x27;url&#x27;</span>: item,</span><br><span class="line">                            <span class="string">&#x27;key&#x27;</span>: <span class="string">f&quot;<span class="subst">&#123;current_key&#125;</span>[<span class="subst">&#123;i&#125;</span>]&quot;</span>,</span><br><span class="line">                            <span class="string">&#x27;save_path&#x27;</span>: <span class="literal">None</span></span><br><span class="line">                        &#125;)</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(value, <span class="built_in">dict</span>):</span><br><span class="line">                self._extract_urls_from_dict(value, items, current_key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_batch_template</span>(<span class="params">self, format_type: <span class="built_in">str</span> = <span class="string">&#x27;json&#x27;</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;生成批量下载模板&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> format_type == <span class="string">&#x27;txt&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;&quot;# 批量下载URL列表</span></span><br><span class="line"><span class="string"># 每行一个URL，空行和以#开头的行会被忽略</span></span><br><span class="line"><span class="string">https://example.com/file1.zip</span></span><br><span class="line"><span class="string">https://example.com/file2.jpg</span></span><br><span class="line"><span class="string">https://example.com/file3.pdf</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> format_type == <span class="string">&#x27;json&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> json.dumps([</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://example.com/file1.zip&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;save_path&quot;</span>: <span class="string">&quot;downloads/file1.zip&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;priority&quot;</span>: <span class="number">2</span>,</span><br><span class="line">                    <span class="string">&quot;category&quot;</span>: <span class="string">&quot;documents&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://example.com/file2.jpg&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;save_path&quot;</span>: <span class="string">&quot;images/file2.jpg&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;priority&quot;</span>: <span class="number">1</span></span><br><span class="line">                &#125;</span><br><span class="line">            ], indent=<span class="number">2</span>)</span><br><span class="line">        <span class="keyword">elif</span> format_type == <span class="string">&#x27;csv&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;&quot;url,save_path,priority,category</span></span><br><span class="line"><span class="string">https://example.com/file1.zip,downloads/file1.zip,2,documents</span></span><br><span class="line"><span class="string">https://example.com/file2.jpg,images/file2.jpg,1,images</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> format_type <span class="keyword">in</span> [<span class="string">&#x27;yaml&#x27;</span>, <span class="string">&#x27;yml&#x27;</span>]:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;&quot;- url: https://example.com/file1.zip</span></span><br><span class="line"><span class="string">  save_path: downloads/file1.zip</span></span><br><span class="line"><span class="string">  priority: 2</span></span><br><span class="line"><span class="string">  category: documents</span></span><br><span class="line"><span class="string">- url: https://example.com/file2.jpg</span></span><br><span class="line"><span class="string">  save_path: images/file2.jpg</span></span><br><span class="line"><span class="string">  priority: 1</span></span><br><span class="line"><span class="string">  category: images</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;不支持的文件格式: <span class="subst">&#123;format_type&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">validate_urls</span>(<span class="params">self, items: <span class="type">List</span>[<span class="type">Dict</span>]</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;验证URL列表&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">import</span> re</span><br><span class="line">        </span><br><span class="line">        results = &#123;</span><br><span class="line">            <span class="string">&#x27;valid&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;invalid&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;duplicates&#x27;</span>: []</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        url_pattern = re.<span class="built_in">compile</span>(</span><br><span class="line">            <span class="string">r&#x27;^(?:http|ftp)s?://&#x27;</span>  <span class="comment"># http:// or https:// or ftp://</span></span><br><span class="line">            <span class="string">r&#x27;(?:(?:[A-Z0-9](?:[A-Z0-9-]&#123;0,61&#125;[A-Z0-9])?\.)+(?:[A-Z]&#123;2,6&#125;\.?|[A-Z0-9-]&#123;2,&#125;\.?)|&#x27;</span></span><br><span class="line">            <span class="string">r&#x27;localhost|&#x27;</span></span><br><span class="line">            <span class="string">r&#x27;\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;)&#x27;</span></span><br><span class="line">            <span class="string">r&#x27;(?::\d+)?&#x27;</span></span><br><span class="line">            <span class="string">r&#x27;(?:/?|[/?]\S+)$&#x27;</span>, re.IGNORECASE)</span><br><span class="line">        </span><br><span class="line">        seen_urls = <span class="built_in">set</span>()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">            url = item.get(<span class="string">&#x27;url&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 检查URL格式</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> url_pattern.<span class="keyword">match</span>(url):</span><br><span class="line">                results[<span class="string">&#x27;invalid&#x27;</span>].append(&#123;</span><br><span class="line">                    <span class="string">&#x27;item&#x27;</span>: item,</span><br><span class="line">                    <span class="string">&#x27;reason&#x27;</span>: <span class="string">&#x27;无效的URL格式&#x27;</span></span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 检查重复URL</span></span><br><span class="line">            <span class="keyword">if</span> url <span class="keyword">in</span> seen_urls:</span><br><span class="line">                results[<span class="string">&#x27;duplicates&#x27;</span>].append(&#123;</span><br><span class="line">                    <span class="string">&#x27;item&#x27;</span>: item,</span><br><span class="line">                    <span class="string">&#x27;reason&#x27;</span>: <span class="string">&#x27;重复的URL&#x27;</span></span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            seen_urls.add(url)</span><br><span class="line">            results[<span class="string">&#x27;valid&#x27;</span>].append(item)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># core/file_checker.py</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> magic</span><br><span class="line"><span class="keyword">import</span> imghdr</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Dict</span>, <span class="type">List</span></span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileChecker</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;文件校验器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.supported_hashes = [<span class="string">&#x27;md5&#x27;</span>, <span class="string">&#x27;sha1&#x27;</span>, <span class="string">&#x27;sha256&#x27;</span>, <span class="string">&#x27;sha512&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">calculate_hash</span>(<span class="params">self, file_path: <span class="built_in">str</span>, algorithm: <span class="built_in">str</span> = <span class="string">&#x27;sha256&#x27;</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算文件哈希值&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> algorithm <span class="keyword">not</span> <span class="keyword">in</span> self.supported_hashes:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;不支持的哈希算法: <span class="subst">&#123;algorithm&#125;</span>。支持: <span class="subst">&#123;<span class="string">&#x27;, &#x27;</span>.join(self.supported_hashes)&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(file_path):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        hash_func = <span class="built_in">getattr</span>(hashlib, algorithm)()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                <span class="comment"># 分块读取大文件，避免内存不足</span></span><br><span class="line">                <span class="keyword">for</span> chunk <span class="keyword">in</span> <span class="built_in">iter</span>(<span class="keyword">lambda</span>: f.read(<span class="number">4096</span>), <span class="string">b&quot;&quot;</span>):</span><br><span class="line">                    hash_func.update(chunk)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> hash_func.hexdigest()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;计算哈希值失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">verify_hash</span>(<span class="params">self, file_path: <span class="built_in">str</span>, expected_hash: <span class="built_in">str</span>, algorithm: <span class="built_in">str</span> = <span class="string">&#x27;sha256&#x27;</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;验证文件哈希值&quot;&quot;&quot;</span></span><br><span class="line">        actual_hash = self.calculate_hash(file_path, algorithm)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> actual_hash:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> actual_hash.lower() == expected_hash.lower()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_file_info</span>(<span class="params">self, file_path: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取文件信息&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(file_path):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            stat_info = os.stat(file_path)</span><br><span class="line">            </span><br><span class="line">            file_info = &#123;</span><br><span class="line">                <span class="string">&#x27;path&#x27;</span>: file_path,</span><br><span class="line">                <span class="string">&#x27;filename&#x27;</span>: os.path.basename(file_path),</span><br><span class="line">                <span class="string">&#x27;size&#x27;</span>: stat_info.st_size,</span><br><span class="line">                <span class="string">&#x27;created&#x27;</span>: stat_info.st_ctime,</span><br><span class="line">                <span class="string">&#x27;modified&#x27;</span>: stat_info.st_mtime,</span><br><span class="line">                <span class="string">&#x27;accessed&#x27;</span>: stat_info.st_atime,</span><br><span class="line">                <span class="string">&#x27;extension&#x27;</span>: Path(file_path).suffix.lower(),</span><br><span class="line">                <span class="string">&#x27;hashes&#x27;</span>: &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 计算各种哈希值</span></span><br><span class="line">            <span class="keyword">for</span> algo <span class="keyword">in</span> self.supported_hashes:</span><br><span class="line">                file_info[<span class="string">&#x27;hashes&#x27;</span>][algo] = self.calculate_hash(file_path, algo)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 检测文件类型</span></span><br><span class="line">            file_info[<span class="string">&#x27;mime_type&#x27;</span>] = self.detect_mime_type(file_path)</span><br><span class="line">            file_info[<span class="string">&#x27;file_type&#x27;</span>] = self.detect_file_type(file_path)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> file_info</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;获取文件信息失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">detect_mime_type</span>(<span class="params">self, file_path: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检测文件MIME类型&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 尝试使用python-magic库</span></span><br><span class="line">            <span class="keyword">import</span> magic</span><br><span class="line">            mime = magic.Magic(mime=<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">return</span> mime.from_file(file_path)</span><br><span class="line">        <span class="keyword">except</span> ImportError:</span><br><span class="line">            <span class="comment"># 如果python-magic不可用，使用备用方法</span></span><br><span class="line">            <span class="keyword">return</span> self._guess_mime_type(file_path)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_guess_mime_type</span>(<span class="params">self, file_path: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;猜测文件MIME类型（备用方法）&quot;&quot;&quot;</span></span><br><span class="line">        ext = Path(file_path).suffix.lower()</span><br><span class="line">        </span><br><span class="line">        mime_types = &#123;</span><br><span class="line">            <span class="string">&#x27;.txt&#x27;</span>: <span class="string">&#x27;text/plain&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.html&#x27;</span>: <span class="string">&#x27;text/html&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.htm&#x27;</span>: <span class="string">&#x27;text/html&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.css&#x27;</span>: <span class="string">&#x27;text/css&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.js&#x27;</span>: <span class="string">&#x27;application/javascript&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.json&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.xml&#x27;</span>: <span class="string">&#x27;application/xml&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.pdf&#x27;</span>: <span class="string">&#x27;application/pdf&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.zip&#x27;</span>: <span class="string">&#x27;application/zip&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.rar&#x27;</span>: <span class="string">&#x27;application/x-rar-compressed&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.7z&#x27;</span>: <span class="string">&#x27;application/x-7z-compressed&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.tar&#x27;</span>: <span class="string">&#x27;application/x-tar&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.gz&#x27;</span>: <span class="string">&#x27;application/gzip&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.bz2&#x27;</span>: <span class="string">&#x27;application/x-bzip2&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.jpg&#x27;</span>: <span class="string">&#x27;image/jpeg&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.jpeg&#x27;</span>: <span class="string">&#x27;image/jpeg&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.png&#x27;</span>: <span class="string">&#x27;image/png&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.gif&#x27;</span>: <span class="string">&#x27;image/gif&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.bmp&#x27;</span>: <span class="string">&#x27;image/bmp&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.webp&#x27;</span>: <span class="string">&#x27;image/webp&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.svg&#x27;</span>: <span class="string">&#x27;image/svg+xml&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.mp3&#x27;</span>: <span class="string">&#x27;audio/mpeg&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.wav&#x27;</span>: <span class="string">&#x27;audio/wav&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.ogg&#x27;</span>: <span class="string">&#x27;audio/ogg&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.mp4&#x27;</span>: <span class="string">&#x27;video/mp4&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.avi&#x27;</span>: <span class="string">&#x27;video/x-msvideo&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.mkv&#x27;</span>: <span class="string">&#x27;video/x-matroska&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.mov&#x27;</span>: <span class="string">&#x27;video/quicktime&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.flv&#x27;</span>: <span class="string">&#x27;video/x-flv&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.exe&#x27;</span>: <span class="string">&#x27;application/x-msdownload&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.msi&#x27;</span>: <span class="string">&#x27;application/x-msdownload&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;.dmg&#x27;</span>: <span class="string">&#x27;application/x-apple-diskimage&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> mime_types.get(ext, <span class="string">&#x27;application/octet-stream&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">detect_file_type</span>(<span class="params">self, file_path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检测文件类型&quot;&quot;&quot;</span></span><br><span class="line">        mime_type = self.detect_mime_type(file_path)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> mime_type:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;unknown&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 基于MIME类型分类</span></span><br><span class="line">        <span class="keyword">if</span> mime_type.startswith(<span class="string">&#x27;text/&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;text&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> mime_type.startswith(<span class="string">&#x27;image/&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;image&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> mime_type.startswith(<span class="string">&#x27;audio/&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;audio&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> mime_type.startswith(<span class="string">&#x27;video/&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;video&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> mime_type.startswith(<span class="string">&#x27;application/&#x27;</span>):</span><br><span class="line">            <span class="comment"># 进一步分类应用文件</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;pdf&#x27;</span> <span class="keyword">in</span> mime_type:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;document&#x27;</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&#x27;zip&#x27;</span> <span class="keyword">in</span> mime_type <span class="keyword">or</span> <span class="string">&#x27;rar&#x27;</span> <span class="keyword">in</span> mime_type <span class="keyword">or</span> <span class="string">&#x27;tar&#x27;</span> <span class="keyword">in</span> mime_type <span class="keyword">or</span> <span class="string">&#x27;7z&#x27;</span> <span class="keyword">in</span> mime_type:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;archive&#x27;</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&#x27;msword&#x27;</span> <span class="keyword">in</span> mime_type <span class="keyword">or</span> <span class="string">&#x27;openxml&#x27;</span> <span class="keyword">in</span> mime_type:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;document&#x27;</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&#x27;excel&#x27;</span> <span class="keyword">in</span> mime_type:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;spreadsheet&#x27;</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&#x27;powerpoint&#x27;</span> <span class="keyword">in</span> mime_type:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;presentation&#x27;</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&#x27;javascript&#x27;</span> <span class="keyword">in</span> mime_type:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;code&#x27;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;application&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;other&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">validate_download</span>(<span class="params">self, file_path: <span class="built_in">str</span>, expected_size: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                         expected_hash: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>, </span></span><br><span class="line"><span class="params">                         hash_algorithm: <span class="built_in">str</span> = <span class="string">&#x27;sha256&#x27;</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;验证下载的文件&quot;&quot;&quot;</span></span><br><span class="line">        result = &#123;</span><br><span class="line">            <span class="string">&#x27;exists&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&#x27;size_matches&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&#x27;hash_matches&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&#x27;is_valid&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&#x27;errors&#x27;</span>: []</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查文件是否存在</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(file_path):</span><br><span class="line">            result[<span class="string">&#x27;errors&#x27;</span>].append(<span class="string">&#x27;文件不存在&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        </span><br><span class="line">        result[<span class="string">&#x27;exists&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查文件大小</span></span><br><span class="line">        actual_size = os.path.getsize(file_path)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> expected_size <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            result[<span class="string">&#x27;size_matches&#x27;</span>] = (actual_size == expected_size)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> result[<span class="string">&#x27;size_matches&#x27;</span>]:</span><br><span class="line">                result[<span class="string">&#x27;errors&#x27;</span>].append(<span class="string">f&#x27;文件大小不匹配: 期望 <span class="subst">&#123;expected_size&#125;</span>, 实际 <span class="subst">&#123;actual_size&#125;</span>&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查哈希值</span></span><br><span class="line">        <span class="keyword">if</span> expected_hash <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            actual_hash = self.calculate_hash(file_path, hash_algorithm)</span><br><span class="line">            <span class="keyword">if</span> actual_hash:</span><br><span class="line">                result[<span class="string">&#x27;hash_matches&#x27;</span>] = (actual_hash.lower() == expected_hash.lower())</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> result[<span class="string">&#x27;hash_matches&#x27;</span>]:</span><br><span class="line">                    result[<span class="string">&#x27;errors&#x27;</span>].append(<span class="string">f&#x27;哈希值不匹配: 期望 <span class="subst">&#123;expected_hash&#125;</span>, 实际 <span class="subst">&#123;actual_hash&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                result[<span class="string">&#x27;errors&#x27;</span>].append(<span class="string">&#x27;无法计算文件哈希值&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 确定文件是否有效</span></span><br><span class="line">        <span class="keyword">if</span> expected_size <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> expected_hash <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># 如果没有验证条件，只要有文件就认为是有效的</span></span><br><span class="line">            result[<span class="string">&#x27;is_valid&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 检查所有验证条件</span></span><br><span class="line">            size_ok = (expected_size <span class="keyword">is</span> <span class="literal">None</span>) <span class="keyword">or</span> result[<span class="string">&#x27;size_matches&#x27;</span>]</span><br><span class="line">            hash_ok = (expected_hash <span class="keyword">is</span> <span class="literal">None</span>) <span class="keyword">or</span> result[<span class="string">&#x27;hash_matches&#x27;</span>]</span><br><span class="line">            result[<span class="string">&#x27;is_valid&#x27;</span>] = size_ok <span class="keyword">and</span> hash_ok</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_duplicate_files</span>(<span class="params">self, directory: <span class="built_in">str</span>, algorithm: <span class="built_in">str</span> = <span class="string">&#x27;md5&#x27;</span></span>) -&gt; <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">str</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;查找目录中的重复文件&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> algorithm <span class="keyword">not</span> <span class="keyword">in</span> self.supported_hashes:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;不支持的哈希算法: <span class="subst">&#123;algorithm&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        hash_dict = &#123;&#125;</span><br><span class="line">        duplicates = []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 遍历目录中的所有文件</span></span><br><span class="line">        <span class="keyword">for</span> root, _, files <span class="keyword">in</span> os.walk(directory):</span><br><span class="line">            <span class="keyword">for</span> filename <span class="keyword">in</span> files:</span><br><span class="line">                file_path = os.path.join(root, filename)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 计算文件哈希值</span></span><br><span class="line">                file_hash = self.calculate_hash(file_path, algorithm)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> file_hash:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 按哈希值分组</span></span><br><span class="line">                <span class="keyword">if</span> file_hash <span class="keyword">in</span> hash_dict:</span><br><span class="line">                    hash_dict[file_hash].append(file_path)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    hash_dict[file_hash] = [file_path]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 找出有重复的组</span></span><br><span class="line">        <span class="keyword">for</span> file_hash, file_paths <span class="keyword">in</span> hash_dict.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(file_paths) &gt; <span class="number">1</span>:</span><br><span class="line">                duplicates.append(file_paths)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> duplicates</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># core/scheduler.py</span></span><br><span class="line"><span class="keyword">import</span> schedule</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Optional</span>, <span class="type">Callable</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DownloadScheduler</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;下载计划任务管理器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.scheduled_tasks: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Dict</span>] = &#123;&#125;</span><br><span class="line">        self.scheduler_thread: <span class="type">Optional</span>[threading.Thread] = <span class="literal">None</span></span><br><span class="line">        self.running = <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_scheduled_task</span>(<span class="params">self, name: <span class="built_in">str</span>, url: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                          schedule_type: <span class="built_in">str</span> = <span class="string">&#x27;once&#x27;</span>,</span></span><br><span class="line"><span class="params">                          schedule_time: <span class="type">Optional</span>[datetime] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                          interval: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                          interval_unit: <span class="built_in">str</span> = <span class="string">&#x27;hours&#x27;</span>,</span></span><br><span class="line"><span class="params">                          save_path: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                          enabled: <span class="built_in">bool</span> = <span class="literal">True</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;添加计划任务&quot;&quot;&quot;</span></span><br><span class="line">        task_id = <span class="string">f&quot;task_<span class="subst">&#123;<span class="built_in">int</span>(time.time())&#125;</span>_<span class="subst">&#123;name&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        task = &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: task_id,</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: name,</span><br><span class="line">            <span class="string">&#x27;url&#x27;</span>: url,</span><br><span class="line">            <span class="string">&#x27;save_path&#x27;</span>: save_path,</span><br><span class="line">            <span class="string">&#x27;schedule_type&#x27;</span>: schedule_type,</span><br><span class="line">            <span class="string">&#x27;schedule_time&#x27;</span>: schedule_time.isoformat() <span class="keyword">if</span> schedule_time <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&#x27;interval&#x27;</span>: interval,</span><br><span class="line">            <span class="string">&#x27;interval_unit&#x27;</span>: interval_unit,</span><br><span class="line">            <span class="string">&#x27;enabled&#x27;</span>: enabled,</span><br><span class="line">            <span class="string">&#x27;last_run&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&#x27;next_run&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&#x27;run_count&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;created&#x27;</span>: datetime.now().isoformat()</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算下一次运行时间</span></span><br><span class="line">        self._calculate_next_run(task)</span><br><span class="line">        </span><br><span class="line">        self.scheduled_tasks[task_id] = task</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果调度器正在运行，重新加载任务</span></span><br><span class="line">        <span class="keyword">if</span> self.running:</span><br><span class="line">            self._schedule_task(task)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> task_id</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_calculate_next_run</span>(<span class="params">self, task: <span class="type">Dict</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算下一次运行时间&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> task[<span class="string">&#x27;enabled&#x27;</span>]:</span><br><span class="line">            task[<span class="string">&#x27;next_run&#x27;</span>] = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        schedule_type = task[<span class="string">&#x27;schedule_type&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> schedule_type == <span class="string">&#x27;once&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> task[<span class="string">&#x27;schedule_time&#x27;</span>]:</span><br><span class="line">                schedule_time = datetime.fromisoformat(task[<span class="string">&#x27;schedule_time&#x27;</span>])</span><br><span class="line">                <span class="keyword">if</span> schedule_time &gt; datetime.now():</span><br><span class="line">                    task[<span class="string">&#x27;next_run&#x27;</span>] = schedule_time.isoformat()</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    task[<span class="string">&#x27;next_run&#x27;</span>] = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                task[<span class="string">&#x27;next_run&#x27;</span>] = <span class="literal">None</span></span><br><span class="line">                </span><br><span class="line">        <span class="keyword">elif</span> schedule_type == <span class="string">&#x27;interval&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> task[<span class="string">&#x27;interval&#x27;</span>] <span class="keyword">and</span> task[<span class="string">&#x27;interval_unit&#x27;</span>]:</span><br><span class="line">                now = datetime.now()</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> task[<span class="string">&#x27;last_run&#x27;</span>]:</span><br><span class="line">                    last_run = datetime.fromisoformat(task[<span class="string">&#x27;last_run&#x27;</span>])</span><br><span class="line">                    delta = self._get_interval_delta(task[<span class="string">&#x27;interval&#x27;</span>], task[<span class="string">&#x27;interval_unit&#x27;</span>])</span><br><span class="line">                    next_run = last_run + delta</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    delta = self._get_interval_delta(task[<span class="string">&#x27;interval&#x27;</span>], task[<span class="string">&#x27;interval_unit&#x27;</span>])</span><br><span class="line">                    next_run = now + delta</span><br><span class="line">                </span><br><span class="line">                task[<span class="string">&#x27;next_run&#x27;</span>] = next_run.isoformat()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">elif</span> schedule_type == <span class="string">&#x27;daily&#x27;</span>:</span><br><span class="line">            <span class="comment"># 每天的特定时间运行</span></span><br><span class="line">            <span class="keyword">if</span> task[<span class="string">&#x27;schedule_time&#x27;</span>]:</span><br><span class="line">                schedule_time = datetime.fromisoformat(task[<span class="string">&#x27;schedule_time&#x27;</span>])</span><br><span class="line">                now = datetime.now()</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 设置今天的运行时间</span></span><br><span class="line">                today_run = now.replace(</span><br><span class="line">                    hour=schedule_time.hour,</span><br><span class="line">                    minute=schedule_time.minute,</span><br><span class="line">                    second=schedule_time.second,</span><br><span class="line">                    microsecond=<span class="number">0</span></span><br><span class="line">                )</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 如果今天的时间已经过去，设置为明天</span></span><br><span class="line">                <span class="keyword">if</span> today_run &lt; now:</span><br><span class="line">                    today_run += timedelta(days=<span class="number">1</span>)</span><br><span class="line">                </span><br><span class="line">                task[<span class="string">&#x27;next_run&#x27;</span>] = today_run.isoformat()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">elif</span> schedule_type == <span class="string">&#x27;weekly&#x27;</span>:</span><br><span class="line">            <span class="comment"># 每周的特定时间运行</span></span><br><span class="line">            <span class="keyword">if</span> task[<span class="string">&#x27;schedule_time&#x27;</span>]:</span><br><span class="line">                schedule_time = datetime.fromisoformat(task[<span class="string">&#x27;schedule_time&#x27;</span>])</span><br><span class="line">                now = datetime.now()</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 计算下一次运行（假设schedule_time包含星期信息）</span></span><br><span class="line">                <span class="comment"># 这里简化处理，实际需要更复杂的逻辑</span></span><br><span class="line">                task[<span class="string">&#x27;next_run&#x27;</span>] = (now + timedelta(days=<span class="number">7</span>)).isoformat()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_interval_delta</span>(<span class="params">self, interval: <span class="built_in">int</span>, unit: <span class="built_in">str</span></span>) -&gt; timedelta:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取时间间隔的timedelta&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> unit == <span class="string">&#x27;seconds&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> timedelta(seconds=interval)</span><br><span class="line">        <span class="keyword">elif</span> unit == <span class="string">&#x27;minutes&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> timedelta(minutes=interval)</span><br><span class="line">        <span class="keyword">elif</span> unit == <span class="string">&#x27;hours&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> timedelta(hours=interval)</span><br><span class="line">        <span class="keyword">elif</span> unit == <span class="string">&#x27;days&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> timedelta(days=interval)</span><br><span class="line">        <span class="keyword">elif</span> unit == <span class="string">&#x27;weeks&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> timedelta(weeks=interval)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> timedelta(hours=interval)  <span class="comment"># 默认小时</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_schedule_task</span>(<span class="params">self, task: <span class="type">Dict</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;安排任务执行&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> task[<span class="string">&#x27;enabled&#x27;</span>] <span class="keyword">or</span> <span class="keyword">not</span> task[<span class="string">&#x27;next_run&#x27;</span>]:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        schedule_type = task[<span class="string">&#x27;schedule_type&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> schedule_type == <span class="string">&#x27;once&#x27;</span>:</span><br><span class="line">            <span class="comment"># 一次性任务</span></span><br><span class="line">            schedule_time = datetime.fromisoformat(task[<span class="string">&#x27;schedule_time&#x27;</span>])</span><br><span class="line">            delay = (schedule_time - datetime.now()).total_seconds()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> delay &gt; <span class="number">0</span>:</span><br><span class="line">                schedule.every(delay).seconds.do(</span><br><span class="line">                    self._execute_task, task[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">                ).tag(task[<span class="string">&#x27;id&#x27;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">elif</span> schedule_type == <span class="string">&#x27;interval&#x27;</span>:</span><br><span class="line">            <span class="comment"># 间隔任务</span></span><br><span class="line">            interval = task[<span class="string">&#x27;interval&#x27;</span>]</span><br><span class="line">            unit = task[<span class="string">&#x27;interval_unit&#x27;</span>]</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> unit == <span class="string">&#x27;seconds&#x27;</span>:</span><br><span class="line">                schedule.every(interval).seconds.do(</span><br><span class="line">                    self._execute_task, task[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">                ).tag(task[<span class="string">&#x27;id&#x27;</span>])</span><br><span class="line">            <span class="keyword">elif</span> unit == <span class="string">&#x27;minutes&#x27;</span>:</span><br><span class="line">                schedule.every(interval).minutes.do(</span><br><span class="line">                    self._execute_task, task[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">                ).tag(task[<span class="string">&#x27;id&#x27;</span>])</span><br><span class="line">            <span class="keyword">elif</span> unit == <span class="string">&#x27;hours&#x27;</span>:</span><br><span class="line">                schedule.every(interval).hours.do(</span><br><span class="line">                    self._execute_task, task[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">                ).tag(task[<span class="string">&#x27;id&#x27;</span>])</span><br><span class="line">            <span class="keyword">elif</span> unit == <span class="string">&#x27;days&#x27;</span>:</span><br><span class="line">                schedule.every(interval).days.do(</span><br><span class="line">                    self._execute_task, task[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">                ).tag(task[<span class="string">&#x27;id&#x27;</span>])</span><br><span class="line">            <span class="keyword">elif</span> unit == <span class="string">&#x27;weeks&#x27;</span>:</span><br><span class="line">                schedule.every(interval).weeks.do(</span><br><span class="line">                    self._execute_task, task[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">                ).tag(task[<span class="string">&#x27;id&#x27;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">elif</span> schedule_type == <span class="string">&#x27;daily&#x27;</span>:</span><br><span class="line">            <span class="comment"># 每天任务</span></span><br><span class="line">            schedule_time = datetime.fromisoformat(task[<span class="string">&#x27;schedule_time&#x27;</span>])</span><br><span class="line">            schedule.every().day.at(</span><br><span class="line">                <span class="string">f&quot;<span class="subst">&#123;schedule_time.hour:02d&#125;</span>:<span class="subst">&#123;schedule_time.minute:02d&#125;</span>&quot;</span></span><br><span class="line">            ).do(self._execute_task, task[<span class="string">&#x27;id&#x27;</span>]).tag(task[<span class="string">&#x27;id&#x27;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_execute_task</span>(<span class="params">self, task_id: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;执行计划任务&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> task_id <span class="keyword">not</span> <span class="keyword">in</span> self.scheduled_tasks:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        task = self.scheduled_tasks[task_id]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 更新任务状态</span></span><br><span class="line">        task[<span class="string">&#x27;last_run&#x27;</span>] = datetime.now().isoformat()</span><br><span class="line">        task[<span class="string">&#x27;run_count&#x27;</span>] += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算下一次运行时间</span></span><br><span class="line">        self._calculate_next_run(task)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 这里应该调用实际的下载函数</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;执行计划任务: <span class="subst">&#123;task[<span class="string">&#x27;name&#x27;</span>]&#125;</span> - <span class="subst">&#123;task[<span class="string">&#x27;url&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果是一次性任务，禁用</span></span><br><span class="line">        <span class="keyword">if</span> task[<span class="string">&#x27;schedule_type&#x27;</span>] == <span class="string">&#x27;once&#x27;</span>:</span><br><span class="line">            task[<span class="string">&#x27;enabled&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">            schedule.clear(task_id)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 保存更新后的任务状态</span></span><br><span class="line">        self._save_tasks()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start_scheduler</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;启动调度器&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.running:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        self.running = <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 安排所有启用的任务</span></span><br><span class="line">        <span class="keyword">for</span> task_id, task <span class="keyword">in</span> self.scheduled_tasks.items():</span><br><span class="line">            <span class="keyword">if</span> task[<span class="string">&#x27;enabled&#x27;</span>]:</span><br><span class="line">                self._schedule_task(task)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 启动调度线程</span></span><br><span class="line">        self.scheduler_thread = threading.Thread(target=self._scheduler_loop)</span><br><span class="line">        self.scheduler_thread.daemon = <span class="literal">True</span></span><br><span class="line">        self.scheduler_thread.start()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_scheduler_loop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;调度器主循环&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">while</span> self.running:</span><br><span class="line">            schedule.run_pending()</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop_scheduler</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;停止调度器&quot;&quot;&quot;</span></span><br><span class="line">        self.running = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> self.scheduler_thread:</span><br><span class="line">            self.scheduler_thread.join(timeout=<span class="number">5</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">enable_task</span>(<span class="params">self, task_id: <span class="built_in">str</span>, enabled: <span class="built_in">bool</span> = <span class="literal">True</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;启用/禁用任务&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> task_id <span class="keyword">not</span> <span class="keyword">in</span> self.scheduled_tasks:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        task = self.scheduled_tasks[task_id]</span><br><span class="line">        task[<span class="string">&#x27;enabled&#x27;</span>] = enabled</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 清除现有的调度</span></span><br><span class="line">        schedule.clear(task_id)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果启用，重新安排</span></span><br><span class="line">        <span class="keyword">if</span> enabled:</span><br><span class="line">            self._calculate_next_run(task)</span><br><span class="line">            <span class="keyword">if</span> self.running:</span><br><span class="line">                self._schedule_task(task)</span><br><span class="line">        </span><br><span class="line">        self._save_tasks()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">remove_task</span>(<span class="params">self, task_id: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;移除任务&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> task_id <span class="keyword">in</span> self.scheduled_tasks:</span><br><span class="line">            <span class="comment"># 清除调度</span></span><br><span class="line">            schedule.clear(task_id)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 从任务列表中移除</span></span><br><span class="line">            <span class="keyword">del</span> self.scheduled_tasks[task_id]</span><br><span class="line">            </span><br><span class="line">            self._save_tasks()</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_task</span>(<span class="params">self, task_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取任务信息&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.scheduled_tasks.get(task_id)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_all_tasks</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取所有任务&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">list</span>(self.scheduled_tasks.values())</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_save_tasks</span>(<span class="params">self, file_path: <span class="built_in">str</span> = <span class="string">&#x27;scheduled_tasks.json&#x27;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;保存任务到文件&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                json.dump(self.scheduled_tasks, f, indent=<span class="number">2</span>, default=<span class="built_in">str</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;保存任务失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_tasks</span>(<span class="params">self, file_path: <span class="built_in">str</span> = <span class="string">&#x27;scheduled_tasks.json&#x27;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;从文件加载任务&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> os.path.exists(file_path):</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    self.scheduled_tasks = json.load(f)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;加载任务失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            self.scheduled_tasks = &#123;&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># core/rss_parser.py</span></span><br><span class="line"><span class="keyword">import</span> feedparser</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RSSParser</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;RSS订阅解析器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.feeds: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Dict</span>] = &#123;&#125;</span><br><span class="line">        self.downloaded_items = <span class="built_in">set</span>()  <span class="comment"># 存储已下载项目的哈希值</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_feed</span>(<span class="params">self, name: <span class="built_in">str</span>, url: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                download_pattern: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                enabled: <span class="built_in">bool</span> = <span class="literal">True</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;添加RSS订阅&quot;&quot;&quot;</span></span><br><span class="line">        feed_id = <span class="string">f&quot;feed_<span class="subst">&#123;<span class="built_in">int</span>(time.time())&#125;</span>_<span class="subst">&#123;hashlib.md5(url.encode()).hexdigest()[:<span class="number">8</span>]&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        feed = &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: feed_id,</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: name,</span><br><span class="line">            <span class="string">&#x27;url&#x27;</span>: url,</span><br><span class="line">            <span class="string">&#x27;download_pattern&#x27;</span>: download_pattern,</span><br><span class="line">            <span class="string">&#x27;enabled&#x27;</span>: enabled,</span><br><span class="line">            <span class="string">&#x27;last_check&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&#x27;last_update&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&#x27;check_interval&#x27;</span>: <span class="number">3600</span>,  <span class="comment"># 默认1小时检查一次</span></span><br><span class="line">            <span class="string">&#x27;auto_download&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&#x27;download_folder&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&#x27;created&#x27;</span>: datetime.now().isoformat()</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        self.feeds[feed_id] = feed</span><br><span class="line">        <span class="keyword">return</span> feed_id</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse_feed</span>(<span class="params">self, feed_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;解析RSS订阅&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> feed_id <span class="keyword">not</span> <span class="keyword">in</span> self.feeds:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        feed = self.feeds[feed_id]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 解析RSS</span></span><br><span class="line">            parsed_feed = feedparser.parse(feed[<span class="string">&#x27;url&#x27;</span>])</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> parsed_feed.get(<span class="string">&#x27;bozo&#x27;</span>, <span class="number">0</span>):  <span class="comment"># bozo表示解析错误</span></span><br><span class="line">                error_msg = parsed_feed.get(<span class="string">&#x27;bozo_exception&#x27;</span>, <span class="string">&#x27;Unknown error&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    <span class="string">&#x27;success&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">                    <span class="string">&#x27;error&#x27;</span>: <span class="built_in">str</span>(error_msg),</span><br><span class="line">                    <span class="string">&#x27;feed&#x27;</span>: feed</span><br><span class="line">                &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 更新最后检查时间</span></span><br><span class="line">            feed[<span class="string">&#x27;last_check&#x27;</span>] = datetime.now().isoformat()</span><br><span class="line">            feed[<span class="string">&#x27;last_update&#x27;</span>] = parsed_feed.feed.get(<span class="string">&#x27;updated_parsed&#x27;</span>, </span><br><span class="line">                                                     parsed_feed.feed.get(<span class="string">&#x27;published_parsed&#x27;</span>))</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> feed[<span class="string">&#x27;last_update&#x27;</span>]:</span><br><span class="line">                feed[<span class="string">&#x27;last_update&#x27;</span>] = time.strftime(<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>, </span><br><span class="line">                                                   feed[<span class="string">&#x27;last_update&#x27;</span>])</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 提取项目</span></span><br><span class="line">            items = []</span><br><span class="line">            <span class="keyword">for</span> entry <span class="keyword">in</span> parsed_feed.entries:</span><br><span class="line">                item = self._parse_feed_item(entry, feed)</span><br><span class="line">                <span class="keyword">if</span> item:</span><br><span class="line">                    items.append(item)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;success&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&#x27;feed&#x27;</span>: feed,</span><br><span class="line">                <span class="string">&#x27;items&#x27;</span>: items,</span><br><span class="line">                <span class="string">&#x27;feed_info&#x27;</span>: &#123;</span><br><span class="line">                    <span class="string">&#x27;title&#x27;</span>: parsed_feed.feed.get(<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                    <span class="string">&#x27;description&#x27;</span>: parsed_feed.feed.get(<span class="string">&#x27;description&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                    <span class="string">&#x27;link&#x27;</span>: parsed_feed.feed.get(<span class="string">&#x27;link&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                    <span class="string">&#x27;item_count&#x27;</span>: <span class="built_in">len</span>(items)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;success&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">                <span class="string">&#x27;error&#x27;</span>: <span class="built_in">str</span>(e),</span><br><span class="line">                <span class="string">&#x27;feed&#x27;</span>: feed</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_parse_feed_item</span>(<span class="params">self, entry: <span class="type">Dict</span>, feed: <span class="type">Dict</span></span>) -&gt; <span class="type">Optional</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;解析单个RSS项目&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 提取基本信息</span></span><br><span class="line">        item = &#123;</span><br><span class="line">            <span class="string">&#x27;title&#x27;</span>: entry.get(<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;Untitled&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;link&#x27;</span>: entry.get(<span class="string">&#x27;link&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;description&#x27;</span>: entry.get(<span class="string">&#x27;description&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;published&#x27;</span>: entry.get(<span class="string">&#x27;published&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;published_parsed&#x27;</span>: entry.get(<span class="string">&#x27;published_parsed&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;author&#x27;</span>: entry.get(<span class="string">&#x27;author&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;categories&#x27;</span>: entry.get(<span class="string">&#x27;tags&#x27;</span>, []),</span><br><span class="line">            <span class="string">&#x27;guid&#x27;</span>: entry.get(<span class="string">&#x27;guid&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;enclosures&#x27;</span>: entry.get(<span class="string">&#x27;enclosures&#x27;</span>, [])</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 生成项目ID</span></span><br><span class="line">        item_hash = self._generate_item_hash(item)</span><br><span class="line">        item[<span class="string">&#x27;id&#x27;</span>] = item_hash</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查是否已经下载过</span></span><br><span class="line">        item[<span class="string">&#x27;downloaded&#x27;</span>] = (item_hash <span class="keyword">in</span> self.downloaded_items)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 查找下载链接</span></span><br><span class="line">        download_links = self._extract_download_links(item, feed.get(<span class="string">&#x27;download_pattern&#x27;</span>))</span><br><span class="line">        item[<span class="string">&#x27;download_links&#x27;</span>] = download_links</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> item <span class="keyword">if</span> download_links <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_generate_item_hash</span>(<span class="params">self, item: <span class="type">Dict</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;生成项目哈希值&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 使用标题、链接和发布时间生成哈希</span></span><br><span class="line">        hash_str = <span class="string">f&quot;<span class="subst">&#123;item[<span class="string">&#x27;title&#x27;</span>]&#125;</span>_<span class="subst">&#123;item[<span class="string">&#x27;link&#x27;</span>]&#125;</span>_<span class="subst">&#123;item.get(<span class="string">&#x27;published&#x27;</span>, <span class="string">&#x27;&#x27;</span>)&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">return</span> hashlib.md5(hash_str.encode()).hexdigest()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_extract_download_links</span>(<span class="params">self, item: <span class="type">Dict</span>, pattern: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;提取下载链接&quot;&quot;&quot;</span></span><br><span class="line">        download_links = []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查附件</span></span><br><span class="line">        <span class="keyword">for</span> enclosure <span class="keyword">in</span> item.get(<span class="string">&#x27;enclosures&#x27;</span>, []):</span><br><span class="line">            <span class="keyword">if</span> enclosure.get(<span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;&#x27;</span>).startswith((<span class="string">&#x27;application/&#x27;</span>, <span class="string">&#x27;video/&#x27;</span>, <span class="string">&#x27;audio/&#x27;</span>, <span class="string">&#x27;image/&#x27;</span>)):</span><br><span class="line">                download_links.append(&#123;</span><br><span class="line">                    <span class="string">&#x27;url&#x27;</span>: enclosure.get(<span class="string">&#x27;href&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                    <span class="string">&#x27;type&#x27;</span>: enclosure.get(<span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                    <span class="string">&#x27;length&#x27;</span>: enclosure.get(<span class="string">&#x27;length&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">                    <span class="string">&#x27;title&#x27;</span>: <span class="string">f&quot;<span class="subst">&#123;item[<span class="string">&#x27;title&#x27;</span>]&#125;</span> - Attachment&quot;</span></span><br><span class="line">                &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 从描述中提取链接</span></span><br><span class="line">        <span class="keyword">import</span> re</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 查找常见的文件链接</span></span><br><span class="line">        file_patterns = [</span><br><span class="line">            <span class="string">r&#x27;href=&quot;([^&quot;]+\.(?:zip|rar|7z|tar\.gz|tar\.bz2|exe|msi|dmg|pkg|deb|rpm))&quot;&#x27;</span>,</span><br><span class="line">            <span class="string">r&#x27;href=&quot;([^&quot;]+\.(?:mp4|avi|mkv|mov|flv|wmv|mpg|mpeg))&quot;&#x27;</span>,</span><br><span class="line">            <span class="string">r&#x27;href=&quot;([^&quot;]+\.(?:mp3|wav|flac|ogg|aac|m4a))&quot;&#x27;</span>,</span><br><span class="line">            <span class="string">r&#x27;href=&quot;([^&quot;]+\.(?:pdf|epub|mobi|azw))&quot;&#x27;</span>,</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        description = item.get(<span class="string">&#x27;description&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> pattern <span class="keyword">in</span> file_patterns:</span><br><span class="line">            matches = re.findall(pattern, description, re.IGNORECASE)</span><br><span class="line">            <span class="keyword">for</span> <span class="keyword">match</span> <span class="keyword">in</span> matches:</span><br><span class="line">                download_links.append(&#123;</span><br><span class="line">                    <span class="string">&#x27;url&#x27;</span>: <span class="keyword">match</span>,</span><br><span class="line">                    <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;unknown&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;length&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="string">&#x27;title&#x27;</span>: <span class="string">f&quot;<span class="subst">&#123;item[<span class="string">&#x27;title&#x27;</span>]&#125;</span> - <span class="subst">&#123;<span class="keyword">match</span>.split(<span class="string">&#x27;.&#x27;</span>)[-<span class="number">1</span>].upper()&#125;</span>&quot;</span></span><br><span class="line">                &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果指定了模式，进行模式匹配</span></span><br><span class="line">        <span class="keyword">if</span> pattern:</span><br><span class="line">            pattern_matches = re.findall(pattern, description, re.IGNORECASE)</span><br><span class="line">            <span class="keyword">for</span> <span class="keyword">match</span> <span class="keyword">in</span> pattern_matches:</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">isinstance</span>(<span class="keyword">match</span>, <span class="built_in">tuple</span>):</span><br><span class="line">                    <span class="keyword">match</span> = <span class="keyword">match</span>[<span class="number">0</span>]  <span class="comment"># 如果是分组匹配，取第一个组</span></span><br><span class="line">                </span><br><span class="line">                download_links.append(&#123;</span><br><span class="line">                    <span class="string">&#x27;url&#x27;</span>: <span class="keyword">match</span>,</span><br><span class="line">                    <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;pattern_match&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;length&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="string">&#x27;title&#x27;</span>: <span class="string">f&quot;<span class="subst">&#123;item[<span class="string">&#x27;title&#x27;</span>]&#125;</span> - Pattern Match&quot;</span></span><br><span class="line">                &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 去重</span></span><br><span class="line">        seen_urls = <span class="built_in">set</span>()</span><br><span class="line">        unique_links = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> link <span class="keyword">in</span> download_links:</span><br><span class="line">            <span class="keyword">if</span> link[<span class="string">&#x27;url&#x27;</span>] <span class="keyword">not</span> <span class="keyword">in</span> seen_urls:</span><br><span class="line">                seen_urls.add(link[<span class="string">&#x27;url&#x27;</span>])</span><br><span class="line">                unique_links.append(link)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> unique_links</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">mark_as_downloaded</span>(<span class="params">self, item_id: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;标记项目为已下载&quot;&quot;&quot;</span></span><br><span class="line">        self.downloaded_items.add(item_id)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_feeds_for_updates</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查所有启用的订阅更新&quot;&quot;&quot;</span></span><br><span class="line">        updates = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> feed_id, feed <span class="keyword">in</span> self.feeds.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> feed.get(<span class="string">&#x27;enabled&#x27;</span>, <span class="literal">True</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 检查是否需要检查更新</span></span><br><span class="line">            last_check = feed.get(<span class="string">&#x27;last_check&#x27;</span>)</span><br><span class="line">            check_interval = feed.get(<span class="string">&#x27;check_interval&#x27;</span>, <span class="number">3600</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> last_check:</span><br><span class="line">                last_check_time = datetime.fromisoformat(last_check)</span><br><span class="line">                next_check_time = last_check_time + timedelta(seconds=check_interval)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> datetime.now() &lt; next_check_time:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 解析订阅</span></span><br><span class="line">            result = self.parse_feed(feed_id)</span><br><span class="line">            <span class="keyword">if</span> result <span class="keyword">and</span> result.get(<span class="string">&#x27;success&#x27;</span>):</span><br><span class="line">                <span class="comment"># 查找新的下载项</span></span><br><span class="line">                new_items = []</span><br><span class="line">                <span class="keyword">for</span> item <span class="keyword">in</span> result.get(<span class="string">&#x27;items&#x27;</span>, []):</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> item.get(<span class="string">&#x27;downloaded&#x27;</span>, <span class="literal">False</span>) <span class="keyword">and</span> item.get(<span class="string">&#x27;download_links&#x27;</span>):</span><br><span class="line">                        new_items.append(item)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> new_items:</span><br><span class="line">                    updates.append(&#123;</span><br><span class="line">                        <span class="string">&#x27;feed&#x27;</span>: feed,</span><br><span class="line">                        <span class="string">&#x27;feed_info&#x27;</span>: result.get(<span class="string">&#x27;feed_info&#x27;</span>),</span><br><span class="line">                        <span class="string">&#x27;new_items&#x27;</span>: new_items,</span><br><span class="line">                        <span class="string">&#x27;total_items&#x27;</span>: <span class="built_in">len</span>(result.get(<span class="string">&#x27;items&#x27;</span>, []))</span><br><span class="line">                    &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> updates</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_feed</span>(<span class="params">self, feed_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取订阅信息&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.feeds.get(feed_id)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_all_feeds</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取所有订阅&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">list</span>(self.feeds.values())</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">remove_feed</span>(<span class="params">self, feed_id: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;移除订阅&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> feed_id <span class="keyword">in</span> self.feeds:</span><br><span class="line">            <span class="keyword">del</span> self.feeds[feed_id]</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_feeds</span>(<span class="params">self, file_path: <span class="built_in">str</span> = <span class="string">&#x27;rss_feeds.json&#x27;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;保存订阅到文件&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">import</span> json</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                data = &#123;</span><br><span class="line">                    <span class="string">&#x27;feeds&#x27;</span>: self.feeds,</span><br><span class="line">                    <span class="string">&#x27;downloaded_items&#x27;</span>: <span class="built_in">list</span>(self.downloaded_items)</span><br><span class="line">                &#125;</span><br><span class="line">                json.dump(data, f, indent=<span class="number">2</span>, default=<span class="built_in">str</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;保存订阅失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_feeds</span>(<span class="params">self, file_path: <span class="built_in">str</span> = <span class="string">&#x27;rss_feeds.json&#x27;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;从文件加载订阅&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">import</span> json</span><br><span class="line">            <span class="keyword">import</span> os</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> os.path.exists(file_path):</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    data = json.load(f)</span><br><span class="line">                    </span><br><span class="line">                    self.feeds = data.get(<span class="string">&#x27;feeds&#x27;</span>, &#123;&#125;)</span><br><span class="line">                    self.downloaded_items = <span class="built_in">set</span>(data.get(<span class="string">&#x27;downloaded_items&#x27;</span>, []))</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;加载订阅失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            self.feeds = &#123;&#125;</span><br><span class="line">            self.downloaded_items = <span class="built_in">set</span>()</span><br></pre></td></tr></table></figure>



<h2 id="2-增强版CLI工具"><a href="#2-增强版CLI工具" class="headerlink" title="2. 增强版CLI工具"></a>2. 增强版CLI工具</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cli/interactive_cli.py</span></span><br><span class="line"><span class="keyword">import</span> cmd</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span></span><br><span class="line"><span class="keyword">from</span> core.downloader <span class="keyword">import</span> Downloader</span><br><span class="line"><span class="keyword">from</span> core.queue_manager <span class="keyword">import</span> QueueManager, DownloadPriority</span><br><span class="line"><span class="keyword">from</span> core.batch_processor <span class="keyword">import</span> BatchProcessor</span><br><span class="line"><span class="keyword">from</span> core.file_checker <span class="keyword">import</span> FileChecker</span><br><span class="line"><span class="keyword">from</span> core.resume_manager <span class="keyword">import</span> ResumeManager</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DownloadManagerCLI</span>(cmd.Cmd):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;交互式命令行下载管理器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    intro = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ╔══════════════════════════════════════════════════════════╗</span></span><br><span class="line"><span class="string">    ║           多线程下载管理器 - 交互式命令行界面           ║</span></span><br><span class="line"><span class="string">    ║                 输入 help 或 ? 查看命令列表             ║</span></span><br><span class="line"><span class="string">    ╚══════════════════════════════════════════════════════════╝</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    prompt = <span class="string">&quot;(下载管理器) &gt; &quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.downloader = Downloader(max_workers=<span class="number">4</span>)</span><br><span class="line">        self.queue_manager = QueueManager(max_concurrent=<span class="number">2</span>)</span><br><span class="line">        self.batch_processor = BatchProcessor()</span><br><span class="line">        self.file_checker = FileChecker()</span><br><span class="line">        self.resume_manager = ResumeManager()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 注册队列回调</span></span><br><span class="line">        self.queue_manager.register_callback(<span class="string">&#x27;item_completed&#x27;</span>, self._on_download_completed)</span><br><span class="line">        self.queue_manager.register_callback(<span class="string">&#x27;item_failed&#x27;</span>, self._on_download_failed)</span><br><span class="line">        </span><br><span class="line">        self.current_downloads = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_on_download_completed</span>(<span class="params">self, download_info</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;下载完成回调&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n✓ 下载完成: <span class="subst">&#123;download_info.get(<span class="string">&#x27;save_path&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_on_download_failed</span>(<span class="params">self, download_info</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;下载失败回调&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n✗ 下载失败: <span class="subst">&#123;download_info.get(<span class="string">&#x27;error&#x27;</span>, <span class="string">&#x27;未知错误&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_download</span>(<span class="params">self, arg</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        下载文件</span></span><br><span class="line"><span class="string">        用法: download &lt;URL&gt; [保存路径]</span></span><br><span class="line"><span class="string">        示例: download https://example.com/file.zip ./downloads/</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        args = arg.split()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">1</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;错误: 需要提供URL&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        url = args[<span class="number">0</span>]</span><br><span class="line">        save_path = args[<span class="number">1</span>] <span class="keyword">if</span> <span class="built_in">len</span>(args) &gt; <span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;开始下载: <span class="subst">&#123;url&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 添加到队列</span></span><br><span class="line">        queue_id = self.queue_manager.add_to_queue(url, save_path)</span><br><span class="line">        self.current_downloads[queue_id] = &#123;</span><br><span class="line">            <span class="string">&#x27;url&#x27;</span>: url,</span><br><span class="line">            <span class="string">&#x27;save_path&#x27;</span>: save_path,</span><br><span class="line">            <span class="string">&#x27;status&#x27;</span>: <span class="string">&#x27;queued&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;任务已添加到队列，ID: <span class="subst">&#123;queue_id&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_batch</span>(<span class="params">self, arg</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        批量下载</span></span><br><span class="line"><span class="string">        用法: batch &lt;文件路径&gt; [--format=&lt;格式&gt;]</span></span><br><span class="line"><span class="string">        示例: batch ./urls.txt</span></span><br><span class="line"><span class="string">               batch ./downloads.json --format=json</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        args = arg.split()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">1</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;错误: 需要提供文件路径&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        file_path = args[<span class="number">0</span>]</span><br><span class="line">        file_format = <span class="string">&#x27;auto&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 解析可选参数</span></span><br><span class="line">        <span class="keyword">for</span> arg <span class="keyword">in</span> args[<span class="number">1</span>:]:</span><br><span class="line">            <span class="keyword">if</span> arg.startswith(<span class="string">&#x27;--format=&#x27;</span>):</span><br><span class="line">                file_format = arg.split(<span class="string">&#x27;=&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 解析批量文件</span></span><br><span class="line">            <span class="keyword">if</span> file_format == <span class="string">&#x27;auto&#x27;</span>:</span><br><span class="line">                items = self.batch_processor.parse_batch_file(file_path)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 根据指定格式解析</span></span><br><span class="line">                <span class="keyword">if</span> file_format == <span class="string">&#x27;txt&#x27;</span>:</span><br><span class="line">                    items = self.batch_processor._parse_txt_file(file_path)</span><br><span class="line">                <span class="keyword">elif</span> file_format == <span class="string">&#x27;json&#x27;</span>:</span><br><span class="line">                    items = self.batch_processor._parse_json_file(file_path)</span><br><span class="line">                <span class="keyword">elif</span> file_format == <span class="string">&#x27;csv&#x27;</span>:</span><br><span class="line">                    items = self.batch_processor._parse_csv_file(file_path)</span><br><span class="line">                <span class="keyword">elif</span> file_format <span class="keyword">in</span> [<span class="string">&#x27;yaml&#x27;</span>, <span class="string">&#x27;yml&#x27;</span>]:</span><br><span class="line">                    items = self.batch_processor._parse_yaml_file(file_path)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;错误: 不支持的格式: <span class="subst">&#123;file_format&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 验证URL</span></span><br><span class="line">            validation = self.batch_processor.validate_urls(items)</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;解析结果:&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  有效URL: <span class="subst">&#123;<span class="built_in">len</span>(validation[<span class="string">&#x27;valid&#x27;</span>])&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  无效URL: <span class="subst">&#123;<span class="built_in">len</span>(validation[<span class="string">&#x27;invalid&#x27;</span>])&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  重复URL: <span class="subst">&#123;<span class="built_in">len</span>(validation[<span class="string">&#x27;duplicates&#x27;</span>])&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> validation[<span class="string">&#x27;invalid&#x27;</span>]:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;\n无效URL列表:&quot;</span>)</span><br><span class="line">                <span class="keyword">for</span> invalid <span class="keyword">in</span> validation[<span class="string">&#x27;invalid&#x27;</span>][:<span class="number">5</span>]:  <span class="comment"># 只显示前5个</span></span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;  - <span class="subst">&#123;invalid[<span class="string">&#x27;item&#x27;</span>].get(<span class="string">&#x27;url&#x27;</span>)&#125;</span>: <span class="subst">&#123;invalid[<span class="string">&#x27;reason&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(validation[<span class="string">&#x27;invalid&#x27;</span>]) &gt; <span class="number">5</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;  ... 还有 <span class="subst">&#123;<span class="built_in">len</span>(validation[<span class="string">&#x27;invalid&#x27;</span>]) - <span class="number">5</span>&#125;</span> 个&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 确认是否继续</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> validation[<span class="string">&#x27;valid&#x27;</span>]:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;错误: 没有有效的URL可供下载&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">            confirm = <span class="built_in">input</span>(<span class="string">f&quot;\n是否开始下载 <span class="subst">&#123;<span class="built_in">len</span>(validation[<span class="string">&#x27;valid&#x27;</span>])&#125;</span> 个文件？(y/N): &quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> confirm.lower() != <span class="string">&#x27;y&#x27;</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;已取消&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 添加到下载队列</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\n添加到下载队列...&quot;</span>)</span><br><span class="line">            added_count = <span class="number">0</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> validation[<span class="string">&#x27;valid&#x27;</span>]:</span><br><span class="line">                queue_id = self.queue_manager.add_to_queue(</span><br><span class="line">                    url=item[<span class="string">&#x27;url&#x27;</span>],</span><br><span class="line">                    save_path=item.get(<span class="string">&#x27;save_path&#x27;</span>),</span><br><span class="line">                    priority=DownloadPriority(item.get(<span class="string">&#x27;priority&#x27;</span>, <span class="number">1</span>)),</span><br><span class="line">                    metadata=item</span><br><span class="line">                )</span><br><span class="line">                added_count += <span class="number">1</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> added_count % <span class="number">10</span> == <span class="number">0</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;  已添加 <span class="subst">&#123;added_count&#125;</span>/<span class="subst">&#123;<span class="built_in">len</span>(validation[<span class="string">&#x27;valid&#x27;</span>])&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\n✓ 已添加 <span class="subst">&#123;added_count&#125;</span> 个任务到下载队列&quot;</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_queue</span>(<span class="params">self, arg</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        管理下载队列</span></span><br><span class="line"><span class="string">        用法: queue [list|pause|resume|cancel|clear|status]</span></span><br><span class="line"><span class="string">        示例: queue list       # 列出队列</span></span><br><span class="line"><span class="string">               queue pause &lt;ID&gt; # 暂停任务</span></span><br><span class="line"><span class="string">               queue status    # 查看队列状态</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        args = arg.split()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(args) == <span class="number">0</span>:</span><br><span class="line">            self._show_queue_status()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        command = args[<span class="number">0</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> command == <span class="string">&#x27;list&#x27;</span>:</span><br><span class="line">            self._list_queue()</span><br><span class="line">        <span class="keyword">elif</span> command == <span class="string">&#x27;status&#x27;</span>:</span><br><span class="line">            self._show_queue_status()</span><br><span class="line">        <span class="keyword">elif</span> command == <span class="string">&#x27;pause&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">2</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;错误: 需要提供任务ID&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            self._pause_download(args[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">elif</span> command == <span class="string">&#x27;resume&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">2</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;错误: 需要提供任务ID&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            self._resume_download(args[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">elif</span> command == <span class="string">&#x27;cancel&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">2</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;错误: 需要提供任务ID&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            self._cancel_download(args[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">elif</span> command == <span class="string">&#x27;clear&#x27;</span>:</span><br><span class="line">            self._clear_queue()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;错误: 未知命令: <span class="subst">&#123;command&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_list_queue</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;列出队列任务&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 这里需要实现具体的队列列表显示逻辑</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;队列列表功能待实现&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_show_queue_status</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;显示队列状态&quot;&quot;&quot;</span></span><br><span class="line">        status = self.queue_manager.get_queue_status()</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n下载队列状态:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  队列中任务: <span class="subst">&#123;status[<span class="string">&#x27;queue_size&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  等待中任务: <span class="subst">&#123;status[<span class="string">&#x27;waiting_count&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  活跃下载: <span class="subst">&#123;status[<span class="string">&#x27;active_count&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  已暂停: <span class="subst">&#123;status[<span class="string">&#x27;paused_count&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  已完成: <span class="subst">&#123;status[<span class="string">&#x27;completed_count&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  最大并发: <span class="subst">&#123;status[<span class="string">&#x27;max_concurrent&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_pause_download</span>(<span class="params">self, queue_id</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;暂停下载&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.queue_manager.pause_download(queue_id):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;✓ 已暂停任务: <span class="subst">&#123;queue_id&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;错误: 无法暂停任务: <span class="subst">&#123;queue_id&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_resume_download</span>(<span class="params">self, queue_id</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;恢复下载&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.queue_manager.resume_download(queue_id):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;✓ 已恢复任务: <span class="subst">&#123;queue_id&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;错误: 无法恢复任务: <span class="subst">&#123;queue_id&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_cancel_download</span>(<span class="params">self, queue_id</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;取消下载&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.queue_manager.cancel_download(queue_id):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;✓ 已取消任务: <span class="subst">&#123;queue_id&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;错误: 无法取消任务: <span class="subst">&#123;queue_id&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_clear_queue</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;清空队列&quot;&quot;&quot;</span></span><br><span class="line">        confirm = <span class="built_in">input</span>(<span class="string">&quot;确认清空所有队列任务？(y/N): &quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> confirm.lower() == <span class="string">&#x27;y&#x27;</span>:</span><br><span class="line">            <span class="comment"># 这里需要实现清空队列的逻辑</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;队列清空功能待实现&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;已取消&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_resume</span>(<span class="params">self, arg</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        管理断点续传</span></span><br><span class="line"><span class="string">        用法: resume [list|continue|clean]</span></span><br><span class="line"><span class="string">        示例: resume list      # 列出可续传的文件</span></span><br><span class="line"><span class="string">               resume continue &lt;ID&gt; # 继续下载</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        args = arg.split()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(args) == <span class="number">0</span>:</span><br><span class="line">            self._list_resume_files()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        command = args[<span class="number">0</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> command == <span class="string">&#x27;list&#x27;</span>:</span><br><span class="line">            self._list_resume_files()</span><br><span class="line">        <span class="keyword">elif</span> command == <span class="string">&#x27;continue&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">2</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;错误: 需要提供续传文件ID&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            self._continue_download(args[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">elif</span> command == <span class="string">&#x27;clean&#x27;</span>:</span><br><span class="line">            self._clean_resume_files()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;错误: 未知命令: <span class="subst">&#123;command&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_list_resume_files</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;列出可续传的文件&quot;&quot;&quot;</span></span><br><span class="line">        resume_files = self.resume_manager.list_resume_files()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> resume_files:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;没有找到可续传的文件&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n可续传的文件:&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> i, resume_file <span class="keyword">in</span> <span class="built_in">enumerate</span>(resume_files, <span class="number">1</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;i:2d&#125;</span>. <span class="subst">&#123;resume_file[<span class="string">&#x27;filename&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;    URL: <span class="subst">&#123;resume_file[<span class="string">&#x27;url&#x27;</span>][:<span class="number">50</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;    进度: <span class="subst">&#123;resume_file[<span class="string">&#x27;progress&#x27;</span>]&#125;</span>% (<span class="subst">&#123;resume_file[<span class="string">&#x27;downloaded&#x27;</span>]&#125;</span>/<span class="subst">&#123;resume_file[<span class="string">&#x27;total_size&#x27;</span>]&#125;</span>)&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;    分块: <span class="subst">&#123;resume_file[<span class="string">&#x27;chunks&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_continue_download</span>(<span class="params">self, resume_id</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;继续下载&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 这里需要实现续传逻辑</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;继续下载: <span class="subst">&#123;resume_id&#125;</span> (功能待实现)&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_clean_resume_files</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;清理续传文件&quot;&quot;&quot;</span></span><br><span class="line">        confirm = <span class="built_in">input</span>(<span class="string">&quot;确认清理所有续传文件？(y/N): &quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> confirm.lower() == <span class="string">&#x27;y&#x27;</span>:</span><br><span class="line">            <span class="comment"># 这里需要实现清理逻辑</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;续传文件清理功能待实现&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;已取消&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_check</span>(<span class="params">self, arg</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        检查文件</span></span><br><span class="line"><span class="string">        用法: check &lt;文件路径&gt; [--hash=&lt;算法&gt;]</span></span><br><span class="line"><span class="string">        示例: check ./file.zip</span></span><br><span class="line"><span class="string">               check ./file.zip --hash=md5</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        args = arg.split()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">1</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;错误: 需要提供文件路径&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        file_path = args[<span class="number">0</span>]</span><br><span class="line">        hash_algorithm = <span class="string">&#x27;sha256&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 解析可选参数</span></span><br><span class="line">        <span class="keyword">for</span> arg <span class="keyword">in</span> args[<span class="number">1</span>:]:</span><br><span class="line">            <span class="keyword">if</span> arg.startswith(<span class="string">&#x27;--hash=&#x27;</span>):</span><br><span class="line">                hash_algorithm = arg.split(<span class="string">&#x27;=&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(file_path):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;错误: 文件不存在: <span class="subst">&#123;file_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取文件信息</span></span><br><span class="line">        file_info = self.file_checker.get_file_info(file_path)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> file_info:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;错误: 无法获取文件信息&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n文件信息:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  文件名: <span class="subst">&#123;file_info[<span class="string">&#x27;filename&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  路径: <span class="subst">&#123;file_info[<span class="string">&#x27;path&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  大小: <span class="subst">&#123;self._format_size(file_info[<span class="string">&#x27;size&#x27;</span>])&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  类型: <span class="subst">&#123;file_info[<span class="string">&#x27;file_type&#x27;</span>]&#125;</span> (<span class="subst">&#123;file_info[<span class="string">&#x27;mime_type&#x27;</span>]&#125;</span>)&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  修改时间: <span class="subst">&#123;self._format_time(file_info[<span class="string">&#x27;modified&#x27;</span>])&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n哈希值:&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> algo, hash_value <span class="keyword">in</span> file_info[<span class="string">&#x27;hashes&#x27;</span>].items():</span><br><span class="line">            <span class="keyword">if</span> hash_value:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;  <span class="subst">&#123;algo.upper()&#125;</span>: <span class="subst">&#123;hash_value&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_format_size</span>(<span class="params">self, size_bytes</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;格式化文件大小&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> unit <span class="keyword">in</span> [<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;KB&#x27;</span>, <span class="string">&#x27;MB&#x27;</span>, <span class="string">&#x27;GB&#x27;</span>, <span class="string">&#x27;TB&#x27;</span>]:</span><br><span class="line">            <span class="keyword">if</span> size_bytes &lt; <span class="number">1024.0</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">f&quot;<span class="subst">&#123;size_bytes:<span class="number">.2</span>f&#125;</span> <span class="subst">&#123;unit&#125;</span>&quot;</span></span><br><span class="line">            size_bytes /= <span class="number">1024.0</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;<span class="subst">&#123;size_bytes:<span class="number">.2</span>f&#125;</span> PB&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_format_time</span>(<span class="params">self, timestamp</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;格式化时间戳&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line">        <span class="keyword">return</span> datetime.fromtimestamp(timestamp).strftime(<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_settings</span>(<span class="params">self, arg</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        管理设置</span></span><br><span class="line"><span class="string">        用法: settings [show|set &lt;键&gt; &lt;值&gt;]</span></span><br><span class="line"><span class="string">        示例: settings show</span></span><br><span class="line"><span class="string">               settings set max_threads 8</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        args = arg.split()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(args) == <span class="number">0</span>:</span><br><span class="line">            self._show_settings()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        command = args[<span class="number">0</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> command == <span class="string">&#x27;show&#x27;</span>:</span><br><span class="line">            self._show_settings()</span><br><span class="line">        <span class="keyword">elif</span> command == <span class="string">&#x27;set&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">3</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;错误: 需要提供键和值&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            self._set_setting(args[<span class="number">1</span>], args[<span class="number">2</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;错误: 未知命令: <span class="subst">&#123;command&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_show_settings</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;显示当前设置&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n当前设置:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  最大线程数: <span class="subst">&#123;self.downloader.max_workers&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  分块大小: <span class="subst">&#123;self._format_size(self.downloader.chunk_size)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  最大并发下载: <span class="subst">&#123;self.queue_manager.max_concurrent&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_set_setting</span>(<span class="params">self, key, value</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;修改设置&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> key == <span class="string">&#x27;max_threads&#x27;</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.downloader.max_workers = <span class="built_in">int</span>(value)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;✓ 最大线程数已设置为: <span class="subst">&#123;value&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> ValueError:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;错误: 无效的数值: <span class="subst">&#123;value&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">elif</span> key == <span class="string">&#x27;chunk_size&#x27;</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 支持带单位的大小（如 1M, 512K）</span></span><br><span class="line">                <span class="keyword">if</span> value.endswith(<span class="string">&#x27;K&#x27;</span>):</span><br><span class="line">                    size = <span class="built_in">int</span>(value[:-<span class="number">1</span>]) * <span class="number">1024</span></span><br><span class="line">                <span class="keyword">elif</span> value.endswith(<span class="string">&#x27;M&#x27;</span>):</span><br><span class="line">                    size = <span class="built_in">int</span>(value[:-<span class="number">1</span>]) * <span class="number">1024</span> * <span class="number">1024</span></span><br><span class="line">                <span class="keyword">elif</span> value.endswith(<span class="string">&#x27;G&#x27;</span>):</span><br><span class="line">                    size = <span class="built_in">int</span>(value[:-<span class="number">1</span>]) * <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1024</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    size = <span class="built_in">int</span>(value)</span><br><span class="line">                </span><br><span class="line">                self.downloader.chunk_size = size</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;✓ 分块大小已设置为: <span class="subst">&#123;self._format_size(size)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> ValueError:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;错误: 无效的大小: <span class="subst">&#123;value&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">elif</span> key == <span class="string">&#x27;max_concurrent&#x27;</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.queue_manager.set_max_concurrent(<span class="built_in">int</span>(value))</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;✓ 最大并发下载已设置为: <span class="subst">&#123;value&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> ValueError:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;错误: 无效的数值: <span class="subst">&#123;value&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;错误: 未知设置项: <span class="subst">&#123;key&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_history</span>(<span class="params">self, arg</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        查看下载历史</span></span><br><span class="line"><span class="string">        用法: history [clear]</span></span><br><span class="line"><span class="string">        示例: history      # 查看历史</span></span><br><span class="line"><span class="string">               history clear # 清空历史</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> arg == <span class="string">&#x27;clear&#x27;</span>:</span><br><span class="line">            confirm = <span class="built_in">input</span>(<span class="string">&quot;确认清空下载历史？(y/N): &quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> confirm.lower() == <span class="string">&#x27;y&#x27;</span>:</span><br><span class="line">                <span class="comment"># 这里需要实现清空历史的逻辑</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;历史记录清空功能待实现&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;已取消&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 显示下载历史</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;下载历史功能待实现&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_template</span>(<span class="params">self, arg</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        生成批量下载模板</span></span><br><span class="line"><span class="string">        用法: template &lt;格式&gt; [输出文件]</span></span><br><span class="line"><span class="string">        示例: template json</span></span><br><span class="line"><span class="string">               template csv urls.csv</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        args = arg.split()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">1</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;错误: 需要提供格式&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;可用格式: txt, json, csv, yaml&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        format_type = args[<span class="number">0</span>]</span><br><span class="line">        output_file = args[<span class="number">1</span>] <span class="keyword">if</span> <span class="built_in">len</span>(args) &gt; <span class="number">1</span> <span class="keyword">else</span> <span class="string">f&quot;template.<span class="subst">&#123;format_type&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            template = self.batch_processor.generate_batch_template(format_type)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> output_file:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(output_file, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    f.write(template)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;✓ 模板已保存到: <span class="subst">&#123;output_file&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span> + template)</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_exit</span>(<span class="params">self, arg</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        退出程序</span></span><br><span class="line"><span class="string">        用法: exit</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;感谢使用下载管理器，再见！&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_quit</span>(<span class="params">self, arg</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;退出程序&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.do_exit(arg)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">default</span>(<span class="params">self, line</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理未知命令&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;未知命令: <span class="subst">&#123;line&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;输入 help 或 ? 查看可用命令&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主函数&quot;&quot;&quot;</span></span><br><span class="line">    cli = DownloadManagerCLI()</span><br><span class="line">    cli.cmdloop()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>



<h2 id="3-增强版Web界面"><a href="#3-增强版Web界面" class="headerlink" title="3. 增强版Web界面"></a>3. 增强版Web界面</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># web/app.py (增强版)</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, jsonify, send_file, session, redirect, url_for</span><br><span class="line"><span class="keyword">from</span> flask_login <span class="keyword">import</span> LoginManager, UserMixin, login_user, login_required, logout_user, current_user</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> core.downloader <span class="keyword">import</span> Downloader</span><br><span class="line"><span class="keyword">from</span> core.queue_manager <span class="keyword">import</span> QueueManager, DownloadPriority</span><br><span class="line"><span class="keyword">from</span> core.resume_manager <span class="keyword">import</span> ResumeManager</span><br><span class="line"><span class="keyword">from</span> core.speed_limiter <span class="keyword">import</span> SpeedLimiter</span><br><span class="line"><span class="keyword">from</span> core.proxy_manager <span class="keyword">import</span> ProxyManager</span><br><span class="line"><span class="keyword">from</span> core.batch_processor <span class="keyword">import</span> BatchProcessor</span><br><span class="line"><span class="keyword">from</span> core.file_checker <span class="keyword">import</span> FileChecker</span><br><span class="line"><span class="keyword">from</span> core.scheduler <span class="keyword">import</span> DownloadScheduler</span><br><span class="line"><span class="keyword">from</span> core.rss_parser <span class="keyword">import</span> RSSParser</span><br><span class="line"><span class="keyword">from</span> core.utils <span class="keyword">import</span> format_file_size, format_time, calculate_speed</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = os.urandom(<span class="number">24</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化登录管理器</span></span><br><span class="line">login_manager = LoginManager()</span><br><span class="line">login_manager.init_app(app)</span><br><span class="line">login_manager.login_view = <span class="string">&#x27;login&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化管理器</span></span><br><span class="line">downloader = Downloader(max_workers=<span class="number">4</span>, chunk_size=<span class="number">1024</span>*<span class="number">1024</span>)</span><br><span class="line">queue_manager = QueueManager(max_concurrent=<span class="number">3</span>)</span><br><span class="line">resume_manager = ResumeManager()</span><br><span class="line">speed_limiter = SpeedLimiter(download_limit=<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">10</span>)  <span class="comment"># 10MB/s限制</span></span><br><span class="line">proxy_manager = ProxyManager()</span><br><span class="line">batch_processor = BatchProcessor()</span><br><span class="line">file_checker = FileChecker()</span><br><span class="line">scheduler = DownloadScheduler()</span><br><span class="line">rss_parser = RSSParser()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户管理（简化版，实际应用中应使用数据库）</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">UserMixin</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, <span class="built_in">id</span></span>):</span><br><span class="line">        self.<span class="built_in">id</span> = <span class="built_in">id</span></span><br><span class="line"></span><br><span class="line">users = &#123;<span class="string">&#x27;admin&#x27;</span>: &#123;<span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;admin123&#x27;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@login_manager.user_loader</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_user</span>(<span class="params">user_id</span>):</span><br><span class="line">    <span class="keyword">return</span> User(user_id) <span class="keyword">if</span> user_id <span class="keyword">in</span> users <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 存储下载历史和统计</span></span><br><span class="line">download_history = []</span><br><span class="line">download_stats = &#123;</span><br><span class="line">    <span class="string">&#x27;total_downloads&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&#x27;total_bytes&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&#x27;average_speed&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&#x27;success_rate&#x27;</span>: <span class="number">100</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update_stats</span>(<span class="params">download_info</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;更新下载统计&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> download_info.get(<span class="string">&#x27;status&#x27;</span>) == <span class="string">&#x27;completed&#x27;</span>:</span><br><span class="line">        download_stats[<span class="string">&#x27;total_downloads&#x27;</span>] += <span class="number">1</span></span><br><span class="line">        download_stats[<span class="string">&#x27;total_bytes&#x27;</span>] += download_info.get(<span class="string">&#x27;file_size&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算平均速度</span></span><br><span class="line">        <span class="keyword">if</span> download_info.get(<span class="string">&#x27;start_time&#x27;</span>) <span class="keyword">and</span> download_info.get(<span class="string">&#x27;end_time&#x27;</span>):</span><br><span class="line">            elapsed = download_info[<span class="string">&#x27;end_time&#x27;</span>] - download_info[<span class="string">&#x27;start_time&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> elapsed &gt; <span class="number">0</span>:</span><br><span class="line">                speed = download_info.get(<span class="string">&#x27;file_size&#x27;</span>, <span class="number">0</span>) / elapsed</span><br><span class="line">                <span class="comment"># 更新平均速度（加权平均）</span></span><br><span class="line">                old_avg = download_stats[<span class="string">&#x27;average_speed&#x27;</span>]</span><br><span class="line">                total = download_stats[<span class="string">&#x27;total_downloads&#x27;</span>]</span><br><span class="line">                download_stats[<span class="string">&#x27;average_speed&#x27;</span>] = (old_avg * (total - <span class="number">1</span>) + speed) / total</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主页&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;登录页面&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        username = request.form.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = request.form.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> username <span class="keyword">in</span> users <span class="keyword">and</span> users[username][<span class="string">&#x27;password&#x27;</span>] == password:</span><br><span class="line">            user = User(username)</span><br><span class="line">            login_user(user)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>, error=<span class="string">&#x27;用户名或密码错误&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/logout&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;退出登录&quot;&quot;&quot;</span></span><br><span class="line">    logout_user()</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/stats&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_stats</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取统计信息&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">        <span class="string">&#x27;stats&#x27;</span>: download_stats,</span><br><span class="line">        <span class="string">&#x27;queue_status&#x27;</span>: queue_manager.get_queue_status(),</span><br><span class="line">        <span class="string">&#x27;speed_limit&#x27;</span>: speed_limiter.get_current_speeds(),</span><br><span class="line">        <span class="string">&#x27;formatted_stats&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;total_downloads&#x27;</span>: download_stats[<span class="string">&#x27;total_downloads&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;total_bytes&#x27;</span>: format_file_size(download_stats[<span class="string">&#x27;total_bytes&#x27;</span>]),</span><br><span class="line">            <span class="string">&#x27;average_speed&#x27;</span>: <span class="string">f&quot;<span class="subst">&#123;format_file_size(download_stats[<span class="string">&#x27;average_speed&#x27;</span>])&#125;</span>/s&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;success_rate&#x27;</span>: <span class="string">f&quot;<span class="subst">&#123;download_stats[<span class="string">&#x27;success_rate&#x27;</span>]:<span class="number">.1</span>f&#125;</span>%&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/download&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start_download</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;开始下载&quot;&quot;&quot;</span></span><br><span class="line">    data = request.json</span><br><span class="line">    url = data.get(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line">    save_path = data.get(<span class="string">&#x27;save_path&#x27;</span>)</span><br><span class="line">    priority = data.get(<span class="string">&#x27;priority&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> url:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;URL不能为空&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 添加到队列</span></span><br><span class="line">        queue_id = queue_manager.add_to_queue(</span><br><span class="line">            url=url,</span><br><span class="line">            save_path=save_path,</span><br><span class="line">            priority=DownloadPriority(priority)</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&#x27;queue_id&#x27;</span>: queue_id,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;下载任务已添加到队列&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="built_in">str</span>(e)&#125;), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/batch&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">batch_download</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;批量下载&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;file&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;没有上传文件&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line">    </span><br><span class="line">    file = request.files[<span class="string">&#x27;file&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> file.filename == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;没有选择文件&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 保存上传的文件</span></span><br><span class="line">        upload_dir = <span class="string">&#x27;uploads&#x27;</span></span><br><span class="line">        os.makedirs(upload_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        file_path = os.path.join(upload_dir, file.filename)</span><br><span class="line">        file.save(file_path)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 解析批量文件</span></span><br><span class="line">        items = batch_processor.parse_batch_file(file_path)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 验证URL</span></span><br><span class="line">        validation = batch_processor.validate_urls(items)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 添加到队列</span></span><br><span class="line">        added_count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> validation[<span class="string">&#x27;valid&#x27;</span>]:</span><br><span class="line">            queue_manager.add_to_queue(</span><br><span class="line">                url=item[<span class="string">&#x27;url&#x27;</span>],</span><br><span class="line">                save_path=item.get(<span class="string">&#x27;save_path&#x27;</span>),</span><br><span class="line">                priority=DownloadPriority(item.get(<span class="string">&#x27;priority&#x27;</span>, <span class="number">1</span>)),</span><br><span class="line">                metadata=item</span><br><span class="line">            )</span><br><span class="line">            added_count += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&#x27;added_count&#x27;</span>: added_count,</span><br><span class="line">            <span class="string">&#x27;validation&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;valid&#x27;</span>: <span class="built_in">len</span>(validation[<span class="string">&#x27;valid&#x27;</span>]),</span><br><span class="line">                <span class="string">&#x27;invalid&#x27;</span>: <span class="built_in">len</span>(validation[<span class="string">&#x27;invalid&#x27;</span>]),</span><br><span class="line">                <span class="string">&#x27;duplicates&#x27;</span>: <span class="built_in">len</span>(validation[<span class="string">&#x27;duplicates&#x27;</span>])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="built_in">str</span>(e)&#125;), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/progress&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_progress</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取下载进度&quot;&quot;&quot;</span></span><br><span class="line">    downloads = downloader.get_all_downloads()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 格式化下载信息</span></span><br><span class="line">    formatted_downloads = []</span><br><span class="line">    <span class="keyword">for</span> dl <span class="keyword">in</span> downloads:</span><br><span class="line">        formatted = &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: dl.get(<span class="string">&#x27;url&#x27;</span>) + <span class="string">&#x27;_&#x27;</span> + <span class="built_in">str</span>(dl.get(<span class="string">&#x27;start_time&#x27;</span>, <span class="string">&#x27;&#x27;</span>)),</span><br><span class="line">            <span class="string">&#x27;url&#x27;</span>: dl.get(<span class="string">&#x27;url&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;filename&#x27;</span>: os.path.basename(dl.get(<span class="string">&#x27;save_path&#x27;</span>, <span class="string">&#x27;&#x27;</span>)),</span><br><span class="line">            <span class="string">&#x27;save_path&#x27;</span>: dl.get(<span class="string">&#x27;save_path&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;status&#x27;</span>: dl.get(<span class="string">&#x27;status&#x27;</span>, <span class="string">&#x27;unknown&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;progress&#x27;</span>: dl.get(<span class="string">&#x27;progress&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="string">&#x27;file_size&#x27;</span>: dl.get(<span class="string">&#x27;file_size&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="string">&#x27;downloaded&#x27;</span>: dl.get(<span class="string">&#x27;downloaded&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="string">&#x27;formatted_size&#x27;</span>: format_file_size(dl.get(<span class="string">&#x27;file_size&#x27;</span>, <span class="number">0</span>)),</span><br><span class="line">            <span class="string">&#x27;formatted_downloaded&#x27;</span>: format_file_size(dl.get(<span class="string">&#x27;downloaded&#x27;</span>, <span class="number">0</span>)),</span><br><span class="line">            <span class="string">&#x27;start_time&#x27;</span>: dl.get(<span class="string">&#x27;start_time&#x27;</span>, time.time()),</span><br><span class="line">            <span class="string">&#x27;speed&#x27;</span>: <span class="string">&#x27;计算中...&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;eta&#x27;</span>: <span class="string">&#x27;计算中...&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算速度和预计剩余时间</span></span><br><span class="line">        <span class="keyword">if</span> dl.get(<span class="string">&#x27;status&#x27;</span>) == <span class="string">&#x27;downloading&#x27;</span> <span class="keyword">and</span> dl.get(<span class="string">&#x27;start_time&#x27;</span>):</span><br><span class="line">            elapsed = time.time() - dl[<span class="string">&#x27;start_time&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> elapsed &gt; <span class="number">0</span>:</span><br><span class="line">                speed = dl.get(<span class="string">&#x27;downloaded&#x27;</span>, <span class="number">0</span>) / elapsed</span><br><span class="line">                formatted[<span class="string">&#x27;speed&#x27;</span>] = <span class="string">f&quot;<span class="subst">&#123;format_file_size(speed)&#125;</span>/s&quot;</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 计算ETA</span></span><br><span class="line">                remaining = dl.get(<span class="string">&#x27;file_size&#x27;</span>, <span class="number">0</span>) - dl.get(<span class="string">&#x27;downloaded&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">if</span> speed &gt; <span class="number">0</span>:</span><br><span class="line">                    eta_seconds = remaining / speed</span><br><span class="line">                    <span class="keyword">if</span> eta_seconds &lt; <span class="number">60</span>:</span><br><span class="line">                        formatted[<span class="string">&#x27;eta&#x27;</span>] = <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">int</span>(eta_seconds)&#125;</span>秒&quot;</span></span><br><span class="line">                    <span class="keyword">elif</span> eta_seconds &lt; <span class="number">3600</span>:</span><br><span class="line">                        formatted[<span class="string">&#x27;eta&#x27;</span>] = <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">int</span>(eta_seconds/<span class="number">60</span>)&#125;</span>分钟&quot;</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        formatted[<span class="string">&#x27;eta&#x27;</span>] = <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">int</span>(eta_seconds/<span class="number">3600</span>)&#125;</span>小时&quot;</span></span><br><span class="line">        </span><br><span class="line">        formatted_downloads.append(formatted)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;downloads&#x27;</span>: formatted_downloads&#125;)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/queue&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_queue</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取队列信息&quot;&quot;&quot;</span></span><br><span class="line">    queue_status = queue_manager.get_queue_status()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 这里需要实现获取队列详细信息的逻辑</span></span><br><span class="line">    queue_items = []  <span class="comment"># 待实现</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">        <span class="string">&#x27;status&#x27;</span>: queue_status,</span><br><span class="line">        <span class="string">&#x27;items&#x27;</span>: queue_items</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/settings&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">manage_settings</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;管理设置&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        <span class="comment"># 返回当前设置</span></span><br><span class="line">        settings = &#123;</span><br><span class="line">            <span class="string">&#x27;max_threads&#x27;</span>: downloader.max_workers,</span><br><span class="line">            <span class="string">&#x27;chunk_size&#x27;</span>: downloader.chunk_size,</span><br><span class="line">            <span class="string">&#x27;max_concurrent&#x27;</span>: queue_manager.max_concurrent,</span><br><span class="line">            <span class="string">&#x27;download_limit&#x27;</span>: speed_limiter.download_limit,</span><br><span class="line">            <span class="string">&#x27;upload_limit&#x27;</span>: speed_limiter.upload_limit,</span><br><span class="line">            <span class="string">&#x27;active_proxy&#x27;</span>: proxy_manager.active_proxy</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> jsonify(settings)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">else</span>:  <span class="comment"># POST</span></span><br><span class="line">        data = request.json</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 更新设置</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;max_threads&#x27;</span> <span class="keyword">in</span> data:</span><br><span class="line">            downloader.max_workers = <span class="built_in">int</span>(data[<span class="string">&#x27;max_threads&#x27;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;chunk_size&#x27;</span> <span class="keyword">in</span> data:</span><br><span class="line">            downloader.chunk_size = <span class="built_in">int</span>(data[<span class="string">&#x27;chunk_size&#x27;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;max_concurrent&#x27;</span> <span class="keyword">in</span> data:</span><br><span class="line">            queue_manager.set_max_concurrent(<span class="built_in">int</span>(data[<span class="string">&#x27;max_concurrent&#x27;</span>]))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;download_limit&#x27;</span> <span class="keyword">in</span> data:</span><br><span class="line">            speed_limiter.set_download_limit(</span><br><span class="line">                <span class="built_in">float</span>(data[<span class="string">&#x27;download_limit&#x27;</span>]) <span class="keyword">if</span> data[<span class="string">&#x27;download_limit&#x27;</span>] <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">            )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;upload_limit&#x27;</span> <span class="keyword">in</span> data:</span><br><span class="line">            speed_limiter.set_upload_limit(</span><br><span class="line">                <span class="built_in">float</span>(data[<span class="string">&#x27;upload_limit&#x27;</span>]) <span class="keyword">if</span> data[<span class="string">&#x27;upload_limit&#x27;</span>] <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">            )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;success&#x27;</span>: <span class="literal">True</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/proxies&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;DELETE&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">manage_proxies</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;管理代理&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        <span class="comment"># 获取所有代理</span></span><br><span class="line">        proxies = proxy_manager.get_all_proxies()</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;proxies&#x27;</span>: proxies&#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        <span class="comment"># 添加或更新代理</span></span><br><span class="line">        data = request.json</span><br><span class="line">        </span><br><span class="line">        name = data.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">        url = data.get(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line">        proxy_type = data.get(<span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;http&#x27;</span>)</span><br><span class="line">        username = data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = data.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> name <span class="keyword">or</span> <span class="keyword">not</span> url:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;名称和URL不能为空&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line">        </span><br><span class="line">        success = proxy_manager.add_proxy(</span><br><span class="line">            name=name,</span><br><span class="line">            proxy_url=url,</span><br><span class="line">            proxy_type=proxy_type,</span><br><span class="line">            username=username,</span><br><span class="line">            password=password</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> success:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;success&#x27;</span>: <span class="literal">True</span>&#125;)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;添加代理失败&#x27;</span>&#125;), <span class="number">500</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">else</span>:  <span class="comment"># DELETE</span></span><br><span class="line">        name = request.args.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> name:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;需要提供代理名称&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line">        </span><br><span class="line">        success = proxy_manager.remove_proxy(name)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> success:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;success&#x27;</span>: <span class="literal">True</span>&#125;)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;删除代理失败&#x27;</span>&#125;), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/rss&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;DELETE&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">manage_rss</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;管理RSS订阅&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        <span class="comment"># 获取所有订阅</span></span><br><span class="line">        feeds = rss_parser.get_all_feeds()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查更新</span></span><br><span class="line">        check_updates = request.args.get(<span class="string">&#x27;check_updates&#x27;</span>, <span class="string">&#x27;false&#x27;</span>).lower() == <span class="string">&#x27;true&#x27;</span></span><br><span class="line">        updates = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> check_updates:</span><br><span class="line">            updates = rss_parser.check_feeds_for_updates()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&#x27;feeds&#x27;</span>: feeds,</span><br><span class="line">            <span class="string">&#x27;updates&#x27;</span>: updates</span><br><span class="line">        &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        <span class="comment"># 添加订阅</span></span><br><span class="line">        data = request.json</span><br><span class="line">        </span><br><span class="line">        name = data.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">        url = data.get(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line">        download_pattern = data.get(<span class="string">&#x27;download_pattern&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> name <span class="keyword">or</span> <span class="keyword">not</span> url:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;名称和URL不能为空&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line">        </span><br><span class="line">        feed_id = rss_parser.add_feed(</span><br><span class="line">            name=name,</span><br><span class="line">            url=url,</span><br><span class="line">            download_pattern=download_pattern</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&#x27;feed_id&#x27;</span>: feed_id</span><br><span class="line">        &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">else</span>:  <span class="comment"># DELETE</span></span><br><span class="line">        feed_id = request.args.get(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> feed_id:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;需要提供订阅ID&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line">        </span><br><span class="line">        success = rss_parser.remove_feed(feed_id)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> success:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;success&#x27;</span>: <span class="literal">True</span>&#125;)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;删除订阅失败&#x27;</span>&#125;), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/scheduler&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;DELETE&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">manage_scheduler</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;管理计划任务&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        <span class="comment"># 获取所有任务</span></span><br><span class="line">        tasks = scheduler.get_all_tasks()</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;tasks&#x27;</span>: tasks&#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        <span class="comment"># 添加任务</span></span><br><span class="line">        data = request.json</span><br><span class="line">        </span><br><span class="line">        required_fields = [<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;url&#x27;</span>, <span class="string">&#x27;schedule_type&#x27;</span>]</span><br><span class="line">        <span class="keyword">for</span> field <span class="keyword">in</span> required_fields:</span><br><span class="line">            <span class="keyword">if</span> field <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">                <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">f&#x27;缺少必要字段: <span class="subst">&#123;field&#125;</span>&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 解析时间</span></span><br><span class="line">        schedule_time = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> data.get(<span class="string">&#x27;schedule_time&#x27;</span>):</span><br><span class="line">            schedule_time = datetime.fromisoformat(data[<span class="string">&#x27;schedule_time&#x27;</span>])</span><br><span class="line">        </span><br><span class="line">        task_id = scheduler.add_scheduled_task(</span><br><span class="line">            name=data[<span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">            url=data[<span class="string">&#x27;url&#x27;</span>],</span><br><span class="line">            schedule_type=data[<span class="string">&#x27;schedule_type&#x27;</span>],</span><br><span class="line">            schedule_time=schedule_time,</span><br><span class="line">            interval=data.get(<span class="string">&#x27;interval&#x27;</span>),</span><br><span class="line">            interval_unit=data.get(<span class="string">&#x27;interval_unit&#x27;</span>, <span class="string">&#x27;hours&#x27;</span>),</span><br><span class="line">            save_path=data.get(<span class="string">&#x27;save_path&#x27;</span>)</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&#x27;task_id&#x27;</span>: task_id</span><br><span class="line">        &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">else</span>:  <span class="comment"># DELETE</span></span><br><span class="line">        task_id = request.args.get(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> task_id:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;需要提供任务ID&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line">        </span><br><span class="line">        success = scheduler.remove_task(task_id)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> success:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;success&#x27;</span>: <span class="literal">True</span>&#125;)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;删除任务失败&#x27;</span>&#125;), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/files&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">list_files</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;列出已下载的文件&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 获取下载目录</span></span><br><span class="line">    download_dir = request.args.get(<span class="string">&#x27;dir&#x27;</span>, <span class="string">&#x27;downloads&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(download_dir):</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;files&#x27;</span>: []&#125;)</span><br><span class="line">    </span><br><span class="line">    files = []</span><br><span class="line">    <span class="keyword">for</span> filename <span class="keyword">in</span> os.listdir(download_dir):</span><br><span class="line">        filepath = os.path.join(download_dir, filename)</span><br><span class="line">        <span class="keyword">if</span> os.path.isfile(filepath):</span><br><span class="line">            stat = os.stat(filepath)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 获取文件信息</span></span><br><span class="line">            file_info = file_checker.get_file_info(filepath)</span><br><span class="line">            </span><br><span class="line">            files.append(&#123;</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>: filename,</span><br><span class="line">                <span class="string">&#x27;path&#x27;</span>: filepath,</span><br><span class="line">                <span class="string">&#x27;size&#x27;</span>: stat.st_size,</span><br><span class="line">                <span class="string">&#x27;formatted_size&#x27;</span>: format_file_size(stat.st_size),</span><br><span class="line">                <span class="string">&#x27;modified&#x27;</span>: stat.st_mtime,</span><br><span class="line">                <span class="string">&#x27;formatted_modified&#x27;</span>: time.ctime(stat.st_mtime),</span><br><span class="line">                <span class="string">&#x27;type&#x27;</span>: file_info[<span class="string">&#x27;file_type&#x27;</span>] <span class="keyword">if</span> file_info <span class="keyword">else</span> <span class="string">&#x27;unknown&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;mime_type&#x27;</span>: file_info[<span class="string">&#x27;mime_type&#x27;</span>] <span class="keyword">if</span> file_info <span class="keyword">else</span> <span class="string">&#x27;unknown&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;hashes&#x27;</span>: file_info[<span class="string">&#x27;hashes&#x27;</span>] <span class="keyword">if</span> file_info <span class="keyword">else</span> &#123;&#125;</span><br><span class="line">            &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 按修改时间排序（最新的在前）</span></span><br><span class="line">    files.sort(key=<span class="keyword">lambda</span> x: x[<span class="string">&#x27;modified&#x27;</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;files&#x27;</span>: files&#125;)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/file/check&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_file</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;检查文件&quot;&quot;&quot;</span></span><br><span class="line">    data = request.json</span><br><span class="line">    file_path = data.get(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> file_path <span class="keyword">or</span> <span class="keyword">not</span> os.path.exists(file_path):</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;文件不存在&#x27;</span>&#125;), <span class="number">404</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 验证文件</span></span><br><span class="line">    validation = file_checker.validate_download(</span><br><span class="line">        file_path=file_path,</span><br><span class="line">        expected_size=data.get(<span class="string">&#x27;expected_size&#x27;</span>),</span><br><span class="line">        expected_hash=data.get(<span class="string">&#x27;expected_hash&#x27;</span>),</span><br><span class="line">        hash_algorithm=data.get(<span class="string">&#x27;hash_algorithm&#x27;</span>, <span class="string">&#x27;sha256&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> jsonify(validation)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/resume&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_resume_files</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取可续传的文件&quot;&quot;&quot;</span></span><br><span class="line">    resume_files = resume_manager.list_resume_files()</span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;resume_files&#x27;</span>: resume_files&#125;)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/resume/&lt;resume_id&gt;&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resume_download</span>(<span class="params">resume_id</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;续传下载&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 这里需要实现续传逻辑</span></span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;success&#x27;</span>: <span class="literal">True</span>, <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;续传功能待实现&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 加载数据</span></span><br><span class="line">    scheduler.load_tasks()</span><br><span class="line">    rss_parser.load_feeds()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 启动调度器</span></span><br><span class="line">    scheduler.start_scheduler()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 启动Web服务器</span></span><br><span class="line">    app.run(debug=<span class="literal">True</span>, port=<span class="number">5000</span>, host=<span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="4-配置文件-1"><a href="#4-配置文件-1" class="headerlink" title="4. 配置文件"></a>4. 配置文件</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># config/settings.py</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">Any</span>, <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Settings</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;配置管理器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config_file: <span class="built_in">str</span> = <span class="string">&#x27;config.yaml&#x27;</span></span>):</span><br><span class="line">        self.config_file = config_file</span><br><span class="line">        self.config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = &#123;&#125;</span><br><span class="line">        self._load_config()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_load_config</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;加载配置文件&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(self.config_file):</span><br><span class="line">            self._create_default_config()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(self.config_file, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                <span class="keyword">if</span> self.config_file.endswith(<span class="string">&#x27;.json&#x27;</span>):</span><br><span class="line">                    self.config = json.load(f)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.config = yaml.safe_load(f)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;加载配置文件失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            self._create_default_config()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_create_default_config</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建默认配置&quot;&quot;&quot;</span></span><br><span class="line">        self.config = &#123;</span><br><span class="line">            <span class="string">&#x27;general&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;max_threads&#x27;</span>: <span class="number">4</span>,</span><br><span class="line">                <span class="string">&#x27;chunk_size&#x27;</span>: <span class="number">1024</span> * <span class="number">1024</span>,  <span class="comment"># 1MB</span></span><br><span class="line">                <span class="string">&#x27;max_concurrent&#x27;</span>: <span class="number">3</span>,</span><br><span class="line">                <span class="string">&#x27;download_dir&#x27;</span>: <span class="string">&#x27;downloads&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;temp_dir&#x27;</span>: <span class="string">&#x27;temp&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;resume_dir&#x27;</span>: <span class="string">&#x27;.resume&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;log_level&#x27;</span>: <span class="string">&#x27;INFO&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;speed_limit&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;download&#x27;</span>: <span class="literal">None</span>,  <span class="comment"># 无限制</span></span><br><span class="line">                <span class="string">&#x27;upload&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">                <span class="string">&#x27;enabled&#x27;</span>: <span class="literal">False</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;proxy&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;enabled&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">                <span class="string">&#x27;auto_select&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&#x27;proxies&#x27;</span>: []</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;queue&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;auto_start&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&#x27;retry_failed&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&#x27;max_retries&#x27;</span>: <span class="number">3</span>,</span><br><span class="line">                <span class="string">&#x27;retry_delay&#x27;</span>: <span class="number">60</span>  <span class="comment"># 秒</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;scheduler&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;enabled&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&#x27;check_interval&#x27;</span>: <span class="number">60</span>  <span class="comment"># 秒</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;rss&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;enabled&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&#x27;auto_download&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">                <span class="string">&#x27;check_interval&#x27;</span>: <span class="number">3600</span>  <span class="comment"># 秒</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;web&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;host&#x27;</span>: <span class="string">&#x27;0.0.0.0&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;port&#x27;</span>: <span class="number">5000</span>,</span><br><span class="line">                <span class="string">&#x27;debug&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">                <span class="string">&#x27;secret_key&#x27;</span>: os.urandom(<span class="number">24</span>).<span class="built_in">hex</span>()</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;security&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;require_auth&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&#x27;session_timeout&#x27;</span>: <span class="number">3600</span>,  <span class="comment"># 秒</span></span><br><span class="line">                <span class="string">&#x27;rate_limit&#x27;</span>: <span class="number">100</span>  <span class="comment"># 每分钟请求数</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;notifications&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;enabled&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">                <span class="string">&#x27;email&#x27;</span>: &#123;</span><br><span class="line">                    <span class="string">&#x27;enabled&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">                    <span class="string">&#x27;smtp_server&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;smtp_port&#x27;</span>: <span class="number">587</span>,</span><br><span class="line">                    <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;from_email&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;to_email&#x27;</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&#x27;webhook&#x27;</span>: &#123;</span><br><span class="line">                    <span class="string">&#x27;enabled&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">                    <span class="string">&#x27;url&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;events&#x27;</span>: [<span class="string">&#x27;download_completed&#x27;</span>, <span class="string">&#x27;download_failed&#x27;</span>]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        self.save_config()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_config</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;保存配置到文件&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            os.makedirs(os.path.dirname(self.config_file), exist_ok=<span class="literal">True</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(self.config_file, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                <span class="keyword">if</span> self.config_file.endswith(<span class="string">&#x27;.json&#x27;</span>):</span><br><span class="line">                    json.dump(self.config, f, indent=<span class="number">2</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    yaml.dump(self.config, f, default_flow_style=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;保存配置文件失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, key: <span class="built_in">str</span>, default: <span class="type">Any</span> = <span class="literal">None</span></span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取配置值&quot;&quot;&quot;</span></span><br><span class="line">        keys = key.split(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">        value = self.config</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> keys:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(value, <span class="built_in">dict</span>) <span class="keyword">and</span> k <span class="keyword">in</span> value:</span><br><span class="line">                value = value[k]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> default</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="type">Any</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;设置配置值&quot;&quot;&quot;</span></span><br><span class="line">        keys = key.split(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">        config = self.config</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 导航到嵌套字典</span></span><br><span class="line">        <span class="keyword">for</span> i, k <span class="keyword">in</span> <span class="built_in">enumerate</span>(keys[:-<span class="number">1</span>]):</span><br><span class="line">            <span class="keyword">if</span> k <span class="keyword">not</span> <span class="keyword">in</span> config:</span><br><span class="line">                config[k] = &#123;&#125;</span><br><span class="line">            config = config[k]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 设置值</span></span><br><span class="line">        config[keys[-<span class="number">1</span>]] = value</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 保存配置</span></span><br><span class="line">        self.save_config()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">self, updates: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;批量更新配置&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> updates.items():</span><br><span class="line">            self.<span class="built_in">set</span>(key, value)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_download_dir</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取下载目录&quot;&quot;&quot;</span></span><br><span class="line">        download_dir = self.get(<span class="string">&#x27;general.download_dir&#x27;</span>, <span class="string">&#x27;downloads&#x27;</span>)</span><br><span class="line">        os.makedirs(download_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> download_dir</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_temp_dir</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取临时目录&quot;&quot;&quot;</span></span><br><span class="line">        temp_dir = self.get(<span class="string">&#x27;general.temp_dir&#x27;</span>, <span class="string">&#x27;temp&#x27;</span>)</span><br><span class="line">        os.makedirs(temp_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> temp_dir</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_resume_dir</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取续传目录&quot;&quot;&quot;</span></span><br><span class="line">        resume_dir = self.get(<span class="string">&#x27;general.resume_dir&#x27;</span>, <span class="string">&#x27;.resume&#x27;</span>)</span><br><span class="line">        os.makedirs(resume_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> resume_dir</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局配置实例</span></span><br><span class="line">settings = Settings()</span><br></pre></td></tr></table></figure>



<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># config/default_settings.yaml</span></span><br><span class="line"><span class="comment"># 下载管理器默认配置</span></span><br><span class="line"></span><br><span class="line"><span class="attr">general:</span></span><br><span class="line">  <span class="comment"># 最大下载线程数</span></span><br><span class="line">  <span class="attr">max_threads:</span> <span class="number">4</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 分块大小（字节）</span></span><br><span class="line">  <span class="attr">chunk_size:</span> <span class="number">1048576</span>  <span class="comment"># 1MB</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 最大并发下载数</span></span><br><span class="line">  <span class="attr">max_concurrent:</span> <span class="number">3</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 下载目录</span></span><br><span class="line">  <span class="attr">download_dir:</span> <span class="string">downloads</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 临时文件目录</span></span><br><span class="line">  <span class="attr">temp_dir:</span> <span class="string">temp</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 续传文件目录</span></span><br><span class="line">  <span class="attr">resume_dir:</span> <span class="string">.resume</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 日志级别：DEBUG, INFO, WARNING, ERROR, CRITICAL</span></span><br><span class="line">  <span class="attr">log_level:</span> <span class="string">INFO</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 语言设置</span></span><br><span class="line">  <span class="attr">language:</span> <span class="string">zh_CN</span></span><br><span class="line"></span><br><span class="line"><span class="attr">speed_limit:</span></span><br><span class="line">  <span class="comment"># 下载速度限制（字节/秒），null表示无限制</span></span><br><span class="line">  <span class="attr">download:</span> <span class="literal">null</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 上传速度限制（字节/秒），null表示无限制</span></span><br><span class="line">  <span class="attr">upload:</span> <span class="literal">null</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 是否启用速度限制</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">proxy:</span></span><br><span class="line">  <span class="comment"># 是否启用代理</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 是否自动选择最佳代理</span></span><br><span class="line">  <span class="attr">auto_select:</span> <span class="literal">true</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 代理服务器列表</span></span><br><span class="line">  <span class="attr">proxies:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;代理1&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">&quot;http&quot;</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">&quot;http://proxy1.example.com:8080&quot;</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;代理2&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">&quot;socks5&quot;</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">&quot;socks5://proxy2.example.com:1080&quot;</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">queue:</span></span><br><span class="line">  <span class="comment"># 是否自动开始下载</span></span><br><span class="line">  <span class="attr">auto_start:</span> <span class="literal">true</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 是否重试失败的下载</span></span><br><span class="line">  <span class="attr">retry_failed:</span> <span class="literal">true</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 最大重试次数</span></span><br><span class="line">  <span class="attr">max_retries:</span> <span class="number">3</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 重试延迟（秒）</span></span><br><span class="line">  <span class="attr">retry_delay:</span> <span class="number">60</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 队列优先级：FIFO（先进先出）、PRIORITY（优先级）、SIZE（文件大小）</span></span><br><span class="line">  <span class="attr">priority_mode:</span> <span class="string">&quot;PRIORITY&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">scheduler:</span></span><br><span class="line">  <span class="comment"># 是否启用计划任务</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 检查间隔（秒）</span></span><br><span class="line">  <span class="attr">check_interval:</span> <span class="number">60</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rss:</span></span><br><span class="line">  <span class="comment"># 是否启用RSS订阅</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 是否自动下载新项目</span></span><br><span class="line">  <span class="attr">auto_download:</span> <span class="literal">false</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 检查间隔（秒）</span></span><br><span class="line">  <span class="attr">check_interval:</span> <span class="number">3600</span></span><br><span class="line"></span><br><span class="line"><span class="attr">web:</span></span><br><span class="line">  <span class="comment"># Web服务器主机</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Web服务器端口</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5000</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 调试模式</span></span><br><span class="line">  <span class="attr">debug:</span> <span class="literal">false</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 密钥</span></span><br><span class="line">  <span class="attr">secret_key:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 静态文件目录</span></span><br><span class="line">  <span class="attr">static_dir:</span> <span class="string">&quot;static&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 模板目录</span></span><br><span class="line">  <span class="attr">template_dir:</span> <span class="string">&quot;templates&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">security:</span></span><br><span class="line">  <span class="comment"># 是否需要认证</span></span><br><span class="line">  <span class="attr">require_auth:</span> <span class="literal">true</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 会话超时时间（秒）</span></span><br><span class="line">  <span class="attr">session_timeout:</span> <span class="number">3600</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 请求频率限制（每分钟）</span></span><br><span class="line">  <span class="attr">rate_limit:</span> <span class="number">100</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 允许的IP列表（空表示允许所有）</span></span><br><span class="line">  <span class="attr">allowed_ips:</span> []</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 禁止的IP列表</span></span><br><span class="line">  <span class="attr">blocked_ips:</span> []</span><br><span class="line"></span><br><span class="line"><span class="attr">notifications:</span></span><br><span class="line">  <span class="comment"># 是否启用通知</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">email:</span></span><br><span class="line">    <span class="comment"># 是否启用邮件通知</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># SMTP服务器</span></span><br><span class="line">    <span class="attr">smtp_server:</span> <span class="string">&quot;smtp.example.com&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># SMTP端口</span></span><br><span class="line">    <span class="attr">smtp_port:</span> <span class="number">587</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 用户名</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">&quot;user@example.com&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 密码</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 发件人邮箱</span></span><br><span class="line">    <span class="attr">from_email:</span> <span class="string">&quot;noreply@example.com&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 收件人邮箱</span></span><br><span class="line">    <span class="attr">to_email:</span> <span class="string">&quot;admin@example.com&quot;</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">webhook:</span></span><br><span class="line">    <span class="comment"># 是否启用Webhook通知</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Webhook URL</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">&quot;https://example.com/webhook&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 触发事件</span></span><br><span class="line">    <span class="attr">events:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;download_started&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;download_completed&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;download_failed&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;download_paused&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;download_resumed&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;queue_empty&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">database:</span></span><br><span class="line">  <span class="comment"># 数据库类型：sqlite, mysql, postgresql</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">&quot;sqlite&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 数据库连接字符串</span></span><br><span class="line">  <span class="comment"># SQLite: sqlite:///downloads.db</span></span><br><span class="line">  <span class="comment"># MySQL: mysql://user:password@localhost/downloads</span></span><br><span class="line">  <span class="comment"># PostgreSQL: postgresql://user:password@localhost/downloads</span></span><br><span class="line">  <span class="attr">connection_string:</span> <span class="string">&quot;sqlite:///downloads.db&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="comment"># 日志文件路径</span></span><br><span class="line">  <span class="attr">file:</span> <span class="string">&quot;download_manager.log&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 日志格式</span></span><br><span class="line">  <span class="attr">format:</span> <span class="string">&quot;%(asctime)s - %(name)s - %(levelname)s - %(message)s&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 日志文件最大大小（字节）</span></span><br><span class="line">  <span class="attr">max_size:</span> <span class="number">10485760</span>  <span class="comment"># 10MB</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 保留的日志文件数量</span></span><br><span class="line">  <span class="attr">backup_count:</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件类型设置</span></span><br><span class="line"><span class="attr">file_types:</span></span><br><span class="line">  <span class="attr">images:</span></span><br><span class="line">    <span class="attr">extensions:</span> [<span class="string">&quot;.jpg&quot;</span>, <span class="string">&quot;.jpeg&quot;</span>, <span class="string">&quot;.png&quot;</span>, <span class="string">&quot;.gif&quot;</span>, <span class="string">&quot;.bmp&quot;</span>, <span class="string">&quot;.webp&quot;</span>, <span class="string">&quot;.svg&quot;</span>]</span><br><span class="line">    <span class="attr">default_dir:</span> <span class="string">&quot;images&quot;</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">videos:</span></span><br><span class="line">    <span class="attr">extensions:</span> [<span class="string">&quot;.mp4&quot;</span>, <span class="string">&quot;.avi&quot;</span>, <span class="string">&quot;.mkv&quot;</span>, <span class="string">&quot;.mov&quot;</span>, <span class="string">&quot;.wmv&quot;</span>, <span class="string">&quot;.flv&quot;</span>, <span class="string">&quot;.webm&quot;</span>]</span><br><span class="line">    <span class="attr">default_dir:</span> <span class="string">&quot;videos&quot;</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">audio:</span></span><br><span class="line">    <span class="attr">extensions:</span> [<span class="string">&quot;.mp3&quot;</span>, <span class="string">&quot;.wav&quot;</span>, <span class="string">&quot;.flac&quot;</span>, <span class="string">&quot;.ogg&quot;</span>, <span class="string">&quot;.m4a&quot;</span>, <span class="string">&quot;.aac&quot;</span>]</span><br><span class="line">    <span class="attr">default_dir:</span> <span class="string">&quot;audio&quot;</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">documents:</span></span><br><span class="line">    <span class="attr">extensions:</span> [<span class="string">&quot;.pdf&quot;</span>, <span class="string">&quot;.doc&quot;</span>, <span class="string">&quot;.docx&quot;</span>, <span class="string">&quot;.xls&quot;</span>, <span class="string">&quot;.xlsx&quot;</span>, <span class="string">&quot;.ppt&quot;</span>, <span class="string">&quot;.pptx&quot;</span>, <span class="string">&quot;.txt&quot;</span>]</span><br><span class="line">    <span class="attr">default_dir:</span> <span class="string">&quot;documents&quot;</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">archives:</span></span><br><span class="line">    <span class="attr">extensions:</span> [<span class="string">&quot;.zip&quot;</span>, <span class="string">&quot;.rar&quot;</span>, <span class="string">&quot;.7z&quot;</span>, <span class="string">&quot;.tar&quot;</span>, <span class="string">&quot;.gz&quot;</span>, <span class="string">&quot;.bz2&quot;</span>]</span><br><span class="line">    <span class="attr">default_dir:</span> <span class="string">&quot;archives&quot;</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">programs:</span></span><br><span class="line">    <span class="attr">extensions:</span> [<span class="string">&quot;.exe&quot;</span>, <span class="string">&quot;.msi&quot;</span>, <span class="string">&quot;.dmg&quot;</span>, <span class="string">&quot;.pkg&quot;</span>, <span class="string">&quot;.deb&quot;</span>, <span class="string">&quot;.rpm&quot;</span>, <span class="string">&quot;.apk&quot;</span>]</span><br><span class="line">    <span class="attr">default_dir:</span> <span class="string">&quot;programs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 浏览器集成</span></span><br><span class="line"><span class="attr">browser_integration:</span></span><br><span class="line">  <span class="comment"># 是否启用浏览器集成</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 浏览器扩展</span></span><br><span class="line">  <span class="attr">extension:</span></span><br><span class="line">    <span class="attr">chrome:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">firefox:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">edge:</span> <span class="literal">false</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 监听的端口</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5001</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 允许的域名</span></span><br><span class="line">  <span class="attr">allowed_domains:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;localhost&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;127.0.0.1&quot;</span></span><br></pre></td></tr></table></figure>



<h2 id="5-Docker支持"><a href="#5-Docker支持" class="headerlink" title="5. Docker支持"></a>5. Docker支持</h2><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker/Dockerfile</span></span><br><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.9</span>-slim</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置工作目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line"><span class="keyword">ENV</span> PYTHONDONTWRITEBYTECODE=<span class="number">1</span></span><br><span class="line"><span class="keyword">ENV</span> PYTHONUNBUFFERED=<span class="number">1</span></span><br><span class="line"><span class="keyword">ENV</span> FLASK_APP=web/app.py</span><br><span class="line"><span class="keyword">ENV</span> FLASK_ENV=production</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装系统依赖</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y \</span></span><br><span class="line"><span class="language-bash">    gcc \</span></span><br><span class="line"><span class="language-bash">    g++ \</span></span><br><span class="line"><span class="language-bash">    curl \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制依赖文件</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> requirements.txt .</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> requirements-dev.txt .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装Python依赖</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install --no-cache-dir -r requirements.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制应用代码</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建必要的目录</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p downloads temp uploads .resume logs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建非root用户</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> useradd -m -u 1000 downloader &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">chown</span> -R downloader:downloader /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到非root用户</span></span><br><span class="line"><span class="keyword">USER</span> downloader</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">5000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 健康检查</span></span><br><span class="line"><span class="keyword">HEALTHCHECK</span><span class="language-bash"> --interval=30s --<span class="built_in">timeout</span>=3s --start-period=5s --retries=3 \</span></span><br><span class="line"><span class="language-bash">    CMD curl -f http://localhost:5000/api/health || <span class="built_in">exit</span> 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动命令</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;python&quot;</span>, <span class="string">&quot;web/app.py&quot;</span>]</span></span><br></pre></td></tr></table></figure>



<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker/docker-compose.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">download-manager:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">..</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">docker/Dockerfile</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">download-manager</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;5000:5000&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">download-data:/app/downloads</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">config-data:/app/config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">temp-data:/app/temp</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">resume-data:/app/.resume</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">logs-data:/app/logs</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">FLASK_ENV=production</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DATABASE_URL=sqlite:////app/data/downloads.db</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost:5000/api/health&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">start_period:</span> <span class="string">40s</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">download-network</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># PostgreSQL数据库（可选）</span></span><br><span class="line">  <span class="attr">postgres:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:13-alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">download-db</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_USER=downloader</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_PASSWORD=download123</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_DB=downloads</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">postgres-data:/var/lib/postgresql/data</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">download-network</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD-SHELL&quot;</span>, <span class="string">&quot;pg_isready -U downloader&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Redis缓存（可选）</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:6-alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">download-cache</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--appendonly</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-data:/data</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">download-network</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;redis-cli&quot;</span>, <span class="string">&quot;ping&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Nginx反向代理（可选）</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">download-proxy</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;443:443&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx.conf:/etc/nginx/nginx.conf:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./ssl:/etc/nginx/ssl:ro</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">download-manager</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">download-network</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">download-data:</span></span><br><span class="line">  <span class="attr">config-data:</span></span><br><span class="line">  <span class="attr">temp-data:</span></span><br><span class="line">  <span class="attr">resume-data:</span></span><br><span class="line">  <span class="attr">logs-data:</span></span><br><span class="line">  <span class="attr">postgres-data:</span></span><br><span class="line">  <span class="attr">redis-data:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">download-network:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure>



<h2 id="6-浏览器扩展"><a href="#6-浏览器扩展" class="headerlink" title="6. 浏览器扩展"></a>6. 浏览器扩展</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// web/extensions/browser_extension/manifest.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;manifest_version&quot;</span>: <span class="number">3</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;下载管理器助手&quot;</span>,</span><br><span class="line">  <span class="string">&quot;version&quot;</span>: <span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;与本地下载管理器集成，轻松添加下载任务&quot;</span>,</span><br><span class="line">  <span class="string">&quot;permissions&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;activeTab&quot;</span>,</span><br><span class="line">    <span class="string">&quot;downloads&quot;</span>,</span><br><span class="line">    <span class="string">&quot;contextMenus&quot;</span>,</span><br><span class="line">    <span class="string">&quot;storage&quot;</span>,</span><br><span class="line">    <span class="string">&quot;notifications&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;host_permissions&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;http://localhost:5000/*&quot;</span>,</span><br><span class="line">    <span class="string">&quot;http://127.0.0.1:5000/*&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;background&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;service_worker&quot;</span>: <span class="string">&quot;background.js&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;content_scripts&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;matches&quot;</span>: [<span class="string">&quot;&lt;all_urls&gt;&quot;</span>],</span><br><span class="line">      <span class="string">&quot;js&quot;</span>: [<span class="string">&quot;content.js&quot;</span>],</span><br><span class="line">      <span class="string">&quot;css&quot;</span>: [<span class="string">&quot;content.css&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;action&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;default_popup&quot;</span>: <span class="string">&quot;popup.html&quot;</span>,</span><br><span class="line">    <span class="string">&quot;default_title&quot;</span>: <span class="string">&quot;下载管理器&quot;</span>,</span><br><span class="line">    <span class="string">&quot;default_icon&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;16&quot;</span>: <span class="string">&quot;icons/icon16.png&quot;</span>,</span><br><span class="line">      <span class="string">&quot;48&quot;</span>: <span class="string">&quot;icons/icon48.png&quot;</span>,</span><br><span class="line">      <span class="string">&quot;128&quot;</span>: <span class="string">&quot;icons/icon128.png&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;icons&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;16&quot;</span>: <span class="string">&quot;icons/icon16.png&quot;</span>,</span><br><span class="line">    <span class="string">&quot;48&quot;</span>: <span class="string">&quot;icons/icon48.png&quot;</span>,</span><br><span class="line">    <span class="string">&quot;128&quot;</span>: <span class="string">&quot;icons/icon128.png&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;web_accessible_resources&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;resources&quot;</span>: [<span class="string">&quot;inject.js&quot;</span>],</span><br><span class="line">      <span class="string">&quot;matches&quot;</span>: [<span class="string">&quot;&lt;all_urls&gt;&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// web/extensions/browser_extension/background.js</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">DOWNLOAD_MANAGER_URL</span> = <span class="string">&#x27;http://localhost:5000&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听扩展安装</span></span><br><span class="line">chrome.<span class="property">runtime</span>.<span class="property">onInstalled</span>.<span class="title function_">addListener</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;下载管理器扩展已安装&#x27;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 创建右键菜单</span></span><br><span class="line">  chrome.<span class="property">contextMenus</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="string">&quot;download-with-manager&quot;</span>,</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&quot;使用下载管理器下载&quot;</span>,</span><br><span class="line">    <span class="attr">contexts</span>: [<span class="string">&quot;link&quot;</span>, <span class="string">&quot;image&quot;</span>, <span class="string">&quot;video&quot;</span>, <span class="string">&quot;audio&quot;</span>]</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  chrome.<span class="property">contextMenus</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="string">&quot;download-page-media&quot;</span>,</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&quot;下载页面所有媒体文件&quot;</span>,</span><br><span class="line">    <span class="attr">contexts</span>: [<span class="string">&quot;page&quot;</span>]</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听右键菜单点击</span></span><br><span class="line">chrome.<span class="property">contextMenus</span>.<span class="property">onClicked</span>.<span class="title function_">addListener</span>(<span class="function">(<span class="params">info, tab</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (info.<span class="property">menuItemId</span> === <span class="string">&quot;download-with-manager&quot;</span>) &#123;</span><br><span class="line">    <span class="comment">// 获取链接URL</span></span><br><span class="line">    <span class="keyword">let</span> url = info.<span class="property">srcUrl</span> || info.<span class="property">linkUrl</span>;</span><br><span class="line">    <span class="keyword">if</span> (url) &#123;</span><br><span class="line">      <span class="title function_">sendToDownloadManager</span>(url, tab.<span class="property">title</span> || <span class="string">&#x27;未知文件&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (info.<span class="property">menuItemId</span> === <span class="string">&quot;download-page-media&quot;</span>) &#123;</span><br><span class="line">    <span class="comment">// 通知内容脚本提取页面媒体</span></span><br><span class="line">    chrome.<span class="property">tabs</span>.<span class="title function_">sendMessage</span>(tab.<span class="property">id</span>, &#123; <span class="attr">action</span>: <span class="string">&quot;extractMedia&quot;</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听浏览器下载事件</span></span><br><span class="line">chrome.<span class="property">downloads</span>.<span class="property">onCreated</span>.<span class="title function_">addListener</span>(<span class="function">(<span class="params">downloadItem</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 可选：拦截浏览器下载并转发到下载管理器</span></span><br><span class="line">  <span class="keyword">const</span> settings = <span class="title function_">getSettings</span>();</span><br><span class="line">  <span class="keyword">if</span> (settings.<span class="property">interceptDownloads</span>) &#123;</span><br><span class="line">    chrome.<span class="property">downloads</span>.<span class="title function_">cancel</span>(downloadItem.<span class="property">id</span>);</span><br><span class="line">    <span class="title function_">sendToDownloadManager</span>(downloadItem.<span class="property">url</span>, downloadItem.<span class="property">filename</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送到下载管理器</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sendToDownloadManager</span>(<span class="params">url, filename</span>) &#123;</span><br><span class="line">  <span class="title function_">fetch</span>(<span class="string">`<span class="subst">$&#123;DOWNLOAD_MANAGER_URL&#125;</span>/api/download`</span>, &#123;</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">      <span class="attr">url</span>: url,</span><br><span class="line">      <span class="attr">save_path</span>: filename,</span><br><span class="line">      <span class="attr">source</span>: <span class="string">&#x27;browser_extension&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (data.<span class="property">success</span>) &#123;</span><br><span class="line">      <span class="title function_">showNotification</span>(<span class="string">&#x27;下载任务已添加&#x27;</span>, <span class="string">`已添加到下载管理器: <span class="subst">$&#123;filename&#125;</span>`</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">showNotification</span>(<span class="string">&#x27;添加失败&#x27;</span>, data.<span class="property">error</span> || <span class="string">&#x27;未知错误&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;连接到下载管理器失败:&#x27;</span>, error);</span><br><span class="line">    <span class="title function_">showNotification</span>(<span class="string">&#x27;连接失败&#x27;</span>, <span class="string">&#x27;无法连接到下载管理器，请确保服务正在运行&#x27;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示通知</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showNotification</span>(<span class="params">title, message</span>) &#123;</span><br><span class="line">  chrome.<span class="property">notifications</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;basic&#x27;</span>,</span><br><span class="line">    <span class="attr">iconUrl</span>: <span class="string">&#x27;icons/icon128.png&#x27;</span>,</span><br><span class="line">    <span class="attr">title</span>: title,</span><br><span class="line">    <span class="attr">message</span>: message</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取设置</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getSettings</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    chrome.<span class="property">storage</span>.<span class="property">local</span>.<span class="title function_">get</span>([<span class="string">&#x27;settings&#x27;</span>], <span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">resolve</span>(result.<span class="property">settings</span> || &#123;</span><br><span class="line">        <span class="attr">interceptDownloads</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">autoDownload</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">serverUrl</span>: <span class="variable constant_">DOWNLOAD_MANAGER_URL</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存设置</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">saveSettings</span>(<span class="params">settings</span>) &#123;</span><br><span class="line">  chrome.<span class="property">storage</span>.<span class="property">local</span>.<span class="title function_">set</span>(&#123; settings &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听来自popup的消息</span></span><br><span class="line">chrome.<span class="property">runtime</span>.<span class="property">onMessage</span>.<span class="title function_">addListener</span>(<span class="function">(<span class="params">request, sender, sendResponse</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (request.<span class="property">action</span> === <span class="string">&#x27;getSettings&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_">getSettings</span>().<span class="title function_">then</span>(<span class="function"><span class="params">settings</span> =&gt;</span> <span class="title function_">sendResponse</span>(settings));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// 保持消息通道开放</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (request.<span class="property">action</span> === <span class="string">&#x27;saveSettings&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_">saveSettings</span>(request.<span class="property">settings</span>);</span><br><span class="line">    <span class="title function_">sendResponse</span>(&#123; <span class="attr">success</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (request.<span class="property">action</span> === <span class="string">&#x27;testConnection&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_">testConnection</span>(request.<span class="property">url</span>).<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> <span class="title function_">sendResponse</span>(result));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试连接</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">testConnection</span>(<span class="params">url</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">`<span class="subst">$&#123;url || DOWNLOAD_MANAGER_URL&#125;</span>/api/health`</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> (&#123; <span class="attr">success</span>: response.<span class="property">ok</span> &#125;))</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function">() =&gt;</span> (&#123; <span class="attr">success</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// web/extensions/browser_extension/content.js</span></span><br><span class="line"><span class="comment">// 监听来自背景脚本的消息</span></span><br><span class="line">chrome.<span class="property">runtime</span>.<span class="property">onMessage</span>.<span class="title function_">addListener</span>(<span class="function">(<span class="params">request, sender, sendResponse</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (request.<span class="property">action</span> === <span class="string">&quot;extractMedia&quot;</span>) &#123;</span><br><span class="line">    <span class="title function_">extractMediaLinks</span>().<span class="title function_">then</span>(<span class="function"><span class="params">links</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">sendResponse</span>(&#123; <span class="attr">links</span>: links &#125;);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 显示提取结果</span></span><br><span class="line">      <span class="title function_">showMediaExtractor</span>(links);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// 保持消息通道开放</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 提取页面媒体链接</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">extractMediaLinks</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> links = [];</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 提取图片</span></span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;img&#x27;</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">img</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> src = img.<span class="property">src</span> || img.<span class="property">dataset</span>.<span class="property">src</span>;</span><br><span class="line">    <span class="keyword">if</span> (src &amp;&amp; src.<span class="title function_">startsWith</span>(<span class="string">&#x27;http&#x27;</span>)) &#123;</span><br><span class="line">      links.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">url</span>: src,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;image&#x27;</span>,</span><br><span class="line">        <span class="attr">filename</span>: src.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>).<span class="title function_">pop</span>() || <span class="string">&#x27;image.jpg&#x27;</span>,</span><br><span class="line">        <span class="attr">element</span>: img</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 提取视频</span></span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;video&#x27;</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">video</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> src = video.<span class="property">src</span>;</span><br><span class="line">    <span class="keyword">if</span> (src &amp;&amp; src.<span class="title function_">startsWith</span>(<span class="string">&#x27;http&#x27;</span>)) &#123;</span><br><span class="line">      links.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">url</span>: src,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;video&#x27;</span>,</span><br><span class="line">        <span class="attr">filename</span>: src.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>).<span class="title function_">pop</span>() || <span class="string">&#x27;video.mp4&#x27;</span>,</span><br><span class="line">        <span class="attr">element</span>: video</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查source标签</span></span><br><span class="line">    video.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;source&#x27;</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">source</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> src = source.<span class="property">src</span>;</span><br><span class="line">      <span class="keyword">if</span> (src &amp;&amp; src.<span class="title function_">startsWith</span>(<span class="string">&#x27;http&#x27;</span>)) &#123;</span><br><span class="line">        links.<span class="title function_">push</span>(&#123;</span><br><span class="line">          <span class="attr">url</span>: src,</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;video&#x27;</span>,</span><br><span class="line">          <span class="attr">filename</span>: src.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>).<span class="title function_">pop</span>() || <span class="string">&#x27;video.mp4&#x27;</span>,</span><br><span class="line">          <span class="attr">element</span>: source</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 提取音频</span></span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;audio&#x27;</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">audio</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> src = audio.<span class="property">src</span>;</span><br><span class="line">    <span class="keyword">if</span> (src &amp;&amp; src.<span class="title function_">startsWith</span>(<span class="string">&#x27;http&#x27;</span>)) &#123;</span><br><span class="line">      links.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">url</span>: src,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;audio&#x27;</span>,</span><br><span class="line">        <span class="attr">filename</span>: src.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>).<span class="title function_">pop</span>() || <span class="string">&#x27;audio.mp3&#x27;</span>,</span><br><span class="line">        <span class="attr">element</span>: audio</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 提取文件下载链接</span></span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;a[href]&#x27;</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">link</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> href = link.<span class="property">href</span>;</span><br><span class="line">    <span class="keyword">const</span> text = link.<span class="property">textContent</span>.<span class="title function_">trim</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查是否是文件链接</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isFileLink</span>(href)) &#123;</span><br><span class="line">      links.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">url</span>: href,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;file&#x27;</span>,</span><br><span class="line">        <span class="attr">filename</span>: text || href.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>).<span class="title function_">pop</span>() || <span class="string">&#x27;file&#x27;</span>,</span><br><span class="line">        <span class="attr">element</span>: link</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(links);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查是否是文件链接</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isFileLink</span>(<span class="params">url</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> fileExtensions = [</span><br><span class="line">    <span class="string">&#x27;.zip&#x27;</span>, <span class="string">&#x27;.rar&#x27;</span>, <span class="string">&#x27;.7z&#x27;</span>, <span class="string">&#x27;.tar&#x27;</span>, <span class="string">&#x27;.gz&#x27;</span>, <span class="string">&#x27;.bz2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;.pdf&#x27;</span>, <span class="string">&#x27;.doc&#x27;</span>, <span class="string">&#x27;.docx&#x27;</span>, <span class="string">&#x27;.xls&#x27;</span>, <span class="string">&#x27;.xlsx&#x27;</span>, <span class="string">&#x27;.ppt&#x27;</span>, <span class="string">&#x27;.pptx&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;.mp4&#x27;</span>, <span class="string">&#x27;.avi&#x27;</span>, <span class="string">&#x27;.mkv&#x27;</span>, <span class="string">&#x27;.mov&#x27;</span>, <span class="string">&#x27;.wmv&#x27;</span>, <span class="string">&#x27;.flv&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;.mp3&#x27;</span>, <span class="string">&#x27;.wav&#x27;</span>, <span class="string">&#x27;.flac&#x27;</span>, <span class="string">&#x27;.ogg&#x27;</span>, <span class="string">&#x27;.m4a&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;.jpg&#x27;</span>, <span class="string">&#x27;.jpeg&#x27;</span>, <span class="string">&#x27;.png&#x27;</span>, <span class="string">&#x27;.gif&#x27;</span>, <span class="string">&#x27;.bmp&#x27;</span>, <span class="string">&#x27;.webp&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;.exe&#x27;</span>, <span class="string">&#x27;.msi&#x27;</span>, <span class="string">&#x27;.dmg&#x27;</span>, <span class="string">&#x27;.pkg&#x27;</span>, <span class="string">&#x27;.deb&#x27;</span>, <span class="string">&#x27;.rpm&#x27;</span>, <span class="string">&#x27;.apk&#x27;</span></span><br><span class="line">  ];</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> fileExtensions.<span class="title function_">some</span>(<span class="function"><span class="params">ext</span> =&gt;</span> url.<span class="title function_">toLowerCase</span>().<span class="title function_">endsWith</span>(ext));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示媒体提取器界面</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showMediaExtractor</span>(<span class="params">links</span>) &#123;</span><br><span class="line">  <span class="comment">// 移除现有的提取器</span></span><br><span class="line">  <span class="keyword">const</span> existingExtractor = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;media-extractor&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span> (existingExtractor) &#123;</span><br><span class="line">    existingExtractor.<span class="title function_">remove</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 创建提取器界面</span></span><br><span class="line">  <span class="keyword">const</span> extractor = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">  extractor.<span class="property">id</span> = <span class="string">&#x27;media-extractor&#x27;</span>;</span><br><span class="line">  extractor.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;media-extractor-container&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;div class=&quot;media-extractor-header&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;h3&gt;发现 <span class="subst">$&#123;links.length&#125;</span> 个媒体文件&lt;/h3&gt;</span></span><br><span class="line"><span class="string">        &lt;button class=&quot;close-extractor&quot;&gt;&amp;times;&lt;/button&gt;</span></span><br><span class="line"><span class="string">      &lt;/div&gt;</span></span><br><span class="line"><span class="string">      &lt;div class=&quot;media-extractor-content&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;media-list&quot;&gt;</span></span><br><span class="line"><span class="string">          <span class="subst">$&#123;links.map((link, index) =&gt; <span class="string">`</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="string">            &lt;div class=&quot;media-item&quot; data-index=&quot;<span class="subst">$&#123;index&#125;</span>&quot;&gt;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="string">              &lt;input type=&quot;checkbox&quot; class=&quot;media-checkbox&quot; checked&gt;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="string">              &lt;span class=&quot;media-type <span class="subst">$&#123;link.type&#125;</span>&quot;&gt;<span class="subst">$&#123;link.type&#125;</span>&lt;/span&gt;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="string">              &lt;span class=&quot;media-filename&quot; title=&quot;<span class="subst">$&#123;link.url&#125;</span>&quot;&gt;<span class="subst">$&#123;link.filename&#125;</span>&lt;/span&gt;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="string">              &lt;span class=&quot;media-size&quot;&gt;<span class="subst">$&#123;link.size || <span class="string">&#x27;未知大小&#x27;</span>&#125;</span>&lt;/span&gt;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="string">            &lt;/div&gt;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="string">          `</span>).join(<span class="string">&#x27;&#x27;</span>)&#125;</span></span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;media-actions&quot;&gt;</span></span><br><span class="line"><span class="string">          &lt;button class=&quot;select-all&quot;&gt;全选&lt;/button&gt;</span></span><br><span class="line"><span class="string">          &lt;button class=&quot;select-none&quot;&gt;全不选&lt;/button&gt;</span></span><br><span class="line"><span class="string">          &lt;button class=&quot;download-selected&quot;&gt;下载选中项&lt;/button&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">      &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(extractor);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 添加事件监听器</span></span><br><span class="line">  extractor.<span class="title function_">querySelector</span>(<span class="string">&#x27;.close-extractor&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    extractor.<span class="title function_">remove</span>();</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  extractor.<span class="title function_">querySelector</span>(<span class="string">&#x27;.select-all&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    extractor.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.media-checkbox&#x27;</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">checkbox</span> =&gt;</span> &#123;</span><br><span class="line">      checkbox.<span class="property">checked</span> = <span class="literal">true</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  extractor.<span class="title function_">querySelector</span>(<span class="string">&#x27;.select-none&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    extractor.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.media-checkbox&#x27;</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">checkbox</span> =&gt;</span> &#123;</span><br><span class="line">      checkbox.<span class="property">checked</span> = <span class="literal">false</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  extractor.<span class="title function_">querySelector</span>(<span class="string">&#x27;.download-selected&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> selectedLinks = [];</span><br><span class="line">    extractor.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.media-item&#x27;</span>).<span class="title function_">forEach</span>(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> checkbox = item.<span class="title function_">querySelector</span>(<span class="string">&#x27;.media-checkbox&#x27;</span>);</span><br><span class="line">      <span class="keyword">if</span> (checkbox.<span class="property">checked</span>) &#123;</span><br><span class="line">        selectedLinks.<span class="title function_">push</span>(links[index]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (selectedLinks.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="title function_">sendLinksToDownloadManager</span>(selectedLinks);</span><br><span class="line">      extractor.<span class="title function_">remove</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 点击外部关闭</span></span><br><span class="line">  extractor.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (e.<span class="property">target</span> === extractor) &#123;</span><br><span class="line">      extractor.<span class="title function_">remove</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送链接到下载管理器</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sendLinksToDownloadManager</span>(<span class="params">links</span>) &#123;</span><br><span class="line">  links.<span class="title function_">forEach</span>(<span class="function"><span class="params">link</span> =&gt;</span> &#123;</span><br><span class="line">    chrome.<span class="property">runtime</span>.<span class="title function_">sendMessage</span>(&#123;</span><br><span class="line">      <span class="attr">action</span>: <span class="string">&#x27;downloadLink&#x27;</span>,</span><br><span class="line">      <span class="attr">url</span>: link.<span class="property">url</span>,</span><br><span class="line">      <span class="attr">filename</span>: link.<span class="property">filename</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 显示通知</span></span><br><span class="line">  <span class="keyword">const</span> notification = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">  notification.<span class="property">className</span> = <span class="string">&#x27;download-notification&#x27;</span>;</span><br><span class="line">  notification.<span class="property">textContent</span> = <span class="string">`已添加 <span class="subst">$&#123;links.length&#125;</span> 个文件到下载队列`</span>;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(notification);</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    notification.<span class="title function_">remove</span>();</span><br><span class="line">  &#125;, <span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注入CSS</span></span><br><span class="line"><span class="keyword">const</span> style = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;style&#x27;</span>);</span><br><span class="line">style.<span class="property">textContent</span> = <span class="string">`</span></span><br><span class="line"><span class="string">  #media-extractor &#123;</span></span><br><span class="line"><span class="string">    position: fixed;</span></span><br><span class="line"><span class="string">    top: 0;</span></span><br><span class="line"><span class="string">    left: 0;</span></span><br><span class="line"><span class="string">    right: 0;</span></span><br><span class="line"><span class="string">    bottom: 0;</span></span><br><span class="line"><span class="string">    background: rgba(0, 0, 0, 0.5);</span></span><br><span class="line"><span class="string">    display: flex;</span></span><br><span class="line"><span class="string">    align-items: center;</span></span><br><span class="line"><span class="string">    justify-content: center;</span></span><br><span class="line"><span class="string">    z-index: 10000;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  .media-extractor-container &#123;</span></span><br><span class="line"><span class="string">    background: white;</span></span><br><span class="line"><span class="string">    border-radius: 8px;</span></span><br><span class="line"><span class="string">    width: 80%;</span></span><br><span class="line"><span class="string">    max-width: 600px;</span></span><br><span class="line"><span class="string">    max-height: 80%;</span></span><br><span class="line"><span class="string">    overflow: hidden;</span></span><br><span class="line"><span class="string">    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  .media-extractor-header &#123;</span></span><br><span class="line"><span class="string">    background: #4f46e5;</span></span><br><span class="line"><span class="string">    color: white;</span></span><br><span class="line"><span class="string">    padding: 15px 20px;</span></span><br><span class="line"><span class="string">    display: flex;</span></span><br><span class="line"><span class="string">    justify-content: space-between;</span></span><br><span class="line"><span class="string">    align-items: center;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  .media-extractor-header h3 &#123;</span></span><br><span class="line"><span class="string">    margin: 0;</span></span><br><span class="line"><span class="string">    font-size: 16px;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  .close-extractor &#123;</span></span><br><span class="line"><span class="string">    background: none;</span></span><br><span class="line"><span class="string">    border: none;</span></span><br><span class="line"><span class="string">    color: white;</span></span><br><span class="line"><span class="string">    font-size: 24px;</span></span><br><span class="line"><span class="string">    cursor: pointer;</span></span><br><span class="line"><span class="string">    line-height: 1;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  .media-extractor-content &#123;</span></span><br><span class="line"><span class="string">    padding: 20px;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  .media-list &#123;</span></span><br><span class="line"><span class="string">    max-height: 300px;</span></span><br><span class="line"><span class="string">    overflow-y: auto;</span></span><br><span class="line"><span class="string">    margin-bottom: 20px;</span></span><br><span class="line"><span class="string">    border: 1px solid #e2e8f0;</span></span><br><span class="line"><span class="string">    border-radius: 4px;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  .media-item &#123;</span></span><br><span class="line"><span class="string">    display: flex;</span></span><br><span class="line"><span class="string">    align-items: center;</span></span><br><span class="line"><span class="string">    padding: 10px;</span></span><br><span class="line"><span class="string">    border-bottom: 1px solid #e2e8f0;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  .media-item:last-child &#123;</span></span><br><span class="line"><span class="string">    border-bottom: none;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  .media-checkbox &#123;</span></span><br><span class="line"><span class="string">    margin-right: 10px;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  .media-type &#123;</span></span><br><span class="line"><span class="string">    display: inline-block;</span></span><br><span class="line"><span class="string">    padding: 2px 6px;</span></span><br><span class="line"><span class="string">    border-radius: 4px;</span></span><br><span class="line"><span class="string">    font-size: 12px;</span></span><br><span class="line"><span class="string">    margin-right: 10px;</span></span><br><span class="line"><span class="string">    color: white;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  .media-type.image &#123; background: #4299e1; &#125;</span></span><br><span class="line"><span class="string">  .media-type.video &#123; background: #ed8936; &#125;</span></span><br><span class="line"><span class="string">  .media-type.audio &#123; background: #48bb78; &#125;</span></span><br><span class="line"><span class="string">  .media-type.file &#123; background: #9f7aea; &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  .media-filename &#123;</span></span><br><span class="line"><span class="string">    flex: 1;</span></span><br><span class="line"><span class="string">    overflow: hidden;</span></span><br><span class="line"><span class="string">    text-overflow: ellipsis;</span></span><br><span class="line"><span class="string">    white-space: nowrap;</span></span><br><span class="line"><span class="string">    font-family: monospace;</span></span><br><span class="line"><span class="string">    font-size: 12px;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  .media-size &#123;</span></span><br><span class="line"><span class="string">    color: #718096;</span></span><br><span class="line"><span class="string">    font-size: 12px;</span></span><br><span class="line"><span class="string">    margin-left: 10px;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  .media-actions &#123;</span></span><br><span class="line"><span class="string">    display: flex;</span></span><br><span class="line"><span class="string">    gap: 10px;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  .media-actions button &#123;</span></span><br><span class="line"><span class="string">    padding: 8px 16px;</span></span><br><span class="line"><span class="string">    border: none;</span></span><br><span class="line"><span class="string">    border-radius: 4px;</span></span><br><span class="line"><span class="string">    cursor: pointer;</span></span><br><span class="line"><span class="string">    font-size: 14px;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  .media-actions .download-selected &#123;</span></span><br><span class="line"><span class="string">    background: #4f46e5;</span></span><br><span class="line"><span class="string">    color: white;</span></span><br><span class="line"><span class="string">    flex: 1;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  .download-notification &#123;</span></span><br><span class="line"><span class="string">    position: fixed;</span></span><br><span class="line"><span class="string">    bottom: 20px;</span></span><br><span class="line"><span class="string">    right: 20px;</span></span><br><span class="line"><span class="string">    background: #48bb78;</span></span><br><span class="line"><span class="string">    color: white;</span></span><br><span class="line"><span class="string">    padding: 10px 20px;</span></span><br><span class="line"><span class="string">    border-radius: 4px;</span></span><br><span class="line"><span class="string">    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);</span></span><br><span class="line"><span class="string">    z-index: 10001;</span></span><br><span class="line"><span class="string">    animation: slideIn 0.3s ease;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  @keyframes slideIn &#123;</span></span><br><span class="line"><span class="string">    from &#123;</span></span><br><span class="line"><span class="string">      transform: translateY(100px);</span></span><br><span class="line"><span class="string">      opacity: 0;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    to &#123;</span></span><br><span class="line"><span class="string">      transform: translateY(0);</span></span><br><span class="line"><span class="string">      opacity: 1;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">head</span>.<span class="title function_">appendChild</span>(style);</span><br></pre></td></tr></table></figure>



<h2 id="7-完整的requirements-txt"><a href="#7-完整的requirements-txt" class="headerlink" title="7. 完整的requirements.txt"></a>7. 完整的requirements.txt</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"># 基础依赖</span><br><span class="line">Flask==2.3.3</span><br><span class="line">Flask-Login==0.6.2</span><br><span class="line">Flask-CORS==4.0.0</span><br><span class="line">Flask-SQLAlchemy==3.0.5</span><br><span class="line">Flask-Migrate==4.0.5</span><br><span class="line">requests==2.31.0</span><br><span class="line">beautifulsoup4==4.12.2</span><br><span class="line">feedparser==6.0.10</span><br><span class="line">humanize==4.8.0</span><br><span class="line">schedule==1.2.0</span><br><span class="line">pyyaml==6.0.1</span><br><span class="line">python-magic==0.4.27</span><br><span class="line"></span><br><span class="line"># 数据库</span><br><span class="line">SQLAlchemy==2.0.23</span><br><span class="line">alembic==1.12.1</span><br><span class="line">psycopg2-binary==2.9.9  # PostgreSQL</span><br><span class="line">mysqlclient==2.2.0  # MySQL</span><br><span class="line"></span><br><span class="line"># 缓存和队列</span><br><span class="line">redis==5.0.1</span><br><span class="line">celery==5.3.4</span><br><span class="line"></span><br><span class="line"># 异步处理</span><br><span class="line">aiohttp==3.9.1</span><br><span class="line">asyncio==3.4.3</span><br><span class="line"></span><br><span class="line"># 文件处理</span><br><span class="line">Pillow==10.1.0</span><br><span class="line">python-magic-bin==0.4.14  # Windows版</span><br><span class="line"></span><br><span class="line"># 网络工具</span><br><span class="line">urllib3==2.0.7</span><br><span class="line">chardet==5.2.0</span><br><span class="line">idna==3.4</span><br><span class="line"></span><br><span class="line"># 工具库</span><br><span class="line">colorama==0.4.6</span><br><span class="line">tqdm==4.66.1</span><br><span class="line">progress==1.6</span><br><span class="line">click==8.1.7</span><br><span class="line"></span><br><span class="line"># 测试和开发</span><br><span class="line">pytest==7.4.3</span><br><span class="line">pytest-cov==4.1.0</span><br><span class="line">black==23.11.0</span><br><span class="line">flake8==6.1.0</span><br><span class="line">mypy==1.7.0</span><br><span class="line">autopep8==2.0.4</span><br><span class="line"></span><br><span class="line"># 文档生成</span><br><span class="line">sphinx==7.2.6</span><br><span class="line">sphinx-rtd-theme==1.3.0</span><br><span class="line"></span><br><span class="line"># Docker相关</span><br><span class="line">gunicorn==21.2.0</span><br><span class="line">gevent==23.9.1</span><br></pre></td></tr></table></figure>



<h2 id="8-安装和部署脚本"><a href="#8-安装和部署脚本" class="headerlink" title="8. 安装和部署脚本"></a>8. 安装和部署脚本</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># setup.py</span></span><br><span class="line"><span class="keyword">from</span> setuptools <span class="keyword">import</span> setup, find_packages</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;README.md&quot;</span>, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> fh:</span><br><span class="line">    long_description = fh.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;requirements.txt&quot;</span>, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> fh:</span><br><span class="line">    requirements = fh.read().splitlines()</span><br><span class="line"></span><br><span class="line">setup(</span><br><span class="line">    name=<span class="string">&quot;download-manager&quot;</span>,</span><br><span class="line">    version=<span class="string">&quot;2.0.0&quot;</span>,</span><br><span class="line">    author=<span class="string">&quot;下载管理器开发团队&quot;</span>,</span><br><span class="line">    author_email=<span class="string">&quot;contact@example.com&quot;</span>,</span><br><span class="line">    description=<span class="string">&quot;功能强大的多线程下载管理器&quot;</span>,</span><br><span class="line">    long_description=long_description,</span><br><span class="line">    long_description_content_type=<span class="string">&quot;text/markdown&quot;</span>,</span><br><span class="line">    url=<span class="string">&quot;https://github.com/yourusername/download-manager&quot;</span>,</span><br><span class="line">    packages=find_packages(),</span><br><span class="line">    classifiers=[</span><br><span class="line">        <span class="string">&quot;Development Status :: 4 - Beta&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Intended Audience :: End Users/Desktop&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Topic :: Internet :: WWW/HTTP&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Topic :: Utilities&quot;</span>,</span><br><span class="line">        <span class="string">&quot;License :: OSI Approved :: MIT License&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Programming Language :: Python :: 3&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Programming Language :: Python :: 3.9&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Programming Language :: Python :: 3.10&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Programming Language :: Python :: 3.11&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Operating System :: OS Independent&quot;</span>,</span><br><span class="line">    ],</span><br><span class="line">    python_requires=<span class="string">&quot;&gt;=3.9&quot;</span>,</span><br><span class="line">    install_requires=requirements,</span><br><span class="line">    entry_points=&#123;</span><br><span class="line">        <span class="string">&quot;console_scripts&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;download-manager=cli.main:main&quot;</span>,</span><br><span class="line">            <span class="string">&quot;dm-cli=cli.interactive_cli:main&quot;</span>,</span><br><span class="line">            <span class="string">&quot;dm-web=web.app:main&quot;</span>,</span><br><span class="line">        ],</span><br><span class="line">    &#125;,</span><br><span class="line">    include_package_data=<span class="literal">True</span>,</span><br><span class="line">    package_data=&#123;</span><br><span class="line">        <span class="string">&quot;&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;templates/*&quot;</span>,</span><br><span class="line">            <span class="string">&quot;static/*&quot;</span>,</span><br><span class="line">            <span class="string">&quot;config/*&quot;</span>,</span><br><span class="line">            <span class="string">&quot;extensions/*&quot;</span>,</span><br><span class="line">        ],</span><br><span class="line">    &#125;,</span><br><span class="line">    data_files=[</span><br><span class="line">        (<span class="string">&quot;share/applications&quot;</span>, [<span class="string">&quot;download-manager.desktop&quot;</span>]),</span><br><span class="line">        (<span class="string">&quot;share/icons&quot;</span>, [<span class="string">&quot;icons/download-manager.png&quot;</span>]),</span><br><span class="line">        (<span class="string">&quot;share/man/man1&quot;</span>, [<span class="string">&quot;man/download-manager.1&quot;</span>]),</span><br><span class="line">    ],</span><br><span class="line">    scripts=[</span><br><span class="line">        <span class="string">&quot;scripts/download-manager&quot;</span>,</span><br><span class="line">        <span class="string">&quot;scripts/dm-cli&quot;</span>,</span><br><span class="line">        <span class="string">&quot;scripts/dm-web&quot;</span>,</span><br><span class="line">    ],</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># install.sh - 安装脚本</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 颜色定义</span></span><br><span class="line">RED=<span class="string">&#x27;\033[0;31m&#x27;</span></span><br><span class="line">GREEN=<span class="string">&#x27;\033[0;32m&#x27;</span></span><br><span class="line">YELLOW=<span class="string">&#x27;\033[1;33m&#x27;</span></span><br><span class="line">BLUE=<span class="string">&#x27;\033[0;34m&#x27;</span></span><br><span class="line">NC=<span class="string">&#x27;\033[0m&#x27;</span> <span class="comment"># No Color</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印带颜色的信息</span></span><br><span class="line"><span class="function"><span class="title">print_info</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;BLUE&#125;</span>[INFO]<span class="variable">$&#123;NC&#125;</span> <span class="variable">$1</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">print_success</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>[SUCCESS]<span class="variable">$&#123;NC&#125;</span> <span class="variable">$1</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">print_warning</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>[WARNING]<span class="variable">$&#123;NC&#125;</span> <span class="variable">$1</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">print_error</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>[ERROR]<span class="variable">$&#123;NC&#125;</span> <span class="variable">$1</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查命令是否存在</span></span><br><span class="line"><span class="function"><span class="title">check_command</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> ! <span class="built_in">command</span> -v <span class="variable">$1</span> &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">        print_error <span class="string">&quot;<span class="variable">$1</span> 未安装，请先安装 <span class="variable">$1</span>&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查Python版本</span></span><br><span class="line"><span class="function"><span class="title">check_python_version</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> python_cmd=<span class="variable">$1</span></span><br><span class="line">    <span class="built_in">local</span> version=$(<span class="variable">$python_cmd</span> -c <span class="string">&quot;import sys; print(f&#x27;&#123;sys.version_info.major&#125;.&#123;sys.version_info.minor&#125;&#x27;)&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [ $(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$version</span> &lt; 3.9&quot;</span> | bc) -eq 1 ]; <span class="keyword">then</span></span><br><span class="line">        print_error <span class="string">&quot;需要 Python 3.9 或更高版本，当前版本: <span class="variable">$version</span>&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    print_info <span class="string">&quot;Python 版本: <span class="variable">$version</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建虚拟环境</span></span><br><span class="line"><span class="function"><span class="title">create_venv</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> venv_dir=<span class="variable">$1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [ ! -d <span class="string">&quot;<span class="variable">$venv_dir</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        print_info <span class="string">&quot;创建虚拟环境...&quot;</span></span><br><span class="line">        python3 -m venv <span class="string">&quot;<span class="variable">$venv_dir</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">            print_error <span class="string">&quot;创建虚拟环境失败&quot;</span></span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        print_success <span class="string">&quot;虚拟环境创建成功&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        print_warning <span class="string">&quot;虚拟环境已存在&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line"><span class="function"><span class="title">install_dependencies</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> venv_dir=<span class="variable">$1</span></span><br><span class="line">    </span><br><span class="line">    print_info <span class="string">&quot;安装依赖包...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 激活虚拟环境</span></span><br><span class="line">    <span class="built_in">source</span> <span class="string">&quot;<span class="variable">$venv_dir</span>/bin/activate&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 升级pip</span></span><br><span class="line">    pip install --upgrade pip</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 安装依赖</span></span><br><span class="line">    pip install -r requirements.txt</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">        print_error <span class="string">&quot;安装依赖失败&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    print_success <span class="string">&quot;依赖安装成功&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建配置文件</span></span><br><span class="line"><span class="function"><span class="title">create_config</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> config_dir=<span class="variable">$1</span></span><br><span class="line">    </span><br><span class="line">    print_info <span class="string">&quot;创建配置文件...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [ ! -f <span class="string">&quot;<span class="variable">$config_dir</span>/config.yaml&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">cp</span> config/default_settings.yaml <span class="string">&quot;<span class="variable">$config_dir</span>/config.yaml&quot;</span></span><br><span class="line">        print_success <span class="string">&quot;配置文件创建成功&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        print_warning <span class="string">&quot;配置文件已存在，跳过创建&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建数据目录</span></span><br><span class="line"><span class="function"><span class="title">create_data_dirs</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> base_dir=<span class="variable">$1</span></span><br><span class="line">    </span><br><span class="line">    print_info <span class="string">&quot;创建数据目录...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dirs</span>=(<span class="string">&quot;downloads&quot;</span> <span class="string">&quot;temp&quot;</span> <span class="string">&quot;uploads&quot;</span> <span class="string">&quot;.resume&quot;</span> <span class="string">&quot;logs&quot;</span> <span class="string">&quot;database&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">dir</span> <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;dirs[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$base_dir</span>/<span class="variable">$dir</span>&quot;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    </span><br><span class="line">    print_success <span class="string">&quot;数据目录创建成功&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line"><span class="function"><span class="title">setup_environment</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> venv_dir=<span class="variable">$1</span></span><br><span class="line">    </span><br><span class="line">    print_info <span class="string">&quot;设置环境变量...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建环境变量文件</span></span><br><span class="line">    <span class="built_in">cat</span> &gt; .<span class="built_in">env</span> &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string"># 下载管理器环境变量</span></span><br><span class="line"><span class="string">DOWNLOAD_MANAGER_HOME=$(pwd)</span></span><br><span class="line"><span class="string">DOWNLOAD_MANAGER_VENV=$venv_dir</span></span><br><span class="line"><span class="string">DOWNLOAD_MANAGER_CONFIG=config/config.yaml</span></span><br><span class="line"><span class="string">DOWNLOAD_MANAGER_DB=database/downloads.db</span></span><br><span class="line"><span class="string">DOWNLOAD_MANAGER_LOG=logs/download_manager.log</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 添加到PATH</span></span><br><span class="line"><span class="string">export PATH=&quot;\$PATH:$venv_dir/bin&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 添加到bashrc（可选）</span></span><br><span class="line">    <span class="keyword">if</span> [ -f ~/.bashrc ]; <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> ! grep -q <span class="string">&quot;DOWNLOAD_MANAGER_HOME&quot;</span> ~/.bashrc; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;source <span class="subst">$(pwd)</span>/.env&quot;</span> &gt;&gt; ~/.bashrc</span><br><span class="line">            print_success <span class="string">&quot;环境变量已添加到 ~/.bashrc&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    print_success <span class="string">&quot;环境变量设置成功&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建启动脚本</span></span><br><span class="line"><span class="function"><span class="title">create_start_scripts</span></span>() &#123;</span><br><span class="line">    print_info <span class="string">&quot;创建启动脚本...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># CLI启动脚本</span></span><br><span class="line">    <span class="built_in">cat</span> &gt; dm-cli &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="built_in">source</span> venv/bin/activate</span><br><span class="line">python cli/interactive_cli.py <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line">EOF</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Web启动脚本</span></span><br><span class="line">    <span class="built_in">cat</span> &gt; dm-web &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="built_in">source</span> venv/bin/activate</span><br><span class="line">python web/app.py <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line">EOF</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 系统服务脚本</span></span><br><span class="line">    <span class="built_in">cat</span> &gt; download-manager.service &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Download Manager Web Service</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=simple</span></span><br><span class="line"><span class="string">User=$USER</span></span><br><span class="line"><span class="string">WorkingDirectory=$(pwd)</span></span><br><span class="line"><span class="string">Environment=&quot;PATH=$(pwd)/venv/bin&quot;</span></span><br><span class="line"><span class="string">ExecStart=$(pwd)/venv/bin/python web/app.py</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"><span class="string">RestartSec=10</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">chmod</span> +x dm-cli dm-web</span><br><span class="line">    </span><br><span class="line">    print_success <span class="string">&quot;启动脚本创建成功&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装系统服务</span></span><br><span class="line"><span class="function"><span class="title">install_service</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$EUID</span>&quot;</span> -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">        print_warning <span class="string">&quot;需要root权限安装系统服务&quot;</span></span><br><span class="line">        <span class="built_in">return</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    print_info <span class="string">&quot;安装系统服务...&quot;</span></span><br><span class="line">    </span><br><span class="line">    sudo <span class="built_in">cp</span> download-manager.service /etc/systemd/system/</span><br><span class="line">    sudo systemctl daemon-reload</span><br><span class="line">    sudo systemctl <span class="built_in">enable</span> download-manager.service</span><br><span class="line">    </span><br><span class="line">    print_success <span class="string">&quot;系统服务安装成功&quot;</span></span><br><span class="line">    print_info <span class="string">&quot;使用以下命令管理服务:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  sudo systemctl start download-manager   # 启动服务&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  sudo systemctl stop download-manager    # 停止服务&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  sudo systemctl status download-manager  # 查看状态&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装浏览器扩展</span></span><br><span class="line"><span class="function"><span class="title">install_browser_extension</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> browser=<span class="variable">$1</span></span><br><span class="line">    </span><br><span class="line">    print_info <span class="string">&quot;安装浏览器扩展...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$browser</span> <span class="keyword">in</span></span><br><span class="line">        chrome)</span><br><span class="line">            <span class="comment"># Chrome扩展安装</span></span><br><span class="line">            <span class="keyword">if</span> [ -d <span class="string">&quot;/usr/share/google-chrome&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">                extension_dir=<span class="string">&quot;<span class="variable">$HOME</span>/.config/google-chrome/NativeMessagingHosts&quot;</span></span><br><span class="line">                <span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$extension_dir</span>&quot;</span></span><br><span class="line">                <span class="built_in">cp</span> web/extensions/browser_extension/chrome.json <span class="string">&quot;<span class="variable">$extension_dir</span>/com.download.manager.json&quot;</span></span><br><span class="line">                print_success <span class="string">&quot;Chrome扩展安装成功&quot;</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">            ;;</span><br><span class="line">        firefox)</span><br><span class="line">            <span class="comment"># Firefox扩展安装</span></span><br><span class="line">            <span class="keyword">if</span> [ -d <span class="string">&quot;/usr/lib/firefox&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">                extension_dir=<span class="string">&quot;<span class="variable">$HOME</span>/.mozilla/native-messaging-hosts&quot;</span></span><br><span class="line">                <span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$extension_dir</span>&quot;</span></span><br><span class="line">                <span class="built_in">cp</span> web/extensions/browser_extension/firefox.json <span class="string">&quot;<span class="variable">$extension_dir</span>/com.download.manager.json&quot;</span></span><br><span class="line">                print_success <span class="string">&quot;Firefox扩展安装成功&quot;</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">            ;;</span><br><span class="line">        *)</span><br><span class="line">            print_warning <span class="string">&quot;不支持的浏览器: <span class="variable">$browser</span>&quot;</span></span><br><span class="line">            ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主安装函数</span></span><br><span class="line"><span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    print_info <span class="string">&quot;开始安装下载管理器...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查依赖</span></span><br><span class="line">    check_command python3</span><br><span class="line">    check_command pip3</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查Python版本</span></span><br><span class="line">    check_python_version python3</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建虚拟环境</span></span><br><span class="line">    VENV_DIR=<span class="string">&quot;venv&quot;</span></span><br><span class="line">    create_venv <span class="string">&quot;<span class="variable">$VENV_DIR</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 安装依赖</span></span><br><span class="line">    install_dependencies <span class="string">&quot;<span class="variable">$VENV_DIR</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建配置</span></span><br><span class="line">    CONFIG_DIR=<span class="string">&quot;config&quot;</span></span><br><span class="line">    create_config <span class="string">&quot;<span class="variable">$CONFIG_DIR</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建数据目录</span></span><br><span class="line">    create_data_dirs <span class="string">&quot;.&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 设置环境变量</span></span><br><span class="line">    setup_environment <span class="string">&quot;<span class="variable">$VENV_DIR</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建启动脚本</span></span><br><span class="line">    create_start_scripts</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 询问是否安装系统服务</span></span><br><span class="line">    <span class="built_in">read</span> -p <span class="string">&quot;是否安装为系统服务？(y/N): &quot;</span> install_service_choice</span><br><span class="line">    <span class="keyword">if</span> [[ <span class="variable">$install_service_choice</span> =~ ^[Yy]$ ]]; <span class="keyword">then</span></span><br><span class="line">        install_service</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 询问是否安装浏览器扩展</span></span><br><span class="line">    <span class="built_in">read</span> -p <span class="string">&quot;是否安装浏览器扩展？(y/N): &quot;</span> install_extension_choice</span><br><span class="line">    <span class="keyword">if</span> [[ <span class="variable">$install_extension_choice</span> =~ ^[Yy]$ ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">read</span> -p <span class="string">&quot;选择浏览器 (chrome/firefox): &quot;</span> browser_choice</span><br><span class="line">        install_browser_extension <span class="string">&quot;<span class="variable">$browser_choice</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    print_success <span class="string">&quot;下载管理器安装完成！&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    print_info <span class="string">&quot;使用说明:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  1. 命令行模式: ./dm-cli&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  2. Web界面: ./dm-web&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  3. 访问地址: http://localhost:5000&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    print_info <span class="string">&quot;首次使用:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  1. 编辑 config/config.yaml 修改配置&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  2. 运行 ./dm-web 启动Web服务&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  3. 浏览器访问 http://localhost:5000&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  4. 默认账号: admin / admin123&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行主函数</span></span><br><span class="line">main <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br></pre></td></tr></table></figure>



<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这个扩展版下载管理器现在具有以下高级功能：</p>
<h3 id="核心功能增强"><a href="#核心功能增强" class="headerlink" title="核心功能增强"></a>核心功能增强</h3><ol>
<li><strong>断点续传</strong> - 支持从上次中断处继续下载</li>
<li><strong>下载队列</strong> - 智能队列管理，支持优先级调度</li>
<li><strong>速度限制</strong> - 精确控制下载和上传速度</li>
<li><strong>代理支持</strong> - 支持HTTP&#x2F;HTTPS&#x2F;SOCKS代理，自动选择最佳代理</li>
</ol>
<h3 id="批量处理"><a href="#批量处理" class="headerlink" title="批量处理"></a>批量处理</h3><ol>
<li><strong>批量下载</strong> - 支持多种格式的批量URL导入</li>
<li><strong>文件校验</strong> - 支持多种哈希算法验证文件完整性</li>
<li><strong>重复检测</strong> - 自动检测并处理重复文件</li>
</ol>
<h3 id="自动化功能"><a href="#自动化功能" class="headerlink" title="自动化功能"></a>自动化功能</h3><ol>
<li><strong>计划任务</strong> - 定时下载任务，支持多种调度模式</li>
<li><strong>RSS订阅</strong> - 自动抓取RSS更新并下载新内容</li>
<li><strong>自动分类</strong> - 根据文件类型自动分类保存</li>
</ol>
<h3 id="用户体验"><a href="#用户体验" class="headerlink" title="用户体验"></a>用户体验</h3><ol>
<li><strong>交互式CLI</strong> - 功能丰富的命令行界面</li>
<li><strong>现代化Web界面</strong> - 响应式设计，实时进度显示</li>
<li><strong>浏览器集成</strong> - 浏览器扩展支持一键下载</li>
<li><strong>通知系统</strong> - 邮件和Webhook通知</li>
</ol>
<h3 id="系统架构"><a href="#系统架构" class="headerlink" title="系统架构"></a>系统架构</h3><ol>
<li><strong>模块化设计</strong> - 各个功能模块独立，易于扩展</li>
<li><strong>配置文件管理</strong> - YAML格式配置，支持热重载</li>
<li><strong>数据库支持</strong> - SQLite&#x2F;MySQL&#x2F;PostgreSQL可选</li>
<li><strong>Docker支持</strong> - 容器化部署，一键启动</li>
</ol>
<h3 id="安全特性"><a href="#安全特性" class="headerlink" title="安全特性"></a>安全特性</h3><ol>
<li><strong>用户认证</strong> - 多用户支持，权限管理</li>
<li><strong>访问控制</strong> - IP白名单&#x2F;黑名单</li>
<li><strong>请求限制</strong> - 防止滥用</li>
<li><strong>数据加密</strong> - 敏感数据加密存储</li>
</ol>
<h3 id="监控和管理"><a href="#监控和管理" class="headerlink" title="监控和管理"></a>监控和管理</h3><ol>
<li><strong>实时统计</strong> - 下载速度、流量统计</li>
<li><strong>日志系统</strong> - 详细的操作日志</li>
<li><strong>健康检查</strong> - 系统健康状态监控</li>
<li><strong>API接口</strong> - 完整的REST API，支持第三方集成</li>
</ol>
<p>这个系统既适合个人使用，也适合小型团队或组织使用。它可以通过命令行快速操作，也可以通过Web界面进行详细管理，还可以通过API与其他系统集成。Docker支持使得部署变得非常简单，无论是在本地环境还是在服务器上。</p>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">
    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/f9ba3e83.html" rel="prev" title="Java面试笔记">
                  <i class="fa fa-angle-left"></i> Java面试笔记
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/94c76a9b.html" rel="next" title="Python实践:数据清洗工具">
                  Python实践:数据清洗工具 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa-regular fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder"></span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Word count total">392k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">23:47</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>

  <script class="next-config" data-name="wavedrom" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/wavedrom.min.js","integrity":"sha256-INLAoJc6quTNfiMWkGZniYO2cxE8mHpddnLow1m6RFs="}}</script>
  <script class="next-config" data-name="wavedrom_skin" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/skins/default.js","integrity":"sha256-fduc/Zszk5ezWws2uInY/ALWVmIrmV6VTgXbsYSReFI="}}</script>
  <script src="/js/third-party/tags/wavedrom.js"></script>




  





</body>
</html>
