<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"timewait7.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Elasticsearch 的核心概念 文档： 数据的基本单位，通常是 JSON 格式。相当于数据库中的一行记录。 索引： 具有相似特征的文档集合。相当于数据库中的一个表。一个索引对应一个或多个分片。 类型： (7.x 之前) 索引内部的逻辑分区，允许在同一索引中存储不同类型的文档（如 user, product）。(注意： 在 7.x 中类型被废弃，8.x 中完全移除。现在一个索引通常只包含一种">
<meta property="og:type" content="article">
<meta property="og:title" content="ElasticSearch">
<meta property="og:url" content="http://timewait7.github.io/post/d48132d3.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Elasticsearch 的核心概念 文档： 数据的基本单位，通常是 JSON 格式。相当于数据库中的一行记录。 索引： 具有相似特征的文档集合。相当于数据库中的一个表。一个索引对应一个或多个分片。 类型： (7.x 之前) 索引内部的逻辑分区，允许在同一索引中存储不同类型的文档（如 user, product）。(注意： 在 7.x 中类型被废弃，8.x 中完全移除。现在一个索引通常只包含一种">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-09-21T08:00:35.000Z">
<meta property="article:modified_time" content="2025-09-21T08:15:21.131Z">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://timewait7.github.io/post/d48132d3.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://timewait7.github.io/post/d48132d3.html","path":"post/d48132d3.html","title":"ElasticSearch"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>ElasticSearch | Hexo</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-archives"><a href="/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="Searching..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Elasticsearch-%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-number">1.</span> <span class="nav-text">Elasticsearch 的核心概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%EF%BC%9F%E4%B8%BA%E4%BB%80%E4%B9%88%E5%AE%83%E5%AF%B9%E6%90%9C%E7%B4%A2%E5%BE%88%E9%87%8D%E8%A6%81%EF%BC%9F"><span class="nav-number">2.</span> <span class="nav-text">什么是倒排索引？为什么它对搜索很重要？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E7%89%87%EF%BC%88Shard%EF%BC%89%E5%92%8C%E5%89%AF%E6%9C%AC%EF%BC%88Replica%EF%BC%89%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">3.</span> <span class="nav-text">分片（Shard）和副本（Replica）是什么</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Elasticsearch-%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%80%A7%EF%BC%9F"><span class="nav-number">4.</span> <span class="nav-text">Elasticsearch 如何保证写入数据的可靠性？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%A3%E9%87%8A%E4%B8%80%E4%B8%8B-Elasticsearch-%E4%B8%AD%E7%9A%84-refresh-%E5%92%8C-flush-%E6%93%8D%E4%BD%9C%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">5.</span> <span class="nav-text">解释一下 Elasticsearch 中的 refresh 和 flush 操作的区别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81-Yellow-%E6%88%96-Red-%E6%84%8F%E5%91%B3%E7%9D%80%E4%BB%80%E4%B9%88%EF%BC%9F%E5%A6%82%E4%BD%95%E6%8E%92%E6%9F%A5"><span class="nav-number">6.</span> <span class="nav-text">集群状态 Yellow 或 Red 意味着什么？如何排查?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%A3%E9%87%8A%E4%B8%80%E4%B8%8B%E4%BB%80%E4%B9%88%E6%98%AF%E8%84%91%E8%A3%82%EF%BC%88Split-Brain%EF%BC%89%E9%97%AE%E9%A2%98%EF%BC%9FElasticsearch-%E5%A6%82%E4%BD%95%E9%98%B2%E6%AD%A2%E8%84%91%E8%A3%82%EF%BC%9F"><span class="nav-number">7.</span> <span class="nav-text">解释一下什么是脑裂（Split-Brain）问题？Elasticsearch 如何防止脑裂？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%98%A0%E5%B0%84%E7%88%86%E7%82%B8%EF%BC%9F%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%EF%BC%9F"><span class="nav-number">8.</span> <span class="nav-text">什么是映射爆炸？如何避免？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%83%85%E5%86%B5%E4%B8%8B%E4%BD%A0%E4%BC%9A%E8%80%83%E8%99%91%E4%BD%BF%E7%94%A8-keyword-%E7%B1%BB%E5%9E%8B%E8%80%8C%E4%B8%8D%E6%98%AF-text-%E7%B1%BB%E5%9E%8B%EF%BC%9F"><span class="nav-number">9.</span> <span class="nav-text">什么情况下你会考虑使用 keyword 类型而不是 text 类型？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E6%AE%B5%E5%90%88%E5%B9%B6%EF%BC%88Segment-Merging%EF%BC%89%EF%BC%9F%E5%AE%83%E6%9C%89%E4%BB%80%E4%B9%88%E4%BC%98%E7%BC%BA%E7%82%B9%EF%BC%9F"><span class="nav-number">10.</span> <span class="nav-text">为什么需要段合并（Segment Merging）？它有什么优缺点？</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/">
          <span class="site-state-item-count">36</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://timewait7.github.io/post/d48132d3.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="ElasticSearch | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ElasticSearch
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-09-21 16:00:35" itemprop="dateCreated datePublished" datetime="2025-09-21T16:00:35+08:00">2025-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ElasticSearch/" itemprop="url" rel="index"><span itemprop="name">ElasticSearch</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>2.7k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>10 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="Elasticsearch-的核心概念"><a href="#Elasticsearch-的核心概念" class="headerlink" title="Elasticsearch 的核心概念"></a><strong>Elasticsearch 的核心概念</strong></h2><ul>
<li><strong>文档：</strong> 数据的基本单位，通常是 JSON 格式。相当于数据库中的一行记录。</li>
<li><strong>索引：</strong> 具有相似特征的文档集合。相当于数据库中的一个表。一个索引对应一个或多个分片。</li>
<li><strong>类型：</strong> (7.x 之前) 索引内部的逻辑分区，允许在同一索引中存储不同类型的文档（如 <code>user</code>, <code>product</code>）。(<strong>注意：</strong> 在 7.x 中类型被废弃，8.x 中完全移除。现在一个索引通常只包含一种文档类型)。</li>
<li><strong>分片：</strong> 索引被水平分割成的子集。每个分片本身就是一个功能完整且独立的“索引”。<ul>
<li><strong>主分片：</strong> 存储文档数据和处理索引&#x2F;更新操作。索引创建时指定数量，后续不可更改（除非 Reindex）。</li>
<li><strong>副本分片：</strong> 主分片的拷贝。提供高可用性（主分片故障时副本可提升为主）和读取吞吐量（查询可负载均衡到所有副本）。</li>
</ul>
</li>
<li><strong>节点：</strong> 运行中的 Elasticsearch 实例。</li>
<li><strong>集群：</strong> 一个或多个节点协同工作的集合，共同持有整个数据并提供联合索引和搜索能力。</li>
<li><strong>倒排索引：</strong> ES 实现快速全文搜索的核心数据结构。它存储了词项（Token）到包含该词项的文档 ID 列表的映射。相比传统数据库的正排索引（文档 ID 到字段值），它更擅长回答“哪些文档包含某个词？”的问题。</li>
</ul>
<h2 id="什么是倒排索引？为什么它对搜索很重要？"><a href="#什么是倒排索引？为什么它对搜索很重要？" class="headerlink" title="什么是倒排索引？为什么它对搜索很重要？"></a><strong>什么是倒排索引？为什么它对搜索很重要？</strong></h2><ul>
<li><strong>定义：</strong> 倒排索引是一种将文档中的词项（Token）映射到包含该词项的文档列表的数据结构。它包含两个核心部分：<ul>
<li><strong>词项字典：</strong> 包含所有不重复的词项（Token），通常按字典序排序。</li>
<li><strong>倒排列表：</strong> 对于每个词项，记录包含该词项的所有文档 ID 列表（Postings List），以及词项在文档中出现的位置（Position）、频率（Term Frequency）等信息（用于相关性评分）。</li>
</ul>
</li>
<li><strong>重要性：</strong><ul>
<li><strong>快速定位：</strong> 直接通过词项找到包含它的文档，避免了扫描所有文档。</li>
<li><strong>高效布尔查询：</strong> AND&#x2F;OR&#x2F;NOT 操作可以通过对倒排列表进行交&#x2F;并&#x2F;差集运算高效完成。</li>
<li><strong>相关性评分基础：</strong> TF-IDF、BM25 等经典评分模型严重依赖倒排索引中存储的词频（TF）、文档频率（DF&#x2F;IDF）信息。</li>
<li><strong>支持短语查询：</strong> 利用存储的位置信息，可以精确查找相邻出现的词组。</li>
</ul>
</li>
</ul>
<h2 id="分片（Shard）和副本（Replica）是什么"><a href="#分片（Shard）和副本（Replica）是什么" class="headerlink" title="分片（Shard）和副本（Replica）是什么"></a>分片（Shard）和副本（Replica）是什么</h2><p>分片是索引的物理组成部分（一个 Lucene 索引），用于<strong>水平分割数据</strong>，使索引可以分布在多个节点上，实现<strong>水平扩展和并行处理</strong>。</p>
<p>副本是主分片的完整拷贝，作用是<strong>提供高可用性</strong>（主分片故障时副本可接管）和<strong>提高查询吞吐量&#x2F;性能</strong>（查询可以在副本上执行，分担负载）。主分片数量在索引创建时指定且后续不可变，副本数量可以动态调整。</p>
<h2 id="Elasticsearch-如何保证写入数据的可靠性？"><a href="#Elasticsearch-如何保证写入数据的可靠性？" class="headerlink" title="Elasticsearch 如何保证写入数据的可靠性？"></a>Elasticsearch 如何保证写入数据的可靠性？</h2><ul>
<li><strong>事务日志：</strong> 所有写入操作在写入内存缓冲区（In-memory Buffer）的同时，会立即追加写入到事务日志（Translog）中。Translog 是持久化的。</li>
<li><strong>Refresh：</strong> 定期（默认 1 秒）将内存缓冲区中的内容生成一个新的、可搜索的 Lucene 段（Segment），并清空缓冲区。这个过程使新写入的数据对搜索可见。<strong>注意：</strong> 此时数据还在操作系统的文件系统缓存（Page Cache）中，并未物理刷盘（<code>fsync</code>）。</li>
<li><strong>Flush：</strong> 定期（默认 30 分钟，或 Translog 大小达到阈值）执行以下操作：<ol>
<li>触发一次 Refresh，将所有在内存缓冲区中的数据生成新的段。</li>
<li>将文件系统缓存中的段数据物理 <code>fsync</code> 到磁盘。</li>
<li>清空（截断）旧的、已持久化的 Translog。</li>
</ol>
</li>
<li><strong>副本机制：</strong> 写入操作在主分片执行成功后，必须等待所有配置的副本分片也写入成功才返回客户端确认（除非使用 <code>wait_for_active_shards</code> 降低要求）。这确保了数据冗余。</li>
<li><strong>故障恢复：</strong> 节点重启时，会重放 Translog 中尚未刷盘的操作来恢复数据。副本分片的存在保证了主分片丢失时数据不丢。</li>
</ul>
<h2 id="解释一下-Elasticsearch-中的-refresh-和-flush-操作的区别"><a href="#解释一下-Elasticsearch-中的-refresh-和-flush-操作的区别" class="headerlink" title="解释一下 Elasticsearch 中的 refresh 和 flush 操作的区别"></a>解释一下 Elasticsearch 中的 <code>refresh</code> 和 <code>flush</code> 操作的区别</h2><ul>
<li><strong><code>refresh</code>：</strong><ul>
<li><strong>目的：</strong> 使新写入的数据对搜索可见。</li>
<li><strong>操作：</strong> 将内存缓冲区中的文档生成新的、可搜索的 Lucene 段（Segment）。段写入文件系统缓存（Page Cache），<strong>不</strong>立即 <code>fsync</code> 到磁盘。</li>
<li><strong>频率：</strong> 默认每秒一次（可通过 <code>index.refresh_interval</code> 配置）。</li>
<li><strong>开销：</strong> 相对较低，因为只写入 Page Cache。频繁 Refresh 会产生大量小段，增加合并（Merge）压力。</li>
</ul>
</li>
<li><strong><code>flush</code>：</strong><ul>
<li><strong>目的：</strong> 将文件系统缓存中的数据安全持久化到磁盘，并清理 Translog。</li>
<li><strong>操作：</strong><ol>
<li>执行一次 Refresh（确保所有数据都在段里）。</li>
<li>调用 <code>fsync</code> 将文件系统缓存中的所有段数据强制写入磁盘存储设备。</li>
<li>清空（截断）当前 Translog（因为数据已安全落盘）。</li>
</ol>
</li>
<li><strong>触发条件：</strong><ul>
<li>定时（默认 30 分钟，<code>index.translog.sync_interval</code> &#x2F; <code>index.translog.durability</code>）。</li>
<li>Translog 大小达到阈值（默认 512MB，<code>index.translog.flush_threshold_size</code>）。</li>
<li>显式调用 <code>_flush</code> API。</li>
</ul>
</li>
<li><strong>开销：</strong> 相对较高，因为涉及磁盘 I&#x2F;O (<code>fsync</code>)。</li>
</ul>
</li>
</ul>
<h2 id="集群状态-Yellow-或-Red-意味着什么？如何排查"><a href="#集群状态-Yellow-或-Red-意味着什么？如何排查" class="headerlink" title="集群状态 Yellow 或 Red 意味着什么？如何排查?"></a>集群状态 Yellow 或 Red 意味着什么？如何排查?</h2><ul>
<li><strong>Yellow：</strong><ul>
<li><strong>含义：</strong> 所有主分片都已分配，但<strong>至少有一个副本分片没有分配</strong>。</li>
<li><strong>常见原因：</strong><ul>
<li>节点数量不足（例如，索引配置了 <code>number_of_replicas=1</code>，但集群只有一个节点）。</li>
<li>新创建的索引副本分片正在初始化（短暂状态）。</li>
<li>有节点故障，导致部分副本分片丢失（但主分片还在）。</li>
</ul>
</li>
<li><strong>影响：</strong> 高可用性降低（丢失一个节点可能导致数据丢失&#x2F;不可用），查询吞吐量可能下降（副本少）。</li>
<li><strong>排查：</strong> <code>GET _cluster/allocation/explain</code> API 查看未分配分片的具体原因；检查节点数、节点状态、磁盘空间、分片分配设置。</li>
</ul>
</li>
<li><strong>Red：</strong><ul>
<li><strong>含义：</strong> <strong>至少有一个主分片没有分配</strong>（可能连带其副本也缺失）。</li>
<li><strong>常见原因：</strong><ul>
<li>持有主分片的节点永久丢失，且没有可用的副本分片可以提升为主分片。</li>
<li>磁盘空间不足导致分片无法分配。</li>
<li>配置错误（如分片分配规则 exclude 了所有节点）。</li>
</ul>
</li>
<li><strong>影响：</strong> <strong>数据部分丢失或完全不可用！</strong> 涉及该主分片的索引和搜索操作都会失败。</li>
<li><strong>排查：</strong> 紧急！立即检查 <code>_cluster/health</code> 和 <code>_cat/shards?v</code> 确认哪些索引&#x2F;分片是 <code>red</code>。使用 <code>GET _cluster/allocation/explain</code> 分析未分配原因。检查节点状态、磁盘空间、日志。可能需要从备份恢复或手动分配分片（风险操作）。</li>
</ul>
</li>
<li><strong>目标：</strong> 始终追求 <code>Green</code> 状态。</li>
</ul>
<h2 id="解释一下什么是脑裂（Split-Brain）问题？Elasticsearch-如何防止脑裂？"><a href="#解释一下什么是脑裂（Split-Brain）问题？Elasticsearch-如何防止脑裂？" class="headerlink" title="解释一下什么是脑裂（Split-Brain）问题？Elasticsearch 如何防止脑裂？"></a>解释一下什么是脑裂（Split-Brain）问题？Elasticsearch 如何防止脑裂？</h2><ul>
<li><strong>定义：</strong> 在分布式系统中，当网络分区（Network Partition）发生时，集群的不同部分（节点组）可能无法互相通信。如果每个部分都认为自己是唯一可用的部分并选举出新的主节点，就会导致集群分裂成两个或多个独立运作的“脑”，各自接受写入操作，造成<strong>数据不一致</strong>和<strong>冲突</strong>。</li>
<li><strong>ES 防止机制：</strong> 主要通过 <strong><code>discovery.zen.minimum_master_nodes</code></strong> 设置（在 7.x 之前显式配置）或 <strong><code>cluster.initial_master_nodes</code></strong> + <strong>Quorum</strong> 机制（7.x+ 尤其是基于 Raft 的选举）：<ul>
<li><strong>核心思想：</strong> 确保只有拥有<strong>多数</strong>（Quorum, &gt; N&#x2F;2）<strong>主节点资格节点</strong>的节点组才能成功选举主节点或维持主节点。假设有 <code>N</code> 个主节点资格节点：<ul>
<li>设置 <code>discovery.zen.minimum_master_nodes = (N/2) + 1</code> （例如，3节点集群设为2）。</li>
<li>在 7.x+ 中，使用 <code>cluster.initial_master_nodes</code> 列出初始主节点，新选举协议自动确保需要多数投票。</li>
</ul>
</li>
<li><strong>效果：</strong> 在网络分区时，任何节点组如果包含的主节点资格节点数不足多数（&lt;&#x3D; N&#x2F;2），就无法选举新主节点或维持现有主节点状态（因为它无法获得多数确认），从而<strong>无法提供服务或接受写操作</strong>，避免了“双主”导致的脑裂。只有拥有多数节点的分区才能正常运作。</li>
</ul>
</li>
</ul>
<h2 id="什么是映射爆炸？如何避免？"><a href="#什么是映射爆炸？如何避免？" class="headerlink" title="什么是映射爆炸？如何避免？"></a>什么是映射爆炸？如何避免？</h2><ul>
<li><strong>定义：</strong> 当索引中包含大量<strong>唯一</strong>字段（通常是动态映射产生的）时，导致集群状态（Cluster State）变得极其庞大（可能超过数百MB甚至GB），主节点在广播和维持集群状态时压力巨大，严重影响集群稳定性和性能。</li>
<li><strong>原因：</strong> 常见于索引了类似日志数据，其中每个文档都有大量不同的、不可预测的字段（如包含用户ID或请求ID的字段名）。</li>
<li><strong>避免：</strong><ul>
<li><strong>严格控制动态映射：</strong> 设置 <code>&quot;dynamic&quot;: &quot;strict&quot;</code>（禁止未知字段）或 <code>&quot;dynamic&quot;: &quot;false&quot;</code>（忽略未知字段，但不索引）。优先使用<strong>显式映射</strong>。</li>
<li><strong>使用 <code>flattened</code> 类型：</strong> 将整个 JSON 对象映射为单个 <code>flattened</code> 字段，避免为每个内部键创建独立字段。适用于不需要独立查询&#x2F;聚合的元数据。</li>
<li><strong>使用 <code>object</code>&#x2F;<code>nested</code> 但限制深度：</strong> 使用 <code>index.mapping.depth.limit</code> 控制嵌套深度。</li>
<li><strong>字段别名：</strong> 如果不同来源的字段语义相同，用别名统一映射到一个字段。</li>
<li><strong>合理的索引设计：</strong> 避免将差异巨大的文档类型塞进同一个索引。</li>
</ul>
</li>
</ul>
<h2 id="什么情况下你会考虑使用-keyword-类型而不是-text-类型？"><a href="#什么情况下你会考虑使用-keyword-类型而不是-text-类型？" class="headerlink" title="什么情况下你会考虑使用 keyword 类型而不是 text 类型？"></a>什么情况下你会考虑使用 <code>keyword</code> 类型而不是 <code>text</code> 类型？</h2><ul>
<li>使用 <code>keyword</code> 类型当：<ul>
<li>需要<strong>精确匹配</strong>（e.g., 状态码、标签、ID、枚举值）。</li>
<li>需要<strong>聚合</strong>（Aggregations - Terms, Significant Terms）。</li>
<li>需要<strong>排序</strong>（Sorting）。</li>
<li>不需要全文分词搜索。</li>
</ul>
</li>
<li>使用 <code>text</code> 类型当：<ul>
<li>字段内容是需要被<strong>全文搜索</strong>的自然语言文本（e.g., 邮件正文、产品描述）。</li>
<li>需要被<strong>分词器</strong>处理（Tokenization, Normalization）。</li>
</ul>
</li>
<li><strong>注意：</strong> 通常对同一个字段会同时定义 <code>text</code>（用于搜索）和 <code>keyword</code>（用于聚合&#x2F;排序）多字段（Multi-fields）。</li>
</ul>
<h2 id="为什么需要段合并（Segment-Merging）？它有什么优缺点？"><a href="#为什么需要段合并（Segment-Merging）？它有什么优缺点？" class="headerlink" title="为什么需要段合并（Segment Merging）？它有什么优缺点？"></a>为什么需要段合并（Segment Merging）？它有什么优缺点？</h2><ul>
<li><strong>为什么需要：</strong> 频繁的 refresh 会产生大量小的 Lucene 段。小段过多会降低查询性能（需要打开更多文件句柄）且占用更多资源（文件描述符、内存）。删除操作只是标记文档为删除，空间不会立即释放。</li>
<li><strong>优点：</strong><ul>
<li>减少段数量，<strong>提升查询速度</strong>（减少文件打开和搜索范围）。</li>
<li><strong>真正删除</strong>被标记删除的文档，<strong>回收磁盘空间</strong>。</li>
<li>合并过程中优化索引结构（如压缩）。</li>
</ul>
</li>
<li><strong>缺点：</strong><ul>
<li>是 <strong>I&#x2F;O 和 CPU 密集型操作</strong>，在合并期间可能<strong>显著影响集群性能</strong>（写入延迟、查询延迟增加）。</li>
<li>需要额外的临时磁盘空间。</li>
</ul>
</li>
</ul>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">
    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/bae4ff13.html" rel="prev" title="Redis">
                  <i class="fa fa-angle-left"></i> Redis
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/f6253398.html" rel="next" title="Dubbo">
                  Dubbo <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa-regular fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder"></span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Word count total">163k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">9:53</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>

  <script class="next-config" data-name="wavedrom" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/wavedrom.min.js","integrity":"sha256-INLAoJc6quTNfiMWkGZniYO2cxE8mHpddnLow1m6RFs="}}</script>
  <script class="next-config" data-name="wavedrom_skin" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/skins/default.js","integrity":"sha256-fduc/Zszk5ezWws2uInY/ALWVmIrmV6VTgXbsYSReFI="}}</script>
  <script src="/js/third-party/tags/wavedrom.js"></script>




  





</body>
</html>
