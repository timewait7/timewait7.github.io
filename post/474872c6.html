<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"timewait7.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="é¡¹ç›®è®¾è®¡ï¼šAIèŠå¤©æœºå™¨äººåŠ©æ‰‹ç³»ç»Ÿ1. é¡¹ç›®æ¦‚è¿°è¿™æ˜¯ä¸€ä¸ªç»¼åˆæ€§çš„AIèŠå¤©æœºå™¨äººåŠ©æ‰‹ç³»ç»Ÿï¼Œæ¶µç›–Pythonåœ¨å®é™…å·¥ä½œä¸­çš„ä¸»è¦æŠ€èƒ½ç‚¹ã€‚ç³»ç»ŸåŒ…å«ç”¨æˆ·ç•Œé¢ã€èŠå¤©æœºå™¨äººã€æ•°æ®åˆ†æã€ç”¨æˆ·ç®¡ç†ç­‰å¤šä¸ªæ¨¡å—ï¼Œå…·æœ‰å¯ç©æ€§å’Œå®ç”¨æ€§ã€‚ 2. æŠ€æœ¯æ ˆä¸æŠ€èƒ½ç‚¹   æŠ€èƒ½ç±»åˆ« å…·ä½“æŠ€æœ¯ åº”ç”¨åœºæ™¯    Webæ¡†æ¶ Flask&#x2F;FastAPI APIå¼€å‘ã€Webç•Œé¢   æ•°æ®åº“ SQLite&#x2F;MySQL, Re">
<meta property="og:type" content="article">
<meta property="og:title" content="PythonèŠå¤©æœºå™¨äººè®¾è®¡ä¸å®ç°">
<meta property="og:url" content="http://timewait7.github.io/post/474872c6.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="é¡¹ç›®è®¾è®¡ï¼šAIèŠå¤©æœºå™¨äººåŠ©æ‰‹ç³»ç»Ÿ1. é¡¹ç›®æ¦‚è¿°è¿™æ˜¯ä¸€ä¸ªç»¼åˆæ€§çš„AIèŠå¤©æœºå™¨äººåŠ©æ‰‹ç³»ç»Ÿï¼Œæ¶µç›–Pythonåœ¨å®é™…å·¥ä½œä¸­çš„ä¸»è¦æŠ€èƒ½ç‚¹ã€‚ç³»ç»ŸåŒ…å«ç”¨æˆ·ç•Œé¢ã€èŠå¤©æœºå™¨äººã€æ•°æ®åˆ†æã€ç”¨æˆ·ç®¡ç†ç­‰å¤šä¸ªæ¨¡å—ï¼Œå…·æœ‰å¯ç©æ€§å’Œå®ç”¨æ€§ã€‚ 2. æŠ€æœ¯æ ˆä¸æŠ€èƒ½ç‚¹   æŠ€èƒ½ç±»åˆ« å…·ä½“æŠ€æœ¯ åº”ç”¨åœºæ™¯    Webæ¡†æ¶ Flask&#x2F;FastAPI APIå¼€å‘ã€Webç•Œé¢   æ•°æ®åº“ SQLite&#x2F;MySQL, Re">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-12-17T10:11:45.000Z">
<meta property="article:modified_time" content="2025-12-17T10:44:10.717Z">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://timewait7.github.io/post/474872c6.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://timewait7.github.io/post/474872c6.html","path":"post/474872c6.html","title":"PythonèŠå¤©æœºå™¨äººè®¾è®¡ä¸å®ç°"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>PythonèŠå¤©æœºå™¨äººè®¾è®¡ä¸å®ç° | Hexo</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-archives"><a href="/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="Searching..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E8%AE%BE%E8%AE%A1%EF%BC%9AAI%E8%81%8A%E5%A4%A9%E6%9C%BA%E5%99%A8%E4%BA%BA%E5%8A%A9%E6%89%8B%E7%B3%BB%E7%BB%9F"><span class="nav-number">1.</span> <span class="nav-text">é¡¹ç›®è®¾è®¡ï¼šAIèŠå¤©æœºå™¨äººåŠ©æ‰‹ç³»ç»Ÿ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E9%A1%B9%E7%9B%AE%E6%A6%82%E8%BF%B0"><span class="nav-number">1.1.</span> <span class="nav-text">1. é¡¹ç›®æ¦‚è¿°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%8A%80%E6%9C%AF%E6%A0%88%E4%B8%8E%E6%8A%80%E8%83%BD%E7%82%B9"><span class="nav-number">1.2.</span> <span class="nav-text">2. æŠ€æœ¯æ ˆä¸æŠ€èƒ½ç‚¹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E8%AF%A6%E7%BB%86%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3"><span class="nav-number">1.3.</span> <span class="nav-text">3. è¯¦ç»†è®¾è®¡æ–‡æ¡£</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E9%A1%B9%E7%9B%AE%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="nav-number">1.3.1.</span> <span class="nav-text">3.1 é¡¹ç›®ç›®å½•ç»“æ„</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.3.2.</span> <span class="nav-text">3.2 æ•°æ®åº“è®¾è®¡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E6%A0%B8%E5%BF%83%E8%81%8A%E5%A4%A9%E6%9C%BA%E5%99%A8%E4%BA%BA%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.3.3.</span> <span class="nav-text">3.3 æ ¸å¿ƒèŠå¤©æœºå™¨äººå®ç°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-API%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.3.4.</span> <span class="nav-text">3.4 APIæ¥å£è®¾è®¡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B"><span class="nav-number">1.3.5.</span> <span class="nav-text">3.5 æµ‹è¯•ç”¨ä¾‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="nav-number">1.3.6.</span> <span class="nav-text">3.6 ä½¿ç”¨æ¡ˆä¾‹</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B1%EF%BC%9A%E5%9F%BA%E7%A1%80%E8%81%8A%E5%A4%A9"><span class="nav-number">1.3.6.1.</span> <span class="nav-text">æ¡ˆä¾‹1ï¼šåŸºç¡€èŠå¤©</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B2%EF%BC%9A%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E4%BB%AA%E8%A1%A8%E7%9B%98"><span class="nav-number">1.3.6.2.</span> <span class="nav-text">æ¡ˆä¾‹2ï¼šæ•°æ®åˆ†æä»ªè¡¨ç›˜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B3%EF%BC%9A%E5%A4%9A%E8%BD%AE%E5%AF%B9%E8%AF%9D%E5%9C%BA%E6%99%AF"><span class="nav-number">1.3.6.3.</span> <span class="nav-text">æ¡ˆä¾‹3ï¼šå¤šè½®å¯¹è¯åœºæ™¯</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%88%86%E9%98%B6%E6%AE%B5%E5%AE%9E%E7%8E%B0%E8%AE%A1%E5%88%92"><span class="nav-number">1.4.</span> <span class="nav-text">4. åˆ†é˜¶æ®µå®ç°è®¡åˆ’</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%98%B6%E6%AE%B51%EF%BC%9A%E5%9F%BA%E7%A1%80%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA%EF%BC%881-2%E5%91%A8%EF%BC%89"><span class="nav-number">1.4.1.</span> <span class="nav-text">é˜¶æ®µ1ï¼šåŸºç¡€æ¡†æ¶æ­å»ºï¼ˆ1-2å‘¨ï¼‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%98%B6%E6%AE%B52%EF%BC%9A%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91%EF%BC%882-3%E5%91%A8%EF%BC%89"><span class="nav-number">1.4.2.</span> <span class="nav-text">é˜¶æ®µ2ï¼šæ ¸å¿ƒåŠŸèƒ½å¼€å‘ï¼ˆ2-3å‘¨ï¼‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%98%B6%E6%AE%B53%EF%BC%9A%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD%E4%B8%8E%E4%BC%98%E5%8C%96%EF%BC%882-3%E5%91%A8%EF%BC%89"><span class="nav-number">1.4.3.</span> <span class="nav-text">é˜¶æ®µ3ï¼šé«˜çº§åŠŸèƒ½ä¸ä¼˜åŒ–ï¼ˆ2-3å‘¨ï¼‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%98%B6%E6%AE%B54%EF%BC%9A%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%BF%90%E7%BB%B4%EF%BC%881-2%E5%91%A8%EF%BC%89"><span class="nav-number">1.4.4.</span> <span class="nav-text">é˜¶æ®µ4ï¼šéƒ¨ç½²ä¸è¿ç»´ï¼ˆ1-2å‘¨ï¼‰</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97"><span class="nav-number">1.5.</span> <span class="nav-text">5. éƒ¨ç½²æŒ‡å—</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E6%9C%AC%E5%9C%B0%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83"><span class="nav-number">1.5.1.</span> <span class="nav-text">5.1 æœ¬åœ°å¼€å‘ç¯å¢ƒ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-Docker%E9%83%A8%E7%BD%B2"><span class="nav-number">1.5.2.</span> <span class="nav-text">5.2 Dockeréƒ¨ç½²</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-docker-compose%E9%83%A8%E7%BD%B2"><span class="nav-number">1.5.3.</span> <span class="nav-text">5.3 docker-composeéƒ¨ç½²</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E9%A1%B9%E7%9B%AE%E7%89%B9%E8%89%B2%E4%B8%8E%E5%8F%AF%E7%8E%A9%E6%80%A7"><span class="nav-number">1.6.</span> <span class="nav-text">6. é¡¹ç›®ç‰¹è‰²ä¸å¯ç©æ€§</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%E6%B8%B8%E6%88%8F%E5%8C%96%E5%8A%9F%E8%83%BD"><span class="nav-number">1.6.1.</span> <span class="nav-text">6.1 æ¸¸æˆåŒ–åŠŸèƒ½</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-%E4%B8%BB%E9%A2%98%E7%9A%AE%E8%82%A4%E7%B3%BB%E7%BB%9F"><span class="nav-number">1.6.2.</span> <span class="nav-text">6.2 ä¸»é¢˜çš®è‚¤ç³»ç»Ÿ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E5%AD%A6%E4%B9%A0%E8%B7%AF%E5%BE%84%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.7.</span> <span class="nav-text">7. å­¦ä¹ è·¯å¾„å»ºè®®</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E5%91%A8%EF%BC%9APython%E5%9F%BA%E7%A1%80"><span class="nav-number">1.7.1.</span> <span class="nav-text">ç¬¬ä¸€å‘¨ï¼šPythonåŸºç¡€</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E5%91%A8%EF%BC%9AWeb%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80"><span class="nav-number">1.7.2.</span> <span class="nav-text">ç¬¬äºŒå‘¨ï¼šWebå¼€å‘åŸºç¡€</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E5%91%A8%EF%BC%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="nav-number">1.7.3.</span> <span class="nav-text">ç¬¬ä¸‰å‘¨ï¼šæ•°æ®åº“æ“ä½œ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E5%91%A8%EF%BC%9A%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B"><span class="nav-number">1.7.4.</span> <span class="nav-text">ç¬¬å››å‘¨ï¼šå¼‚æ­¥ç¼–ç¨‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%BA%94%E5%91%A8%EF%BC%9A%E6%B5%8B%E8%AF%95%E4%B8%8E%E9%83%A8%E7%BD%B2"><span class="nav-number">1.7.5.</span> <span class="nav-text">ç¬¬äº”å‘¨ï¼šæµ‹è¯•ä¸éƒ¨ç½²</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E5%85%AD%E5%91%A8%EF%BC%9A%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98"><span class="nav-number">1.7.6.</span> <span class="nav-text">ç¬¬å…­å‘¨ï¼šé¡¹ç›®å®æˆ˜</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">1.8.</span> <span class="nav-text">8. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Q1%EF%BC%9A%E5%A6%82%E4%BD%95%E8%B0%83%E8%AF%95Python%E7%A8%8B%E5%BA%8F%EF%BC%9F"><span class="nav-number">1.8.1.</span> <span class="nav-text">Q1ï¼šå¦‚ä½•è°ƒè¯•Pythonç¨‹åºï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Q2%EF%BC%9A%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0%EF%BC%9F"><span class="nav-number">1.8.2.</span> <span class="nav-text">Q2ï¼šå¦‚ä½•å¤„ç†æ•°æ®åº“è¿æ¥æ± ï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Q3%EF%BC%9A%E5%A6%82%E4%BD%95%E4%BC%98%E5%8C%96API%E6%80%A7%E8%83%BD%EF%BC%9F"><span class="nav-number">1.8.3.</span> <span class="nav-text">Q3ï¼šå¦‚ä½•ä¼˜åŒ–APIæ€§èƒ½ï¼Ÿ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.9.</span> <span class="nav-text">æ€»ç»“</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E7%9A%84-AI-%E8%81%8A%E5%A4%A9%E6%9C%BA%E5%99%A8%E4%BA%BA%E5%8A%A9%E6%89%8B%E7%B3%BB%E7%BB%9F%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.</span> <span class="nav-text">å®Œæ•´çš„ AI èŠå¤©æœºå™¨äººåŠ©æ‰‹ç³»ç»Ÿå®ç°</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC1%E6%AD%A5%EF%BC%9A%E9%A1%B9%E7%9B%AE%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">2.1.</span> <span class="nav-text">ç¬¬1æ­¥ï¼šé¡¹ç›®åˆå§‹åŒ–</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="nav-number">2.1.1.</span> <span class="nav-text">1.1 åˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">2.1.2.</span> <span class="nav-text">1.2 åŸºç¡€é…ç½®æ–‡ä»¶</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC2%E6%AD%A5%EF%BC%9AFlask%E5%BA%94%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="nav-number">2.2.</span> <span class="nav-text">ç¬¬2æ­¥ï¼šFlaskåº”ç”¨é…ç½®</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC3%E6%AD%A5%EF%BC%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A8%A1%E5%9E%8B"><span class="nav-number">2.3.</span> <span class="nav-text">ç¬¬3æ­¥ï¼šæ•°æ®åº“æ¨¡å‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC4%E6%AD%A5%EF%BC%9A%E6%A0%B8%E5%BF%83%E8%81%8A%E5%A4%A9%E6%9C%BA%E5%99%A8%E4%BA%BA%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.4.</span> <span class="nav-text">ç¬¬4æ­¥ï¼šæ ¸å¿ƒèŠå¤©æœºå™¨äººå®ç°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC5%E6%AD%A5%EF%BC%9AAPI%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.5.</span> <span class="nav-text">ç¬¬5æ­¥ï¼šAPIæ¥å£å®ç°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC6%E6%AD%A5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E5%B1%82%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.6.</span> <span class="nav-text">ç¬¬6æ­¥ï¼šæœåŠ¡å±‚å®ç°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC7%E6%AD%A5%EF%BC%9A%E5%B7%A5%E5%85%B7%E7%B1%BB%E5%92%8C%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-number">2.7.</span> <span class="nav-text">ç¬¬7æ­¥ï¼šå·¥å…·ç±»å’Œä¸­é—´ä»¶</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC8%E6%AD%A5%EF%BC%9A%E5%89%8D%E7%AB%AF%E7%95%8C%E9%9D%A2"><span class="nav-number">2.8.</span> <span class="nav-text">ç¬¬8æ­¥ï¼šå‰ç«¯ç•Œé¢</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC9%E6%AD%A5%EF%BC%9ADocker%E9%83%A8%E7%BD%B2%E9%85%8D%E7%BD%AE"><span class="nav-number">2.9.</span> <span class="nav-text">ç¬¬9æ­¥ï¼šDockeréƒ¨ç½²é…ç½®</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC10%E6%AD%A5%EF%BC%9A%E5%AE%8C%E6%95%B4%E7%9A%84%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-number">2.10.</span> <span class="nav-text">ç¬¬10æ­¥ï¼šå®Œæ•´çš„é¡¹ç›®ç»“æ„</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC11%E6%AD%A5%EF%BC%9A%E8%BF%90%E8%A1%8C%E5%92%8C%E6%B5%8B%E8%AF%95"><span class="nav-number">2.11.</span> <span class="nav-text">ç¬¬11æ­¥ï¼šè¿è¡Œå’Œæµ‹è¯•</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-1-%E6%9C%AC%E5%9C%B0%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E8%BF%90%E8%A1%8C"><span class="nav-number">2.11.1.</span> <span class="nav-text">11.1 æœ¬åœ°å¼€å‘ç¯å¢ƒè¿è¡Œ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-2-%E4%BD%BF%E7%94%A8Docker%E8%BF%90%E8%A1%8C"><span class="nav-number">2.11.2.</span> <span class="nav-text">11.2 ä½¿ç”¨Dockerè¿è¡Œ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-3-%E8%BF%90%E8%A1%8C%E6%B5%8B%E8%AF%95"><span class="nav-number">2.11.3.</span> <span class="nav-text">11.3 è¿è¡Œæµ‹è¯•</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93"><span class="nav-number">2.12.</span> <span class="nav-text">é¡¹ç›®æ€»ç»“</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E2%9C%85-%E5%B7%B2%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%8A%9F%E8%83%BD%EF%BC%9A"><span class="nav-number">2.12.1.</span> <span class="nav-text">âœ… å·²å®ç°çš„åŠŸèƒ½ï¼š</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%94%A7-%E6%8A%80%E6%9C%AF%E6%A0%88%E8%A6%86%E7%9B%96%EF%BC%9A"><span class="nav-number">2.12.2.</span> <span class="nav-text">ğŸ”§ æŠ€æœ¯æ ˆè¦†ç›–ï¼š</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%9A%80-%E5%AD%A6%E4%B9%A0%E8%B7%AF%E5%BE%84%EF%BC%9A"><span class="nav-number">2.12.3.</span> <span class="nav-text">ğŸš€ å­¦ä¹ è·¯å¾„ï¼š</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%93%8A-%E6%8A%80%E8%83%BD%E6%8F%90%E5%8D%87%EF%BC%9A"><span class="nav-number">2.12.4.</span> <span class="nav-text">ğŸ“Š æŠ€èƒ½æå‡ï¼š</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E5%92%8C%E6%89%A9%E5%B1%95%E6%96%B9%E5%90%91"><span class="nav-number">2.13.</span> <span class="nav-text">ä¼˜åŒ–å’Œæ‰©å±•æ–¹å‘</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">2.13.1.</span> <span class="nav-text">1. æ€§èƒ½ä¼˜åŒ–</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%8A%9F%E8%83%BD%E6%89%A9%E5%B1%95"><span class="nav-number">2.13.2.</span> <span class="nav-text">2. åŠŸèƒ½æ‰©å±•</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-AI%E8%83%BD%E5%8A%9B%E5%A2%9E%E5%BC%BA"><span class="nav-number">2.13.3.</span> <span class="nav-text">3. AIèƒ½åŠ›å¢å¼º</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E7%94%A8%E6%88%B7%E4%BD%93%E9%AA%8C"><span class="nav-number">2.13.4.</span> <span class="nav-text">4. ç”¨æˆ·ä½“éªŒ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E7%B3%BB%E7%BB%9F%E5%8F%AF%E9%9D%A0%E6%80%A7%E5%92%8C%E5%AE%89%E5%85%A8%E6%80%A7"><span class="nav-number">2.13.5.</span> <span class="nav-text">5. ç³»ç»Ÿå¯é æ€§å’Œå®‰å…¨æ€§</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E7%9B%91%E6%8E%A7%E5%92%8C%E8%BF%90%E7%BB%B4"><span class="nav-number">2.13.6.</span> <span class="nav-text">6. ç›‘æ§å’Œè¿ç»´</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AI%E8%81%8A%E5%A4%A9%E6%9C%BA%E5%99%A8%E4%BA%BA%E5%8A%A9%E6%89%8B%E7%B3%BB%E7%BB%9F%EF%BC%9A%E4%BC%98%E5%8C%96%E4%B8%8E%E6%89%A9%E5%B1%95%E6%96%B9%E6%A1%88"><span class="nav-number">3.</span> <span class="nav-text">AIèŠå¤©æœºå™¨äººåŠ©æ‰‹ç³»ç»Ÿï¼šä¼˜åŒ–ä¸æ‰©å±•æ–¹æ¡ˆ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%F0%9F%9A%80-%E9%AB%98%E7%BA%A7%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91"><span class="nav-number">3.1.</span> <span class="nav-text">ğŸš€ é«˜çº§ä¼˜åŒ–æ–¹å‘</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%80%A7%E8%83%BD%E6%B7%B1%E5%BA%A6%E4%BC%98%E5%8C%96"><span class="nav-number">3.1.1.</span> <span class="nav-text">1. æ€§èƒ½æ·±åº¦ä¼˜åŒ–</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BC%98%E5%8C%96"><span class="nav-number">3.1.1.1.</span> <span class="nav-text">1.1 æ•°æ®åº“ä¼˜åŒ–</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5%E4%BC%98%E5%8C%96"><span class="nav-number">3.1.1.2.</span> <span class="nav-text">1.2 ç¼“å­˜ç­–ç•¥ä¼˜åŒ–</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E4%BC%98%E5%8C%96"><span class="nav-number">3.1.1.3.</span> <span class="nav-text">1.3 å¼‚æ­¥ä»»åŠ¡ä¼˜åŒ–</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-AI%E8%83%BD%E5%8A%9B%E5%A2%9E%E5%BC%BA"><span class="nav-number">3.1.2.</span> <span class="nav-text">2. AIèƒ½åŠ›å¢å¼º</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-%E5%A4%9A%E6%A8%A1%E5%9E%8B%E8%B7%AF%E7%94%B1%E7%B3%BB%E7%BB%9F"><span class="nav-number">3.1.2.1.</span> <span class="nav-text">2.1 å¤šæ¨¡å‹è·¯ç”±ç³»ç»Ÿ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-RAG%EF%BC%88%E6%A3%80%E7%B4%A2%E5%A2%9E%E5%BC%BA%E7%94%9F%E6%88%90%EF%BC%89%E7%B3%BB%E7%BB%9F"><span class="nav-number">3.1.2.2.</span> <span class="nav-text">2.2 RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ç³»ç»Ÿ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E6%89%A9%E5%B1%95"><span class="nav-number">3.1.3.</span> <span class="nav-text">3. ç³»ç»Ÿæ¶æ„æ‰©å±•</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84"><span class="nav-number">3.1.3.1.</span> <span class="nav-text">3.1 å¾®æœåŠ¡æ¶æ„</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="nav-number">3.1.3.2.</span> <span class="nav-text">3.2 æœåŠ¡ç½‘æ ¼é…ç½®ç¤ºä¾‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E6%9E%B6%E6%9E%84"><span class="nav-number">3.1.3.3.</span> <span class="nav-text">3.3 äº‹ä»¶é©±åŠ¨æ¶æ„</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E7%9B%91%E6%8E%A7%E5%92%8C%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7%E6%89%A9%E5%B1%95"><span class="nav-number">3.1.4.</span> <span class="nav-text">4. ç›‘æ§å’Œå¯è§‚æµ‹æ€§æ‰©å±•</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-%E9%AB%98%E7%BA%A7%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F"><span class="nav-number">3.1.4.1.</span> <span class="nav-text">4.1 é«˜çº§ç›‘æ§ç³»ç»Ÿ</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%F0%9F%8E%AF-%E6%89%A9%E5%B1%95%E5%8A%9F%E8%83%BD%E5%BB%BA%E8%AE%AE"><span class="nav-number">3.2.</span> <span class="nav-text">ğŸ¯ æ‰©å±•åŠŸèƒ½å»ºè®®</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%95%86%E4%B8%9A%E5%8A%9F%E8%83%BD%E6%89%A9%E5%B1%95"><span class="nav-number">3.2.1.</span> <span class="nav-text">1. å•†ä¸šåŠŸèƒ½æ‰©å±•</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-%E5%A4%9A%E7%A7%9F%E6%88%B7%E7%B3%BB%E7%BB%9F"><span class="nav-number">3.2.1.1.</span> <span class="nav-text">1.1 å¤šç§Ÿæˆ·ç³»ç»Ÿ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-%E4%BB%98%E8%B4%B9%E8%AE%A2%E9%98%85%E7%B3%BB%E7%BB%9F"><span class="nav-number">3.2.1.2.</span> <span class="nav-text">1.2 ä»˜è´¹è®¢é˜…ç³»ç»Ÿ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%8A%80%E6%9C%AF%E6%B7%B1%E5%BA%A6%E6%89%A9%E5%B1%95"><span class="nav-number">3.2.2.</span> <span class="nav-text">2. æŠ€æœ¯æ·±åº¦æ‰©å±•</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0%E9%9B%86%E6%88%90"><span class="nav-number">3.2.2.1.</span> <span class="nav-text">2.1 æœºå™¨å­¦ä¹ å¹³å°é›†æˆ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-%E5%AE%9E%E6%97%B6%E6%B5%81%E5%A4%84%E7%90%86"><span class="nav-number">3.2.2.2.</span> <span class="nav-text">2.2 å®æ—¶æµå¤„ç†</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E7%94%A8%E6%88%B7%E4%BD%93%E9%AA%8C%E5%A2%9E%E5%BC%BA"><span class="nav-number">3.2.3.</span> <span class="nav-text">3. ç”¨æˆ·ä½“éªŒå¢å¼º</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-%E8%AF%AD%E9%9F%B3%E4%BA%A4%E4%BA%92"><span class="nav-number">3.2.3.1.</span> <span class="nav-text">3.1 è¯­éŸ³äº¤äº’</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-AR-VR%E9%9B%86%E6%88%90"><span class="nav-number">3.2.3.2.</span> <span class="nav-text">3.2 AR&#x2F;VRé›†æˆ</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%F0%9F%93%8A-%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94%E8%A1%A8"><span class="nav-number">3.3.</span> <span class="nav-text">ğŸ“Š æ€§èƒ½å¯¹æ¯”è¡¨</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%F0%9F%9A%80-%E9%83%A8%E7%BD%B2%E6%9E%B6%E6%9E%84%E5%8D%87%E7%BA%A7"><span class="nav-number">3.4.</span> <span class="nav-text">ğŸš€ éƒ¨ç½²æ¶æ„å‡çº§</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Kubernetes%E9%83%A8%E7%BD%B2"><span class="nav-number">3.4.1.</span> <span class="nav-text">1. Kuberneteséƒ¨ç½²</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Serverless%E6%9E%B6%E6%9E%84"><span class="nav-number">3.4.2.</span> <span class="nav-text">2. Serverlessæ¶æ„</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%A4%9A%E4%BA%91%E9%83%A8%E7%BD%B2"><span class="nav-number">3.4.3.</span> <span class="nav-text">3. å¤šäº‘éƒ¨ç½²</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%F0%9F%94%A7-%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E9%93%BE%E5%A2%9E%E5%BC%BA"><span class="nav-number">3.5.</span> <span class="nav-text">ğŸ”§ å¼€å‘å·¥å…·é“¾å¢å¼º</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-CI-CD%E6%B5%81%E6%B0%B4%E7%BA%BF"><span class="nav-number">3.5.1.</span> <span class="nav-text">1. CI&#x2F;CDæµæ°´çº¿</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83"><span class="nav-number">3.5.2.</span> <span class="nav-text">2. å¼€å‘ç¯å¢ƒ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%F0%9F%93%88-%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87%E6%89%A9%E5%B1%95"><span class="nav-number">3.6.</span> <span class="nav-text">ğŸ“ˆ ç›‘æ§æŒ‡æ ‡æ‰©å±•</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E4%B8%9A%E5%8A%A1%E6%8C%87%E6%A0%87"><span class="nav-number">3.6.1.</span> <span class="nav-text">1. ä¸šåŠ¡æŒ‡æ ‡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%8A%80%E6%9C%AF%E6%8C%87%E6%A0%87"><span class="nav-number">3.6.2.</span> <span class="nav-text">2. æŠ€æœ¯æŒ‡æ ‡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-AI%E6%8C%87%E6%A0%87"><span class="nav-number">3.6.3.</span> <span class="nav-text">3. AIæŒ‡æ ‡</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%F0%9F%8E%AF-%E5%AE%9E%E6%96%BD%E5%BB%BA%E8%AE%AE"><span class="nav-number">3.7.</span> <span class="nav-text">ğŸ¯ å®æ–½å»ºè®®</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5%EF%BC%881-2%E4%B8%AA%E6%9C%88%EF%BC%89%EF%BC%9A%E5%9F%BA%E7%A1%80%E4%BC%98%E5%8C%96"><span class="nav-number">3.7.1.</span> <span class="nav-text">ç¬¬ä¸€é˜¶æ®µï¼ˆ1-2ä¸ªæœˆï¼‰ï¼šåŸºç¡€ä¼˜åŒ–</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5%EF%BC%882-3%E4%B8%AA%E6%9C%88%EF%BC%89%EF%BC%9A%E6%9E%B6%E6%9E%84%E5%8D%87%E7%BA%A7"><span class="nav-number">3.7.2.</span> <span class="nav-text">ç¬¬äºŒé˜¶æ®µï¼ˆ2-3ä¸ªæœˆï¼‰ï¼šæ¶æ„å‡çº§</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%EF%BC%883-4%E4%B8%AA%E6%9C%88%EF%BC%89%EF%BC%9AAI%E5%A2%9E%E5%BC%BA"><span class="nav-number">3.7.3.</span> <span class="nav-text">ç¬¬ä¸‰é˜¶æ®µï¼ˆ3-4ä¸ªæœˆï¼‰ï¼šAIå¢å¼º</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E9%98%B6%E6%AE%B5%EF%BC%88%E6%8C%81%E7%BB%AD%EF%BC%89%EF%BC%9A%E5%88%9B%E6%96%B0%E6%89%A9%E5%B1%95"><span class="nav-number">3.7.4.</span> <span class="nav-text">ç¬¬å››é˜¶æ®µï¼ˆæŒç»­ï¼‰ï¼šåˆ›æ–°æ‰©å±•</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%F0%9F%92%A1-%E5%88%9B%E6%96%B0%E7%82%B9"><span class="nav-number">3.8.</span> <span class="nav-text">ğŸ’¡ åˆ›æ–°ç‚¹</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/">
          <span class="site-state-item-count">53</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://timewait7.github.io/post/474872c6.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="PythonèŠå¤©æœºå™¨äººè®¾è®¡ä¸å®ç° | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          PythonèŠå¤©æœºå™¨äººè®¾è®¡ä¸å®ç°
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-12-17 18:11:45" itemprop="dateCreated datePublished" datetime="2025-12-17T18:11:45+08:00">2025-12-17</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>30k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1:49</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="é¡¹ç›®è®¾è®¡ï¼šAIèŠå¤©æœºå™¨äººåŠ©æ‰‹ç³»ç»Ÿ"><a href="#é¡¹ç›®è®¾è®¡ï¼šAIèŠå¤©æœºå™¨äººåŠ©æ‰‹ç³»ç»Ÿ" class="headerlink" title="é¡¹ç›®è®¾è®¡ï¼šAIèŠå¤©æœºå™¨äººåŠ©æ‰‹ç³»ç»Ÿ"></a>é¡¹ç›®è®¾è®¡ï¼šAIèŠå¤©æœºå™¨äººåŠ©æ‰‹ç³»ç»Ÿ</h1><h2 id="1-é¡¹ç›®æ¦‚è¿°"><a href="#1-é¡¹ç›®æ¦‚è¿°" class="headerlink" title="1. é¡¹ç›®æ¦‚è¿°"></a>1. é¡¹ç›®æ¦‚è¿°</h2><p>è¿™æ˜¯ä¸€ä¸ªç»¼åˆæ€§çš„AIèŠå¤©æœºå™¨äººåŠ©æ‰‹ç³»ç»Ÿï¼Œæ¶µç›–Pythonåœ¨å®é™…å·¥ä½œä¸­çš„ä¸»è¦æŠ€èƒ½ç‚¹ã€‚ç³»ç»ŸåŒ…å«ç”¨æˆ·ç•Œé¢ã€èŠå¤©æœºå™¨äººã€æ•°æ®åˆ†æã€ç”¨æˆ·ç®¡ç†ç­‰å¤šä¸ªæ¨¡å—ï¼Œå…·æœ‰å¯ç©æ€§å’Œå®ç”¨æ€§ã€‚</p>
<h2 id="2-æŠ€æœ¯æ ˆä¸æŠ€èƒ½ç‚¹"><a href="#2-æŠ€æœ¯æ ˆä¸æŠ€èƒ½ç‚¹" class="headerlink" title="2. æŠ€æœ¯æ ˆä¸æŠ€èƒ½ç‚¹"></a>2. æŠ€æœ¯æ ˆä¸æŠ€èƒ½ç‚¹</h2><table>
<thead>
<tr>
<th align="left">æŠ€èƒ½ç±»åˆ«</th>
<th align="left">å…·ä½“æŠ€æœ¯</th>
<th align="left">åº”ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>Webæ¡†æ¶</strong></td>
<td align="left">Flask&#x2F;FastAPI</td>
<td align="left">APIå¼€å‘ã€Webç•Œé¢</td>
</tr>
<tr>
<td align="left"><strong>æ•°æ®åº“</strong></td>
<td align="left">SQLite&#x2F;MySQL, Redis</td>
<td align="left">æ•°æ®æŒä¹…åŒ–ã€ç¼“å­˜</td>
</tr>
<tr>
<td align="left"><strong>å¼‚æ­¥ç¼–ç¨‹</strong></td>
<td align="left">asyncio, WebSocket</td>
<td align="left">å®æ—¶èŠå¤©</td>
</tr>
<tr>
<td align="left"><strong>æ•°æ®å¤„ç†</strong></td>
<td align="left">Pandas, NumPy</td>
<td align="left">æ•°æ®åˆ†æ</td>
</tr>
<tr>
<td align="left"><strong>æœºå™¨å­¦ä¹ </strong></td>
<td align="left">scikit-learn, transformers</td>
<td align="left">AIå¯¹è¯ã€æƒ…æ„Ÿåˆ†æ</td>
</tr>
<tr>
<td align="left"><strong>ä»»åŠ¡é˜Ÿåˆ—</strong></td>
<td align="left">Celery</td>
<td align="left">å¼‚æ­¥ä»»åŠ¡å¤„ç†</td>
</tr>
<tr>
<td align="left"><strong>æµ‹è¯•æ¡†æ¶</strong></td>
<td align="left">pytest, unittest</td>
<td align="left">å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•</td>
</tr>
<tr>
<td align="left"><strong>éƒ¨ç½²è¿ç»´</strong></td>
<td align="left">Docker, Nginx</td>
<td align="left">å®¹å™¨åŒ–éƒ¨ç½²</td>
</tr>
<tr>
<td align="left"><strong>ç‰ˆæœ¬æ§åˆ¶</strong></td>
<td align="left">Git</td>
<td align="left">ä»£ç ç®¡ç†</td>
</tr>
<tr>
<td align="left"><strong>APIè®¾è®¡</strong></td>
<td align="left">RESTful, GraphQL</td>
<td align="left">æ¥å£è®¾è®¡</td>
</tr>
</tbody></table>
<h2 id="3-è¯¦ç»†è®¾è®¡æ–‡æ¡£"><a href="#3-è¯¦ç»†è®¾è®¡æ–‡æ¡£" class="headerlink" title="3. è¯¦ç»†è®¾è®¡æ–‡æ¡£"></a>3. è¯¦ç»†è®¾è®¡æ–‡æ¡£</h2><h3 id="3-1-é¡¹ç›®ç›®å½•ç»“æ„"><a href="#3-1-é¡¹ç›®ç›®å½•ç»“æ„" class="headerlink" title="3.1 é¡¹ç›®ç›®å½•ç»“æ„"></a>3.1 é¡¹ç›®ç›®å½•ç»“æ„</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">ai-chatbot-system/</span><br><span class="line">â”œâ”€â”€ app/</span><br><span class="line">â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚   â”œâ”€â”€ main.py              # åº”ç”¨å…¥å£</span><br><span class="line">â”‚   â”œâ”€â”€ api/</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ auth.py          # ç”¨æˆ·è®¤è¯</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ chat.py          # èŠå¤©æ¥å£</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ analytics.py     # æ•°æ®åˆ†ææ¥å£</span><br><span class="line">â”‚   â”‚   â””â”€â”€ models.py        # æ•°æ®æ¨¡å‹</span><br><span class="line">â”‚   â”œâ”€â”€ core/</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ chatbot.py       # èŠå¤©æœºå™¨äººæ ¸å¿ƒ</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ nlp_engine.py    # NLPå¤„ç†å¼•æ“</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ intent_detector.py # æ„å›¾è¯†åˆ«</span><br><span class="line">â”‚   â”‚   â””â”€â”€ emotion_analyzer.py # æƒ…æ„Ÿåˆ†æ</span><br><span class="line">â”‚   â”œâ”€â”€ database/</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ models.py        # SQLAlchemyæ¨¡å‹</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ crud.py          # æ•°æ®åº“æ“ä½œ</span><br><span class="line">â”‚   â”‚   â””â”€â”€ migrations/      # æ•°æ®åº“è¿ç§»</span><br><span class="line">â”‚   â”œâ”€â”€ services/</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ ai_service.py    # AIæœåŠ¡å°è£…</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ cache_service.py # ç¼“å­˜æœåŠ¡</span><br><span class="line">â”‚   â”‚   â””â”€â”€ task_service.py  # å¼‚æ­¥ä»»åŠ¡</span><br><span class="line">â”‚   â”œâ”€â”€ static/</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ css/</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ js/</span><br><span class="line">â”‚   â”‚   â””â”€â”€ images/</span><br><span class="line">â”‚   â”œâ”€â”€ templates/</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ base.html</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ index.html       # ä¸»é¡µ</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ chat.html        # èŠå¤©ç•Œé¢</span><br><span class="line">â”‚   â”‚   â””â”€â”€ dashboard.html   # ä»ªè¡¨ç›˜</span><br><span class="line">â”‚   â””â”€â”€ utils/</span><br><span class="line">â”‚       â”œâ”€â”€ config.py        # é…ç½®ç®¡ç†</span><br><span class="line">â”‚       â”œâ”€â”€ logger.py        # æ—¥å¿—å·¥å…·</span><br><span class="line">â”‚       â””â”€â”€ helpers.py       # è¾…åŠ©å‡½æ•°</span><br><span class="line">â”œâ”€â”€ tests/</span><br><span class="line">â”‚   â”œâ”€â”€ unit/</span><br><span class="line">â”‚   â”œâ”€â”€ integration/</span><br><span class="line">â”‚   â””â”€â”€ functional/</span><br><span class="line">â”œâ”€â”€ scripts/</span><br><span class="line">â”‚   â”œâ”€â”€ setup.py            # å®‰è£…è„šæœ¬</span><br><span class="line">â”‚   â”œâ”€â”€ deploy.sh           # éƒ¨ç½²è„šæœ¬</span><br><span class="line">â”‚   â””â”€â”€ test.sh             # æµ‹è¯•è„šæœ¬</span><br><span class="line">â”œâ”€â”€ docs/                   # é¡¹ç›®æ–‡æ¡£</span><br><span class="line">â”œâ”€â”€ requirements.txt        # Pythonä¾èµ–</span><br><span class="line">â”œâ”€â”€ Dockerfile             # å®¹å™¨åŒ–é…ç½®</span><br><span class="line">â”œâ”€â”€ docker-compose.yml     # å¤šå®¹å™¨ç¼–æ’</span><br><span class="line">â””â”€â”€ README.md              # é¡¹ç›®è¯´æ˜</span><br></pre></td></tr></table></figure>



<h3 id="3-2-æ•°æ®åº“è®¾è®¡"><a href="#3-2-æ•°æ®åº“è®¾è®¡" class="headerlink" title="3.2 æ•°æ®åº“è®¾è®¡"></a>3.2 æ•°æ®åº“è®¾è®¡</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/database/models.py</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> app.database <span class="keyword">import</span> Base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String, Text, DateTime, ForeignKey, Boolean, Float</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> relationship</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = Column(String(<span class="number">50</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)</span><br><span class="line">    email = Column(String(<span class="number">100</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)</span><br><span class="line">    password_hash = Column(String(<span class="number">200</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    created_at = Column(DateTime, default=datetime.utcnow)</span><br><span class="line">    is_active = Column(Boolean, default=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å…³ç³»</span></span><br><span class="line">    chat_sessions = relationship(<span class="string">&quot;ChatSession&quot;</span>, back_populates=<span class="string">&quot;user&quot;</span>)</span><br><span class="line">    feedbacks = relationship(<span class="string">&quot;UserFeedback&quot;</span>, back_populates=<span class="string">&quot;user&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatSession</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;chat_sessions&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    user_id = Column(Integer, ForeignKey(<span class="string">&#x27;users.id&#x27;</span>))</span><br><span class="line">    session_id = Column(String(<span class="number">100</span>), unique=<span class="literal">True</span>)</span><br><span class="line">    title = Column(String(<span class="number">200</span>))</span><br><span class="line">    created_at = Column(DateTime, default=datetime.utcnow)</span><br><span class="line">    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å…³ç³»</span></span><br><span class="line">    user = relationship(<span class="string">&quot;User&quot;</span>, back_populates=<span class="string">&quot;chat_sessions&quot;</span>)</span><br><span class="line">    messages = relationship(<span class="string">&quot;ChatMessage&quot;</span>, back_populates=<span class="string">&quot;session&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatMessage</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;chat_messages&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    session_id = Column(Integer, ForeignKey(<span class="string">&#x27;chat_sessions.id&#x27;</span>))</span><br><span class="line">    role = Column(String(<span class="number">20</span>))  <span class="comment"># &#x27;user&#x27; æˆ– &#x27;assistant&#x27;</span></span><br><span class="line">    content = Column(Text)</span><br><span class="line">    timestamp = Column(DateTime, default=datetime.utcnow)</span><br><span class="line">    tokens_used = Column(Integer, default=<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å…³ç³»</span></span><br><span class="line">    session = relationship(<span class="string">&quot;ChatSession&quot;</span>, back_populates=<span class="string">&quot;messages&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserFeedback</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;user_feedbacks&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    user_id = Column(Integer, ForeignKey(<span class="string">&#x27;users.id&#x27;</span>))</span><br><span class="line">    message_id = Column(Integer, ForeignKey(<span class="string">&#x27;chat_messages.id&#x27;</span>))</span><br><span class="line">    rating = Column(Integer)  <span class="comment"># 1-5æ˜Ÿ</span></span><br><span class="line">    comment = Column(Text)</span><br><span class="line">    created_at = Column(DateTime, default=datetime.utcnow)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å…³ç³»</span></span><br><span class="line">    user = relationship(<span class="string">&quot;User&quot;</span>, back_populates=<span class="string">&quot;feedbacks&quot;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="3-3-æ ¸å¿ƒèŠå¤©æœºå™¨äººå®ç°"><a href="#3-3-æ ¸å¿ƒèŠå¤©æœºå™¨äººå®ç°" class="headerlink" title="3.3 æ ¸å¿ƒèŠå¤©æœºå™¨äººå®ç°"></a>3.3 æ ¸å¿ƒèŠå¤©æœºå™¨äººå®ç°</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/core/chatbot.py</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> app.core.nlp_engine <span class="keyword">import</span> NLEngine</span><br><span class="line"><span class="keyword">from</span> app.core.intent_detector <span class="keyword">import</span> IntentDetector</span><br><span class="line"><span class="keyword">from</span> app.core.emotion_analyzer <span class="keyword">import</span> EmotionAnalyzer</span><br><span class="line"><span class="keyword">from</span> app.services.ai_service <span class="keyword">import</span> AIService</span><br><span class="line"><span class="keyword">from</span> app.services.cache_service <span class="keyword">import</span> CacheService</span><br><span class="line"><span class="keyword">from</span> app.utils.logger <span class="keyword">import</span> setup_logger</span><br><span class="line"></span><br><span class="line">logger = setup_logger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatBot</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.nlp_engine = NLEngine()</span><br><span class="line">        self.intent_detector = IntentDetector()</span><br><span class="line">        self.emotion_analyzer = EmotionAnalyzer()</span><br><span class="line">        self.ai_service = AIService()</span><br><span class="line">        self.cache = CacheService()</span><br><span class="line">        self.personality_traits = &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;æ™ºå‹&quot;</span>,</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: <span class="string">&quot;AIåŠ©æ‰‹&quot;</span>,</span><br><span class="line">            <span class="string">&quot;traits&quot;</span>: [<span class="string">&quot;å‹å¥½&quot;</span>, <span class="string">&quot;ä¸“ä¸š&quot;</span>, <span class="string">&quot;å¹½é»˜&quot;</span>, <span class="string">&quot;ä¹äºåŠ©äºº&quot;</span>],</span><br><span class="line">            <span class="string">&quot;knowledge_base&quot;</span>: self._load_knowledge_base()</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_load_knowledge_base</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åŠ è½½çŸ¥è¯†åº“&quot;&quot;&quot;</span></span><br><span class="line">        knowledge = &#123;</span><br><span class="line">            <span class="string">&quot;greetings&quot;</span>: [<span class="string">&quot;ä½ å¥½&quot;</span>, <span class="string">&quot;æ‚¨å¥½&quot;</span>, <span class="string">&quot;å—¨&quot;</span>, <span class="string">&quot;æ—©ä¸Šå¥½&quot;</span>, <span class="string">&quot;æ™šä¸Šå¥½&quot;</span>],</span><br><span class="line">            <span class="string">&quot;farewells&quot;</span>: [<span class="string">&quot;å†è§&quot;</span>, <span class="string">&quot;æ‹œæ‹œ&quot;</span>, <span class="string">&quot;ä¸‹æ¬¡èŠ&quot;</span>],</span><br><span class="line">            <span class="string">&quot;capabilities&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;æˆ‘å¯ä»¥å›ç­”å„ç§é—®é¢˜&quot;</span>,</span><br><span class="line">                <span class="string">&quot;æˆ‘èƒ½è¿›è¡Œå¯¹è¯èŠå¤©&quot;</span>,</span><br><span class="line">                <span class="string">&quot;æˆ‘å¯ä»¥å¸®ä½ åˆ†ææ–‡æœ¬æƒ…æ„Ÿ&quot;</span>,</span><br><span class="line">                <span class="string">&quot;æˆ‘èƒ½è¯†åˆ«å¯¹è¯æ„å›¾&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> knowledge</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">process_message</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                             user_message: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                             session_id: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                             user_context: <span class="type">Optional</span>[<span class="type">Dict</span>] = <span class="literal">None</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        å¤„ç†ç”¨æˆ·æ¶ˆæ¯å¹¶ç”Ÿæˆå›å¤</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            user_message: ç”¨æˆ·æ¶ˆæ¯</span></span><br><span class="line"><span class="string">            session_id: ä¼šè¯ID</span></span><br><span class="line"><span class="string">            user_context: ç”¨æˆ·ä¸Šä¸‹æ–‡ä¿¡æ¯</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Dict: åŒ…å«å›å¤å’Œé™„åŠ ä¿¡æ¯</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 1. æ£€æŸ¥ç¼“å­˜</span></span><br><span class="line">            cached_response = <span class="keyword">await</span> self.cache.get_cached_response(</span><br><span class="line">                user_message, session_id</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">if</span> cached_response:</span><br><span class="line">                <span class="keyword">return</span> cached_response</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 2. é¢„å¤„ç†æ¶ˆæ¯</span></span><br><span class="line">            cleaned_message = self.nlp_engine.preprocess_text(user_message)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 3. å¹¶è¡Œå¤„ç†ï¼šæ„å›¾è¯†åˆ«å’Œæƒ…æ„Ÿåˆ†æ</span></span><br><span class="line">            intent_task = asyncio.create_task(</span><br><span class="line">                self.intent_detector.detect(cleaned_message)</span><br><span class="line">            )</span><br><span class="line">            emotion_task = asyncio.create_task(</span><br><span class="line">                self.emotion_analyzer.analyze(cleaned_message)</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            intent, emotion = <span class="keyword">await</span> asyncio.gather(intent_task, emotion_task)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 4. æ ¹æ®æ„å›¾é€‰æ‹©å¤„ç†ç­–ç•¥</span></span><br><span class="line">            <span class="keyword">if</span> intent == <span class="string">&quot;greeting&quot;</span>:</span><br><span class="line">                response = <span class="keyword">await</span> self._handle_greeting(cleaned_message, emotion)</span><br><span class="line">            <span class="keyword">elif</span> intent == <span class="string">&quot;question&quot;</span>:</span><br><span class="line">                response = <span class="keyword">await</span> self._handle_question(cleaned_message, user_context)</span><br><span class="line">            <span class="keyword">elif</span> intent == <span class="string">&quot;conversation&quot;</span>:</span><br><span class="line">                response = <span class="keyword">await</span> self._handle_conversation(cleaned_message, emotion)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                response = <span class="keyword">await</span> self._handle_default(cleaned_message)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 5. æ·»åŠ å…ƒæ•°æ®</span></span><br><span class="line">            response_metadata = &#123;</span><br><span class="line">                <span class="string">&quot;timestamp&quot;</span>: datetime.utcnow().isoformat(),</span><br><span class="line">                <span class="string">&quot;intent&quot;</span>: intent,</span><br><span class="line">                <span class="string">&quot;emotion&quot;</span>: emotion,</span><br><span class="line">                <span class="string">&quot;tokens_used&quot;</span>: response.get(<span class="string">&quot;tokens_used&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;processing_time&quot;</span>: response.get(<span class="string">&quot;processing_time&quot;</span>, <span class="number">0</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 6. ç¼“å­˜å“åº”</span></span><br><span class="line">            <span class="keyword">await</span> self.cache.cache_response(</span><br><span class="line">                user_message, session_id, response, intent</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;reply&quot;</span>: response[<span class="string">&quot;reply&quot;</span>],</span><br><span class="line">                <span class="string">&quot;metadata&quot;</span>: response_metadata,</span><br><span class="line">                <span class="string">&quot;suggested_responses&quot;</span>: response.get(<span class="string">&quot;suggested_responses&quot;</span>, [])</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Error processing message: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;reply&quot;</span>: <span class="string">&quot;æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚&quot;</span>,</span><br><span class="line">                <span class="string">&quot;metadata&quot;</span>: &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;,</span><br><span class="line">                <span class="string">&quot;suggested_responses&quot;</span>: [<span class="string">&quot;é‡æ–°å¼€å§‹&quot;</span>, <span class="string">&quot;æ¢ä¸ªè¯é¢˜&quot;</span>, <span class="string">&quot;è”ç³»å®¢æœ&quot;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_handle_greeting</span>(<span class="params">self, message: <span class="built_in">str</span>, emotion: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¤„ç†é—®å€™&quot;&quot;&quot;</span></span><br><span class="line">        greetings = self.personality_traits[<span class="string">&quot;knowledge_base&quot;</span>][<span class="string">&quot;greetings&quot;</span>]</span><br><span class="line">        response = <span class="string">f&quot;<span class="subst">&#123;np.random.choice(greetings)&#125;</span>ï¼æˆ‘æ˜¯<span class="subst">&#123;self.personality_traits[<span class="string">&#x27;name&#x27;</span>]&#125;</span>ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> emotion == <span class="string">&quot;positive&quot;</span>:</span><br><span class="line">            response += <span class="string">&quot; çœ‹èµ·æ¥æ‚¨ä»Šå¤©å¿ƒæƒ…ä¸é”™å‘¢ï¼&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;reply&quot;</span>: response,</span><br><span class="line">            <span class="string">&quot;tokens_used&quot;</span>: <span class="number">20</span>,</span><br><span class="line">            <span class="string">&quot;processing_time&quot;</span>: <span class="number">0.1</span>,</span><br><span class="line">            <span class="string">&quot;suggested_responses&quot;</span>: [<span class="string">&quot;ä½ èƒ½åšä»€ä¹ˆï¼Ÿ&quot;</span>, <span class="string">&quot;ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±&quot;</span>, <span class="string">&quot;å¼€å§‹èŠå¤©&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_handle_question</span>(<span class="params">self, message: <span class="built_in">str</span>, context: <span class="type">Dict</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¤„ç†é—®é¢˜&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ä½¿ç”¨AIæœåŠ¡ç”Ÿæˆå›ç­”</span></span><br><span class="line">        start_time = datetime.now()</span><br><span class="line">        ai_response = <span class="keyword">await</span> self.ai_service.generate_response(</span><br><span class="line">            message, </span><br><span class="line">            context=context</span><br><span class="line">        )</span><br><span class="line">        processing_time = (datetime.now() - start_time).total_seconds()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;reply&quot;</span>: ai_response[<span class="string">&quot;content&quot;</span>],</span><br><span class="line">            <span class="string">&quot;tokens_used&quot;</span>: ai_response.get(<span class="string">&quot;tokens_used&quot;</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="string">&quot;processing_time&quot;</span>: processing_time,</span><br><span class="line">            <span class="string">&quot;suggested_responses&quot;</span>: [<span class="string">&quot;è§£é‡Šæ›´è¯¦ç»†äº›&quot;</span>, <span class="string">&quot;ä¸¾ä¸ªä¾‹å­&quot;</span>, <span class="string">&quot;ç›¸å…³çš„é—®é¢˜&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_handle_conversation</span>(<span class="params">self, message: <span class="built_in">str</span>, emotion: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¤„ç†ä¸€èˆ¬å¯¹è¯&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># æ ¹æ®æƒ…æ„Ÿè°ƒæ•´å›å¤é£æ ¼</span></span><br><span class="line">        style = <span class="string">&quot;friendly&quot;</span> <span class="keyword">if</span> emotion == <span class="string">&quot;positive&quot;</span> <span class="keyword">else</span> <span class="string">&quot;empathetic&quot;</span></span><br><span class="line">        </span><br><span class="line">        response = <span class="keyword">await</span> self.ai_service.generate_conversation_response(</span><br><span class="line">            message, </span><br><span class="line">            style=style,</span><br><span class="line">            personality=self.personality_traits</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;reply&quot;</span>: response,</span><br><span class="line">            <span class="string">&quot;tokens_used&quot;</span>: <span class="number">50</span>,</span><br><span class="line">            <span class="string">&quot;processing_time&quot;</span>: <span class="number">0.2</span>,</span><br><span class="line">            <span class="string">&quot;suggested_responses&quot;</span>: [<span class="string">&quot;ç»§ç»­èŠ&quot;</span>, <span class="string">&quot;æ¢ä¸ªè¯é¢˜&quot;</span>, <span class="string">&quot;é—®ä¸ªé—®é¢˜&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">generate_dialogue</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                               topic: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                               num_exchanges: <span class="built_in">int</span> = <span class="number">5</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        ç”Ÿæˆç¤ºä¾‹å¯¹è¯</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            topic: å¯¹è¯ä¸»é¢˜</span></span><br><span class="line"><span class="string">            num_exchanges: å¯¹è¯è½®æ¬¡</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            List[Dict]: å¯¹è¯åˆ—è¡¨</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        dialogue = []</span><br><span class="line">        current_context = &#123;<span class="string">&quot;topic&quot;</span>: topic&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç”Ÿæˆå¼€åœºç™½</span></span><br><span class="line">        opening = <span class="keyword">await</span> self.ai_service.generate_opening_line(topic)</span><br><span class="line">        dialogue.append(&#123;</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: <span class="string">&quot;assistant&quot;</span>,</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: opening</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç”Ÿæˆå¯¹è¯</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_exchanges - <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># ç”Ÿæˆç”¨æˆ·æ¶ˆæ¯</span></span><br><span class="line">                user_msg = <span class="keyword">await</span> self.ai_service.generate_user_message(</span><br><span class="line">                    topic, </span><br><span class="line">                    context=current_context</span><br><span class="line">                )</span><br><span class="line">                dialogue.append(&#123;</span><br><span class="line">                    <span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;content&quot;</span>: user_msg</span><br><span class="line">                &#125;)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># ç”ŸæˆåŠ©æ‰‹å›å¤</span></span><br><span class="line">                last_user_msg = dialogue[-<span class="number">1</span>][<span class="string">&quot;content&quot;</span>]</span><br><span class="line">                response = <span class="keyword">await</span> self.process_message(</span><br><span class="line">                    last_user_msg, </span><br><span class="line">                    <span class="string">f&quot;dialogue_<span class="subst">&#123;topic&#125;</span>_<span class="subst">&#123;i&#125;</span>&quot;</span>,</span><br><span class="line">                    current_context</span><br><span class="line">                )</span><br><span class="line">                dialogue.append(&#123;</span><br><span class="line">                    <span class="string">&quot;role&quot;</span>: <span class="string">&quot;assistant&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;content&quot;</span>: response[<span class="string">&quot;reply&quot;</span>]</span><br><span class="line">                &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> dialogue</span><br></pre></td></tr></table></figure>



<h3 id="3-4-APIæ¥å£è®¾è®¡"><a href="#3-4-APIæ¥å£è®¾è®¡" class="headerlink" title="3.4 APIæ¥å£è®¾è®¡"></a>3.4 APIæ¥å£è®¾è®¡</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/api/chat.py</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint, request, jsonify, session</span><br><span class="line"><span class="keyword">from</span> flask_login <span class="keyword">import</span> login_required, current_user</span><br><span class="line"><span class="keyword">from</span> app.core.chatbot <span class="keyword">import</span> ChatBot</span><br><span class="line"><span class="keyword">from</span> app.database.crud <span class="keyword">import</span> save_message, get_chat_history</span><br><span class="line"><span class="keyword">from</span> app.utils.logger <span class="keyword">import</span> setup_logger</span><br><span class="line"></span><br><span class="line">chat_bp = Blueprint(<span class="string">&#x27;chat&#x27;</span>, __name__)</span><br><span class="line">logger = setup_logger(__name__)</span><br><span class="line">chatbot = ChatBot()</span><br><span class="line"></span><br><span class="line"><span class="meta">@chat_bp.route(<span class="params"><span class="string">&#x27;/send&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">send_message</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å‘é€æ¶ˆæ¯æ¥å£</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Request JSON:</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;message&quot;: &quot;ç”¨æˆ·æ¶ˆæ¯&quot;,</span></span><br><span class="line"><span class="string">        &quot;session_id&quot;: &quot;ä¼šè¯IDï¼ˆå¯é€‰ï¼‰&quot;,</span></span><br><span class="line"><span class="string">        &quot;context&quot;: &#123;&quot;key&quot;: &quot;value&quot;&#125;  # ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = request.get_json()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data <span class="keyword">or</span> <span class="string">&#x27;message&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                <span class="string">&quot;error&quot;</span>: <span class="string">&quot;æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º&quot;</span>,</span><br><span class="line">                <span class="string">&quot;code&quot;</span>: <span class="number">400</span></span><br><span class="line">            &#125;), <span class="number">400</span></span><br><span class="line">        </span><br><span class="line">        user_message = data[<span class="string">&#x27;message&#x27;</span>]</span><br><span class="line">        session_id = data.get(<span class="string">&#x27;session_id&#x27;</span>) <span class="keyword">or</span> <span class="string">f&quot;session_<span class="subst">&#123;current_user.<span class="built_in">id</span>&#125;</span>_<span class="subst">&#123;datetime.now().timestamp()&#125;</span>&quot;</span></span><br><span class="line">        user_context = data.get(<span class="string">&#x27;context&#x27;</span>, &#123;&#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è·å–èŠå¤©å†å²ä½œä¸ºä¸Šä¸‹æ–‡</span></span><br><span class="line">        chat_history = <span class="keyword">await</span> get_chat_history(</span><br><span class="line">            user_id=current_user.<span class="built_in">id</span>,</span><br><span class="line">            session_id=session_id,</span><br><span class="line">            limit=<span class="number">10</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å¤„ç†æ¶ˆæ¯</span></span><br><span class="line">        response = <span class="keyword">await</span> chatbot.process_message(</span><br><span class="line">            user_message, </span><br><span class="line">            session_id,</span><br><span class="line">            &#123;**user_context, <span class="string">&quot;history&quot;</span>: chat_history&#125;</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“</span></span><br><span class="line">        <span class="keyword">await</span> save_message(</span><br><span class="line">            user_id=current_user.<span class="built_in">id</span>,</span><br><span class="line">            session_id=session_id,</span><br><span class="line">            role=<span class="string">&quot;user&quot;</span>,</span><br><span class="line">            content=user_message,</span><br><span class="line">            metadata=&#123;<span class="string">&quot;intent&quot;</span>: response[<span class="string">&quot;metadata&quot;</span>][<span class="string">&quot;intent&quot;</span>]&#125;</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">await</span> save_message(</span><br><span class="line">            user_id=current_user.<span class="built_in">id</span>,</span><br><span class="line">            session_id=session_id,</span><br><span class="line">            role=<span class="string">&quot;assistant&quot;</span>,</span><br><span class="line">            content=response[<span class="string">&quot;reply&quot;</span>],</span><br><span class="line">            metadata=response[<span class="string">&quot;metadata&quot;</span>]</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;reply&quot;</span>: response[<span class="string">&quot;reply&quot;</span>],</span><br><span class="line">                <span class="string">&quot;session_id&quot;</span>: session_id,</span><br><span class="line">                <span class="string">&quot;metadata&quot;</span>: response[<span class="string">&quot;metadata&quot;</span>],</span><br><span class="line">                <span class="string">&quot;suggested_responses&quot;</span>: response.get(<span class="string">&quot;suggested_responses&quot;</span>, []),</span><br><span class="line">                <span class="string">&quot;timestamp&quot;</span>: datetime.utcnow().isoformat()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Error in send_message: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;error&quot;</span>: <span class="string">&quot;å¤„ç†æ¶ˆæ¯æ—¶å‘ç”Ÿé”™è¯¯&quot;</span>,</span><br><span class="line">            <span class="string">&quot;code&quot;</span>: <span class="number">500</span>,</span><br><span class="line">            <span class="string">&quot;details&quot;</span>: <span class="built_in">str</span>(e)</span><br><span class="line">        &#125;), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@chat_bp.route(<span class="params"><span class="string">&#x27;/sessions&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_sessions</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è·å–ç”¨æˆ·çš„èŠå¤©ä¼šè¯åˆ—è¡¨&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        sessions = <span class="keyword">await</span> get_user_sessions(current_user.<span class="built_in">id</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;sessions&quot;</span>: sessions,</span><br><span class="line">                <span class="string">&quot;count&quot;</span>: <span class="built_in">len</span>(sessions)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Error getting sessions: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;error&quot;</span>: <span class="string">&quot;è·å–ä¼šè¯åˆ—è¡¨å¤±è´¥&quot;</span>,</span><br><span class="line">            <span class="string">&quot;code&quot;</span>: <span class="number">500</span></span><br><span class="line">        &#125;), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@chat_bp.route(<span class="params"><span class="string">&#x27;/history/&lt;session_id&gt;&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_history</span>(<span class="params">session_id: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è·å–ç‰¹å®šä¼šè¯çš„å†å²è®°å½•&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        messages = <span class="keyword">await</span> get_chat_history(</span><br><span class="line">            user_id=current_user.<span class="built_in">id</span>,</span><br><span class="line">            session_id=session_id,</span><br><span class="line">            limit=<span class="number">50</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;session_id&quot;</span>: session_id,</span><br><span class="line">                <span class="string">&quot;messages&quot;</span>: messages,</span><br><span class="line">                <span class="string">&quot;count&quot;</span>: <span class="built_in">len</span>(messages)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Error getting history: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;error&quot;</span>: <span class="string">&quot;è·å–å†å²è®°å½•å¤±è´¥&quot;</span>,</span><br><span class="line">            <span class="string">&quot;code&quot;</span>: <span class="number">500</span></span><br><span class="line">        &#125;), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@chat_bp.route(<span class="params"><span class="string">&#x27;/generate-dialogue&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">generate_dialogue</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ç”Ÿæˆç¤ºä¾‹å¯¹è¯</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Request JSON:</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;topic&quot;: &quot;å¯¹è¯ä¸»é¢˜&quot;,</span></span><br><span class="line"><span class="string">        &quot;num_exchanges&quot;: 5</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = request.get_json()</span><br><span class="line">        topic = data.get(<span class="string">&#x27;topic&#x27;</span>, <span class="string">&#x27;äººå·¥æ™ºèƒ½&#x27;</span>)</span><br><span class="line">        num_exchanges = <span class="built_in">min</span>(data.get(<span class="string">&#x27;num_exchanges&#x27;</span>, <span class="number">5</span>), <span class="number">20</span>)</span><br><span class="line">        </span><br><span class="line">        dialogue = <span class="keyword">await</span> chatbot.generate_dialogue(topic, num_exchanges)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;topic&quot;</span>: topic,</span><br><span class="line">                <span class="string">&quot;dialogue&quot;</span>: dialogue,</span><br><span class="line">                <span class="string">&quot;total_exchanges&quot;</span>: <span class="built_in">len</span>(dialogue)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Error generating dialogue: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;error&quot;</span>: <span class="string">&quot;ç”Ÿæˆå¯¹è¯å¤±è´¥&quot;</span>,</span><br><span class="line">            <span class="string">&quot;code&quot;</span>: <span class="number">500</span></span><br><span class="line">        &#125;), <span class="number">500</span></span><br></pre></td></tr></table></figure>



<h3 id="3-5-æµ‹è¯•ç”¨ä¾‹"><a href="#3-5-æµ‹è¯•ç”¨ä¾‹" class="headerlink" title="3.5 æµ‹è¯•ç”¨ä¾‹"></a>3.5 æµ‹è¯•ç”¨ä¾‹</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tests/test_chatbot.py</span></span><br><span class="line"><span class="keyword">import</span> pytest</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> Mock, patch, AsyncMock</span><br><span class="line"><span class="keyword">from</span> app.core.chatbot <span class="keyword">import</span> ChatBot</span><br><span class="line"><span class="keyword">from</span> app.core.intent_detector <span class="keyword">import</span> IntentDetector</span><br><span class="line"><span class="keyword">from</span> app.core.emotion_analyzer <span class="keyword">import</span> EmotionAnalyzer</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestChatBot</span>:</span><br><span class="line"><span class="meta">    @pytest.fixture</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">chatbot</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆ›å»ºèŠå¤©æœºå™¨äººå®ä¾‹&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> patch(<span class="string">&#x27;app.core.chatbot.AIService&#x27;</span>) <span class="keyword">as</span> mock_ai:</span><br><span class="line">            mock_ai.return_value = AsyncMock()</span><br><span class="line">            mock_ai.return_value.generate_response.return_value = &#123;</span><br><span class="line">                <span class="string">&quot;content&quot;</span>: <span class="string">&quot;è¿™æ˜¯AIç”Ÿæˆçš„å›ç­”&quot;</span>,</span><br><span class="line">                <span class="string">&quot;tokens_used&quot;</span>: <span class="number">50</span></span><br><span class="line">            &#125;</span><br><span class="line">            bot = ChatBot()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Mockæ„å›¾è¯†åˆ«å’Œæƒ…æ„Ÿåˆ†æ</span></span><br><span class="line">            bot.intent_detector.detect = AsyncMock(return_value=<span class="string">&quot;greeting&quot;</span>)</span><br><span class="line">            bot.emotion_analyzer.analyze = AsyncMock(return_value=<span class="string">&quot;positive&quot;</span>)</span><br><span class="line">            bot.cache.get_cached_response = AsyncMock(return_value=<span class="literal">None</span>)</span><br><span class="line">            bot.cache.cache_response = AsyncMock()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> bot</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @pytest.mark.asyncio</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">test_process_greeting_message</span>(<span class="params">self, chatbot</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æµ‹è¯•å¤„ç†é—®å€™æ¶ˆæ¯&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># å‡†å¤‡æµ‹è¯•æ•°æ®</span></span><br><span class="line">        test_message = <span class="string">&quot;ä½ å¥½&quot;</span></span><br><span class="line">        session_id = <span class="string">&quot;test_session_123&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ‰§è¡Œæµ‹è¯•</span></span><br><span class="line">        result = <span class="keyword">await</span> chatbot.process_message(test_message, session_id)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># éªŒè¯ç»“æœ</span></span><br><span class="line">        <span class="keyword">assert</span> <span class="string">&quot;reply&quot;</span> <span class="keyword">in</span> result</span><br><span class="line">        <span class="keyword">assert</span> <span class="string">&quot;metadata&quot;</span> <span class="keyword">in</span> result</span><br><span class="line">        <span class="keyword">assert</span> <span class="string">&quot;suggested_responses&quot;</span> <span class="keyword">in</span> result</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># éªŒè¯æ„å›¾è¯†åˆ«è¢«è°ƒç”¨</span></span><br><span class="line">        chatbot.intent_detector.detect.assert_called_once()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># éªŒè¯å›å¤åŒ…å«é—®å€™è¯­</span></span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">any</span>(greeting <span class="keyword">in</span> result[<span class="string">&quot;reply&quot;</span>] </span><br><span class="line">                  <span class="keyword">for</span> greeting <span class="keyword">in</span> chatbot.personality_traits[<span class="string">&quot;knowledge_base&quot;</span>][<span class="string">&quot;greetings&quot;</span>])</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @pytest.mark.asyncio</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">test_process_question_message</span>(<span class="params">self, chatbot</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æµ‹è¯•å¤„ç†é—®é¢˜æ¶ˆæ¯&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># æ¨¡æ‹Ÿæ„å›¾ä¸ºé—®é¢˜</span></span><br><span class="line">        chatbot.intent_detector.detect = AsyncMock(return_value=<span class="string">&quot;question&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        test_message = <span class="string">&quot;Pythonæ˜¯ä»€ä¹ˆï¼Ÿ&quot;</span></span><br><span class="line">        session_id = <span class="string">&quot;test_session_456&quot;</span></span><br><span class="line">        </span><br><span class="line">        result = <span class="keyword">await</span> chatbot.process_message(test_message, session_id)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">assert</span> result[<span class="string">&quot;reply&quot;</span>] == <span class="string">&quot;è¿™æ˜¯AIç”Ÿæˆçš„å›ç­”&quot;</span></span><br><span class="line">        <span class="keyword">assert</span> <span class="string">&quot;tokens_used&quot;</span> <span class="keyword">in</span> result[<span class="string">&quot;metadata&quot;</span>]</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @pytest.mark.asyncio</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">test_cache_usage</span>(<span class="params">self, chatbot</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æµ‹è¯•ç¼“å­˜ä½¿ç”¨&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œåº”è¯¥ä¸ä½¿ç”¨ç¼“å­˜</span></span><br><span class="line">        <span class="keyword">await</span> chatbot.process_message(<span class="string">&quot;æµ‹è¯•æ¶ˆæ¯&quot;</span>, <span class="string">&quot;session1&quot;</span>)</span><br><span class="line">        chatbot.cache.get_cached_response.assert_called_once()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># é‡ç½®mock</span></span><br><span class="line">        chatbot.cache.get_cached_response.reset_mock()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ¨¡æ‹Ÿç¼“å­˜å‘½ä¸­</span></span><br><span class="line">        chatbot.cache.get_cached_response.return_value = &#123;</span><br><span class="line">            <span class="string">&quot;reply&quot;</span>: <span class="string">&quot;ç¼“å­˜çš„å›å¤&quot;</span>,</span><br><span class="line">            <span class="string">&quot;metadata&quot;</span>: &#123;<span class="string">&quot;cached&quot;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">            <span class="string">&quot;suggested_responses&quot;</span>: []</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        result = <span class="keyword">await</span> chatbot.process_message(<span class="string">&quot;æµ‹è¯•æ¶ˆæ¯&quot;</span>, <span class="string">&quot;session1&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># éªŒè¯ä½¿ç”¨äº†ç¼“å­˜</span></span><br><span class="line">        <span class="keyword">assert</span> result[<span class="string">&quot;reply&quot;</span>] == <span class="string">&quot;ç¼“å­˜çš„å›å¤&quot;</span></span><br><span class="line">        chatbot.intent_detector.detect.assert_not_called()</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @pytest.mark.asyncio</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">test_error_handling</span>(<span class="params">self, chatbot</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æµ‹è¯•é”™è¯¯å¤„ç†&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># æ¨¡æ‹Ÿå¼‚å¸¸</span></span><br><span class="line">        chatbot.intent_detector.detect = AsyncMock(side_effect=Exception(<span class="string">&quot;æµ‹è¯•å¼‚å¸¸&quot;</span>))</span><br><span class="line">        </span><br><span class="line">        result = <span class="keyword">await</span> chatbot.process_message(<span class="string">&quot;ä»»ä½•æ¶ˆæ¯&quot;</span>, <span class="string">&quot;session_error&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># éªŒè¯è¿”å›äº†é”™è¯¯å›å¤</span></span><br><span class="line">        <span class="keyword">assert</span> <span class="string">&quot;æŠ±æ­‰&quot;</span> <span class="keyword">in</span> result[<span class="string">&quot;reply&quot;</span>]</span><br><span class="line">        <span class="keyword">assert</span> <span class="string">&quot;error&quot;</span> <span class="keyword">in</span> result[<span class="string">&quot;metadata&quot;</span>]</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @pytest.mark.asyncio</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">test_generate_dialogue</span>(<span class="params">self, chatbot</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æµ‹è¯•ç”Ÿæˆå¯¹è¯&quot;&quot;&quot;</span></span><br><span class="line">        topic = <span class="string">&quot;äººå·¥æ™ºèƒ½çš„æœªæ¥&quot;</span></span><br><span class="line">        </span><br><span class="line">        dialogue = <span class="keyword">await</span> chatbot.generate_dialogue(topic, num_exchanges=<span class="number">3</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">isinstance</span>(dialogue, <span class="built_in">list</span>)</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(dialogue) == <span class="number">3</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># éªŒè¯å¯¹è¯ç»“æ„</span></span><br><span class="line">        <span class="keyword">for</span> i, turn <span class="keyword">in</span> <span class="built_in">enumerate</span>(dialogue):</span><br><span class="line">            <span class="keyword">assert</span> <span class="string">&quot;role&quot;</span> <span class="keyword">in</span> turn</span><br><span class="line">            <span class="keyword">assert</span> <span class="string">&quot;content&quot;</span> <span class="keyword">in</span> turn</span><br><span class="line">            <span class="keyword">assert</span> turn[<span class="string">&quot;role&quot;</span>] <span class="keyword">in</span> [<span class="string">&quot;user&quot;</span>, <span class="string">&quot;assistant&quot;</span>]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># ç¬¬ä¸€ä¸ªåº”è¯¥æ˜¯åŠ©æ‰‹å¼€åœº</span></span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">assert</span> turn[<span class="string">&quot;role&quot;</span>] == <span class="string">&quot;assistant&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># tests/test_api.py</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> pytest</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestChatAPI</span>:</span><br><span class="line"><span class="meta">    @pytest.fixture</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">client</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆ›å»ºæµ‹è¯•å®¢æˆ·ç«¯&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">from</span> app <span class="keyword">import</span> create_app</span><br><span class="line">        app = create_app(<span class="string">&#x27;testing&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> app.test_client() <span class="keyword">as</span> client:</span><br><span class="line">            <span class="keyword">yield</span> client</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_send_message_missing_data</span>(<span class="params">self, client</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æµ‹è¯•å‘é€æ¶ˆæ¯ç¼ºå°‘æ•°æ®&quot;&quot;&quot;</span></span><br><span class="line">        response = client.post(<span class="string">&#x27;/api/chat/send&#x27;</span>, </span><br><span class="line">                              data=json.dumps(&#123;&#125;),</span><br><span class="line">                              content_type=<span class="string">&#x27;application/json&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">assert</span> response.status_code == <span class="number">400</span></span><br><span class="line">        data = json.loads(response.data)</span><br><span class="line">        <span class="keyword">assert</span> <span class="string">&quot;error&quot;</span> <span class="keyword">in</span> data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_send_message_success</span>(<span class="params">self, client</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æµ‹è¯•æˆåŠŸå‘é€æ¶ˆæ¯&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># éœ€è¦å…ˆç™»å½•</span></span><br><span class="line">        <span class="comment"># è¿™é‡Œç®€åŒ–ï¼Œå®é™…æµ‹è¯•éœ€è¦æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•</span></span><br><span class="line">        test_data = &#123;</span><br><span class="line">            <span class="string">&quot;message&quot;</span>: <span class="string">&quot;ä½ å¥½&quot;</span>,</span><br><span class="line">            <span class="string">&quot;session_id&quot;</span>: <span class="string">&quot;test_session&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        response = client.post(<span class="string">&#x27;/api/chat/send&#x27;</span>,</span><br><span class="line">                              data=json.dumps(test_data),</span><br><span class="line">                              content_type=<span class="string">&#x27;application/json&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç”±äºæœªç™»å½•ï¼Œåº”è¯¥è¿”å›401</span></span><br><span class="line">        <span class="keyword">assert</span> response.status_code <span class="keyword">in</span> [<span class="number">401</span>, <span class="number">200</span>]  <span class="comment"># å–å†³äºè®¤è¯é…ç½®</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_generate_dialogue</span>(<span class="params">self, client</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æµ‹è¯•ç”Ÿæˆå¯¹è¯æ¥å£&quot;&quot;&quot;</span></span><br><span class="line">        test_data = &#123;</span><br><span class="line">            <span class="string">&quot;topic&quot;</span>: <span class="string">&quot;æœºå™¨å­¦ä¹ &quot;</span>,</span><br><span class="line">            <span class="string">&quot;num_exchanges&quot;</span>: <span class="number">3</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        response = client.post(<span class="string">&#x27;/api/chat/generate-dialogue&#x27;</span>,</span><br><span class="line">                              data=json.dumps(test_data),</span><br><span class="line">                              content_type=<span class="string">&#x27;application/json&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        data = json.loads(response.data)</span><br><span class="line">        <span class="keyword">assert</span> response.status_code == <span class="number">200</span></span><br><span class="line">        <span class="keyword">assert</span> data[<span class="string">&quot;success&quot;</span>] == <span class="literal">True</span></span><br><span class="line">        <span class="keyword">assert</span> <span class="string">&quot;dialogue&quot;</span> <span class="keyword">in</span> data[<span class="string">&quot;data&quot;</span>]</span><br><span class="line">        <span class="keyword">assert</span> data[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;topic&quot;</span>] == <span class="string">&quot;æœºå™¨å­¦ä¹ &quot;</span></span><br></pre></td></tr></table></figure>



<h3 id="3-6-ä½¿ç”¨æ¡ˆä¾‹"><a href="#3-6-ä½¿ç”¨æ¡ˆä¾‹" class="headerlink" title="3.6 ä½¿ç”¨æ¡ˆä¾‹"></a>3.6 ä½¿ç”¨æ¡ˆä¾‹</h3><h4 id="æ¡ˆä¾‹1ï¼šåŸºç¡€èŠå¤©"><a href="#æ¡ˆä¾‹1ï¼šåŸºç¡€èŠå¤©" class="headerlink" title="æ¡ˆä¾‹1ï¼šåŸºç¡€èŠå¤©"></a>æ¡ˆä¾‹1ï¼šåŸºç¡€èŠå¤©</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># examples/basic_chat.py</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> app.core.chatbot <span class="keyword">import</span> ChatBot</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">basic_chat_example</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åŸºç¡€èŠå¤©ç¤ºä¾‹&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">50</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;AIèŠå¤©æœºå™¨äººæ¼”ç¤º&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">50</span>)</span><br><span class="line">    </span><br><span class="line">    bot = ChatBot()</span><br><span class="line">    session_id = <span class="string">&quot;demo_session_001&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å¯¹è¯ç¤ºä¾‹</span></span><br><span class="line">    conversations = [</span><br><span class="line">        <span class="string">&quot;ä½ å¥½ï¼&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ä½ å«ä»€ä¹ˆåå­—ï¼Ÿ&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ä½ èƒ½åšä»€ä¹ˆï¼Ÿ&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ç»™æˆ‘è®²ä¸ªç¬‘è¯&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Pythonå’ŒJavaå“ªä¸ªæ›´å¥½ï¼Ÿ&quot;</span>,</span><br><span class="line">        <span class="string">&quot;è°¢è°¢ï¼Œå†è§ï¼&quot;</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> message <span class="keyword">in</span> conversations:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n[ç”¨æˆ·]: <span class="subst">&#123;message&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        response = <span class="keyword">await</span> bot.process_message(message, session_id)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[åŠ©æ‰‹]: <span class="subst">&#123;response[<span class="string">&#x27;reply&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> response.get(<span class="string">&#x27;suggested_responses&#x27;</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\nå»ºè®®å›å¤: <span class="subst">&#123;<span class="string">&#x27;, &#x27;</span>.join(response[<span class="string">&#x27;suggested_responses&#x27;</span>][:<span class="number">3</span>])&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ˜¾ç¤ºå…ƒæ•°æ®</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n[æ„å›¾]: <span class="subst">&#123;response[<span class="string">&#x27;metadata&#x27;</span>][<span class="string">&#x27;intent&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[æƒ…æ„Ÿ]: <span class="subst">&#123;response[<span class="string">&#x27;metadata&#x27;</span>][<span class="string">&#x27;emotion&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)  <span class="comment"># æ¨¡æ‹Ÿæ€è€ƒæ—¶é—´</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span> + <span class="string">&quot;=&quot;</span> * <span class="number">50</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;å¯¹è¯ç»“æŸ&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">50</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡Œç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    asyncio.run(basic_chat_example())</span><br></pre></td></tr></table></figure>



<h4 id="æ¡ˆä¾‹2ï¼šæ•°æ®åˆ†æä»ªè¡¨ç›˜"><a href="#æ¡ˆä¾‹2ï¼šæ•°æ®åˆ†æä»ªè¡¨ç›˜" class="headerlink" title="æ¡ˆä¾‹2ï¼šæ•°æ®åˆ†æä»ªè¡¨ç›˜"></a>æ¡ˆä¾‹2ï¼šæ•°æ®åˆ†æä»ªè¡¨ç›˜</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># examples/analytics_dashboard.py</span></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> plotly.graph_objects <span class="keyword">as</span> go</span><br><span class="line"><span class="keyword">from</span> plotly.subplots <span class="keyword">import</span> make_subplots</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_chat_analytics</span>(<span class="params">user_id: <span class="built_in">int</span>, days: <span class="built_in">int</span> = <span class="number">7</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ç”ŸæˆèŠå¤©æ•°æ®åˆ†æ</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        user_id: ç”¨æˆ·ID</span></span><br><span class="line"><span class="string">        days: åˆ†æå¤©æ•°</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        Dict: åˆ†æç»“æœ</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># æ¨¡æ‹Ÿç”Ÿæˆæ•°æ®</span></span><br><span class="line">    end_date = datetime.now()</span><br><span class="line">    start_date = end_date - timedelta(days=days)</span><br><span class="line">    </span><br><span class="line">    dates = [start_date + timedelta(days=i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(days)]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ¨¡æ‹Ÿæ¯æ—¥æ¶ˆæ¯æ•°</span></span><br><span class="line">    daily_messages = [random.randint(<span class="number">5</span>, <span class="number">50</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(days)]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ¨¡æ‹Ÿæ„å›¾åˆ†å¸ƒ</span></span><br><span class="line">    intents = [<span class="string">&#x27;greeting&#x27;</span>, <span class="string">&#x27;question&#x27;</span>, <span class="string">&#x27;conversation&#x27;</span>, <span class="string">&#x27;command&#x27;</span>, <span class="string">&#x27;other&#x27;</span>]</span><br><span class="line">    intent_counts = &#123;intent: random.randint(<span class="number">1</span>, <span class="number">20</span>) <span class="keyword">for</span> intent <span class="keyword">in</span> intents&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åˆ›å»ºå›¾è¡¨</span></span><br><span class="line">    fig = make_subplots(</span><br><span class="line">        rows=<span class="number">2</span>, cols=<span class="number">2</span>,</span><br><span class="line">        subplot_titles=(<span class="string">&#x27;æ¯æ—¥æ¶ˆæ¯è¶‹åŠ¿&#x27;</span>, <span class="string">&#x27;æ„å›¾åˆ†å¸ƒ&#x27;</span>, <span class="string">&#x27;æ´»è·ƒæ—¶é—´æ®µ&#x27;</span>, <span class="string">&#x27;æƒ…æ„Ÿåˆ†æ&#x27;</span>),</span><br><span class="line">        specs=[[&#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;scatter&#x27;</span>&#125;, &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;pie&#x27;</span>&#125;],</span><br><span class="line">               [&#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;bar&#x27;</span>&#125;, &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;scatter&#x27;</span>&#125;]]</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 1. æ¯æ—¥æ¶ˆæ¯è¶‹åŠ¿</span></span><br><span class="line">    fig.add_trace(</span><br><span class="line">        go.Scatter(x=dates, y=daily_messages, mode=<span class="string">&#x27;lines+markers&#x27;</span>, </span><br><span class="line">                  name=<span class="string">&#x27;æ¶ˆæ¯æ•°&#x27;</span>, line=<span class="built_in">dict</span>(color=<span class="string">&#x27;blue&#x27;</span>)),</span><br><span class="line">        row=<span class="number">1</span>, col=<span class="number">1</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. æ„å›¾åˆ†å¸ƒé¥¼å›¾</span></span><br><span class="line">    fig.add_trace(</span><br><span class="line">        go.Pie(labels=<span class="built_in">list</span>(intent_counts.keys()), </span><br><span class="line">              values=<span class="built_in">list</span>(intent_counts.values()),</span><br><span class="line">              name=<span class="string">&#x27;æ„å›¾åˆ†å¸ƒ&#x27;</span>),</span><br><span class="line">        row=<span class="number">1</span>, col=<span class="number">2</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. æ´»è·ƒæ—¶é—´æ®µ</span></span><br><span class="line">    hours = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">24</span>))</span><br><span class="line">    hour_activity = [random.randint(<span class="number">0</span>, <span class="number">100</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> hours]</span><br><span class="line">    </span><br><span class="line">    fig.add_trace(</span><br><span class="line">        go.Bar(x=hours, y=hour_activity, name=<span class="string">&#x27;æ´»è·ƒåº¦&#x27;</span>, marker_color=<span class="string">&#x27;green&#x27;</span>),</span><br><span class="line">        row=<span class="number">2</span>, col=<span class="number">1</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4. æƒ…æ„Ÿè¶‹åŠ¿</span></span><br><span class="line">    emotions = [<span class="string">&#x27;positive&#x27;</span>, <span class="string">&#x27;neutral&#x27;</span>, <span class="string">&#x27;negative&#x27;</span>]</span><br><span class="line">    emotion_data = &#123;</span><br><span class="line">        <span class="string">&#x27;positive&#x27;</span>: [random.randint(<span class="number">30</span>, <span class="number">80</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(days)],</span><br><span class="line">        <span class="string">&#x27;neutral&#x27;</span>: [random.randint(<span class="number">10</span>, <span class="number">50</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(days)],</span><br><span class="line">        <span class="string">&#x27;negative&#x27;</span>: [random.randint(<span class="number">0</span>, <span class="number">20</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(days)]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> emotion <span class="keyword">in</span> emotions:</span><br><span class="line">        fig.add_trace(</span><br><span class="line">            go.Scatter(x=dates, y=emotion_data[emotion], </span><br><span class="line">                      mode=<span class="string">&#x27;lines&#x27;</span>, name=emotion),</span><br><span class="line">            row=<span class="number">2</span>, col=<span class="number">2</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    fig.update_layout(height=<span class="number">800</span>, showlegend=<span class="literal">True</span>, title_text=<span class="string">&quot;èŠå¤©æ•°æ®åˆ†æ&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡</span></span><br><span class="line">    stats = &#123;</span><br><span class="line">        <span class="string">&quot;total_messages&quot;</span>: <span class="built_in">sum</span>(daily_messages),</span><br><span class="line">        <span class="string">&quot;avg_daily_messages&quot;</span>: <span class="built_in">sum</span>(daily_messages) / days,</span><br><span class="line">        <span class="string">&quot;most_active_hour&quot;</span>: hours[hour_activity.index(<span class="built_in">max</span>(hour_activity))],</span><br><span class="line">        <span class="string">&quot;dominant_intent&quot;</span>: <span class="built_in">max</span>(intent_counts, key=intent_counts.get),</span><br><span class="line">        <span class="string">&quot;positive_ratio&quot;</span>: <span class="built_in">sum</span>(emotion_data[<span class="string">&#x27;positive&#x27;</span>]) / </span><br><span class="line">                         (<span class="built_in">sum</span>(emotion_data[<span class="string">&#x27;positive&#x27;</span>]) + </span><br><span class="line">                          <span class="built_in">sum</span>(emotion_data[<span class="string">&#x27;neutral&#x27;</span>]) + </span><br><span class="line">                          <span class="built_in">sum</span>(emotion_data[<span class="string">&#x27;negative&#x27;</span>]))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;user_id&quot;</span>: user_id,</span><br><span class="line">        <span class="string">&quot;analysis_period&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;start&quot;</span>: start_date.strftime(<span class="string">&quot;%Y-%m-%d&quot;</span>),</span><br><span class="line">            <span class="string">&quot;end&quot;</span>: end_date.strftime(<span class="string">&quot;%Y-%m-%d&quot;</span>),</span><br><span class="line">            <span class="string">&quot;days&quot;</span>: days</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;statistics&quot;</span>: stats,</span><br><span class="line">        <span class="string">&quot;charts&quot;</span>: fig.to_dict()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># ç”Ÿæˆç¤ºä¾‹åˆ†ææŠ¥å‘Š</span></span><br><span class="line">    analytics = generate_chat_analytics(user_id=<span class="number">123</span>, days=<span class="number">7</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;èŠå¤©æ•°æ®åˆ†ææŠ¥å‘Š&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">50</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;ç”¨æˆ·ID: <span class="subst">&#123;analytics[<span class="string">&#x27;user_id&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;åˆ†æå‘¨æœŸ: <span class="subst">&#123;analytics[<span class="string">&#x27;analysis_period&#x27;</span>][<span class="string">&#x27;start&#x27;</span>]&#125;</span> åˆ° &quot;</span></span><br><span class="line">          <span class="string">f&quot;<span class="subst">&#123;analytics[<span class="string">&#x27;analysis_period&#x27;</span>][<span class="string">&#x27;end&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line">    </span><br><span class="line">    stats = analytics[<span class="string">&#x27;statistics&#x27;</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ç»Ÿè®¡æ‘˜è¦:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  æ€»æ¶ˆæ¯æ•°: <span class="subst">&#123;stats[<span class="string">&#x27;total_messages&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  æ—¥å‡æ¶ˆæ¯: <span class="subst">&#123;stats[<span class="string">&#x27;avg_daily_messages&#x27;</span>]:<span class="number">.1</span>f&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  æœ€æ´»è·ƒæ—¶æ®µ: <span class="subst">&#123;stats[<span class="string">&#x27;most_active_hour&#x27;</span>]&#125;</span>:00&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  ä¸»è¦æ„å›¾: <span class="subst">&#123;stats[<span class="string">&#x27;dominant_intent&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  ç§¯ææƒ…ç»ªæ¯”ä¾‹: <span class="subst">&#123;stats[<span class="string">&#x27;positive_ratio&#x27;</span>]:<span class="number">.1</span>%&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å›¾è¡¨å¯ä»¥ä¿å­˜ä¸ºHTMLæ–‡ä»¶æˆ–æ˜¾ç¤ºåœ¨Webç•Œé¢</span></span><br><span class="line">    fig = go.Figure(data=analytics[<span class="string">&#x27;charts&#x27;</span>][<span class="string">&#x27;data&#x27;</span>], </span><br><span class="line">                    layout=analytics[<span class="string">&#x27;charts&#x27;</span>][<span class="string">&#x27;layout&#x27;</span>])</span><br><span class="line">    fig.write_html(<span class="string">&quot;chat_analytics.html&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nå›¾è¡¨å·²ä¿å­˜ä¸º chat_analytics.html&quot;</span>)</span><br></pre></td></tr></table></figure>



<h4 id="æ¡ˆä¾‹3ï¼šå¤šè½®å¯¹è¯åœºæ™¯"><a href="#æ¡ˆä¾‹3ï¼šå¤šè½®å¯¹è¯åœºæ™¯" class="headerlink" title="æ¡ˆä¾‹3ï¼šå¤šè½®å¯¹è¯åœºæ™¯"></a>æ¡ˆä¾‹3ï¼šå¤šè½®å¯¹è¯åœºæ™¯</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># examples/conversation_scenario.py</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span></span><br><span class="line"><span class="keyword">from</span> app.core.chatbot <span class="keyword">import</span> ChatBot</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConversationScenario</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¯¹è¯åœºæ™¯ç®¡ç†&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.bot = ChatBot()</span><br><span class="line">        self.context = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">run_scenario</span>(<span class="params">self, scenario_name: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                          user_inputs: <span class="type">List</span>[<span class="built_in">str</span>]</span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        è¿è¡Œå¯¹è¯åœºæ™¯</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            scenario_name: åœºæ™¯åç§°</span></span><br><span class="line"><span class="string">            user_inputs: ç”¨æˆ·è¾“å…¥åºåˆ—</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            List[Dict]: å¯¹è¯è®°å½•</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\nğŸ­ å¼€å§‹åœºæ™¯: <span class="subst">&#123;scenario_name&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">50</span>)</span><br><span class="line">        </span><br><span class="line">        conversation_log = []</span><br><span class="line">        session_id = <span class="string">f&quot;scenario_<span class="subst">&#123;scenario_name&#125;</span>_<span class="subst">&#123;<span class="built_in">int</span>(asyncio.get_event_loop().time())&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i, user_input <span class="keyword">in</span> <span class="built_in">enumerate</span>(user_inputs, <span class="number">1</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\nç¬¬<span class="subst">&#123;i&#125;</span>è½®:&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[ç”¨æˆ·]: <span class="subst">&#123;user_input&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># å¤„ç†æ¶ˆæ¯ï¼Œä¼ é€’ä¸Šä¸‹æ–‡</span></span><br><span class="line">            response = <span class="keyword">await</span> self.bot.process_message(</span><br><span class="line">                user_input, </span><br><span class="line">                session_id,</span><br><span class="line">                self.context</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[åŠ©æ‰‹]: <span class="subst">&#123;response[<span class="string">&#x27;reply&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ›´æ–°ä¸Šä¸‹æ–‡</span></span><br><span class="line">            self._update_context(response)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è®°å½•å¯¹è¯</span></span><br><span class="line">            conversation_log.append(&#123;</span><br><span class="line">                <span class="string">&quot;round&quot;</span>: i,</span><br><span class="line">                <span class="string">&quot;user&quot;</span>: user_input,</span><br><span class="line">                <span class="string">&quot;assistant&quot;</span>: response[<span class="string">&quot;reply&quot;</span>],</span><br><span class="line">                <span class="string">&quot;intent&quot;</span>: response[<span class="string">&quot;metadata&quot;</span>][<span class="string">&quot;intent&quot;</span>],</span><br><span class="line">                <span class="string">&quot;emotion&quot;</span>: response[<span class="string">&quot;metadata&quot;</span>][<span class="string">&quot;emotion&quot;</span>]</span><br><span class="line">            &#125;)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ˜¾ç¤ºå»ºè®®ï¼ˆå¦‚æœæœ‰ï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> response.get(<span class="string">&#x27;suggested_responses&#x27;</span>):</span><br><span class="line">                suggestions = response[<span class="string">&#x27;suggested_responses&#x27;</span>][:<span class="number">2</span>]</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;ğŸ’¡ å»ºè®®: <span class="subst">&#123;<span class="string">&#x27;, &#x27;</span>.join(suggestions)&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span> + <span class="string">&quot;=&quot;</span> * <span class="number">50</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;åœºæ™¯ &#x27;<span class="subst">&#123;scenario_name&#125;</span>&#x27; å®Œæˆ&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;æ€»å¯¹è¯è½®æ•°: <span class="subst">&#123;<span class="built_in">len</span>(conversation_log)&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> conversation_log</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_update_context</span>(<span class="params">self, response: <span class="type">Dict</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ›´æ–°å¯¹è¯ä¸Šä¸‹æ–‡&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„ä¸Šä¸‹æ–‡ç®¡ç†é€»è¾‘</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;entities&quot;</span> <span class="keyword">in</span> response.get(<span class="string">&quot;metadata&quot;</span>, &#123;&#125;):</span><br><span class="line">            entities = response[<span class="string">&quot;metadata&quot;</span>][<span class="string">&quot;entities&quot;</span>]</span><br><span class="line">            <span class="keyword">for</span> entity_type, value <span class="keyword">in</span> entities.items():</span><br><span class="line">                self.context[entity_type] = value</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">analyze_conversation</span>(<span class="params">self, conversation_log: <span class="type">List</span>[<span class="type">Dict</span>]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆ†æå¯¹è¯è´¨é‡&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> conversation_log:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\nğŸ“Š å¯¹è¯åˆ†æ:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®¡ç®—ç»Ÿè®¡</span></span><br><span class="line">        total_rounds = <span class="built_in">len</span>(conversation_log)</span><br><span class="line">        intents = [turn[<span class="string">&quot;intent&quot;</span>] <span class="keyword">for</span> turn <span class="keyword">in</span> conversation_log]</span><br><span class="line">        emotions = [turn[<span class="string">&quot;emotion&quot;</span>] <span class="keyword">for</span> turn <span class="keyword">in</span> conversation_log]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ„å›¾åˆ†å¸ƒ</span></span><br><span class="line">        intent_counts = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> intent <span class="keyword">in</span> intents:</span><br><span class="line">            intent_counts[intent] = intent_counts.get(intent, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;å¯¹è¯è½®æ•°: <span class="subst">&#123;total_rounds&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\næ„å›¾åˆ†å¸ƒ:&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> intent, count <span class="keyword">in</span> intent_counts.items():</span><br><span class="line">            percentage = (count / total_rounds) * <span class="number">100</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  <span class="subst">&#123;intent&#125;</span>: <span class="subst">&#123;count&#125;</span>æ¬¡ (<span class="subst">&#123;percentage:<span class="number">.1</span>f&#125;</span>%)&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æƒ…æ„Ÿåˆ†æ</span></span><br><span class="line">        positive_emotions = [e <span class="keyword">for</span> e <span class="keyword">in</span> emotions <span class="keyword">if</span> e == <span class="string">&quot;positive&quot;</span>]</span><br><span class="line">        positive_ratio = <span class="built_in">len</span>(positive_emotions) / <span class="built_in">len</span>(emotions) <span class="keyword">if</span> emotions <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\nç§¯ææƒ…ç»ªæ¯”ä¾‹: <span class="subst">&#123;positive_ratio:<span class="number">.1</span>%&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å¯¹è¯è¿è´¯æ€§è¯„åˆ†ï¼ˆç®€å•ç‰ˆæœ¬ï¼‰</span></span><br><span class="line">        coherence_score = <span class="built_in">min</span>(positive_ratio * <span class="number">10</span>, <span class="number">10</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;å¯¹è¯è¿è´¯æ€§è¯„åˆ†: <span class="subst">&#123;coherence_score:<span class="number">.1</span>f&#125;</span>/10&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;total_rounds&quot;</span>: total_rounds,</span><br><span class="line">            <span class="string">&quot;intent_distribution&quot;</span>: intent_counts,</span><br><span class="line">            <span class="string">&quot;positive_ratio&quot;</span>: positive_ratio,</span><br><span class="line">            <span class="string">&quot;coherence_score&quot;</span>: coherence_score</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è¿è¡Œå¤šä¸ªå¯¹è¯åœºæ™¯&quot;&quot;&quot;</span></span><br><span class="line">    scenario_manager = ConversationScenario()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åœºæ™¯1ï¼šæŠ€æœ¯å’¨è¯¢</span></span><br><span class="line">    tech_scenario = [</span><br><span class="line">        <span class="string">&quot;ä½ å¥½ï¼Œæˆ‘æƒ³å­¦ä¹ Python&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Pythoné€‚åˆåšä»€ä¹ˆï¼Ÿ&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æˆ‘éœ€è¦å­¦ä¹ å“ªäº›åŸºç¡€çŸ¥è¯†ï¼Ÿ&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æœ‰æ¨èçš„å­¦ä¹ èµ„æºå—ï¼Ÿ&quot;</span>,</span><br><span class="line">        <span class="string">&quot;è°¢è°¢ï¼Œæˆ‘æ˜ç™½äº†&quot;</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    tech_log = <span class="keyword">await</span> scenario_manager.run_scenario(<span class="string">&quot;æŠ€æœ¯å’¨è¯¢&quot;</span>, tech_scenario)</span><br><span class="line">    <span class="keyword">await</span> scenario_manager.analyze_conversation(tech_log)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># é‡ç½®ä¸Šä¸‹æ–‡</span></span><br><span class="line">    scenario_manager.context = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åœºæ™¯2ï¼šæ—¥å¸¸èŠå¤©</span></span><br><span class="line">    daily_scenario = [</span><br><span class="line">        <span class="string">&quot;ä»Šå¤©å¤©æ°”ä¸é”™&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ä½ æœ‰ä»€ä¹ˆçˆ±å¥½å—ï¼Ÿ&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ç»™æˆ‘æ¨èä¸€éƒ¨ç”µå½±&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ä½ è§‰å¾—äººå·¥æ™ºèƒ½ä¼šå–ä»£äººç±»å—ï¼Ÿ&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æœ‰è¶£çš„è§‚ç‚¹ï¼Œè°¢è°¢ï¼&quot;</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    daily_log = <span class="keyword">await</span> scenario_manager.run_scenario(<span class="string">&quot;æ—¥å¸¸èŠå¤©&quot;</span>, daily_scenario)</span><br><span class="line">    <span class="keyword">await</span> scenario_manager.analyze_conversation(daily_log)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    asyncio.run(main())</span><br></pre></td></tr></table></figure>



<h2 id="4-åˆ†é˜¶æ®µå®ç°è®¡åˆ’"><a href="#4-åˆ†é˜¶æ®µå®ç°è®¡åˆ’" class="headerlink" title="4. åˆ†é˜¶æ®µå®ç°è®¡åˆ’"></a>4. åˆ†é˜¶æ®µå®ç°è®¡åˆ’</h2><h3 id="é˜¶æ®µ1ï¼šåŸºç¡€æ¡†æ¶æ­å»ºï¼ˆ1-2å‘¨ï¼‰"><a href="#é˜¶æ®µ1ï¼šåŸºç¡€æ¡†æ¶æ­å»ºï¼ˆ1-2å‘¨ï¼‰" class="headerlink" title="é˜¶æ®µ1ï¼šåŸºç¡€æ¡†æ¶æ­å»ºï¼ˆ1-2å‘¨ï¼‰"></a>é˜¶æ®µ1ï¼šåŸºç¡€æ¡†æ¶æ­å»ºï¼ˆ1-2å‘¨ï¼‰</h3><p><strong>ç›®æ ‡</strong>ï¼šå®ŒæˆåŸºç¡€æ¡†æ¶ï¼Œå®ç°ç®€å•èŠå¤©åŠŸèƒ½<br><strong>ä»»åŠ¡</strong>ï¼š</p>
<ol>
<li>åˆ›å»ºé¡¹ç›®ç»“æ„å’Œé…ç½®æ–‡ä»¶</li>
<li>å®ç°åŸºç¡€Flaskåº”ç”¨</li>
<li>è®¾è®¡æ•°æ®åº“æ¨¡å‹</li>
<li>å®ç°ç”¨æˆ·è®¤è¯ç³»ç»Ÿ</li>
<li>åˆ›å»ºåŸºç¡€èŠå¤©ç•Œé¢</li>
</ol>
<p><strong>æŠ€èƒ½ç‚¹</strong>ï¼š</p>
<ul>
<li>PythonåŸºç¡€è¯­æ³•</li>
<li>Flaskæ¡†æ¶åŸºç¡€</li>
<li>SQLAlchemy ORM</li>
<li>HTML&#x2F;CSSåŸºç¡€</li>
<li>Gitç‰ˆæœ¬æ§åˆ¶</li>
</ul>
<h3 id="é˜¶æ®µ2ï¼šæ ¸å¿ƒåŠŸèƒ½å¼€å‘ï¼ˆ2-3å‘¨ï¼‰"><a href="#é˜¶æ®µ2ï¼šæ ¸å¿ƒåŠŸèƒ½å¼€å‘ï¼ˆ2-3å‘¨ï¼‰" class="headerlink" title="é˜¶æ®µ2ï¼šæ ¸å¿ƒåŠŸèƒ½å¼€å‘ï¼ˆ2-3å‘¨ï¼‰"></a>é˜¶æ®µ2ï¼šæ ¸å¿ƒåŠŸèƒ½å¼€å‘ï¼ˆ2-3å‘¨ï¼‰</h3><p><strong>ç›®æ ‡</strong>ï¼šå®ç°èŠå¤©æœºå™¨äººæ ¸å¿ƒåŠŸèƒ½<br><strong>ä»»åŠ¡</strong>ï¼š</p>
<ol>
<li>å¼€å‘NLPå¤„ç†æ¨¡å—</li>
<li>å®ç°æ„å›¾è¯†åˆ«å’Œæƒ…æ„Ÿåˆ†æ</li>
<li>é›†æˆAIæ¨¡å‹ï¼ˆæœ¬åœ°æˆ–APIï¼‰</li>
<li>å®ç°å¯¹è¯ç®¡ç†</li>
<li>æ·»åŠ ç¼“å­˜æœºåˆ¶</li>
</ol>
<p><strong>æŠ€èƒ½ç‚¹</strong>ï¼š</p>
<ul>
<li>å¼‚æ­¥ç¼–ç¨‹ï¼ˆasyncioï¼‰</li>
<li>RESTful APIè®¾è®¡</li>
<li>æœºå™¨å­¦ä¹ åŸºç¡€</li>
<li>Redisç¼“å­˜</li>
<li>å•å…ƒæµ‹è¯•</li>
</ul>
<h3 id="é˜¶æ®µ3ï¼šé«˜çº§åŠŸèƒ½ä¸ä¼˜åŒ–ï¼ˆ2-3å‘¨ï¼‰"><a href="#é˜¶æ®µ3ï¼šé«˜çº§åŠŸèƒ½ä¸ä¼˜åŒ–ï¼ˆ2-3å‘¨ï¼‰" class="headerlink" title="é˜¶æ®µ3ï¼šé«˜çº§åŠŸèƒ½ä¸ä¼˜åŒ–ï¼ˆ2-3å‘¨ï¼‰"></a>é˜¶æ®µ3ï¼šé«˜çº§åŠŸèƒ½ä¸ä¼˜åŒ–ï¼ˆ2-3å‘¨ï¼‰</h3><p><strong>ç›®æ ‡</strong>ï¼šæ·»åŠ é«˜çº§åŠŸèƒ½å’Œæ€§èƒ½ä¼˜åŒ–<br><strong>ä»»åŠ¡</strong>ï¼š</p>
<ol>
<li>å®ç°æ•°æ®åˆ†ææ¨¡å—</li>
<li>æ·»åŠ WebSocketå®æ—¶èŠå¤©</li>
<li>å¼€å‘ç®¡ç†åå°</li>
<li>æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§</li>
<li>æ·»åŠ æ—¥å¿—ç³»ç»Ÿ</li>
</ol>
<p><strong>æŠ€èƒ½ç‚¹</strong>ï¼š</p>
<ul>
<li>WebSocketç¼–ç¨‹</li>
<li>æ•°æ®åˆ†æï¼ˆPandasï¼‰</li>
<li>æ•°æ®å¯è§†åŒ–</li>
<li>æ€§èƒ½ä¼˜åŒ–</li>
<li>æ—¥å¿—ç®¡ç†</li>
</ul>
<h3 id="é˜¶æ®µ4ï¼šéƒ¨ç½²ä¸è¿ç»´ï¼ˆ1-2å‘¨ï¼‰"><a href="#é˜¶æ®µ4ï¼šéƒ¨ç½²ä¸è¿ç»´ï¼ˆ1-2å‘¨ï¼‰" class="headerlink" title="é˜¶æ®µ4ï¼šéƒ¨ç½²ä¸è¿ç»´ï¼ˆ1-2å‘¨ï¼‰"></a>é˜¶æ®µ4ï¼šéƒ¨ç½²ä¸è¿ç»´ï¼ˆ1-2å‘¨ï¼‰</h3><p><strong>ç›®æ ‡</strong>ï¼šå®Œæˆé¡¹ç›®éƒ¨ç½²å’Œè¿ç»´é…ç½®<br><strong>ä»»åŠ¡</strong>ï¼š</p>
<ol>
<li>Dockerå®¹å™¨åŒ–</li>
<li>éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨</li>
<li>é…ç½®Nginxåå‘ä»£ç†</li>
<li>è®¾ç½®ç›‘æ§å‘Šè­¦</li>
<li>ç¼–å†™éƒ¨ç½²æ–‡æ¡£</li>
</ol>
<p><strong>æŠ€èƒ½ç‚¹</strong>ï¼š</p>
<ul>
<li>Dockerå®¹å™¨åŒ–</li>
<li>LinuxæœåŠ¡å™¨ç®¡ç†</li>
<li>Nginxé…ç½®</li>
<li>CI&#x2F;CDåŸºç¡€</li>
<li>ç›‘æ§å‘Šè­¦</li>
</ul>
<h2 id="5-éƒ¨ç½²æŒ‡å—"><a href="#5-éƒ¨ç½²æŒ‡å—" class="headerlink" title="5. éƒ¨ç½²æŒ‡å—"></a>5. éƒ¨ç½²æŒ‡å—</h2><h3 id="5-1-æœ¬åœ°å¼€å‘ç¯å¢ƒ"><a href="#5-1-æœ¬åœ°å¼€å‘ç¯å¢ƒ" class="headerlink" title="5.1 æœ¬åœ°å¼€å‘ç¯å¢ƒ"></a>5.1 æœ¬åœ°å¼€å‘ç¯å¢ƒ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. å…‹éš†é¡¹ç›®</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/yourusername/ai-chatbot-system.git</span><br><span class="line"><span class="built_in">cd</span> ai-chatbot-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line">python -m venv venv</span><br><span class="line"></span><br><span class="line"><span class="comment"># Windows</span></span><br><span class="line">venv\Scripts\activate</span><br><span class="line"><span class="comment"># Linux/Mac</span></span><br><span class="line"><span class="built_in">source</span> venv/bin/activate</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. å®‰è£…ä¾èµ–</span></span><br><span class="line">pip install -r requirements.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. åˆå§‹åŒ–æ•°æ®åº“</span></span><br><span class="line">python scripts/init_db.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. è¿è¡Œå¼€å‘æœåŠ¡å™¨</span></span><br><span class="line">python run.py</span><br></pre></td></tr></table></figure>



<h3 id="5-2-Dockeréƒ¨ç½²"><a href="#5-2-Dockeréƒ¨ç½²" class="headerlink" title="5.2 Dockeréƒ¨ç½²"></a>5.2 Dockeréƒ¨ç½²</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dockerfile</span></span><br><span class="line">FROM python:3.9-slim</span><br><span class="line"></span><br><span class="line">WORKDIR /app</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ç³»ç»Ÿä¾èµ–</span></span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y \</span><br><span class="line">    gcc \</span><br><span class="line">    g++ \</span><br><span class="line">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶ä¾èµ–æ–‡ä»¶</span></span><br><span class="line">COPY requirements.txt .</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…Pythonä¾èµ–</span></span><br><span class="line">RUN pip install --no-cache-dir -r requirements.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶åº”ç”¨ä»£ç </span></span><br><span class="line">COPY . .</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºérootç”¨æˆ·</span></span><br><span class="line">RUN useradd -m -u 1000 appuser &amp;&amp; <span class="built_in">chown</span> -R appuser:appuser /app</span><br><span class="line">USER appuser</span><br><span class="line"></span><br><span class="line"><span class="comment"># æš´éœ²ç«¯å£</span></span><br><span class="line">EXPOSE 5000</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨å‘½ä»¤</span></span><br><span class="line">CMD [<span class="string">&quot;gunicorn&quot;</span>, <span class="string">&quot;--bind&quot;</span>, <span class="string">&quot;0.0.0.0:5000&quot;</span>, <span class="string">&quot;app.main:app&quot;</span>]</span><br></pre></td></tr></table></figure>



<h3 id="5-3-docker-composeéƒ¨ç½²"><a href="#5-3-docker-composeéƒ¨ç½²" class="headerlink" title="5.3 docker-composeéƒ¨ç½²"></a>5.3 docker-composeéƒ¨ç½²</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;5000:5000&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DATABASE_URL=postgresql://user:password@db:5432/chatbot</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REDIS_URL=redis://redis:6379/0</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logs:/app/logs</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:13</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_USER=user</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_PASSWORD=password</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_DB=chatbot</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">postgres_data:/var/lib/postgresql/data</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:6-alpine</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis_data:/data</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx.conf:/etc/nginx/nginx.conf</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">postgres_data:</span></span><br><span class="line">  <span class="attr">redis_data:</span></span><br></pre></td></tr></table></figure>



<h2 id="6-é¡¹ç›®ç‰¹è‰²ä¸å¯ç©æ€§"><a href="#6-é¡¹ç›®ç‰¹è‰²ä¸å¯ç©æ€§" class="headerlink" title="6. é¡¹ç›®ç‰¹è‰²ä¸å¯ç©æ€§"></a>6. é¡¹ç›®ç‰¹è‰²ä¸å¯ç©æ€§</h2><h3 id="6-1-æ¸¸æˆåŒ–åŠŸèƒ½"><a href="#6-1-æ¸¸æˆåŒ–åŠŸèƒ½" class="headerlink" title="6.1 æ¸¸æˆåŒ–åŠŸèƒ½"></a>6.1 æ¸¸æˆåŒ–åŠŸèƒ½</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç§¯åˆ†å’Œæˆå°±ç³»ç»Ÿ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AchievementSystem</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æˆå°±ç³»ç»Ÿ&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    ACHIEVEMENTS = &#123;</span><br><span class="line">        <span class="string">&quot;first_chat&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;åˆæ¬¡å¯¹è¯&quot;</span>,</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;å®Œæˆç¬¬ä¸€æ¬¡å¯¹è¯&quot;</span>,</span><br><span class="line">            <span class="string">&quot;points&quot;</span>: <span class="number">10</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;chat_master&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;èŠå¤©å¤§å¸ˆ&quot;</span>,</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;å®Œæˆ100æ¬¡å¯¹è¯&quot;</span>,</span><br><span class="line">            <span class="string">&quot;points&quot;</span>: <span class="number">100</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;quick_thinker&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;å¿«é€Ÿæ€è€ƒè€…&quot;</span>,</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;è¿ç»­5æ¬¡å¿«é€Ÿå›å¤&quot;</span>,</span><br><span class="line">            <span class="string">&quot;points&quot;</span>: <span class="number">50</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;explorer&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;æ¢ç´¢è€…&quot;</span>,</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;å°è¯•æ‰€æœ‰å¯¹è¯ç±»å‹&quot;</span>,</span><br><span class="line">            <span class="string">&quot;points&quot;</span>: <span class="number">80</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.user_achievements = &#123;&#125;</span><br><span class="line">        self.user_points = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">award_achievement</span>(<span class="params">self, user_id: <span class="built_in">int</span>, achievement_id: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;é¢å‘æˆå°±&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> achievement_id <span class="keyword">not</span> <span class="keyword">in</span> self.ACHIEVEMENTS:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> user_id <span class="keyword">not</span> <span class="keyword">in</span> self.user_achievements:</span><br><span class="line">            self.user_achievements[user_id] = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> achievement_id <span class="keyword">not</span> <span class="keyword">in</span> self.user_achievements[user_id]:</span><br><span class="line">            self.user_achievements[user_id].append(achievement_id)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># å¢åŠ ç§¯åˆ†</span></span><br><span class="line">            points = self.ACHIEVEMENTS[achievement_id][<span class="string">&quot;points&quot;</span>]</span><br><span class="line">            self.user_points[user_id] = self.user_points.get(user_id, <span class="number">0</span>) + points</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_chat_achievements</span>(<span class="params">self, user_id: <span class="built_in">int</span>, chat_stats: <span class="type">Dict</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ£€æŸ¥èŠå¤©ç›¸å…³æˆå°±&quot;&quot;&quot;</span></span><br><span class="line">        achievements_awarded = []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ£€æŸ¥å¯¹è¯æ¬¡æ•°æˆå°±</span></span><br><span class="line">        <span class="keyword">if</span> chat_stats[<span class="string">&quot;total_chats&quot;</span>] &gt;= <span class="number">100</span>:</span><br><span class="line">            <span class="keyword">if</span> self.award_achievement(user_id, <span class="string">&quot;chat_master&quot;</span>):</span><br><span class="line">                achievements_awarded.append(<span class="string">&quot;chat_master&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ£€æŸ¥å¿«é€Ÿå›å¤æˆå°±</span></span><br><span class="line">        <span class="keyword">if</span> chat_stats.get(<span class="string">&quot;quick_responses&quot;</span>, <span class="number">0</span>) &gt;= <span class="number">5</span>:</span><br><span class="line">            <span class="keyword">if</span> self.award_achievement(user_id, <span class="string">&quot;quick_thinker&quot;</span>):</span><br><span class="line">                achievements_awarded.append(<span class="string">&quot;quick_thinker&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> achievements_awarded</span><br></pre></td></tr></table></figure>



<h3 id="6-2-ä¸»é¢˜çš®è‚¤ç³»ç»Ÿ"><a href="#6-2-ä¸»é¢˜çš®è‚¤ç³»ç»Ÿ" class="headerlink" title="6.2 ä¸»é¢˜çš®è‚¤ç³»ç»Ÿ"></a>6.2 ä¸»é¢˜çš®è‚¤ç³»ç»Ÿ</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸»é¢˜ç®¡ç†ç³»ç»Ÿ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThemeManager</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä¸»é¢˜ç®¡ç†å™¨&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    THEMES = &#123;</span><br><span class="line">        <span class="string">&quot;default&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;é»˜è®¤ä¸»é¢˜&quot;</span>,</span><br><span class="line">            <span class="string">&quot;primary_color&quot;</span>: <span class="string">&quot;#3498db&quot;</span>,</span><br><span class="line">            <span class="string">&quot;secondary_color&quot;</span>: <span class="string">&quot;#2ecc71&quot;</span>,</span><br><span class="line">            <span class="string">&quot;background_color&quot;</span>: <span class="string">&quot;#f8f9fa&quot;</span>,</span><br><span class="line">            <span class="string">&quot;font_family&quot;</span>: <span class="string">&quot;Arial, sans-serif&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;dark&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;æš—é»‘æ¨¡å¼&quot;</span>,</span><br><span class="line">            <span class="string">&quot;primary_color&quot;</span>: <span class="string">&quot;#9b59b6&quot;</span>,</span><br><span class="line">            <span class="string">&quot;secondary_color&quot;</span>: <span class="string">&quot;#1abc9c&quot;</span>,</span><br><span class="line">            <span class="string">&quot;background_color&quot;</span>: <span class="string">&quot;#2c3e50&quot;</span>,</span><br><span class="line">            <span class="string">&quot;font_family&quot;</span>: <span class="string">&quot;Consolas, monospace&quot;</span>,</span><br><span class="line">            <span class="string">&quot;text_color&quot;</span>: <span class="string">&quot;#ecf0f1&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;nature&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;è‡ªç„¶ä¸»é¢˜&quot;</span>,</span><br><span class="line">            <span class="string">&quot;primary_color&quot;</span>: <span class="string">&quot;#27ae60&quot;</span>,</span><br><span class="line">            <span class="string">&quot;secondary_color&quot;</span>: <span class="string">&quot;#f39c12&quot;</span>,</span><br><span class="line">            <span class="string">&quot;background_color&quot;</span>: <span class="string">&quot;#e8f6f3&quot;</span>,</span><br><span class="line">            <span class="string">&quot;font_family&quot;</span>: <span class="string">&quot;Georgia, serif&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;retro&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;å¤å¤ä¸»é¢˜&quot;</span>,</span><br><span class="line">            <span class="string">&quot;primary_color&quot;</span>: <span class="string">&quot;#e74c3c&quot;</span>,</span><br><span class="line">            <span class="string">&quot;secondary_color&quot;</span>: <span class="string">&quot;#f1c40f&quot;</span>,</span><br><span class="line">            <span class="string">&quot;background_color&quot;</span>: <span class="string">&quot;#fdebd0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;font_family&quot;</span>: <span class="string">&quot;Courier New, monospace&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.user_themes = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_theme</span>(<span class="params">self, user_id: <span class="built_in">int</span>, theme_name: <span class="built_in">str</span> = <span class="string">&quot;default&quot;</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–ä¸»é¢˜é…ç½®&quot;&quot;&quot;</span></span><br><span class="line">        theme = self.THEMES.get(theme_name, self.THEMES[<span class="string">&quot;default&quot;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åˆå¹¶ç”¨æˆ·è‡ªå®šä¹‰è®¾ç½®</span></span><br><span class="line">        user_theme = self.user_themes.get(user_id, &#123;&#125;)</span><br><span class="line">        <span class="keyword">return</span> &#123;**theme, **user_theme&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">unlock_theme</span>(<span class="params">self, user_id: <span class="built_in">int</span>, theme_name: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è§£é”æ–°ä¸»é¢˜&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> theme_name <span class="keyword">not</span> <span class="keyword">in</span> self.THEMES:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> user_id <span class="keyword">not</span> <span class="keyword">in</span> self.user_themes:</span><br><span class="line">            self.user_themes[user_id] = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> theme_name <span class="keyword">not</span> <span class="keyword">in</span> self.user_themes[user_id]:</span><br><span class="line">            self.user_themes[user_id][theme_name] = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>



<h2 id="7-å­¦ä¹ è·¯å¾„å»ºè®®"><a href="#7-å­¦ä¹ è·¯å¾„å»ºè®®" class="headerlink" title="7. å­¦ä¹ è·¯å¾„å»ºè®®"></a>7. å­¦ä¹ è·¯å¾„å»ºè®®</h2><h3 id="ç¬¬ä¸€å‘¨ï¼šPythonåŸºç¡€"><a href="#ç¬¬ä¸€å‘¨ï¼šPythonåŸºç¡€" class="headerlink" title="ç¬¬ä¸€å‘¨ï¼šPythonåŸºç¡€"></a>ç¬¬ä¸€å‘¨ï¼šPythonåŸºç¡€</h3><ol>
<li>å­¦ä¹ PythonåŸºç¡€è¯­æ³•</li>
<li>ç†è§£é¢å‘å¯¹è±¡ç¼–ç¨‹</li>
<li>æŒæ¡å¸¸ç”¨æ•°æ®ç»“æ„</li>
<li>å­¦ä¹ æ–‡ä»¶æ“ä½œå’Œå¼‚å¸¸å¤„ç†</li>
</ol>
<h3 id="ç¬¬äºŒå‘¨ï¼šWebå¼€å‘åŸºç¡€"><a href="#ç¬¬äºŒå‘¨ï¼šWebå¼€å‘åŸºç¡€" class="headerlink" title="ç¬¬äºŒå‘¨ï¼šWebå¼€å‘åŸºç¡€"></a>ç¬¬äºŒå‘¨ï¼šWebå¼€å‘åŸºç¡€</h3><ol>
<li>å­¦ä¹ Flaskæ¡†æ¶</li>
<li>ç†è§£HTTPåè®®å’ŒRESTful API</li>
<li>å­¦ä¹ HTML&#x2F;CSSåŸºç¡€</li>
<li>æŒæ¡Jinja2æ¨¡æ¿</li>
</ol>
<h3 id="ç¬¬ä¸‰å‘¨ï¼šæ•°æ®åº“æ“ä½œ"><a href="#ç¬¬ä¸‰å‘¨ï¼šæ•°æ®åº“æ“ä½œ" class="headerlink" title="ç¬¬ä¸‰å‘¨ï¼šæ•°æ®åº“æ“ä½œ"></a>ç¬¬ä¸‰å‘¨ï¼šæ•°æ®åº“æ“ä½œ</h3><ol>
<li>å­¦ä¹ SQLåŸºç¡€</li>
<li>æŒæ¡SQLAlchemy ORM</li>
<li>å­¦ä¹ æ•°æ®åº“è®¾è®¡</li>
<li>ç†è§£æ•°æ®åº“è¿ç§»</li>
</ol>
<h3 id="ç¬¬å››å‘¨ï¼šå¼‚æ­¥ç¼–ç¨‹"><a href="#ç¬¬å››å‘¨ï¼šå¼‚æ­¥ç¼–ç¨‹" class="headerlink" title="ç¬¬å››å‘¨ï¼šå¼‚æ­¥ç¼–ç¨‹"></a>ç¬¬å››å‘¨ï¼šå¼‚æ­¥ç¼–ç¨‹</h3><ol>
<li>å­¦ä¹ asyncioåŸºç¡€</li>
<li>ç†è§£åç¨‹å’Œä»»åŠ¡</li>
<li>æŒæ¡WebSocketç¼–ç¨‹</li>
<li>å­¦ä¹ å¼‚æ­¥æ•°æ®åº“æ“ä½œ</li>
</ol>
<h3 id="ç¬¬äº”å‘¨ï¼šæµ‹è¯•ä¸éƒ¨ç½²"><a href="#ç¬¬äº”å‘¨ï¼šæµ‹è¯•ä¸éƒ¨ç½²" class="headerlink" title="ç¬¬äº”å‘¨ï¼šæµ‹è¯•ä¸éƒ¨ç½²"></a>ç¬¬äº”å‘¨ï¼šæµ‹è¯•ä¸éƒ¨ç½²</h3><ol>
<li>å­¦ä¹ pytestæ¡†æ¶</li>
<li>æŒæ¡å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•</li>
<li>å­¦ä¹ DockeråŸºç¡€</li>
<li>ç†è§£CI&#x2F;CDæµç¨‹</li>
</ol>
<h3 id="ç¬¬å…­å‘¨ï¼šé¡¹ç›®å®æˆ˜"><a href="#ç¬¬å…­å‘¨ï¼šé¡¹ç›®å®æˆ˜" class="headerlink" title="ç¬¬å…­å‘¨ï¼šé¡¹ç›®å®æˆ˜"></a>ç¬¬å…­å‘¨ï¼šé¡¹ç›®å®æˆ˜</h3><ol>
<li>æŒ‰ç…§åˆ†é˜¶æ®µè®¡åˆ’å¼€å‘é¡¹ç›®</li>
<li>å­¦ä¹ è°ƒè¯•å’Œæ€§èƒ½ä¼˜åŒ–</li>
<li>æŒæ¡æ—¥å¿—å’Œç›‘æ§</li>
<li>å®Œæˆé¡¹ç›®éƒ¨ç½²</li>
</ol>
<h2 id="8-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ"><a href="#8-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ" class="headerlink" title="8. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ"></a>8. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</h2><h3 id="Q1ï¼šå¦‚ä½•è°ƒè¯•Pythonç¨‹åºï¼Ÿ"><a href="#Q1ï¼šå¦‚ä½•è°ƒè¯•Pythonç¨‹åºï¼Ÿ" class="headerlink" title="Q1ï¼šå¦‚ä½•è°ƒè¯•Pythonç¨‹åºï¼Ÿ"></a>Q1ï¼šå¦‚ä½•è°ƒè¯•Pythonç¨‹åºï¼Ÿ</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨pdbè°ƒè¯•å™¨</span></span><br><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">problematic_function</span>():</span><br><span class="line">    x = <span class="number">1</span></span><br><span class="line">    y = <span class="number">0</span></span><br><span class="line">    pdb.set_trace()  <span class="comment"># è®¾ç½®æ–­ç‚¹</span></span><br><span class="line">    result = x / y  <span class="comment"># è¿™é‡Œä¼šæŠ¥é”™</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–è€…ä½¿ç”¨è°ƒè¯•é…ç½®ï¼ˆ.vscode/launch.jsonï¼‰</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;version&quot;</span>: <span class="string">&quot;0.2.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;configurations&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Python: Current File&quot;</span>,</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;python&quot;</span>,</span><br><span class="line">            <span class="string">&quot;request&quot;</span>: <span class="string">&quot;launch&quot;</span>,</span><br><span class="line">            <span class="string">&quot;program&quot;</span>: <span class="string">&quot;$&#123;file&#125;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;console&quot;</span>: <span class="string">&quot;integratedTerminal&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Q2ï¼šå¦‚ä½•å¤„ç†æ•°æ®åº“è¿æ¥æ± ï¼Ÿ"><a href="#Q2ï¼šå¦‚ä½•å¤„ç†æ•°æ®åº“è¿æ¥æ± ï¼Ÿ" class="headerlink" title="Q2ï¼šå¦‚ä½•å¤„ç†æ•°æ®åº“è¿æ¥æ± ï¼Ÿ"></a>Q2ï¼šå¦‚ä½•å¤„ç†æ•°æ®åº“è¿æ¥æ± ï¼Ÿ</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨SQLAlchemyè¿æ¥æ± é…ç½®</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.pool <span class="keyword">import</span> QueuePool</span><br><span class="line"></span><br><span class="line">engine = create_engine(</span><br><span class="line">    <span class="string">&#x27;postgresql://user:password@localhost/dbname&#x27;</span>,</span><br><span class="line">    poolclass=QueuePool,</span><br><span class="line">    pool_size=<span class="number">10</span>,           <span class="comment"># è¿æ¥æ± å¤§å°</span></span><br><span class="line">    max_overflow=<span class="number">20</span>,        <span class="comment"># æœ€å¤§æº¢å‡ºè¿æ¥æ•°</span></span><br><span class="line">    pool_timeout=<span class="number">30</span>,        <span class="comment"># è·å–è¿æ¥è¶…æ—¶æ—¶é—´</span></span><br><span class="line">    pool_recycle=<span class="number">3600</span>,      <span class="comment"># è¿æ¥å›æ”¶æ—¶é—´</span></span><br><span class="line">    echo_pool=<span class="literal">True</span>          <span class="comment"># æ‰“å°è¿æ¥æ± æ—¥å¿—</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h3 id="Q3ï¼šå¦‚ä½•ä¼˜åŒ–APIæ€§èƒ½ï¼Ÿ"><a href="#Q3ï¼šå¦‚ä½•ä¼˜åŒ–APIæ€§èƒ½ï¼Ÿ" class="headerlink" title="Q3ï¼šå¦‚ä½•ä¼˜åŒ–APIæ€§èƒ½ï¼Ÿ"></a>Q3ï¼šå¦‚ä½•ä¼˜åŒ–APIæ€§èƒ½ï¼Ÿ</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ç¼“å­˜å’Œå¼‚æ­¥å¤„ç†</span></span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> lru_cache</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. ä½¿ç”¨LRUç¼“å­˜</span></span><br><span class="line"><span class="meta">@lru_cache(<span class="params">maxsize=<span class="number">128</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">expensive_calculation</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="comment"># è€—æ—¶è®¡ç®—</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. å¼‚æ­¥å¤„ç†</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">process_batch</span>(<span class="params">items</span>):</span><br><span class="line">    tasks = []</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">        task = asyncio.create_task(process_item(item))</span><br><span class="line">        tasks.append(task)</span><br><span class="line">    </span><br><span class="line">    results = <span class="keyword">await</span> asyncio.gather(*tasks)</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. çº¿ç¨‹æ± å¤„ç†CPUå¯†é›†å‹ä»»åŠ¡</span></span><br><span class="line">executor = ThreadPoolExecutor(max_workers=<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cpu_intensive_task</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="comment"># CPUå¯†é›†å‹è®¡ç®—</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_request</span>(<span class="params">data</span>):</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    result = <span class="keyword">await</span> loop.run_in_executor(executor, cpu_intensive_task, data)</span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>



<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ä¸ªAIèŠå¤©æœºå™¨äººåŠ©æ‰‹é¡¹ç›®æ¶µç›–äº†Pythonåœ¨å®é™…å·¥ä½œä¸­çš„ä¸»è¦æŠ€èƒ½ç‚¹ï¼ŒåŒ…æ‹¬ï¼š</p>
<ol>
<li><strong>Webå¼€å‘</strong>ï¼šFlaskæ¡†æ¶ã€RESTful APIã€æ¨¡æ¿æ¸²æŸ“</li>
<li><strong>æ•°æ®åº“</strong>ï¼šSQLAlchemy ORMã€æ•°æ®åº“è®¾è®¡ã€è¿ç§»ç®¡ç†</li>
<li><strong>å¼‚æ­¥ç¼–ç¨‹</strong>ï¼šasyncioã€WebSocketã€å¹¶å‘å¤„ç†</li>
<li><strong>æœºå™¨å­¦ä¹ </strong>ï¼šNLPå¤„ç†ã€æƒ…æ„Ÿåˆ†æã€æ„å›¾è¯†åˆ«</li>
<li><strong>ç³»ç»Ÿè®¾è®¡</strong>ï¼šæ¶æ„è®¾è®¡ã€ç¼“å­˜ç­–ç•¥ã€æ€§èƒ½ä¼˜åŒ–</li>
<li><strong>æµ‹è¯•éƒ¨ç½²</strong>ï¼šå•å…ƒæµ‹è¯•ã€Dockerå®¹å™¨åŒ–ã€CI&#x2F;CD</li>
<li><strong>é¡¹ç›®ç®¡ç†</strong>ï¼šç‰ˆæœ¬æ§åˆ¶ã€æ–‡æ¡£ç¼–å†™ã€å›¢é˜Ÿåä½œ</li>
</ol>
<p>é€šè¿‡å®Œæˆè¿™ä¸ªé¡¹ç›®ï¼Œä½ å°†èƒ½å¤Ÿï¼š</p>
<ul>
<li>ç‹¬ç«‹å¼€å‘å®Œæ•´çš„Webåº”ç”¨</li>
<li>è®¾è®¡å’Œå®ç°å¤æ‚çš„ä¸šåŠ¡é€»è¾‘</li>
<li>ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ</li>
<li>éƒ¨ç½²å’Œç»´æŠ¤ç”Ÿäº§çº§åº”ç”¨</li>
<li>ç¼–å†™é«˜è´¨é‡çš„ä»£ç å’Œæµ‹è¯•</li>
</ul>
<p>é¡¹ç›®å…·æœ‰å¾ˆå¥½çš„å¯ç©æ€§ï¼Œæ™®é€šç”¨æˆ·å¯ä»¥é€šè¿‡Webç•Œé¢ä¸AIèŠå¤©ã€æŸ¥çœ‹æ•°æ®åˆ†æã€è§£é”æˆå°±å’Œä¸»é¢˜ï¼Œä½“éªŒæµç•…æœ‰è¶£ã€‚åŒæ—¶ï¼Œé¡¹ç›®æ¨¡å—åŒ–è®¾è®¡ä½¿å¾—å¯ä»¥åˆ†é˜¶æ®µå®ç°ï¼Œé€‚åˆé€æ­¥å­¦ä¹ å’Œå®è·µã€‚</p>
<p>å¼€å§‹ä½ çš„Pythonå®æˆ˜ä¹‹æ—…å§ï¼æ¯ä¸ªé˜¶æ®µå®Œæˆåï¼Œä½ éƒ½ä¼šçœ‹åˆ°æ˜æ˜¾çš„è¿›æ­¥ï¼Œæœ€ç»ˆè¾¾åˆ°å·¥ä½œæ°´å¹³ã€‚</p>
<h1 id="å®Œæ•´çš„-AI-èŠå¤©æœºå™¨äººåŠ©æ‰‹ç³»ç»Ÿå®ç°"><a href="#å®Œæ•´çš„-AI-èŠå¤©æœºå™¨äººåŠ©æ‰‹ç³»ç»Ÿå®ç°" class="headerlink" title="å®Œæ•´çš„ AI èŠå¤©æœºå™¨äººåŠ©æ‰‹ç³»ç»Ÿå®ç°"></a>å®Œæ•´çš„ AI èŠå¤©æœºå™¨äººåŠ©æ‰‹ç³»ç»Ÿå®ç°</h1><p>æˆ‘å°†æä¾›ä¸€ä¸ªå®Œæ•´å¯è¿è¡Œçš„é¡¹ç›®å®ç°ï¼Œåˆ†ä¸ºå¤šä¸ªæ­¥éª¤ï¼Œä½ å¯ä»¥é€æ­¥è·Ÿéšå®ç°ã€‚</p>
<h2 id="ç¬¬1æ­¥ï¼šé¡¹ç›®åˆå§‹åŒ–"><a href="#ç¬¬1æ­¥ï¼šé¡¹ç›®åˆå§‹åŒ–" class="headerlink" title="ç¬¬1æ­¥ï¼šé¡¹ç›®åˆå§‹åŒ–"></a>ç¬¬1æ­¥ï¼šé¡¹ç›®åˆå§‹åŒ–</h2><h3 id="1-1-åˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„"><a href="#1-1-åˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„" class="headerlink" title="1.1 åˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„"></a>1.1 åˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> ai-chatbot-system</span><br><span class="line"><span class="built_in">cd</span> ai-chatbot-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„</span></span><br><span class="line"><span class="built_in">mkdir</span> -p app/&#123;api,core,database,services,static/&#123;css,js,images&#125;,templates,utils,models,middleware&#125;</span><br><span class="line"><span class="built_in">mkdir</span> -p tests/&#123;unit,integration,functional&#125;</span><br><span class="line"><span class="built_in">mkdir</span> -p scripts docs migrations</span><br><span class="line"><span class="built_in">mkdir</span> -p logs/&#123;app,nginx,db&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå…³é”®æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">touch</span> app/__init__.py app/main.py app/config.py</span><br><span class="line"><span class="built_in">touch</span> app/api/__init__.py app/api/auth.py app/api/chat.py app/api/analytics.py</span><br><span class="line"><span class="built_in">touch</span> app/core/__init__.py app/core/chatbot.py app/core/nlp_engine.py</span><br><span class="line"><span class="built_in">touch</span> app/core/intent_detector.py app/core/emotion_analyzer.py</span><br><span class="line"><span class="built_in">touch</span> app/database/__init__.py app/database/models.py app/database/crud.py</span><br><span class="line"><span class="built_in">touch</span> app/database/session.py app/database/migrations/__init__.py</span><br><span class="line"><span class="built_in">touch</span> app/services/__init__.py app/services/ai_service.py</span><br><span class="line"><span class="built_in">touch</span> app/services/cache_service.py app/services/task_service.py</span><br><span class="line"><span class="built_in">touch</span> app/utils/__init__.py app/utils/logger.py app/utils/helpers.py</span><br><span class="line"><span class="built_in">touch</span> app/utils/security.py app/utils/validators.py</span><br><span class="line"><span class="built_in">touch</span> app/models/__init__.py app/models/user.py app/models/chat.py</span><br><span class="line"><span class="built_in">touch</span> app/middleware/__init__.py app/middleware/auth.py app/middleware/logging.py</span><br><span class="line"><span class="built_in">touch</span> requirements.txt requirements-dev.txt</span><br><span class="line"><span class="built_in">touch</span> Dockerfile docker-compose.yml docker-compose.dev.yml</span><br><span class="line"><span class="built_in">touch</span> nginx.conf gunicorn.conf.py</span><br><span class="line"><span class="built_in">touch</span> .env.example .gitignore .dockerignore</span><br><span class="line"><span class="built_in">touch</span> README.md setup.py</span><br></pre></td></tr></table></figure>



<h3 id="1-2-åŸºç¡€é…ç½®æ–‡ä»¶"><a href="#1-2-åŸºç¡€é…ç½®æ–‡ä»¶" class="headerlink" title="1.2 åŸºç¡€é…ç½®æ–‡ä»¶"></a>1.2 åŸºç¡€é…ç½®æ–‡ä»¶</h3><p><strong>requirements.txt</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"># Webæ¡†æ¶</span><br><span class="line">Flask==2.3.3</span><br><span class="line">Flask-SQLAlchemy==3.0.5</span><br><span class="line">Flask-Login==0.6.3</span><br><span class="line">Flask-CORS==4.0.0</span><br><span class="line">Flask-Migrate==4.0.5</span><br><span class="line">Flask-WTF==1.1.1</span><br><span class="line">Flask-SocketIO==5.3.4</span><br><span class="line">Flask-Admin==1.6.1</span><br><span class="line"></span><br><span class="line"># æ•°æ®åº“</span><br><span class="line">SQLAlchemy==2.0.19</span><br><span class="line">alembic==1.12.0</span><br><span class="line">psycopg2-binary==2.9.7</span><br><span class="line">redis==4.6.0</span><br><span class="line"></span><br><span class="line"># æ•°æ®å¤„ç†</span><br><span class="line">pandas==2.0.3</span><br><span class="line">numpy==1.24.3</span><br><span class="line">scikit-learn==1.3.0</span><br><span class="line">nltk==3.8.1</span><br><span class="line">transformers==4.33.3</span><br><span class="line">torch==2.0.1</span><br><span class="line"></span><br><span class="line"># AI/ML</span><br><span class="line">openai==0.28.1</span><br><span class="line">langchain==0.0.340</span><br><span class="line">chromadb==0.4.15</span><br><span class="line">sentence-transformers==2.2.2</span><br><span class="line"></span><br><span class="line"># å¼‚æ­¥/ä»»åŠ¡</span><br><span class="line">celery==5.3.1</span><br><span class="line">eventlet==0.33.3</span><br><span class="line">asyncio==3.4.3</span><br><span class="line"></span><br><span class="line"># ç¼“å­˜/æ¶ˆæ¯é˜Ÿåˆ—</span><br><span class="line">redis==4.6.0</span><br><span class="line"></span><br><span class="line"># é…ç½®ç®¡ç†</span><br><span class="line">python-dotenv==1.0.0</span><br><span class="line">pyyaml==6.0.1</span><br><span class="line"></span><br><span class="line"># åºåˆ—åŒ–</span><br><span class="line">marshmallow==3.20.1</span><br><span class="line">marshmallow-sqlalchemy==0.29.0</span><br><span class="line"></span><br><span class="line"># è®¤è¯/å®‰å…¨</span><br><span class="line">python-jose==3.3.0</span><br><span class="line">passlib==1.7.4</span><br><span class="line">bcrypt==4.0.1</span><br><span class="line"></span><br><span class="line"># HTTPå®¢æˆ·ç«¯</span><br><span class="line">requests==2.31.0</span><br><span class="line">aiohttp==3.8.5</span><br><span class="line"></span><br><span class="line"># æ•°æ®å¯è§†åŒ–</span><br><span class="line">plotly==5.17.0</span><br><span class="line">chart.js==0.1.0</span><br><span class="line"></span><br><span class="line"># å·¥å…·ç±»</span><br><span class="line">python-dateutil==2.8.2</span><br><span class="line">pytz==2023.3</span><br><span class="line">click==8.1.7</span><br><span class="line"></span><br><span class="line"># å¼€å‘å·¥å…·</span><br><span class="line">black==23.9.1</span><br><span class="line">flake8==6.1.0</span><br><span class="line">isort==5.12.0</span><br></pre></td></tr></table></figure>



<p><strong>requirements-dev.txt</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># æµ‹è¯•æ¡†æ¶</span><br><span class="line">pytest==7.4.2</span><br><span class="line">pytest-cov==4.1.0</span><br><span class="line">pytest-asyncio==0.21.1</span><br><span class="line">pytest-mock==3.11.1</span><br><span class="line">pytest-flask==1.2.0</span><br><span class="line"></span><br><span class="line"># ä»£ç è´¨é‡</span><br><span class="line">black==23.9.1</span><br><span class="line">flake8==6.1.0</span><br><span class="line">mypy==1.5.1</span><br><span class="line">isort==5.12.0</span><br><span class="line">pre-commit==3.4.0</span><br><span class="line"></span><br><span class="line"># è°ƒè¯•å·¥å…·</span><br><span class="line">ipython==8.15.0</span><br><span class="line">ipdb==0.13.13</span><br><span class="line">debugpy==1.7.0</span><br><span class="line"></span><br><span class="line"># æ–‡æ¡£</span><br><span class="line">sphinx==7.2.6</span><br><span class="line">sphinx-rtd-theme==1.3.0</span><br><span class="line">autodoc==0.5.0</span><br><span class="line"></span><br><span class="line"># å¼€å‘æœåŠ¡å™¨</span><br><span class="line">watchdog==3.0.0</span><br></pre></td></tr></table></figure>



<p><strong>.env.example</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># Flask é…ç½®</span><br><span class="line">FLASK_APP=app.main:app</span><br><span class="line">FLASK_ENV=development</span><br><span class="line">SECRET_KEY=your-secret-key-here-change-in-production</span><br><span class="line">DEBUG=True</span><br><span class="line"></span><br><span class="line"># æ•°æ®åº“é…ç½®</span><br><span class="line">DATABASE_URL=postgresql://postgres:password@localhost:5432/chatbot_db</span><br><span class="line">REDIS_URL=redis://localhost:6379/0</span><br><span class="line"></span><br><span class="line"># AI æœåŠ¡é…ç½®</span><br><span class="line">OPENAI_API_KEY=your-openai-api-key</span><br><span class="line">HUGGINGFACE_TOKEN=your-huggingface-token</span><br><span class="line">AI_MODEL_NAME=gpt-3.5-turbo</span><br><span class="line"></span><br><span class="line"># åº”ç”¨é…ç½®</span><br><span class="line">JWT_SECRET_KEY=your-jwt-secret-key</span><br><span class="line">JWT_ACCESS_TOKEN_EXPIRES=3600</span><br><span class="line">API_RATE_LIMIT=100 per day</span><br><span class="line"></span><br><span class="line"># é‚®ä»¶é…ç½®</span><br><span class="line">MAIL_SERVER=smtp.gmail.com</span><br><span class="line">MAIL_PORT=587</span><br><span class="line">MAIL_USE_TLS=True</span><br><span class="line">MAIL_USERNAME=your-email@gmail.com</span><br><span class="line">MAIL_PASSWORD=your-app-password</span><br><span class="line"></span><br><span class="line"># æ–‡ä»¶ä¸Šä¼ </span><br><span class="line">MAX_CONTENT_LENGTH=16777216  # 16MB</span><br><span class="line">UPLOAD_FOLDER=./uploads</span><br><span class="line">ALLOWED_EXTENSIONS=pdf,txt,docx,png,jpg,jpeg</span><br><span class="line"></span><br><span class="line"># ç›‘æ§é…ç½®</span><br><span class="line">SENTRY_DSN=your-sentry-dsn</span><br></pre></td></tr></table></figure>



<p><strong>.gitignore</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"># Python</span><br><span class="line">__pycache__/</span><br><span class="line">*.py[cod]</span><br><span class="line">*$py.class</span><br><span class="line">*.so</span><br><span class="line">.Python</span><br><span class="line">build/</span><br><span class="line">develop-eggs/</span><br><span class="line">dist/</span><br><span class="line">downloads/</span><br><span class="line">eggs/</span><br><span class="line">.eggs/</span><br><span class="line">lib/</span><br><span class="line">lib64/</span><br><span class="line">parts/</span><br><span class="line">sdist/</span><br><span class="line">var/</span><br><span class="line">wheels/</span><br><span class="line">*.egg-info/</span><br><span class="line">.installed.cfg</span><br><span class="line">*.egg</span><br><span class="line"></span><br><span class="line"># Environment</span><br><span class="line">.env</span><br><span class="line">.venv</span><br><span class="line">env/</span><br><span class="line">venv/</span><br><span class="line">ENV/</span><br><span class="line">env.bak/</span><br><span class="line">venv.bak/</span><br><span class="line"></span><br><span class="line"># IDE</span><br><span class="line">.vscode/</span><br><span class="line">.idea/</span><br><span class="line">*.swp</span><br><span class="line">*.swo</span><br><span class="line">*~</span><br><span class="line"></span><br><span class="line"># OS</span><br><span class="line">.DS_Store</span><br><span class="line">.DS_Store?</span><br><span class="line">._*</span><br><span class="line">.Spotlight-V100</span><br><span class="line">.Trashes</span><br><span class="line">ehthumbs.db</span><br><span class="line">Thumbs.db</span><br><span class="line"></span><br><span class="line"># Application</span><br><span class="line">logs/</span><br><span class="line">*.log</span><br><span class="line">uploads/</span><br><span class="line">instance/</span><br><span class="line"></span><br><span class="line"># Database</span><br><span class="line">*.sqlite</span><br><span class="line">*.sqlite3</span><br><span class="line"></span><br><span class="line"># Docker</span><br><span class="line">docker-compose.override.yml</span><br><span class="line"></span><br><span class="line"># Test</span><br><span class="line">.coverage</span><br><span class="line">htmlcov/</span><br><span class="line">.pytest_cache/</span><br><span class="line"></span><br><span class="line"># Redis</span><br><span class="line">dump.rdb</span><br></pre></td></tr></table></figure>



<h2 id="ç¬¬2æ­¥ï¼šFlaskåº”ç”¨é…ç½®"><a href="#ç¬¬2æ­¥ï¼šFlaskåº”ç”¨é…ç½®" class="headerlink" title="ç¬¬2æ­¥ï¼šFlaskåº”ç”¨é…ç½®"></a>ç¬¬2æ­¥ï¼šFlaskåº”ç”¨é…ç½®</h2><p><strong>app&#x2F;config.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line">load_dotenv()</span><br><span class="line"></span><br><span class="line">basedir = os.path.abspath(os.path.dirname(__file__))</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Config</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åŸºç¡€é…ç½®ç±»&quot;&quot;&quot;</span></span><br><span class="line">    SECRET_KEY = os.getenv(<span class="string">&#x27;SECRET_KEY&#x27;</span>, <span class="string">&#x27;dev-secret-key-change-in-production&#x27;</span>)</span><br><span class="line">    DEBUG = <span class="literal">False</span></span><br><span class="line">    TESTING = <span class="literal">False</span></span><br><span class="line">    SQLALCHEMY_TRACK_MODIFICATIONS = <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># JWTé…ç½®</span></span><br><span class="line">    JWT_SECRET_KEY = os.getenv(<span class="string">&#x27;JWT_SECRET_KEY&#x27;</span>, <span class="string">&#x27;jwt-secret-key-change-in-production&#x27;</span>)</span><br><span class="line">    JWT_ACCESS_TOKEN_EXPIRES = timedelta(hours=<span class="number">1</span>)</span><br><span class="line">    JWT_REFRESH_TOKEN_EXPIRES = timedelta(days=<span class="number">30</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Redisé…ç½®</span></span><br><span class="line">    REDIS_URL = os.getenv(<span class="string">&#x27;REDIS_URL&#x27;</span>, <span class="string">&#x27;redis://localhost:6379/0&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ–‡ä»¶ä¸Šä¼ </span></span><br><span class="line">    MAX_CONTENT_LENGTH = <span class="built_in">int</span>(os.getenv(<span class="string">&#x27;MAX_CONTENT_LENGTH&#x27;</span>, <span class="number">16</span> * <span class="number">1024</span> * <span class="number">1024</span>))</span><br><span class="line">    UPLOAD_FOLDER = os.getenv(<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>, os.path.join(basedir, <span class="string">&#x27;uploads&#x27;</span>))</span><br><span class="line">    ALLOWED_EXTENSIONS = &#123;<span class="string">&#x27;pdf&#x27;</span>, <span class="string">&#x27;txt&#x27;</span>, <span class="string">&#x27;docx&#x27;</span>, <span class="string">&#x27;png&#x27;</span>, <span class="string">&#x27;jpg&#x27;</span>, <span class="string">&#x27;jpeg&#x27;</span>&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># AIé…ç½®</span></span><br><span class="line">    OPENAI_API_KEY = os.getenv(<span class="string">&#x27;OPENAI_API_KEY&#x27;</span>)</span><br><span class="line">    HUGGINGFACE_TOKEN = os.getenv(<span class="string">&#x27;HUGGINGFACE_TOKEN&#x27;</span>)</span><br><span class="line">    AI_MODEL_NAME = os.getenv(<span class="string">&#x27;AI_MODEL_NAME&#x27;</span>, <span class="string">&#x27;gpt-3.5-turbo&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># é‚®ä»¶é…ç½®</span></span><br><span class="line">    MAIL_SERVER = os.getenv(<span class="string">&#x27;MAIL_SERVER&#x27;</span>, <span class="string">&#x27;smtp.gmail.com&#x27;</span>)</span><br><span class="line">    MAIL_PORT = <span class="built_in">int</span>(os.getenv(<span class="string">&#x27;MAIL_PORT&#x27;</span>, <span class="number">587</span>))</span><br><span class="line">    MAIL_USE_TLS = os.getenv(<span class="string">&#x27;MAIL_USE_TLS&#x27;</span>, <span class="string">&#x27;True&#x27;</span>) == <span class="string">&#x27;True&#x27;</span></span><br><span class="line">    MAIL_USERNAME = os.getenv(<span class="string">&#x27;MAIL_USERNAME&#x27;</span>)</span><br><span class="line">    MAIL_PASSWORD = os.getenv(<span class="string">&#x27;MAIL_PASSWORD&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># é€Ÿç‡é™åˆ¶</span></span><br><span class="line">    RATELIMIT_ENABLED = <span class="literal">True</span></span><br><span class="line">    RATELIMIT_STORAGE_URL = REDIS_URL</span><br><span class="line">    RATELIMIT_STRATEGY = <span class="string">&#x27;moving-window&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># WebSocket</span></span><br><span class="line">    SOCKETIO_MESSAGE_QUEUE = REDIS_URL</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è·¨åŸŸé…ç½®</span></span><br><span class="line">    CORS_ORIGINS = os.getenv(<span class="string">&#x27;CORS_ORIGINS&#x27;</span>, <span class="string">&#x27;*&#x27;</span>).split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ—¥å¿—é…ç½®</span></span><br><span class="line">    LOG_LEVEL = os.getenv(<span class="string">&#x27;LOG_LEVEL&#x27;</span>, <span class="string">&#x27;INFO&#x27;</span>)</span><br><span class="line">    LOG_FORMAT = <span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span></span><br><span class="line">    LOG_FILE = os.getenv(<span class="string">&#x27;LOG_FILE&#x27;</span>, <span class="string">&#x27;logs/app.log&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init_app</span>(<span class="params">app</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆå§‹åŒ–åº”ç”¨é…ç½®&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DevelopmentConfig</span>(<span class="title class_ inherited__">Config</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¼€å‘ç¯å¢ƒé…ç½®&quot;&quot;&quot;</span></span><br><span class="line">    DEBUG = <span class="literal">True</span></span><br><span class="line">    SQLALCHEMY_DATABASE_URI = os.getenv(</span><br><span class="line">        <span class="string">&#x27;DATABASE_URL&#x27;</span>,</span><br><span class="line">        <span class="string">f&quot;sqlite:///<span class="subst">&#123;os.path.join(basedir, <span class="string">&#x27;chatbot_dev.db&#x27;</span>)&#125;</span>&quot;</span></span><br><span class="line">    )</span><br><span class="line">    SQLALCHEMY_ECHO = <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å¼€å‘ç¯å¢ƒå…è®¸æ‰€æœ‰CORS</span></span><br><span class="line">    CORS_ORIGINS = [<span class="string">&#x27;*&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å¼€å‘ç¯å¢ƒæ—¥å¿—çº§åˆ«</span></span><br><span class="line">    LOG_LEVEL = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestingConfig</span>(<span class="title class_ inherited__">Config</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æµ‹è¯•ç¯å¢ƒé…ç½®&quot;&quot;&quot;</span></span><br><span class="line">    TESTING = <span class="literal">True</span></span><br><span class="line">    DEBUG = <span class="literal">False</span></span><br><span class="line">    SQLALCHEMY_DATABASE_URI = os.getenv(</span><br><span class="line">        <span class="string">&#x27;TEST_DATABASE_URL&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;sqlite:///:memory:&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    WTF_CSRF_ENABLED = <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æµ‹è¯•ç¯å¢ƒä½¿ç”¨å†…å­˜Redis</span></span><br><span class="line">    REDIS_URL = <span class="string">&#x27;redis://localhost:6379/1&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç¦ç”¨é‚®ä»¶å‘é€</span></span><br><span class="line">    MAIL_SUPPRESS_SEND = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProductionConfig</span>(<span class="title class_ inherited__">Config</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ç”Ÿäº§ç¯å¢ƒé…ç½®&quot;&quot;&quot;</span></span><br><span class="line">    DEBUG = <span class="literal">False</span></span><br><span class="line">    SQLALCHEMY_DATABASE_URI = os.getenv(<span class="string">&#x27;DATABASE_URL&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½®</span></span><br><span class="line">    SESSION_COOKIE_SECURE = <span class="literal">True</span></span><br><span class="line">    SESSION_COOKIE_HTTPONLY = <span class="literal">True</span></span><br><span class="line">    SESSION_COOKIE_SAMESITE = <span class="string">&#x27;Lax&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç”Ÿäº§ç¯å¢ƒCORSé…ç½®</span></span><br><span class="line">    CORS_ORIGINS = os.getenv(<span class="string">&#x27;CORS_ORIGINS&#x27;</span>, <span class="string">&#x27;http://localhost:3000&#x27;</span>).split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç”Ÿäº§ç¯å¢ƒæ—¥å¿—çº§åˆ«</span></span><br><span class="line">    LOG_LEVEL = <span class="string">&#x27;WARNING&#x27;</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init_app</span>(<span class="params">app</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ç”Ÿäº§ç¯å¢ƒåˆå§‹åŒ–&quot;&quot;&quot;</span></span><br><span class="line">        Config.init_app(app)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç”Ÿäº§ç¯å¢ƒæ—¥å¿—å¤„ç†</span></span><br><span class="line">        <span class="keyword">import</span> logging</span><br><span class="line">        <span class="keyword">from</span> logging.handlers <span class="keyword">import</span> RotatingFileHandler</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ–‡ä»¶æ—¥å¿—</span></span><br><span class="line">        file_handler = RotatingFileHandler(</span><br><span class="line">            <span class="string">&#x27;logs/app.log&#x27;</span>,</span><br><span class="line">            maxBytes=<span class="number">10485760</span>,  <span class="comment"># 10MB</span></span><br><span class="line">            backupCount=<span class="number">10</span></span><br><span class="line">        )</span><br><span class="line">        file_handler.setFormatter(logging.Formatter(</span><br><span class="line">            <span class="string">&#x27;%(asctime)s %(levelname)s: %(message)s &#x27;</span></span><br><span class="line">            <span class="string">&#x27;[in %(pathname)s:%(lineno)d]&#x27;</span></span><br><span class="line">        ))</span><br><span class="line">        file_handler.setLevel(logging.WARNING)</span><br><span class="line">        app.logger.addHandler(file_handler)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># é”™è¯¯é‚®ä»¶é€šçŸ¥</span></span><br><span class="line">        <span class="keyword">if</span> app.config.get(<span class="string">&#x27;MAIL_USERNAME&#x27;</span>):</span><br><span class="line">            <span class="keyword">from</span> logging.handlers <span class="keyword">import</span> SMTPHandler</span><br><span class="line">            credentials = (app.config[<span class="string">&#x27;MAIL_USERNAME&#x27;</span>], app.config[<span class="string">&#x27;MAIL_PASSWORD&#x27;</span>])</span><br><span class="line">            mail_handler = SMTPHandler(</span><br><span class="line">                mailhost=(app.config[<span class="string">&#x27;MAIL_SERVER&#x27;</span>], app.config[<span class="string">&#x27;MAIL_PORT&#x27;</span>]),</span><br><span class="line">                fromaddr=<span class="string">&#x27;noreply@&#x27;</span> + app.config[<span class="string">&#x27;MAIL_SERVER&#x27;</span>],</span><br><span class="line">                toaddrs=app.config.get(<span class="string">&#x27;ADMINS&#x27;</span>, []),</span><br><span class="line">                subject=<span class="string">&#x27;Application Error&#x27;</span>,</span><br><span class="line">                credentials=credentials,</span><br><span class="line">                secure=() <span class="keyword">if</span> app.config[<span class="string">&#x27;MAIL_USE_TLS&#x27;</span>] <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">            )</span><br><span class="line">            mail_handler.setLevel(logging.ERROR)</span><br><span class="line">            app.logger.addHandler(mail_handler)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">config = &#123;</span><br><span class="line">    <span class="string">&#x27;development&#x27;</span>: DevelopmentConfig,</span><br><span class="line">    <span class="string">&#x27;testing&#x27;</span>: TestingConfig,</span><br><span class="line">    <span class="string">&#x27;production&#x27;</span>: ProductionConfig,</span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: DevelopmentConfig</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>*<em>app&#x2F;*<em>init*</em>.py</em>*</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask_login <span class="keyword">import</span> LoginManager</span><br><span class="line"><span class="keyword">from</span> flask_migrate <span class="keyword">import</span> Migrate</span><br><span class="line"><span class="keyword">from</span> flask_cors <span class="keyword">import</span> CORS</span><br><span class="line"><span class="keyword">from</span> flask_socketio <span class="keyword">import</span> SocketIO</span><br><span class="line"><span class="keyword">from</span> flask_limiter <span class="keyword">import</span> Limiter</span><br><span class="line"><span class="keyword">from</span> flask_limiter.util <span class="keyword">import</span> get_remote_address</span><br><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> .config <span class="keyword">import</span> config</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰©å±•åˆå§‹åŒ–</span></span><br><span class="line">db = SQLAlchemy()</span><br><span class="line">login_manager = LoginManager()</span><br><span class="line">migrate = Migrate()</span><br><span class="line">socketio = SocketIO()</span><br><span class="line">limiter = Limiter(key_func=get_remote_address)</span><br><span class="line">redis_client = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_app</span>(<span class="params">config_name=<span class="string">&#x27;default&#x27;</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åº”ç”¨å·¥å‚å‡½æ•°&quot;&quot;&quot;</span></span><br><span class="line">    app = Flask(__name__)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åŠ è½½é…ç½®</span></span><br><span class="line">    app.config.from_object(config[config_name])</span><br><span class="line">    config[config_name].init_app(app)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–æ‰©å±•</span></span><br><span class="line">    db.init_app(app)</span><br><span class="line">    login_manager.init_app(app)</span><br><span class="line">    migrate.init_app(app, db)</span><br><span class="line">    CORS(app, origins=app.config[<span class="string">&#x27;CORS_ORIGINS&#x27;</span>])</span><br><span class="line">    socketio.init_app(app, </span><br><span class="line">                     cors_allowed_origins=app.config[<span class="string">&#x27;CORS_ORIGINS&#x27;</span>],</span><br><span class="line">                     message_queue=app.config[<span class="string">&#x27;SOCKETIO_MESSAGE_QUEUE&#x27;</span>])</span><br><span class="line">    limiter.init_app(app)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–Redis</span></span><br><span class="line">    <span class="keyword">global</span> redis_client</span><br><span class="line">    redis_client = Redis.from_url(app.config[<span class="string">&#x27;REDIS_URL&#x27;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># é…ç½®ç™»å½•ç®¡ç†å™¨</span></span><br><span class="line">    login_manager.login_view = <span class="string">&#x27;auth.login&#x27;</span></span><br><span class="line">    login_manager.login_message = <span class="string">&#x27;è¯·å…ˆç™»å½•&#x27;</span></span><br><span class="line">    login_manager.login_message_category = <span class="string">&#x27;info&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ³¨å†Œè“å›¾</span></span><br><span class="line">    <span class="keyword">from</span> .api.auth <span class="keyword">import</span> auth_bp</span><br><span class="line">    <span class="keyword">from</span> .api.chat <span class="keyword">import</span> chat_bp</span><br><span class="line">    <span class="keyword">from</span> .api.analytics <span class="keyword">import</span> analytics_bp</span><br><span class="line">    </span><br><span class="line">    app.register_blueprint(auth_bp, url_prefix=<span class="string">&#x27;/api/auth&#x27;</span>)</span><br><span class="line">    app.register_blueprint(chat_bp, url_prefix=<span class="string">&#x27;/api/chat&#x27;</span>)</span><br><span class="line">    app.register_blueprint(analytics_bp, url_prefix=<span class="string">&#x27;/api/analytics&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ³¨å†Œé”™è¯¯å¤„ç†å™¨</span></span><br><span class="line">    <span class="keyword">from</span> .utils.error_handlers <span class="keyword">import</span> register_error_handlers</span><br><span class="line">    register_error_handlers(app)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ³¨å†ŒCLIå‘½ä»¤</span></span><br><span class="line">    <span class="keyword">from</span> .utils.cli <span class="keyword">import</span> register_cli_commands</span><br><span class="line">    register_cli_commands(app)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># é…ç½®æ—¥å¿—</span></span><br><span class="line">    setup_logging(app)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åˆ›å»ºæ•°æ®åº“è¡¨</span></span><br><span class="line">    <span class="keyword">with</span> app.app_context():</span><br><span class="line">        db.create_all()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> app</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup_logging</span>(<span class="params">app</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;é…ç½®æ—¥å¿—&quot;&quot;&quot;</span></span><br><span class="line">    logging.basicConfig(</span><br><span class="line">        level=<span class="built_in">getattr</span>(logging, app.config[<span class="string">&#x27;LOG_LEVEL&#x27;</span>]),</span><br><span class="line">        <span class="built_in">format</span>=app.config[<span class="string">&#x27;LOG_FORMAT&#x27;</span>]</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ·»åŠ æ–‡ä»¶å¤„ç†å™¨</span></span><br><span class="line">    file_handler = logging.FileHandler(app.config[<span class="string">&#x27;LOG_FILE&#x27;</span>])</span><br><span class="line">    file_handler.setFormatter(logging.Formatter(app.config[<span class="string">&#x27;LOG_FORMAT&#x27;</span>]))</span><br><span class="line">    file_handler.setLevel(<span class="built_in">getattr</span>(logging, app.config[<span class="string">&#x27;LOG_LEVEL&#x27;</span>]))</span><br><span class="line">    </span><br><span class="line">    root_logger = logging.getLogger()</span><br><span class="line">    root_logger.addHandler(file_handler)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Flaskæ—¥å¿—é…ç½®</span></span><br><span class="line">    app.logger.setLevel(<span class="built_in">getattr</span>(logging, app.config[<span class="string">&#x27;LOG_LEVEL&#x27;</span>]))</span><br></pre></td></tr></table></figure>



<h2 id="ç¬¬3æ­¥ï¼šæ•°æ®åº“æ¨¡å‹"><a href="#ç¬¬3æ­¥ï¼šæ•°æ®åº“æ¨¡å‹" class="headerlink" title="ç¬¬3æ­¥ï¼šæ•°æ®åº“æ¨¡å‹"></a>ç¬¬3æ­¥ï¼šæ•°æ®åº“æ¨¡å‹</h2><p><strong>app&#x2F;database&#x2F;models.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> .session <span class="keyword">import</span> db</span><br><span class="line"><span class="keyword">from</span> werkzeug.security <span class="keyword">import</span> generate_password_hash, check_password_hash</span><br><span class="line"><span class="keyword">from</span> flask_login <span class="keyword">import</span> UserMixin</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(UserMixin, db.Model):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ç”¨æˆ·æ¨¡å‹&quot;&quot;&quot;</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = db.Column(db.String(<span class="number">64</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>, index=<span class="literal">True</span>)</span><br><span class="line">    email = db.Column(db.String(<span class="number">120</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>, index=<span class="literal">True</span>)</span><br><span class="line">    password_hash = db.Column(db.String(<span class="number">256</span>))</span><br><span class="line">    is_active = db.Column(db.Boolean, default=<span class="literal">True</span>)</span><br><span class="line">    is_admin = db.Column(db.Boolean, default=<span class="literal">False</span>)</span><br><span class="line">    created_at = db.Column(db.DateTime, default=datetime.utcnow)</span><br><span class="line">    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å…³ç³»</span></span><br><span class="line">    chat_sessions = db.relationship(<span class="string">&#x27;ChatSession&#x27;</span>, backref=<span class="string">&#x27;user&#x27;</span>, lazy=<span class="string">&#x27;dynamic&#x27;</span>)</span><br><span class="line">    feedbacks = db.relationship(<span class="string">&#x27;UserFeedback&#x27;</span>, backref=<span class="string">&#x27;user&#x27;</span>, lazy=<span class="string">&#x27;dynamic&#x27;</span>)</span><br><span class="line">    analytics = db.relationship(<span class="string">&#x27;UserAnalytics&#x27;</span>, backref=<span class="string">&#x27;user&#x27;</span>, lazy=<span class="string">&#x27;dynamic&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, **kwargs</span>):</span><br><span class="line">        <span class="built_in">super</span>(User, self).__init__(**kwargs)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">password</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">raise</span> AttributeError(<span class="string">&#x27;å¯†ç ä¸å¯è¯»&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @password.setter</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">password</span>(<span class="params">self, password</span>):</span><br><span class="line">        self.password_hash = generate_password_hash(password)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">verify_password</span>(<span class="params">self, password</span>):</span><br><span class="line">        <span class="keyword">return</span> check_password_hash(self.password_hash, password)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">to_dict</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: self.<span class="built_in">id</span>,</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>: self.username,</span><br><span class="line">            <span class="string">&#x27;email&#x27;</span>: self.email,</span><br><span class="line">            <span class="string">&#x27;is_active&#x27;</span>: self.is_active,</span><br><span class="line">            <span class="string">&#x27;is_admin&#x27;</span>: self.is_admin,</span><br><span class="line">            <span class="string">&#x27;created_at&#x27;</span>: self.created_at.isoformat() <span class="keyword">if</span> self.created_at <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&#x27;updated_at&#x27;</span>: self.updated_at.isoformat() <span class="keyword">if</span> self.updated_at <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;&lt;User <span class="subst">&#123;self.username&#125;</span>&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatSession</span>(db.Model):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;èŠå¤©ä¼šè¯æ¨¡å‹&quot;&quot;&quot;</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;chat_sessions&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.String(<span class="number">36</span>), primary_key=<span class="literal">True</span>, default=<span class="keyword">lambda</span>: <span class="built_in">str</span>(uuid.uuid4()))</span><br><span class="line">    user_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;users.id&#x27;</span>), nullable=<span class="literal">False</span>, index=<span class="literal">True</span>)</span><br><span class="line">    title = db.Column(db.String(<span class="number">200</span>))</span><br><span class="line">    created_at = db.Column(db.DateTime, default=datetime.utcnow)</span><br><span class="line">    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)</span><br><span class="line">    is_active = db.Column(db.Boolean, default=<span class="literal">True</span>)</span><br><span class="line">    metadata = db.Column(db.JSON, default=<span class="built_in">dict</span>)  <span class="comment"># å­˜å‚¨é¢å¤–ä¿¡æ¯</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å…³ç³»</span></span><br><span class="line">    messages = db.relationship(<span class="string">&#x27;ChatMessage&#x27;</span>, backref=<span class="string">&#x27;session&#x27;</span>, lazy=<span class="string">&#x27;dynamic&#x27;</span>, </span><br><span class="line">                               cascade=<span class="string">&#x27;all, delete-orphan&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, **kwargs</span>):</span><br><span class="line">        <span class="built_in">super</span>(ChatSession, self).__init__(**kwargs)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">to_dict</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: self.<span class="built_in">id</span>,</span><br><span class="line">            <span class="string">&#x27;user_id&#x27;</span>: self.user_id,</span><br><span class="line">            <span class="string">&#x27;title&#x27;</span>: self.title,</span><br><span class="line">            <span class="string">&#x27;created_at&#x27;</span>: self.created_at.isoformat() <span class="keyword">if</span> self.created_at <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&#x27;updated_at&#x27;</span>: self.updated_at.isoformat() <span class="keyword">if</span> self.updated_at <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&#x27;is_active&#x27;</span>: self.is_active,</span><br><span class="line">            <span class="string">&#x27;message_count&#x27;</span>: self.messages.count(),</span><br><span class="line">            <span class="string">&#x27;metadata&#x27;</span>: self.metadata</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;&lt;ChatSession <span class="subst">&#123;self.<span class="built_in">id</span>&#125;</span>&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatMessage</span>(db.Model):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;èŠå¤©æ¶ˆæ¯æ¨¡å‹&quot;&quot;&quot;</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;chat_messages&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.String(<span class="number">36</span>), primary_key=<span class="literal">True</span>, default=<span class="keyword">lambda</span>: <span class="built_in">str</span>(uuid.uuid4()))</span><br><span class="line">    session_id = db.Column(db.String(<span class="number">36</span>), db.ForeignKey(<span class="string">&#x27;chat_sessions.id&#x27;</span>), </span><br><span class="line">                          nullable=<span class="literal">False</span>, index=<span class="literal">True</span>)</span><br><span class="line">    role = db.Column(db.String(<span class="number">20</span>), nullable=<span class="literal">False</span>)  <span class="comment"># &#x27;user&#x27;, &#x27;assistant&#x27;, &#x27;system&#x27;</span></span><br><span class="line">    content = db.Column(db.Text, nullable=<span class="literal">False</span>)</span><br><span class="line">    tokens = db.Column(db.Integer, default=<span class="number">0</span>)</span><br><span class="line">    metadata = db.Column(db.JSON, default=<span class="built_in">dict</span>)  <span class="comment"># å­˜å‚¨æ¨¡å‹ã€æ¸©åº¦ç­‰å‚æ•°</span></span><br><span class="line">    created_at = db.Column(db.DateTime, default=datetime.utcnow, index=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç´¢å¼•</span></span><br><span class="line">    __table_args__ = (</span><br><span class="line">        db.Index(<span class="string">&#x27;ix_chat_messages_session_role&#x27;</span>, <span class="string">&#x27;session_id&#x27;</span>, <span class="string">&#x27;role&#x27;</span>),</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, **kwargs</span>):</span><br><span class="line">        <span class="built_in">super</span>(ChatMessage, self).__init__(**kwargs)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">to_dict</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: self.<span class="built_in">id</span>,</span><br><span class="line">            <span class="string">&#x27;session_id&#x27;</span>: self.session_id,</span><br><span class="line">            <span class="string">&#x27;role&#x27;</span>: self.role,</span><br><span class="line">            <span class="string">&#x27;content&#x27;</span>: self.content,</span><br><span class="line">            <span class="string">&#x27;tokens&#x27;</span>: self.tokens,</span><br><span class="line">            <span class="string">&#x27;metadata&#x27;</span>: self.metadata,</span><br><span class="line">            <span class="string">&#x27;created_at&#x27;</span>: self.created_at.isoformat() <span class="keyword">if</span> self.created_at <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;&lt;ChatMessage <span class="subst">&#123;self.<span class="built_in">id</span>[:<span class="number">8</span>]&#125;</span>...&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserFeedback</span>(db.Model):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ç”¨æˆ·åé¦ˆæ¨¡å‹&quot;&quot;&quot;</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;user_feedbacks&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    user_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;users.id&#x27;</span>), nullable=<span class="literal">False</span>, index=<span class="literal">True</span>)</span><br><span class="line">    message_id = db.Column(db.String(<span class="number">36</span>), db.ForeignKey(<span class="string">&#x27;chat_messages.id&#x27;</span>))</span><br><span class="line">    rating = db.Column(db.Integer, nullable=<span class="literal">False</span>)  <span class="comment"># 1-5</span></span><br><span class="line">    feedback_type = db.Column(db.String(<span class="number">50</span>))  <span class="comment"># &#x27;helpful&#x27;, &#x27;incorrect&#x27;, &#x27;inappropriate&#x27;</span></span><br><span class="line">    comment = db.Column(db.Text)</span><br><span class="line">    created_at = db.Column(db.DateTime, default=datetime.utcnow)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å…³ç³»</span></span><br><span class="line">    message = db.relationship(<span class="string">&#x27;ChatMessage&#x27;</span>, backref=<span class="string">&#x27;feedbacks&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, **kwargs</span>):</span><br><span class="line">        <span class="built_in">super</span>(UserFeedback, self).__init__(**kwargs)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">to_dict</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: self.<span class="built_in">id</span>,</span><br><span class="line">            <span class="string">&#x27;user_id&#x27;</span>: self.user_id,</span><br><span class="line">            <span class="string">&#x27;message_id&#x27;</span>: self.message_id,</span><br><span class="line">            <span class="string">&#x27;rating&#x27;</span>: self.rating,</span><br><span class="line">            <span class="string">&#x27;feedback_type&#x27;</span>: self.feedback_type,</span><br><span class="line">            <span class="string">&#x27;comment&#x27;</span>: self.comment,</span><br><span class="line">            <span class="string">&#x27;created_at&#x27;</span>: self.created_at.isoformat() <span class="keyword">if</span> self.created_at <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;&lt;UserFeedback <span class="subst">&#123;self.<span class="built_in">id</span>&#125;</span>&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserAnalytics</span>(db.Model):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ç”¨æˆ·åˆ†ææ¨¡å‹&quot;&quot;&quot;</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;user_analytics&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    user_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;users.id&#x27;</span>), nullable=<span class="literal">False</span>, index=<span class="literal">True</span>)</span><br><span class="line">    date = db.Column(db.Date, nullable=<span class="literal">False</span>, index=<span class="literal">True</span>)</span><br><span class="line">    message_count = db.Column(db.Integer, default=<span class="number">0</span>)</span><br><span class="line">    token_count = db.Column(db.Integer, default=<span class="number">0</span>)</span><br><span class="line">    session_count = db.Column(db.Integer, default=<span class="number">0</span>)</span><br><span class="line">    avg_rating = db.Column(db.Float, default=<span class="number">0.0</span>)</span><br><span class="line">    active_hours = db.Column(db.JSON, default=<span class="built_in">list</span>)  <span class="comment"># æ´»è·ƒæ—¶æ®µåˆ—è¡¨</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å¤åˆç´¢å¼•</span></span><br><span class="line">    __table_args__ = (</span><br><span class="line">        db.UniqueConstraint(<span class="string">&#x27;user_id&#x27;</span>, <span class="string">&#x27;date&#x27;</span>, name=<span class="string">&#x27;uix_user_date&#x27;</span>),</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, **kwargs</span>):</span><br><span class="line">        <span class="built_in">super</span>(UserAnalytics, self).__init__(**kwargs)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">to_dict</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: self.<span class="built_in">id</span>,</span><br><span class="line">            <span class="string">&#x27;user_id&#x27;</span>: self.user_id,</span><br><span class="line">            <span class="string">&#x27;date&#x27;</span>: self.date.isoformat() <span class="keyword">if</span> self.date <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&#x27;message_count&#x27;</span>: self.message_count,</span><br><span class="line">            <span class="string">&#x27;token_count&#x27;</span>: self.token_count,</span><br><span class="line">            <span class="string">&#x27;session_count&#x27;</span>: self.session_count,</span><br><span class="line">            <span class="string">&#x27;avg_rating&#x27;</span>: self.avg_rating,</span><br><span class="line">            <span class="string">&#x27;active_hours&#x27;</span>: self.active_hours</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;&lt;UserAnalytics user:<span class="subst">&#123;self.user_id&#125;</span> date:<span class="subst">&#123;self.date&#125;</span>&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">KnowledgeBase</span>(db.Model):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;çŸ¥è¯†åº“æ¨¡å‹&quot;&quot;&quot;</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;knowledge_base&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    title = db.Column(db.String(<span class="number">200</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    content = db.Column(db.Text, nullable=<span class="literal">False</span>)</span><br><span class="line">    content_type = db.Column(db.String(<span class="number">50</span>))  <span class="comment"># &#x27;faq&#x27;, &#x27;documentation&#x27;, &#x27;example&#x27;</span></span><br><span class="line">    category = db.Column(db.String(<span class="number">100</span>))</span><br><span class="line">    tags = db.Column(db.JSON, default=<span class="built_in">list</span>)</span><br><span class="line">    embeddings = db.Column(db.LargeBinary)  <span class="comment"># å‘é‡åµŒå…¥</span></span><br><span class="line">    is_active = db.Column(db.Boolean, default=<span class="literal">True</span>)</span><br><span class="line">    created_at = db.Column(db.DateTime, default=datetime.utcnow)</span><br><span class="line">    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, **kwargs</span>):</span><br><span class="line">        <span class="built_in">super</span>(KnowledgeBase, self).__init__(**kwargs)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">to_dict</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: self.<span class="built_in">id</span>,</span><br><span class="line">            <span class="string">&#x27;title&#x27;</span>: self.title,</span><br><span class="line">            <span class="string">&#x27;content&#x27;</span>: self.content,</span><br><span class="line">            <span class="string">&#x27;content_type&#x27;</span>: self.content_type,</span><br><span class="line">            <span class="string">&#x27;category&#x27;</span>: self.category,</span><br><span class="line">            <span class="string">&#x27;tags&#x27;</span>: self.tags,</span><br><span class="line">            <span class="string">&#x27;is_active&#x27;</span>: self.is_active,</span><br><span class="line">            <span class="string">&#x27;created_at&#x27;</span>: self.created_at.isoformat() <span class="keyword">if</span> self.created_at <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&#x27;updated_at&#x27;</span>: self.updated_at.isoformat() <span class="keyword">if</span> self.updated_at <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;&lt;KnowledgeBase <span class="subst">&#123;self.title&#125;</span>&gt;&#x27;</span></span><br></pre></td></tr></table></figure>



<p><strong>app&#x2F;database&#x2F;session.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> scoped_session, sessionmaker</span><br><span class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> contextmanager</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line">db = SQLAlchemy()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DBSession</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ•°æ®åº“ä¼šè¯ç®¡ç†å™¨&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line"><span class="meta">    @contextmanager</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">session_scope</span>():</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æä¾›äº‹åŠ¡èŒƒå›´çš„ä¸Šä¸‹æ–‡ç®¡ç†å™¨&quot;&quot;&quot;</span></span><br><span class="line">        session = db.session</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">yield</span> session</span><br><span class="line">            session.commit()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            session.rollback()</span><br><span class="line">            logger.error(<span class="string">f&quot;Database session error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            session.close()</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">obj</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ·»åŠ å¯¹è±¡åˆ°ä¼šè¯&quot;&quot;&quot;</span></span><br><span class="line">        db.session.add(obj)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_all</span>(<span class="params">objs</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ‰¹é‡æ·»åŠ å¯¹è±¡&quot;&quot;&quot;</span></span><br><span class="line">        db.session.add_all(objs)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">obj</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ä»ä¼šè¯ä¸­åˆ é™¤å¯¹è±¡&quot;&quot;&quot;</span></span><br><span class="line">        db.session.delete(obj)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">commit</span>():</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æäº¤ä¼šè¯&quot;&quot;&quot;</span></span><br><span class="line">        db.session.commit()</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">rollback</span>():</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å›æ»šä¼šè¯&quot;&quot;&quot;</span></span><br><span class="line">        db.session.rollback()</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">flush</span>():</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆ·æ–°ä¼šè¯&quot;&quot;&quot;</span></span><br><span class="line">        db.session.flush()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init_db</span>(<span class="params">app</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åˆå§‹åŒ–æ•°æ®åº“&quot;&quot;&quot;</span></span><br><span class="line">    db.init_app(app)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> app.app_context():</span><br><span class="line">        <span class="comment"># åˆ›å»ºæ‰€æœ‰è¡¨</span></span><br><span class="line">        db.create_all()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åˆ›å»ºåˆå§‹æ•°æ®</span></span><br><span class="line">        create_initial_data()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_initial_data</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åˆ›å»ºåˆå§‹æ•°æ®&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">from</span> .models <span class="keyword">import</span> User</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ£€æŸ¥æ˜¯å¦å·²æœ‰ç®¡ç†å‘˜ç”¨æˆ·</span></span><br><span class="line">    admin = User.query.filter_by(username=<span class="string">&#x27;admin&#x27;</span>).first()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> admin:</span><br><span class="line">        admin = User(</span><br><span class="line">            username=<span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">            email=<span class="string">&#x27;admin@example.com&#x27;</span>,</span><br><span class="line">            password=<span class="string">&#x27;admin123&#x27;</span>,  <span class="comment"># ç”Ÿäº§ç¯å¢ƒè¦ä¿®æ”¹</span></span><br><span class="line">            is_admin=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        db.session.add(admin)</span><br><span class="line">        db.session.commit()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Created initial admin user&quot;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="ç¬¬4æ­¥ï¼šæ ¸å¿ƒèŠå¤©æœºå™¨äººå®ç°"><a href="#ç¬¬4æ­¥ï¼šæ ¸å¿ƒèŠå¤©æœºå™¨äººå®ç°" class="headerlink" title="ç¬¬4æ­¥ï¼šæ ¸å¿ƒèŠå¤©æœºå™¨äººå®ç°"></a>ç¬¬4æ­¥ï¼šæ ¸å¿ƒèŠå¤©æœºå™¨äººå®ç°</h2><p><strong>app&#x2F;core&#x2F;chatbot.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Optional</span>, <span class="type">Any</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass, asdict</span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ..services.ai_service <span class="keyword">import</span> AIService</span><br><span class="line"><span class="keyword">from</span> ..services.cache_service <span class="keyword">import</span> CacheService</span><br><span class="line"><span class="keyword">from</span> ..database.models <span class="keyword">import</span> ChatSession, ChatMessage</span><br><span class="line"><span class="keyword">from</span> .intent_detector <span class="keyword">import</span> IntentDetector</span><br><span class="line"><span class="keyword">from</span> .emotion_analyzer <span class="keyword">import</span> EmotionAnalyzer</span><br><span class="line"><span class="keyword">from</span> .nlp_engine <span class="keyword">import</span> NLEngine</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MessageRole</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    USER = <span class="string">&quot;user&quot;</span></span><br><span class="line">    ASSISTANT = <span class="string">&quot;assistant&quot;</span></span><br><span class="line">    SYSTEM = <span class="string">&quot;system&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatContext</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;èŠå¤©ä¸Šä¸‹æ–‡&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, user_id: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span>, session_id: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span>):</span><br><span class="line">        self.user_id = user_id</span><br><span class="line">        self.session_id = session_id</span><br><span class="line">        self.history: <span class="type">List</span>[<span class="type">Dict</span>] = []</span><br><span class="line">        self.variables: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = &#123;&#125;</span><br><span class="line">        self.created_at = datetime.now()</span><br><span class="line">        self.last_activity = datetime.now()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_message</span>(<span class="params">self, role: <span class="built_in">str</span>, content: <span class="built_in">str</span>, **kwargs</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ·»åŠ æ¶ˆæ¯åˆ°å†å²&quot;&quot;&quot;</span></span><br><span class="line">        message = &#123;</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: role,</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: content,</span><br><span class="line">            <span class="string">&quot;timestamp&quot;</span>: datetime.now().isoformat(),</span><br><span class="line">            **kwargs</span><br><span class="line">        &#125;</span><br><span class="line">        self.history.append(message)</span><br><span class="line">        self.last_activity = datetime.now()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_recent_history</span>(<span class="params">self, max_messages: <span class="built_in">int</span> = <span class="number">10</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–æœ€è¿‘çš„èŠå¤©å†å²&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.history[-max_messages:]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">to_dict</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;user_id&quot;</span>: self.user_id,</span><br><span class="line">            <span class="string">&quot;session_id&quot;</span>: self.session_id,</span><br><span class="line">            <span class="string">&quot;history&quot;</span>: self.history,</span><br><span class="line">            <span class="string">&quot;variables&quot;</span>: self.variables,</span><br><span class="line">            <span class="string">&quot;created_at&quot;</span>: self.created_at.isoformat(),</span><br><span class="line">            <span class="string">&quot;last_activity&quot;</span>: self.last_activity.isoformat()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatBot</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;AIèŠå¤©æœºå™¨äºº&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.ai_service = AIService()</span><br><span class="line">        self.cache_service = CacheService()</span><br><span class="line">        self.intent_detector = IntentDetector()</span><br><span class="line">        self.emotion_analyzer = EmotionAnalyzer()</span><br><span class="line">        self.nlp_engine = NLEngine()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æœºå™¨äººä¸ªæ€§é…ç½®</span></span><br><span class="line">        self.personality = &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;æ™ºå‹&quot;</span>,</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: <span class="string">&quot;AIåŠ©æ‰‹&quot;</span>,</span><br><span class="line">            <span class="string">&quot;traits&quot;</span>: [<span class="string">&quot;å‹å¥½&quot;</span>, <span class="string">&quot;ä¸“ä¸š&quot;</span>, <span class="string">&quot;å¹½é»˜&quot;</span>, <span class="string">&quot;ä¹äºåŠ©äºº&quot;</span>],</span><br><span class="line">            <span class="string">&quot;style&quot;</span>: <span class="string">&quot;ä¸“ä¸šä¸”å‹å¥½&quot;</span>,</span><br><span class="line">            <span class="string">&quot;knowledge_domains&quot;</span>: [<span class="string">&quot;æŠ€æœ¯&quot;</span>, <span class="string">&quot;æ•™è‚²&quot;</span>, <span class="string">&quot;å¨±ä¹&quot;</span>, <span class="string">&quot;ç”Ÿæ´»&quot;</span>, <span class="string">&quot;å•†ä¸š&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å“åº”æ¨¡æ¿</span></span><br><span class="line">        self.response_templates = &#123;</span><br><span class="line">            <span class="string">&quot;greeting&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;ä½ å¥½ï¼æˆ‘æ˜¯&#123;name&#125;ï¼Œå¾ˆé«˜å…´ä¸ºä½ æœåŠ¡ã€‚&quot;</span>,</span><br><span class="line">                <span class="string">&quot;å—¨ï¼æˆ‘æ˜¯&#123;name&#125;ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ&quot;</span>,</span><br><span class="line">                <span class="string">&quot;ä½ å¥½ï¼Œæˆ‘æ˜¯&#123;name&#125;ï¼Œä½ çš„AIåŠ©æ‰‹ã€‚ä»Šå¤©æƒ³èŠä»€ä¹ˆå‘¢ï¼Ÿ&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;farewell&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;å†è§ï¼æœŸå¾…ä¸‹æ¬¡èŠå¤©ã€‚&quot;</span>,</span><br><span class="line">                <span class="string">&quot;å¾ˆé«˜å…´å’Œä½ èŠå¤©ï¼Œä¸‹æ¬¡è§ï¼&quot;</span>,</span><br><span class="line">                <span class="string">&quot;æ„Ÿè°¢ä½¿ç”¨ï¼Œæœ‰ä»»ä½•é—®é¢˜éšæ—¶æ¥æ‰¾æˆ‘ï¼&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;error&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚&quot;</span>,</span><br><span class="line">                <span class="string">&quot;å“å‘€ï¼Œå‡ºäº†ç‚¹å°çŠ¶å†µï¼Œæˆ‘ä»¬é‡æ–°å¼€å§‹å§ã€‚&quot;</span>,</span><br><span class="line">                <span class="string">&quot;ç³»ç»Ÿæš‚æ—¶æœ‰ç‚¹å¿™ï¼Œè¯·ç¨ç­‰ç‰‡åˆ»ã€‚&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;unknown&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;è¿™ä¸ªé—®é¢˜æœ‰ç‚¹è¶…å‡ºæˆ‘çš„çŸ¥è¯†èŒƒå›´äº†ï¼Œæˆ‘ä»¬å¯ä»¥æ¢ä¸ªè¯é¢˜å—ï¼Ÿ&quot;</span>,</span><br><span class="line">                <span class="string">&quot;æˆ‘è¿˜åœ¨å­¦ä¹ è¿™æ–¹é¢çš„çŸ¥è¯†ï¼Œä½ å¯ä»¥é—®æˆ‘å…¶ä»–é—®é¢˜å“¦ã€‚&quot;</span>,</span><br><span class="line">                <span class="string">&quot;è®©æˆ‘æƒ³æƒ³... è¦ä¸æˆ‘ä»¬èŠèŠå…¶ä»–è¯é¢˜ï¼Ÿ&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ä¸Šä¸‹æ–‡ç®¡ç†å™¨</span></span><br><span class="line">        self.contexts: <span class="type">Dict</span>[<span class="built_in">str</span>, ChatContext] = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">&quot;ChatBot initialized&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_context</span>(<span class="params">self, session_id: <span class="built_in">str</span></span>) -&gt; ChatContext:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–æˆ–åˆ›å»ºä¸Šä¸‹æ–‡&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> session_id <span class="keyword">not</span> <span class="keyword">in</span> self.contexts:</span><br><span class="line">            self.contexts[session_id] = ChatContext(session_id=session_id)</span><br><span class="line">        <span class="keyword">return</span> self.contexts[session_id]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_cleanup_old_contexts</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ¸…ç†æ—§çš„ä¸Šä¸‹æ–‡&quot;&quot;&quot;</span></span><br><span class="line">        now = datetime.now()</span><br><span class="line">        old_sessions = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> session_id, context <span class="keyword">in</span> self.contexts.items():</span><br><span class="line">            <span class="keyword">if</span> now - context.last_activity &gt; timedelta(hours=<span class="number">24</span>):</span><br><span class="line">                old_sessions.append(session_id)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> session_id <span class="keyword">in</span> old_sessions:</span><br><span class="line">            <span class="keyword">del</span> self.contexts[session_id]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> old_sessions:</span><br><span class="line">            logger.info(<span class="string">f&quot;Cleaned up <span class="subst">&#123;<span class="built_in">len</span>(old_sessions)&#125;</span> old contexts&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">process_message</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                            user_message: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                            session_id: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                            user_id: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                            context_vars: <span class="type">Optional</span>[<span class="type">Dict</span>] = <span class="literal">None</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        å¤„ç†ç”¨æˆ·æ¶ˆæ¯å¹¶ç”Ÿæˆå›å¤</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            user_message: ç”¨æˆ·æ¶ˆæ¯</span></span><br><span class="line"><span class="string">            session_id: ä¼šè¯ID</span></span><br><span class="line"><span class="string">            user_id: ç”¨æˆ·ID</span></span><br><span class="line"><span class="string">            context_vars: ä¸Šä¸‹æ–‡å˜é‡</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Dict: åŒ…å«å›å¤å’Œå…ƒæ•°æ®</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        start_time = datetime.now()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># è·å–ä¸Šä¸‹æ–‡</span></span><br><span class="line">            context = self._get_context(session_id)</span><br><span class="line">            context.user_id = user_id</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ·»åŠ ä¸Šä¸‹æ–‡å˜é‡</span></span><br><span class="line">            <span class="keyword">if</span> context_vars:</span><br><span class="line">                context.variables.update(context_vars)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># é¢„å¤„ç†ç”¨æˆ·æ¶ˆæ¯</span></span><br><span class="line">            cleaned_message = self.nlp_engine.preprocess_text(user_message)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ£€æŸ¥ç¼“å­˜</span></span><br><span class="line">            cache_key = <span class="string">f&quot;response:<span class="subst">&#123;hashlib.md5(cleaned_message.encode()).hexdigest()&#125;</span>&quot;</span></span><br><span class="line">            cached_response = <span class="keyword">await</span> self.cache_service.get(cache_key)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> cached_response:</span><br><span class="line">                logger.info(<span class="string">f&quot;Cache hit for message: <span class="subst">&#123;cleaned_message[:<span class="number">50</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> self._format_cached_response(cached_response, start_time)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># å¹¶è¡Œå¤„ç†ï¼šæ„å›¾è¯†åˆ«å’Œæƒ…æ„Ÿåˆ†æ</span></span><br><span class="line">            tasks = [</span><br><span class="line">                self.intent_detector.detect(cleaned_message),</span><br><span class="line">                self.emotion_analyzer.analyze(cleaned_message)</span><br><span class="line">            ]</span><br><span class="line">            intent, emotion = <span class="keyword">await</span> asyncio.gather(*tasks)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°ä¸Šä¸‹æ–‡</span></span><br><span class="line">            context.add_message(MessageRole.USER.value, user_message, </span><br><span class="line">                               intent=intent, emotion=emotion)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ ¹æ®æ„å›¾é€‰æ‹©å¤„ç†ç­–ç•¥</span></span><br><span class="line">            response = <span class="keyword">await</span> self._handle_by_intent(</span><br><span class="line">                cleaned_message, intent, emotion, context</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># ä¿å­˜åŠ©æ‰‹å›å¤åˆ°ä¸Šä¸‹æ–‡</span></span><br><span class="line">            context.add_message(MessageRole.ASSISTANT.value, response[<span class="string">&#x27;reply&#x27;</span>],</span><br><span class="line">                               intent=intent, emotion=emotion)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># ç¼“å­˜å“åº”</span></span><br><span class="line">            <span class="keyword">await</span> self.cache_service.<span class="built_in">set</span>(cache_key, response, ttl=<span class="number">3600</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è®¡ç®—å¤„ç†æ—¶é—´</span></span><br><span class="line">            processing_time = (datetime.now() - start_time).total_seconds()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ ¼å¼åŒ–æœ€ç»ˆå“åº”</span></span><br><span class="line">            <span class="keyword">return</span> self._format_response(response, intent, emotion, processing_time)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Error processing message: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">return</span> self._format_error_response(<span class="built_in">str</span>(e), start_time)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_handle_by_intent</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                               message: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                               intent: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                               emotion: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                               context: ChatContext</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ ¹æ®æ„å›¾å¤„ç†æ¶ˆæ¯&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        handler_map = &#123;</span><br><span class="line">            <span class="string">&quot;greeting&quot;</span>: self._handle_greeting,</span><br><span class="line">            <span class="string">&quot;farewell&quot;</span>: self._handle_farewell,</span><br><span class="line">            <span class="string">&quot;question&quot;</span>: self._handle_question,</span><br><span class="line">            <span class="string">&quot;conversation&quot;</span>: self._handle_conversation,</span><br><span class="line">            <span class="string">&quot;command&quot;</span>: self._handle_command,</span><br><span class="line">            <span class="string">&quot;feedback&quot;</span>: self._handle_feedback</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        handler = handler_map.get(intent, self._handle_unknown)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> handler(message, emotion, context)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_handle_greeting</span>(<span class="params">self, message: <span class="built_in">str</span>, emotion: <span class="built_in">str</span>, context: ChatContext</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¤„ç†é—®å€™&quot;&quot;&quot;</span></span><br><span class="line">        template = random.choice(self.response_templates[<span class="string">&quot;greeting&quot;</span>])</span><br><span class="line">        reply = template.<span class="built_in">format</span>(name=self.personality[<span class="string">&quot;name&quot;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ ¹æ®æƒ…æ„Ÿè°ƒæ•´å›å¤</span></span><br><span class="line">        <span class="keyword">if</span> emotion == <span class="string">&quot;positive&quot;</span>:</span><br><span class="line">            reply += <span class="string">&quot; çœ‹èµ·æ¥ä½ ä»Šå¤©å¿ƒæƒ…ä¸é”™å‘¢ï¼&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> emotion == <span class="string">&quot;negative&quot;</span>:</span><br><span class="line">            reply += <span class="string">&quot; æœ‰ä»€ä¹ˆçƒ¦æ¼å¯ä»¥å’Œæˆ‘è¯´è¯´ã€‚&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;reply&quot;</span>: reply,</span><br><span class="line">            <span class="string">&quot;tokens_used&quot;</span>: <span class="number">30</span>,</span><br><span class="line">            <span class="string">&quot;suggested_responses&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;ä½ èƒ½åšä»€ä¹ˆï¼Ÿ&quot;</span>,</span><br><span class="line">                <span class="string">&quot;ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±&quot;</span>,</span><br><span class="line">                <span class="string">&quot;å¼€å§‹èŠå¤©&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_handle_question</span>(<span class="params">self, message: <span class="built_in">str</span>, emotion: <span class="built_in">str</span>, context: ChatContext</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¤„ç†é—®é¢˜&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># è·å–ç›¸å…³å†å²ä½œä¸ºä¸Šä¸‹æ–‡</span></span><br><span class="line">        history = context.get_recent_history(<span class="number">5</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ä½¿ç”¨AIæœåŠ¡ç”Ÿæˆå›ç­”</span></span><br><span class="line">        ai_response = <span class="keyword">await</span> self.ai_service.generate_response(</span><br><span class="line">            message=message,</span><br><span class="line">            history=history,</span><br><span class="line">            context=context.variables</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç”Ÿæˆå»ºè®®å›å¤</span></span><br><span class="line">        suggested_responses = <span class="keyword">await</span> self._generate_suggestions(message, ai_response[<span class="string">&quot;content&quot;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;reply&quot;</span>: ai_response[<span class="string">&quot;content&quot;</span>],</span><br><span class="line">            <span class="string">&quot;tokens_used&quot;</span>: ai_response.get(<span class="string">&quot;tokens_used&quot;</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="string">&quot;suggested_responses&quot;</span>: suggested_responses</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_handle_conversation</span>(<span class="params">self, message: <span class="built_in">str</span>, emotion: <span class="built_in">str</span>, context: ChatContext</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¤„ç†ä¸€èˆ¬å¯¹è¯&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># æ ¹æ®æƒ…æ„Ÿè°ƒæ•´é£æ ¼</span></span><br><span class="line">        style = <span class="string">&quot;friendly&quot;</span></span><br><span class="line">        <span class="keyword">if</span> emotion == <span class="string">&quot;positive&quot;</span>:</span><br><span class="line">            style = <span class="string">&quot;enthusiastic&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> emotion == <span class="string">&quot;negative&quot;</span>:</span><br><span class="line">            style = <span class="string">&quot;empathetic&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç”Ÿæˆå¯¹è¯å›å¤</span></span><br><span class="line">        reply = <span class="keyword">await</span> self.ai_service.generate_conversation(</span><br><span class="line">            message=message,</span><br><span class="line">            style=style,</span><br><span class="line">            personality=self.personality,</span><br><span class="line">            history=context.get_recent_history(<span class="number">3</span>)</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;reply&quot;</span>: reply,</span><br><span class="line">            <span class="string">&quot;tokens_used&quot;</span>: <span class="number">50</span>,</span><br><span class="line">            <span class="string">&quot;suggested_responses&quot;</span>: [<span class="string">&quot;ç»§ç»­èŠ&quot;</span>, <span class="string">&quot;æ¢ä¸ªè¯é¢˜&quot;</span>, <span class="string">&quot;é—®ä¸ªé—®é¢˜&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_handle_command</span>(<span class="params">self, message: <span class="built_in">str</span>, emotion: <span class="built_in">str</span>, context: ChatContext</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¤„ç†å‘½ä»¤&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># è§£æå‘½ä»¤</span></span><br><span class="line">        command = message.lower().strip()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;å¸®åŠ©&quot;</span> <span class="keyword">in</span> command <span class="keyword">or</span> <span class="string">&quot;help&quot;</span> <span class="keyword">in</span> command:</span><br><span class="line">            reply = self._generate_help_message()</span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&quot;è®¾ç½®&quot;</span> <span class="keyword">in</span> command <span class="keyword">or</span> <span class="string">&quot;setting&quot;</span> <span class="keyword">in</span> command:</span><br><span class="line">            reply = <span class="string">&quot;ä½ å¯ä»¥åœ¨è®¾ç½®é¡µé¢è°ƒæ•´æˆ‘çš„è¡Œä¸ºå‚æ•°ã€‚&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&quot;æ¸…é™¤&quot;</span> <span class="keyword">in</span> command <span class="keyword">or</span> <span class="string">&quot;clear&quot;</span> <span class="keyword">in</span> command:</span><br><span class="line">            context.history = []</span><br><span class="line">            reply = <span class="string">&quot;èŠå¤©å†å²å·²æ¸…é™¤ã€‚&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            reply = <span class="string">&quot;æˆ‘ä¸å¤ªæ˜ç™½è¿™ä¸ªå‘½ä»¤ï¼Œè¯•è¯•è¯´&#x27;å¸®åŠ©&#x27;æŸ¥çœ‹å¯ç”¨å‘½ä»¤ã€‚&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;reply&quot;</span>: reply,</span><br><span class="line">            <span class="string">&quot;tokens_used&quot;</span>: <span class="number">20</span>,</span><br><span class="line">            <span class="string">&quot;suggested_responses&quot;</span>: [<span class="string">&quot;æŸ¥çœ‹å¸®åŠ©&quot;</span>, <span class="string">&quot;ç»§ç»­èŠå¤©&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_handle_farewell</span>(<span class="params">self, message: <span class="built_in">str</span>, emotion: <span class="built_in">str</span>, context: ChatContext</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¤„ç†å‘Šåˆ«&quot;&quot;&quot;</span></span><br><span class="line">        template = random.choice(self.response_templates[<span class="string">&quot;farewell&quot;</span>])</span><br><span class="line">        reply = template</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ¸…ç†ä¸Šä¸‹æ–‡</span></span><br><span class="line">        <span class="keyword">if</span> context.session_id <span class="keyword">in</span> self.contexts:</span><br><span class="line">            <span class="keyword">del</span> self.contexts[context.session_id]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;reply&quot;</span>: reply,</span><br><span class="line">            <span class="string">&quot;tokens_used&quot;</span>: <span class="number">15</span>,</span><br><span class="line">            <span class="string">&quot;suggested_responses&quot;</span>: []</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_handle_feedback</span>(<span class="params">self, message: <span class="built_in">str</span>, emotion: <span class="built_in">str</span>, context: ChatContext</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¤„ç†åé¦ˆ&quot;&quot;&quot;</span></span><br><span class="line">        reply = <span class="string">&quot;æ„Ÿè°¢ä½ çš„åé¦ˆï¼æˆ‘ä¼šä¸æ–­æ”¹è¿›çš„ã€‚&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è¿™é‡Œå¯ä»¥æ·»åŠ åé¦ˆå¤„ç†é€»è¾‘</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;reply&quot;</span>: reply,</span><br><span class="line">            <span class="string">&quot;tokens_used&quot;</span>: <span class="number">20</span>,</span><br><span class="line">            <span class="string">&quot;suggested_responses&quot;</span>: [<span class="string">&quot;ç»§ç»­èŠå¤©&quot;</span>, <span class="string">&quot;æŠ¥å‘Šé—®é¢˜&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_handle_unknown</span>(<span class="params">self, message: <span class="built_in">str</span>, emotion: <span class="built_in">str</span>, context: ChatContext</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¤„ç†æœªçŸ¥æ„å›¾&quot;&quot;&quot;</span></span><br><span class="line">        template = random.choice(self.response_templates[<span class="string">&quot;unknown&quot;</span>])</span><br><span class="line">        reply = template</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;reply&quot;</span>: reply,</span><br><span class="line">            <span class="string">&quot;tokens_used&quot;</span>: <span class="number">25</span>,</span><br><span class="line">            <span class="string">&quot;suggested_responses&quot;</span>: [<span class="string">&quot;æ¢ä¸ªè¯é¢˜&quot;</span>, <span class="string">&quot;é—®ä¸ªç®€å•é—®é¢˜&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_generate_help_message</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ç”Ÿæˆå¸®åŠ©ä¿¡æ¯&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">æˆ‘æ˜¯<span class="subst">&#123;self.personality[<span class="string">&#x27;name&#x27;</span>]&#125;</span>ï¼Œä½ çš„AIåŠ©æ‰‹ã€‚æˆ‘å¯ä»¥ï¼š</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ğŸ¤– **åŸºç¡€åŠŸèƒ½**</span></span><br><span class="line"><span class="string">- å›ç­”å„ç§é—®é¢˜</span></span><br><span class="line"><span class="string">- è¿›è¡Œæ—¥å¸¸å¯¹è¯</span></span><br><span class="line"><span class="string">- æä¾›å»ºè®®å’Œæ„è§</span></span><br><span class="line"><span class="string">- ååŠ©å­¦ä¹ å’Œå·¥ä½œ</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ğŸ’¡ **ç‰¹è‰²åŠŸèƒ½**</span></span><br><span class="line"><span class="string">- æƒ…æ„Ÿåˆ†æï¼šæˆ‘èƒ½ç†è§£ä½ çš„æƒ…ç»ª</span></span><br><span class="line"><span class="string">- æ„å›¾è¯†åˆ«ï¼šæˆ‘èƒ½ç†è§£ä½ çš„éœ€æ±‚</span></span><br><span class="line"><span class="string">- ä¸Šä¸‹æ–‡è®°å¿†ï¼šæˆ‘èƒ½è®°ä½æˆ‘ä»¬çš„å¯¹è¯</span></span><br><span class="line"><span class="string">- å¤šè½®å¯¹è¯ï¼šæ”¯æŒå¤æ‚çš„å¯¹è¯åœºæ™¯</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ğŸ® **äº’åŠ¨åŠŸèƒ½**</span></span><br><span class="line"><span class="string">- ç”Ÿæˆå¯¹è¯ç¤ºä¾‹</span></span><br><span class="line"><span class="string">- æä¾›å»ºè®®å›å¤</span></span><br><span class="line"><span class="string">- æ”¯æŒä¸»é¢˜åˆ‡æ¢</span></span><br><span class="line"><span class="string">- ä¸ªæ€§åŒ–è®¾ç½®</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ğŸ“Š **åˆ†æåŠŸèƒ½**</span></span><br><span class="line"><span class="string">- èŠå¤©æ•°æ®åˆ†æ</span></span><br><span class="line"><span class="string">- ä½¿ç”¨ç»Ÿè®¡</span></span><br><span class="line"><span class="string">- æƒ…æ„Ÿè¶‹åŠ¿</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¾“å…¥ &#x27;è®¾ç½®&#x27; å¯ä»¥è°ƒæ•´æˆ‘çš„è¡Œä¸ºï¼Œæˆ–ç›´æ¥å¼€å§‹èŠå¤©å§ï¼</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_generate_suggestions</span>(<span class="params">self, question: <span class="built_in">str</span>, answer: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ç”Ÿæˆå»ºè®®å›å¤&quot;&quot;&quot;</span></span><br><span class="line">        suggestions = []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åŸºäºå›ç­”ç±»å‹ç”Ÿæˆå»ºè®®</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;?&quot;</span> <span class="keyword">in</span> question <span class="keyword">or</span> <span class="string">&quot;å—&quot;</span> <span class="keyword">in</span> question <span class="keyword">or</span> <span class="string">&quot;å¦‚ä½•&quot;</span> <span class="keyword">in</span> question:</span><br><span class="line">            suggestions.extend([<span class="string">&quot;è§£é‡Šæ›´è¯¦ç»†äº›&quot;</span>, <span class="string">&quot;ä¸¾ä¸ªä¾‹å­&quot;</span>, <span class="string">&quot;æœ‰ä»€ä¹ˆéœ€è¦æ³¨æ„çš„&quot;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ·»åŠ é€šç”¨å»ºè®®</span></span><br><span class="line">        suggestions.extend([<span class="string">&quot;ç»§ç»­è¿™ä¸ªè¯é¢˜&quot;</span>, <span class="string">&quot;é—®ä¸ªç›¸å…³é—®é¢˜&quot;</span>, <span class="string">&quot;æ¢ä¸ªè¯é¢˜&quot;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å»é‡å¹¶é™åˆ¶æ•°é‡</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">list</span>(<span class="built_in">dict</span>.fromkeys(suggestions))[:<span class="number">3</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_format_response</span>(<span class="params">self, response: <span class="type">Dict</span>, intent: <span class="built_in">str</span>, emotion: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                        processing_time: <span class="built_in">float</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ ¼å¼åŒ–å“åº”&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&quot;reply&quot;</span>: response[<span class="string">&quot;reply&quot;</span>],</span><br><span class="line">            <span class="string">&quot;metadata&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;intent&quot;</span>: intent,</span><br><span class="line">                <span class="string">&quot;emotion&quot;</span>: emotion,</span><br><span class="line">                <span class="string">&quot;tokens_used&quot;</span>: response.get(<span class="string">&quot;tokens_used&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;processing_time&quot;</span>: <span class="built_in">round</span>(processing_time, <span class="number">3</span>),</span><br><span class="line">                <span class="string">&quot;timestamp&quot;</span>: datetime.now().isoformat(),</span><br><span class="line">                <span class="string">&quot;suggested_responses&quot;</span>: response.get(<span class="string">&quot;suggested_responses&quot;</span>, [])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_format_cached_response</span>(<span class="params">self, response: <span class="type">Dict</span>, start_time: datetime</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ ¼å¼åŒ–ç¼“å­˜å“åº”&quot;&quot;&quot;</span></span><br><span class="line">        processing_time = (datetime.now() - start_time).total_seconds()</span><br><span class="line">        response[<span class="string">&quot;metadata&quot;</span>][<span class="string">&quot;processing_time&quot;</span>] = <span class="built_in">round</span>(processing_time, <span class="number">3</span>)</span><br><span class="line">        response[<span class="string">&quot;metadata&quot;</span>][<span class="string">&quot;cached&quot;</span>] = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_format_error_response</span>(<span class="params">self, error: <span class="built_in">str</span>, start_time: datetime</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ ¼å¼åŒ–é”™è¯¯å“åº”&quot;&quot;&quot;</span></span><br><span class="line">        processing_time = (datetime.now() - start_time).total_seconds()</span><br><span class="line">        template = random.choice(self.response_templates[<span class="string">&quot;error&quot;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&quot;reply&quot;</span>: template,</span><br><span class="line">            <span class="string">&quot;metadata&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;error&quot;</span>: error,</span><br><span class="line">                <span class="string">&quot;processing_time&quot;</span>: <span class="built_in">round</span>(processing_time, <span class="number">3</span>),</span><br><span class="line">                <span class="string">&quot;timestamp&quot;</span>: datetime.now().isoformat(),</span><br><span class="line">                <span class="string">&quot;suggested_responses&quot;</span>: [<span class="string">&quot;é‡è¯•&quot;</span>, <span class="string">&quot;é‡æ–°å¼€å§‹&quot;</span>, <span class="string">&quot;è”ç³»æ”¯æŒ&quot;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">generate_dialogue</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                               topic: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                               num_exchanges: <span class="built_in">int</span> = <span class="number">5</span>,</span></span><br><span class="line"><span class="params">                               style: <span class="built_in">str</span> = <span class="string">&quot;professional&quot;</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        ç”Ÿæˆç¤ºä¾‹å¯¹è¯</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            topic: å¯¹è¯ä¸»é¢˜</span></span><br><span class="line"><span class="string">            num_exchanges: å¯¹è¯è½®æ¬¡</span></span><br><span class="line"><span class="string">            style: å¯¹è¯é£æ ¼</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            List[Dict]: å¯¹è¯åˆ—è¡¨</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        dialogue = []</span><br><span class="line">        temp_session_id = <span class="string">f&quot;dialogue_<span class="subst">&#123;hashlib.md5(topic.encode()).hexdigest()[:<span class="number">8</span>]&#125;</span>&quot;</span></span><br><span class="line">        context = ChatContext(session_id=temp_session_id)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç”Ÿæˆå¼€åœºç™½</span></span><br><span class="line">        opening = <span class="keyword">await</span> self.ai_service.generate_opening(topic, style)</span><br><span class="line">        dialogue.append(&#123;</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: MessageRole.ASSISTANT.value,</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: opening,</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;opening&quot;</span></span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        context.add_message(MessageRole.ASSISTANT.value, opening)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç”Ÿæˆå¯¹è¯è½®æ¬¡</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_exchanges - <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># ç”Ÿæˆç”¨æˆ·æ¶ˆæ¯</span></span><br><span class="line">                user_msg = <span class="keyword">await</span> self.ai_service.generate_user_message(</span><br><span class="line">                    topic=topic,</span><br><span class="line">                    context=context.variables,</span><br><span class="line">                    history=context.get_recent_history(<span class="number">3</span>)</span><br><span class="line">                )</span><br><span class="line">                dialogue.append(&#123;</span><br><span class="line">                    <span class="string">&quot;role&quot;</span>: MessageRole.USER.value,</span><br><span class="line">                    <span class="string">&quot;content&quot;</span>: user_msg,</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;user_input&quot;</span></span><br><span class="line">                &#125;)</span><br><span class="line">                context.add_message(MessageRole.USER.value, user_msg)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># ç”ŸæˆåŠ©æ‰‹å›å¤</span></span><br><span class="line">                last_user_msg = dialogue[-<span class="number">1</span>][<span class="string">&quot;content&quot;</span>]</span><br><span class="line">                response = <span class="keyword">await</span> self.process_message(</span><br><span class="line">                    user_message=last_user_msg,</span><br><span class="line">                    session_id=temp_session_id,</span><br><span class="line">                    context_vars=context.variables</span><br><span class="line">                )</span><br><span class="line">                dialogue.append(&#123;</span><br><span class="line">                    <span class="string">&quot;role&quot;</span>: MessageRole.ASSISTANT.value,</span><br><span class="line">                    <span class="string">&quot;content&quot;</span>: response[<span class="string">&quot;reply&quot;</span>],</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;assistant_response&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;metadata&quot;</span>: response.get(<span class="string">&quot;metadata&quot;</span>, &#123;&#125;)</span><br><span class="line">                &#125;)</span><br><span class="line">                context.add_message(MessageRole.ASSISTANT.value, response[<span class="string">&quot;reply&quot;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> dialogue</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">analyze_conversation</span>(<span class="params">self, session_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆ†æå¯¹è¯è´¨é‡&quot;&quot;&quot;</span></span><br><span class="line">        context = self._get_context(session_id)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> context.history:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;No conversation history&quot;</span>&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ”¶é›†ç»Ÿè®¡ä¿¡æ¯</span></span><br><span class="line">        messages = context.history</span><br><span class="line">        user_messages = [m <span class="keyword">for</span> m <span class="keyword">in</span> messages <span class="keyword">if</span> m[<span class="string">&quot;role&quot;</span>] == MessageRole.USER.value]</span><br><span class="line">        assistant_messages = [m <span class="keyword">for</span> m <span class="keyword">in</span> messages <span class="keyword">if</span> m[<span class="string">&quot;role&quot;</span>] == MessageRole.ASSISTANT.value]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®¡ç®—æ„å›¾åˆ†å¸ƒ</span></span><br><span class="line">        intents = [m.get(<span class="string">&quot;intent&quot;</span>, <span class="string">&quot;unknown&quot;</span>) <span class="keyword">for</span> m <span class="keyword">in</span> messages <span class="keyword">if</span> <span class="string">&quot;intent&quot;</span> <span class="keyword">in</span> m]</span><br><span class="line">        intent_counts = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> intent <span class="keyword">in</span> intents:</span><br><span class="line">            intent_counts[intent] = intent_counts.get(intent, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®¡ç®—æƒ…æ„Ÿåˆ†å¸ƒ</span></span><br><span class="line">        emotions = [m.get(<span class="string">&quot;emotion&quot;</span>, <span class="string">&quot;neutral&quot;</span>) <span class="keyword">for</span> m <span class="keyword">in</span> messages <span class="keyword">if</span> <span class="string">&quot;emotion&quot;</span> <span class="keyword">in</span> m]</span><br><span class="line">        emotion_counts = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> emotion <span class="keyword">in</span> emotions:</span><br><span class="line">            emotion_counts[emotion] = emotion_counts.get(emotion, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®¡ç®—å¯¹è¯è´¨é‡æŒ‡æ ‡</span></span><br><span class="line">        total_messages = <span class="built_in">len</span>(messages)</span><br><span class="line">        avg_message_length = <span class="built_in">sum</span>(<span class="built_in">len</span>(m[<span class="string">&quot;content&quot;</span>]) <span class="keyword">for</span> m <span class="keyword">in</span> messages) / total_messages <span class="keyword">if</span> total_messages &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®¡ç®—å“åº”æ—¶é—´ï¼ˆæ¨¡æ‹Ÿï¼‰</span></span><br><span class="line">        response_times = [<span class="number">0.5</span>, <span class="number">1.2</span>, <span class="number">0.8</span>, <span class="number">1.5</span>, <span class="number">0.3</span>]  <span class="comment"># å®é™…åº”è¯¥ä»æ—¥å¿—ä¸­è·å–</span></span><br><span class="line">        avg_response_time = <span class="built_in">sum</span>(response_times) / <span class="built_in">len</span>(response_times) <span class="keyword">if</span> response_times <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;session_id&quot;</span>: session_id,</span><br><span class="line">            <span class="string">&quot;statistics&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;total_messages&quot;</span>: total_messages,</span><br><span class="line">                <span class="string">&quot;user_messages&quot;</span>: <span class="built_in">len</span>(user_messages),</span><br><span class="line">                <span class="string">&quot;assistant_messages&quot;</span>: <span class="built_in">len</span>(assistant_messages),</span><br><span class="line">                <span class="string">&quot;avg_message_length&quot;</span>: <span class="built_in">round</span>(avg_message_length, <span class="number">1</span>),</span><br><span class="line">                <span class="string">&quot;avg_response_time&quot;</span>: <span class="built_in">round</span>(avg_response_time, <span class="number">3</span>),</span><br><span class="line">                <span class="string">&quot;conversation_duration&quot;</span>: (context.last_activity - context.created_at).total_seconds()</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;intent_distribution&quot;</span>: intent_counts,</span><br><span class="line">            <span class="string">&quot;emotion_distribution&quot;</span>: emotion_counts,</span><br><span class="line">            <span class="string">&quot;quality_metrics&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;engagement_score&quot;</span>: <span class="built_in">min</span>(<span class="built_in">len</span>(messages) * <span class="number">0.1</span>, <span class="number">10</span>),  <span class="comment"># ç®€å•è¯„åˆ†</span></span><br><span class="line">                <span class="string">&quot;coherence_score&quot;</span>: <span class="built_in">min</span>(<span class="built_in">len</span>(<span class="built_in">set</span>(intents)) * <span class="number">2</span>, <span class="number">10</span>),</span><br><span class="line">                <span class="string">&quot;sentiment_score&quot;</span>: emotion_counts.get(<span class="string">&quot;positive&quot;</span>, <span class="number">0</span>) / total_messages <span class="keyword">if</span> total_messages &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



<p><strong>app&#x2F;core&#x2F;intent_detector.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Optional</span>, <span class="type">Tuple</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Intent</span>:</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    patterns: <span class="type">List</span>[<span class="built_in">str</span>]</span><br><span class="line">    priority: <span class="built_in">int</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IntentDetector</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ„å›¾æ£€æµ‹å™¨&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.intents = self._load_intents()</span><br><span class="line">        self.pattern_cache = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">f&quot;IntentDetector initialized with <span class="subst">&#123;<span class="built_in">len</span>(self.intents)&#125;</span> intents&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_load_intents</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[Intent]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åŠ è½½æ„å›¾é…ç½®&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            Intent(</span><br><span class="line">                name=<span class="string">&quot;greeting&quot;</span>,</span><br><span class="line">                patterns=[</span><br><span class="line">                    <span class="string">r&quot;ä½ å¥½|æ‚¨å¥½|å—¨|hello|hi|hey|æ—©ä¸Šå¥½|æ™šä¸Šå¥½|åˆå®‰&quot;</span>,</span><br><span class="line">                    <span class="string">r&quot;å“ˆå–½|å—¨å–½|å–‚|åœ¨å—|æœ‰äººå—&quot;</span></span><br><span class="line">                ],</span><br><span class="line">                priority=<span class="number">10</span></span><br><span class="line">            ),</span><br><span class="line">            Intent(</span><br><span class="line">                name=<span class="string">&quot;farewell&quot;</span>,</span><br><span class="line">                patterns=[</span><br><span class="line">                    <span class="string">r&quot;å†è§|æ‹œæ‹œ|æ™šå®‰|goodbye|bye|see you|ä¸‹æ¬¡èŠ|æ”¹å¤©è§&quot;</span>,</span><br><span class="line">                    <span class="string">r&quot;ç»“æŸ|é€€å‡º|ä¸èŠäº†|åˆ°æ­¤ä¸ºæ­¢&quot;</span></span><br><span class="line">                ],</span><br><span class="line">                priority=<span class="number">10</span></span><br><span class="line">            ),</span><br><span class="line">            Intent(</span><br><span class="line">                name=<span class="string">&quot;question&quot;</span>,</span><br><span class="line">                patterns=[</span><br><span class="line">                    <span class="string">r&quot;.*[?ï¼Ÿ].*&quot;</span>,  <span class="comment"># åŒ…å«é—®å·</span></span><br><span class="line">                    <span class="string">r&quot;.*(å—|ä¹ˆ|å‘¢|ä»€ä¹ˆ|ä¸ºä»€ä¹ˆ|æ€ä¹ˆ|å¦‚ä½•|ä½•æ—¶|å“ªé‡Œ|è°).*&quot;</span>,</span><br><span class="line">                    <span class="string">r&quot;è¯·é—®|è¯·æ•™|é—®ä¸€ä¸‹|èƒ½ä¸èƒ½|æ˜¯å¦å¯ä»¥&quot;</span>,</span><br><span class="line">                    <span class="string">r&quot;è§£é‡Š|è¯´æ˜|ä»‹ç»|è®²è¿°|æè¿°&quot;</span></span><br><span class="line">                ],</span><br><span class="line">                priority=<span class="number">5</span></span><br><span class="line">            ),</span><br><span class="line">            Intent(</span><br><span class="line">                name=<span class="string">&quot;command&quot;</span>,</span><br><span class="line">                patterns=[</span><br><span class="line">                    <span class="string">r&quot;^(è®¾ç½®|é…ç½®|è°ƒæ•´|ä¿®æ”¹|æ”¹å˜).*&quot;</span>,</span><br><span class="line">                    <span class="string">r&quot;^(å¸®åŠ©|help|æ”¯æŒ|æ–‡æ¡£|è¯´æ˜).*&quot;</span>,</span><br><span class="line">                    <span class="string">r&quot;^(æ¸…é™¤|æ¸…ç©º|é‡ç½®|é‡å¯|é‡æ–°å¼€å§‹).*&quot;</span>,</span><br><span class="line">                    <span class="string">r&quot;^(ä¿å­˜|å¯¼å‡º|ä¸‹è½½|å¤‡ä»½).*&quot;</span>,</span><br><span class="line">                    <span class="string">r&quot;^(å¼€å¯|å…³é—­|å¯ç”¨|ç¦ç”¨|æ˜¾ç¤º|éšè—).*&quot;</span></span><br><span class="line">                ],</span><br><span class="line">                priority=<span class="number">7</span></span><br><span class="line">            ),</span><br><span class="line">            Intent(</span><br><span class="line">                name=<span class="string">&quot;feedback&quot;</span>,</span><br><span class="line">                patterns=[</span><br><span class="line">                    <span class="string">r&quot;^(è°¢è°¢|æ„Ÿè°¢|thx|thanks|appreciate).*&quot;</span>,</span><br><span class="line">                    <span class="string">r&quot;^(ä¸å¥½|ä¸å¯¹|é”™äº†|ä¸æ­£ç¡®|æœ‰é—®é¢˜).*&quot;</span>,</span><br><span class="line">                    <span class="string">r&quot;^(å¥½è¯„|å·®è¯„|ç‚¹èµ|è¸©|å–œæ¬¢|ä¸å–œæ¬¢).*&quot;</span>,</span><br><span class="line">                    <span class="string">r&quot;^(å»ºè®®|æ„è§|åé¦ˆ|æŠ¥å‘Š).*&quot;</span></span><br><span class="line">                ],</span><br><span class="line">                priority=<span class="number">6</span></span><br><span class="line">            ),</span><br><span class="line">            Intent(</span><br><span class="line">                name=<span class="string">&quot;conversation&quot;</span>,</span><br><span class="line">                patterns=[</span><br><span class="line">                    <span class="string">r&quot;.*çš„.*&quot;</span>,  <span class="comment"># åŒ…å«&quot;çš„&quot;å­—çš„é™ˆè¿°å¥</span></span><br><span class="line">                    <span class="string">r&quot;æˆ‘è§‰å¾—|æˆ‘è®¤ä¸º|æˆ‘æ„Ÿè§‰|æˆ‘æƒ³|æˆ‘å¸Œæœ›|æˆ‘å»ºè®®&quot;</span>,</span><br><span class="line">                    <span class="string">r&quot;ä»Šå¤©|æ˜¨å¤©|æ˜å¤©|ç°åœ¨|æœ€è¿‘|ä»¥å&quot;</span>,</span><br><span class="line">                    <span class="string">r&quot;å¤©æ°”|å¿ƒæƒ…|ç”Ÿæ´»|å·¥ä½œ|å­¦ä¹ |å¨±ä¹&quot;</span></span><br><span class="line">                ],</span><br><span class="line">                priority=<span class="number">3</span></span><br><span class="line">            )</span><br><span class="line">        ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">detect</span>(<span class="params">self, text: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        æ£€æµ‹æ–‡æœ¬æ„å›¾</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            text: è¾“å…¥æ–‡æœ¬</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            str: æ£€æµ‹åˆ°çš„æ„å›¾åç§°</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> text <span class="keyword">or</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(text, <span class="built_in">str</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;unknown&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è½¬æ¢ä¸ºå°å†™å¹¶å»é™¤å¤šä½™ç©ºæ ¼</span></span><br><span class="line">        text_lower = text.lower().strip()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ£€æŸ¥ç¼“å­˜</span></span><br><span class="line">        <span class="keyword">if</span> text_lower <span class="keyword">in</span> self.pattern_cache:</span><br><span class="line">            <span class="keyword">return</span> self.pattern_cache[text_lower]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æŒ‰ä¼˜å…ˆçº§æ’åº</span></span><br><span class="line">        sorted_intents = <span class="built_in">sorted</span>(self.intents, key=<span class="keyword">lambda</span> x: x.priority, reverse=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åŒ¹é…æ„å›¾</span></span><br><span class="line">        <span class="keyword">for</span> intent <span class="keyword">in</span> sorted_intents:</span><br><span class="line">            <span class="keyword">for</span> pattern <span class="keyword">in</span> intent.patterns:</span><br><span class="line">                <span class="keyword">if</span> re.search(pattern, text_lower, re.IGNORECASE):</span><br><span class="line">                    <span class="comment"># ç¼“å­˜ç»“æœ</span></span><br><span class="line">                    self.pattern_cache[text_lower] = intent.name</span><br><span class="line">                    logger.debug(<span class="string">f&quot;Detected intent &#x27;<span class="subst">&#123;intent.name&#125;</span>&#x27; for text: <span class="subst">&#123;text[:<span class="number">50</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">                    <span class="keyword">return</span> intent.name</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># é»˜è®¤æ„å›¾</span></span><br><span class="line">        default_intent = <span class="string">&quot;conversation&quot;</span></span><br><span class="line">        self.pattern_cache[text_lower] = default_intent</span><br><span class="line">        <span class="keyword">return</span> default_intent</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">detect_multiple</span>(<span class="params">self, texts: <span class="type">List</span>[<span class="built_in">str</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ‰¹é‡æ£€æµ‹æ„å›¾&quot;&quot;&quot;</span></span><br><span class="line">        tasks = [self.detect(text) <span class="keyword">for</span> text <span class="keyword">in</span> texts]</span><br><span class="line">        results = <span class="keyword">await</span> asyncio.gather(*tasks)</span><br><span class="line">        <span class="keyword">return</span> results</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_intent_details</span>(<span class="params">self, intent_name: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–æ„å›¾è¯¦æƒ…&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> intent <span class="keyword">in</span> self.intents:</span><br><span class="line">            <span class="keyword">if</span> intent.name == intent_name:</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    <span class="string">&quot;name&quot;</span>: intent.name,</span><br><span class="line">                    <span class="string">&quot;patterns&quot;</span>: intent.patterns,</span><br><span class="line">                    <span class="string">&quot;priority&quot;</span>: intent.priority,</span><br><span class="line">                    <span class="string">&quot;description&quot;</span>: self._get_intent_description(intent.name)</span><br><span class="line">                &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_intent_description</span>(<span class="params">self, intent_name: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–æ„å›¾æè¿°&quot;&quot;&quot;</span></span><br><span class="line">        descriptions = &#123;</span><br><span class="line">            <span class="string">&quot;greeting&quot;</span>: <span class="string">&quot;é—®å€™å’Œæ‰“æ‹›å‘¼&quot;</span>,</span><br><span class="line">            <span class="string">&quot;farewell&quot;</span>: <span class="string">&quot;å‘Šåˆ«å’Œç»“æŸå¯¹è¯&quot;</span>,</span><br><span class="line">            <span class="string">&quot;question&quot;</span>: <span class="string">&quot;è¯¢é—®å’Œæé—®&quot;</span>,</span><br><span class="line">            <span class="string">&quot;command&quot;</span>: <span class="string">&quot;å‘½ä»¤å’Œæ§åˆ¶&quot;</span>,</span><br><span class="line">            <span class="string">&quot;feedback&quot;</span>: <span class="string">&quot;åé¦ˆå’Œè¯„ä»·&quot;</span>,</span><br><span class="line">            <span class="string">&quot;conversation&quot;</span>: <span class="string">&quot;ä¸€èˆ¬å¯¹è¯å’Œäº¤æµ&quot;</span>,</span><br><span class="line">            <span class="string">&quot;unknown&quot;</span>: <span class="string">&quot;æœªçŸ¥æ„å›¾&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> descriptions.get(intent_name, <span class="string">&quot;æœªçŸ¥æ„å›¾&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">analyze_text_features</span>(<span class="params">self, text: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆ†ææ–‡æœ¬ç‰¹å¾&quot;&quot;&quot;</span></span><br><span class="line">        features = &#123;</span><br><span class="line">            <span class="string">&quot;length&quot;</span>: <span class="built_in">len</span>(text),</span><br><span class="line">            <span class="string">&quot;word_count&quot;</span>: <span class="built_in">len</span>(text.split()),</span><br><span class="line">            <span class="string">&quot;has_question_mark&quot;</span>: <span class="string">&quot;?&quot;</span> <span class="keyword">in</span> text <span class="keyword">or</span> <span class="string">&quot;ï¼Ÿ&quot;</span> <span class="keyword">in</span> text,</span><br><span class="line">            <span class="string">&quot;has_exclamation&quot;</span>: <span class="string">&quot;!&quot;</span> <span class="keyword">in</span> text <span class="keyword">or</span> <span class="string">&quot;ï¼&quot;</span> <span class="keyword">in</span> text,</span><br><span class="line">            <span class="string">&quot;has_chinese&quot;</span>: <span class="built_in">bool</span>(re.search(<span class="string">r&#x27;[\u4e00-\u9fff]&#x27;</span>, text)),</span><br><span class="line">            <span class="string">&quot;has_english&quot;</span>: <span class="built_in">bool</span>(re.search(<span class="string">r&#x27;[a-zA-Z]&#x27;</span>, text)),</span><br><span class="line">            <span class="string">&quot;has_numbers&quot;</span>: <span class="built_in">bool</span>(re.search(<span class="string">r&#x27;\d&#x27;</span>, text)),</span><br><span class="line">            <span class="string">&quot;has_emoticon&quot;</span>: <span class="built_in">bool</span>(re.search(<span class="string">r&#x27;[:;]-?[\)\(DP]&#x27;</span>, text))  <span class="comment"># ç®€å•è¡¨æƒ…æ£€æµ‹</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®¡ç®—æƒ…ç»ªè¯æ¯”ä¾‹</span></span><br><span class="line">        positive_words = [<span class="string">&quot;å¥½&quot;</span>, <span class="string">&quot;å–œæ¬¢&quot;</span>, <span class="string">&quot;å¼€å¿ƒ&quot;</span>, <span class="string">&quot;é«˜å…´&quot;</span>, <span class="string">&quot;æ£’&quot;</span>, <span class="string">&quot;ä¼˜ç§€&quot;</span>, <span class="string">&quot;å®Œç¾&quot;</span>, <span class="string">&quot;èµ&quot;</span>]</span><br><span class="line">        negative_words = [<span class="string">&quot;ä¸å¥½&quot;</span>, <span class="string">&quot;è®¨åŒ&quot;</span>, <span class="string">&quot;ä¼¤å¿ƒ&quot;</span>, <span class="string">&quot;éš¾è¿‡&quot;</span>, <span class="string">&quot;ç³Ÿ&quot;</span>, <span class="string">&quot;å·®&quot;</span>, <span class="string">&quot;å&quot;</span>, <span class="string">&quot;çƒ‚&quot;</span>]</span><br><span class="line">        </span><br><span class="line">        words = text.lower().split()</span><br><span class="line">        total_words = <span class="built_in">len</span>(words)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> total_words &gt; <span class="number">0</span>:</span><br><span class="line">            positive_count = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> word <span class="keyword">in</span> words <span class="keyword">if</span> <span class="built_in">any</span>(pw <span class="keyword">in</span> word <span class="keyword">for</span> pw <span class="keyword">in</span> positive_words))</span><br><span class="line">            negative_count = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> word <span class="keyword">in</span> words <span class="keyword">if</span> <span class="built_in">any</span>(nw <span class="keyword">in</span> word <span class="keyword">for</span> nw <span class="keyword">in</span> negative_words))</span><br><span class="line">            </span><br><span class="line">            features[<span class="string">&quot;positive_ratio&quot;</span>] = positive_count / total_words</span><br><span class="line">            features[<span class="string">&quot;negative_ratio&quot;</span>] = negative_count / total_words</span><br><span class="line">            features[<span class="string">&quot;sentiment_score&quot;</span>] = (positive_count - negative_count) / total_words</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            features[<span class="string">&quot;positive_ratio&quot;</span>] = <span class="number">0</span></span><br><span class="line">            features[<span class="string">&quot;negative_ratio&quot;</span>] = <span class="number">0</span></span><br><span class="line">            features[<span class="string">&quot;sentiment_score&quot;</span>] = <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> features</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">clear_cache</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ¸…ç©ºç¼“å­˜&quot;&quot;&quot;</span></span><br><span class="line">        self.pattern_cache.clear()</span><br><span class="line">        logger.info(<span class="string">&quot;Intent detector cache cleared&quot;</span>)</span><br></pre></td></tr></table></figure>



<p><strong>app&#x2F;core&#x2F;emotion_analyzer.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Optional</span>, <span class="type">Tuple</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">import</span> jieba</span><br><span class="line"><span class="keyword">import</span> jieba.posseg <span class="keyword">as</span> pseg</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EmotionWord</span>:</span><br><span class="line">    word: <span class="built_in">str</span></span><br><span class="line">    emotion: <span class="built_in">str</span></span><br><span class="line">    intensity: <span class="built_in">float</span>  <span class="comment"># 0.0 åˆ° 1.0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EmotionAnalyzer</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æƒ…æ„Ÿåˆ†æå™¨&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–ç»“å·´åˆ†è¯</span></span><br><span class="line">        jieba.initialize()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åŠ è½½æƒ…æ„Ÿè¯å…¸</span></span><br><span class="line">        self.emotion_words = self._load_emotion_words()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æƒ…æ„Ÿç±»åˆ«</span></span><br><span class="line">        self.emotion_categories = [<span class="string">&quot;positive&quot;</span>, <span class="string">&quot;negative&quot;</span>, <span class="string">&quot;neutral&quot;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è¡¨æƒ…ç¬¦å·æ˜ å°„</span></span><br><span class="line">        self.emoticon_map = &#123;</span><br><span class="line">            <span class="string">&quot;positive&quot;</span>: [<span class="string">&quot;:)&quot;</span>, <span class="string">&quot;:-)&quot;</span>, <span class="string">&quot;:D&quot;</span>, <span class="string">&quot;:-D&quot;</span>, <span class="string">&quot;^_^&quot;</span>, <span class="string">&quot;ğŸ˜Š&quot;</span>, <span class="string">&quot;ğŸ˜„&quot;</span>, <span class="string">&quot;ğŸ˜&quot;</span>, <span class="string">&quot;ğŸ˜‚&quot;</span>, <span class="string">&quot;ğŸ¤£&quot;</span>, <span class="string">&quot;ğŸ˜&quot;</span>, <span class="string">&quot;ğŸ¥°&quot;</span>],</span><br><span class="line">            <span class="string">&quot;negative&quot;</span>: [<span class="string">&quot;:(&quot;</span>, <span class="string">&quot;:-(&quot;</span>, <span class="string">&quot;:&#x27;(&quot;</span>, <span class="string">&quot;T_T&quot;</span>, <span class="string">&quot;ğŸ˜¢&quot;</span>, <span class="string">&quot;ğŸ˜­&quot;</span>, <span class="string">&quot;ğŸ˜&quot;</span>, <span class="string">&quot;ğŸ˜”&quot;</span>, <span class="string">&quot;ğŸ˜Ÿ&quot;</span>, <span class="string">&quot;ğŸ˜©&quot;</span>, <span class="string">&quot;ğŸ˜«&quot;</span>],</span><br><span class="line">            <span class="string">&quot;neutral&quot;</span>: [<span class="string">&quot;:|&quot;</span>, <span class="string">&quot;:-|&quot;</span>, <span class="string">&quot;ğŸ˜&quot;</span>, <span class="string">&quot;ğŸ˜‘&quot;</span>, <span class="string">&quot;ğŸ˜¶&quot;</span>, <span class="string">&quot;ğŸ¤”&quot;</span>, <span class="string">&quot;ğŸ˜&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">&quot;EmotionAnalyzer initialized&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_load_emotion_words</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[EmotionWord]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åŠ è½½æƒ…æ„Ÿè¯å…¸&quot;&quot;&quot;</span></span><br><span class="line">        emotion_words = []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ­£é¢æƒ…æ„Ÿè¯</span></span><br><span class="line">        positive_words = [</span><br><span class="line">            (<span class="string">&quot;å¥½&quot;</span>, <span class="number">0.8</span>), (<span class="string">&quot;ä¼˜ç§€&quot;</span>, <span class="number">0.9</span>), (<span class="string">&quot;å®Œç¾&quot;</span>, <span class="number">1.0</span>), (<span class="string">&quot;æ£’&quot;</span>, <span class="number">0.7</span>), (<span class="string">&quot;èµ&quot;</span>, <span class="number">0.6</span>),</span><br><span class="line">            (<span class="string">&quot;å–œæ¬¢&quot;</span>, <span class="number">0.7</span>), (<span class="string">&quot;çˆ±&quot;</span>, <span class="number">0.9</span>), (<span class="string">&quot;å¼€å¿ƒ&quot;</span>, <span class="number">0.8</span>), (<span class="string">&quot;é«˜å…´&quot;</span>, <span class="number">0.8</span>), (<span class="string">&quot;å¿«ä¹&quot;</span>, <span class="number">0.8</span>),</span><br><span class="line">            (<span class="string">&quot;æ»¡æ„&quot;</span>, <span class="number">0.7</span>), (<span class="string">&quot;æˆåŠŸ&quot;</span>, <span class="number">0.8</span>), (<span class="string">&quot;èƒœåˆ©&quot;</span>, <span class="number">0.9</span>), (<span class="string">&quot;ç¾ä¸½&quot;</span>, <span class="number">0.7</span>), (<span class="string">&quot;æ¼‚äº®&quot;</span>, <span class="number">0.7</span>),</span><br><span class="line">            (<span class="string">&quot;èªæ˜&quot;</span>, <span class="number">0.7</span>), (<span class="string">&quot;å‰å®³&quot;</span>, <span class="number">0.8</span>), (<span class="string">&quot;å¼ºå¤§&quot;</span>, <span class="number">0.8</span>), (<span class="string">&quot;æ¸©æš–&quot;</span>, <span class="number">0.6</span>), (<span class="string">&quot;å¹¸ç¦&quot;</span>, <span class="number">0.9</span>),</span><br><span class="line">            (<span class="string">&quot;è°¢è°¢&quot;</span>, <span class="number">0.5</span>), (<span class="string">&quot;æ„Ÿè°¢&quot;</span>, <span class="number">0.6</span>), (<span class="string">&quot;æ­å–œ&quot;</span>, <span class="number">0.7</span>), (<span class="string">&quot;ç¥è´º&quot;</span>, <span class="number">0.7</span>)</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è´Ÿé¢æƒ…æ„Ÿè¯</span></span><br><span class="line">        negative_words = [</span><br><span class="line">            (<span class="string">&quot;å&quot;</span>, <span class="number">0.8</span>), (<span class="string">&quot;å·®&quot;</span>, <span class="number">0.7</span>), (<span class="string">&quot;ç³Ÿç³•&quot;</span>, <span class="number">0.9</span>), (<span class="string">&quot;çƒ‚&quot;</span>, <span class="number">0.8</span>), (<span class="string">&quot;å·®åŠ²&quot;</span>, <span class="number">0.8</span>),</span><br><span class="line">            (<span class="string">&quot;è®¨åŒ&quot;</span>, <span class="number">0.8</span>), (<span class="string">&quot;æ¨&quot;</span>, <span class="number">1.0</span>), (<span class="string">&quot;ç”Ÿæ°”&quot;</span>, <span class="number">0.8</span>), (<span class="string">&quot;æ„¤æ€’&quot;</span>, <span class="number">0.9</span>), (<span class="string">&quot;ä¼¤å¿ƒ&quot;</span>, <span class="number">0.8</span>),</span><br><span class="line">            (<span class="string">&quot;éš¾è¿‡&quot;</span>, <span class="number">0.8</span>), (<span class="string">&quot;æ‚²ä¼¤&quot;</span>, <span class="number">0.9</span>), (<span class="string">&quot;ç—›è‹¦&quot;</span>, <span class="number">0.9</span>), (<span class="string">&quot;å¤±æœ›&quot;</span>, <span class="number">0.8</span>), (<span class="string">&quot;å¤±è´¥&quot;</span>, <span class="number">0.8</span>),</span><br><span class="line">            (<span class="string">&quot;å›°éš¾&quot;</span>, <span class="number">0.6</span>), (<span class="string">&quot;éº»çƒ¦&quot;</span>, <span class="number">0.7</span>), (<span class="string">&quot;é—®é¢˜&quot;</span>, <span class="number">0.5</span>), (<span class="string">&quot;é”™è¯¯&quot;</span>, <span class="number">0.7</span>), (<span class="string">&quot;æŠ±æ­‰&quot;</span>, <span class="number">0.5</span>),</span><br><span class="line">            (<span class="string">&quot;å¯¹ä¸èµ·&quot;</span>, <span class="number">0.6</span>), (<span class="string">&quot;é—æ†¾&quot;</span>, <span class="number">0.7</span>), (<span class="string">&quot;ç—›è‹¦&quot;</span>, <span class="number">0.9</span>), (<span class="string">&quot;ç»æœ›&quot;</span>, <span class="number">1.0</span>)</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ·»åŠ æ­£é¢è¯</span></span><br><span class="line">        <span class="keyword">for</span> word, intensity <span class="keyword">in</span> positive_words:</span><br><span class="line">            emotion_words.append(EmotionWord(word=word, emotion=<span class="string">&quot;positive&quot;</span>, intensity=intensity))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ·»åŠ è´Ÿé¢è¯</span></span><br><span class="line">        <span class="keyword">for</span> word, intensity <span class="keyword">in</span> negative_words:</span><br><span class="line">            emotion_words.append(EmotionWord(word=word, emotion=<span class="string">&quot;negative&quot;</span>, intensity=intensity))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> emotion_words</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">analyze</span>(<span class="params">self, text: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        åˆ†ææ–‡æœ¬æƒ…æ„Ÿ</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            text: è¾“å…¥æ–‡æœ¬</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            str: æƒ…æ„Ÿç±»åˆ« (positive, negative, neutral)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> text <span class="keyword">or</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(text, <span class="built_in">str</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;neutral&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ£€æŸ¥è¡¨æƒ…ç¬¦å·</span></span><br><span class="line">        emoticon_emotion = self._detect_emoticon(text)</span><br><span class="line">        <span class="keyword">if</span> emoticon_emotion:</span><br><span class="line">            <span class="keyword">return</span> emoticon_emotion</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åˆ†è¯</span></span><br><span class="line">        words = self._segment_text(text)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> words:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;neutral&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®¡ç®—æƒ…æ„Ÿåˆ†æ•°</span></span><br><span class="line">        scores = self._calculate_emotion_scores(words)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åˆ¤æ–­æƒ…æ„Ÿç±»åˆ«</span></span><br><span class="line">        emotion = self._classify_emotion(scores)</span><br><span class="line">        </span><br><span class="line">        logger.debug(<span class="string">f&quot;Emotion analysis: text=&#x27;<span class="subst">&#123;text[:<span class="number">50</span>]&#125;</span>...&#x27;, scores=<span class="subst">&#123;scores&#125;</span>, emotion=<span class="subst">&#123;emotion&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> emotion</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_segment_text</span>(<span class="params">self, text: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆ†è¯&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ä½¿ç”¨ç»“å·´åˆ†è¯</span></span><br><span class="line">        words = []</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            seg_list = jieba.cut(text, cut_all=<span class="literal">False</span>)</span><br><span class="line">            words = <span class="built_in">list</span>(seg_list)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Error segmenting text: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># å›é€€åˆ°ç®€å•ç©ºæ ¼åˆ†å‰²</span></span><br><span class="line">            words = text.split()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> words</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_detect_emoticon</span>(<span class="params">self, text: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ£€æµ‹è¡¨æƒ…ç¬¦å·&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> emotion, emoticons <span class="keyword">in</span> self.emoticon_map.items():</span><br><span class="line">            <span class="keyword">for</span> emoticon <span class="keyword">in</span> emoticons:</span><br><span class="line">                <span class="keyword">if</span> emoticon <span class="keyword">in</span> text:</span><br><span class="line">                    <span class="keyword">return</span> emotion</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_calculate_emotion_scores</span>(<span class="params">self, words: <span class="type">List</span>[<span class="built_in">str</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">float</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è®¡ç®—æƒ…æ„Ÿåˆ†æ•°&quot;&quot;&quot;</span></span><br><span class="line">        scores = &#123;<span class="string">&quot;positive&quot;</span>: <span class="number">0.0</span>, <span class="string">&quot;negative&quot;</span>: <span class="number">0.0</span>, <span class="string">&quot;neutral&quot;</span>: <span class="number">0.0</span>&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å¦å®šè¯</span></span><br><span class="line">        negation_words = [<span class="string">&quot;ä¸&quot;</span>, <span class="string">&quot;æ²¡&quot;</span>, <span class="string">&quot;æ— &quot;</span>, <span class="string">&quot;é&quot;</span>, <span class="string">&quot;æœª&quot;</span>, <span class="string">&quot;è«&quot;</span>, <span class="string">&quot;å‹¿&quot;</span>, <span class="string">&quot;åˆ«&quot;</span>]</span><br><span class="line">        negation_multiplier = -<span class="number">1.0</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å¼ºåº¦å‰¯è¯</span></span><br><span class="line">        intensity_words = &#123;</span><br><span class="line">            <span class="string">&quot;éå¸¸&quot;</span>: <span class="number">2.0</span>, <span class="string">&quot;å¾ˆ&quot;</span>: <span class="number">1.5</span>, <span class="string">&quot;ç‰¹åˆ«&quot;</span>: <span class="number">2.0</span>, <span class="string">&quot;æå…¶&quot;</span>: <span class="number">2.5</span>, <span class="string">&quot;ååˆ†&quot;</span>: <span class="number">1.8</span>,</span><br><span class="line">            <span class="string">&quot;æœ‰ç‚¹&quot;</span>: <span class="number">0.5</span>, <span class="string">&quot;ç¨å¾®&quot;</span>: <span class="number">0.5</span>, <span class="string">&quot;ç•¥å¾®&quot;</span>: <span class="number">0.5</span>, <span class="string">&quot;ç¨ç¨&quot;</span>: <span class="number">0.5</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        current_intensity = <span class="number">1.0</span></span><br><span class="line">        negated = <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i, word <span class="keyword">in</span> <span class="built_in">enumerate</span>(words):</span><br><span class="line">            <span class="comment"># æ£€æŸ¥æ˜¯å¦ä¸ºå¼ºåº¦å‰¯è¯</span></span><br><span class="line">            <span class="keyword">if</span> word <span class="keyword">in</span> intensity_words:</span><br><span class="line">                current_intensity = intensity_words[word]</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ£€æŸ¥æ˜¯å¦ä¸ºå¦å®šè¯</span></span><br><span class="line">            <span class="keyword">if</span> word <span class="keyword">in</span> negation_words:</span><br><span class="line">                negated = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ£€æŸ¥æƒ…æ„Ÿè¯</span></span><br><span class="line">            <span class="keyword">for</span> emotion_word <span class="keyword">in</span> self.emotion_words:</span><br><span class="line">                <span class="keyword">if</span> emotion_word.word <span class="keyword">in</span> word:</span><br><span class="line">                    score = emotion_word.intensity * current_intensity</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># åº”ç”¨å¦å®š</span></span><br><span class="line">                    <span class="keyword">if</span> negated:</span><br><span class="line">                        score *= negation_multiplier</span><br><span class="line">                        negated = <span class="literal">False</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># æ ¹æ®åˆ†æ•°æ­£è´Ÿåˆ†é…åˆ°æ­£é¢æˆ–è´Ÿé¢</span></span><br><span class="line">                    <span class="keyword">if</span> score &gt; <span class="number">0</span>:</span><br><span class="line">                        scores[<span class="string">&quot;positive&quot;</span>] += score</span><br><span class="line">                    <span class="keyword">elif</span> score &lt; <span class="number">0</span>:</span><br><span class="line">                        scores[<span class="string">&quot;negative&quot;</span>] += <span class="built_in">abs</span>(score)</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># é‡ç½®å¼ºåº¦</span></span><br><span class="line">                    current_intensity = <span class="number">1.0</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å½’ä¸€åŒ–åˆ†æ•°</span></span><br><span class="line">        total_score = <span class="built_in">sum</span>(scores.values())</span><br><span class="line">        <span class="keyword">if</span> total_score &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">for</span> emotion <span class="keyword">in</span> scores:</span><br><span class="line">                scores[emotion] = scores[emotion] / total_score</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> scores</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_classify_emotion</span>(<span class="params">self, scores: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">float</span>]</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆ†ç±»æƒ…æ„Ÿ&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># å¦‚æœæ­£é¢å’Œè´Ÿé¢åˆ†æ•°éƒ½å¾ˆä½ï¼Œè¿”å›ä¸­æ€§</span></span><br><span class="line">        <span class="keyword">if</span> scores[<span class="string">&quot;positive&quot;</span>] &lt; <span class="number">0.1</span> <span class="keyword">and</span> scores[<span class="string">&quot;negative&quot;</span>] &lt; <span class="number">0.1</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;neutral&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ¯”è¾ƒæ­£é¢å’Œè´Ÿé¢åˆ†æ•°</span></span><br><span class="line">        <span class="keyword">if</span> scores[<span class="string">&quot;positive&quot;</span>] &gt; scores[<span class="string">&quot;negative&quot;</span>]:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;positive&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> scores[<span class="string">&quot;negative&quot;</span>] &gt; scores[<span class="string">&quot;positive&quot;</span>]:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;negative&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;neutral&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">analyze_with_details</span>(<span class="params">self, text: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆ†ææƒ…æ„Ÿå¹¶è¿”å›è¯¦ç»†ä¿¡æ¯&quot;&quot;&quot;</span></span><br><span class="line">        emotion = <span class="keyword">await</span> self.analyze(text)</span><br><span class="line">        words = self._segment_text(text)</span><br><span class="line">        scores = self._calculate_emotion_scores(words)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ£€æµ‹åˆ°çš„æƒ…æ„Ÿè¯</span></span><br><span class="line">        detected_words = []</span><br><span class="line">        <span class="keyword">for</span> word <span class="keyword">in</span> words:</span><br><span class="line">            <span class="keyword">for</span> emotion_word <span class="keyword">in</span> self.emotion_words:</span><br><span class="line">                <span class="keyword">if</span> emotion_word.word <span class="keyword">in</span> word:</span><br><span class="line">                    detected_words.append(&#123;</span><br><span class="line">                        <span class="string">&quot;word&quot;</span>: word,</span><br><span class="line">                        <span class="string">&quot;emotion&quot;</span>: emotion_word.emotion,</span><br><span class="line">                        <span class="string">&quot;intensity&quot;</span>: emotion_word.intensity</span><br><span class="line">                    &#125;)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;text&quot;</span>: text,</span><br><span class="line">            <span class="string">&quot;emotion&quot;</span>: emotion,</span><br><span class="line">            <span class="string">&quot;scores&quot;</span>: scores,</span><br><span class="line">            <span class="string">&quot;word_count&quot;</span>: <span class="built_in">len</span>(words),</span><br><span class="line">            <span class="string">&quot;detected_words&quot;</span>: detected_words[:<span class="number">10</span>],  <span class="comment"># é™åˆ¶æ•°é‡</span></span><br><span class="line">            <span class="string">&quot;emoticon_detected&quot;</span>: self._detect_emoticon(text) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">analyze_batch</span>(<span class="params">self, texts: <span class="type">List</span>[<span class="built_in">str</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ‰¹é‡åˆ†ææƒ…æ„Ÿ&quot;&quot;&quot;</span></span><br><span class="line">        tasks = [self.analyze(text) <span class="keyword">for</span> text <span class="keyword">in</span> texts]</span><br><span class="line">        results = <span class="keyword">await</span> asyncio.gather(*tasks)</span><br><span class="line">        <span class="keyword">return</span> results</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_emotion_statistics</span>(<span class="params">self, emotions: <span class="type">List</span>[<span class="built_in">str</span>]</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–æƒ…æ„Ÿç»Ÿè®¡&quot;&quot;&quot;</span></span><br><span class="line">        total = <span class="built_in">len</span>(emotions)</span><br><span class="line">        <span class="keyword">if</span> total == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        counts = &#123;<span class="string">&quot;positive&quot;</span>: <span class="number">0</span>, <span class="string">&quot;negative&quot;</span>: <span class="number">0</span>, <span class="string">&quot;neutral&quot;</span>: <span class="number">0</span>&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> emotion <span class="keyword">in</span> emotions:</span><br><span class="line">            <span class="keyword">if</span> emotion <span class="keyword">in</span> counts:</span><br><span class="line">                counts[emotion] += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        percentages = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> emotion, count <span class="keyword">in</span> counts.items():</span><br><span class="line">            percentages[emotion] = count / total</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;counts&quot;</span>: counts,</span><br><span class="line">            <span class="string">&quot;percentages&quot;</span>: percentages,</span><br><span class="line">            <span class="string">&quot;total&quot;</span>: total,</span><br><span class="line">            <span class="string">&quot;dominant_emotion&quot;</span>: <span class="built_in">max</span>(counts, key=counts.get)</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



<h2 id="ç¬¬5æ­¥ï¼šAPIæ¥å£å®ç°"><a href="#ç¬¬5æ­¥ï¼šAPIæ¥å£å®ç°" class="headerlink" title="ç¬¬5æ­¥ï¼šAPIæ¥å£å®ç°"></a>ç¬¬5æ­¥ï¼šAPIæ¥å£å®ç°</h2><p><strong>app&#x2F;api&#x2F;chat.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint, request, jsonify, current_app</span><br><span class="line"><span class="keyword">from</span> flask_login <span class="keyword">import</span> login_required, current_user</span><br><span class="line"><span class="keyword">from</span> flask_limiter <span class="keyword">import</span> Limiter</span><br><span class="line"><span class="keyword">from</span> flask_limiter.util <span class="keyword">import</span> get_remote_address</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> app.core.chatbot <span class="keyword">import</span> ChatBot</span><br><span class="line"><span class="keyword">from</span> app.database.models <span class="keyword">import</span> ChatSession, ChatMessage</span><br><span class="line"><span class="keyword">from</span> app.database.session <span class="keyword">import</span> DBSession</span><br><span class="line"><span class="keyword">from</span> app.utils.validators <span class="keyword">import</span> validate_chat_request</span><br><span class="line"><span class="keyword">from</span> app.utils.decorators <span class="keyword">import</span> async_handler, rate_limit_by_user</span><br><span class="line"><span class="keyword">from</span> app.services.task_service <span class="keyword">import</span> process_chat_async</span><br><span class="line"></span><br><span class="line">chat_bp = Blueprint(<span class="string">&#x27;chat&#x27;</span>, __name__)</span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–èŠå¤©æœºå™¨äºº</span></span><br><span class="line">chatbot = ChatBot()</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€Ÿç‡é™åˆ¶å™¨</span></span><br><span class="line">limiter = Limiter(</span><br><span class="line">    key_func=get_remote_address,</span><br><span class="line">    default_limits=[<span class="string">&quot;200 per day&quot;</span>, <span class="string">&quot;50 per hour&quot;</span>]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="meta">@chat_bp.route(<span class="params"><span class="string">&#x27;/send&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="meta">@rate_limit_by_user(<span class="params">limit=<span class="string">&quot;10/minute&quot;</span></span>)</span></span><br><span class="line"><span class="meta">@async_handler</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">send_message</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å‘é€èŠå¤©æ¶ˆæ¯</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Request JSON:</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;message&quot;: &quot;ç”¨æˆ·æ¶ˆæ¯&quot;,</span></span><br><span class="line"><span class="string">        &quot;session_id&quot;: &quot;ä¼šè¯IDï¼ˆå¯é€‰ï¼‰&quot;,</span></span><br><span class="line"><span class="string">        &quot;context&quot;: &#123;&quot;key&quot;: &quot;value&quot;&#125;  # ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Response JSON:</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;success&quot;: true,</span></span><br><span class="line"><span class="string">        &quot;data&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;reply&quot;: &quot;åŠ©æ‰‹å›å¤&quot;,</span></span><br><span class="line"><span class="string">            &quot;session_id&quot;: &quot;ä¼šè¯ID&quot;,</span></span><br><span class="line"><span class="string">            &quot;metadata&quot;: &#123;...&#125;,</span></span><br><span class="line"><span class="string">            &quot;timestamp&quot;: &quot;æ—¶é—´æˆ³&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># éªŒè¯è¯·æ±‚</span></span><br><span class="line">        data = request.get_json()</span><br><span class="line">        validation_result = validate_chat_request(data)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> validation_result[<span class="string">&quot;valid&quot;</span>]:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                <span class="string">&quot;error&quot;</span>: validation_result[<span class="string">&quot;errors&quot;</span>][<span class="number">0</span>],</span><br><span class="line">                <span class="string">&quot;code&quot;</span>: <span class="number">400</span></span><br><span class="line">            &#125;), <span class="number">400</span></span><br><span class="line">        </span><br><span class="line">        user_message = data[<span class="string">&#x27;message&#x27;</span>]</span><br><span class="line">        session_id = data.get(<span class="string">&#x27;session_id&#x27;</span>)</span><br><span class="line">        context_vars = data.get(<span class="string">&#x27;context&#x27;</span>, &#123;&#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è·å–æˆ–åˆ›å»ºä¼šè¯</span></span><br><span class="line">        <span class="keyword">with</span> DBSession.session_scope() <span class="keyword">as</span> session:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> session_id:</span><br><span class="line">                <span class="comment"># åˆ›å»ºæ–°ä¼šè¯</span></span><br><span class="line">                new_session = ChatSession(</span><br><span class="line">                    user_id=current_user.<span class="built_in">id</span>,</span><br><span class="line">                    title=user_message[:<span class="number">50</span>] + <span class="string">&quot;...&quot;</span> <span class="keyword">if</span> <span class="built_in">len</span>(user_message) &gt; <span class="number">50</span> <span class="keyword">else</span> user_message</span><br><span class="line">                )</span><br><span class="line">                session.add(new_session)</span><br><span class="line">                session.flush()</span><br><span class="line">                session_id = new_session.<span class="built_in">id</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># éªŒè¯ä¼šè¯æ‰€æœ‰æƒ</span></span><br><span class="line">                chat_session = session.query(ChatSession).filter_by(</span><br><span class="line">                    <span class="built_in">id</span>=session_id, </span><br><span class="line">                    user_id=current_user.<span class="built_in">id</span></span><br><span class="line">                ).first()</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> chat_session:</span><br><span class="line">                    <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                        <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                        <span class="string">&quot;error&quot;</span>: <span class="string">&quot;ä¼šè¯ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;code&quot;</span>: <span class="number">404</span></span><br><span class="line">                    &#125;), <span class="number">404</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># å¤„ç†èŠå¤©æ¶ˆæ¯ï¼ˆå¼‚æ­¥ï¼‰</span></span><br><span class="line">            response = <span class="keyword">await</span> chatbot.process_message(</span><br><span class="line">                user_message=user_message,</span><br><span class="line">                session_id=session_id,</span><br><span class="line">                user_id=current_user.<span class="built_in">id</span>,</span><br><span class="line">                context_vars=context_vars</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># ä¿å­˜ç”¨æˆ·æ¶ˆæ¯</span></span><br><span class="line">            user_msg = ChatMessage(</span><br><span class="line">                <span class="built_in">id</span>=<span class="built_in">str</span>(uuid.uuid4()),</span><br><span class="line">                session_id=session_id,</span><br><span class="line">                role=<span class="string">&quot;user&quot;</span>,</span><br><span class="line">                content=user_message,</span><br><span class="line">                metadata=&#123;<span class="string">&quot;intent&quot;</span>: response[<span class="string">&quot;metadata&quot;</span>][<span class="string">&quot;intent&quot;</span>]&#125;</span><br><span class="line">            )</span><br><span class="line">            session.add(user_msg)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># ä¿å­˜åŠ©æ‰‹å›å¤</span></span><br><span class="line">            assistant_msg = ChatMessage(</span><br><span class="line">                <span class="built_in">id</span>=<span class="built_in">str</span>(uuid.uuid4()),</span><br><span class="line">                session_id=session_id,</span><br><span class="line">                role=<span class="string">&quot;assistant&quot;</span>,</span><br><span class="line">                content=response[<span class="string">&quot;reply&quot;</span>],</span><br><span class="line">                metadata=response[<span class="string">&quot;metadata&quot;</span>]</span><br><span class="line">            )</span><br><span class="line">            session.add(assistant_msg)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ›´æ–°ä¼šè¯æ—¶é—´</span></span><br><span class="line">            chat_session = session.query(ChatSession).get(session_id)</span><br><span class="line">            <span class="keyword">if</span> chat_session:</span><br><span class="line">                chat_session.updated_at = datetime.utcnow()</span><br><span class="line">            </span><br><span class="line">            session.commit()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è¿”å›å“åº”</span></span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;reply&quot;</span>: response[<span class="string">&quot;reply&quot;</span>],</span><br><span class="line">                <span class="string">&quot;session_id&quot;</span>: session_id,</span><br><span class="line">                <span class="string">&quot;metadata&quot;</span>: response[<span class="string">&quot;metadata&quot;</span>],</span><br><span class="line">                <span class="string">&quot;timestamp&quot;</span>: datetime.utcnow().isoformat()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Error in send_message: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&quot;error&quot;</span>: <span class="string">&quot;å¤„ç†æ¶ˆæ¯æ—¶å‘ç”Ÿé”™è¯¯&quot;</span>,</span><br><span class="line">            <span class="string">&quot;code&quot;</span>: <span class="number">500</span>,</span><br><span class="line">            <span class="string">&quot;details&quot;</span>: <span class="built_in">str</span>(e) <span class="keyword">if</span> current_app.config[<span class="string">&#x27;DEBUG&#x27;</span>] <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        &#125;), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@chat_bp.route(<span class="params"><span class="string">&#x27;/sessions&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="meta">@async_handler</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_sessions</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è·å–ç”¨æˆ·çš„èŠå¤©ä¼šè¯åˆ—è¡¨</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Query Parameters:</span></span><br><span class="line"><span class="string">    - page: é¡µç  (é»˜è®¤: 1)</span></span><br><span class="line"><span class="string">    - per_page: æ¯é¡µæ•°é‡ (é»˜è®¤: 20)</span></span><br><span class="line"><span class="string">    - search: æœç´¢å…³é”®è¯ (å¯é€‰)</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Response JSON:</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;success&quot;: true,</span></span><br><span class="line"><span class="string">        &quot;data&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;sessions&quot;: [...],</span></span><br><span class="line"><span class="string">            &quot;pagination&quot;: &#123;</span></span><br><span class="line"><span class="string">                &quot;page&quot;: 1,</span></span><br><span class="line"><span class="string">                &quot;per_page&quot;: 20,</span></span><br><span class="line"><span class="string">                &quot;total&quot;: 100,</span></span><br><span class="line"><span class="string">                &quot;pages&quot;: 5</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># è·å–æŸ¥è¯¢å‚æ•°</span></span><br><span class="line">        page = request.args.get(<span class="string">&#x27;page&#x27;</span>, <span class="number">1</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line">        per_page = request.args.get(<span class="string">&#x27;per_page&#x27;</span>, <span class="number">20</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line">        search = request.args.get(<span class="string">&#x27;search&#x27;</span>, <span class="string">&#x27;&#x27;</span>).strip()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># é™åˆ¶æ¯é¡µæ•°é‡</span></span><br><span class="line">        per_page = <span class="built_in">min</span>(per_page, <span class="number">100</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> DBSession.session_scope() <span class="keyword">as</span> session:</span><br><span class="line">            <span class="comment"># æ„å»ºæŸ¥è¯¢</span></span><br><span class="line">            query = session.query(ChatSession).filter_by(</span><br><span class="line">                user_id=current_user.<span class="built_in">id</span>,</span><br><span class="line">                is_active=<span class="literal">True</span></span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æœç´¢è¿‡æ»¤</span></span><br><span class="line">            <span class="keyword">if</span> search:</span><br><span class="line">                query = query.<span class="built_in">filter</span>(ChatSession.title.contains(search))</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è·å–æ€»æ•°</span></span><br><span class="line">            total = query.count()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># åˆ†é¡µæŸ¥è¯¢</span></span><br><span class="line">            sessions = query.order_by(ChatSession.updated_at.desc())\</span><br><span class="line">                           .offset((page - <span class="number">1</span>) * per_page)\</span><br><span class="line">                           .limit(per_page)\</span><br><span class="line">                           .<span class="built_in">all</span>()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è½¬æ¢ä¸ºå­—å…¸</span></span><br><span class="line">            sessions_data = [s.to_dict() <span class="keyword">for</span> s <span class="keyword">in</span> sessions]</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;sessions&quot;</span>: sessions_data,</span><br><span class="line">                    <span class="string">&quot;pagination&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;page&quot;</span>: page,</span><br><span class="line">                        <span class="string">&quot;per_page&quot;</span>: per_page,</span><br><span class="line">                        <span class="string">&quot;total&quot;</span>: total,</span><br><span class="line">                        <span class="string">&quot;pages&quot;</span>: (total + per_page - <span class="number">1</span>) // per_page</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Error getting sessions: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&quot;error&quot;</span>: <span class="string">&quot;è·å–ä¼šè¯åˆ—è¡¨å¤±è´¥&quot;</span>,</span><br><span class="line">            <span class="string">&quot;code&quot;</span>: <span class="number">500</span></span><br><span class="line">        &#125;), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@chat_bp.route(<span class="params"><span class="string">&#x27;/sessions/&lt;session_id&gt;&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="meta">@async_handler</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_session_detail</span>(<span class="params">session_id</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è·å–ç‰¹å®šä¼šè¯çš„è¯¦ç»†ä¿¡æ¯&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> DBSession.session_scope() <span class="keyword">as</span> session:</span><br><span class="line">            <span class="comment"># æŸ¥è¯¢ä¼šè¯</span></span><br><span class="line">            chat_session = session.query(ChatSession).filter_by(</span><br><span class="line">                <span class="built_in">id</span>=session_id,</span><br><span class="line">                user_id=current_user.<span class="built_in">id</span></span><br><span class="line">            ).first()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> chat_session:</span><br><span class="line">                <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                    <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                    <span class="string">&quot;error&quot;</span>: <span class="string">&quot;ä¼šè¯ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;code&quot;</span>: <span class="number">404</span></span><br><span class="line">                &#125;), <span class="number">404</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è·å–æ¶ˆæ¯å†å²</span></span><br><span class="line">            messages = session.query(ChatMessage)\</span><br><span class="line">                             .filter_by(session_id=session_id)\</span><br><span class="line">                             .order_by(ChatMessage.created_at.asc())\</span><br><span class="line">                             .<span class="built_in">all</span>()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># åˆ†æå¯¹è¯è´¨é‡</span></span><br><span class="line">            conversation_analysis = <span class="keyword">await</span> chatbot.analyze_conversation(session_id)</span><br><span class="line">            </span><br><span class="line">            session_data = chat_session.to_dict()</span><br><span class="line">            session_data[<span class="string">&quot;messages&quot;</span>] = [m.to_dict() <span class="keyword">for</span> m <span class="keyword">in</span> messages]</span><br><span class="line">            session_data[<span class="string">&quot;analysis&quot;</span>] = conversation_analysis</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&quot;data&quot;</span>: session_data</span><br><span class="line">            &#125;)</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Error getting session detail: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&quot;error&quot;</span>: <span class="string">&quot;è·å–ä¼šè¯è¯¦æƒ…å¤±è´¥&quot;</span>,</span><br><span class="line">            <span class="string">&quot;code&quot;</span>: <span class="number">500</span></span><br><span class="line">        &#125;), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@chat_bp.route(<span class="params"><span class="string">&#x27;/sessions/&lt;session_id&gt;&#x27;</span>, methods=[<span class="string">&#x27;DELETE&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="meta">@async_handler</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">delete_session</span>(<span class="params">session_id</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åˆ é™¤ä¼šè¯&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> DBSession.session_scope() <span class="keyword">as</span> session:</span><br><span class="line">            <span class="comment"># æŸ¥è¯¢ä¼šè¯</span></span><br><span class="line">            chat_session = session.query(ChatSession).filter_by(</span><br><span class="line">                <span class="built_in">id</span>=session_id,</span><br><span class="line">                user_id=current_user.<span class="built_in">id</span></span><br><span class="line">            ).first()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> chat_session:</span><br><span class="line">                <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                    <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                    <span class="string">&quot;error&quot;</span>: <span class="string">&quot;ä¼šè¯ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;code&quot;</span>: <span class="number">404</span></span><br><span class="line">                &#125;), <span class="number">404</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è½¯åˆ é™¤ï¼ˆæ ‡è®°ä¸ºä¸æ´»è·ƒï¼‰</span></span><br><span class="line">            chat_session.is_active = <span class="literal">False</span></span><br><span class="line">            session.commit()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&quot;message&quot;</span>: <span class="string">&quot;ä¼šè¯å·²åˆ é™¤&quot;</span></span><br><span class="line">            &#125;)</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Error deleting session: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&quot;error&quot;</span>: <span class="string">&quot;åˆ é™¤ä¼šè¯å¤±è´¥&quot;</span>,</span><br><span class="line">            <span class="string">&quot;code&quot;</span>: <span class="number">500</span></span><br><span class="line">        &#125;), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@chat_bp.route(<span class="params"><span class="string">&#x27;/history/&lt;session_id&gt;&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="meta">@async_handler</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_chat_history</span>(<span class="params">session_id</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è·å–èŠå¤©å†å²</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Query Parameters:</span></span><br><span class="line"><span class="string">    - limit: é™åˆ¶æ•°é‡ (é»˜è®¤: 50, æœ€å¤§: 200)</span></span><br><span class="line"><span class="string">    - before: åœ¨æ­¤æ—¶é—´ä¹‹å‰çš„æ—¶é—´æˆ³ (å¯é€‰)</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Response JSON:</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;success&quot;: true,</span></span><br><span class="line"><span class="string">        &quot;data&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;session_id&quot;: &quot;ä¼šè¯ID&quot;,</span></span><br><span class="line"><span class="string">            &quot;messages&quot;: [...],</span></span><br><span class="line"><span class="string">            &quot;has_more&quot;: true/false</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># è·å–æŸ¥è¯¢å‚æ•°</span></span><br><span class="line">        limit = <span class="built_in">min</span>(request.args.get(<span class="string">&#x27;limit&#x27;</span>, <span class="number">50</span>, <span class="built_in">type</span>=<span class="built_in">int</span>), <span class="number">200</span>)</span><br><span class="line">        before = request.args.get(<span class="string">&#x27;before&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> DBSession.session_scope() <span class="keyword">as</span> session:</span><br><span class="line">            <span class="comment"># éªŒè¯ä¼šè¯æ‰€æœ‰æƒ</span></span><br><span class="line">            chat_session = session.query(ChatSession).filter_by(</span><br><span class="line">                <span class="built_in">id</span>=session_id,</span><br><span class="line">                user_id=current_user.<span class="built_in">id</span></span><br><span class="line">            ).first()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> chat_session:</span><br><span class="line">                <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                    <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                    <span class="string">&quot;error&quot;</span>: <span class="string">&quot;ä¼šè¯ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;code&quot;</span>: <span class="number">404</span></span><br><span class="line">                &#125;), <span class="number">404</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ„å»ºæŸ¥è¯¢</span></span><br><span class="line">            query = session.query(ChatMessage).filter_by(session_id=session_id)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ—¶é—´è¿‡æ»¤</span></span><br><span class="line">            <span class="keyword">if</span> before:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    before_date = datetime.fromisoformat(before.replace(<span class="string">&#x27;Z&#x27;</span>, <span class="string">&#x27;+00:00&#x27;</span>))</span><br><span class="line">                    query = query.<span class="built_in">filter</span>(ChatMessage.created_at &lt; before_date)</span><br><span class="line">                <span class="keyword">except</span> ValueError:</span><br><span class="line">                    <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                        <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                        <span class="string">&quot;error&quot;</span>: <span class="string">&quot;æ— æ•ˆçš„æ—¶é—´æ ¼å¼&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;code&quot;</span>: <span class="number">400</span></span><br><span class="line">                    &#125;), <span class="number">400</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è·å–æ¶ˆæ¯</span></span><br><span class="line">            messages = query.order_by(ChatMessage.created_at.desc())\</span><br><span class="line">                           .limit(limit + <span class="number">1</span>)\</span><br><span class="line">                           .<span class="built_in">all</span>()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ£€æŸ¥æ˜¯å¦æœ‰æ›´å¤šæ¶ˆæ¯</span></span><br><span class="line">            has_more = <span class="built_in">len</span>(messages) &gt; limit</span><br><span class="line">            <span class="keyword">if</span> has_more:</span><br><span class="line">                messages = messages[:limit]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æŒ‰æ—¶é—´å‡åºæ’åºè¿”å›</span></span><br><span class="line">            messages = <span class="built_in">sorted</span>(messages, key=<span class="keyword">lambda</span> x: x.created_at)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;session_id&quot;</span>: session_id,</span><br><span class="line">                    <span class="string">&quot;messages&quot;</span>: [m.to_dict() <span class="keyword">for</span> m <span class="keyword">in</span> messages],</span><br><span class="line">                    <span class="string">&quot;has_more&quot;</span>: has_more,</span><br><span class="line">                    <span class="string">&quot;count&quot;</span>: <span class="built_in">len</span>(messages)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Error getting chat history: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&quot;error&quot;</span>: <span class="string">&quot;è·å–å†å²è®°å½•å¤±è´¥&quot;</span>,</span><br><span class="line">            <span class="string">&quot;code&quot;</span>: <span class="number">500</span></span><br><span class="line">        &#125;), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@chat_bp.route(<span class="params"><span class="string">&#x27;/generate-dialogue&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@async_handler</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">generate_dialogue</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ç”Ÿæˆç¤ºä¾‹å¯¹è¯</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Request JSON:</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;topic&quot;: &quot;å¯¹è¯ä¸»é¢˜&quot;,</span></span><br><span class="line"><span class="string">        &quot;num_exchanges&quot;: 5,  # å¯é€‰ï¼Œé»˜è®¤5</span></span><br><span class="line"><span class="string">        &quot;style&quot;: &quot;professional&quot;  # å¯é€‰ï¼Œé»˜è®¤professional</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Response JSON:</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;success&quot;: true,</span></span><br><span class="line"><span class="string">        &quot;data&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;topic&quot;: &quot;å¯¹è¯ä¸»é¢˜&quot;,</span></span><br><span class="line"><span class="string">            &quot;dialogue&quot;: [...],</span></span><br><span class="line"><span class="string">            &quot;total_exchanges&quot;: 5</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = request.get_json()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data <span class="keyword">or</span> <span class="string">&#x27;topic&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                <span class="string">&quot;error&quot;</span>: <span class="string">&quot;ç¼ºå°‘ä¸»é¢˜å‚æ•°&quot;</span>,</span><br><span class="line">                <span class="string">&quot;code&quot;</span>: <span class="number">400</span></span><br><span class="line">            &#125;), <span class="number">400</span></span><br><span class="line">        </span><br><span class="line">        topic = data.get(<span class="string">&#x27;topic&#x27;</span>, <span class="string">&#x27;äººå·¥æ™ºèƒ½&#x27;</span>)</span><br><span class="line">        num_exchanges = <span class="built_in">min</span>(data.get(<span class="string">&#x27;num_exchanges&#x27;</span>, <span class="number">5</span>), <span class="number">20</span>)</span><br><span class="line">        style = data.get(<span class="string">&#x27;style&#x27;</span>, <span class="string">&#x27;professional&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç”Ÿæˆå¯¹è¯</span></span><br><span class="line">        dialogue = <span class="keyword">await</span> chatbot.generate_dialogue(</span><br><span class="line">            topic=topic,</span><br><span class="line">            num_exchanges=num_exchanges,</span><br><span class="line">            style=style</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;topic&quot;</span>: topic,</span><br><span class="line">                <span class="string">&quot;dialogue&quot;</span>: dialogue,</span><br><span class="line">                <span class="string">&quot;total_exchanges&quot;</span>: <span class="built_in">len</span>(dialogue),</span><br><span class="line">                <span class="string">&quot;style&quot;</span>: style</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Error generating dialogue: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&quot;error&quot;</span>: <span class="string">&quot;ç”Ÿæˆå¯¹è¯å¤±è´¥&quot;</span>,</span><br><span class="line">            <span class="string">&quot;code&quot;</span>: <span class="number">500</span></span><br><span class="line">        &#125;), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@chat_bp.route(<span class="params"><span class="string">&#x27;/analyze/&lt;session_id&gt;&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="meta">@async_handler</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">analyze_conversation</span>(<span class="params">session_id</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åˆ†æå¯¹è¯è´¨é‡&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> DBSession.session_scope() <span class="keyword">as</span> session:</span><br><span class="line">            <span class="comment"># éªŒè¯ä¼šè¯æ‰€æœ‰æƒ</span></span><br><span class="line">            chat_session = session.query(ChatSession).filter_by(</span><br><span class="line">                <span class="built_in">id</span>=session_id,</span><br><span class="line">                user_id=current_user.<span class="built_in">id</span></span><br><span class="line">            ).first()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> chat_session:</span><br><span class="line">                <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                    <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                    <span class="string">&quot;error&quot;</span>: <span class="string">&quot;ä¼šè¯ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;code&quot;</span>: <span class="number">404</span></span><br><span class="line">                &#125;), <span class="number">404</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># åˆ†æå¯¹è¯</span></span><br><span class="line">            analysis = <span class="keyword">await</span> chatbot.analyze_conversation(session_id)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&quot;data&quot;</span>: analysis</span><br><span class="line">            &#125;)</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Error analyzing conversation: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&quot;error&quot;</span>: <span class="string">&quot;åˆ†æå¯¹è¯å¤±è´¥&quot;</span>,</span><br><span class="line">            <span class="string">&quot;code&quot;</span>: <span class="number">500</span></span><br><span class="line">        &#125;), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@chat_bp.route(<span class="params"><span class="string">&#x27;/feedback&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="meta">@async_handler</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">submit_feedback</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æäº¤åé¦ˆ</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Request JSON:</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;message_id&quot;: &quot;æ¶ˆæ¯ID&quot;,</span></span><br><span class="line"><span class="string">        &quot;rating&quot;: 5,  # 1-5</span></span><br><span class="line"><span class="string">        &quot;feedback_type&quot;: &quot;helpful&quot;,  # å¯é€‰</span></span><br><span class="line"><span class="string">        &quot;comment&quot;: &quot;åé¦ˆå†…å®¹&quot;  # å¯é€‰</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = request.get_json()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data <span class="keyword">or</span> <span class="string">&#x27;message_id&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> data <span class="keyword">or</span> <span class="string">&#x27;rating&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                <span class="string">&quot;error&quot;</span>: <span class="string">&quot;ç¼ºå°‘å¿…è¦å‚æ•°&quot;</span>,</span><br><span class="line">                <span class="string">&quot;code&quot;</span>: <span class="number">400</span></span><br><span class="line">            &#125;), <span class="number">400</span></span><br><span class="line">        </span><br><span class="line">        rating = data.get(<span class="string">&#x27;rating&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(rating, <span class="built_in">int</span>) <span class="keyword">or</span> rating &lt; <span class="number">1</span> <span class="keyword">or</span> rating &gt; <span class="number">5</span>:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                <span class="string">&quot;error&quot;</span>: <span class="string">&quot;è¯„åˆ†å¿…é¡»æ˜¯1-5çš„æ•´æ•°&quot;</span>,</span><br><span class="line">                <span class="string">&quot;code&quot;</span>: <span class="number">400</span></span><br><span class="line">            &#125;), <span class="number">400</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> DBSession.session_scope() <span class="keyword">as</span> session:</span><br><span class="line">            <span class="comment"># éªŒè¯æ¶ˆæ¯æ‰€æœ‰æƒ</span></span><br><span class="line">            message = session.query(ChatMessage).filter_by(</span><br><span class="line">                <span class="built_in">id</span>=data[<span class="string">&#x27;message_id&#x27;</span>]</span><br><span class="line">            ).first()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> message:</span><br><span class="line">                <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                    <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                    <span class="string">&quot;error&quot;</span>: <span class="string">&quot;æ¶ˆæ¯ä¸å­˜åœ¨&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;code&quot;</span>: <span class="number">404</span></span><br><span class="line">                &#125;), <span class="number">404</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ£€æŸ¥ä¼šè¯æ‰€æœ‰æƒ</span></span><br><span class="line">            chat_session = session.query(ChatSession).filter_by(</span><br><span class="line">                <span class="built_in">id</span>=message.session_id,</span><br><span class="line">                user_id=current_user.<span class="built_in">id</span></span><br><span class="line">            ).first()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> chat_session:</span><br><span class="line">                <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                    <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                    <span class="string">&quot;error&quot;</span>: <span class="string">&quot;æ— æƒé™è®¿é—®æ­¤æ¶ˆæ¯&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;code&quot;</span>: <span class="number">403</span></span><br><span class="line">                &#125;), <span class="number">403</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># åˆ›å»ºåé¦ˆ</span></span><br><span class="line">            <span class="keyword">from</span> app.database.models <span class="keyword">import</span> UserFeedback</span><br><span class="line">            </span><br><span class="line">            feedback = UserFeedback(</span><br><span class="line">                user_id=current_user.<span class="built_in">id</span>,</span><br><span class="line">                message_id=data[<span class="string">&#x27;message_id&#x27;</span>],</span><br><span class="line">                rating=rating,</span><br><span class="line">                feedback_type=data.get(<span class="string">&#x27;feedback_type&#x27;</span>),</span><br><span class="line">                comment=data.get(<span class="string">&#x27;comment&#x27;</span>)</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            session.add(feedback)</span><br><span class="line">            session.commit()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&quot;message&quot;</span>: <span class="string">&quot;åé¦ˆæäº¤æˆåŠŸ&quot;</span></span><br><span class="line">            &#125;)</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Error submitting feedback: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&quot;error&quot;</span>: <span class="string">&quot;æäº¤åé¦ˆå¤±è´¥&quot;</span>,</span><br><span class="line">            <span class="string">&quot;code&quot;</span>: <span class="number">500</span></span><br><span class="line">        &#125;), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@chat_bp.route(<span class="params"><span class="string">&#x27;/stream&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stream_chat</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    SSEèŠå¤©æµæ¥å£</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    é€šè¿‡Server-Sent Eventså®ç°æµå¼å“åº”</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">from</span> flask <span class="keyword">import</span> Response, stream_with_context</span><br><span class="line">    <span class="keyword">import</span> json</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate</span>():</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ç”Ÿæˆæµå¼å“åº”&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># è·å–æŸ¥è¯¢å‚æ•°</span></span><br><span class="line">            session_id = request.args.get(<span class="string">&#x27;session_id&#x27;</span>)</span><br><span class="line">            message = request.args.get(<span class="string">&#x27;message&#x27;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> message:</span><br><span class="line">                <span class="keyword">yield</span> <span class="string">f&quot;data: <span class="subst">&#123;json.dumps(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;ç¼ºå°‘æ¶ˆæ¯å‚æ•°&#x27;</span>&#125;</span>)&#125;\n\n&quot;</span></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ¨¡æ‹Ÿæµå¼å“åº”</span></span><br><span class="line">            words = message.split()</span><br><span class="line">            response_text = <span class="string">f&quot;æˆ‘æ”¶åˆ°äº†ä½ çš„æ¶ˆæ¯: &#x27;<span class="subst">&#123;message&#125;</span>&#x27;. &quot;</span></span><br><span class="line">            response_text += <span class="string">&quot;è®©æˆ‘ä¸ºä½ åˆ†æä¸€ä¸‹...&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># å‘é€åˆå§‹å“åº”</span></span><br><span class="line">            <span class="keyword">yield</span> <span class="string">f&quot;data: <span class="subst">&#123;json.dumps(&#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;start&#x27;</span>&#125;</span>)&#125;\n\n&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># é€è¯å‘é€ï¼ˆæ¨¡æ‹Ÿæµå¼ï¼‰</span></span><br><span class="line">            <span class="keyword">for</span> i, word <span class="keyword">in</span> <span class="built_in">enumerate</span>(words):</span><br><span class="line">                <span class="keyword">yield</span> <span class="string">f&quot;data: <span class="subst">&#123;json.dumps(&#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;chunk&#x27;</span>, <span class="string">&#x27;content&#x27;</span>: word + <span class="string">&#x27; &#x27;</span>&#125;</span>)&#125;\n\n&quot;</span></span><br><span class="line">                <span class="keyword">import</span> time</span><br><span class="line">                time.sleep(<span class="number">0.1</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># å‘é€å®Œæ•´å“åº”</span></span><br><span class="line">            <span class="keyword">yield</span> <span class="string">f&quot;data: <span class="subst">&#123;json.dumps(&#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;complete&#x27;</span>, <span class="string">&#x27;content&#x27;</span>: response_text&#125;</span>)&#125;\n\n&quot;</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Error in stream: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">yield</span> <span class="string">f&quot;data: <span class="subst">&#123;json.dumps(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="built_in">str</span>(e)&#125;</span>)&#125;\n\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> Response(</span><br><span class="line">        stream_with_context(generate()),</span><br><span class="line">        mimetype=<span class="string">&#x27;text/event-stream&#x27;</span>,</span><br><span class="line">        headers=&#123;</span><br><span class="line">            <span class="string">&#x27;Cache-Control&#x27;</span>: <span class="string">&#x27;no-cache&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;X-Accel-Buffering&#x27;</span>: <span class="string">&#x27;no&#x27;</span>  <span class="comment"># ç¦ç”¨Nginxç¼“å†²</span></span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>



<p><strong>app&#x2F;api&#x2F;auth.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint, request, jsonify, current_app</span><br><span class="line"><span class="keyword">from</span> flask_login <span class="keyword">import</span> login_user, logout_user, current_user, login_required</span><br><span class="line"><span class="keyword">from</span> flask_limiter <span class="keyword">import</span> Limiter</span><br><span class="line"><span class="keyword">from</span> flask_limiter.util <span class="keyword">import</span> get_remote_address</span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> werkzeug.security <span class="keyword">import</span> generate_password_hash, check_password_hash</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> app.database.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> app.database.session <span class="keyword">import</span> DBSession</span><br><span class="line"><span class="keyword">from</span> app.utils.validators <span class="keyword">import</span> validate_user_registration</span><br><span class="line"><span class="keyword">from</span> app.utils.decorators <span class="keyword">import</span> token_required</span><br><span class="line"></span><br><span class="line">auth_bp = Blueprint(<span class="string">&#x27;auth&#x27;</span>, __name__)</span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€Ÿç‡é™åˆ¶å™¨</span></span><br><span class="line">limiter = Limiter(</span><br><span class="line">    key_func=get_remote_address,</span><br><span class="line">    default_limits=[<span class="string">&quot;100 per day&quot;</span>, <span class="string">&quot;20 per hour&quot;</span>]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="meta">@auth_bp.route(<span class="params"><span class="string">&#x27;/register&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@limiter.limit(<span class="params"><span class="string">&quot;5 per minute&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ç”¨æˆ·æ³¨å†Œ</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Request JSON:</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;username&quot;: &quot;ç”¨æˆ·å&quot;,</span></span><br><span class="line"><span class="string">        &quot;email&quot;: &quot;é‚®ç®±&quot;,</span></span><br><span class="line"><span class="string">        &quot;password&quot;: &quot;å¯†ç &quot;,</span></span><br><span class="line"><span class="string">        &quot;confirm_password&quot;: &quot;ç¡®è®¤å¯†ç &quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Response JSON:</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;success&quot;: true,</span></span><br><span class="line"><span class="string">        &quot;message&quot;: &quot;æ³¨å†ŒæˆåŠŸ&quot;,</span></span><br><span class="line"><span class="string">        &quot;data&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;user_id&quot;: 1,</span></span><br><span class="line"><span class="string">            &quot;username&quot;: &quot;ç”¨æˆ·å&quot;,</span></span><br><span class="line"><span class="string">            &quot;email&quot;: &quot;é‚®ç®±&quot;,</span></span><br><span class="line"><span class="string">            &quot;token&quot;: &quot;JWTä»¤ç‰Œ&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = request.get_json()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># éªŒè¯è¯·æ±‚æ•°æ®</span></span><br><span class="line">        validation_result = validate_user_registration(data)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> validation_result[<span class="string">&quot;valid&quot;</span>]:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                <span class="string">&quot;error&quot;</span>: validation_result[<span class="string">&quot;errors&quot;</span>][<span class="number">0</span>],</span><br><span class="line">                <span class="string">&quot;code&quot;</span>: <span class="number">400</span></span><br><span class="line">            &#125;), <span class="number">400</span></span><br><span class="line">        </span><br><span class="line">        username = data[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">        email = data[<span class="string">&#x27;email&#x27;</span>]</span><br><span class="line">        password = data[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> DBSession.session_scope() <span class="keyword">as</span> session:</span><br><span class="line">            <span class="comment"># æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨</span></span><br><span class="line">            existing_user = session.query(User).filter_by(username=username).first()</span><br><span class="line">            <span class="keyword">if</span> existing_user:</span><br><span class="line">                <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                    <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                    <span class="string">&quot;error&quot;</span>: <span class="string">&quot;ç”¨æˆ·åå·²å­˜åœ¨&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;code&quot;</span>: <span class="number">400</span></span><br><span class="line">                &#125;), <span class="number">400</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨</span></span><br><span class="line">            existing_email = session.query(User).filter_by(email=email).first()</span><br><span class="line">            <span class="keyword">if</span> existing_email:</span><br><span class="line">                <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                    <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                    <span class="string">&quot;error&quot;</span>: <span class="string">&quot;é‚®ç®±å·²æ³¨å†Œ&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;code&quot;</span>: <span class="number">400</span></span><br><span class="line">                &#125;), <span class="number">400</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># åˆ›å»ºæ–°ç”¨æˆ·</span></span><br><span class="line">            new_user = User(</span><br><span class="line">                username=username,</span><br><span class="line">                email=email,</span><br><span class="line">                password=password  <span class="comment"># ä¼šè‡ªåŠ¨è°ƒç”¨password setterè¿›è¡Œå“ˆå¸Œ</span></span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            session.add(new_user)</span><br><span class="line">            session.flush()  <span class="comment"># è·å–ç”¨æˆ·ID</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># ç”ŸæˆJWTä»¤ç‰Œ</span></span><br><span class="line">            token = generate_token(new_user.<span class="built_in">id</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è®°å½•æ—¥å¿—</span></span><br><span class="line">            logger.info(<span class="string">f&quot;New user registered: <span class="subst">&#123;username&#125;</span> (<span class="subst">&#123;email&#125;</span>)&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&quot;message&quot;</span>: <span class="string">&quot;æ³¨å†ŒæˆåŠŸ&quot;</span>,</span><br><span class="line">                <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;user_id&quot;</span>: new_user.<span class="built_in">id</span>,</span><br><span class="line">                    <span class="string">&quot;username&quot;</span>: new_user.username,</span><br><span class="line">                    <span class="string">&quot;email&quot;</span>: new_user.email,</span><br><span class="line">                    <span class="string">&quot;token&quot;</span>: token,</span><br><span class="line">                    <span class="string">&quot;is_admin&quot;</span>: new_user.is_admin</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Error in register: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&quot;error&quot;</span>: <span class="string">&quot;æ³¨å†Œå¤±è´¥&quot;</span>,</span><br><span class="line">            <span class="string">&quot;code&quot;</span>: <span class="number">500</span>,</span><br><span class="line">            <span class="string">&quot;details&quot;</span>: <span class="built_in">str</span>(e) <span class="keyword">if</span> current_app.config[<span class="string">&#x27;DEBUG&#x27;</span>] <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        &#125;), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@auth_bp.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@limiter.limit(<span class="params"><span class="string">&quot;10 per minute&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ç”¨æˆ·ç™»å½•</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Request JSON:</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;username&quot;: &quot;ç”¨æˆ·åæˆ–é‚®ç®±&quot;,</span></span><br><span class="line"><span class="string">        &quot;password&quot;: &quot;å¯†ç &quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Response JSON:</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;success&quot;: true,</span></span><br><span class="line"><span class="string">        &quot;message&quot;: &quot;ç™»å½•æˆåŠŸ&quot;,</span></span><br><span class="line"><span class="string">        &quot;data&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;user_id&quot;: 1,</span></span><br><span class="line"><span class="string">            &quot;username&quot;: &quot;ç”¨æˆ·å&quot;,</span></span><br><span class="line"><span class="string">            &quot;email&quot;: &quot;é‚®ç®±&quot;,</span></span><br><span class="line"><span class="string">            &quot;token&quot;: &quot;JWTä»¤ç‰Œ&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = request.get_json()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data <span class="keyword">or</span> <span class="string">&#x27;username&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> data <span class="keyword">or</span> <span class="string">&#x27;password&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                <span class="string">&quot;error&quot;</span>: <span class="string">&quot;è¯·è¾“å…¥ç”¨æˆ·å/é‚®ç®±å’Œå¯†ç &quot;</span>,</span><br><span class="line">                <span class="string">&quot;code&quot;</span>: <span class="number">400</span></span><br><span class="line">            &#125;), <span class="number">400</span></span><br><span class="line">        </span><br><span class="line">        username_or_email = data[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">        password = data[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> DBSession.session_scope() <span class="keyword">as</span> session:</span><br><span class="line">            <span class="comment"># å°è¯•é€šè¿‡ç”¨æˆ·åæˆ–é‚®ç®±æŸ¥æ‰¾ç”¨æˆ·</span></span><br><span class="line">            user = session.query(User).<span class="built_in">filter</span>(</span><br><span class="line">                (User.username == username_or_email) | </span><br><span class="line">                (User.email == username_or_email)</span><br><span class="line">            ).first()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">                <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                    <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                    <span class="string">&quot;error&quot;</span>: <span class="string">&quot;ç”¨æˆ·ä¸å­˜åœ¨&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;code&quot;</span>: <span class="number">404</span></span><br><span class="line">                &#125;), <span class="number">404</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> user.is_active:</span><br><span class="line">                <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                    <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                    <span class="string">&quot;error&quot;</span>: <span class="string">&quot;è´¦æˆ·å·²è¢«ç¦ç”¨&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;code&quot;</span>: <span class="number">403</span></span><br><span class="line">                &#125;), <span class="number">403</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># éªŒè¯å¯†ç </span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> user.verify_password(password):</span><br><span class="line">                <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                    <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                    <span class="string">&quot;error&quot;</span>: <span class="string">&quot;å¯†ç é”™è¯¯&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;code&quot;</span>: <span class="number">401</span></span><br><span class="line">                &#125;), <span class="number">401</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># ç™»å½•ç”¨æˆ·</span></span><br><span class="line">            login_user(user, remember=data.get(<span class="string">&#x27;remember&#x27;</span>, <span class="literal">False</span>))</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># ç”ŸæˆJWTä»¤ç‰Œ</span></span><br><span class="line">            token = generate_token(user.<span class="built_in">id</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è®°å½•æ—¥å¿—</span></span><br><span class="line">            logger.info(<span class="string">f&quot;User logged in: <span class="subst">&#123;user.username&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&quot;message&quot;</span>: <span class="string">&quot;ç™»å½•æˆåŠŸ&quot;</span>,</span><br><span class="line">                <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;user_id&quot;</span>: user.<span class="built_in">id</span>,</span><br><span class="line">                    <span class="string">&quot;username&quot;</span>: user.username,</span><br><span class="line">                    <span class="string">&quot;email&quot;</span>: user.email,</span><br><span class="line">                    <span class="string">&quot;token&quot;</span>: token,</span><br><span class="line">                    <span class="string">&quot;is_admin&quot;</span>: user.is_admin</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Error in login: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&quot;error&quot;</span>: <span class="string">&quot;ç™»å½•å¤±è´¥&quot;</span>,</span><br><span class="line">            <span class="string">&quot;code&quot;</span>: <span class="number">500</span></span><br><span class="line">        &#125;), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@auth_bp.route(<span class="params"><span class="string">&#x27;/logout&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ç”¨æˆ·ç™»å‡º&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        logout_user()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&quot;message&quot;</span>: <span class="string">&quot;ç™»å‡ºæˆåŠŸ&quot;</span></span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Error in logout: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&quot;error&quot;</span>: <span class="string">&quot;ç™»å‡ºå¤±è´¥&quot;</span>,</span><br><span class="line">            <span class="string">&quot;code&quot;</span>: <span class="number">500</span></span><br><span class="line">        &#125;), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@auth_bp.route(<span class="params"><span class="string">&#x27;/me&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@token_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_current_user</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;user&quot;</span>: current_user.to_dict() <span class="keyword">if</span> current_user <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Error getting current user: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&quot;error&quot;</span>: <span class="string">&quot;è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥&quot;</span>,</span><br><span class="line">            <span class="string">&quot;code&quot;</span>: <span class="number">500</span></span><br><span class="line">        &#125;), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@auth_bp.route(<span class="params"><span class="string">&#x27;/refresh-token&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@token_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">refresh_token</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åˆ·æ–°JWTä»¤ç‰Œ&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># ç”Ÿæˆæ–°çš„ä»¤ç‰Œ</span></span><br><span class="line">        token = generate_token(current_user.<span class="built_in">id</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;token&quot;</span>: token,</span><br><span class="line">                <span class="string">&quot;expires_in&quot;</span>: current_app.config[<span class="string">&#x27;JWT_ACCESS_TOKEN_EXPIRES&#x27;</span>].total_seconds()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Error refreshing token: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&quot;error&quot;</span>: <span class="string">&quot;åˆ·æ–°ä»¤ç‰Œå¤±è´¥&quot;</span>,</span><br><span class="line">            <span class="string">&quot;code&quot;</span>: <span class="number">500</span></span><br><span class="line">        &#125;), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@auth_bp.route(<span class="params"><span class="string">&#x27;/change-password&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change_password</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä¿®æ”¹å¯†ç &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = request.get_json()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data <span class="keyword">or</span> <span class="string">&#x27;current_password&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> data <span class="keyword">or</span> <span class="string">&#x27;new_password&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                <span class="string">&quot;error&quot;</span>: <span class="string">&quot;è¯·è¾“å…¥å½“å‰å¯†ç å’Œæ–°å¯†ç &quot;</span>,</span><br><span class="line">                <span class="string">&quot;code&quot;</span>: <span class="number">400</span></span><br><span class="line">            &#125;), <span class="number">400</span></span><br><span class="line">        </span><br><span class="line">        current_password = data[<span class="string">&#x27;current_password&#x27;</span>]</span><br><span class="line">        new_password = data[<span class="string">&#x27;new_password&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># éªŒè¯å½“å‰å¯†ç </span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> current_user.verify_password(current_password):</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">                <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                <span class="string">&quot;error&quot;</span>: <span class="string">&quot;å½“å‰å¯†ç é”™è¯¯&quot;</span>,</span><br><span class="line">                <span class="string">&quot;code&quot;</span>: <span class="number">401</span></span><br><span class="line">            &#125;), <span class="number">401</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ›´æ–°å¯†ç </span></span><br><span class="line">        <span class="keyword">with</span> DBSession.session_scope() <span class="keyword">as</span> session:</span><br><span class="line">            user = session.query(User).get(current_user.<span class="built_in">id</span>)</span><br><span class="line">            user.password = new_password</span><br><span class="line">            session.commit()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®°å½•æ—¥å¿—</span></span><br><span class="line">        logger.info(<span class="string">f&quot;User changed password: <span class="subst">&#123;current_user.username&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&quot;message&quot;</span>: <span class="string">&quot;å¯†ç ä¿®æ”¹æˆåŠŸ&quot;</span></span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Error changing password: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&quot;error&quot;</span>: <span class="string">&quot;ä¿®æ”¹å¯†ç å¤±è´¥&quot;</span>,</span><br><span class="line">            <span class="string">&quot;code&quot;</span>: <span class="number">500</span></span><br><span class="line">        &#125;), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_token</span>(<span class="params">user_id</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ç”ŸæˆJWTä»¤ç‰Œ&quot;&quot;&quot;</span></span><br><span class="line">    payload = &#123;</span><br><span class="line">        <span class="string">&#x27;user_id&#x27;</span>: user_id,</span><br><span class="line">        <span class="string">&#x27;exp&#x27;</span>: datetime.datetime.utcnow() + current_app.config[<span class="string">&#x27;JWT_ACCESS_TOKEN_EXPIRES&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;iat&#x27;</span>: datetime.datetime.utcnow()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> jwt.encode(</span><br><span class="line">        payload,</span><br><span class="line">        current_app.config[<span class="string">&#x27;JWT_SECRET_KEY&#x27;</span>],</span><br><span class="line">        algorithm=<span class="string">&#x27;HS256&#x27;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify_token</span>(<span class="params">token</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;éªŒè¯JWTä»¤ç‰Œ&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        payload = jwt.decode(</span><br><span class="line">            token,</span><br><span class="line">            current_app.config[<span class="string">&#x27;JWT_SECRET_KEY&#x27;</span>],</span><br><span class="line">            algorithms=[<span class="string">&#x27;HS256&#x27;</span>]</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> payload</span><br><span class="line">    <span class="keyword">except</span> jwt.ExpiredSignatureError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>  <span class="comment"># ä»¤ç‰Œè¿‡æœŸ</span></span><br><span class="line">    <span class="keyword">except</span> jwt.InvalidTokenError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>  <span class="comment"># æ— æ•ˆä»¤ç‰Œ</span></span><br></pre></td></tr></table></figure>



<h2 id="ç¬¬6æ­¥ï¼šæœåŠ¡å±‚å®ç°"><a href="#ç¬¬6æ­¥ï¼šæœåŠ¡å±‚å®ç°" class="headerlink" title="ç¬¬6æ­¥ï¼šæœåŠ¡å±‚å®ç°"></a>ç¬¬6æ­¥ï¼šæœåŠ¡å±‚å®ç°</h2><p><strong>app&#x2F;services&#x2F;ai_service.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Optional</span>, <span class="type">Any</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> openai</span><br><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> pipeline</span><br><span class="line"><span class="keyword">from</span> sentence_transformers <span class="keyword">import</span> SentenceTransformer</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AIService</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;AIæœåŠ¡å°è£…&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–OpenAIå®¢æˆ·ç«¯</span></span><br><span class="line">        self.openai_api_key = os.getenv(<span class="string">&#x27;OPENAI_API_KEY&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> self.openai_api_key:</span><br><span class="line">            openai.api_key = self.openai_api_key</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–æœ¬åœ°æ¨¡å‹</span></span><br><span class="line">        self.local_models = &#123;&#125;</span><br><span class="line">        self.init_local_models()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># é…ç½®</span></span><br><span class="line">        self.config = &#123;</span><br><span class="line">            <span class="string">&quot;openai&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;model&quot;</span>: os.getenv(<span class="string">&#x27;AI_MODEL_NAME&#x27;</span>, <span class="string">&#x27;gpt-3.5-turbo&#x27;</span>),</span><br><span class="line">                <span class="string">&quot;temperature&quot;</span>: <span class="number">0.7</span>,</span><br><span class="line">                <span class="string">&quot;max_tokens&quot;</span>: <span class="number">1000</span>,</span><br><span class="line">                <span class="string">&quot;timeout&quot;</span>: <span class="number">30</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;fallback_model&quot;</span>: <span class="string">&quot;local&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å¯¹è¯å†å²ç¼“å­˜</span></span><br><span class="line">        self.conversation_cache = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">&quot;AIService initialized&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init_local_models</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆå§‹åŒ–æœ¬åœ°æ¨¡å‹&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># æƒ…æ„Ÿåˆ†ææ¨¡å‹</span></span><br><span class="line">            self.local_models[<span class="string">&#x27;sentiment&#x27;</span>] = pipeline(</span><br><span class="line">                <span class="string">&#x27;sentiment-analysis&#x27;</span>,</span><br><span class="line">                model=<span class="string">&#x27;uer/roberta-base-finetuned-dianping-chinese&#x27;</span></span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ–‡æœ¬ç”Ÿæˆæ¨¡å‹ï¼ˆå°å‹ï¼‰</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.local_models[<span class="string">&#x27;text_generation&#x27;</span>] = pipeline(</span><br><span class="line">                    <span class="string">&#x27;text-generation&#x27;</span>,</span><br><span class="line">                    model=<span class="string">&#x27;gpt2&#x27;</span></span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                logger.warning(<span class="string">&quot;Text generation model not available&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># å¥å­åµŒå…¥æ¨¡å‹</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.local_models[<span class="string">&#x27;embedding&#x27;</span>] = SentenceTransformer(</span><br><span class="line">                    <span class="string">&#x27;paraphrase-multilingual-MiniLM-L12-v2&#x27;</span></span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                logger.warning(<span class="string">&quot;Embedding model not available&quot;</span>)</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Error initializing local models: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">generate_response</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                               message: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                               history: <span class="type">Optional</span>[<span class="type">List</span>[<span class="type">Dict</span>]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                               context: <span class="type">Optional</span>[<span class="type">Dict</span>] = <span class="literal">None</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        ç”ŸæˆAIå›å¤</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            message: ç”¨æˆ·æ¶ˆæ¯</span></span><br><span class="line"><span class="string">            history: å¯¹è¯å†å²</span></span><br><span class="line"><span class="string">            context: ä¸Šä¸‹æ–‡ä¿¡æ¯</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Dict: åŒ…å«å›å¤å’Œå…ƒæ•°æ®</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># é¦–å…ˆå°è¯•OpenAI</span></span><br><span class="line">            <span class="keyword">if</span> self.openai_api_key:</span><br><span class="line">                response = <span class="keyword">await</span> self._call_openai(message, history, context)</span><br><span class="line">                <span class="keyword">if</span> response:</span><br><span class="line">                    <span class="keyword">return</span> response</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># å›é€€åˆ°æœ¬åœ°æ¨¡å‹</span></span><br><span class="line">            response = <span class="keyword">await</span> self._call_local_model(message, history, context)</span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Error generating response: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> self._generate_fallback_response(message)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_call_openai</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                          message: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                          history: <span class="type">Optional</span>[<span class="type">List</span>[<span class="type">Dict</span>]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                          context: <span class="type">Optional</span>[<span class="type">Dict</span>] = <span class="literal">None</span></span>) -&gt; <span class="type">Optional</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è°ƒç”¨OpenAI API&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># æ„å»ºæ¶ˆæ¯åˆ—è¡¨</span></span><br><span class="line">            messages = []</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># ç³»ç»Ÿæç¤º</span></span><br><span class="line">            system_prompt = self._build_system_prompt(context)</span><br><span class="line">            messages.append(&#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, <span class="string">&quot;content&quot;</span>: system_prompt&#125;)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># å¯¹è¯å†å²</span></span><br><span class="line">            <span class="keyword">if</span> history:</span><br><span class="line">                <span class="keyword">for</span> msg <span class="keyword">in</span> history[-<span class="number">10</span>:]:  <span class="comment"># é™åˆ¶å†å²é•¿åº¦</span></span><br><span class="line">                    messages.append(&#123;</span><br><span class="line">                        <span class="string">&quot;role&quot;</span>: msg.get(<span class="string">&quot;role&quot;</span>, <span class="string">&quot;user&quot;</span>),</span><br><span class="line">                        <span class="string">&quot;content&quot;</span>: msg.get(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">                    &#125;)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># å½“å‰æ¶ˆæ¯</span></span><br><span class="line">            messages.append(&#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: message&#125;)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è°ƒç”¨API</span></span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">                <span class="keyword">async</span> <span class="keyword">with</span> session.post(</span><br><span class="line">                    <span class="string">&quot;https://api.openai.com/v1/chat/completions&quot;</span>,</span><br><span class="line">                    headers=&#123;</span><br><span class="line">                        <span class="string">&quot;Authorization&quot;</span>: <span class="string">f&quot;Bearer <span class="subst">&#123;self.openai_api_key&#125;</span>&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    json=&#123;</span><br><span class="line">                        <span class="string">&quot;model&quot;</span>: self.config[<span class="string">&quot;openai&quot;</span>][<span class="string">&quot;model&quot;</span>],</span><br><span class="line">                        <span class="string">&quot;messages&quot;</span>: messages,</span><br><span class="line">                        <span class="string">&quot;temperature&quot;</span>: self.config[<span class="string">&quot;openai&quot;</span>][<span class="string">&quot;temperature&quot;</span>],</span><br><span class="line">                        <span class="string">&quot;max_tokens&quot;</span>: self.config[<span class="string">&quot;openai&quot;</span>][<span class="string">&quot;max_tokens&quot;</span>]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    timeout=self.config[<span class="string">&quot;openai&quot;</span>][<span class="string">&quot;timeout&quot;</span>]</span><br><span class="line">                ) <span class="keyword">as</span> response:</span><br><span class="line">                    <span class="keyword">if</span> response.status == <span class="number">200</span>:</span><br><span class="line">                        data = <span class="keyword">await</span> response.json()</span><br><span class="line">                        </span><br><span class="line">                        content = data[<span class="string">&quot;choices&quot;</span>][<span class="number">0</span>][<span class="string">&quot;message&quot;</span>][<span class="string">&quot;content&quot;</span>]</span><br><span class="line">                        tokens_used = data.get(<span class="string">&quot;usage&quot;</span>, &#123;&#125;).get(<span class="string">&quot;total_tokens&quot;</span>, <span class="number">0</span>)</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">return</span> &#123;</span><br><span class="line">                            <span class="string">&quot;content&quot;</span>: content.strip(),</span><br><span class="line">                            <span class="string">&quot;tokens_used&quot;</span>: tokens_used,</span><br><span class="line">                            <span class="string">&quot;model&quot;</span>: self.config[<span class="string">&quot;openai&quot;</span>][<span class="string">&quot;model&quot;</span>],</span><br><span class="line">                            <span class="string">&quot;finish_reason&quot;</span>: data[<span class="string">&quot;choices&quot;</span>][<span class="number">0</span>].get(<span class="string">&quot;finish_reason&quot;</span>)</span><br><span class="line">                        &#125;</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        error_text = <span class="keyword">await</span> response.text()</span><br><span class="line">                        logger.error(<span class="string">f&quot;OpenAI API error: <span class="subst">&#123;response.status&#125;</span> - <span class="subst">&#123;error_text&#125;</span>&quot;</span>)</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">                        </span><br><span class="line">        <span class="keyword">except</span> asyncio.TimeoutError:</span><br><span class="line">            logger.warning(<span class="string">&quot;OpenAI API timeout&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Error calling OpenAI: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_call_local_model</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                               message: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                               history: <span class="type">Optional</span>[<span class="type">List</span>[<span class="type">Dict</span>]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                               context: <span class="type">Optional</span>[<span class="type">Dict</span>] = <span class="literal">None</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è°ƒç”¨æœ¬åœ°æ¨¡å‹&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ç®€å•çš„åŸºäºè§„åˆ™çš„å›å¤ï¼ˆå®é™…é¡¹ç›®ä¸­åº”è¯¥ä½¿ç”¨æ›´å¥½çš„æœ¬åœ°æ¨¡å‹ï¼‰</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åˆ†ææ¶ˆæ¯ç±»å‹</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">any</span>(keyword <span class="keyword">in</span> message.lower() <span class="keyword">for</span> keyword <span class="keyword">in</span> [<span class="string">&quot;ä½ å¥½&quot;</span>, <span class="string">&quot;å—¨&quot;</span>, <span class="string">&quot;hello&quot;</span>, <span class="string">&quot;hi&quot;</span>]):</span><br><span class="line">            response = <span class="string">&quot;ä½ å¥½ï¼æˆ‘æ˜¯æœ¬åœ°AIåŠ©æ‰‹ã€‚&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&quot;?&quot;</span> <span class="keyword">in</span> message <span class="keyword">or</span> <span class="string">&quot;ï¼Ÿ&quot;</span> <span class="keyword">in</span> message:</span><br><span class="line">            response = <span class="string">&quot;è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ã€‚æˆ‘çš„çŸ¥è¯†æœ‰é™ï¼Œå»ºè®®ä½ æŸ¥é˜…ç›¸å…³èµ„æ–™æˆ–ä½¿ç”¨åœ¨çº¿æœç´¢å¼•æ“è·å–æ›´å‡†ç¡®çš„ç­”æ¡ˆã€‚&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">any</span>(keyword <span class="keyword">in</span> message.lower() <span class="keyword">for</span> keyword <span class="keyword">in</span> [<span class="string">&quot;è°¢è°¢&quot;</span>, <span class="string">&quot;æ„Ÿè°¢&quot;</span>]):</span><br><span class="line">            response = <span class="string">&quot;ä¸ç”¨å®¢æ°”ï¼å¾ˆé«˜å…´èƒ½å¸®åˆ°ä½ ã€‚&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">any</span>(keyword <span class="keyword">in</span> message.lower() <span class="keyword">for</span> keyword <span class="keyword">in</span> [<span class="string">&quot;å†è§&quot;</span>, <span class="string">&quot;æ‹œæ‹œ&quot;</span>]):</span><br><span class="line">            response = <span class="string">&quot;å†è§ï¼æœŸå¾…ä¸‹æ¬¡èŠå¤©ã€‚&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            response = <span class="string">&quot;æˆ‘æ”¶åˆ°äº†ä½ çš„æ¶ˆæ¯ã€‚ä½œä¸ºæœ¬åœ°AIåŠ©æ‰‹ï¼Œæˆ‘çš„èƒ½åŠ›æœ‰é™ï¼Œä½†æˆ‘ä¼šå°½åŠ›å¸®åŠ©ä½ ã€‚&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: response,</span><br><span class="line">            <span class="string">&quot;tokens_used&quot;</span>: <span class="built_in">len</span>(response.split()),</span><br><span class="line">            <span class="string">&quot;model&quot;</span>: <span class="string">&quot;local_rule_based&quot;</span>,</span><br><span class="line">            <span class="string">&quot;finish_reason&quot;</span>: <span class="string">&quot;stop&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_build_system_prompt</span>(<span class="params">self, context: <span class="type">Optional</span>[<span class="type">Dict</span>] = <span class="literal">None</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ„å»ºç³»ç»Ÿæç¤º&quot;&quot;&quot;</span></span><br><span class="line">        prompt = <span class="string">&quot;&quot;&quot;ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</span></span><br><span class="line"><span class="string">1. å‹å¥½ã€ä¸“ä¸šã€ä¹äºåŠ©äºº</span></span><br><span class="line"><span class="string">2. å°½å¯èƒ½æä¾›å‡†ç¡®ã€æœ‰ç”¨çš„ä¿¡æ¯</span></span><br><span class="line"><span class="string">3. å¦‚æœä¸çŸ¥é“ç­”æ¡ˆï¼Œè¯šå®åœ°è¯´æ˜</span></span><br><span class="line"><span class="string">4. ä¿æŒå¯¹è¯çš„è‡ªç„¶å’Œæµç•…&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> context:</span><br><span class="line">            <span class="comment"># æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;user_name&quot;</span> <span class="keyword">in</span> context:</span><br><span class="line">                prompt += <span class="string">f&quot;\nç”¨æˆ·å§“å: <span class="subst">&#123;context[<span class="string">&#x27;user_name&#x27;</span>]&#125;</span>&quot;</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;conversation_style&quot;</span> <span class="keyword">in</span> context:</span><br><span class="line">                prompt += <span class="string">f&quot;\nå¯¹è¯é£æ ¼: <span class="subst">&#123;context[<span class="string">&#x27;conversation_style&#x27;</span>]&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> prompt</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_generate_fallback_response</span>(<span class="params">self, message: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ç”Ÿæˆå›é€€å“åº”&quot;&quot;&quot;</span></span><br><span class="line">        fallback_responses = [</span><br><span class="line">            <span class="string">&quot;æˆ‘ç›®å‰æ— æ³•å¤„ç†è¿™ä¸ªè¯·æ±‚ï¼Œè¯·ç¨åå†è¯•ã€‚&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ç³»ç»Ÿæš‚æ—¶ä¸å¯ç”¨ï¼Œæˆ‘æ­£åœ¨åŠªåŠ›æ¢å¤æœåŠ¡ã€‚&quot;</span>,</span><br><span class="line">            <span class="string">&quot;æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨é‡åˆ°äº†ä¸€äº›æŠ€æœ¯é—®é¢˜ã€‚&quot;</span></span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">import</span> random</span><br><span class="line">        response = random.choice(fallback_responses)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: response,</span><br><span class="line">            <span class="string">&quot;tokens_used&quot;</span>: <span class="built_in">len</span>(response.split()),</span><br><span class="line">            <span class="string">&quot;model&quot;</span>: <span class="string">&quot;fallback&quot;</span>,</span><br><span class="line">            <span class="string">&quot;finish_reason&quot;</span>: <span class="string">&quot;error&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">generate_conversation</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                                   message: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                                   style: <span class="built_in">str</span> = <span class="string">&quot;friendly&quot;</span>,</span></span><br><span class="line"><span class="params">                                   personality: <span class="type">Optional</span>[<span class="type">Dict</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                                   history: <span class="type">Optional</span>[<span class="type">List</span>[<span class="type">Dict</span>]] = <span class="literal">None</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ç”Ÿæˆå¯¹è¯å›å¤&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># æ ¹æ®é£æ ¼è°ƒæ•´å›å¤</span></span><br><span class="line">        style_modifiers = &#123;</span><br><span class="line">            <span class="string">&quot;friendly&quot;</span>: <span class="string">&quot;ç”¨å‹å¥½ã€çƒ­æƒ…çš„è¯­æ°”å›å¤ã€‚&quot;</span>,</span><br><span class="line">            <span class="string">&quot;professional&quot;</span>: <span class="string">&quot;ç”¨ä¸“ä¸šã€æ­£å¼çš„è¯­æ°”å›å¤ã€‚&quot;</span>,</span><br><span class="line">            <span class="string">&quot;humorous&quot;</span>: <span class="string">&quot;ç”¨å¹½é»˜ã€è½»æ¾çš„è¯­æ°”å›å¤ï¼Œå¯ä»¥é€‚å½“åŠ å…¥ç¬‘è¯æˆ–ä¿çš®è¯ã€‚&quot;</span>,</span><br><span class="line">            <span class="string">&quot;empathetic&quot;</span>: <span class="string">&quot;ç”¨åŒç†å¿ƒå¼ºçš„è¯­æ°”å›å¤ï¼Œè¡¨è¾¾ç†è§£å’Œæ”¯æŒã€‚&quot;</span>,</span><br><span class="line">            <span class="string">&quot;enthusiastic&quot;</span>: <span class="string">&quot;ç”¨å……æ»¡çƒ­æƒ…ã€ç§¯æå‘ä¸Šçš„è¯­æ°”å›å¤ã€‚&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        style_prompt = style_modifiers.get(style, style_modifiers[<span class="string">&quot;friendly&quot;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ„å»ºå®Œæ•´çš„æç¤º</span></span><br><span class="line">        prompt = <span class="string">f&quot;<span class="subst">&#123;style_prompt&#125;</span>\nç”¨æˆ·è¯´ï¼š<span class="subst">&#123;message&#125;</span>\nè¯·ç”Ÿæˆä¸€ä¸ªåˆé€‚çš„å›å¤ï¼š&quot;</span></span><br><span class="line">        </span><br><span class="line">        response = <span class="keyword">await</span> self.generate_response(prompt, history)</span><br><span class="line">        <span class="keyword">return</span> response[<span class="string">&quot;content&quot;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">generate_opening</span>(<span class="params">self, topic: <span class="built_in">str</span>, style: <span class="built_in">str</span> = <span class="string">&quot;professional&quot;</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ç”Ÿæˆå¯¹è¯å¼€åœºç™½&quot;&quot;&quot;</span></span><br><span class="line">        opening_prompts = &#123;</span><br><span class="line">            <span class="string">&quot;professional&quot;</span>: <span class="string">f&quot;å…³äº<span class="subst">&#123;topic&#125;</span>ï¼Œæˆ‘å¾ˆä¹æ„å’Œä½ è®¨è®ºã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦ä¸”æœ‰è¶£çš„è¯é¢˜ã€‚&quot;</span>,</span><br><span class="line">            <span class="string">&quot;friendly&quot;</span>: <span class="string">f&quot;å—¨ï¼æˆ‘ä»¬æ¥èŠèŠ<span class="subst">&#123;topic&#125;</span>å§ï¼æˆ‘å¯¹è¿™ä¸ªè¯é¢˜å¾ˆæ„Ÿå…´è¶£å‘¢ã€‚&quot;</span>,</span><br><span class="line">            <span class="string">&quot;humorous&quot;</span>: <span class="string">f&quot;å“ˆå“ˆï¼Œ<span class="subst">&#123;topic&#125;</span>è¿™ä¸ªè¯é¢˜çœŸæœ‰æ„æ€ï¼è®©æˆ‘ä»¬å¼€å§‹æ„‰å¿«çš„èŠå¤©å§ï¼&quot;</span>,</span><br><span class="line">            <span class="string">&quot;educational&quot;</span>: <span class="string">f&quot;è®©æˆ‘ä»¬ä¸€èµ·æ¥æ¢ç´¢<span class="subst">&#123;topic&#125;</span>è¿™ä¸ªè¯é¢˜ã€‚æˆ‘ä¼šåˆ†äº«ä¸€äº›ç›¸å…³çš„çŸ¥è¯†å’Œè§è§£ã€‚&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> opening_prompts.get(style, opening_prompts[<span class="string">&quot;professional&quot;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">generate_user_message</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                                   topic: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                                   context: <span class="type">Optional</span>[<span class="type">Dict</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                                   history: <span class="type">Optional</span>[<span class="type">List</span>[<span class="type">Dict</span>]] = <span class="literal">None</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ç”Ÿæˆç”¨æˆ·æ¶ˆæ¯ï¼ˆç”¨äºå¯¹è¯ç”Ÿæˆï¼‰&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># åŸºäºä¸»é¢˜ç”Ÿæˆç›¸å…³é—®é¢˜æˆ–é™ˆè¿°</span></span><br><span class="line">        questions = [</span><br><span class="line">            <span class="string">f&quot;å…³äº<span class="subst">&#123;topic&#125;</span>ï¼Œä½ èƒ½å‘Šè¯‰æˆ‘ä»€ä¹ˆï¼Ÿ&quot;</span>,</span><br><span class="line">            <span class="string">f&quot;<span class="subst">&#123;topic&#125;</span>çš„ä¸»è¦ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ&quot;</span>,</span><br><span class="line">            <span class="string">f&quot;æˆ‘å¯¹<span class="subst">&#123;topic&#125;</span>å¾ˆæ„Ÿå…´è¶£ï¼Œä½ æœ‰ä»€ä¹ˆå»ºè®®å—ï¼Ÿ&quot;</span>,</span><br><span class="line">            <span class="string">f&quot;å¦‚ä½•å¼€å§‹å­¦ä¹ <span class="subst">&#123;topic&#125;</span>ï¼Ÿ&quot;</span>,</span><br><span class="line">            <span class="string">f&quot;<span class="subst">&#123;topic&#125;</span>åœ¨å®é™…ä¸­æœ‰ä»€ä¹ˆåº”ç”¨ï¼Ÿ&quot;</span></span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">import</span> random</span><br><span class="line">        <span class="keyword">return</span> random.choice(questions)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">analyze_sentiment</span>(<span class="params">self, text: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆ†ææ–‡æœ¬æƒ…æ„Ÿ&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;sentiment&#x27;</span> <span class="keyword">in</span> self.local_models:</span><br><span class="line">                result = self.local_models[<span class="string">&#x27;sentiment&#x27;</span>](text)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    <span class="string">&quot;sentiment&quot;</span>: result[<span class="number">0</span>][<span class="string">&#x27;label&#x27;</span>],</span><br><span class="line">                    <span class="string">&quot;score&quot;</span>: <span class="built_in">float</span>(result[<span class="number">0</span>][<span class="string">&#x27;score&#x27;</span>]),</span><br><span class="line">                    <span class="string">&quot;model&quot;</span>: <span class="string">&quot;local_sentiment&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># ç®€å•çš„åŸºäºè§„åˆ™çš„æƒ…æ„Ÿåˆ†æ</span></span><br><span class="line">                positive_words = [<span class="string">&quot;å¥½&quot;</span>, <span class="string">&quot;å–œæ¬¢&quot;</span>, <span class="string">&quot;å¼€å¿ƒ&quot;</span>, <span class="string">&quot;é«˜å…´&quot;</span>, <span class="string">&quot;æ£’&quot;</span>, <span class="string">&quot;ä¼˜ç§€&quot;</span>]</span><br><span class="line">                negative_words = [<span class="string">&quot;å&quot;</span>, <span class="string">&quot;è®¨åŒ&quot;</span>, <span class="string">&quot;ä¼¤å¿ƒ&quot;</span>, <span class="string">&quot;éš¾è¿‡&quot;</span>, <span class="string">&quot;ç³Ÿ&quot;</span>, <span class="string">&quot;å·®&quot;</span>]</span><br><span class="line">                </span><br><span class="line">                text_lower = text.lower()</span><br><span class="line">                positive_count = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> word <span class="keyword">in</span> positive_words <span class="keyword">if</span> word <span class="keyword">in</span> text_lower)</span><br><span class="line">                negative_count = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> word <span class="keyword">in</span> negative_words <span class="keyword">if</span> word <span class="keyword">in</span> text_lower)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> positive_count &gt; negative_count:</span><br><span class="line">                    sentiment = <span class="string">&quot;POSITIVE&quot;</span></span><br><span class="line">                    score = <span class="number">0.5</span> + (positive_count - negative_count) * <span class="number">0.1</span></span><br><span class="line">                <span class="keyword">elif</span> negative_count &gt; positive_count:</span><br><span class="line">                    sentiment = <span class="string">&quot;NEGATIVE&quot;</span></span><br><span class="line">                    score = <span class="number">0.5</span> + (negative_count - positive_count) * <span class="number">0.1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    sentiment = <span class="string">&quot;NEUTRAL&quot;</span></span><br><span class="line">                    score = <span class="number">0.5</span></span><br><span class="line">                </span><br><span class="line">                score = <span class="built_in">min</span>(<span class="built_in">max</span>(score, <span class="number">0</span>), <span class="number">1</span>)  <span class="comment"># é™åˆ¶åœ¨0-1ä¹‹é—´</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    <span class="string">&quot;sentiment&quot;</span>: sentiment,</span><br><span class="line">                    <span class="string">&quot;score&quot;</span>: score,</span><br><span class="line">                    <span class="string">&quot;model&quot;</span>: <span class="string">&quot;rule_based&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Error analyzing sentiment: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;sentiment&quot;</span>: <span class="string">&quot;NEUTRAL&quot;</span>,</span><br><span class="line">                <span class="string">&quot;score&quot;</span>: <span class="number">0.5</span>,</span><br><span class="line">                <span class="string">&quot;model&quot;</span>: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">                <span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_embeddings</span>(<span class="params">self, texts: <span class="type">List</span>[<span class="built_in">str</span>]</span>) -&gt; <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">float</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–æ–‡æœ¬åµŒå…¥å‘é‡&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;embedding&#x27;</span> <span class="keyword">in</span> self.local_models:</span><br><span class="line">                embeddings = self.local_models[<span class="string">&#x27;embedding&#x27;</span>].encode(texts)</span><br><span class="line">                <span class="keyword">return</span> embeddings.tolist()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># ç®€å•çš„è¯è¢‹æ¨¡å‹ï¼ˆå®é™…é¡¹ç›®ä¸­åº”è¯¥ä½¿ç”¨æ›´å¥½çš„åµŒå…¥ï¼‰</span></span><br><span class="line">                all_words = <span class="built_in">set</span>()</span><br><span class="line">                <span class="keyword">for</span> text <span class="keyword">in</span> texts:</span><br><span class="line">                    words = text.lower().split()</span><br><span class="line">                    all_words.update(words)</span><br><span class="line">                </span><br><span class="line">                word_to_idx = &#123;word: i <span class="keyword">for</span> i, word <span class="keyword">in</span> <span class="built_in">enumerate</span>(all_words)&#125;</span><br><span class="line">                embeddings = []</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> text <span class="keyword">in</span> texts:</span><br><span class="line">                    vector = [<span class="number">0</span>] * <span class="built_in">len</span>(all_words)</span><br><span class="line">                    words = text.lower().split()</span><br><span class="line">                    <span class="keyword">for</span> word <span class="keyword">in</span> words:</span><br><span class="line">                        <span class="keyword">if</span> word <span class="keyword">in</span> word_to_idx:</span><br><span class="line">                            vector[word_to_idx[word]] = <span class="number">1</span></span><br><span class="line">                    embeddings.append(vector)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> embeddings</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Error getting embeddings: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># è¿”å›éšæœºå‘é‡ä½œä¸ºå›é€€</span></span><br><span class="line">            <span class="keyword">import</span> random</span><br><span class="line">            <span class="keyword">return</span> [[random.random() <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">384</span>)] <span class="keyword">for</span> _ <span class="keyword">in</span> texts]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">summarize_text</span>(<span class="params">self, text: <span class="built_in">str</span>, max_length: <span class="built_in">int</span> = <span class="number">200</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ–‡æœ¬æ‘˜è¦&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># ç®€å•çš„åŸºäºè§„åˆ™æ‘˜è¦ï¼ˆå®é™…é¡¹ç›®ä¸­åº”è¯¥ä½¿ç”¨æ‘˜è¦æ¨¡å‹ï¼‰</span></span><br><span class="line">            sentences = text.split(<span class="string">&#x27;ã€‚&#x27;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(sentences) &lt;= <span class="number">3</span>:</span><br><span class="line">                <span class="keyword">return</span> text</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># é€‰æ‹©å¼€å¤´ã€ä¸­é—´ã€ç»“å°¾çš„å¥å­</span></span><br><span class="line">            summary_sentences = []</span><br><span class="line">            <span class="keyword">if</span> sentences:</span><br><span class="line">                summary_sentences.append(sentences[<span class="number">0</span>])</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(sentences) &gt; <span class="number">2</span>:</span><br><span class="line">                middle_idx = <span class="built_in">len</span>(sentences) // <span class="number">2</span></span><br><span class="line">                summary_sentences.append(sentences[middle_idx])</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(sentences) &gt; <span class="number">1</span>:</span><br><span class="line">                summary_sentences.append(sentences[-<span class="number">1</span>])</span><br><span class="line">            </span><br><span class="line">            summary = <span class="string">&#x27;ã€‚&#x27;</span>.join(summary_sentences)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(summary) &gt; max_length:</span><br><span class="line">                summary = summary[:max_length-<span class="number">3</span>] + <span class="string">&quot;...&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> summary</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Error summarizing text: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> text[:max_length]</span><br></pre></td></tr></table></figure>



<h2 id="ç¬¬7æ­¥ï¼šå·¥å…·ç±»å’Œä¸­é—´ä»¶"><a href="#ç¬¬7æ­¥ï¼šå·¥å…·ç±»å’Œä¸­é—´ä»¶" class="headerlink" title="ç¬¬7æ­¥ï¼šå·¥å…·ç±»å’Œä¸­é—´ä»¶"></a>ç¬¬7æ­¥ï¼šå·¥å…·ç±»å’Œä¸­é—´ä»¶</h2><p><strong>app&#x2F;utils&#x2F;logger.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> logging.handlers <span class="keyword">import</span> RotatingFileHandler, TimedRotatingFileHandler</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JSONFormatter</span>(logging.Formatter):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;JSONæ ¼å¼æ—¥å¿—æ ¼å¼åŒ–å™¨&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">format</span>(<span class="params">self, record</span>):</span><br><span class="line">        log_record = &#123;</span><br><span class="line">            <span class="string">&quot;timestamp&quot;</span>: datetime.utcnow().isoformat(),</span><br><span class="line">            <span class="string">&quot;level&quot;</span>: record.levelname,</span><br><span class="line">            <span class="string">&quot;logger&quot;</span>: record.name,</span><br><span class="line">            <span class="string">&quot;message&quot;</span>: record.getMessage(),</span><br><span class="line">            <span class="string">&quot;module&quot;</span>: record.module,</span><br><span class="line">            <span class="string">&quot;function&quot;</span>: record.funcName,</span><br><span class="line">            <span class="string">&quot;line&quot;</span>: record.lineno</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ·»åŠ å¼‚å¸¸ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">if</span> record.exc_info:</span><br><span class="line">            log_record[<span class="string">&quot;exception&quot;</span>] = self.formatException(record.exc_info)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ·»åŠ é¢å¤–å­—æ®µ</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(record, <span class="string">&#x27;extra&#x27;</span>):</span><br><span class="line">            log_record.update(record.extra)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> json.dumps(log_record, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup_logger</span>(<span class="params">name=<span class="literal">None</span>, level=logging.INFO, log_file=<span class="literal">None</span>, json_format=<span class="literal">False</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    é…ç½®æ—¥å¿—è®°å½•å™¨</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        name: æ—¥å¿—è®°å½•å™¨åç§°</span></span><br><span class="line"><span class="string">        level: æ—¥å¿—çº§åˆ«</span></span><br><span class="line"><span class="string">        log_file: æ—¥å¿—æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="string">        json_format: æ˜¯å¦ä½¿ç”¨JSONæ ¼å¼</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        logging.Logger: é…ç½®å¥½çš„æ—¥å¿—è®°å½•å™¨</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    logger = logging.getLogger(name)</span><br><span class="line">    logger.setLevel(level)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># é¿å…é‡å¤æ·»åŠ å¤„ç†å™¨</span></span><br><span class="line">    <span class="keyword">if</span> logger.handlers:</span><br><span class="line">        <span class="keyword">return</span> logger</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ§åˆ¶å°å¤„ç†å™¨</span></span><br><span class="line">    console_handler = logging.StreamHandler(sys.stdout)</span><br><span class="line">    <span class="keyword">if</span> json_format:</span><br><span class="line">        console_handler.setFormatter(JSONFormatter())</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        console_format = logging.Formatter(</span><br><span class="line">            <span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        console_handler.setFormatter(console_format)</span><br><span class="line">    logger.addHandler(console_handler)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ–‡ä»¶å¤„ç†å™¨</span></span><br><span class="line">    <span class="keyword">if</span> log_file:</span><br><span class="line">        os.makedirs(os.path.dirname(log_file), exist_ok=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æŒ‰æ—¶é—´è½®è½¬çš„æ–‡ä»¶å¤„ç†å™¨</span></span><br><span class="line">        file_handler = TimedRotatingFileHandler(</span><br><span class="line">            log_file,</span><br><span class="line">            when=<span class="string">&#x27;midnight&#x27;</span>,</span><br><span class="line">            interval=<span class="number">1</span>,</span><br><span class="line">            backupCount=<span class="number">30</span>,</span><br><span class="line">            encoding=<span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> json_format:</span><br><span class="line">            file_handler.setFormatter(JSONFormatter())</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            file_format = logging.Formatter(</span><br><span class="line">                <span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span></span><br><span class="line">            )</span><br><span class="line">            file_handler.setFormatter(file_format)</span><br><span class="line">        </span><br><span class="line">        logger.addHandler(file_handler)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> logger</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_request_logger</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è·å–è¯·æ±‚æ—¥å¿—è®°å½•å™¨&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> setup_logger(<span class="string">&#x27;request&#x27;</span>, logging.INFO, <span class="string">&#x27;logs/request.log&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_error_logger</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è·å–é”™è¯¯æ—¥å¿—è®°å½•å™¨&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> setup_logger(<span class="string">&#x27;error&#x27;</span>, logging.ERROR, <span class="string">&#x27;logs/error.log&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_ai_logger</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è·å–AIæœåŠ¡æ—¥å¿—è®°å½•å™¨&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> setup_logger(<span class="string">&#x27;ai&#x27;</span>, logging.INFO, <span class="string">&#x27;logs/ai.log&#x27;</span>, json_format=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">log_request</span>(<span class="params">request, response=<span class="literal">None</span>, duration=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è®°å½•HTTPè¯·æ±‚æ—¥å¿—&quot;&quot;&quot;</span></span><br><span class="line">    logger = get_request_logger()</span><br><span class="line">    </span><br><span class="line">    log_data = &#123;</span><br><span class="line">        <span class="string">&quot;method&quot;</span>: request.method,</span><br><span class="line">        <span class="string">&quot;path&quot;</span>: request.path,</span><br><span class="line">        <span class="string">&quot;query_params&quot;</span>: <span class="built_in">dict</span>(request.args),</span><br><span class="line">        <span class="string">&quot;user_agent&quot;</span>: request.user_agent.string,</span><br><span class="line">        <span class="string">&quot;remote_addr&quot;</span>: request.remote_addr,</span><br><span class="line">        <span class="string">&quot;duration&quot;</span>: duration</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> response:</span><br><span class="line">        log_data[<span class="string">&quot;status_code&quot;</span>] = response.status_code</span><br><span class="line">        log_data[<span class="string">&quot;response_size&quot;</span>] = <span class="built_in">len</span>(response.get_data()) <span class="keyword">if</span> response <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å¯¹äºç™»å½•è¯·æ±‚ï¼Œä¸è®°å½•å¯†ç </span></span><br><span class="line">    <span class="keyword">if</span> request.path == <span class="string">&#x27;/api/auth/login&#x27;</span> <span class="keyword">and</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        data = request.get_json() <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">        filtered_data = data.copy()</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;password&#x27;</span> <span class="keyword">in</span> filtered_data:</span><br><span class="line">            filtered_data[<span class="string">&#x27;password&#x27;</span>] = <span class="string">&#x27;***&#x27;</span></span><br><span class="line">        log_data[<span class="string">&quot;request_body&quot;</span>] = filtered_data</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> request.is_json:</span><br><span class="line">            log_data[<span class="string">&quot;request_body&quot;</span>] = request.get_json()</span><br><span class="line">    </span><br><span class="line">    logger.info(<span class="string">&quot;HTTP Request&quot;</span>, extra=log_data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">log_ai_request</span>(<span class="params">model, prompt, response, tokens_used</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è®°å½•AIè¯·æ±‚æ—¥å¿—&quot;&quot;&quot;</span></span><br><span class="line">    logger = get_ai_logger()</span><br><span class="line">    </span><br><span class="line">    log_data = &#123;</span><br><span class="line">        <span class="string">&quot;model&quot;</span>: model,</span><br><span class="line">        <span class="string">&quot;prompt_length&quot;</span>: <span class="built_in">len</span>(prompt),</span><br><span class="line">        <span class="string">&quot;response_length&quot;</span>: <span class="built_in">len</span>(response),</span><br><span class="line">        <span class="string">&quot;tokens_used&quot;</span>: tokens_used,</span><br><span class="line">        <span class="string">&quot;prompt_preview&quot;</span>: prompt[:<span class="number">100</span>] + <span class="string">&quot;...&quot;</span> <span class="keyword">if</span> <span class="built_in">len</span>(prompt) &gt; <span class="number">100</span> <span class="keyword">else</span> prompt,</span><br><span class="line">        <span class="string">&quot;response_preview&quot;</span>: response[:<span class="number">100</span>] + <span class="string">&quot;...&quot;</span> <span class="keyword">if</span> <span class="built_in">len</span>(response) &gt; <span class="number">100</span> <span class="keyword">else</span> response</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    logger.info(<span class="string">&quot;AI Request&quot;</span>, extra=log_data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">log_error</span>(<span class="params">error, context=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è®°å½•é”™è¯¯æ—¥å¿—&quot;&quot;&quot;</span></span><br><span class="line">    logger = get_error_logger()</span><br><span class="line">    </span><br><span class="line">    log_data = &#123;</span><br><span class="line">        <span class="string">&quot;error_type&quot;</span>: <span class="built_in">type</span>(error).__name__,</span><br><span class="line">        <span class="string">&quot;error_message&quot;</span>: <span class="built_in">str</span>(error),</span><br><span class="line">        <span class="string">&quot;context&quot;</span>: context <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    logger.error(<span class="string">&quot;Error occurred&quot;</span>, extra=log_data, exc_info=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LoggingMiddleware</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ—¥å¿—ä¸­é—´ä»¶&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, app</span>):</span><br><span class="line">        self.app = app</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, environ, start_response</span>):</span><br><span class="line">        <span class="keyword">import</span> time</span><br><span class="line">        </span><br><span class="line">        start_time = time.time()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">logging_start_response</span>(<span class="params">status, headers, exc_info=<span class="literal">None</span></span>):</span><br><span class="line">            duration = time.time() - start_time</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è®°å½•è¯·æ±‚æ—¥å¿—</span></span><br><span class="line">            <span class="keyword">from</span> flask <span class="keyword">import</span> request, g</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">hasattr</span>(g, <span class="string">&#x27;response&#x27;</span>):</span><br><span class="line">                log_request(request, g.response, duration)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> start_response(status, headers, exc_info)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> self.app(environ, logging_start_response)</span><br></pre></td></tr></table></figure>



<h2 id="ç¬¬8æ­¥ï¼šå‰ç«¯ç•Œé¢"><a href="#ç¬¬8æ­¥ï¼šå‰ç«¯ç•Œé¢" class="headerlink" title="ç¬¬8æ­¥ï¼šå‰ç«¯ç•Œé¢"></a>ç¬¬8æ­¥ï¼šå‰ç«¯ç•Œé¢</h2><p>ç”±äºç¯‡å¹…é™åˆ¶ï¼Œè¿™é‡Œæä¾›ä¸€ä¸ªç®€åŒ–çš„å‰ç«¯ç•Œé¢ï¼š</p>
<p><strong>templates&#x2F;index.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh-CN&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>AIèŠå¤©æœºå™¨äººåŠ©æ‰‹<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-pseudo">:root</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attr">--primary-color</span>: <span class="number">#3498db</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attr">--secondary-color</span>: <span class="number">#2ecc71</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attr">--background-color</span>: <span class="number">#f8f9fa</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attr">--text-color</span>: <span class="number">#333</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attr">--border-color</span>: <span class="number">#dee2e6</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">body</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: <span class="built_in">var</span>(--background-color);</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="built_in">var</span>(--text-color);</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-family</span>: <span class="string">&#x27;Segoe UI&#x27;</span>, Tahoma, Geneva, Verdana, sans-serif;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.chat-container</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">max-width</span>: <span class="number">1200px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin</span>: <span class="number">0</span> auto;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">5px</span> <span class="number">20px</span> <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.1</span>);</span></span><br><span class="line"><span class="language-css">            <span class="attribute">overflow</span>: hidden;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.chat-header</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">135deg</span>, <span class="built_in">var</span>(--primary-color), <span class="number">#2980b9</span>);</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: white;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">text-align</span>: center;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.chat-messages</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">500px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">overflow-y</span>: auto;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: white;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.message</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-bottom</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">align-items</span>: flex-start;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.message</span><span class="selector-class">.user</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">justify-content</span>: flex-end;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.message-bubble</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">max-width</span>: <span class="number">70%</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">12px</span> <span class="number">18px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">18px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">position</span>: relative;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.user</span> <span class="selector-class">.message-bubble</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: <span class="built_in">var</span>(--primary-color);</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: white;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-bottom-right-radius</span>: <span class="number">4px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.assistant</span> <span class="selector-class">.message-bubble</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: <span class="number">#f1f1f1</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="built_in">var</span>(--text-color);</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-bottom-left-radius</span>: <span class="number">4px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.chat-input</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-top</span>: <span class="number">1px</span> solid <span class="built_in">var</span>(--border-color);</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: white;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.suggestions</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">flex-wrap</span>: wrap;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">gap</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-top</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.suggestion-btn</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: <span class="number">#f8f9fa</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="built_in">var</span>(--border-color);</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">5px</span> <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">0.9em</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">cursor</span>: pointer;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">transition</span>: all <span class="number">0.2s</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.suggestion-btn</span><span class="selector-pseudo">:hover</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: <span class="built_in">var</span>(--primary-color);</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: white;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.sidebar</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: white;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-right</span>: <span class="number">1px</span> solid <span class="built_in">var</span>(--border-color);</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">100vh</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">overflow-y</span>: auto;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.session-item</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">10px</span> <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="built_in">var</span>(--border-color);</span></span><br><span class="line"><span class="language-css">            <span class="attribute">cursor</span>: pointer;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">transition</span>: background-color <span class="number">0.2s</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.session-item</span><span class="selector-pseudo">:hover</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: <span class="number">#f8f9fa</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.session-item</span><span class="selector-class">.active</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: <span class="built_in">var</span>(--primary-color);</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: white;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.typing-indicator</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">align-items</span>: center;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">gap</span>: <span class="number">5px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.typing-dot</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">8px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">8px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: <span class="number">#999</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">animation</span>: typing <span class="number">1.4s</span> infinite;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.typing-dot</span><span class="selector-pseudo">:nth-child</span>(<span class="number">2</span>) &#123; <span class="attribute">animation-delay</span>: <span class="number">0.2s</span>; &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.typing-dot</span><span class="selector-pseudo">:nth-child</span>(<span class="number">3</span>) &#123; <span class="attribute">animation-delay</span>: <span class="number">0.4s</span>; &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="keyword">@keyframes</span> typing &#123;</span></span><br><span class="line"><span class="language-css">            <span class="number">0%</span>, <span class="number">60%</span>, <span class="number">100%</span> &#123; <span class="attribute">transform</span>: <span class="built_in">translateY</span>(<span class="number">0</span>); &#125;</span></span><br><span class="line"><span class="language-css">            <span class="number">30%</span> &#123; <span class="attribute">transform</span>: <span class="built_in">translateY</span>(-<span class="number">10px</span>); &#125;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.analytics-card</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: white;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">2px</span> <span class="number">10px</span> <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.1</span>);</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-bottom</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.theme-selector</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">position</span>: fixed;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">top</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">right</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">z-index</span>: <span class="number">1000</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.theme-btn</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">30px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">30px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border</span>: <span class="number">2px</span> solid white;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">cursor</span>: pointer;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin</span>: <span class="number">5px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.theme-default</span> &#123; <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">135deg</span>, <span class="number">#3498db</span>, <span class="number">#2ecc71</span>); &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.theme-dark</span> &#123; <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">135deg</span>, <span class="number">#2c3e50</span>, <span class="number">#34495e</span>); &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.theme-nature</span> &#123; <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">135deg</span>, <span class="number">#27ae60</span>, <span class="number">#f39c12</span>); &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.theme-retro</span> &#123; <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">135deg</span>, <span class="number">#e74c3c</span>, <span class="number">#f1c40f</span>); &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container-fluid&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- ä¾§è¾¹æ  --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-md-3 sidebar d-none d-md-block&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;p-3&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h4</span>&gt;</span>èŠå¤©ä¼šè¯<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary w-100 mb-3&quot;</span> <span class="attr">id</span>=<span class="string">&quot;new-chat-btn&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-plus&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> æ–°å¯¹è¯</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;sessions-list&quot;</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- ä¼šè¯åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">&lt;!-- ä¸»èŠå¤©åŒºåŸŸ --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-md-9&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;chat-container mt-3&quot;</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- èŠå¤©å¤´éƒ¨ --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;chat-header&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">h3</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-robot&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> AIèŠå¤©åŠ©æ‰‹<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;mb-0&quot;</span>&gt;</span>æ™ºèƒ½å¯¹è¯ï¼Œéšæ—¶ä¸ºæ‚¨æœåŠ¡<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">&lt;!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;chat-messages&quot;</span> <span class="attr">id</span>=<span class="string">&quot;chat-messages&quot;</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- æ¬¢è¿æ¶ˆæ¯ --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;message assistant&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;message-bubble&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">strong</span>&gt;</span>æ™ºå‹AIåŠ©æ‰‹ï¼š<span class="tag">&lt;/<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                                ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ï¼Œå¯ä»¥å¸®ä½ è§£ç­”é—®é¢˜ã€èŠå¤©å¯¹è¯ã€åˆ†ææƒ…æ„Ÿç­‰ã€‚æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ</span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">&lt;!-- èŠå¤©è¾“å…¥åŒºåŸŸ --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;chat-input&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> </span></span><br><span class="line"><span class="tag">                                   <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> </span></span><br><span class="line"><span class="tag">                                   <span class="attr">id</span>=<span class="string">&quot;message-input&quot;</span> </span></span><br><span class="line"><span class="tag">                                   <span class="attr">placeholder</span>=<span class="string">&quot;è¾“å…¥ä½ çš„æ¶ˆæ¯...&quot;</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> <span class="attr">id</span>=<span class="string">&quot;send-btn&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-paper-plane&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> å‘é€</span><br><span class="line">                            <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">&lt;!-- å»ºè®®å›å¤ --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;suggestions mt-3&quot;</span> <span class="attr">id</span>=<span class="string">&quot;suggestions&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;suggestion-btn&quot;</span> <span class="attr">data-message</span>=<span class="string">&quot;ä½ å¥½ï¼&quot;</span>&gt;</span>ä½ å¥½ï¼<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;suggestion-btn&quot;</span> <span class="attr">data-message</span>=<span class="string">&quot;ä½ èƒ½åšä»€ä¹ˆï¼Ÿ&quot;</span>&gt;</span>ä½ èƒ½åšä»€ä¹ˆï¼Ÿ<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;suggestion-btn&quot;</span> <span class="attr">data-message</span>=<span class="string">&quot;è®²ä¸ªç¬‘è¯&quot;</span>&gt;</span>è®²ä¸ªç¬‘è¯<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;suggestion-btn&quot;</span> <span class="attr">data-message</span>=<span class="string">&quot;ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ&quot;</span>&gt;</span>ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">&lt;!-- åˆ†æé¢æ¿ --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row mt-4&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-md-4&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;analytics-card&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">h5</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-chart-line&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> å¯¹è¯ç»Ÿè®¡<span class="tag">&lt;/<span class="name">h5</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;stats-container&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">p</span>&gt;</span>æ¶ˆæ¯æ€»æ•°: <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;total-messages&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">p</span>&gt;</span>å¯¹è¯è½®æ¬¡: <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;conversation-rounds&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">p</span>&gt;</span>å¹³å‡å“åº”æ—¶é—´: <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;avg-response-time&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span>ç§’<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-md-4&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;analytics-card&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">h5</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-brain&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> æ„å›¾åˆ†æ<span class="tag">&lt;/<span class="name">h5</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">&quot;intent-chart&quot;</span> <span class="attr">width</span>=<span class="string">&quot;200&quot;</span> <span class="attr">height</span>=<span class="string">&quot;150&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-md-4&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;analytics-card&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">h5</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-smile&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> æƒ…æ„Ÿåˆ†æ<span class="tag">&lt;/<span class="name">h5</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">&quot;emotion-chart&quot;</span> <span class="attr">width</span>=<span class="string">&quot;200&quot;</span> <span class="attr">height</span>=<span class="string">&quot;150&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- ä¸»é¢˜é€‰æ‹©å™¨ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;theme-selector&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;theme-btn theme-default&quot;</span> <span class="attr">data-theme</span>=<span class="string">&quot;default&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;theme-btn theme-dark&quot;</span> <span class="attr">data-theme</span>=<span class="string">&quot;dark&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;theme-btn theme-nature&quot;</span> <span class="attr">data-theme</span>=<span class="string">&quot;nature&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;theme-btn theme-retro&quot;</span> <span class="attr">data-theme</span>=<span class="string">&quot;retro&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- è„šæœ¬ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/chart.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.socket.io/4.5.0/socket.io.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// å…¨å±€å˜é‡</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> currentSessionId = <span class="literal">null</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> isTyping = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// åˆå§‹åŒ–å›¾è¡¨</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> intentChart = <span class="keyword">new</span> <span class="title class_">Chart</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;intent-chart&#x27;</span>), &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">type</span>: <span class="string">&#x27;doughnut&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">data</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">labels</span>: [<span class="string">&#x27;é—®å€™&#x27;</span>, <span class="string">&#x27;æé—®&#x27;</span>, <span class="string">&#x27;å¯¹è¯&#x27;</span>, <span class="string">&#x27;å‘½ä»¤&#x27;</span>],</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">datasets</span>: [&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">data</span>: [<span class="number">25</span>, <span class="number">40</span>, <span class="number">25</span>, <span class="number">10</span>],</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">backgroundColor</span>: [<span class="string">&#x27;#3498db&#x27;</span>, <span class="string">&#x27;#2ecc71&#x27;</span>, <span class="string">&#x27;#e74c3c&#x27;</span>, <span class="string">&#x27;#f39c12&#x27;</span>]</span></span><br><span class="line"><span class="language-javascript">                &#125;]</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">options</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">responsive</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">plugins</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">legend</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="attr">position</span>: <span class="string">&#x27;bottom&#x27;</span></span></span><br><span class="line"><span class="language-javascript">                    &#125;</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> emotionChart = <span class="keyword">new</span> <span class="title class_">Chart</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;emotion-chart&#x27;</span>), &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">type</span>: <span class="string">&#x27;bar&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">data</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">labels</span>: [<span class="string">&#x27;ç§¯æ&#x27;</span>, <span class="string">&#x27;ä¸­æ€§&#x27;</span>, <span class="string">&#x27;æ¶ˆæ&#x27;</span>],</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">datasets</span>: [&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">label</span>: <span class="string">&#x27;æƒ…æ„Ÿåˆ†å¸ƒ&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">data</span>: [<span class="number">60</span>, <span class="number">30</span>, <span class="number">10</span>],</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">backgroundColor</span>: [<span class="string">&#x27;#2ecc71&#x27;</span>, <span class="string">&#x27;#3498db&#x27;</span>, <span class="string">&#x27;#e74c3c&#x27;</span>]</span></span><br><span class="line"><span class="language-javascript">                &#125;]</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">options</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">responsive</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">scales</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">y</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="attr">beginAtZero</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="language-javascript">                        <span class="attr">max</span>: <span class="number">100</span></span></span><br><span class="line"><span class="language-javascript">                    &#125;</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// WebSocketè¿æ¥</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> socket = <span class="title function_">io</span>();</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// å‘é€æ¶ˆæ¯</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sendMessage</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> input = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;message-input&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> message = input.<span class="property">value</span>.<span class="title function_">trim</span>();</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (!message) <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">addMessageToUI</span>(<span class="string">&#x27;user&#x27;</span>, message);</span></span><br><span class="line"><span class="language-javascript">            input.<span class="property">value</span> = <span class="string">&#x27;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">showTypingIndicator</span>();</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// å‘é€è¯·æ±‚åˆ°åç«¯</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;/api/chat/send&#x27;</span>, &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">headers</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                        <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">`Bearer <span class="subst">$&#123;<span class="variable language_">localStorage</span>.getItem(<span class="string">&#x27;token&#x27;</span>)&#125;</span>`</span></span></span><br><span class="line"><span class="language-javascript">                    &#125;,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="attr">message</span>: message,</span></span><br><span class="line"><span class="language-javascript">                        <span class="attr">session_id</span>: currentSessionId</span></span><br><span class="line"><span class="language-javascript">                    &#125;)</span></span><br><span class="line"><span class="language-javascript">                &#125;);</span></span><br><span class="line"><span class="language-javascript">                </span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span></span><br><span class="line"><span class="language-javascript">                </span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// éšè—æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨</span></span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">hideTypingIndicator</span>();</span></span><br><span class="line"><span class="language-javascript">                </span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (data.<span class="property">success</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// æ·»åŠ AIå›å¤åˆ°ç•Œé¢</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">addMessageToUI</span>(<span class="string">&#x27;assistant&#x27;</span>, data.<span class="property">data</span>.<span class="property">reply</span>);</span></span><br><span class="line"><span class="language-javascript">                    </span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// æ›´æ–°å»ºè®®å›å¤</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">updateSuggestions</span>(data.<span class="property">data</span>.<span class="property">metadata</span>.<span class="property">suggested_responses</span>);</span></span><br><span class="line"><span class="language-javascript">                    </span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">updateStats</span>(data.<span class="property">data</span>.<span class="property">metadata</span>);</span></span><br><span class="line"><span class="language-javascript">                    </span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// æ›´æ–°å›¾è¡¨</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">updateCharts</span>(data.<span class="property">data</span>.<span class="property">metadata</span>);</span></span><br><span class="line"><span class="language-javascript">                &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">addMessageToUI</span>(<span class="string">&#x27;assistant&#x27;</span>, <span class="string">`é”™è¯¯: <span class="subst">$&#123;data.error&#125;</span>`</span>);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125; <span class="keyword">catch</span> (error) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">hideTypingIndicator</span>();</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">addMessageToUI</span>(<span class="string">&#x27;assistant&#x27;</span>, <span class="string">&#x27;ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error:&#x27;</span>, error);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">addMessageToUI</span>(<span class="params">role, content</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> messagesContainer = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;chat-messages&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// ç§»é™¤æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> typingIndicator = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.typing-indicator&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (typingIndicator) &#123;</span></span><br><span class="line"><span class="language-javascript">                typingIndicator.<span class="title function_">remove</span>();</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> messageDiv = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            messageDiv.<span class="property">className</span> = <span class="string">`message <span class="subst">$&#123;role&#125;</span>`</span>;</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> bubbleDiv = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            bubbleDiv.<span class="property">className</span> = <span class="string">&#x27;message-bubble&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (role === <span class="string">&#x27;assistant&#x27;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                bubbleDiv.<span class="property">innerHTML</span> = <span class="string">`&lt;strong&gt;æ™ºå‹AIåŠ©æ‰‹ï¼š&lt;/strong&gt;&lt;br&gt;<span class="subst">$&#123;content&#125;</span>`</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                bubbleDiv.<span class="property">innerHTML</span> = <span class="string">`&lt;strong&gt;ä½ ï¼š&lt;/strong&gt;&lt;br&gt;<span class="subst">$&#123;content&#125;</span>`</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            messageDiv.<span class="title function_">appendChild</span>(bubbleDiv);</span></span><br><span class="line"><span class="language-javascript">            messagesContainer.<span class="title function_">appendChild</span>(messageDiv);</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// æ»šåŠ¨åˆ°åº•éƒ¨</span></span></span><br><span class="line"><span class="language-javascript">            messagesContainer.<span class="property">scrollTop</span> = messagesContainer.<span class="property">scrollHeight</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">showTypingIndicator</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> messagesContainer = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;chat-messages&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> indicatorDiv = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            indicatorDiv.<span class="property">className</span> = <span class="string">&#x27;message assistant&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> bubbleDiv = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            bubbleDiv.<span class="property">className</span> = <span class="string">&#x27;message-bubble&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">            bubbleDiv.<span class="property">innerHTML</span> = <span class="string">&#x27;&lt;div class=&quot;typing-indicator&quot;&gt;&lt;div class=&quot;typing-dot&quot;&gt;&lt;/div&gt;&lt;div class=&quot;typing-dot&quot;&gt;&lt;/div&gt;&lt;div class=&quot;typing-dot&quot;&gt;&lt;/div&gt;&lt;/div&gt;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            indicatorDiv.<span class="title function_">appendChild</span>(bubbleDiv);</span></span><br><span class="line"><span class="language-javascript">            messagesContainer.<span class="title function_">appendChild</span>(indicatorDiv);</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// æ»šåŠ¨åˆ°åº•éƒ¨</span></span></span><br><span class="line"><span class="language-javascript">            messagesContainer.<span class="property">scrollTop</span> = messagesContainer.<span class="property">scrollHeight</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// éšè—æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">hideTypingIndicator</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> indicator = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.typing-indicator&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (indicator) &#123;</span></span><br><span class="line"><span class="language-javascript">                indicator.<span class="property">parentElement</span>.<span class="property">parentElement</span>.<span class="title function_">remove</span>();</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// æ›´æ–°å»ºè®®å›å¤</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">updateSuggestions</span>(<span class="params">suggestions</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> container = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;suggestions&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            container.<span class="property">innerHTML</span> = <span class="string">&#x27;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (suggestions &amp;&amp; suggestions.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                suggestions.<span class="title function_">forEach</span>(<span class="function"><span class="params">suggestion</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">const</span> btn = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                    btn.<span class="property">className</span> = <span class="string">&#x27;suggestion-btn&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                    btn.<span class="property">textContent</span> = suggestion;</span></span><br><span class="line"><span class="language-javascript">                    btn.<span class="title function_">setAttribute</span>(<span class="string">&#x27;data-message&#x27;</span>, suggestion);</span></span><br><span class="line"><span class="language-javascript">                    btn.<span class="property">onclick</span> = <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;message-input&#x27;</span>).<span class="property">value</span> = suggestion;</span></span><br><span class="line"><span class="language-javascript">                        <span class="title function_">sendMessage</span>();</span></span><br><span class="line"><span class="language-javascript">                    &#125;;</span></span><br><span class="line"><span class="language-javascript">                    container.<span class="title function_">appendChild</span>(btn);</span></span><br><span class="line"><span class="language-javascript">                &#125;);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">updateStats</span>(<span class="params">metadata</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;total-messages&#x27;</span>).<span class="property">textContent</span> = </span></span><br><span class="line"><span class="language-javascript">                <span class="built_in">parseInt</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;total-messages&#x27;</span>).<span class="property">textContent</span>) + <span class="number">2</span>;</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;conversation-rounds&#x27;</span>).<span class="property">textContent</span> = </span></span><br><span class="line"><span class="language-javascript">                <span class="built_in">parseInt</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;conversation-rounds&#x27;</span>).<span class="property">textContent</span>) + <span class="number">1</span>;</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;avg-response-time&#x27;</span>).<span class="property">textContent</span> = </span></span><br><span class="line"><span class="language-javascript">                metadata.<span class="property">processing_time</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// æ›´æ–°å›¾è¡¨</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">updateCharts</span>(<span class="params">metadata</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// è¿™é‡Œå¯ä»¥æ·»åŠ æ›´æ–°å›¾è¡¨çš„é€»è¾‘</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Updating charts with:&#x27;</span>, metadata);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// äº‹ä»¶ç›‘å¬å™¨</span></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;send-btn&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, sendMessage);</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;message-input&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;keypress&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;Enter&#x27;</span> &amp;&amp; !e.<span class="property">shiftKey</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                e.<span class="title function_">preventDefault</span>();</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">sendMessage</span>();</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// å»ºè®®å›å¤ç‚¹å‡»äº‹ä»¶</span></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.suggestion-btn&#x27;</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">btn</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            btn.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;message-input&#x27;</span>).<span class="property">value</span> = btn.<span class="title function_">getAttribute</span>(<span class="string">&#x27;data-message&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">sendMessage</span>();</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// ä¸»é¢˜åˆ‡æ¢</span></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.theme-btn&#x27;</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">btn</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            btn.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> theme = btn.<span class="title function_">getAttribute</span>(<span class="string">&#x27;data-theme&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">applyTheme</span>(theme);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// åº”ç”¨ä¸»é¢˜</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">applyTheme</span>(<span class="params">theme</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> root = <span class="variable language_">document</span>.<span class="property">documentElement</span>;</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> themes = &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">default</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&#x27;primary-color&#x27;</span>: <span class="string">&#x27;#3498db&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&#x27;secondary-color&#x27;</span>: <span class="string">&#x27;#2ecc71&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&#x27;background-color&#x27;</span>: <span class="string">&#x27;#f8f9fa&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&#x27;text-color&#x27;</span>: <span class="string">&#x27;#333&#x27;</span></span></span><br><span class="line"><span class="language-javascript">                &#125;,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">dark</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&#x27;primary-color&#x27;</span>: <span class="string">&#x27;#9b59b6&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&#x27;secondary-color&#x27;</span>: <span class="string">&#x27;#1abc9c&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&#x27;background-color&#x27;</span>: <span class="string">&#x27;#2c3e50&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&#x27;text-color&#x27;</span>: <span class="string">&#x27;#ecf0f1&#x27;</span></span></span><br><span class="line"><span class="language-javascript">                &#125;,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">nature</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&#x27;primary-color&#x27;</span>: <span class="string">&#x27;#27ae60&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&#x27;secondary-color&#x27;</span>: <span class="string">&#x27;#f39c12&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&#x27;background-color&#x27;</span>: <span class="string">&#x27;#e8f6f3&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&#x27;text-color&#x27;</span>: <span class="string">&#x27;#2c3e50&#x27;</span></span></span><br><span class="line"><span class="language-javascript">                &#125;,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">retro</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&#x27;primary-color&#x27;</span>: <span class="string">&#x27;#e74c3c&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&#x27;secondary-color&#x27;</span>: <span class="string">&#x27;#f1c40f&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&#x27;background-color&#x27;</span>: <span class="string">&#x27;#fdebd0&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&#x27;text-color&#x27;</span>: <span class="string">&#x27;#34495e&#x27;</span></span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;;</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> colors = themes[theme] || themes.<span class="property">default</span>;</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="title class_">Object</span>.<span class="title function_">entries</span>(colors).<span class="title function_">forEach</span>(<span class="function">(<span class="params">[key, value]</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                root.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">`--<span class="subst">$&#123;key&#125;</span>`</span>, value);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// ä¿å­˜ä¸»é¢˜åˆ°æœ¬åœ°å­˜å‚¨</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;theme&#x27;</span>, theme);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// åŠ è½½ä¿å­˜çš„ä¸»é¢˜</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> savedTheme = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;theme&#x27;</span>) || <span class="string">&#x27;default&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">applyTheme</span>(savedTheme);</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// åˆå§‹åŒ–</span></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;message-input&#x27;</span>).<span class="title function_">focus</span>();</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// æ¨¡æ‹ŸåŠ è½½ä¼šè¯åˆ—è¡¨</span></span></span><br><span class="line"><span class="language-javascript">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> sessions = [</span></span><br><span class="line"><span class="language-javascript">                &#123; <span class="attr">id</span>: <span class="string">&#x27;1&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;å…³äºAIçš„è®¨è®º&#x27;</span>, <span class="attr">time</span>: <span class="string">&#x27;åˆšåˆš&#x27;</span>, <span class="attr">count</span>: <span class="number">5</span> &#125;,</span></span><br><span class="line"><span class="language-javascript">                &#123; <span class="attr">id</span>: <span class="string">&#x27;2&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;å­¦ä¹ Pythonçš„å»ºè®®&#x27;</span>, <span class="attr">time</span>: <span class="string">&#x27;2å°æ—¶å‰&#x27;</span>, <span class="attr">count</span>: <span class="number">8</span> &#125;,</span></span><br><span class="line"><span class="language-javascript">                &#123; <span class="attr">id</span>: <span class="string">&#x27;3&#x27;</span>, <span class="attr">title</span>: <span class="string">&#x27;å‘¨æœ«è®¡åˆ’&#x27;</span>, <span class="attr">time</span>: <span class="string">&#x27;æ˜¨å¤©&#x27;</span>, <span class="attr">count</span>: <span class="number">3</span> &#125;</span></span><br><span class="line"><span class="language-javascript">            ];</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> sessionsList = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;sessions-list&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            sessions.<span class="title function_">forEach</span>(<span class="function"><span class="params">session</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> div = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                div.<span class="property">className</span> = <span class="string">&#x27;session-item&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                div.<span class="property">innerHTML</span> = <span class="string">`</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                    &lt;strong&gt;<span class="subst">$&#123;session.title&#125;</span>&lt;/strong&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                    &lt;div class=&quot;small text-muted&quot;&gt;<span class="subst">$&#123;session.time&#125;</span> â€¢ <span class="subst">$&#123;session.count&#125;</span>æ¡æ¶ˆæ¯&lt;/div&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                `</span>;</span></span><br><span class="line"><span class="language-javascript">                sessionsList.<span class="title function_">appendChild</span>(div);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;, <span class="number">1000</span>);</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="ç¬¬9æ­¥ï¼šDockeréƒ¨ç½²é…ç½®"><a href="#ç¬¬9æ­¥ï¼šDockeréƒ¨ç½²é…ç½®" class="headerlink" title="ç¬¬9æ­¥ï¼šDockeréƒ¨ç½²é…ç½®"></a>ç¬¬9æ­¥ï¼šDockeréƒ¨ç½²é…ç½®</h2><p><strong>Dockerfile</strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨Python 3.9å®˜æ–¹é•œåƒ</span></span><br><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.9</span>-slim</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å·¥ä½œç›®å½•</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="keyword">ENV</span> PYTHONDONTWRITEBYTECODE=<span class="number">1</span> \</span><br><span class="line">    PYTHONUNBUFFERED=<span class="number">1</span> \</span><br><span class="line">    PYTHONPATH=/app</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ç³»ç»Ÿä¾èµ–</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y \</span></span><br><span class="line"><span class="language-bash">    gcc \</span></span><br><span class="line"><span class="language-bash">    g++ \</span></span><br><span class="line"><span class="language-bash">    postgresql-client \</span></span><br><span class="line"><span class="language-bash">    curl \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…Pythonä¾èµ–</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> requirements.txt .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install --no-cache-dir -r requirements.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶åº”ç”¨ä»£ç </span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºérootç”¨æˆ·</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> useradd -m -u 1000 appuser &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">chown</span> -R appuser:appuser /app &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mkdir</span> -p /app/logs /app/uploads &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">chown</span> -R appuser:appuser /app/logs /app/uploads</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ‡æ¢ç”¨æˆ·</span></span><br><span class="line"><span class="keyword">USER</span> appuser</span><br><span class="line"></span><br><span class="line"><span class="comment"># æš´éœ²ç«¯å£</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">5000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¥åº·æ£€æŸ¥</span></span><br><span class="line"><span class="keyword">HEALTHCHECK</span><span class="language-bash"> --interval=30s --<span class="built_in">timeout</span>=10s --start-period=30s --retries=3 \</span></span><br><span class="line"><span class="language-bash">    CMD curl -f http://localhost:5000/health || <span class="built_in">exit</span> 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨å‘½ä»¤</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;gunicorn&quot;</span>, <span class="string">&quot;--config&quot;</span>, <span class="string">&quot;gunicorn.conf.py&quot;</span>, <span class="string">&quot;app.main:app&quot;</span>]</span></span><br></pre></td></tr></table></figure>



<p><strong>docker-compose.yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="comment"># PostgreSQLæ•°æ®åº“</span></span><br><span class="line">  <span class="attr">postgres:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:15-alpine</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">POSTGRES_USER:</span> <span class="string">chatbot</span></span><br><span class="line">      <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">chatbot123</span></span><br><span class="line">      <span class="attr">POSTGRES_DB:</span> <span class="string">chatbot_db</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">postgres_data:/var/lib/postgresql/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./init.sql:/docker-entrypoint-initdb.d/init.sql</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;5432:5432&quot;</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD-SHELL&quot;</span>, <span class="string">&quot;pg_isready -U chatbot&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">chatbot_network</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Redisç¼“å­˜</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:7-alpine</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis_data:/data</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--appendonly</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;redis-cli&quot;</span>, <span class="string">&quot;ping&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">chatbot_network</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Flaskåº”ç”¨</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;5000:5000&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">FLASK_ENV:</span> <span class="string">production</span></span><br><span class="line">      <span class="attr">DATABASE_URL:</span> <span class="string">postgresql://chatbot:chatbot123@postgres:5432/chatbot_db</span></span><br><span class="line">      <span class="attr">REDIS_URL:</span> <span class="string">redis://redis:6379/0</span></span><br><span class="line">      <span class="attr">SECRET_KEY:</span> <span class="string">$&#123;SECRET_KEY:-your-secret-key-change-in-production&#125;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logs:/app/logs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./uploads:/app/uploads</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="attr">postgres:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">service_healthy</span></span><br><span class="line">      <span class="attr">redis:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">service_healthy</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">chatbot_network</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Celery worker</span></span><br><span class="line">  <span class="attr">worker:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">celery</span> <span class="string">-A</span> <span class="string">app.services.task_service.celery_app</span> <span class="string">worker</span> <span class="string">--loglevel=info</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">DATABASE_URL:</span> <span class="string">postgresql://chatbot:chatbot123@postgres:5432/chatbot_db</span></span><br><span class="line">      <span class="attr">REDIS_URL:</span> <span class="string">redis://redis:6379/0</span></span><br><span class="line">      <span class="attr">CELERY_BROKER_URL:</span> <span class="string">redis://redis:6379/0</span></span><br><span class="line">      <span class="attr">CELERY_RESULT_BACKEND:</span> <span class="string">redis://redis:6379/0</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logs:/app/logs</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">postgres</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">chatbot_network</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Celery beat</span></span><br><span class="line">  <span class="attr">beat:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">celery</span> <span class="string">-A</span> <span class="string">app.services.task_service.celery_app</span> <span class="string">beat</span> <span class="string">--loglevel=info</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">DATABASE_URL:</span> <span class="string">postgresql://chatbot:chatbot123@postgres:5432/chatbot_db</span></span><br><span class="line">      <span class="attr">REDIS_URL:</span> <span class="string">redis://redis:6379/0</span></span><br><span class="line">      <span class="attr">CELERY_BROKER_URL:</span> <span class="string">redis://redis:6379/0</span></span><br><span class="line">      <span class="attr">CELERY_RESULT_BACKEND:</span> <span class="string">redis://redis:6379/0</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logs:/app/logs</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">postgres</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">chatbot_network</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Nginxåå‘ä»£ç†</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;443:443&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx.conf:/etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./ssl:/etc/nginx/ssl</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logs/nginx:/var/log/nginx</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">chatbot_network</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ç›‘æ§</span></span><br><span class="line">  <span class="attr">prometheus:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">prom/prometheus:latest</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9090:9090&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./prometheus.yml:/etc/prometheus/prometheus.yml</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">prometheus_data:/prometheus</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;--config.file=/etc/prometheus/prometheus.yml&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;--storage.tsdb.path=/prometheus&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;--web.console.libraries=/etc/prometheus/console_libraries&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;--web.console.templates=/etc/prometheus/consoles&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;--storage.tsdb.retention.time=200h&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;--web.enable-lifecycle&#x27;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">chatbot_network</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Grafana</span></span><br><span class="line">  <span class="attr">grafana:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">grafana/grafana:latest</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3000:3000&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">GF_SECURITY_ADMIN_PASSWORD:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">grafana_data:/var/lib/grafana</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./grafana/provisioning:/etc/grafana/provisioning</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">chatbot_network</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç½‘ç»œ</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">chatbot_network:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å·</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">postgres_data:</span></span><br><span class="line">  <span class="attr">redis_data:</span></span><br><span class="line">  <span class="attr">prometheus_data:</span></span><br><span class="line">  <span class="attr">grafana_data:</span></span><br></pre></td></tr></table></figure>



<h2 id="ç¬¬10æ­¥ï¼šå®Œæ•´çš„é¡¹ç›®ç»“æ„"><a href="#ç¬¬10æ­¥ï¼šå®Œæ•´çš„é¡¹ç›®ç»“æ„" class="headerlink" title="ç¬¬10æ­¥ï¼šå®Œæ•´çš„é¡¹ç›®ç»“æ„"></a>ç¬¬10æ­¥ï¼šå®Œæ•´çš„é¡¹ç›®ç»“æ„</h2><p>æœ€ç»ˆçš„é¡¹ç›®å®Œæ•´ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">ai-chatbot-system/</span><br><span class="line">â”œâ”€â”€ app/</span><br><span class="line">â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚   â”œâ”€â”€ main.py</span><br><span class="line">â”‚   â”œâ”€â”€ config.py</span><br><span class="line">â”‚   â”œâ”€â”€ api/</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ auth.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ chat.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ analytics.py</span><br><span class="line">â”‚   â”‚   â””â”€â”€ admin.py</span><br><span class="line">â”‚   â”œâ”€â”€ core/</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ chatbot.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ nlp_engine.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ intent_detector.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ emotion_analyzer.py</span><br><span class="line">â”‚   â”‚   â””â”€â”€ knowledge_base.py</span><br><span class="line">â”‚   â”œâ”€â”€ database/</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ models.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ crud.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ session.py</span><br><span class="line">â”‚   â”‚   â””â”€â”€ migrations/</span><br><span class="line">â”‚   â”‚       â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚   â”‚       â”œâ”€â”€ versions/</span><br><span class="line">â”‚   â”‚       â””â”€â”€ script.py.mako</span><br><span class="line">â”‚   â”œâ”€â”€ services/</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ ai_service.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ cache_service.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ task_service.py</span><br><span class="line">â”‚   â”‚   â””â”€â”€ email_service.py</span><br><span class="line">â”‚   â”œâ”€â”€ static/</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ css/</span><br><span class="line">â”‚   â”‚   â”‚   â”œâ”€â”€ style.css</span><br><span class="line">â”‚   â”‚   â”‚   â””â”€â”€ themes.css</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ js/</span><br><span class="line">â”‚   â”‚   â”‚   â”œâ”€â”€ app.js</span><br><span class="line">â”‚   â”‚   â”‚   â”œâ”€â”€ chat.js</span><br><span class="line">â”‚   â”‚   â”‚   â””â”€â”€ analytics.js</span><br><span class="line">â”‚   â”‚   â””â”€â”€ images/</span><br><span class="line">â”‚   â”‚       â”œâ”€â”€ logo.png</span><br><span class="line">â”‚   â”‚       â””â”€â”€ favicon.ico</span><br><span class="line">â”‚   â”œâ”€â”€ templates/</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ base.html</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ index.html</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ chat.html</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ dashboard.html</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ login.html</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ register.html</span><br><span class="line">â”‚   â”‚   â””â”€â”€ admin/</span><br><span class="line">â”‚   â”‚       â”œâ”€â”€ base.html</span><br><span class="line">â”‚   â”‚       â”œâ”€â”€ index.html</span><br><span class="line">â”‚   â”‚       â””â”€â”€ users.html</span><br><span class="line">â”‚   â”œâ”€â”€ utils/</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ logger.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ helpers.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ validators.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ decorators.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ error_handlers.py</span><br><span class="line">â”‚   â”‚   â””â”€â”€ cli.py</span><br><span class="line">â”‚   â”œâ”€â”€ middleware/</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ auth.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ logging.py</span><br><span class="line">â”‚   â”‚   â””â”€â”€ rate_limit.py</span><br><span class="line">â”‚   â””â”€â”€ models/</span><br><span class="line">â”‚       â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚       â”œâ”€â”€ user.py</span><br><span class="line">â”‚       â”œâ”€â”€ chat.py</span><br><span class="line">â”‚       â””â”€â”€ analytics.py</span><br><span class="line">â”œâ”€â”€ tests/</span><br><span class="line">â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚   â”œâ”€â”€ conftest.py</span><br><span class="line">â”‚   â”œâ”€â”€ unit/</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ test_models.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ test_chatbot.py</span><br><span class="line">â”‚   â”‚   â””â”€â”€ test_services.py</span><br><span class="line">â”‚   â”œâ”€â”€ integration/</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ test_api_auth.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ test_api_chat.py</span><br><span class="line">â”‚   â”‚   â””â”€â”€ test_database.py</span><br><span class="line">â”‚   â””â”€â”€ functional/</span><br><span class="line">â”‚       â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚       â”œâ”€â”€ test_user_flow.py</span><br><span class="line">â”‚       â””â”€â”€ test_chat_flow.py</span><br><span class="line">â”œâ”€â”€ scripts/</span><br><span class="line">â”‚   â”œâ”€â”€ setup.sh</span><br><span class="line">â”‚   â”œâ”€â”€ deploy.sh</span><br><span class="line">â”‚   â”œâ”€â”€ test.sh</span><br><span class="line">â”‚   â”œâ”€â”€ migrate.sh</span><br><span class="line">â”‚   â”œâ”€â”€ backup.sh</span><br><span class="line">â”‚   â””â”€â”€ init.sql</span><br><span class="line">â”œâ”€â”€ docs/</span><br><span class="line">â”‚   â”œâ”€â”€ api.md</span><br><span class="line">â”‚   â”œâ”€â”€ database.md</span><br><span class="line">â”‚   â”œâ”€â”€ deployment.md</span><br><span class="line">â”‚   â””â”€â”€ development.md</span><br><span class="line">â”œâ”€â”€ logs/</span><br><span class="line">â”‚   â”œâ”€â”€ app/</span><br><span class="line">â”‚   â”œâ”€â”€ nginx/</span><br><span class="line">â”‚   â””â”€â”€ celery/</span><br><span class="line">â”œâ”€â”€ migrations/</span><br><span class="line">â”‚   â”œâ”€â”€ versions/</span><br><span class="line">â”‚   â””â”€â”€ script.py.mako</span><br><span class="line">â”œâ”€â”€ uploads/</span><br><span class="line">â”‚   â”œâ”€â”€ avatars/</span><br><span class="line">â”‚   â””â”€â”€ documents/</span><br><span class="line">â”œâ”€â”€ requirements.txt</span><br><span class="line">â”œâ”€â”€ requirements-dev.txt</span><br><span class="line">â”œâ”€â”€ Dockerfile</span><br><span class="line">â”œâ”€â”€ docker-compose.yml</span><br><span class="line">â”œâ”€â”€ docker-compose.dev.yml</span><br><span class="line">â”œâ”€â”€ nginx.conf</span><br><span class="line">â”œâ”€â”€ gunicorn.conf.py</span><br><span class="line">â”œâ”€â”€ celery.conf.py</span><br><span class="line">â”œâ”€â”€ prometheus.yml</span><br><span class="line">â”œâ”€â”€ .env.example</span><br><span class="line">â”œâ”€â”€ .gitignore</span><br><span class="line">â”œâ”€â”€ .dockerignore</span><br><span class="line">â”œâ”€â”€ .pre-commit-config.yaml</span><br><span class="line">â”œâ”€â”€ setup.py</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â””â”€â”€ CHANGELOG.md</span><br></pre></td></tr></table></figure>



<h2 id="ç¬¬11æ­¥ï¼šè¿è¡Œå’Œæµ‹è¯•"><a href="#ç¬¬11æ­¥ï¼šè¿è¡Œå’Œæµ‹è¯•" class="headerlink" title="ç¬¬11æ­¥ï¼šè¿è¡Œå’Œæµ‹è¯•"></a>ç¬¬11æ­¥ï¼šè¿è¡Œå’Œæµ‹è¯•</h2><h3 id="11-1-æœ¬åœ°å¼€å‘ç¯å¢ƒè¿è¡Œ"><a href="#11-1-æœ¬åœ°å¼€å‘ç¯å¢ƒè¿è¡Œ" class="headerlink" title="11.1 æœ¬åœ°å¼€å‘ç¯å¢ƒè¿è¡Œ"></a>11.1 æœ¬åœ°å¼€å‘ç¯å¢ƒè¿è¡Œ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. å…‹éš†é¡¹ç›®</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/yourusername/ai-chatbot-system.git</span><br><span class="line"><span class="built_in">cd</span> ai-chatbot-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line">python -m venv venv</span><br><span class="line"></span><br><span class="line"><span class="comment"># Windows</span></span><br><span class="line">venv\Scripts\activate</span><br><span class="line"><span class="comment"># Linux/Mac</span></span><br><span class="line"><span class="built_in">source</span> venv/bin/activate</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. å®‰è£…ä¾èµ–</span></span><br><span class="line">pip install -r requirements.txt</span><br><span class="line">pip install -r requirements-dev.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. è®¾ç½®ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="built_in">cp</span> .env.example .<span class="built_in">env</span></span><br><span class="line"><span class="comment"># ç¼–è¾‘.envæ–‡ä»¶ï¼Œå¡«å…¥ä½ çš„é…ç½®</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. åˆå§‹åŒ–æ•°æ®åº“</span></span><br><span class="line">python scripts/setup.py init_db</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. è¿è¡Œå¼€å‘æœåŠ¡å™¨</span></span><br><span class="line">python run.py</span><br></pre></td></tr></table></figure>



<h3 id="11-2-ä½¿ç”¨Dockerè¿è¡Œ"><a href="#11-2-ä½¿ç”¨Dockerè¿è¡Œ" class="headerlink" title="11.2 ä½¿ç”¨Dockerè¿è¡Œ"></a>11.2 ä½¿ç”¨Dockerè¿è¡Œ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. æ„å»ºå’Œå¯åŠ¨æœåŠ¡</span></span><br><span class="line">docker-compose up -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æŸ¥çœ‹è¿è¡ŒçŠ¶æ€</span></span><br><span class="line">docker-compose ps</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. æŸ¥çœ‹æ—¥å¿—</span></span><br><span class="line">docker-compose logs -f web</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. åœæ­¢æœåŠ¡</span></span><br><span class="line">docker-compose down</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. åœæ­¢å¹¶åˆ é™¤æ•°æ®</span></span><br><span class="line">docker-compose down -v</span><br></pre></td></tr></table></figure>



<h3 id="11-3-è¿è¡Œæµ‹è¯•"><a href="#11-3-è¿è¡Œæµ‹è¯•" class="headerlink" title="11.3 è¿è¡Œæµ‹è¯•"></a>11.3 è¿è¡Œæµ‹è¯•</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿è¡Œæ‰€æœ‰æµ‹è¯•</span></span><br><span class="line">pytest</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡Œç‰¹å®šæµ‹è¯•</span></span><br><span class="line">pytest tests/unit/test_chatbot.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š</span></span><br><span class="line">pytest --cov=app --cov-report=html</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥</span></span><br><span class="line">flake8 app</span><br><span class="line">black --check app</span><br><span class="line">mypy app</span><br></pre></td></tr></table></figure>



<h2 id="é¡¹ç›®æ€»ç»“"><a href="#é¡¹ç›®æ€»ç»“" class="headerlink" title="é¡¹ç›®æ€»ç»“"></a>é¡¹ç›®æ€»ç»“</h2><p>è¿™ä¸ªå®Œæ•´çš„AIèŠå¤©æœºå™¨äººåŠ©æ‰‹ç³»ç»ŸåŒ…å«äº†ï¼š</p>
<h3 id="âœ…-å·²å®ç°çš„åŠŸèƒ½ï¼š"><a href="#âœ…-å·²å®ç°çš„åŠŸèƒ½ï¼š" class="headerlink" title="âœ… å·²å®ç°çš„åŠŸèƒ½ï¼š"></a>âœ… å·²å®ç°çš„åŠŸèƒ½ï¼š</h3><ol>
<li><strong>ç”¨æˆ·ç³»ç»Ÿ</strong>ï¼šæ³¨å†Œã€ç™»å½•ã€JWTè®¤è¯ã€æƒé™ç®¡ç†</li>
<li><strong>èŠå¤©åŠŸèƒ½</strong>ï¼šå®æ—¶å¯¹è¯ã€ä¼šè¯ç®¡ç†ã€æ¶ˆæ¯å†å²</li>
<li><strong>AIæ ¸å¿ƒ</strong>ï¼šæ„å›¾è¯†åˆ«ã€æƒ…æ„Ÿåˆ†æã€æ™ºèƒ½å›å¤</li>
<li><strong>æ•°æ®åˆ†æ</strong>ï¼šå¯¹è¯ç»Ÿè®¡ã€æƒ…æ„Ÿè¶‹åŠ¿ã€ä½¿ç”¨åˆ†æ</li>
<li><strong>çŸ¥è¯†åº“</strong>ï¼šå‘é‡å­˜å‚¨ã€ç›¸ä¼¼åº¦æ£€ç´¢</li>
<li><strong>ä»»åŠ¡é˜Ÿåˆ—</strong>ï¼šå¼‚æ­¥å¤„ç†ã€å®šæ—¶ä»»åŠ¡</li>
<li><strong>ç¼“å­˜ç³»ç»Ÿ</strong>ï¼šRedisç¼“å­˜ã€ä¼šè¯ç®¡ç†</li>
<li><strong>ç›‘æ§å‘Šè­¦</strong>ï¼šæ—¥å¿—ç³»ç»Ÿã€æ€§èƒ½ç›‘æ§</li>
<li><strong>å‰ç«¯ç•Œé¢</strong>ï¼šå“åº”å¼Webç•Œé¢ã€ä¸»é¢˜åˆ‡æ¢</li>
<li><strong>éƒ¨ç½²é…ç½®</strong>ï¼šDockerå®¹å™¨åŒ–ã€Nginxåå‘ä»£ç†</li>
</ol>
<h3 id="ğŸ”§-æŠ€æœ¯æ ˆè¦†ç›–ï¼š"><a href="#ğŸ”§-æŠ€æœ¯æ ˆè¦†ç›–ï¼š" class="headerlink" title="ğŸ”§ æŠ€æœ¯æ ˆè¦†ç›–ï¼š"></a>ğŸ”§ æŠ€æœ¯æ ˆè¦†ç›–ï¼š</h3><ul>
<li><strong>åç«¯æ¡†æ¶</strong>ï¼šFlask + SQLAlchemy + Celery</li>
<li><strong>æ•°æ®åº“</strong>ï¼šPostgreSQL + Redis</li>
<li><strong>AI&#x2F;ML</strong>ï¼šOpenAI API + HuggingFace + scikit-learn</li>
<li><strong>å¼‚æ­¥å¤„ç†</strong>ï¼šasyncio + WebSocket + Celery</li>
<li><strong>ç¼“å­˜é˜Ÿåˆ—</strong>ï¼šRedis</li>
<li><strong>å®¹å™¨åŒ–</strong>ï¼šDocker + Docker Compose</li>
<li><strong>ç›‘æ§</strong>ï¼šPrometheus + Grafana</li>
<li><strong>æµ‹è¯•</strong>ï¼špytest + unittest + coverage</li>
<li><strong>ä»£ç è´¨é‡</strong>ï¼šflake8 + black + mypy</li>
</ul>
<h3 id="ğŸš€-å­¦ä¹ è·¯å¾„ï¼š"><a href="#ğŸš€-å­¦ä¹ è·¯å¾„ï¼š" class="headerlink" title="ğŸš€ å­¦ä¹ è·¯å¾„ï¼š"></a>ğŸš€ å­¦ä¹ è·¯å¾„ï¼š</h3><ol>
<li><strong>åŸºç¡€é˜¶æ®µ</strong>ï¼šFlaskæ¡†æ¶ã€æ•°æ®åº“æ“ä½œã€APIè®¾è®¡</li>
<li><strong>è¿›é˜¶é˜¶æ®µ</strong>ï¼šå¼‚æ­¥ç¼–ç¨‹ã€AIé›†æˆã€ç¼“å­˜ä¼˜åŒ–</li>
<li><strong>é«˜çº§é˜¶æ®µ</strong>ï¼šç³»ç»Ÿæ¶æ„ã€æ€§èƒ½ä¼˜åŒ–ã€éƒ¨ç½²è¿ç»´</li>
<li><strong>å®æˆ˜é˜¶æ®µ</strong>ï¼šé¡¹ç›®å¼€å‘ã€å›¢é˜Ÿåä½œã€ç”Ÿäº§éƒ¨ç½²</li>
</ol>
<h3 id="ğŸ“Š-æŠ€èƒ½æå‡ï¼š"><a href="#ğŸ“Š-æŠ€èƒ½æå‡ï¼š" class="headerlink" title="ğŸ“Š æŠ€èƒ½æå‡ï¼š"></a>ğŸ“Š æŠ€èƒ½æå‡ï¼š</h3><p>é€šè¿‡å®Œæˆè¿™ä¸ªé¡¹ç›®ï¼Œä½ å°†æŒæ¡ï¼š</p>
<ul>
<li>å®Œæ•´çš„Webåº”ç”¨å¼€å‘æµç¨‹</li>
<li>RESTful APIè®¾è®¡å’Œå®ç°</li>
<li>æ•°æ®åº“è®¾è®¡å’Œä¼˜åŒ–</li>
<li>AI&#x2F;MLæ¨¡å‹é›†æˆå’Œåº”ç”¨</li>
<li>ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§</li>
<li>å®¹å™¨åŒ–éƒ¨ç½²å’ŒDevOpså®è·µ</li>
<li>å›¢é˜Ÿåä½œå’Œé¡¹ç›®ç®¡ç†</li>
</ul>
<p>è¿™ä¸ªé¡¹ç›®æä¾›äº†å®Œæ•´çš„ä»£ç å®ç°å’Œè¯¦ç»†çš„æ–‡æ¡£ï¼Œä½ å¯ä»¥æŒ‰ç…§æ­¥éª¤é€æ­¥å®ç°ï¼Œæ¯ä¸ªæ¨¡å—éƒ½æœ‰æ¸…æ™°çš„æ³¨é‡Šå’Œæµ‹è¯•ç”¨ä¾‹ã€‚é¡¹ç›®è®¾è®¡è€ƒè™‘äº†å®é™…å·¥ä½œåœºæ™¯ä¸­çš„å„ç§éœ€æ±‚ï¼ŒåŒ…æ‹¬é”™è¯¯å¤„ç†ã€æ—¥å¿—è®°å½•ã€æ€§èƒ½ç›‘æ§ã€å®‰å…¨é˜²æŠ¤ç­‰ç”Ÿäº§çº§åŠŸèƒ½ã€‚</p>
<h2 id="ä¼˜åŒ–å’Œæ‰©å±•æ–¹å‘"><a href="#ä¼˜åŒ–å’Œæ‰©å±•æ–¹å‘" class="headerlink" title="ä¼˜åŒ–å’Œæ‰©å±•æ–¹å‘"></a>ä¼˜åŒ–å’Œæ‰©å±•æ–¹å‘</h2><h3 id="1-æ€§èƒ½ä¼˜åŒ–"><a href="#1-æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="1. æ€§èƒ½ä¼˜åŒ–"></a>1. æ€§èƒ½ä¼˜åŒ–</h3><ul>
<li>æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–ï¼ˆç´¢å¼•ã€åˆ†é¡µã€ç¼“å­˜ï¼‰</li>
<li>å¼‚æ­¥ä»»åŠ¡å¤„ç†ï¼ˆCeleryã€æ¶ˆæ¯é˜Ÿåˆ—ï¼‰</li>
<li>ç¼“å­˜ç­–ç•¥ï¼ˆRedisç¼“å­˜çƒ­ç‚¹æ•°æ®ï¼‰</li>
<li>ä»£ç æ€§èƒ½åˆ†æï¼ˆä½¿ç”¨cProfileã€py-spyç­‰å·¥å…·ï¼‰</li>
</ul>
<h3 id="2-åŠŸèƒ½æ‰©å±•"><a href="#2-åŠŸèƒ½æ‰©å±•" class="headerlink" title="2. åŠŸèƒ½æ‰©å±•"></a>2. åŠŸèƒ½æ‰©å±•</h3><ul>
<li>å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡ç®¡ç†</li>
<li>å¯¹è¯å†å²æœç´¢å’Œå¯¼å‡º</li>
<li>è¯­éŸ³è¾“å…¥å’Œè¾“å‡ºï¼ˆé›†æˆTTSå’ŒASRï¼‰</li>
<li>å¤šè¯­è¨€æ”¯æŒ</li>
<li>æ–‡ä»¶ä¸Šä¼ å’Œå¤„ç†ï¼ˆå›¾ç‰‡ã€PDFã€Wordç­‰ï¼‰</li>
<li>çŸ¥è¯†åº“æ›´æ–°å’Œç®¡ç†ç•Œé¢</li>
<li>ç”¨æˆ·è§’è‰²å’Œæƒé™ç®¡ç†ï¼ˆç®¡ç†å‘˜ã€æ™®é€šç”¨æˆ·ç­‰ï¼‰</li>
<li>ç¬¬ä¸‰æ–¹ç™»å½•ï¼ˆå¾®ä¿¡ã€GitHubç­‰ï¼‰</li>
</ul>
<h3 id="3-AIèƒ½åŠ›å¢å¼º"><a href="#3-AIèƒ½åŠ›å¢å¼º" class="headerlink" title="3. AIèƒ½åŠ›å¢å¼º"></a>3. AIèƒ½åŠ›å¢å¼º</h3><ul>
<li>é›†æˆæ›´å¤šAIæ¨¡å‹ï¼ˆæœ¬åœ°å’Œäº‘ç«¯ï¼‰</li>
<li>è‡ªå®šä¹‰æ¨¡å‹è®­ç»ƒå’Œå¾®è°ƒ</li>
<li>æ„å›¾è¯†åˆ«å’Œå®ä½“æå–çš„æ¨¡å‹ä¼˜åŒ–</li>
<li>æƒ…æ„Ÿåˆ†ææ¨¡å‹ä¼˜åŒ–</li>
<li>å¯¹è¯çŠ¶æ€è·Ÿè¸ª</li>
</ul>
<h3 id="4-ç”¨æˆ·ä½“éªŒ"><a href="#4-ç”¨æˆ·ä½“éªŒ" class="headerlink" title="4. ç”¨æˆ·ä½“éªŒ"></a>4. ç”¨æˆ·ä½“éªŒ</h3><ul>
<li>æ›´ä¸°å¯Œçš„å‰ç«¯ç•Œé¢ï¼ˆReact&#x2F;Vue.jsï¼‰</li>
<li>ç§»åŠ¨ç«¯é€‚é…æˆ–å¼€å‘å°ç¨‹åº</li>
<li>å®æ—¶é€šä¿¡ï¼ˆWebSocketï¼‰</li>
<li>é€šçŸ¥ç³»ç»Ÿï¼ˆé‚®ä»¶ã€çŸ­ä¿¡ã€ç«™å†…ä¿¡ï¼‰</li>
<li>ç”¨æˆ·åé¦ˆå’Œè¯„ä»·ç³»ç»Ÿ</li>
</ul>
<h3 id="5-ç³»ç»Ÿå¯é æ€§å’Œå®‰å…¨æ€§"><a href="#5-ç³»ç»Ÿå¯é æ€§å’Œå®‰å…¨æ€§" class="headerlink" title="5. ç³»ç»Ÿå¯é æ€§å’Œå®‰å…¨æ€§"></a>5. ç³»ç»Ÿå¯é æ€§å’Œå®‰å…¨æ€§</h3><ul>
<li>å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•è¦†ç›–ç‡</li>
<li>å‹åŠ›æµ‹è¯•å’Œè´Ÿè½½æµ‹è¯•</li>
<li>å®‰å…¨å®¡è®¡å’Œæ¼æ´æ‰«æ</li>
<li>æ•°æ®åŠ å¯†å’Œè„±æ•</li>
<li>å¤‡ä»½å’Œæ¢å¤ç­–ç•¥</li>
</ul>
<h3 id="6-ç›‘æ§å’Œè¿ç»´"><a href="#6-ç›‘æ§å’Œè¿ç»´" class="headerlink" title="6. ç›‘æ§å’Œè¿ç»´"></a>6. ç›‘æ§å’Œè¿ç»´</h3><ul>
<li>åº”ç”¨æ€§èƒ½ç›‘æ§ï¼ˆAPMï¼‰</li>
<li>æ—¥å¿—åˆ†æå’Œå‘Šè­¦</li>
<li>è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼ˆCI&#x2F;CDï¼‰</li>
<li>å¤šç¯å¢ƒé…ç½®ï¼ˆå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰</li>
</ul>
<h1 id="AIèŠå¤©æœºå™¨äººåŠ©æ‰‹ç³»ç»Ÿï¼šä¼˜åŒ–ä¸æ‰©å±•æ–¹æ¡ˆ"><a href="#AIèŠå¤©æœºå™¨äººåŠ©æ‰‹ç³»ç»Ÿï¼šä¼˜åŒ–ä¸æ‰©å±•æ–¹æ¡ˆ" class="headerlink" title="AIèŠå¤©æœºå™¨äººåŠ©æ‰‹ç³»ç»Ÿï¼šä¼˜åŒ–ä¸æ‰©å±•æ–¹æ¡ˆ"></a>AIèŠå¤©æœºå™¨äººåŠ©æ‰‹ç³»ç»Ÿï¼šä¼˜åŒ–ä¸æ‰©å±•æ–¹æ¡ˆ</h1><h2 id="ğŸš€-é«˜çº§ä¼˜åŒ–æ–¹å‘"><a href="#ğŸš€-é«˜çº§ä¼˜åŒ–æ–¹å‘" class="headerlink" title="ğŸš€ é«˜çº§ä¼˜åŒ–æ–¹å‘"></a>ğŸš€ é«˜çº§ä¼˜åŒ–æ–¹å‘</h2><h3 id="1-æ€§èƒ½æ·±åº¦ä¼˜åŒ–"><a href="#1-æ€§èƒ½æ·±åº¦ä¼˜åŒ–" class="headerlink" title="1. æ€§èƒ½æ·±åº¦ä¼˜åŒ–"></a>1. æ€§èƒ½æ·±åº¦ä¼˜åŒ–</h3><h4 id="1-1-æ•°æ®åº“ä¼˜åŒ–"><a href="#1-1-æ•°æ®åº“ä¼˜åŒ–" class="headerlink" title="1.1 æ•°æ®åº“ä¼˜åŒ–"></a>1.1 æ•°æ®åº“ä¼˜åŒ–</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/database/optimization.py</span></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> contextmanager</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> event, text</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> Session</span><br><span class="line"><span class="keyword">from</span> app.database.session <span class="keyword">import</span> db</span><br><span class="line"><span class="keyword">from</span> app.utils.logger <span class="keyword">import</span> setup_logger</span><br><span class="line"></span><br><span class="line">logger = setup_logger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DatabaseOptimizer</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–å™¨&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.query_stats = &#123;&#125;</span><br><span class="line">        self.slow_query_threshold = <span class="number">1.0</span>  <span class="comment"># ç§’</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setup_query_profiling</span>():</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è®¾ç½®æŸ¥è¯¢æ€§èƒ½åˆ†æ&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">        @event.listens_for(<span class="params">Session, <span class="string">&quot;before_execute&quot;</span></span>)</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">before_execute</span>(<span class="params">conn, clauseelement, multiparams, params</span>):</span><br><span class="line">            conn.info.setdefault(<span class="string">&#x27;query_start_time&#x27;</span>, []).append(</span><br><span class="line">                conn.engine.pool._time()</span><br><span class="line">            )</span><br><span class="line">        </span><br><span class="line"><span class="meta">        @event.listens_for(<span class="params">Session, <span class="string">&quot;after_execute&quot;</span></span>)</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">after_execute</span>(<span class="params">conn, clauseelement, multiparams, params, result</span>):</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(conn, <span class="string">&#x27;info&#x27;</span>) <span class="keyword">or</span> <span class="string">&#x27;query_start_time&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> conn.info:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">            start_time = conn.info[<span class="string">&#x27;query_start_time&#x27;</span>].pop()</span><br><span class="line">            duration = conn.engine.pool._time() - start_time</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> duration &gt; <span class="number">1.0</span>:  <span class="comment"># è®°å½•æ…¢æŸ¥è¯¢</span></span><br><span class="line">                logger.warning(<span class="string">f&quot;Slow query detected: <span class="subst">&#123;duration:<span class="number">.3</span>f&#125;</span>s - <span class="subst">&#123;clauseelement&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_indexes</span>():</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆ›å»ºæ€§èƒ½ç›¸å…³çš„ç´¢å¼•&quot;&quot;&quot;</span></span><br><span class="line">        indexes = [</span><br><span class="line">            <span class="comment"># èŠå¤©æ¶ˆæ¯ç´¢å¼•</span></span><br><span class="line">            <span class="string">&quot;CREATE INDEX IF NOT EXISTS idx_chat_messages_session_created ON chat_messages(session_id, created_at)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;CREATE INDEX IF NOT EXISTS idx_chat_messages_user_created ON chat_messages(user_id, created_at)&quot;</span>,</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># ç”¨æˆ·åˆ†æç´¢å¼•</span></span><br><span class="line">            <span class="string">&quot;CREATE INDEX IF NOT EXISTS idx_user_analytics_user_date ON user_analytics(user_id, date)&quot;</span>,</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># ä¼šè¯ç´¢å¼•</span></span><br><span class="line">            <span class="string">&quot;CREATE INDEX IF NOT EXISTS idx_chat_sessions_user_updated ON chat_sessions(user_id, updated_at)&quot;</span>,</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># å…¨æ–‡æœç´¢ç´¢å¼•</span></span><br><span class="line">            <span class="string">&quot;CREATE INDEX IF NOT EXISTS idx_chat_messages_content_search ON chat_messages USING gin(to_tsvector(&#x27;english&#x27;, content))&quot;</span></span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> indexes</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">optimize_queries</span>():</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥&quot;&quot;&quot;</span></span><br><span class="line">        optimizations = &#123;</span><br><span class="line">            <span class="string">&quot;batch_operations&quot;</span>: <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                -- æ‰¹é‡æ“ä½œç¤ºä¾‹</span></span><br><span class="line"><span class="string">                WITH batch_data AS (</span></span><br><span class="line"><span class="string">                    SELECT * FROM json_to_recordset(:data) AS x(id text, content text)</span></span><br><span class="line"><span class="string">                )</span></span><br><span class="line"><span class="string">                INSERT INTO chat_messages (id, content)</span></span><br><span class="line"><span class="string">                SELECT id, content FROM batch_data</span></span><br><span class="line"><span class="string">                ON CONFLICT (id) DO UPDATE SET content = EXCLUDED.content</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;pagination_optimization&quot;</span>: <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                -- æ¸¸æ ‡åˆ†é¡µä¼˜åŒ–</span></span><br><span class="line"><span class="string">                SELECT * FROM chat_messages</span></span><br><span class="line"><span class="string">                WHERE session_id = :session_id</span></span><br><span class="line"><span class="string">                AND created_at &lt; :cursor</span></span><br><span class="line"><span class="string">                ORDER BY created_at DESC</span></span><br><span class="line"><span class="string">                LIMIT :limit</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;materialized_views&quot;</span>: <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                -- ç‰©åŒ–è§†å›¾ç”¨äºé¢‘ç¹æŸ¥è¯¢</span></span><br><span class="line"><span class="string">                CREATE MATERIALIZED VIEW IF NOT EXISTS daily_user_stats AS</span></span><br><span class="line"><span class="string">                SELECT </span></span><br><span class="line"><span class="string">                    user_id,</span></span><br><span class="line"><span class="string">                    DATE(created_at) as date,</span></span><br><span class="line"><span class="string">                    COUNT(*) as message_count,</span></span><br><span class="line"><span class="string">                    SUM(LENGTH(content)) as total_chars</span></span><br><span class="line"><span class="string">                FROM chat_messages</span></span><br><span class="line"><span class="string">                GROUP BY user_id, DATE(created_at)</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> optimizations</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">QueryCache</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æŸ¥è¯¢ç»“æœç¼“å­˜&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client, ttl=<span class="number">300</span></span>):</span><br><span class="line">        self.redis = redis_client</span><br><span class="line">        self.ttl = ttl</span><br><span class="line">        self.prefix = <span class="string">&quot;query_cache:&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_key</span>(<span class="params">self, query, params</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ç”Ÿæˆç¼“å­˜é”®&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">import</span> hashlib</span><br><span class="line">        key_str = <span class="string">f&quot;<span class="subst">&#123;query&#125;</span>:<span class="subst">&#123;<span class="built_in">str</span>(params)&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.prefix + hashlib.md5(key_str.encode()).hexdigest()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, query, params</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–ç¼“å­˜ç»“æœ&quot;&quot;&quot;</span></span><br><span class="line">        key = self.get_key(query, params)</span><br><span class="line">        cached = <span class="keyword">await</span> self.redis.get(key)</span><br><span class="line">        <span class="keyword">if</span> cached:</span><br><span class="line">            <span class="keyword">import</span> pickle</span><br><span class="line">            <span class="keyword">return</span> pickle.loads(cached)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">set</span>(<span class="params">self, query, params, result</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è®¾ç½®ç¼“å­˜ç»“æœ&quot;&quot;&quot;</span></span><br><span class="line">        key = self.get_key(query, params)</span><br><span class="line">        <span class="keyword">import</span> pickle</span><br><span class="line">        <span class="keyword">await</span> self.redis.setex(key, self.ttl, pickle.dumps(result))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">invalidate_pattern</span>(<span class="params">self, pattern</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ ¹æ®æ¨¡å¼åˆ é™¤ç¼“å­˜&quot;&quot;&quot;</span></span><br><span class="line">        keys = <span class="keyword">await</span> self.redis.keys(<span class="string">f&quot;<span class="subst">&#123;self.prefix&#125;</span><span class="subst">&#123;pattern&#125;</span>*&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> keys:</span><br><span class="line">            <span class="keyword">await</span> self.redis.delete(*keys)</span><br></pre></td></tr></table></figure>



<h4 id="1-2-ç¼“å­˜ç­–ç•¥ä¼˜åŒ–"><a href="#1-2-ç¼“å­˜ç­–ç•¥ä¼˜åŒ–" class="headerlink" title="1.2 ç¼“å­˜ç­–ç•¥ä¼˜åŒ–"></a>1.2 ç¼“å­˜ç­–ç•¥ä¼˜åŒ–</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/services/advanced_cache.py</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Any</span>, <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Optional</span>, <span class="type">Union</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"><span class="keyword">import</span> aioredis</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AdvancedCacheService</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;é«˜çº§ç¼“å­˜æœåŠ¡&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_url: <span class="built_in">str</span></span>):</span><br><span class="line">        self.redis_url = redis_url</span><br><span class="line">        self.redis = <span class="literal">None</span></span><br><span class="line">        self.cache_stats = defaultdict(<span class="built_in">int</span>)</span><br><span class="line">        self.circuit_breaker_state = <span class="string">&quot;CLOSED&quot;</span></span><br><span class="line">        self.circuit_failures = <span class="number">0</span></span><br><span class="line">        self.circuit_threshold = <span class="number">5</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">connect</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è¿æ¥Redis&quot;&quot;&quot;</span></span><br><span class="line">        self.redis = <span class="keyword">await</span> aioredis.from_url(</span><br><span class="line">            self.redis_url,</span><br><span class="line">            encoding=<span class="string">&quot;utf-8&quot;</span>,</span><br><span class="line">            decode_responses=<span class="literal">True</span>,</span><br><span class="line">            retry_on_timeout=<span class="literal">True</span>,</span><br><span class="line">            socket_keepalive=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_with_fallback</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                               key: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                               fetch_func, </span></span><br><span class="line"><span class="params">                               ttl: <span class="built_in">int</span> = <span class="number">3600</span>,</span></span><br><span class="line"><span class="params">                               fallback_ttl: <span class="built_in">int</span> = <span class="number">300</span></span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        å¸¦é™çº§çš„ç¼“å­˜è·å–</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            key: ç¼“å­˜é”®</span></span><br><span class="line"><span class="string">            fetch_func: è·å–æ•°æ®çš„å‡½æ•°</span></span><br><span class="line"><span class="string">            ttl: æ­£å¸¸ç¼“å­˜æ—¶é—´</span></span><br><span class="line"><span class="string">            fallback_ttl: é™çº§ç¼“å­˜æ—¶é—´</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            ç¼“å­˜çš„æ•°æ®</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># æ£€æŸ¥ç†”æ–­å™¨</span></span><br><span class="line">        <span class="keyword">if</span> self.circuit_breaker_state == <span class="string">&quot;OPEN&quot;</span>:</span><br><span class="line">            logger.warning(<span class="string">&quot;Cache circuit breaker is OPEN, using fallback&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> self._get_fallback(key, fetch_func, fallback_ttl)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># å°è¯•è·å–ç¼“å­˜</span></span><br><span class="line">            cached = <span class="keyword">await</span> self.redis.get(key)</span><br><span class="line">            <span class="keyword">if</span> cached:</span><br><span class="line">                self.cache_stats[<span class="string">&quot;hits&quot;</span>] += <span class="number">1</span></span><br><span class="line">                <span class="keyword">return</span> json.loads(cached)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># ç¼“å­˜æœªå‘½ä¸­ï¼Œè·å–æ–°æ•°æ®</span></span><br><span class="line">            data = <span class="keyword">await</span> fetch_func()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># ç¼“å­˜æ•°æ®</span></span><br><span class="line">            <span class="keyword">await</span> self.redis.setex(</span><br><span class="line">                key, </span><br><span class="line">                ttl, </span><br><span class="line">                json.dumps(data, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            self.cache_stats[<span class="string">&quot;misses&quot;</span>] += <span class="number">1</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># é‡ç½®ç†”æ–­å™¨å¤±è´¥è®¡æ•°</span></span><br><span class="line">            self.circuit_failures = <span class="number">0</span></span><br><span class="line">            self.circuit_breaker_state = <span class="string">&quot;CLOSED&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> data</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.circuit_failures += <span class="number">1</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰“å¼€ç†”æ–­å™¨</span></span><br><span class="line">            <span class="keyword">if</span> self.circuit_failures &gt;= self.circuit_threshold:</span><br><span class="line">                self.circuit_breaker_state = <span class="string">&quot;OPEN&quot;</span></span><br><span class="line">                <span class="comment"># è®¾ç½®ç†”æ–­å™¨æ¢å¤æ—¶é—´</span></span><br><span class="line">                asyncio.create_task(self._reset_circuit_breaker(<span class="number">60</span>))</span><br><span class="line">            </span><br><span class="line">            logger.error(<span class="string">f&quot;Cache error: <span class="subst">&#123;e&#125;</span>, using fallback&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> self._get_fallback(key, fetch_func, fallback_ttl)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_get_fallback</span>(<span class="params">self, key: <span class="built_in">str</span>, fetch_func, ttl: <span class="built_in">int</span></span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–é™çº§æ•°æ®&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ä½¿ç”¨æœ¬åœ°å†…å­˜ç¼“å­˜ä½œä¸ºé™çº§</span></span><br><span class="line">        fallback_key = <span class="string">f&quot;fallback:<span class="subst">&#123;key&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ£€æŸ¥å†…å­˜ç¼“å­˜</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(self, <span class="string">&#x27;_memory_cache&#x27;</span>):</span><br><span class="line">            cached = self._memory_cache.get(fallback_key)</span><br><span class="line">            <span class="keyword">if</span> cached <span class="keyword">and</span> datetime.now() &lt; cached[<span class="string">&#x27;expires&#x27;</span>]:</span><br><span class="line">                <span class="keyword">return</span> cached[<span class="string">&#x27;data&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è·å–æ–°æ•°æ®</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = <span class="keyword">await</span> fetch_func()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># å­˜å‚¨åˆ°å†…å­˜ç¼“å­˜</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(self, <span class="string">&#x27;_memory_cache&#x27;</span>):</span><br><span class="line">                self._memory_cache = &#123;&#125;</span><br><span class="line">            </span><br><span class="line">            self._memory_cache[fallback_key] = &#123;</span><br><span class="line">                <span class="string">&#x27;data&#x27;</span>: data,</span><br><span class="line">                <span class="string">&#x27;expires&#x27;</span>: datetime.now() + timedelta(seconds=ttl)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> data</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Fallback also failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_reset_circuit_breaker</span>(<span class="params">self, delay: <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;é‡ç½®ç†”æ–­å™¨&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(delay)</span><br><span class="line">        self.circuit_breaker_state = <span class="string">&quot;HALF_OPEN&quot;</span></span><br><span class="line">        self.circuit_failures = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">batch_get</span>(<span class="params">self, keys: <span class="type">List</span>[<span class="built_in">str</span>], fetch_func</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ‰¹é‡è·å–ç¼“å­˜&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># æ‰¹é‡è·å–ç¼“å­˜</span></span><br><span class="line">        cached_values = <span class="keyword">await</span> self.redis.mget(keys)</span><br><span class="line">        </span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        missing_keys = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> key, cached <span class="keyword">in</span> <span class="built_in">zip</span>(keys, cached_values):</span><br><span class="line">            <span class="keyword">if</span> cached:</span><br><span class="line">                result[key] = json.loads(cached)</span><br><span class="line">                self.cache_stats[<span class="string">&quot;hits&quot;</span>] += <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                missing_keys.append(key)</span><br><span class="line">                self.cache_stats[<span class="string">&quot;misses&quot;</span>] += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è·å–ç¼ºå¤±çš„æ•°æ®</span></span><br><span class="line">        <span class="keyword">if</span> missing_keys:</span><br><span class="line">            missing_data = <span class="keyword">await</span> fetch_func(missing_keys)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ‰¹é‡è®¾ç½®ç¼“å­˜</span></span><br><span class="line">            pipeline = self.redis.pipeline()</span><br><span class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> missing_keys:</span><br><span class="line">                <span class="keyword">if</span> key <span class="keyword">in</span> missing_data:</span><br><span class="line">                    result[key] = missing_data[key]</span><br><span class="line">                    pipeline.setex(</span><br><span class="line">                        key, </span><br><span class="line">                        <span class="number">3600</span>, </span><br><span class="line">                        json.dumps(missing_data[key], ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">                    )</span><br><span class="line">            <span class="keyword">await</span> pipeline.execute()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_stats</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–ç¼“å­˜ç»Ÿè®¡&quot;&quot;&quot;</span></span><br><span class="line">        total = self.cache_stats[<span class="string">&quot;hits&quot;</span>] + self.cache_stats[<span class="string">&quot;misses&quot;</span>]</span><br><span class="line">        hit_rate = (self.cache_stats[<span class="string">&quot;hits&quot;</span>] / total * <span class="number">100</span>) <span class="keyword">if</span> total &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;hits&quot;</span>: self.cache_stats[<span class="string">&quot;hits&quot;</span>],</span><br><span class="line">            <span class="string">&quot;misses&quot;</span>: self.cache_stats[<span class="string">&quot;misses&quot;</span>],</span><br><span class="line">            <span class="string">&quot;hit_rate&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;hit_rate:<span class="number">.2</span>f&#125;</span>%&quot;</span>,</span><br><span class="line">            <span class="string">&quot;circuit_breaker&quot;</span>: self.circuit_breaker_state,</span><br><span class="line">            <span class="string">&quot;failures&quot;</span>: self.circuit_failures</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">clear_pattern</span>(<span class="params">self, pattern: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ¸…é™¤åŒ¹é…æ¨¡å¼çš„ç¼“å­˜&quot;&quot;&quot;</span></span><br><span class="line">        keys = <span class="keyword">await</span> self.redis.keys(pattern)</span><br><span class="line">        <span class="keyword">if</span> keys:</span><br><span class="line">            <span class="keyword">await</span> self.redis.delete(*keys)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">warmup_cache</span>(<span class="params">self, warmup_funcs: <span class="type">List</span>[<span class="built_in">callable</span>]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ç¼“å­˜é¢„çƒ­&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> func <span class="keyword">in</span> warmup_funcs:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">await</span> func()</span><br><span class="line">                logger.info(<span class="string">f&quot;Cache warmup completed for <span class="subst">&#123;func.__name__&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logger.error(<span class="string">f&quot;Cache warmup failed for <span class="subst">&#123;func.__name__&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>



<h4 id="1-3-å¼‚æ­¥ä»»åŠ¡ä¼˜åŒ–"><a href="#1-3-å¼‚æ­¥ä»»åŠ¡ä¼˜åŒ–" class="headerlink" title="1.3 å¼‚æ­¥ä»»åŠ¡ä¼˜åŒ–"></a>1.3 å¼‚æ­¥ä»»åŠ¡ä¼˜åŒ–</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/services/task_optimizer.py</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Any</span>, <span class="type">Callable</span>, <span class="type">Dict</span>, <span class="type">List</span></span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor, ProcessPoolExecutor</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TaskPriority</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    HIGH = <span class="number">0</span></span><br><span class="line">    NORMAL = <span class="number">1</span></span><br><span class="line">    LOW = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä»»åŠ¡å®šä¹‰&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">str</span></span><br><span class="line">    func: <span class="type">Callable</span></span><br><span class="line">    args: <span class="built_in">tuple</span></span><br><span class="line">    kwargs: <span class="built_in">dict</span></span><br><span class="line">    priority: TaskPriority = TaskPriority.NORMAL</span><br><span class="line">    timeout: <span class="built_in">float</span> = <span class="number">30.0</span></span><br><span class="line">    retries: <span class="built_in">int</span> = <span class="number">3</span></span><br><span class="line">    created_at: <span class="built_in">float</span> = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__post_init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> self.created_at <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.created_at = time.time()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AsyncTaskScheduler</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¼‚æ­¥ä»»åŠ¡è°ƒåº¦å™¨&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, max_workers: <span class="built_in">int</span> = <span class="number">10</span>, max_queue_size: <span class="built_in">int</span> = <span class="number">1000</span></span>):</span><br><span class="line">        self.max_workers = max_workers</span><br><span class="line">        self.max_queue_size = max_queue_size</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">        self.high_priority_queue = asyncio.Queue()</span><br><span class="line">        self.normal_priority_queue = asyncio.Queue()</span><br><span class="line">        self.low_priority_queue = asyncio.Queue()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># çº¿ç¨‹æ± å’Œè¿›ç¨‹æ± </span></span><br><span class="line">        self.thread_pool = ThreadPoolExecutor(max_workers=max_workers)</span><br><span class="line">        self.process_pool = ProcessPoolExecutor(max_workers=max_workers // <span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ä»»åŠ¡çŠ¶æ€è·Ÿè¸ª</span></span><br><span class="line">        self.tasks_in_progress = <span class="built_in">set</span>()</span><br><span class="line">        self.task_results = &#123;&#125;</span><br><span class="line">        self.task_stats = &#123;</span><br><span class="line">            <span class="string">&quot;completed&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;failed&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;timeout&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;total_time&quot;</span>: <span class="number">0.0</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å¯åŠ¨ä»»åŠ¡å¤„ç†å™¨</span></span><br><span class="line">        self._running = <span class="literal">True</span></span><br><span class="line">        self._processors = []</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">start</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¯åŠ¨ä»»åŠ¡è°ƒåº¦å™¨&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># åˆ›å»ºä»»åŠ¡å¤„ç†å™¨</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self.max_workers):</span><br><span class="line">            processor = asyncio.create_task(self._process_tasks(i))</span><br><span class="line">            self._processors.append(processor)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å¯åŠ¨ç›‘æ§ä»»åŠ¡</span></span><br><span class="line">        self._monitor_task = asyncio.create_task(self._monitor_system())</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">f&quot;AsyncTaskScheduler started with <span class="subst">&#123;self.max_workers&#125;</span> workers&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">stop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åœæ­¢ä»»åŠ¡è°ƒåº¦å™¨&quot;&quot;&quot;</span></span><br><span class="line">        self._running = <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å–æ¶ˆæ‰€æœ‰å¤„ç†å™¨</span></span><br><span class="line">        <span class="keyword">for</span> processor <span class="keyword">in</span> self._processors:</span><br><span class="line">            processor.cancel()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ</span></span><br><span class="line">        <span class="keyword">await</span> asyncio.gather(*self._processors, return_exceptions=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å…³é—­çº¿ç¨‹æ± å’Œè¿›ç¨‹æ± </span></span><br><span class="line">        self.thread_pool.shutdown(wait=<span class="literal">True</span>)</span><br><span class="line">        self.process_pool.shutdown(wait=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">&quot;AsyncTaskScheduler stopped&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">submit</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                    func: <span class="type">Callable</span>, </span></span><br><span class="line"><span class="params">                    *args, </span></span><br><span class="line"><span class="params">                    priority: TaskPriority = TaskPriority.NORMAL,</span></span><br><span class="line"><span class="params">                    **kwargs</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æäº¤ä»»åŠ¡&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># æ£€æŸ¥é˜Ÿåˆ—å¤§å°</span></span><br><span class="line">        total_queue_size = (</span><br><span class="line">            self.high_priority_queue.qsize() +</span><br><span class="line">            self.normal_priority_queue.qsize() +</span><br><span class="line">            self.low_priority_queue.qsize()</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> total_queue_size &gt;= self.max_queue_size:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;Task queue is full&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åˆ›å»ºä»»åŠ¡ID</span></span><br><span class="line">        task_id = <span class="string">f&quot;task_<span class="subst">&#123;<span class="built_in">int</span>(time.time() * <span class="number">1000</span>)&#125;</span>_<span class="subst">&#123;<span class="built_in">hash</span>(func.__name__)&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        task = Task(</span><br><span class="line">            <span class="built_in">id</span>=task_id,</span><br><span class="line">            func=func,</span><br><span class="line">            args=args,</span><br><span class="line">            kwargs=kwargs,</span><br><span class="line">            priority=priority</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ ¹æ®ä¼˜å…ˆçº§æ”¾å…¥é˜Ÿåˆ—</span></span><br><span class="line">        <span class="keyword">if</span> priority == TaskPriority.HIGH:</span><br><span class="line">            <span class="keyword">await</span> self.high_priority_queue.put(task)</span><br><span class="line">        <span class="keyword">elif</span> priority == TaskPriority.NORMAL:</span><br><span class="line">            <span class="keyword">await</span> self.normal_priority_queue.put(task)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">await</span> self.low_priority_queue.put(task)</span><br><span class="line">        </span><br><span class="line">        logger.debug(<span class="string">f&quot;Task <span class="subst">&#123;task_id&#125;</span> submitted with priority <span class="subst">&#123;priority&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> task_id</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_process_tasks</span>(<span class="params">self, worker_id: <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¤„ç†ä»»åŠ¡&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">while</span> self._running:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># æŒ‰ä¼˜å…ˆçº§è·å–ä»»åŠ¡</span></span><br><span class="line">                task = <span class="literal">None</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># é¦–å…ˆå°è¯•é«˜ä¼˜å…ˆçº§é˜Ÿåˆ—</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> self.high_priority_queue.empty():</span><br><span class="line">                    task = <span class="keyword">await</span> self.high_priority_queue.get()</span><br><span class="line">                <span class="comment"># ç„¶åå°è¯•æ™®é€šä¼˜å…ˆçº§é˜Ÿåˆ—</span></span><br><span class="line">                <span class="keyword">elif</span> <span class="keyword">not</span> self.normal_priority_queue.empty():</span><br><span class="line">                    task = <span class="keyword">await</span> self.normal_priority_queue.get()</span><br><span class="line">                <span class="comment"># æœ€åå°è¯•ä½ä¼˜å…ˆçº§é˜Ÿåˆ—</span></span><br><span class="line">                <span class="keyword">elif</span> <span class="keyword">not</span> self.low_priority_queue.empty():</span><br><span class="line">                    task = <span class="keyword">await</span> self.low_priority_queue.get()</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="comment"># é˜Ÿåˆ—ä¸ºç©ºï¼Œç­‰å¾…ä¸€ä¸‹</span></span><br><span class="line">                    <span class="keyword">await</span> asyncio.sleep(<span class="number">0.1</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> task:</span><br><span class="line">                    <span class="keyword">await</span> self._execute_task(task, worker_id)</span><br><span class="line">                    </span><br><span class="line">            <span class="keyword">except</span> asyncio.CancelledError:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logger.error(<span class="string">f&quot;Task processor <span class="subst">&#123;worker_id&#125;</span> error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_execute_task</span>(<span class="params">self, task: Task, worker_id: <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ‰§è¡Œä»»åŠ¡&quot;&quot;&quot;</span></span><br><span class="line">        task_start = time.time()</span><br><span class="line">        self.tasks_in_progress.add(task.<span class="built_in">id</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># æ ¹æ®ä»»åŠ¡ç±»å‹é€‰æ‹©æ‰§è¡Œæ–¹å¼</span></span><br><span class="line">            <span class="keyword">if</span> asyncio.iscoroutinefunction(task.func):</span><br><span class="line">                <span class="comment"># å¼‚æ­¥å‡½æ•°</span></span><br><span class="line">                result = <span class="keyword">await</span> asyncio.wait_for(</span><br><span class="line">                    task.func(*task.args, **task.kwargs),</span><br><span class="line">                    timeout=task.timeout</span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">elif</span> task.func.__name__.startswith(<span class="string">&#x27;cpu_intensive_&#x27;</span>):</span><br><span class="line">                <span class="comment"># CPUå¯†é›†å‹ä»»åŠ¡ï¼Œä½¿ç”¨è¿›ç¨‹æ± </span></span><br><span class="line">                loop = asyncio.get_event_loop()</span><br><span class="line">                result = <span class="keyword">await</span> loop.run_in_executor(</span><br><span class="line">                    self.process_pool,</span><br><span class="line">                    functools.partial(task.func, *task.args, **task.kwargs)</span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># IOå¯†é›†å‹ä»»åŠ¡ï¼Œä½¿ç”¨çº¿ç¨‹æ± </span></span><br><span class="line">                loop = asyncio.get_event_loop()</span><br><span class="line">                result = <span class="keyword">await</span> loop.run_in_executor(</span><br><span class="line">                    self.thread_pool,</span><br><span class="line">                    functools.partial(task.func, *task.args, **task.kwargs)</span><br><span class="line">                )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è®°å½•æˆåŠŸ</span></span><br><span class="line">            self.task_results[task.<span class="built_in">id</span>] = &#123;</span><br><span class="line">                <span class="string">&quot;status&quot;</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">                <span class="string">&quot;result&quot;</span>: result,</span><br><span class="line">                <span class="string">&quot;duration&quot;</span>: time.time() - task_start</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            self.task_stats[<span class="string">&quot;completed&quot;</span>] += <span class="number">1</span></span><br><span class="line">            self.task_stats[<span class="string">&quot;total_time&quot;</span>] += time.time() - task_start</span><br><span class="line">            </span><br><span class="line">            logger.debug(<span class="string">f&quot;Task <span class="subst">&#123;task.<span class="built_in">id</span>&#125;</span> completed successfully in <span class="subst">&#123;time.time() - task_start:<span class="number">.3</span>f&#125;</span>s&quot;</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> asyncio.TimeoutError:</span><br><span class="line">            <span class="comment"># è¶…æ—¶å¤„ç†</span></span><br><span class="line">            self.task_results[task.<span class="built_in">id</span>] = &#123;</span><br><span class="line">                <span class="string">&quot;status&quot;</span>: <span class="string">&quot;timeout&quot;</span>,</span><br><span class="line">                <span class="string">&quot;duration&quot;</span>: time.time() - task_start</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            self.task_stats[<span class="string">&quot;timeout&quot;</span>] += <span class="number">1</span></span><br><span class="line">            logger.warning(<span class="string">f&quot;Task <span class="subst">&#123;task.<span class="built_in">id</span>&#125;</span> timeout after <span class="subst">&#123;task.timeout&#125;</span>s&quot;</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># é‡è¯•é€»è¾‘</span></span><br><span class="line">            <span class="keyword">if</span> task.retries &gt; <span class="number">0</span>:</span><br><span class="line">                logger.info(<span class="string">f&quot;Task <span class="subst">&#123;task.<span class="built_in">id</span>&#125;</span> failed, retrying (<span class="subst">&#123;task.retries&#125;</span> left)&quot;</span>)</span><br><span class="line">                task.retries -= <span class="number">1</span></span><br><span class="line">                <span class="keyword">await</span> self.submit(task.func, *task.args, </span><br><span class="line">                                 priority=task.priority,</span><br><span class="line">                                 timeout=task.timeout,</span><br><span class="line">                                 retries=task.retries,</span><br><span class="line">                                 **task.kwargs)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.task_results[task.<span class="built_in">id</span>] = &#123;</span><br><span class="line">                    <span class="string">&quot;status&quot;</span>: <span class="string">&quot;failed&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e),</span><br><span class="line">                    <span class="string">&quot;duration&quot;</span>: time.time() - task_start</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                self.task_stats[<span class="string">&quot;failed&quot;</span>] += <span class="number">1</span></span><br><span class="line">                logger.error(<span class="string">f&quot;Task <span class="subst">&#123;task.<span class="built_in">id</span>&#125;</span> failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            self.tasks_in_progress.remove(task.<span class="built_in">id</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_task_result</span>(<span class="params">self, task_id: <span class="built_in">str</span>, wait: <span class="built_in">bool</span> = <span class="literal">False</span>, timeout: <span class="built_in">float</span> = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–ä»»åŠ¡ç»“æœ&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> wait <span class="keyword">and</span> task_id <span class="keyword">in</span> self.tasks_in_progress:</span><br><span class="line">            <span class="comment"># ç­‰å¾…ä»»åŠ¡å®Œæˆ</span></span><br><span class="line">            start_time = time.time()</span><br><span class="line">            <span class="keyword">while</span> task_id <span class="keyword">in</span> self.tasks_in_progress:</span><br><span class="line">                <span class="keyword">if</span> timeout <span class="keyword">and</span> (time.time() - start_time) &gt; timeout:</span><br><span class="line">                    <span class="keyword">raise</span> asyncio.TimeoutError(<span class="string">f&quot;Timeout waiting for task <span class="subst">&#123;task_id&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">await</span> asyncio.sleep(<span class="number">0.1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> self.task_results.get(task_id)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_monitor_system</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ç›‘æ§ç³»ç»ŸçŠ¶æ€&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">while</span> self._running:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># æ”¶é›†ç³»ç»ŸæŒ‡æ ‡</span></span><br><span class="line">                metrics = &#123;</span><br><span class="line">                    <span class="string">&quot;queue_sizes&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;high&quot;</span>: self.high_priority_queue.qsize(),</span><br><span class="line">                        <span class="string">&quot;normal&quot;</span>: self.normal_priority_queue.qsize(),</span><br><span class="line">                        <span class="string">&quot;low&quot;</span>: self.low_priority_queue.qsize()</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="string">&quot;tasks_in_progress&quot;</span>: <span class="built_in">len</span>(self.tasks_in_progress),</span><br><span class="line">                    <span class="string">&quot;task_stats&quot;</span>: self.task_stats.copy()</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># è®¡ç®—å¹³å‡å¤„ç†æ—¶é—´</span></span><br><span class="line">                <span class="keyword">if</span> self.task_stats[<span class="string">&quot;completed&quot;</span>] &gt; <span class="number">0</span>:</span><br><span class="line">                    avg_time = self.task_stats[<span class="string">&quot;total_time&quot;</span>] / self.task_stats[<span class="string">&quot;completed&quot;</span>]</span><br><span class="line">                    metrics[<span class="string">&quot;avg_processing_time&quot;</span>] = avg_time</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½</span></span><br><span class="line">                total_queue_size = <span class="built_in">sum</span>(metrics[<span class="string">&quot;queue_sizes&quot;</span>].values())</span><br><span class="line">                load_percentage = (total_queue_size / self.max_queue_size) * <span class="number">100</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> load_percentage &gt; <span class="number">80</span>:</span><br><span class="line">                    logger.warning(<span class="string">f&quot;High system load: <span class="subst">&#123;load_percentage:<span class="number">.1</span>f&#125;</span>%&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># æ¯10ç§’è®°å½•ä¸€æ¬¡</span></span><br><span class="line">                <span class="keyword">await</span> asyncio.sleep(<span class="number">10</span>)</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">except</span> asyncio.CancelledError:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logger.error(<span class="string">f&quot;Monitor error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">await</span> asyncio.sleep(<span class="number">10</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_stats</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–ç»Ÿè®¡ä¿¡æ¯&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;task_stats&quot;</span>: self.task_stats,</span><br><span class="line">            <span class="string">&quot;queue_status&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;high_priority&quot;</span>: self.high_priority_queue.qsize(),</span><br><span class="line">                <span class="string">&quot;normal_priority&quot;</span>: self.normal_priority_queue.qsize(),</span><br><span class="line">                <span class="string">&quot;low_priority&quot;</span>: self.low_priority_queue.qsize()</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;workers&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;thread_pool&quot;</span>: self.thread_pool._max_workers,</span><br><span class="line">                <span class="string">&quot;process_pool&quot;</span>: self.process_pool._max_workers,</span><br><span class="line">                <span class="string">&quot;active_tasks&quot;</span>: <span class="built_in">len</span>(self.tasks_in_progress)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-AIèƒ½åŠ›å¢å¼º"><a href="#2-AIèƒ½åŠ›å¢å¼º" class="headerlink" title="2. AIèƒ½åŠ›å¢å¼º"></a>2. AIèƒ½åŠ›å¢å¼º</h3><h4 id="2-1-å¤šæ¨¡å‹è·¯ç”±ç³»ç»Ÿ"><a href="#2-1-å¤šæ¨¡å‹è·¯ç”±ç³»ç»Ÿ" class="headerlink" title="2.1 å¤šæ¨¡å‹è·¯ç”±ç³»ç»Ÿ"></a>2.1 å¤šæ¨¡å‹è·¯ç”±ç³»ç»Ÿ</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/core/model_router.py</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Optional</span>, <span class="type">Any</span>, <span class="type">Tuple</span></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics.pairwise <span class="keyword">import</span> cosine_similarity</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelType</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ¨¡å‹ç±»å‹&quot;&quot;&quot;</span></span><br><span class="line">    GPT_4 = <span class="string">&quot;gpt-4&quot;</span></span><br><span class="line">    GPT_3_5_TURBO = <span class="string">&quot;gpt-3.5-turbo&quot;</span></span><br><span class="line">    CLAUDE_3 = <span class="string">&quot;claude-3&quot;</span></span><br><span class="line">    LOCAL_LLAMA = <span class="string">&quot;llama-2&quot;</span></span><br><span class="line">    EMBEDDING = <span class="string">&quot;embedding&quot;</span></span><br><span class="line">    SENTIMENT = <span class="string">&quot;sentiment&quot;</span></span><br><span class="line">    CLASSIFICATION = <span class="string">&quot;classification&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelInfo</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ¨¡å‹ä¿¡æ¯&quot;&quot;&quot;</span></span><br><span class="line">    model_id: <span class="built_in">str</span></span><br><span class="line">    model_type: ModelType</span><br><span class="line">    provider: <span class="built_in">str</span></span><br><span class="line">    cost_per_token: <span class="built_in">float</span></span><br><span class="line">    max_tokens: <span class="built_in">int</span></span><br><span class="line">    capabilities: <span class="type">List</span>[<span class="built_in">str</span>]</span><br><span class="line">    latency_ms: <span class="built_in">float</span></span><br><span class="line">    accuracy_score: <span class="built_in">float</span></span><br><span class="line">    is_available: <span class="built_in">bool</span> = <span class="literal">True</span></span><br><span class="line">    rate_limit: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelRouter</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ™ºèƒ½æ¨¡å‹è·¯ç”±ç³»ç»Ÿ&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.models: <span class="type">Dict</span>[<span class="built_in">str</span>, ModelInfo] = &#123;&#125;</span><br><span class="line">        self.model_metrics = &#123;&#125;</span><br><span class="line">        self.model_weights = &#123;&#125;</span><br><span class="line">        self.conversation_contexts = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–æ¨¡å‹</span></span><br><span class="line">        self._init_models()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è´Ÿè½½å‡è¡¡é…ç½®</span></span><br><span class="line">        self.load_balancing_strategy = <span class="string">&quot;weighted_round_robin&quot;</span></span><br><span class="line">        self.fallback_strategy = <span class="string">&quot;best_available&quot;</span></span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">&quot;ModelRouter initialized&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_init_models</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆå§‹åŒ–å¯ç”¨æ¨¡å‹&quot;&quot;&quot;</span></span><br><span class="line">        self.models = &#123;</span><br><span class="line">            <span class="string">&quot;gpt-4&quot;</span>: ModelInfo(</span><br><span class="line">                model_id=<span class="string">&quot;gpt-4&quot;</span>,</span><br><span class="line">                model_type=ModelType.GPT_4,</span><br><span class="line">                provider=<span class="string">&quot;openai&quot;</span>,</span><br><span class="line">                cost_per_token=<span class="number">0.03</span> / <span class="number">1000</span>,  <span class="comment"># æ¯åƒtokenæˆæœ¬</span></span><br><span class="line">                max_tokens=<span class="number">8192</span>,</span><br><span class="line">                capabilities=[<span class="string">&quot;text_generation&quot;</span>, <span class="string">&quot;reasoning&quot;</span>, <span class="string">&quot;coding&quot;</span>, <span class="string">&quot;analysis&quot;</span>],</span><br><span class="line">                latency_ms=<span class="number">2000</span>,</span><br><span class="line">                accuracy_score=<span class="number">0.95</span>,</span><br><span class="line">                rate_limit=&#123;<span class="string">&quot;rpm&quot;</span>: <span class="number">10000</span>, <span class="string">&quot;tpm&quot;</span>: <span class="number">40000</span>&#125;</span><br><span class="line">            ),</span><br><span class="line">            <span class="string">&quot;gpt-3.5-turbo&quot;</span>: ModelInfo(</span><br><span class="line">                model_id=<span class="string">&quot;gpt-3.5-turbo&quot;</span>,</span><br><span class="line">                model_type=ModelType.GPT_3_5_TURBO,</span><br><span class="line">                provider=<span class="string">&quot;openai&quot;</span>,</span><br><span class="line">                cost_per_token=<span class="number">0.002</span> / <span class="number">1000</span>,</span><br><span class="line">                max_tokens=<span class="number">4096</span>,</span><br><span class="line">                capabilities=[<span class="string">&quot;text_generation&quot;</span>, <span class="string">&quot;conversation&quot;</span>, <span class="string">&quot;summarization&quot;</span>],</span><br><span class="line">                latency_ms=<span class="number">800</span>,</span><br><span class="line">                accuracy_score=<span class="number">0.85</span>,</span><br><span class="line">                rate_limit=&#123;<span class="string">&quot;rpm&quot;</span>: <span class="number">3500</span>, <span class="string">&quot;tpm&quot;</span>: <span class="number">90000</span>&#125;</span><br><span class="line">            ),</span><br><span class="line">            <span class="string">&quot;llama-2-7b&quot;</span>: ModelInfo(</span><br><span class="line">                model_id=<span class="string">&quot;llama-2-7b&quot;</span>,</span><br><span class="line">                model_type=ModelType.LOCAL_LLAMA,</span><br><span class="line">                provider=<span class="string">&quot;local&quot;</span>,</span><br><span class="line">                cost_per_token=<span class="number">0.0</span>,</span><br><span class="line">                max_tokens=<span class="number">4096</span>,</span><br><span class="line">                capabilities=[<span class="string">&quot;text_generation&quot;</span>, <span class="string">&quot;qa&quot;</span>],</span><br><span class="line">                latency_ms=<span class="number">1500</span>,</span><br><span class="line">                accuracy_score=<span class="number">0.75</span></span><br><span class="line">            ),</span><br><span class="line">            <span class="string">&quot;claude-3-sonnet&quot;</span>: ModelInfo(</span><br><span class="line">                model_id=<span class="string">&quot;claude-3-sonnet&quot;</span>,</span><br><span class="line">                model_type=ModelType.CLAUDE_3,</span><br><span class="line">                provider=<span class="string">&quot;anthropic&quot;</span>,</span><br><span class="line">                cost_per_token=<span class="number">0.003</span> / <span class="number">1000</span>,</span><br><span class="line">                max_tokens=<span class="number">200000</span>,</span><br><span class="line">                capabilities=[<span class="string">&quot;text_generation&quot;</span>, <span class="string">&quot;long_context&quot;</span>, <span class="string">&quot;analysis&quot;</span>],</span><br><span class="line">                latency_ms=<span class="number">2500</span>,</span><br><span class="line">                accuracy_score=<span class="number">0.90</span>,</span><br><span class="line">                rate_limit=&#123;<span class="string">&quot;rpm&quot;</span>: <span class="number">5000</span>&#125;</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–æ¨¡å‹æƒé‡</span></span><br><span class="line">        <span class="keyword">for</span> model_id <span class="keyword">in</span> self.models:</span><br><span class="line">            self.model_weights[model_id] = <span class="number">1.0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">select_model</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                          task_type: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                          context: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>],</span></span><br><span class="line"><span class="params">                          constraints: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = <span class="literal">None</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        æ™ºèƒ½é€‰æ‹©æ¨¡å‹</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            task_type: ä»»åŠ¡ç±»å‹</span></span><br><span class="line"><span class="string">            context: ä¸Šä¸‹æ–‡ä¿¡æ¯</span></span><br><span class="line"><span class="string">            constraints: çº¦æŸæ¡ä»¶ï¼ˆé¢„ç®—ã€å»¶è¿Ÿç­‰ï¼‰</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            é€‰æ‹©çš„æ¨¡å‹ID</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> constraints <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            constraints = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è¿‡æ»¤å¯ç”¨æ¨¡å‹</span></span><br><span class="line">        available_models = self._get_available_models()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> available_models:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;No models available&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ ¹æ®ä»»åŠ¡ç±»å‹è¿‡æ»¤</span></span><br><span class="line">        task_specific_models = self._filter_by_task_type(available_models, task_type)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> task_specific_models:</span><br><span class="line">            logger.warning(<span class="string">f&quot;No models for task type <span class="subst">&#123;task_type&#125;</span>, using all available&quot;</span>)</span><br><span class="line">            task_specific_models = available_models</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åº”ç”¨çº¦æŸæ¡ä»¶</span></span><br><span class="line">        constrained_models = self._apply_constraints(task_specific_models, constraints)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> constrained_models:</span><br><span class="line">            logger.warning(<span class="string">&quot;No models meet constraints, relaxing constraints&quot;</span>)</span><br><span class="line">            constrained_models = task_specific_models</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># é€‰æ‹©æœ€ä½³æ¨¡å‹</span></span><br><span class="line">        selected_model = self._select_best_model(constrained_models, context, constraints)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®°å½•é€‰æ‹©</span></span><br><span class="line">        self._record_model_selection(selected_model, task_type, context)</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">f&quot;Selected model <span class="subst">&#123;selected_model&#125;</span> for task <span class="subst">&#123;task_type&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> selected_model</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_available_models</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[ModelInfo]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–å¯ç”¨æ¨¡å‹&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> [model <span class="keyword">for</span> model <span class="keyword">in</span> self.models.values() <span class="keyword">if</span> model.is_available]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_filter_by_task_type</span>(<span class="params">self, models: <span class="type">List</span>[ModelInfo], task_type: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[ModelInfo]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ ¹æ®ä»»åŠ¡ç±»å‹è¿‡æ»¤æ¨¡å‹&quot;&quot;&quot;</span></span><br><span class="line">        task_to_capabilities = &#123;</span><br><span class="line">            <span class="string">&quot;conversation&quot;</span>: [<span class="string">&quot;text_generation&quot;</span>, <span class="string">&quot;conversation&quot;</span>],</span><br><span class="line">            <span class="string">&quot;reasoning&quot;</span>: [<span class="string">&quot;reasoning&quot;</span>, <span class="string">&quot;analysis&quot;</span>],</span><br><span class="line">            <span class="string">&quot;coding&quot;</span>: [<span class="string">&quot;coding&quot;</span>],</span><br><span class="line">            <span class="string">&quot;summarization&quot;</span>: [<span class="string">&quot;text_generation&quot;</span>, <span class="string">&quot;summarization&quot;</span>],</span><br><span class="line">            <span class="string">&quot;analysis&quot;</span>: [<span class="string">&quot;analysis&quot;</span>],</span><br><span class="line">            <span class="string">&quot;creative&quot;</span>: [<span class="string">&quot;text_generation&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        required_capabilities = task_to_capabilities.get(task_type, [<span class="string">&quot;text_generation&quot;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            model <span class="keyword">for</span> model <span class="keyword">in</span> models</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">any</span>(cap <span class="keyword">in</span> model.capabilities <span class="keyword">for</span> cap <span class="keyword">in</span> required_capabilities)</span><br><span class="line">        ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_apply_constraints</span>(<span class="params">self, models: <span class="type">List</span>[ModelInfo], constraints: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">List</span>[ModelInfo]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åº”ç”¨çº¦æŸæ¡ä»¶&quot;&quot;&quot;</span></span><br><span class="line">        filtered_models = models</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># é¢„ç®—çº¦æŸ</span></span><br><span class="line">        max_cost = constraints.get(<span class="string">&quot;max_cost&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> max_cost <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># å‡è®¾æ¯ä»»åŠ¡å¹³å‡tokenæ•°</span></span><br><span class="line">            avg_tokens = constraints.get(<span class="string">&quot;avg_tokens&quot;</span>, <span class="number">100</span>)</span><br><span class="line">            filtered_models = [</span><br><span class="line">                m <span class="keyword">for</span> m <span class="keyword">in</span> filtered_models</span><br><span class="line">                <span class="keyword">if</span> m.cost_per_token * avg_tokens &lt;= max_cost</span><br><span class="line">            ]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å»¶è¿Ÿçº¦æŸ</span></span><br><span class="line">        max_latency = constraints.get(<span class="string">&quot;max_latency_ms&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> max_latency <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            filtered_models = [</span><br><span class="line">                m <span class="keyword">for</span> m <span class="keyword">in</span> filtered_models</span><br><span class="line">                <span class="keyword">if</span> m.latency_ms &lt;= max_latency</span><br><span class="line">            ]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># tokené•¿åº¦çº¦æŸ</span></span><br><span class="line">        max_tokens_needed = constraints.get(<span class="string">&quot;max_tokens_needed&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> max_tokens_needed <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            filtered_models = [</span><br><span class="line">                m <span class="keyword">for</span> m <span class="keyword">in</span> filtered_models</span><br><span class="line">                <span class="keyword">if</span> m.max_tokens &gt;= max_tokens_needed</span><br><span class="line">            ]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> filtered_models</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_select_best_model</span>(<span class="params">self, models: <span class="type">List</span>[ModelInfo], </span></span><br><span class="line"><span class="params">                          context: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>],</span></span><br><span class="line"><span class="params">                          constraints: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;é€‰æ‹©æœ€ä½³æ¨¡å‹&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> models:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;No models to select from&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è¯„åˆ†å‡½æ•°</span></span><br><span class="line">        scores = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> model <span class="keyword">in</span> models:</span><br><span class="line">            score = self._calculate_model_score(model, context, constraints)</span><br><span class="line">            scores[model.model_id] = score</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ·»åŠ æƒé‡éšæœºæ€§</span></span><br><span class="line">        <span class="keyword">for</span> model_id, score <span class="keyword">in</span> scores.items():</span><br><span class="line">            weight = self.model_weights.get(model_id, <span class="number">1.0</span>)</span><br><span class="line">            <span class="comment"># æ·»åŠ ä¸€äº›éšæœºæ€§é¿å…æ€»æ˜¯é€‰æ‹©åŒä¸€ä¸ªæ¨¡å‹</span></span><br><span class="line">            random_factor = np.random.uniform(<span class="number">0.95</span>, <span class="number">1.05</span>)</span><br><span class="line">            scores[model_id] = score * weight * random_factor</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># é€‰æ‹©æœ€é«˜åˆ†çš„æ¨¡å‹</span></span><br><span class="line">        selected_model = <span class="built_in">max</span>(scores.items(), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>])[<span class="number">0</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> selected_model</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_calculate_model_score</span>(<span class="params">self, model: ModelInfo, </span></span><br><span class="line"><span class="params">                              context: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>],</span></span><br><span class="line"><span class="params">                              constraints: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è®¡ç®—æ¨¡å‹å¾—åˆ†&quot;&quot;&quot;</span></span><br><span class="line">        score = <span class="number">0.0</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å‡†ç¡®åº¦åˆ†æ•°ï¼ˆ0-100ï¼‰</span></span><br><span class="line">        score += model.accuracy_score * <span class="number">40</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æˆæœ¬åˆ†æ•°ï¼ˆè¶Šä½è¶Šå¥½ï¼‰</span></span><br><span class="line">        avg_tokens = constraints.get(<span class="string">&quot;avg_tokens&quot;</span>, <span class="number">100</span>)</span><br><span class="line">        cost_score = <span class="built_in">max</span>(<span class="number">0</span>, <span class="number">1</span> - (model.cost_per_token * avg_tokens * <span class="number">1000</span>))</span><br><span class="line">        score += cost_score * <span class="number">30</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å»¶è¿Ÿåˆ†æ•°ï¼ˆè¶Šä½è¶Šå¥½ï¼‰</span></span><br><span class="line">        latency_score = <span class="built_in">max</span>(<span class="number">0</span>, <span class="number">1</span> - (model.latency_ms / <span class="number">5000</span>))</span><br><span class="line">        score += latency_score * <span class="number">20</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å¯é æ€§åˆ†æ•°ï¼ˆåŸºäºå†å²æˆåŠŸç‡ï¼‰</span></span><br><span class="line">        model_history = self.model_metrics.get(model.model_id, &#123;&#125;)</span><br><span class="line">        success_rate = model_history.get(<span class="string">&quot;success_rate&quot;</span>, <span class="number">0.9</span>)</span><br><span class="line">        score += success_rate * <span class="number">10</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ä¸Šä¸‹æ–‡é•¿åº¦é€‚åº”æ€§</span></span><br><span class="line">        context_length = <span class="built_in">len</span>(json.dumps(context))</span><br><span class="line">        token_ratio = <span class="built_in">min</span>(<span class="number">1.0</span>, context_length / (model.max_tokens * <span class="number">4</span>))</span><br><span class="line">        score += token_ratio * <span class="number">5</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> score</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_record_model_selection</span>(<span class="params">self, model_id: <span class="built_in">str</span>, task_type: <span class="built_in">str</span>, context: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è®°å½•æ¨¡å‹é€‰æ‹©&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> model_id <span class="keyword">not</span> <span class="keyword">in</span> self.model_metrics:</span><br><span class="line">            self.model_metrics[model_id] = &#123;</span><br><span class="line">                <span class="string">&quot;selections&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;successes&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;failures&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;total_latency&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;task_types&quot;</span>: &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        metrics = self.model_metrics[model_id]</span><br><span class="line">        metrics[<span class="string">&quot;selections&quot;</span>] += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> task_type <span class="keyword">not</span> <span class="keyword">in</span> metrics[<span class="string">&quot;task_types&quot;</span>]:</span><br><span class="line">            metrics[<span class="string">&quot;task_types&quot;</span>][task_type] = <span class="number">0</span></span><br><span class="line">        metrics[<span class="string">&quot;task_types&quot;</span>][task_type] += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_model_metrics</span>(<span class="params">self, model_id: <span class="built_in">str</span>, success: <span class="built_in">bool</span>, latency_ms: <span class="built_in">float</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ›´æ–°æ¨¡å‹æŒ‡æ ‡&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> model_id <span class="keyword">not</span> <span class="keyword">in</span> self.model_metrics:</span><br><span class="line">            self.model_metrics[model_id] = &#123;</span><br><span class="line">                <span class="string">&quot;selections&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;successes&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;failures&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;total_latency&quot;</span>: <span class="number">0</span></span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        metrics = self.model_metrics[model_id]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> success:</span><br><span class="line">            metrics[<span class="string">&quot;successes&quot;</span>] += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            metrics[<span class="string">&quot;failures&quot;</span>] += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        metrics[<span class="string">&quot;total_latency&quot;</span>] += latency_ms</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®¡ç®—æˆåŠŸç‡</span></span><br><span class="line">        total = metrics[<span class="string">&quot;successes&quot;</span>] + metrics[<span class="string">&quot;failures&quot;</span>]</span><br><span class="line">        <span class="keyword">if</span> total &gt; <span class="number">0</span>:</span><br><span class="line">            metrics[<span class="string">&quot;success_rate&quot;</span>] = metrics[<span class="string">&quot;successes&quot;</span>] / total</span><br><span class="line">            metrics[<span class="string">&quot;avg_latency&quot;</span>] = metrics[<span class="string">&quot;total_latency&quot;</span>] / total</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åŠ¨æ€è°ƒæ•´æƒé‡</span></span><br><span class="line">        self._adjust_model_weight(model_id, success, latency_ms)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_adjust_model_weight</span>(<span class="params">self, model_id: <span class="built_in">str</span>, success: <span class="built_in">bool</span>, latency_ms: <span class="built_in">float</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åŠ¨æ€è°ƒæ•´æ¨¡å‹æƒé‡&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> model_id <span class="keyword">not</span> <span class="keyword">in</span> self.model_weights:</span><br><span class="line">            self.model_weights[model_id] = <span class="number">1.0</span></span><br><span class="line">        </span><br><span class="line">        weight = self.model_weights[model_id]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> success:</span><br><span class="line">            <span class="comment"># æˆåŠŸå¢åŠ æƒé‡ï¼Œä½†è€ƒè™‘å»¶è¿Ÿ</span></span><br><span class="line">            latency_factor = <span class="built_in">max</span>(<span class="number">0.5</span>, <span class="built_in">min</span>(<span class="number">1.5</span>, <span class="number">1000</span> / latency_ms))</span><br><span class="line">            new_weight = weight * <span class="number">1.05</span> * latency_factor</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># å¤±è´¥å‡å°‘æƒé‡</span></span><br><span class="line">            new_weight = weight * <span class="number">0.8</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># é™åˆ¶æƒé‡èŒƒå›´</span></span><br><span class="line">        new_weight = <span class="built_in">max</span>(<span class="number">0.1</span>, <span class="built_in">min</span>(<span class="number">5.0</span>, new_weight))</span><br><span class="line">        </span><br><span class="line">        self.model_weights[model_id] = new_weight</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">route_request</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                           task_type: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                           prompt: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                           context: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                           constraints: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = <span class="literal">None</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·¯ç”±è¯·æ±‚åˆ°åˆé€‚çš„æ¨¡å‹&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> context <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            context = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># é€‰æ‹©æ¨¡å‹</span></span><br><span class="line">        model_id = <span class="keyword">await</span> self.select_model(task_type, context, constraints)</span><br><span class="line">        model_info = self.models[model_id]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ‰§è¡Œè¯·æ±‚</span></span><br><span class="line">        start_time = time.time()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># è¿™é‡Œè°ƒç”¨å®é™…çš„æ¨¡å‹æœåŠ¡</span></span><br><span class="line">            response = <span class="keyword">await</span> self._call_model_service(model_id, prompt, context)</span><br><span class="line">            latency_ms = (time.time() - start_time) * <span class="number">1000</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ›´æ–°æŒ‡æ ‡</span></span><br><span class="line">            <span class="keyword">await</span> self.update_model_metrics(model_id, <span class="literal">True</span>, latency_ms)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&quot;model&quot;</span>: model_id,</span><br><span class="line">                <span class="string">&quot;response&quot;</span>: response,</span><br><span class="line">                <span class="string">&quot;latency_ms&quot;</span>: latency_ms,</span><br><span class="line">                <span class="string">&quot;cost&quot;</span>: model_info.cost_per_token * <span class="built_in">len</span>(prompt) / <span class="number">4</span>  <span class="comment"># è¿‘ä¼¼tokenæ•°</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            latency_ms = (time.time() - start_time) * <span class="number">1000</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ›´æ–°æŒ‡æ ‡</span></span><br><span class="line">            <span class="keyword">await</span> self.update_model_metrics(model_id, <span class="literal">False</span>, latency_ms)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># å°è¯•å¤‡ç”¨æ¨¡å‹</span></span><br><span class="line">            logger.error(<span class="string">f&quot;Model <span class="subst">&#123;model_id&#125;</span> failed: <span class="subst">&#123;e&#125;</span>, trying fallback&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> self._fallback_request(task_type, prompt, context, constraints)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_call_model_service</span>(<span class="params">self, model_id: <span class="built_in">str</span>, prompt: <span class="built_in">str</span>, context: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è°ƒç”¨æ¨¡å‹æœåŠ¡&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># è¿™é‡Œåº”è¯¥å®ç°å®é™…çš„æ¨¡å‹è°ƒç”¨</span></span><br><span class="line">        <span class="comment"># ä¾‹å¦‚ï¼šè°ƒç”¨OpenAI APIã€æœ¬åœ°æ¨¡å‹ç­‰</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ¨¡æ‹Ÿå®ç°</span></span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(self.models[model_id].latency_ms / <span class="number">1000</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è¿”å›æ¨¡æ‹Ÿå“åº”</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Response from <span class="subst">&#123;model_id&#125;</span> for prompt: <span class="subst">&#123;prompt[:<span class="number">50</span>]&#125;</span>...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_fallback_request</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                               task_type: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                               prompt: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                               context: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>],</span></span><br><span class="line"><span class="params">                               constraints: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¤‡ç”¨è¯·æ±‚å¤„ç†&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># æ’é™¤å¤±è´¥çš„æ¨¡å‹</span></span><br><span class="line">        available_models = [</span><br><span class="line">            m <span class="keyword">for</span> m <span class="keyword">in</span> self._get_available_models()</span><br><span class="line">            <span class="keyword">if</span> m.model_id <span class="keyword">not</span> <span class="keyword">in</span> self.model_metrics <span class="keyword">or</span> </span><br><span class="line">               self.model_metrics[m.model_id].get(<span class="string">&quot;success_rate&quot;</span>, <span class="number">1.0</span>) &gt; <span class="number">0.5</span></span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> available_models:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;All models failed&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># é€‰æ‹©å¤‡ç”¨æ¨¡å‹</span></span><br><span class="line">        model_info = available_models[<span class="number">0</span>]</span><br><span class="line">        </span><br><span class="line">        start_time = time.time()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = <span class="keyword">await</span> self._call_model_service(model_info.model_id, prompt, context)</span><br><span class="line">            latency_ms = (time.time() - start_time) * <span class="number">1000</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">await</span> self.update_model_metrics(model_info.model_id, <span class="literal">True</span>, latency_ms)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&quot;model&quot;</span>: model_info.model_id,</span><br><span class="line">                <span class="string">&quot;response&quot;</span>: response,</span><br><span class="line">                <span class="string">&quot;latency_ms&quot;</span>: latency_ms,</span><br><span class="line">                <span class="string">&quot;cost&quot;</span>: model_info.cost_per_token * <span class="built_in">len</span>(prompt) / <span class="number">4</span>,</span><br><span class="line">                <span class="string">&quot;fallback&quot;</span>: <span class="literal">True</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            latency_ms = (time.time() - start_time) * <span class="number">1000</span></span><br><span class="line">            <span class="keyword">await</span> self.update_model_metrics(model_info.model_id, <span class="literal">False</span>, latency_ms)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;Fallback also failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_model_stats</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–æ¨¡å‹ç»Ÿè®¡ä¿¡æ¯&quot;&quot;&quot;</span></span><br><span class="line">        stats = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> model_id, model_info <span class="keyword">in</span> self.models.items():</span><br><span class="line">            metrics = self.model_metrics.get(model_id, &#123;&#125;)</span><br><span class="line">            </span><br><span class="line">            stats[model_id] = &#123;</span><br><span class="line">                <span class="string">&quot;provider&quot;</span>: model_info.provider,</span><br><span class="line">                <span class="string">&quot;capabilities&quot;</span>: model_info.capabilities,</span><br><span class="line">                <span class="string">&quot;latency_ms&quot;</span>: model_info.latency_ms,</span><br><span class="line">                <span class="string">&quot;accuracy&quot;</span>: model_info.accuracy_score,</span><br><span class="line">                <span class="string">&quot;cost_per_token&quot;</span>: model_info.cost_per_token,</span><br><span class="line">                <span class="string">&quot;is_available&quot;</span>: model_info.is_available,</span><br><span class="line">                <span class="string">&quot;weight&quot;</span>: self.model_weights.get(model_id, <span class="number">1.0</span>),</span><br><span class="line">                <span class="string">&quot;metrics&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;selections&quot;</span>: metrics.get(<span class="string">&quot;selections&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                    <span class="string">&quot;success_rate&quot;</span>: metrics.get(<span class="string">&quot;success_rate&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                    <span class="string">&quot;avg_latency&quot;</span>: metrics.get(<span class="string">&quot;avg_latency&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                    <span class="string">&quot;task_types&quot;</span>: metrics.get(<span class="string">&quot;task_types&quot;</span>, &#123;&#125;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> stats</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">train_model_selector</span>(<span class="params">self, training_data: <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è®­ç»ƒæ¨¡å‹é€‰æ‹©å™¨&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># è¿™é‡Œå¯ä»¥å®ç°åŸºäºå†å²æ•°æ®çš„æ¨¡å‹é€‰æ‹©å™¨è®­ç»ƒ</span></span><br><span class="line">        <span class="comment"># ä¾‹å¦‚ä½¿ç”¨æœºå™¨å­¦ä¹ æ¨¡å‹æ¥é¢„æµ‹æœ€ä½³æ¨¡å‹</span></span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">f&quot;Training model selector with <span class="subst">&#123;<span class="built_in">len</span>(training_data)&#125;</span> samples&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å®ç°ç‰¹å¾æå–å’Œæ¨¡å‹è®­ç»ƒ</span></span><br><span class="line">        <span class="comment"># è¿™åªæ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œå®é™…éœ€è¦å…·ä½“å®ç°</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ¨¡æ‹Ÿè®­ç»ƒè¿‡ç¨‹</span></span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">&quot;Model selector training completed&quot;</span>)</span><br></pre></td></tr></table></figure>



<h4 id="2-2-RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ç³»ç»Ÿ"><a href="#2-2-RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ç³»ç»Ÿ" class="headerlink" title="2.2 RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ç³»ç»Ÿ"></a>2.2 RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ç³»ç»Ÿ</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/core/rag_system.py</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Optional</span>, <span class="type">Any</span>, <span class="type">Tuple</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">import</span> chromadb</span><br><span class="line"><span class="keyword">from</span> chromadb.utils <span class="keyword">import</span> embedding_functions</span><br><span class="line"><span class="keyword">from</span> sentence_transformers <span class="keyword">import</span> SentenceTransformer</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> faiss</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Document</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ–‡æ¡£ç±»&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">str</span></span><br><span class="line">    content: <span class="built_in">str</span></span><br><span class="line">    metadata: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span><br><span class="line">    embedding: <span class="type">Optional</span>[<span class="type">List</span>[<span class="built_in">float</span>]] = <span class="literal">None</span></span><br><span class="line">    score: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RetrievalMethod</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ£€ç´¢æ–¹æ³•&quot;&quot;&quot;</span></span><br><span class="line">    VECTOR_SIMILARITY = <span class="string">&quot;vector_similarity&quot;</span></span><br><span class="line">    KEYWORD_MATCH = <span class="string">&quot;keyword_match&quot;</span></span><br><span class="line">    HYBRID = <span class="string">&quot;hybrid&quot;</span></span><br><span class="line">    SEMANTIC_SEARCH = <span class="string">&quot;semantic_search&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RAGSystem</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ£€ç´¢å¢å¼ºç”Ÿæˆç³»ç»Ÿ&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                 embedding_model: <span class="built_in">str</span> = <span class="string">&quot;paraphrase-multilingual-MiniLM-L12-v2&quot;</span>,</span></span><br><span class="line"><span class="params">                 vector_db_path: <span class="built_in">str</span> = <span class="string">&quot;./data/vector_db&quot;</span></span>):</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–åµŒå…¥æ¨¡å‹</span></span><br><span class="line">        self.embedding_model = SentenceTransformer(embedding_model)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–å‘é‡æ•°æ®åº“</span></span><br><span class="line">        self.chroma_client = chromadb.PersistentClient(path=vector_db_path)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åˆ›å»ºæˆ–è·å–é›†åˆ</span></span><br><span class="line">        self.collection = self.chroma_client.get_or_create_collection(</span><br><span class="line">            name=<span class="string">&quot;knowledge_base&quot;</span>,</span><br><span class="line">            embedding_function=embedding_functions.SentenceTransformerEmbeddingFunction(</span><br><span class="line">                model_name=embedding_model</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># FAISSç´¢å¼•ï¼ˆç”¨äºé«˜çº§æ£€ç´¢ï¼‰</span></span><br><span class="line">        self.faiss_index = <span class="literal">None</span></span><br><span class="line">        self.document_store = []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç¼“å­˜</span></span><br><span class="line">        self.cache = &#123;&#125;</span><br><span class="line">        self.cache_ttl = <span class="number">3600</span>  <span class="comment"># 1å°æ—¶</span></span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">f&quot;RAGSystem initialized with embedding model: <span class="subst">&#123;embedding_model&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">index_documents</span>(<span class="params">self, documents: <span class="type">List</span>[Document], batch_size: <span class="built_in">int</span> = <span class="number">100</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ç´¢å¼•æ–‡æ¡£&quot;&quot;&quot;</span></span><br><span class="line">        logger.info(<span class="string">f&quot;Indexing <span class="subst">&#123;<span class="built_in">len</span>(documents)&#125;</span> documents&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(documents), batch_size):</span><br><span class="line">            batch = documents[i:i+batch_size]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># ç”ŸæˆåµŒå…¥</span></span><br><span class="line">            contents = [doc.content <span class="keyword">for</span> doc <span class="keyword">in</span> batch]</span><br><span class="line">            embeddings = self.embedding_model.encode(contents)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># å‡†å¤‡æ•°æ®</span></span><br><span class="line">            ids = [doc.<span class="built_in">id</span> <span class="keyword">for</span> doc <span class="keyword">in</span> batch]</span><br><span class="line">            metadatas = [doc.metadata <span class="keyword">for</span> doc <span class="keyword">in</span> batch]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ·»åŠ åˆ°å‘é‡æ•°æ®åº“</span></span><br><span class="line">            self.collection.add(</span><br><span class="line">                embeddings=embeddings.tolist(),</span><br><span class="line">                documents=contents,</span><br><span class="line">                metadatas=metadatas,</span><br><span class="line">                ids=ids</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># åŒæ—¶æ·»åŠ åˆ°FAISSç´¢å¼•</span></span><br><span class="line">            <span class="keyword">await</span> self._update_faiss_index(embeddings, batch)</span><br><span class="line">            </span><br><span class="line">            logger.info(<span class="string">f&quot;Indexed batch <span class="subst">&#123;i//batch_size + <span class="number">1</span>&#125;</span>/<span class="subst">&#123;(<span class="built_in">len</span>(documents)+batch_size-<span class="number">1</span>)//batch_size&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">&quot;Document indexing completed&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_update_faiss_index</span>(<span class="params">self, embeddings: np.ndarray, documents: <span class="type">List</span>[Document]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ›´æ–°FAISSç´¢å¼•&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.faiss_index <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># åˆ›å»ºæ–°çš„FAISSç´¢å¼•</span></span><br><span class="line">            dimension = embeddings.shape[<span class="number">1</span>]</span><br><span class="line">            self.faiss_index = faiss.IndexFlatL2(dimension)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ·»åŠ åˆ°ç´¢å¼•</span></span><br><span class="line">        self.faiss_index.add(embeddings.astype(np.float32))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ä¿å­˜æ–‡æ¡£å¼•ç”¨</span></span><br><span class="line">        self.document_store.extend(documents)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">retrieve</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                      query: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                      top_k: <span class="built_in">int</span> = <span class="number">5</span>,</span></span><br><span class="line"><span class="params">                      method: RetrievalMethod = RetrievalMethod.HYBRID,</span></span><br><span class="line"><span class="params">                      filters: <span class="type">Optional</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]] = <span class="literal">None</span></span>) -&gt; <span class="type">List</span>[Document]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        æ£€ç´¢ç›¸å…³æ–‡æ¡£</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            query: æŸ¥è¯¢æ–‡æœ¬</span></span><br><span class="line"><span class="string">            top_k: è¿”å›æ•°é‡</span></span><br><span class="line"><span class="string">            method: æ£€ç´¢æ–¹æ³•</span></span><br><span class="line"><span class="string">            filters: è¿‡æ»¤æ¡ä»¶</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            ç›¸å…³æ–‡æ¡£åˆ—è¡¨</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># æ£€æŸ¥ç¼“å­˜</span></span><br><span class="line">        cache_key = self._get_cache_key(query, top_k, method, filters)</span><br><span class="line">        <span class="keyword">if</span> cache_key <span class="keyword">in</span> self.cache:</span><br><span class="line">            cached_time, results = self.cache[cache_key]</span><br><span class="line">            <span class="keyword">if</span> (datetime.now() - cached_time).total_seconds() &lt; self.cache_ttl:</span><br><span class="line">                logger.debug(<span class="string">f&quot;Cache hit for query: <span class="subst">&#123;query[:<span class="number">50</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> results</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ ¹æ®æ–¹æ³•æ£€ç´¢</span></span><br><span class="line">        <span class="keyword">if</span> method == RetrievalMethod.VECTOR_SIMILARITY:</span><br><span class="line">            results = <span class="keyword">await</span> self._vector_similarity_retrieval(query, top_k, filters)</span><br><span class="line">        <span class="keyword">elif</span> method == RetrievalMethod.KEYWORD_MATCH:</span><br><span class="line">            results = <span class="keyword">await</span> self._keyword_match_retrieval(query, top_k, filters)</span><br><span class="line">        <span class="keyword">elif</span> method == RetrievalMethod.HYBRID:</span><br><span class="line">            results = <span class="keyword">await</span> self._hybrid_retrieval(query, top_k, filters)</span><br><span class="line">        <span class="keyword">elif</span> method == RetrievalMethod.SEMANTIC_SEARCH:</span><br><span class="line">            results = <span class="keyword">await</span> self._semantic_search_retrieval(query, top_k, filters)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Unknown retrieval method: <span class="subst">&#123;method&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç¼“å­˜ç»“æœ</span></span><br><span class="line">        self.cache[cache_key] = (datetime.now(), results)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ¸…ç†è¿‡æœŸç¼“å­˜</span></span><br><span class="line">        <span class="keyword">await</span> self._cleanup_cache()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> results</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_vector_similarity_retrieval</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                                         query: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                                         top_k: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">                                         filters: <span class="type">Optional</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]</span>) -&gt; <span class="type">List</span>[Document]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å‘é‡ç›¸ä¼¼åº¦æ£€ç´¢&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ç”ŸæˆæŸ¥è¯¢åµŒå…¥</span></span><br><span class="line">        query_embedding = self.embedding_model.encode([query])[<span class="number">0</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ä½¿ç”¨FAISSè¿›è¡Œç›¸ä¼¼åº¦æœç´¢</span></span><br><span class="line">        <span class="keyword">if</span> self.faiss_index <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># FAISSæœç´¢</span></span><br><span class="line">            distances, indices = self.faiss_index.search(</span><br><span class="line">                np.array([query_embedding]).astype(np.float32), </span><br><span class="line">                top_k</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è·å–æ–‡æ¡£</span></span><br><span class="line">            results = []</span><br><span class="line">            <span class="keyword">for</span> idx, distance <span class="keyword">in</span> <span class="built_in">zip</span>(indices[<span class="number">0</span>], distances[<span class="number">0</span>]):</span><br><span class="line">                <span class="keyword">if</span> idx &lt; <span class="built_in">len</span>(self.document_store):</span><br><span class="line">                    doc = self.document_store[idx]</span><br><span class="line">                    doc.score = <span class="number">1.0</span> / (<span class="number">1.0</span> + distance)  <span class="comment"># è½¬æ¢ä¸ºç›¸ä¼¼åº¦åˆ†æ•°</span></span><br><span class="line">                    results.append(doc)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> results</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># ä½¿ç”¨ChromaDB</span></span><br><span class="line">            results = self.collection.query(</span><br><span class="line">                query_embeddings=[query_embedding.tolist()],</span><br><span class="line">                n_results=top_k,</span><br><span class="line">                where=filters</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> self._convert_chroma_results(results)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_keyword_match_retrieval</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                                      query: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                                      top_k: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">                                      filters: <span class="type">Optional</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]</span>) -&gt; <span class="type">List</span>[Document]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å…³é”®è¯åŒ¹é…æ£€ç´¢&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ç®€å•çš„å…³é”®è¯æå–ï¼ˆå®é™…åº”è¯¥ä½¿ç”¨æ›´é«˜çº§çš„æ–¹æ³•ï¼‰</span></span><br><span class="line">        keywords = <span class="built_in">set</span>(query.lower().split())</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åœ¨ChromaDBä¸­æœç´¢</span></span><br><span class="line">        results = self.collection.query(</span><br><span class="line">            query_texts=[query],</span><br><span class="line">            n_results=top_k * <span class="number">2</span>,  <span class="comment"># è·å–æ›´å¤šç»“æœç”¨äºè¿‡æ»¤</span></span><br><span class="line">            where=filters</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        documents = self._convert_chroma_results(results)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åŸºäºå…³é”®è¯åŒ¹é…è¯„åˆ†</span></span><br><span class="line">        scored_docs = []</span><br><span class="line">        <span class="keyword">for</span> doc <span class="keyword">in</span> documents:</span><br><span class="line">            score = self._calculate_keyword_score(doc.content, keywords)</span><br><span class="line">            <span class="keyword">if</span> score &gt; <span class="number">0</span>:</span><br><span class="line">                doc.score = score</span><br><span class="line">                scored_docs.append(doc)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æŒ‰åˆ†æ•°æ’åºå¹¶è¿”å›å‰top_kä¸ª</span></span><br><span class="line">        scored_docs.sort(key=<span class="keyword">lambda</span> x: x.score, reverse=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> scored_docs[:top_k]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_hybrid_retrieval</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                               query: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                               top_k: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">                               filters: <span class="type">Optional</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]</span>) -&gt; <span class="type">List</span>[Document]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ··åˆæ£€ç´¢&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># å¹¶è¡Œæ‰§è¡Œå¤šç§æ£€ç´¢</span></span><br><span class="line">        vector_task = asyncio.create_task(</span><br><span class="line">            self._vector_similarity_retrieval(query, top_k * <span class="number">2</span>, filters)</span><br><span class="line">        )</span><br><span class="line">        keyword_task = asyncio.create_task(</span><br><span class="line">            self._keyword_match_retrieval(query, top_k * <span class="number">2</span>, filters)</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        vector_results, keyword_results = <span class="keyword">await</span> asyncio.gather(vector_task, keyword_task)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åˆå¹¶å’Œé‡æ’åºç»“æœ</span></span><br><span class="line">        all_docs = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ”¶é›†æ‰€æœ‰æ–‡æ¡£ï¼Œè®°å½•å®ƒä»¬çš„åˆ†æ•°</span></span><br><span class="line">        <span class="keyword">for</span> doc <span class="keyword">in</span> vector_results:</span><br><span class="line">            <span class="keyword">if</span> doc.<span class="built_in">id</span> <span class="keyword">not</span> <span class="keyword">in</span> all_docs:</span><br><span class="line">                all_docs[doc.<span class="built_in">id</span>] = &#123;<span class="string">&quot;doc&quot;</span>: doc, <span class="string">&quot;scores&quot;</span>: []&#125;</span><br><span class="line">            all_docs[doc.<span class="built_in">id</span>][<span class="string">&quot;scores&quot;</span>].append(doc.score * <span class="number">0.7</span>)  <span class="comment"># å‘é‡æ£€ç´¢æƒé‡</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> doc <span class="keyword">in</span> keyword_results:</span><br><span class="line">            <span class="keyword">if</span> doc.<span class="built_in">id</span> <span class="keyword">not</span> <span class="keyword">in</span> all_docs:</span><br><span class="line">                all_docs[doc.<span class="built_in">id</span>] = &#123;<span class="string">&quot;doc&quot;</span>: doc, <span class="string">&quot;scores&quot;</span>: []&#125;</span><br><span class="line">            all_docs[doc.<span class="built_in">id</span>][<span class="string">&quot;scores&quot;</span>].append(doc.score * <span class="number">0.3</span>)  <span class="comment"># å…³é”®è¯æ£€ç´¢æƒé‡</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®¡ç®—ç»¼åˆåˆ†æ•°</span></span><br><span class="line">        scored_docs = []</span><br><span class="line">        <span class="keyword">for</span> doc_id, data <span class="keyword">in</span> all_docs.items():</span><br><span class="line">            doc = data[<span class="string">&quot;doc&quot;</span>]</span><br><span class="line">            <span class="keyword">if</span> data[<span class="string">&quot;scores&quot;</span>]:</span><br><span class="line">                doc.score = <span class="built_in">sum</span>(data[<span class="string">&quot;scores&quot;</span>]) / <span class="built_in">len</span>(data[<span class="string">&quot;scores&quot;</span>])</span><br><span class="line">            scored_docs.append(doc)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ’åºå¹¶è¿”å›</span></span><br><span class="line">        scored_docs.sort(key=<span class="keyword">lambda</span> x: x.score, reverse=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> scored_docs[:top_k]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_semantic_search_retrieval</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                                        query: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                                        top_k: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">                                        filters: <span class="type">Optional</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]</span>) -&gt; <span class="type">List</span>[Document]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è¯­ä¹‰æœç´¢æ£€ç´¢&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ä½¿ç”¨é«˜çº§è¯­ä¹‰æœç´¢æŠ€æœ¯</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 1. æŸ¥è¯¢æ‰©å±•</span></span><br><span class="line">        expanded_query = <span class="keyword">await</span> self._expand_query(query)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. å¤šå‘é‡æ£€ç´¢</span></span><br><span class="line">        queries = [query, expanded_query]</span><br><span class="line">        query_embeddings = self.embedding_model.encode(queries)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. ä½¿ç”¨FAISSè¿›è¡Œå¤šæŸ¥è¯¢æ£€ç´¢</span></span><br><span class="line">        <span class="keyword">if</span> self.faiss_index <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            distances, indices = self.faiss_index.search(</span><br><span class="line">                query_embeddings.astype(np.float32), </span><br><span class="line">                top_k * <span class="number">2</span></span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># åˆå¹¶å’Œå»é‡ç»“æœ</span></span><br><span class="line">            all_docs = &#123;&#125;</span><br><span class="line">            <span class="keyword">for</span> query_idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(queries)):</span><br><span class="line">                <span class="keyword">for</span> i, (idx, distance) <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="built_in">zip</span>(indices[query_idx], distances[query_idx])):</span><br><span class="line">                    <span class="keyword">if</span> idx &lt; <span class="built_in">len</span>(self.document_store):</span><br><span class="line">                        doc = self.document_store[idx]</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment"># åŠ æƒåˆ†æ•°ï¼ˆç¬¬ä¸€ä¸ªæŸ¥è¯¢æƒé‡æ›´é«˜ï¼‰</span></span><br><span class="line">                        weight = <span class="number">1.0</span> / (<span class="number">1.0</span> + query_idx * <span class="number">0.5</span>)</span><br><span class="line">                        score = weight * (<span class="number">1.0</span> / (<span class="number">1.0</span> + distance))</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">if</span> doc.<span class="built_in">id</span> <span class="keyword">not</span> <span class="keyword">in</span> all_docs:</span><br><span class="line">                            doc.score = score</span><br><span class="line">                            all_docs[doc.<span class="built_in">id</span>] = doc</span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            all_docs[doc.<span class="built_in">id</span>].score = <span class="built_in">max</span>(all_docs[doc.<span class="built_in">id</span>].score, score)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è½¬æ¢ä¸ºåˆ—è¡¨å¹¶æ’åº</span></span><br><span class="line">            results = <span class="built_in">list</span>(all_docs.values())</span><br><span class="line">            results.sort(key=<span class="keyword">lambda</span> x: x.score, reverse=<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">return</span> results[:top_k]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_expand_query</span>(<span class="params">self, query: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æŸ¥è¯¢æ‰©å±•&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># è¿™é‡Œå¯ä»¥å®ç°æŸ¥è¯¢æ‰©å±•é€»è¾‘</span></span><br><span class="line">        <span class="comment"># ä¾‹å¦‚ï¼šä½¿ç”¨åŒä¹‰è¯ã€ç›¸å…³æ¦‚å¿µç­‰</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç®€å•çš„å®ç°ï¼šæ·»åŠ å¸¸è§ç›¸å…³è¯</span></span><br><span class="line">        expansion_rules = &#123;</span><br><span class="line">            <span class="string">&quot;python&quot;</span>: [<span class="string">&quot;programming&quot;</span>, <span class="string">&quot;code&quot;</span>, <span class="string">&quot;development&quot;</span>],</span><br><span class="line">            <span class="string">&quot;æœºå™¨å­¦ä¹ &quot;</span>: [<span class="string">&quot;äººå·¥æ™ºèƒ½&quot;</span>, <span class="string">&quot;AI&quot;</span>, <span class="string">&quot;æ·±åº¦å­¦ä¹ &quot;</span>],</span><br><span class="line">            <span class="string">&quot;weather&quot;</span>: [<span class="string">&quot;temperature&quot;</span>, <span class="string">&quot;forecast&quot;</span>, <span class="string">&quot;climate&quot;</span>],</span><br><span class="line">            <span class="comment"># æ·»åŠ æ›´å¤šè§„åˆ™...</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        expanded = query</span><br><span class="line">        <span class="keyword">for</span> word, expansions <span class="keyword">in</span> expansion_rules.items():</span><br><span class="line">            <span class="keyword">if</span> word.lower() <span class="keyword">in</span> query.lower():</span><br><span class="line">                expanded += <span class="string">&quot; &quot;</span> + <span class="string">&quot; &quot;</span>.join(expansions)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> expanded</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_calculate_keyword_score</span>(<span class="params">self, text: <span class="built_in">str</span>, keywords: <span class="built_in">set</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è®¡ç®—å…³é”®è¯åŒ¹é…åˆ†æ•°&quot;&quot;&quot;</span></span><br><span class="line">        text_words = <span class="built_in">set</span>(text.lower().split())</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®¡ç®—äº¤é›†</span></span><br><span class="line">        intersection = keywords.intersection(text_words)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> keywords:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0.0</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åŸºç¡€åˆ†æ•°</span></span><br><span class="line">        base_score = <span class="built_in">len</span>(intersection) / <span class="built_in">len</span>(keywords)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è€ƒè™‘å…³é”®è¯é¢‘ç‡</span></span><br><span class="line">        freq_score = <span class="number">0.0</span></span><br><span class="line">        <span class="keyword">for</span> word <span class="keyword">in</span> intersection:</span><br><span class="line">            freq = text.lower().count(word)</span><br><span class="line">            freq_score += <span class="built_in">min</span>(freq, <span class="number">5</span>) / <span class="number">5.0</span>  <span class="comment"># é™åˆ¶æœ€å¤§å½±å“</span></span><br><span class="line">        </span><br><span class="line">        freq_score = freq_score / <span class="built_in">len</span>(keywords) <span class="keyword">if</span> keywords <span class="keyword">else</span> <span class="number">0.0</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç»¼åˆåˆ†æ•°</span></span><br><span class="line">        <span class="keyword">return</span> base_score * <span class="number">0.6</span> + freq_score * <span class="number">0.4</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_convert_chroma_results</span>(<span class="params">self, results: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">List</span>[Document]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è½¬æ¢ChromaDBç»“æœä¸ºDocumentå¯¹è±¡&quot;&quot;&quot;</span></span><br><span class="line">        documents = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> results[<span class="string">&quot;documents&quot;</span>]:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(results[<span class="string">&quot;documents&quot;</span>][<span class="number">0</span>])):</span><br><span class="line">                doc = Document(</span><br><span class="line">                    <span class="built_in">id</span>=results[<span class="string">&quot;ids&quot;</span>][<span class="number">0</span>][i],</span><br><span class="line">                    content=results[<span class="string">&quot;documents&quot;</span>][<span class="number">0</span>][i],</span><br><span class="line">                    metadata=results[<span class="string">&quot;metadatas&quot;</span>][<span class="number">0</span>][i] <span class="keyword">if</span> results[<span class="string">&quot;metadatas&quot;</span>] <span class="keyword">else</span> &#123;&#125;,</span><br><span class="line">                    score=results[<span class="string">&quot;distances&quot;</span>][<span class="number">0</span>][i] <span class="keyword">if</span> results.get(<span class="string">&quot;distances&quot;</span>) <span class="keyword">else</span> <span class="number">0.0</span></span><br><span class="line">                )</span><br><span class="line">                documents.append(doc)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> documents</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_cache_key</span>(<span class="params">self, query: <span class="built_in">str</span>, top_k: <span class="built_in">int</span>, method: RetrievalMethod, filters: <span class="type">Optional</span>[<span class="type">Dict</span>]</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ç”Ÿæˆç¼“å­˜é”®&quot;&quot;&quot;</span></span><br><span class="line">        key_data = &#123;</span><br><span class="line">            <span class="string">&quot;query&quot;</span>: query,</span><br><span class="line">            <span class="string">&quot;top_k&quot;</span>: top_k,</span><br><span class="line">            <span class="string">&quot;method&quot;</span>: method.value,</span><br><span class="line">            <span class="string">&quot;filters&quot;</span>: filters</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        key_str = json.dumps(key_data, sort_keys=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> hashlib.md5(key_str.encode()).hexdigest()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_cleanup_cache</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ¸…ç†è¿‡æœŸç¼“å­˜&quot;&quot;&quot;</span></span><br><span class="line">        current_time = datetime.now()</span><br><span class="line">        expired_keys = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> key, (cached_time, _) <span class="keyword">in</span> self.cache.items():</span><br><span class="line">            <span class="keyword">if</span> (current_time - cached_time).total_seconds() &gt; self.cache_ttl:</span><br><span class="line">                expired_keys.append(key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> expired_keys:</span><br><span class="line">            <span class="keyword">del</span> self.cache[key]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> expired_keys:</span><br><span class="line">            logger.debug(<span class="string">f&quot;Cleaned up <span class="subst">&#123;<span class="built_in">len</span>(expired_keys)&#125;</span> expired cache entries&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">generate_with_context</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                                   query: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                                   model: <span class="type">Any</span>,</span></span><br><span class="line"><span class="params">                                   top_k: <span class="built_in">int</span> = <span class="number">3</span>,</span></span><br><span class="line"><span class="params">                                   temperature: <span class="built_in">float</span> = <span class="number">0.7</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        åŸºäºæ£€ç´¢ç»“æœçš„ç”Ÿæˆ</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            query: æŸ¥è¯¢æ–‡æœ¬</span></span><br><span class="line"><span class="string">            model: ç”Ÿæˆæ¨¡å‹</span></span><br><span class="line"><span class="string">            top_k: æ£€ç´¢æ–‡æ¡£æ•°é‡</span></span><br><span class="line"><span class="string">            temperature: ç”Ÿæˆæ¸©åº¦</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            ç”Ÿæˆç»“æœ</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># æ£€ç´¢ç›¸å…³æ–‡æ¡£</span></span><br><span class="line">        relevant_docs = <span class="keyword">await</span> self.retrieve(query, top_k=top_k)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ„å»ºä¸Šä¸‹æ–‡</span></span><br><span class="line">        context = self._build_context(query, relevant_docs)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç”Ÿæˆå“åº”</span></span><br><span class="line">        response = <span class="keyword">await</span> model.generate(</span><br><span class="line">            prompt=context[<span class="string">&quot;prompt&quot;</span>],</span><br><span class="line">            temperature=temperature,</span><br><span class="line">            max_tokens=<span class="number">1000</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;response&quot;</span>: response,</span><br><span class="line">            <span class="string">&quot;context&quot;</span>: context,</span><br><span class="line">            <span class="string">&quot;relevant_docs&quot;</span>: relevant_docs,</span><br><span class="line">            <span class="string">&quot;retrieval_scores&quot;</span>: [doc.score <span class="keyword">for</span> doc <span class="keyword">in</span> relevant_docs]</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_build_context</span>(<span class="params">self, query: <span class="built_in">str</span>, documents: <span class="type">List</span>[Document]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ„å»ºç”Ÿæˆä¸Šä¸‹æ–‡&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># æ„å»ºç³»ç»Ÿæç¤º</span></span><br><span class="line">        system_prompt = <span class="string">&quot;&quot;&quot;ä½ æ˜¯ä¸€ä¸ªåŸºäºçŸ¥è¯†åº“çš„AIåŠ©æ‰‹ã€‚è¯·æ ¹æ®æä¾›çš„å‚è€ƒä¿¡æ¯å›ç­”é—®é¢˜ã€‚</span></span><br><span class="line"><span class="string">å¦‚æœå‚è€ƒä¿¡æ¯ä¸è¶³ä»¥å›ç­”é—®é¢˜ï¼Œè¯·è¯šå®åœ°è¯´æ˜ä½ ä¸çŸ¥é“ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">å‚è€ƒä¿¡æ¯ï¼š</span></span><br><span class="line"><span class="string">&#123;references&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">é—®é¢˜ï¼š&#123;query&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¯·åŸºäºå‚è€ƒä¿¡æ¯æä¾›å‡†ç¡®ã€æœ‰ç”¨çš„å›ç­”ï¼š&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ ¼å¼åŒ–å‚è€ƒä¿¡æ¯</span></span><br><span class="line">        references = []</span><br><span class="line">        <span class="keyword">for</span> i, doc <span class="keyword">in</span> <span class="built_in">enumerate</span>(documents, <span class="number">1</span>):</span><br><span class="line">            ref_text = <span class="string">f&quot;[å‚è€ƒ<span class="subst">&#123;i&#125;</span>] <span class="subst">&#123;doc.content&#125;</span>&quot;</span></span><br><span class="line">            <span class="keyword">if</span> doc.metadata.get(<span class="string">&quot;source&quot;</span>):</span><br><span class="line">                ref_text += <span class="string">f&quot; (æ¥æº: <span class="subst">&#123;doc.metadata[<span class="string">&#x27;source&#x27;</span>]&#125;</span>)&quot;</span></span><br><span class="line">            <span class="keyword">if</span> doc.score:</span><br><span class="line">                ref_text += <span class="string">f&quot; [ç›¸å…³æ€§: <span class="subst">&#123;doc.score:<span class="number">.2</span>f&#125;</span>]&quot;</span></span><br><span class="line">            references.append(ref_text)</span><br><span class="line">        </span><br><span class="line">        references_text = <span class="string">&quot;\n\n&quot;</span>.join(references)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ„å»ºæœ€ç»ˆæç¤º</span></span><br><span class="line">        prompt = system_prompt.<span class="built_in">format</span>(</span><br><span class="line">            references=references_text,</span><br><span class="line">            query=query</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ„å»ºå…ƒæ•°æ®</span></span><br><span class="line">        metadata = &#123;</span><br><span class="line">            <span class="string">&quot;query&quot;</span>: query,</span><br><span class="line">            <span class="string">&quot;num_references&quot;</span>: <span class="built_in">len</span>(documents),</span><br><span class="line">            <span class="string">&quot;avg_relevance&quot;</span>: np.mean([doc.score <span class="keyword">or</span> <span class="number">0</span> <span class="keyword">for</span> doc <span class="keyword">in</span> documents]) <span class="keyword">if</span> documents <span class="keyword">else</span> <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;references&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;id&quot;</span>: doc.<span class="built_in">id</span>,</span><br><span class="line">                    <span class="string">&quot;score&quot;</span>: doc.score,</span><br><span class="line">                    <span class="string">&quot;metadata&quot;</span>: doc.metadata</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> doc <span class="keyword">in</span> documents</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;prompt&quot;</span>: prompt,</span><br><span class="line">            <span class="string">&quot;metadata&quot;</span>: metadata,</span><br><span class="line">            <span class="string">&quot;references&quot;</span>: references_text</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_stats</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># è·å–é›†åˆç»Ÿè®¡</span></span><br><span class="line">        collection_count = self.collection.count()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è·å–ç¼“å­˜ç»Ÿè®¡</span></span><br><span class="line">        cache_stats = &#123;</span><br><span class="line">            <span class="string">&quot;size&quot;</span>: <span class="built_in">len</span>(self.cache),</span><br><span class="line">            <span class="string">&quot;hit_rate&quot;</span>: self._calculate_cache_hit_rate(),</span><br><span class="line">            <span class="string">&quot;oldest&quot;</span>: <span class="built_in">min</span>([t <span class="keyword">for</span> t, _ <span class="keyword">in</span> self.cache.values()]).isoformat() <span class="keyword">if</span> self.cache <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># FAISSç´¢å¼•ç»Ÿè®¡</span></span><br><span class="line">        faiss_stats = &#123;</span><br><span class="line">            <span class="string">&quot;has_index&quot;</span>: self.faiss_index <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&quot;size&quot;</span>: self.faiss_index.ntotal <span class="keyword">if</span> self.faiss_index <span class="keyword">else</span> <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;dimension&quot;</span>: self.faiss_index.d <span class="keyword">if</span> self.faiss_index <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;collection_count&quot;</span>: collection_count,</span><br><span class="line">            <span class="string">&quot;document_store_size&quot;</span>: <span class="built_in">len</span>(self.document_store),</span><br><span class="line">            <span class="string">&quot;cache_stats&quot;</span>: cache_stats,</span><br><span class="line">            <span class="string">&quot;faiss_stats&quot;</span>: faiss_stats,</span><br><span class="line">            <span class="string">&quot;embedding_model&quot;</span>: self.embedding_model._modules[<span class="string">&#x27;0&#x27;</span>].auto_model.config._name_or_path</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_calculate_cache_hit_rate</span>(<span class="params">self</span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è®¡ç®—ç¼“å­˜å‘½ä¸­ç‡ï¼ˆæ¨¡æ‹Ÿï¼‰&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># å®é™…åº”è¯¥è®°å½•å‘½ä¸­å’Œæœªå‘½ä¸­</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0.0</span>  <span class="comment"># ç®€åŒ–å®ç°</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">delete_document</span>(<span class="params">self, document_id: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆ é™¤æ–‡æ¡£&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ä»ChromaDBåˆ é™¤</span></span><br><span class="line">        self.collection.delete(ids=[document_id])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ä»FAISSç´¢å¼•å’Œæ–‡æ¡£å­˜å‚¨ä¸­åˆ é™¤</span></span><br><span class="line">        <span class="keyword">if</span> self.faiss_index <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># é‡å»ºç´¢å¼•ï¼ˆç®€åŒ–å¤„ç†ï¼‰</span></span><br><span class="line">            <span class="keyword">await</span> self._rebuild_faiss_index()</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">f&quot;Deleted document: <span class="subst">&#123;document_id&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_rebuild_faiss_index</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;é‡å»ºFAISSç´¢å¼•&quot;&quot;&quot;</span></span><br><span class="line">        logger.info(<span class="string">&quot;Rebuilding FAISS index...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ä»ChromaDBè·å–æ‰€æœ‰åµŒå…¥</span></span><br><span class="line">        all_data = self.collection.get(include=[<span class="string">&quot;embeddings&quot;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> all_data[<span class="string">&quot;embeddings&quot;</span>]:</span><br><span class="line">            embeddings = np.array(all_data[<span class="string">&quot;embeddings&quot;</span>])</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># åˆ›å»ºæ–°ç´¢å¼•</span></span><br><span class="line">            dimension = embeddings.shape[<span class="number">1</span>]</span><br><span class="line">            self.faiss_index = faiss.IndexFlatL2(dimension)</span><br><span class="line">            self.faiss_index.add(embeddings.astype(np.float32))</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># é‡å»ºæ–‡æ¡£å­˜å‚¨</span></span><br><span class="line">            self.document_store = []</span><br><span class="line">            <span class="keyword">for</span> i, doc_id <span class="keyword">in</span> <span class="built_in">enumerate</span>(all_data[<span class="string">&quot;ids&quot;</span>]):</span><br><span class="line">                doc = Document(</span><br><span class="line">                    <span class="built_in">id</span>=doc_id,</span><br><span class="line">                    content=all_data[<span class="string">&quot;documents&quot;</span>][i],</span><br><span class="line">                    metadata=all_data[<span class="string">&quot;metadatas&quot;</span>][i] <span class="keyword">if</span> all_data[<span class="string">&quot;metadatas&quot;</span>] <span class="keyword">else</span> &#123;&#125;</span><br><span class="line">                )</span><br><span class="line">                self.document_store.append(doc)</span><br><span class="line">            </span><br><span class="line">            logger.info(<span class="string">f&quot;FAISS index rebuilt with <span class="subst">&#123;<span class="built_in">len</span>(self.document_store)&#125;</span> documents&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">optimize_index</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ä¼˜åŒ–ç´¢å¼•&quot;&quot;&quot;</span></span><br><span class="line">        logger.info(<span class="string">&quot;Optimizing RAG system index...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 1. æ¸…ç†æ— æ•ˆæ–‡æ¡£</span></span><br><span class="line">        <span class="keyword">await</span> self._cleanup_invalid_documents()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. é‡å»ºFAISSç´¢å¼•</span></span><br><span class="line">        <span class="keyword">await</span> self._rebuild_faiss_index()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. æ¸…ç†ç¼“å­˜</span></span><br><span class="line">        self.cache.clear()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 4. è¿è¡Œåƒåœ¾å›æ”¶</span></span><br><span class="line">        <span class="keyword">import</span> gc</span><br><span class="line">        gc.collect()</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">&quot;RAG system optimization completed&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_cleanup_invalid_documents</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ¸…ç†æ— æ•ˆæ–‡æ¡£&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># è·å–æ‰€æœ‰æ–‡æ¡£</span></span><br><span class="line">        all_data = self.collection.get()</span><br><span class="line">        </span><br><span class="line">        invalid_ids = []</span><br><span class="line">        <span class="keyword">for</span> i, doc_id <span class="keyword">in</span> <span class="built_in">enumerate</span>(all_data[<span class="string">&quot;ids&quot;</span>]):</span><br><span class="line">            content = all_data[<span class="string">&quot;documents&quot;</span>][i]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ£€æŸ¥æ–‡æ¡£æœ‰æ•ˆæ€§</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> content <span class="keyword">or</span> <span class="built_in">len</span>(content.strip()) &lt; <span class="number">10</span>:</span><br><span class="line">                invalid_ids.append(doc_id)</span><br><span class="line">                logger.debug(<span class="string">f&quot;Marked document <span class="subst">&#123;doc_id&#125;</span> as invalid: content too short&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åˆ é™¤æ— æ•ˆæ–‡æ¡£</span></span><br><span class="line">        <span class="keyword">if</span> invalid_ids:</span><br><span class="line">            self.collection.delete(ids=invalid_ids)</span><br><span class="line">            logger.info(<span class="string">f&quot;Deleted <span class="subst">&#123;<span class="built_in">len</span>(invalid_ids)&#125;</span> invalid documents&quot;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="3-ç³»ç»Ÿæ¶æ„æ‰©å±•"><a href="#3-ç³»ç»Ÿæ¶æ„æ‰©å±•" class="headerlink" title="3. ç³»ç»Ÿæ¶æ„æ‰©å±•"></a>3. ç³»ç»Ÿæ¶æ„æ‰©å±•</h3><h4 id="3-1-å¾®æœåŠ¡æ¶æ„"><a href="#3-1-å¾®æœåŠ¡æ¶æ„" class="headerlink" title="3.1 å¾®æœåŠ¡æ¶æ„"></a>3.1 å¾®æœåŠ¡æ¶æ„</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># app/services/microservices/</span><br><span class="line"># ç”¨æˆ·æœåŠ¡</span><br><span class="line"># â”œâ”€â”€ user_service/</span><br><span class="line"># â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line"># â”‚   â”œâ”€â”€ api.py</span><br><span class="line"># â”‚   â”œâ”€â”€ models.py</span><br><span class="line"># â”‚   â””â”€â”€ service.py</span><br><span class="line"></span><br><span class="line"># èŠå¤©æœåŠ¡</span><br><span class="line"># â”œâ”€â”€ chat_service/</span><br><span class="line"># â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line"># â”‚   â”œâ”€â”€ api.py</span><br><span class="line"># â”‚   â”œâ”€â”€ models.py</span><br><span class="line"># â”‚   â””â”€â”€ service.py</span><br><span class="line"></span><br><span class="line"># AIæœåŠ¡</span><br><span class="line"># â”œâ”€â”€ ai_service/</span><br><span class="line"># â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line"># â”‚   â”œâ”€â”€ api.py</span><br><span class="line"># â”‚   â”œâ”€â”€ models.py</span><br><span class="line"># â”‚   â””â”€â”€ service.py</span><br><span class="line"></span><br><span class="line"># åˆ†ææœåŠ¡</span><br><span class="line"># â”œâ”€â”€ analytics_service/</span><br><span class="line"># â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line"># â”‚   â”œâ”€â”€ api.py</span><br><span class="line"># â”‚   â”œâ”€â”€ models.py</span><br><span class="line"># â”‚   â””â”€â”€ service.py</span><br><span class="line"></span><br><span class="line"># ç½‘å…³æœåŠ¡</span><br><span class="line"># app/gateway/</span><br><span class="line"># â”œâ”€â”€ __init__.py</span><br><span class="line"># â”œâ”€â”€ api_gateway.py</span><br><span class="line"># â”œâ”€â”€ load_balancer.py</span><br><span class="line"># â””â”€â”€ service_discovery.py</span><br></pre></td></tr></table></figure>



<h4 id="3-2-æœåŠ¡ç½‘æ ¼é…ç½®ç¤ºä¾‹"><a href="#3-2-æœåŠ¡ç½‘æ ¼é…ç½®ç¤ºä¾‹" class="headerlink" title="3.2 æœåŠ¡ç½‘æ ¼é…ç½®ç¤ºä¾‹"></a>3.2 æœåŠ¡ç½‘æ ¼é…ç½®ç¤ºä¾‹</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/gateway/api_gateway.py</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Any</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, HTTPException, Request, Response</span><br><span class="line"><span class="keyword">from</span> fastapi.middleware.cors <span class="keyword">import</span> CORSMiddleware</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urljoin</span><br><span class="line"><span class="keyword">import</span> redis.asyncio <span class="keyword">as</span> redis</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServiceRegistry</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æœåŠ¡æ³¨å†Œä¸­å¿ƒ&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client</span>):</span><br><span class="line">        self.redis = redis_client</span><br><span class="line">        self.services_key = <span class="string">&quot;service_registry&quot;</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">register_service</span>(<span class="params">self, service_name: <span class="built_in">str</span>, service_url: <span class="built_in">str</span>, metadata: <span class="type">Dict</span> = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ³¨å†ŒæœåŠ¡&quot;&quot;&quot;</span></span><br><span class="line">        service_data = &#123;</span><br><span class="line">            <span class="string">&quot;url&quot;</span>: service_url,</span><br><span class="line">            <span class="string">&quot;metadata&quot;</span>: metadata <span class="keyword">or</span> &#123;&#125;,</span><br><span class="line">            <span class="string">&quot;last_heartbeat&quot;</span>: time.time(),</span><br><span class="line">            <span class="string">&quot;status&quot;</span>: <span class="string">&quot;healthy&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">await</span> self.redis.hset(</span><br><span class="line">            self.services_key,</span><br><span class="line">            <span class="string">f&quot;<span class="subst">&#123;service_name&#125;</span>:<span class="subst">&#123;hashlib.md5(service_url.encode()).hexdigest()&#125;</span>&quot;</span>,</span><br><span class="line">            json.dumps(service_data)</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">f&quot;Service registered: <span class="subst">&#123;service_name&#125;</span> -&gt; <span class="subst">&#123;service_url&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_service_instances</span>(<span class="params">self, service_name: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–æœåŠ¡å®ä¾‹&quot;&quot;&quot;</span></span><br><span class="line">        instances = []</span><br><span class="line">        </span><br><span class="line">        all_services = <span class="keyword">await</span> self.redis.hgetall(self.services_key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> all_services.items():</span><br><span class="line">            <span class="keyword">if</span> key.startswith(service_name + <span class="string">&quot;:&quot;</span>):</span><br><span class="line">                service_data = json.loads(value)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€</span></span><br><span class="line">                <span class="keyword">if</span> time.time() - service_data[<span class="string">&quot;last_heartbeat&quot;</span>] &lt; <span class="number">60</span>:  <span class="comment"># å¿ƒè·³è¶…æ—¶60ç§’</span></span><br><span class="line">                    instances.append(service_data)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> instances</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">heartbeat</span>(<span class="params">self, service_name: <span class="built_in">str</span>, service_url: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æœåŠ¡å¿ƒè·³&quot;&quot;&quot;</span></span><br><span class="line">        service_key = <span class="string">f&quot;<span class="subst">&#123;service_name&#125;</span>:<span class="subst">&#123;hashlib.md5(service_url.encode()).hexdigest()&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        service_data_json = <span class="keyword">await</span> self.redis.hget(self.services_key, service_key)</span><br><span class="line">        <span class="keyword">if</span> service_data_json:</span><br><span class="line">            service_data = json.loads(service_data_json)</span><br><span class="line">            service_data[<span class="string">&quot;last_heartbeat&quot;</span>] = time.time()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">await</span> self.redis.hset(</span><br><span class="line">                self.services_key,</span><br><span class="line">                service_key,</span><br><span class="line">                json.dumps(service_data)</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">APIGateway</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;APIç½‘å…³&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.app = FastAPI(title=<span class="string">&quot;AI Chatbot API Gateway&quot;</span>)</span><br><span class="line">        self.service_registry = <span class="literal">None</span></span><br><span class="line">        self.load_balancer = RoundRobinLoadBalancer()</span><br><span class="line">        self.circuit_breakers = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®¾ç½®ä¸­é—´ä»¶</span></span><br><span class="line">        self._setup_middleware()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®¾ç½®è·¯ç”±</span></span><br><span class="line">        self._setup_routes()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å¯åŠ¨å¥åº·æ£€æŸ¥</span></span><br><span class="line">        asyncio.create_task(self._health_check_loop())</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_setup_middleware</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è®¾ç½®ä¸­é—´ä»¶&quot;&quot;&quot;</span></span><br><span class="line">        self.app.add_middleware(</span><br><span class="line">            CORSMiddleware,</span><br><span class="line">            allow_origins=[<span class="string">&quot;*&quot;</span>],</span><br><span class="line">            allow_credentials=<span class="literal">True</span>,</span><br><span class="line">            allow_methods=[<span class="string">&quot;*&quot;</span>],</span><br><span class="line">            allow_headers=[<span class="string">&quot;*&quot;</span>],</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶</span></span><br><span class="line"><span class="meta">        @self.app.middleware(<span class="params"><span class="string">&quot;http&quot;</span></span>)</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">log_requests</span>(<span class="params">request: Request, call_next</span>):</span><br><span class="line">            start_time = time.time()</span><br><span class="line">            </span><br><span class="line">            response = <span class="keyword">await</span> call_next(request)</span><br><span class="line">            </span><br><span class="line">            process_time = (time.time() - start_time) * <span class="number">1000</span></span><br><span class="line">            </span><br><span class="line">            logger.info(</span><br><span class="line">                <span class="string">f&quot;<span class="subst">&#123;request.method&#125;</span> <span class="subst">&#123;request.url.path&#125;</span> &quot;</span></span><br><span class="line">                <span class="string">f&quot;Status: <span class="subst">&#123;response.status_code&#125;</span> &quot;</span></span><br><span class="line">                <span class="string">f&quot;Duration: <span class="subst">&#123;process_time:<span class="number">.2</span>f&#125;</span>ms&quot;</span></span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># é™æµä¸­é—´ä»¶</span></span><br><span class="line"><span class="meta">        @self.app.middleware(<span class="params"><span class="string">&quot;http&quot;</span></span>)</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">rate_limit_middleware</span>(<span class="params">request: Request, call_next</span>):</span><br><span class="line">            client_ip = request.client.host</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># ç®€å•é™æµé€»è¾‘</span></span><br><span class="line">            rate_key = <span class="string">f&quot;rate_limit:<span class="subst">&#123;client_ip&#125;</span>&quot;</span></span><br><span class="line">            requests = <span class="keyword">await</span> self.service_registry.redis.incr(rate_key)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> requests == <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">await</span> self.service_registry.redis.expire(rate_key, <span class="number">60</span>)  <span class="comment"># 60ç§’çª—å£</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> requests &gt; <span class="number">100</span>:  <span class="comment"># æ¯åˆ†é’Ÿ100ä¸ªè¯·æ±‚</span></span><br><span class="line">                <span class="keyword">return</span> Response(</span><br><span class="line">                    content=json.dumps(&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Rate limit exceeded&quot;</span>&#125;),</span><br><span class="line">                    status_code=<span class="number">429</span>,</span><br><span class="line">                    media_type=<span class="string">&quot;application/json&quot;</span></span><br><span class="line">                )</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> call_next(request)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_setup_routes</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è®¾ç½®è·¯ç”±&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">        @self.app.get(<span class="params"><span class="string">&quot;/health&quot;</span></span>)</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">health_check</span>():</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;healthy&quot;</span>, <span class="string">&quot;timestamp&quot;</span>: time.time()&#125;</span><br><span class="line">        </span><br><span class="line"><span class="meta">        @self.app.api_route(<span class="params"><span class="string">&quot;/&#123;service_name&#125;/&#123;path:path&#125;&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>, <span class="string">&quot;PUT&quot;</span>, <span class="string">&quot;DELETE&quot;</span>]</span>)</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">proxy_request</span>(<span class="params">service_name: <span class="built_in">str</span>, path: <span class="built_in">str</span>, request: Request</span>):</span><br><span class="line">            <span class="string">&quot;&quot;&quot;ä»£ç†è¯·æ±‚åˆ°åç«¯æœåŠ¡&quot;&quot;&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è·å–æœåŠ¡å®ä¾‹</span></span><br><span class="line">            instances = <span class="keyword">await</span> self.service_registry.get_service_instances(service_name)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> instances:</span><br><span class="line">                <span class="keyword">raise</span> HTTPException(</span><br><span class="line">                    status_code=<span class="number">503</span>,</span><br><span class="line">                    detail=<span class="string">f&quot;Service <span class="subst">&#123;service_name&#125;</span> is unavailable&quot;</span></span><br><span class="line">                )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># é€‰æ‹©æœåŠ¡å®ä¾‹</span></span><br><span class="line">            selected_instance = self.load_balancer.select_instance(instances)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ£€æŸ¥ç†”æ–­å™¨</span></span><br><span class="line">            <span class="keyword">if</span> self._is_circuit_open(service_name, selected_instance[<span class="string">&quot;url&quot;</span>]):</span><br><span class="line">                <span class="keyword">raise</span> HTTPException(</span><br><span class="line">                    status_code=<span class="number">503</span>,</span><br><span class="line">                    detail=<span class="string">f&quot;Service <span class="subst">&#123;service_name&#125;</span> circuit is open&quot;</span></span><br><span class="line">                )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è½¬å‘è¯·æ±‚</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                response = <span class="keyword">await</span> self._forward_request(</span><br><span class="line">                    selected_instance[<span class="string">&quot;url&quot;</span>],</span><br><span class="line">                    path,</span><br><span class="line">                    request</span><br><span class="line">                )</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># è®°å½•æˆåŠŸï¼Œå…³é—­ç†”æ–­å™¨</span></span><br><span class="line">                self._record_success(service_name, selected_instance[<span class="string">&quot;url&quot;</span>])</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> response</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="comment"># è®°å½•å¤±è´¥ï¼Œå¯èƒ½è§¦å‘ç†”æ–­</span></span><br><span class="line">                self._record_failure(service_name, selected_instance[<span class="string">&quot;url&quot;</span>], <span class="built_in">str</span>(e))</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">raise</span> HTTPException(</span><br><span class="line">                    status_code=<span class="number">502</span>,</span><br><span class="line">                    detail=<span class="string">f&quot;Service error: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line">                )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_forward_request</span>(<span class="params">self, base_url: <span class="built_in">str</span>, path: <span class="built_in">str</span>, request: Request</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è½¬å‘è¯·æ±‚åˆ°åç«¯æœåŠ¡&quot;&quot;&quot;</span></span><br><span class="line">        url = urljoin(base_url, path)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è·å–è¯·æ±‚æ•°æ®</span></span><br><span class="line">        body = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> request.method <span class="keyword">in</span> [<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;PUT&quot;</span>]:</span><br><span class="line">            body = <span class="keyword">await</span> request.body()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è½¬å‘è¯·æ±‚</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">with</span> session.request(</span><br><span class="line">                method=request.method,</span><br><span class="line">                url=url,</span><br><span class="line">                headers=<span class="built_in">dict</span>(request.headers),</span><br><span class="line">                params=<span class="built_in">dict</span>(request.query_params),</span><br><span class="line">                data=body,</span><br><span class="line">                timeout=aiohttp.ClientTimeout(total=<span class="number">30</span>)</span><br><span class="line">            ) <span class="keyword">as</span> response:</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># è·å–å“åº”å†…å®¹</span></span><br><span class="line">                content = <span class="keyword">await</span> response.read()</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># è¿”å›å“åº”</span></span><br><span class="line">                <span class="keyword">return</span> Response(</span><br><span class="line">                    content=content,</span><br><span class="line">                    status_code=response.status,</span><br><span class="line">                    headers=<span class="built_in">dict</span>(response.headers)</span><br><span class="line">                )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_is_circuit_open</span>(<span class="params">self, service_name: <span class="built_in">str</span>, instance_url: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ£€æŸ¥ç†”æ–­å™¨æ˜¯å¦æ‰“å¼€&quot;&quot;&quot;</span></span><br><span class="line">        circuit_key = <span class="string">f&quot;<span class="subst">&#123;service_name&#125;</span>:<span class="subst">&#123;instance_url&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> circuit_key <span class="keyword">not</span> <span class="keyword">in</span> self.circuit_breakers:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        circuit = self.circuit_breakers[circuit_key]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> circuit[<span class="string">&quot;state&quot;</span>] == <span class="string">&quot;OPEN&quot;</span>:</span><br><span class="line">            <span class="comment"># æ£€æŸ¥æ˜¯å¦åº”è¯¥å°è¯•åŠå¼€</span></span><br><span class="line">            <span class="keyword">if</span> time.time() - circuit[<span class="string">&quot;last_failure&quot;</span>] &gt; <span class="number">60</span>:  <span class="comment"># 60ç§’åå°è¯•æ¢å¤</span></span><br><span class="line">                circuit[<span class="string">&quot;state&quot;</span>] = <span class="string">&quot;HALF_OPEN&quot;</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_record_success</span>(<span class="params">self, service_name: <span class="built_in">str</span>, instance_url: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è®°å½•æˆåŠŸè¯·æ±‚&quot;&quot;&quot;</span></span><br><span class="line">        circuit_key = <span class="string">f&quot;<span class="subst">&#123;service_name&#125;</span>:<span class="subst">&#123;instance_url&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> circuit_key <span class="keyword">in</span> self.circuit_breakers:</span><br><span class="line">            circuit = self.circuit_breakers[circuit_key]</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> circuit[<span class="string">&quot;state&quot;</span>] == <span class="string">&quot;HALF_OPEN&quot;</span>:</span><br><span class="line">                <span class="comment"># åŠå¼€çŠ¶æ€ä¸‹æˆåŠŸï¼Œå…³é—­ç†”æ–­å™¨</span></span><br><span class="line">                circuit[<span class="string">&quot;state&quot;</span>] = <span class="string">&quot;CLOSED&quot;</span></span><br><span class="line">                circuit[<span class="string">&quot;failure_count&quot;</span>] = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_record_failure</span>(<span class="params">self, service_name: <span class="built_in">str</span>, instance_url: <span class="built_in">str</span>, error: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è®°å½•å¤±è´¥è¯·æ±‚&quot;&quot;&quot;</span></span><br><span class="line">        circuit_key = <span class="string">f&quot;<span class="subst">&#123;service_name&#125;</span>:<span class="subst">&#123;instance_url&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> circuit_key <span class="keyword">not</span> <span class="keyword">in</span> self.circuit_breakers:</span><br><span class="line">            self.circuit_breakers[circuit_key] = &#123;</span><br><span class="line">                <span class="string">&quot;state&quot;</span>: <span class="string">&quot;CLOSED&quot;</span>,</span><br><span class="line">                <span class="string">&quot;failure_count&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;last_failure&quot;</span>: <span class="number">0</span></span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        circuit = self.circuit_breakers[circuit_key]</span><br><span class="line">        circuit[<span class="string">&quot;failure_count&quot;</span>] += <span class="number">1</span></span><br><span class="line">        circuit[<span class="string">&quot;last_failure&quot;</span>] = time.time()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å¦‚æœå¤±è´¥æ¬¡æ•°è¶…è¿‡é˜ˆå€¼ï¼Œæ‰“å¼€ç†”æ–­å™¨</span></span><br><span class="line">        <span class="keyword">if</span> circuit[<span class="string">&quot;failure_count&quot;</span>] &gt;= <span class="number">5</span>:  <span class="comment"># 5æ¬¡å¤±è´¥åç†”æ–­</span></span><br><span class="line">            circuit[<span class="string">&quot;state&quot;</span>] = <span class="string">&quot;OPEN&quot;</span></span><br><span class="line">            logger.warning(<span class="string">f&quot;Circuit opened for <span class="subst">&#123;service_name&#125;</span> (<span class="subst">&#123;instance_url&#125;</span>)&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_health_check_loop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¥åº·æ£€æŸ¥å¾ªç¯&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">await</span> self._check_service_health()</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logger.error(<span class="string">f&quot;Health check error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">await</span> asyncio.sleep(<span class="number">30</span>)  <span class="comment"># æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_check_service_health</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€&quot;&quot;&quot;</span></span><br><span class="line">        all_services = <span class="keyword">await</span> self.service_registry.redis.hgetall(<span class="string">&quot;service_registry&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> all_services.items():</span><br><span class="line">            service_data = json.loads(value)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># æ£€æŸ¥æœåŠ¡å¥åº·ç«¯ç‚¹</span></span><br><span class="line">                <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">                    <span class="keyword">async</span> <span class="keyword">with</span> session.get(</span><br><span class="line">                        urljoin(service_data[<span class="string">&quot;url&quot;</span>], <span class="string">&quot;/health&quot;</span>),</span><br><span class="line">                        timeout=<span class="number">5</span></span><br><span class="line">                    ) <span class="keyword">as</span> response:</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">if</span> response.status == <span class="number">200</span>:</span><br><span class="line">                            service_data[<span class="string">&quot;status&quot;</span>] = <span class="string">&quot;healthy&quot;</span></span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            service_data[<span class="string">&quot;status&quot;</span>] = <span class="string">&quot;unhealthy&quot;</span></span><br><span class="line">                            </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                service_data[<span class="string">&quot;status&quot;</span>] = <span class="string">&quot;unhealthy&quot;</span></span><br><span class="line">                logger.error(<span class="string">f&quot;Health check failed for <span class="subst">&#123;key&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ›´æ–°æœåŠ¡çŠ¶æ€</span></span><br><span class="line">            <span class="keyword">await</span> self.service_registry.redis.hset(</span><br><span class="line">                <span class="string">&quot;service_registry&quot;</span>,</span><br><span class="line">                key,</span><br><span class="line">                json.dumps(service_data)</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RoundRobinLoadBalancer</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è½®è¯¢è´Ÿè½½å‡è¡¡å™¨&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.counters = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">select_instance</span>(<span class="params">self, instances: <span class="type">List</span>[<span class="type">Dict</span>]</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;é€‰æ‹©æœåŠ¡å®ä¾‹&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> instances:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;No instances available&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è¿‡æ»¤å¥åº·å®ä¾‹</span></span><br><span class="line">        healthy_instances = [i <span class="keyword">for</span> i <span class="keyword">in</span> instances <span class="keyword">if</span> i.get(<span class="string">&quot;status&quot;</span>) == <span class="string">&quot;healthy&quot;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> healthy_instances:</span><br><span class="line">            <span class="comment"># å¦‚æœæ²¡æœ‰å¥åº·å®ä¾‹ï¼Œè¿”å›ç¬¬ä¸€ä¸ª</span></span><br><span class="line">            <span class="keyword">return</span> instances[<span class="number">0</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è·å–æœåŠ¡åç§°</span></span><br><span class="line">        service_urls = [i[<span class="string">&quot;url&quot;</span>] <span class="keyword">for</span> i <span class="keyword">in</span> healthy_instances]</span><br><span class="line">        service_key = <span class="string">&quot;:&quot;</span>.join(<span class="built_in">sorted</span>(service_urls))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è·å–æˆ–åˆå§‹åŒ–è®¡æ•°å™¨</span></span><br><span class="line">        <span class="keyword">if</span> service_key <span class="keyword">not</span> <span class="keyword">in</span> self.counters:</span><br><span class="line">            self.counters[service_key] = <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># é€‰æ‹©å®ä¾‹</span></span><br><span class="line">        selected_index = self.counters[service_key] % <span class="built_in">len</span>(healthy_instances)</span><br><span class="line">        selected_instance = healthy_instances[selected_index]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ›´æ–°è®¡æ•°å™¨</span></span><br><span class="line">        self.counters[service_key] += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> selected_instance</span><br></pre></td></tr></table></figure>



<h4 id="3-3-äº‹ä»¶é©±åŠ¨æ¶æ„"><a href="#3-3-äº‹ä»¶é©±åŠ¨æ¶æ„" class="headerlink" title="3.3 äº‹ä»¶é©±åŠ¨æ¶æ„"></a>3.3 äº‹ä»¶é©±åŠ¨æ¶æ„</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/core/event_bus.py</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Any</span>, <span class="type">Callable</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass, field</span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> redis.asyncio <span class="keyword">as</span> redis</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EventType</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;äº‹ä»¶ç±»å‹&quot;&quot;&quot;</span></span><br><span class="line">    USER_CREATED = <span class="string">&quot;user.created&quot;</span></span><br><span class="line">    USER_UPDATED = <span class="string">&quot;user.updated&quot;</span></span><br><span class="line">    CHAT_MESSAGE_SENT = <span class="string">&quot;chat.message.sent&quot;</span></span><br><span class="line">    CHAT_SESSION_CREATED = <span class="string">&quot;chat.session.created&quot;</span></span><br><span class="line">    AI_RESPONSE_GENERATED = <span class="string">&quot;ai.response.generated&quot;</span></span><br><span class="line">    FEEDBACK_SUBMITTED = <span class="string">&quot;feedback.submitted&quot;</span></span><br><span class="line">    ANALYTICS_UPDATED = <span class="string">&quot;analytics.updated&quot;</span></span><br><span class="line">    SYSTEM_ALERT = <span class="string">&quot;system.alert&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Event</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;äº‹ä»¶æ¨¡å‹&quot;&quot;&quot;</span></span><br><span class="line">    event_id: <span class="built_in">str</span></span><br><span class="line">    event_type: EventType</span><br><span class="line">    timestamp: datetime</span><br><span class="line">    data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span><br><span class="line">    metadata: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = &#123;&#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">cls, event_type: EventType, data: <span class="type">Dict</span>, metadata: <span class="type">Dict</span> = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆ›å»ºäº‹ä»¶&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> cls(</span><br><span class="line">            event_id=<span class="built_in">str</span>(uuid.uuid4()),</span><br><span class="line">            event_type=event_type,</span><br><span class="line">            timestamp=datetime.utcnow(),</span><br><span class="line">            data=data,</span><br><span class="line">            metadata=metadata <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EventHandler</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;äº‹ä»¶å¤„ç†å™¨&quot;&quot;&quot;</span></span><br><span class="line">    handler_id: <span class="built_in">str</span></span><br><span class="line">    event_type: EventType</span><br><span class="line">    callback: <span class="type">Callable</span></span><br><span class="line">    priority: <span class="built_in">int</span> = <span class="number">0</span></span><br><span class="line">    filter_func: <span class="type">Optional</span>[<span class="type">Callable</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EventBus</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;äº‹ä»¶æ€»çº¿&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client: <span class="type">Optional</span>[redis.Redis] = <span class="literal">None</span></span>):</span><br><span class="line">        self.handlers: <span class="type">Dict</span>[EventType, <span class="type">List</span>[EventHandler]] = &#123;&#125;</span><br><span class="line">        self.redis = redis_client</span><br><span class="line">        self.pubsub = <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># äº‹ä»¶é˜Ÿåˆ—</span></span><br><span class="line">        self.event_queue = asyncio.Queue(maxsize=<span class="number">10000</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ¶ˆè´¹è€…ä»»åŠ¡</span></span><br><span class="line">        self.consumer_task = <span class="literal">None</span></span><br><span class="line">        self.running = <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç»Ÿè®¡ä¿¡æ¯</span></span><br><span class="line">        self.stats = &#123;</span><br><span class="line">            <span class="string">&quot;events_published&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;events_processed&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;handlers_executed&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;errors&quot;</span>: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">start</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¯åŠ¨äº‹ä»¶æ€»çº¿&quot;&quot;&quot;</span></span><br><span class="line">        self.running = <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å¯åŠ¨Redisè®¢é˜…ï¼ˆå¦‚æœå¯ç”¨ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> self.redis:</span><br><span class="line">            <span class="keyword">await</span> self._start_redis_subscription()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å¯åŠ¨äº‹ä»¶å¤„ç†å™¨</span></span><br><span class="line">        self.consumer_task = asyncio.create_task(self._process_events())</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">&quot;EventBus started&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">stop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åœæ­¢äº‹ä»¶æ€»çº¿&quot;&quot;&quot;</span></span><br><span class="line">        self.running = <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åœæ­¢æ¶ˆè´¹è€…</span></span><br><span class="line">        <span class="keyword">if</span> self.consumer_task:</span><br><span class="line">            self.consumer_task.cancel()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">await</span> self.consumer_task</span><br><span class="line">            <span class="keyword">except</span> asyncio.CancelledError:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åœæ­¢Redisè®¢é˜…</span></span><br><span class="line">        <span class="keyword">if</span> self.pubsub:</span><br><span class="line">            <span class="keyword">await</span> self.pubsub.unsubscribe()</span><br><span class="line">            <span class="keyword">await</span> self.pubsub.close()</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">&quot;EventBus stopped&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_start_redis_subscription</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¯åŠ¨Redisè®¢é˜…&quot;&quot;&quot;</span></span><br><span class="line">        self.pubsub = self.redis.pubsub()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®¢é˜…äº‹ä»¶é€šé“</span></span><br><span class="line">        <span class="keyword">await</span> self.pubsub.subscribe(<span class="string">&quot;events&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å¯åŠ¨ç›‘å¬ä»»åŠ¡</span></span><br><span class="line">        asyncio.create_task(self._listen_redis_messages())</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_listen_redis_messages</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ç›‘å¬Redisæ¶ˆæ¯&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">for</span> message <span class="keyword">in</span> self.pubsub.listen():</span><br><span class="line">                <span class="keyword">if</span> message[<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;message&quot;</span>:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        event_data = json.loads(message[<span class="string">&quot;data&quot;</span>])</span><br><span class="line">                        event = Event(**event_data)</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment"># æ·»åŠ åˆ°æœ¬åœ°é˜Ÿåˆ—</span></span><br><span class="line">                        <span class="keyword">await</span> self.event_queue.put(event)</span><br><span class="line">                        </span><br><span class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                        logger.error(<span class="string">f&quot;Failed to process Redis message: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                        </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Redis subscription error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">publish</span>(<span class="params">self, event: Event, broadcast: <span class="built_in">bool</span> = <span class="literal">True</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        å‘å¸ƒäº‹ä»¶</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            event: äº‹ä»¶å¯¹è±¡</span></span><br><span class="line"><span class="string">            broadcast: æ˜¯å¦å¹¿æ’­åˆ°å…¶ä»–å®ä¾‹</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># æ·»åŠ åˆ°æœ¬åœ°é˜Ÿåˆ—</span></span><br><span class="line">            <span class="keyword">await</span> self.event_queue.put(event)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># å¹¿æ’­åˆ°Redisï¼ˆå¦‚æœå¯ç”¨ï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> broadcast <span class="keyword">and</span> self.redis:</span><br><span class="line">                event_json = event.json()</span><br><span class="line">                <span class="keyword">await</span> self.redis.publish(<span class="string">&quot;events&quot;</span>, event_json)</span><br><span class="line">            </span><br><span class="line">            self.stats[<span class="string">&quot;events_published&quot;</span>] += <span class="number">1</span></span><br><span class="line">            </span><br><span class="line">            logger.debug(<span class="string">f&quot;Event published: <span class="subst">&#123;event.event_type&#125;</span> (<span class="subst">&#123;event.event_id&#125;</span>)&quot;</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> asyncio.QueueFull:</span><br><span class="line">            logger.warning(<span class="string">&quot;Event queue is full, event dropped&quot;</span>)</span><br><span class="line">            self.stats[<span class="string">&quot;errors&quot;</span>] += <span class="number">1</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Failed to publish event: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            self.stats[<span class="string">&quot;errors&quot;</span>] += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">subscribe</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                 event_type: EventType, </span></span><br><span class="line"><span class="params">                 handler: <span class="type">Callable</span>, </span></span><br><span class="line"><span class="params">                 priority: <span class="built_in">int</span> = <span class="number">0</span>,</span></span><br><span class="line"><span class="params">                 filter_func: <span class="type">Optional</span>[<span class="type">Callable</span>] = <span class="literal">None</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        è®¢é˜…äº‹ä»¶</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            event_type: äº‹ä»¶ç±»å‹</span></span><br><span class="line"><span class="string">            handler: å¤„ç†å‡½æ•°</span></span><br><span class="line"><span class="string">            priority: ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰</span></span><br><span class="line"><span class="string">            filter_func: è¿‡æ»¤å‡½æ•°</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            å¤„ç†å™¨ID</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        handler_id = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">        </span><br><span class="line">        event_handler = EventHandler(</span><br><span class="line">            handler_id=handler_id,</span><br><span class="line">            event_type=event_type,</span><br><span class="line">            callback=handler,</span><br><span class="line">            priority=priority,</span><br><span class="line">            filter_func=filter_func</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> event_type <span class="keyword">not</span> <span class="keyword">in</span> self.handlers:</span><br><span class="line">            self.handlers[event_type] = []</span><br><span class="line">        </span><br><span class="line">        self.handlers[event_type].append(event_handler)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æŒ‰ä¼˜å…ˆçº§æ’åº</span></span><br><span class="line">        self.handlers[event_type].sort(key=<span class="keyword">lambda</span> h: h.priority)</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">f&quot;Handler <span class="subst">&#123;handler_id&#125;</span> subscribed to <span class="subst">&#123;event_type&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> handler_id</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">unsubscribe</span>(<span class="params">self, handler_id: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å–æ¶ˆè®¢é˜…&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> event_type, handlers <span class="keyword">in</span> self.handlers.items():</span><br><span class="line">            <span class="keyword">for</span> i, handler <span class="keyword">in</span> <span class="built_in">enumerate</span>(handlers):</span><br><span class="line">                <span class="keyword">if</span> handler.handler_id == handler_id:</span><br><span class="line">                    handlers.pop(i)</span><br><span class="line">                    logger.info(<span class="string">f&quot;Handler <span class="subst">&#123;handler_id&#125;</span> unsubscribed from <span class="subst">&#123;event_type&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_process_events</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¤„ç†äº‹ä»¶é˜Ÿåˆ—&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">while</span> self.running:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># è·å–äº‹ä»¶ï¼ˆå¸¦è¶…æ—¶ï¼‰</span></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    event = <span class="keyword">await</span> asyncio.wait_for(</span><br><span class="line">                        self.event_queue.get(),</span><br><span class="line">                        timeout=<span class="number">1.0</span></span><br><span class="line">                    )</span><br><span class="line">                <span class="keyword">except</span> asyncio.TimeoutError:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># å¤„ç†äº‹ä»¶</span></span><br><span class="line">                <span class="keyword">await</span> self._handle_event(event)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># æ ‡è®°å®Œæˆ</span></span><br><span class="line">                self.event_queue.task_done()</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">except</span> asyncio.CancelledError:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">                </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logger.error(<span class="string">f&quot;Error processing events: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                self.stats[<span class="string">&quot;errors&quot;</span>] += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_handle_event</span>(<span class="params">self, event: Event</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¤„ç†å•ä¸ªäº‹ä»¶&quot;&quot;&quot;</span></span><br><span class="line">        handlers = self.handlers.get(event.event_type, [])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> handlers:</span><br><span class="line">            logger.debug(<span class="string">f&quot;No handlers for event type: <span class="subst">&#123;event.event_type&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å¹¶è¡Œæ‰§è¡Œå¤„ç†å™¨</span></span><br><span class="line">        tasks = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> handler <span class="keyword">in</span> handlers:</span><br><span class="line">            <span class="comment"># æ£€æŸ¥è¿‡æ»¤å™¨</span></span><br><span class="line">            <span class="keyword">if</span> handler.filter_func <span class="keyword">and</span> <span class="keyword">not</span> handler.filter_func(event):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># åˆ›å»ºå¤„ç†ä»»åŠ¡</span></span><br><span class="line">            task = asyncio.create_task(</span><br><span class="line">                self._execute_handler(handler, event)</span><br><span class="line">            )</span><br><span class="line">            tasks.append(task)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç­‰å¾…æ‰€æœ‰å¤„ç†å™¨å®Œæˆ</span></span><br><span class="line">        <span class="keyword">if</span> tasks:</span><br><span class="line">            <span class="keyword">await</span> asyncio.gather(*tasks, return_exceptions=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        self.stats[<span class="string">&quot;events_processed&quot;</span>] += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_execute_handler</span>(<span class="params">self, handler: EventHandler, event: Event</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ‰§è¡Œå¤„ç†å™¨&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># æ‰§è¡Œå¤„ç†å™¨</span></span><br><span class="line">            <span class="keyword">if</span> asyncio.iscoroutinefunction(handler.callback):</span><br><span class="line">                <span class="keyword">await</span> handler.callback(event)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                handler.callback(event)</span><br><span class="line">            </span><br><span class="line">            self.stats[<span class="string">&quot;handlers_executed&quot;</span>] += <span class="number">1</span></span><br><span class="line">            </span><br><span class="line">            logger.debug(<span class="string">f&quot;Handler <span class="subst">&#123;handler.handler_id&#125;</span> executed for event <span class="subst">&#123;event.event_id&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Handler <span class="subst">&#123;handler.handler_id&#125;</span> failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            self.stats[<span class="string">&quot;errors&quot;</span>] += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_stats</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–ç»Ÿè®¡ä¿¡æ¯&quot;&quot;&quot;</span></span><br><span class="line">        handler_counts = &#123;</span><br><span class="line">            event_type.value: <span class="built_in">len</span>(handlers)</span><br><span class="line">            <span class="keyword">for</span> event_type, handlers <span class="keyword">in</span> self.handlers.items()</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            **self.stats,</span><br><span class="line">            <span class="string">&quot;queue_size&quot;</span>: self.event_queue.qsize(),</span><br><span class="line">            <span class="string">&quot;handlers_by_type&quot;</span>: handler_counts,</span><br><span class="line">            <span class="string">&quot;running&quot;</span>: self.running</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># äº‹ä»¶å¤„ç†å™¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EventHandlers</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;äº‹ä»¶å¤„ç†å™¨é›†åˆ&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_chat_message</span>(<span class="params">event: Event</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¤„ç†èŠå¤©æ¶ˆæ¯äº‹ä»¶&quot;&quot;&quot;</span></span><br><span class="line">        message_data = event.data</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">f&quot;Chat message processed: <span class="subst">&#123;message_data.get(<span class="string">&#x27;message_id&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è¿™é‡Œå¯ä»¥æ·»åŠ ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">        <span class="comment"># ä¾‹å¦‚ï¼šæ›´æ–°ç»Ÿè®¡ã€å‘é€é€šçŸ¥ã€è®°å½•æ—¥å¿—ç­‰</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_ai_response</span>(<span class="params">event: Event</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¤„ç†AIå“åº”äº‹ä»¶&quot;&quot;&quot;</span></span><br><span class="line">        response_data = event.data</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">f&quot;AI response generated: <span class="subst">&#123;response_data.get(<span class="string">&#x27;model&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ä¾‹å¦‚ï¼šè®°å½•å“åº”æ—¶é—´ã€æ›´æ–°æ¨¡å‹ç»Ÿè®¡ç­‰</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_system_alert</span>(<span class="params">event: Event</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¤„ç†ç³»ç»Ÿå‘Šè­¦äº‹ä»¶&quot;&quot;&quot;</span></span><br><span class="line">        alert_data = event.data</span><br><span class="line">        </span><br><span class="line">        logger.warning(<span class="string">f&quot;System alert: <span class="subst">&#123;alert_data.get(<span class="string">&#x27;message&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ä¾‹å¦‚ï¼šå‘é€é‚®ä»¶é€šçŸ¥ã€è®°å½•åˆ°ç›‘æ§ç³»ç»Ÿç­‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">example_usage</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;äº‹ä»¶æ€»çº¿ä½¿ç”¨ç¤ºä¾‹&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># åˆ›å»ºäº‹ä»¶æ€»çº¿</span></span><br><span class="line">    event_bus = EventBus()</span><br><span class="line">    <span class="keyword">await</span> event_bus.start()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># è®¢é˜…äº‹ä»¶</span></span><br><span class="line">        handler_id = event_bus.subscribe(</span><br><span class="line">            EventType.CHAT_MESSAGE_SENT,</span><br><span class="line">            EventHandlers.handle_chat_message,</span><br><span class="line">            priority=<span class="number">1</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å‘å¸ƒäº‹ä»¶</span></span><br><span class="line">        event = Event.create(</span><br><span class="line">            event_type=EventType.CHAT_MESSAGE_SENT,</span><br><span class="line">            data=&#123;</span><br><span class="line">                <span class="string">&quot;message_id&quot;</span>: <span class="string">&quot;msg_123&quot;</span>,</span><br><span class="line">                <span class="string">&quot;user_id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="string">&quot;content&quot;</span>: <span class="string">&quot;Hello, AI!&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            metadata=&#123;<span class="string">&quot;source&quot;</span>: <span class="string">&quot;chat_api&quot;</span>&#125;</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">await</span> event_bus.publish(event)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç­‰å¾…äº‹ä»¶å¤„ç†</span></span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è·å–ç»Ÿè®¡</span></span><br><span class="line">        stats = event_bus.get_stats()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Event bus stats: <span class="subst">&#123;stats&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å–æ¶ˆè®¢é˜…</span></span><br><span class="line">        event_bus.unsubscribe(handler_id)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">await</span> event_bus.stop()</span><br></pre></td></tr></table></figure>



<h3 id="4-ç›‘æ§å’Œå¯è§‚æµ‹æ€§æ‰©å±•"><a href="#4-ç›‘æ§å’Œå¯è§‚æµ‹æ€§æ‰©å±•" class="headerlink" title="4. ç›‘æ§å’Œå¯è§‚æµ‹æ€§æ‰©å±•"></a>4. ç›‘æ§å’Œå¯è§‚æµ‹æ€§æ‰©å±•</h3><h4 id="4-1-é«˜çº§ç›‘æ§ç³»ç»Ÿ"><a href="#4-1-é«˜çº§ç›‘æ§ç³»ç»Ÿ" class="headerlink" title="4.1 é«˜çº§ç›‘æ§ç³»ç»Ÿ"></a>4.1 é«˜çº§ç›‘æ§ç³»ç»Ÿ</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/monitoring/advanced_monitor.py</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Any</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass, field</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"><span class="keyword">import</span> psutil</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> Counter, Gauge, Histogram, Summary, start_http_server</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># PrometheusæŒ‡æ ‡</span></span><br><span class="line">REQUEST_COUNT = Counter(<span class="string">&#x27;http_requests_total&#x27;</span>, <span class="string">&#x27;Total HTTP requests&#x27;</span>, [<span class="string">&#x27;method&#x27;</span>, <span class="string">&#x27;endpoint&#x27;</span>, <span class="string">&#x27;status&#x27;</span>])</span><br><span class="line">REQUEST_LATENCY = Histogram(<span class="string">&#x27;http_request_duration_seconds&#x27;</span>, <span class="string">&#x27;HTTP request latency&#x27;</span>, [<span class="string">&#x27;endpoint&#x27;</span>])</span><br><span class="line">ACTIVE_USERS = Gauge(<span class="string">&#x27;active_users&#x27;</span>, <span class="string">&#x27;Number of active users&#x27;</span>)</span><br><span class="line">AI_RESPONSE_TIME = Summary(<span class="string">&#x27;ai_response_time_seconds&#x27;</span>, <span class="string">&#x27;AI response time&#x27;</span>)</span><br><span class="line">DATABASE_QUERY_TIME = Histogram(<span class="string">&#x27;database_query_duration_seconds&#x27;</span>, <span class="string">&#x27;Database query duration&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Metric</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ç›‘æ§æŒ‡æ ‡&quot;&quot;&quot;</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    value: <span class="built_in">float</span></span><br><span class="line">    timestamp: datetime</span><br><span class="line">    tags: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>] = field(default_factory=<span class="built_in">dict</span>)</span><br><span class="line">    metadata: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = field(default_factory=<span class="built_in">dict</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Alert</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å‘Šè­¦&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">str</span></span><br><span class="line">    severity: <span class="built_in">str</span>  <span class="comment"># info, warning, critical</span></span><br><span class="line">    message: <span class="built_in">str</span></span><br><span class="line">    metric_name: <span class="built_in">str</span></span><br><span class="line">    threshold: <span class="built_in">float</span></span><br><span class="line">    current_value: <span class="built_in">float</span></span><br><span class="line">    timestamp: datetime</span><br><span class="line">    resolved: <span class="built_in">bool</span> = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AdvancedMonitor</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;é«˜çº§ç›‘æ§ç³»ç»Ÿ&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                 prometheus_port: <span class="built_in">int</span> = <span class="number">9090</span>,</span></span><br><span class="line"><span class="params">                 metrics_interval: <span class="built_in">int</span> = <span class="number">30</span>,</span></span><br><span class="line"><span class="params">                 alert_webhook: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span>):</span><br><span class="line">        </span><br><span class="line">        self.prometheus_port = prometheus_port</span><br><span class="line">        self.metrics_interval = metrics_interval</span><br><span class="line">        self.alert_webhook = alert_webhook</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æŒ‡æ ‡å­˜å‚¨</span></span><br><span class="line">        self.metrics_history = &#123;&#125;</span><br><span class="line">        self.alerts = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç³»ç»ŸæŒ‡æ ‡</span></span><br><span class="line">        self.system_metrics = deque(maxlen=<span class="number">3600</span>)  <span class="comment"># ä¿å­˜1å°æ—¶æ•°æ®</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å‘Šè­¦è§„åˆ™</span></span><br><span class="line">        self.alert_rules = self._load_alert_rules()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å¯åŠ¨PrometheusæœåŠ¡å™¨</span></span><br><span class="line">        start_http_server(self.prometheus_port)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å¯åŠ¨ç›‘æ§ä»»åŠ¡</span></span><br><span class="line">        self.monitor_task = <span class="literal">None</span></span><br><span class="line">        self.running = <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">f&quot;AdvancedMonitor started on port <span class="subst">&#123;self.prometheus_port&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_load_alert_rules</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åŠ è½½å‘Šè­¦è§„åˆ™&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;high_cpu_usage&quot;</span>,</span><br><span class="line">                <span class="string">&quot;metric&quot;</span>: <span class="string">&quot;system.cpu.percent&quot;</span>,</span><br><span class="line">                <span class="string">&quot;condition&quot;</span>: <span class="string">&quot;&gt;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;threshold&quot;</span>: <span class="number">80.0</span>,</span><br><span class="line">                <span class="string">&quot;duration&quot;</span>: <span class="number">300</span>,  <span class="comment"># 5åˆ†é’Ÿ</span></span><br><span class="line">                <span class="string">&quot;severity&quot;</span>: <span class="string">&quot;warning&quot;</span>,</span><br><span class="line">                <span class="string">&quot;message&quot;</span>: <span class="string">&quot;High CPU usage detected&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;high_memory_usage&quot;</span>,</span><br><span class="line">                <span class="string">&quot;metric&quot;</span>: <span class="string">&quot;system.memory.percent&quot;</span>,</span><br><span class="line">                <span class="string">&quot;condition&quot;</span>: <span class="string">&quot;&gt;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;threshold&quot;</span>: <span class="number">90.0</span>,</span><br><span class="line">                <span class="string">&quot;duration&quot;</span>: <span class="number">300</span>,</span><br><span class="line">                <span class="string">&quot;severity&quot;</span>: <span class="string">&quot;critical&quot;</span>,</span><br><span class="line">                <span class="string">&quot;message&quot;</span>: <span class="string">&quot;High memory usage detected&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;slow_response_time&quot;</span>,</span><br><span class="line">                <span class="string">&quot;metric&quot;</span>: <span class="string">&quot;api.response_time.p95&quot;</span>,</span><br><span class="line">                <span class="string">&quot;condition&quot;</span>: <span class="string">&quot;&gt;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;threshold&quot;</span>: <span class="number">2.0</span>,  <span class="comment"># 2ç§’</span></span><br><span class="line">                <span class="string">&quot;duration&quot;</span>: <span class="number">600</span>,</span><br><span class="line">                <span class="string">&quot;severity&quot;</span>: <span class="string">&quot;warning&quot;</span>,</span><br><span class="line">                <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Slow response time detected&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;high_error_rate&quot;</span>,</span><br><span class="line">                <span class="string">&quot;metric&quot;</span>: <span class="string">&quot;api.error_rate&quot;</span>,</span><br><span class="line">                <span class="string">&quot;condition&quot;</span>: <span class="string">&quot;&gt;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;threshold&quot;</span>: <span class="number">5.0</span>,  <span class="comment"># 5%</span></span><br><span class="line">                <span class="string">&quot;duration&quot;</span>: <span class="number">300</span>,</span><br><span class="line">                <span class="string">&quot;severity&quot;</span>: <span class="string">&quot;critical&quot;</span>,</span><br><span class="line">                <span class="string">&quot;message&quot;</span>: <span class="string">&quot;High error rate detected&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">start</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¯åŠ¨ç›‘æ§&quot;&quot;&quot;</span></span><br><span class="line">        self.running = <span class="literal">True</span></span><br><span class="line">        self.monitor_task = asyncio.create_task(self._monitor_loop())</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">&quot;AdvancedMonitor monitoring started&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">stop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åœæ­¢ç›‘æ§&quot;&quot;&quot;</span></span><br><span class="line">        self.running = <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> self.monitor_task:</span><br><span class="line">            self.monitor_task.cancel()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">await</span> self.monitor_task</span><br><span class="line">            <span class="keyword">except</span> asyncio.CancelledError:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">&quot;AdvancedMonitor stopped&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_monitor_loop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ç›‘æ§å¾ªç¯&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">while</span> self.running:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># æ”¶é›†ç³»ç»ŸæŒ‡æ ‡</span></span><br><span class="line">                <span class="keyword">await</span> self._collect_system_metrics()</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># æ£€æŸ¥å‘Šè­¦</span></span><br><span class="line">                <span class="keyword">await</span> self._check_alerts()</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># æ¸…ç†æ—§æ•°æ®</span></span><br><span class="line">                <span class="keyword">await</span> self._cleanup_old_data()</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># å‘é€æŒ‡æ ‡åˆ°å¤–éƒ¨æœåŠ¡ï¼ˆå¯é€‰ï¼‰</span></span><br><span class="line">                <span class="keyword">await</span> self._send_metrics_to_external()</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># ç­‰å¾…ä¸‹ä¸€ä¸ªæ”¶é›†å‘¨æœŸ</span></span><br><span class="line">                <span class="keyword">await</span> asyncio.sleep(self.metrics_interval)</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logger.error(<span class="string">f&quot;Monitor loop error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">await</span> asyncio.sleep(self.metrics_interval)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_collect_system_metrics</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ”¶é›†ç³»ç»ŸæŒ‡æ ‡&quot;&quot;&quot;</span></span><br><span class="line">        timestamp = datetime.utcnow()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># CPUä½¿ç”¨ç‡</span></span><br><span class="line">        cpu_percent = psutil.cpu_percent(interval=<span class="number">1</span>)</span><br><span class="line">        self._record_metric(<span class="string">&quot;system.cpu.percent&quot;</span>, cpu_percent, timestamp)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å†…å­˜ä½¿ç”¨ç‡</span></span><br><span class="line">        memory = psutil.virtual_memory()</span><br><span class="line">        self._record_metric(<span class="string">&quot;system.memory.percent&quot;</span>, memory.percent, timestamp)</span><br><span class="line">        self._record_metric(<span class="string">&quot;system.memory.used_gb&quot;</span>, memory.used / (<span class="number">1024</span>**<span class="number">3</span>), timestamp)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç£ç›˜ä½¿ç”¨ç‡</span></span><br><span class="line">        disk = psutil.disk_usage(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">        self._record_metric(<span class="string">&quot;system.disk.percent&quot;</span>, disk.percent, timestamp)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç½‘ç»œIO</span></span><br><span class="line">        net_io = psutil.net_io_counters()</span><br><span class="line">        self._record_metric(<span class="string">&quot;system.network.bytes_sent&quot;</span>, net_io.bytes_sent, timestamp)</span><br><span class="line">        self._record_metric(<span class="string">&quot;system.network.bytes_recv&quot;</span>, net_io.bytes_recv, timestamp)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è¿›ç¨‹ä¿¡æ¯</span></span><br><span class="line">        process = psutil.Process()</span><br><span class="line">        self._record_metric(<span class="string">&quot;system.process.memory_mb&quot;</span>, process.memory_info().rss / (<span class="number">1024</span>**<span class="number">2</span>), timestamp)</span><br><span class="line">        self._record_metric(<span class="string">&quot;system.process.cpu_percent&quot;</span>, process.cpu_percent(), timestamp)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å­˜å‚¨æŒ‡æ ‡å†å²</span></span><br><span class="line">        self.system_metrics.append(&#123;</span><br><span class="line">            <span class="string">&quot;timestamp&quot;</span>: timestamp,</span><br><span class="line">            <span class="string">&quot;cpu&quot;</span>: cpu_percent,</span><br><span class="line">            <span class="string">&quot;memory&quot;</span>: memory.percent,</span><br><span class="line">            <span class="string">&quot;disk&quot;</span>: disk.percent</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ›´æ–°PrometheusæŒ‡æ ‡</span></span><br><span class="line">        ACTIVE_USERS.<span class="built_in">set</span>(self._get_active_users_count())</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_record_metric</span>(<span class="params">self, name: <span class="built_in">str</span>, value: <span class="built_in">float</span>, timestamp: datetime, tags: <span class="type">Dict</span> = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è®°å½•æŒ‡æ ‡&quot;&quot;&quot;</span></span><br><span class="line">        metric = Metric(</span><br><span class="line">            name=name,</span><br><span class="line">            value=value,</span><br><span class="line">            timestamp=timestamp,</span><br><span class="line">            tags=tags <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">not</span> <span class="keyword">in</span> self.metrics_history:</span><br><span class="line">            self.metrics_history[name] = []</span><br><span class="line">        </span><br><span class="line">        self.metrics_history[name].append(metric)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># é™åˆ¶å†å²æ•°æ®å¤§å°</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.metrics_history[name]) &gt; <span class="number">10000</span>:</span><br><span class="line">            self.metrics_history[name] = self.metrics_history[name][-<span class="number">10000</span>:]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_check_alerts</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ£€æŸ¥å‘Šè­¦&quot;&quot;&quot;</span></span><br><span class="line">        current_time = datetime.utcnow()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> rule <span class="keyword">in</span> self.alert_rules:</span><br><span class="line">            metric_name = rule[<span class="string">&quot;metric&quot;</span>]</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> metric_name <span class="keyword">not</span> <span class="keyword">in</span> self.metrics_history:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è·å–æœ€è¿‘ä¸€æ®µæ—¶é—´çš„æ•°æ®</span></span><br><span class="line">            recent_metrics = [</span><br><span class="line">                m <span class="keyword">for</span> m <span class="keyword">in</span> self.metrics_history[metric_name]</span><br><span class="line">                <span class="keyword">if</span> (current_time - m.timestamp).total_seconds() &lt;= rule[<span class="string">&quot;duration&quot;</span>]</span><br><span class="line">            ]</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> recent_metrics:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è®¡ç®—å¹³å‡å€¼</span></span><br><span class="line">            avg_value = np.mean([m.value <span class="keyword">for</span> m <span class="keyword">in</span> recent_metrics])</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ£€æŸ¥æ¡ä»¶</span></span><br><span class="line">            should_alert = <span class="literal">False</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> rule[<span class="string">&quot;condition&quot;</span>] == <span class="string">&quot;&gt;&quot;</span> <span class="keyword">and</span> avg_value &gt; rule[<span class="string">&quot;threshold&quot;</span>]:</span><br><span class="line">                should_alert = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">elif</span> rule[<span class="string">&quot;condition&quot;</span>] == <span class="string">&quot;&lt;&quot;</span> <span class="keyword">and</span> avg_value &lt; rule[<span class="string">&quot;threshold&quot;</span>]:</span><br><span class="line">                should_alert = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">elif</span> rule[<span class="string">&quot;condition&quot;</span>] == <span class="string">&quot;==&quot;</span> <span class="keyword">and</span> avg_value == rule[<span class="string">&quot;threshold&quot;</span>]:</span><br><span class="line">                should_alert = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">elif</span> rule[<span class="string">&quot;condition&quot;</span>] == <span class="string">&quot;!=&quot;</span> <span class="keyword">and</span> avg_value != rule[<span class="string">&quot;threshold&quot;</span>]:</span><br><span class="line">                should_alert = <span class="literal">True</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> should_alert:</span><br><span class="line">                <span class="keyword">await</span> self._trigger_alert(rule, avg_value, current_time)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># å¦‚æœæ¡ä»¶ä¸å†æ»¡è¶³ï¼Œè§£å†³å‘Šè­¦</span></span><br><span class="line">                <span class="keyword">await</span> self._resolve_alert(rule[<span class="string">&quot;name&quot;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_trigger_alert</span>(<span class="params">self, rule: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>], current_value: <span class="built_in">float</span>, timestamp: datetime</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è§¦å‘å‘Šè­¦&quot;&quot;&quot;</span></span><br><span class="line">        alert_id = rule[<span class="string">&quot;name&quot;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ç›¸åŒçš„å‘Šè­¦</span></span><br><span class="line">        <span class="keyword">if</span> alert_id <span class="keyword">in</span> self.alerts <span class="keyword">and</span> <span class="keyword">not</span> self.alerts[alert_id].resolved:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åˆ›å»ºå‘Šè­¦</span></span><br><span class="line">        alert = Alert(</span><br><span class="line">            <span class="built_in">id</span>=alert_id,</span><br><span class="line">            severity=rule[<span class="string">&quot;severity&quot;</span>],</span><br><span class="line">            message=rule[<span class="string">&quot;message&quot;</span>],</span><br><span class="line">            metric_name=rule[<span class="string">&quot;metric&quot;</span>],</span><br><span class="line">            threshold=rule[<span class="string">&quot;threshold&quot;</span>],</span><br><span class="line">            current_value=current_value,</span><br><span class="line">            timestamp=timestamp</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        self.alerts[alert_id] = alert</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®°å½•æ—¥å¿—</span></span><br><span class="line">        logger.warning(</span><br><span class="line">            <span class="string">f&quot;Alert triggered: <span class="subst">&#123;alert.severity.upper()&#125;</span> - <span class="subst">&#123;alert.message&#125;</span> &quot;</span></span><br><span class="line">            <span class="string">f&quot;(metric: <span class="subst">&#123;alert.metric_name&#125;</span>, value: <span class="subst">&#123;alert.current_value:<span class="number">.2</span>f&#125;</span>, &quot;</span></span><br><span class="line">            <span class="string">f&quot;threshold: <span class="subst">&#123;alert.threshold&#125;</span>)&quot;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å‘é€é€šçŸ¥</span></span><br><span class="line">        <span class="keyword">await</span> self._send_alert_notification(alert)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_resolve_alert</span>(<span class="params">self, alert_id: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è§£å†³å‘Šè­¦&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> alert_id <span class="keyword">in</span> self.alerts <span class="keyword">and</span> <span class="keyword">not</span> self.alerts[alert_id].resolved:</span><br><span class="line">            alert = self.alerts[alert_id]</span><br><span class="line">            alert.resolved = <span class="literal">True</span></span><br><span class="line">            </span><br><span class="line">            logger.info(<span class="string">f&quot;Alert resolved: <span class="subst">&#123;alert_id&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># å‘é€è§£å†³é€šçŸ¥</span></span><br><span class="line">            <span class="keyword">await</span> self._send_alert_resolution(alert)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_send_alert_notification</span>(<span class="params">self, alert: Alert</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å‘é€å‘Šè­¦é€šçŸ¥&quot;&quot;&quot;</span></span><br><span class="line">        notification = &#123;</span><br><span class="line">            <span class="string">&quot;alert_id&quot;</span>: alert.<span class="built_in">id</span>,</span><br><span class="line">            <span class="string">&quot;severity&quot;</span>: alert.severity,</span><br><span class="line">            <span class="string">&quot;message&quot;</span>: alert.message,</span><br><span class="line">            <span class="string">&quot;metric&quot;</span>: alert.metric_name,</span><br><span class="line">            <span class="string">&quot;value&quot;</span>: alert.current_value,</span><br><span class="line">            <span class="string">&quot;threshold&quot;</span>: alert.threshold,</span><br><span class="line">            <span class="string">&quot;timestamp&quot;</span>: alert.timestamp.isoformat(),</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;triggered&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å‘é€åˆ°Webhook</span></span><br><span class="line">        <span class="keyword">if</span> self.alert_webhook:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">                    <span class="keyword">async</span> <span class="keyword">with</span> session.post(</span><br><span class="line">                        self.alert_webhook,</span><br><span class="line">                        json=notification,</span><br><span class="line">                        timeout=<span class="number">10</span></span><br><span class="line">                    ) <span class="keyword">as</span> response:</span><br><span class="line">                        <span class="keyword">if</span> response.status != <span class="number">200</span>:</span><br><span class="line">                            logger.error(<span class="string">f&quot;Failed to send alert notification: <span class="subst">&#123;response.status&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logger.error(<span class="string">f&quot;Error sending alert notification: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è¿™é‡Œå¯ä»¥æ·»åŠ å…¶ä»–é€šçŸ¥æ–¹å¼ï¼šé‚®ä»¶ã€çŸ­ä¿¡ã€Slackç­‰</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_send_alert_resolution</span>(<span class="params">self, alert: Alert</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å‘é€å‘Šè­¦è§£å†³é€šçŸ¥&quot;&quot;&quot;</span></span><br><span class="line">        notification = &#123;</span><br><span class="line">            <span class="string">&quot;alert_id&quot;</span>: alert.<span class="built_in">id</span>,</span><br><span class="line">            <span class="string">&quot;message&quot;</span>: <span class="string">f&quot;Alert resolved: <span class="subst">&#123;alert.message&#125;</span>&quot;</span>,</span><br><span class="line">            <span class="string">&quot;timestamp&quot;</span>: datetime.utcnow().isoformat(),</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;resolved&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å‘é€åˆ°Webhook</span></span><br><span class="line">        <span class="keyword">if</span> self.alert_webhook:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">                    <span class="keyword">async</span> <span class="keyword">with</span> session.post(</span><br><span class="line">                        self.alert_webhook,</span><br><span class="line">                        json=notification,</span><br><span class="line">                        timeout=<span class="number">10</span></span><br><span class="line">                    ) <span class="keyword">as</span> response:</span><br><span class="line">                        <span class="keyword">if</span> response.status != <span class="number">200</span>:</span><br><span class="line">                            logger.error(<span class="string">f&quot;Failed to send alert resolution: <span class="subst">&#123;response.status&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logger.error(<span class="string">f&quot;Error sending alert resolution: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_cleanup_old_data</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ¸…ç†æ—§æ•°æ®&quot;&quot;&quot;</span></span><br><span class="line">        current_time = datetime.utcnow()</span><br><span class="line">        cutoff_time = current_time - timedelta(hours=<span class="number">24</span>)  <span class="comment"># ä¿ç•™24å°æ—¶æ•°æ®</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> metric_name <span class="keyword">in</span> <span class="built_in">list</span>(self.metrics_history.keys()):</span><br><span class="line">            <span class="comment"># è¿‡æ»¤æ—§æ•°æ®</span></span><br><span class="line">            self.metrics_history[metric_name] = [</span><br><span class="line">                m <span class="keyword">for</span> m <span class="keyword">in</span> self.metrics_history[metric_name]</span><br><span class="line">                <span class="keyword">if</span> m.timestamp &gt; cutoff_time</span><br><span class="line">            ]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># å¦‚æœæŒ‡æ ‡ä¸ºç©ºï¼Œåˆ é™¤</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self.metrics_history[metric_name]:</span><br><span class="line">                <span class="keyword">del</span> self.metrics_history[metric_name]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ¸…ç†å·²è§£å†³çš„æ—§å‘Šè­¦</span></span><br><span class="line">        resolved_alerts = [</span><br><span class="line">            alert_id <span class="keyword">for</span> alert_id, alert <span class="keyword">in</span> self.alerts.items()</span><br><span class="line">            <span class="keyword">if</span> alert.resolved <span class="keyword">and</span> (current_time - alert.timestamp).days &gt; <span class="number">7</span></span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> alert_id <span class="keyword">in</span> resolved_alerts:</span><br><span class="line">            <span class="keyword">del</span> self.alerts[alert_id]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_send_metrics_to_external</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å‘é€æŒ‡æ ‡åˆ°å¤–éƒ¨æœåŠ¡&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># è¿™é‡Œå¯ä»¥å®ç°å‘é€åˆ°å¤–éƒ¨ç›‘æ§æœåŠ¡</span></span><br><span class="line">        <span class="comment"># ä¾‹å¦‚ï¼šDataDog, New Relic, Grafana Cloudç­‰</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_active_users_count</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–æ´»è·ƒç”¨æˆ·æ•°ï¼ˆæ¨¡æ‹Ÿï¼‰&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># å®é™…åº”è¯¥ä»æ•°æ®åº“æˆ–ç¼“å­˜ä¸­è·å–</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">42</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_api_request</span>(<span class="params">self, method: <span class="built_in">str</span>, endpoint: <span class="built_in">str</span>, status: <span class="built_in">int</span>, duration: <span class="built_in">float</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è®°å½•APIè¯·æ±‚&quot;&quot;&quot;</span></span><br><span class="line">        REQUEST_COUNT.labels(method=method, endpoint=endpoint, status=status).inc()</span><br><span class="line">        REQUEST_LATENCY.labels(endpoint=endpoint).observe(duration)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®°å½•åˆ°å†å²</span></span><br><span class="line">        self._record_metric(</span><br><span class="line">            <span class="string">f&quot;api.request.<span class="subst">&#123;endpoint&#125;</span>.duration&quot;</span>,</span><br><span class="line">            duration,</span><br><span class="line">            datetime.utcnow(),</span><br><span class="line">            &#123;<span class="string">&quot;method&quot;</span>: method, <span class="string">&quot;status&quot;</span>: <span class="built_in">str</span>(status)&#125;</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_ai_response</span>(<span class="params">self, model: <span class="built_in">str</span>, duration: <span class="built_in">float</span>, tokens_used: <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è®°å½•AIå“åº”&quot;&quot;&quot;</span></span><br><span class="line">        AI_RESPONSE_TIME.observe(duration)</span><br><span class="line">        </span><br><span class="line">        self._record_metric(</span><br><span class="line">            <span class="string">&quot;ai.response.duration&quot;</span>,</span><br><span class="line">            duration,</span><br><span class="line">            datetime.utcnow(),</span><br><span class="line">            &#123;<span class="string">&quot;model&quot;</span>: model&#125;</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        self._record_metric(</span><br><span class="line">            <span class="string">&quot;ai.response.tokens&quot;</span>,</span><br><span class="line">            tokens_used,</span><br><span class="line">            datetime.utcnow(),</span><br><span class="line">            &#123;<span class="string">&quot;model&quot;</span>: model&#125;</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_database_query</span>(<span class="params">self, query_type: <span class="built_in">str</span>, duration: <span class="built_in">float</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è®°å½•æ•°æ®åº“æŸ¥è¯¢&quot;&quot;&quot;</span></span><br><span class="line">        DATABASE_QUERY_TIME.observe(duration)</span><br><span class="line">        </span><br><span class="line">        self._record_metric(</span><br><span class="line">            <span class="string">&quot;database.query.duration&quot;</span>,</span><br><span class="line">            duration,</span><br><span class="line">            datetime.utcnow(),</span><br><span class="line">            &#123;<span class="string">&quot;type&quot;</span>: query_type&#125;</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_system_status</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–ç³»ç»ŸçŠ¶æ€&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.system_metrics:</span><br><span class="line">            <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        recent_metrics = <span class="built_in">list</span>(self.system_metrics)[-<span class="number">60</span>:]  <span class="comment"># æœ€è¿‘60ä¸ªæ•°æ®ç‚¹</span></span><br><span class="line">        </span><br><span class="line">        cpu_values = [m[<span class="string">&quot;cpu&quot;</span>] <span class="keyword">for</span> m <span class="keyword">in</span> recent_metrics]</span><br><span class="line">        memory_values = [m[<span class="string">&quot;memory&quot;</span>] <span class="keyword">for</span> m <span class="keyword">in</span> recent_metrics]</span><br><span class="line">        disk_values = [m[<span class="string">&quot;disk&quot;</span>] <span class="keyword">for</span> m <span class="keyword">in</span> recent_metrics]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;cpu&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;current&quot;</span>: cpu_values[-<span class="number">1</span>] <span class="keyword">if</span> cpu_values <span class="keyword">else</span> <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;avg&quot;</span>: np.mean(cpu_values) <span class="keyword">if</span> cpu_values <span class="keyword">else</span> <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;max&quot;</span>: <span class="built_in">max</span>(cpu_values) <span class="keyword">if</span> cpu_values <span class="keyword">else</span> <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;trend&quot;</span>: self._calculate_trend(cpu_values)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;memory&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;current&quot;</span>: memory_values[-<span class="number">1</span>] <span class="keyword">if</span> memory_values <span class="keyword">else</span> <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;avg&quot;</span>: np.mean(memory_values) <span class="keyword">if</span> memory_values <span class="keyword">else</span> <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;max&quot;</span>: <span class="built_in">max</span>(memory_values) <span class="keyword">if</span> memory_values <span class="keyword">else</span> <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;trend&quot;</span>: self._calculate_trend(memory_values)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;disk&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;current&quot;</span>: disk_values[-<span class="number">1</span>] <span class="keyword">if</span> disk_values <span class="keyword">else</span> <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;avg&quot;</span>: np.mean(disk_values) <span class="keyword">if</span> disk_values <span class="keyword">else</span> <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;max&quot;</span>: <span class="built_in">max</span>(disk_values) <span class="keyword">if</span> disk_values <span class="keyword">else</span> <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;trend&quot;</span>: self._calculate_trend(disk_values)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;active_alerts&quot;</span>: <span class="built_in">len</span>([a <span class="keyword">for</span> a <span class="keyword">in</span> self.alerts.values() <span class="keyword">if</span> <span class="keyword">not</span> a.resolved]),</span><br><span class="line">            <span class="string">&quot;metrics_count&quot;</span>: <span class="built_in">len</span>(self.metrics_history),</span><br><span class="line">            <span class="string">&quot;uptime&quot;</span>: self._get_uptime()</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_calculate_trend</span>(<span class="params">self, values: <span class="type">List</span>[<span class="built_in">float</span>]</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è®¡ç®—è¶‹åŠ¿&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(values) &lt; <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;stable&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ä½¿ç”¨çº¿æ€§å›å½’è®¡ç®—è¶‹åŠ¿</span></span><br><span class="line">        x = np.arange(<span class="built_in">len</span>(values))</span><br><span class="line">        y = np.array(values)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®¡ç®—æ–œç‡</span></span><br><span class="line">        <span class="keyword">if</span> np.<span class="built_in">all</span>(x == x[<span class="number">0</span>]):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;stable&quot;</span></span><br><span class="line">        </span><br><span class="line">        slope = np.polyfit(x, y, <span class="number">1</span>)[<span class="number">0</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> slope &gt; <span class="number">0.1</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;increasing&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> slope &lt; -<span class="number">0.1</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;decreasing&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;stable&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_uptime</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–è¿è¡Œæ—¶é—´&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># å®é™…åº”è¯¥è®°å½•å¯åŠ¨æ—¶é—´</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;24h&quot;</span>  <span class="comment"># ç®€åŒ–å®ç°</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_alerts</span>(<span class="params">self, include_resolved: <span class="built_in">bool</span> = <span class="literal">False</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–å‘Šè­¦åˆ—è¡¨&quot;&quot;&quot;</span></span><br><span class="line">        alerts = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> alert <span class="keyword">in</span> self.alerts.values():</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> include_resolved <span class="keyword">and</span> alert.resolved:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            alerts.append(&#123;</span><br><span class="line">                <span class="string">&quot;id&quot;</span>: alert.<span class="built_in">id</span>,</span><br><span class="line">                <span class="string">&quot;severity&quot;</span>: alert.severity,</span><br><span class="line">                <span class="string">&quot;message&quot;</span>: alert.message,</span><br><span class="line">                <span class="string">&quot;metric&quot;</span>: alert.metric_name,</span><br><span class="line">                <span class="string">&quot;value&quot;</span>: alert.current_value,</span><br><span class="line">                <span class="string">&quot;threshold&quot;</span>: alert.threshold,</span><br><span class="line">                <span class="string">&quot;timestamp&quot;</span>: alert.timestamp.isoformat(),</span><br><span class="line">                <span class="string">&quot;resolved&quot;</span>: alert.resolved</span><br><span class="line">            &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sorted</span>(alerts, key=<span class="keyword">lambda</span> x: x[<span class="string">&quot;timestamp&quot;</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_metrics_summary</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–æŒ‡æ ‡æ‘˜è¦&quot;&quot;&quot;</span></span><br><span class="line">        summary = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> metric_name, metrics <span class="keyword">in</span> self.metrics_history.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> metrics:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            values = [m.value <span class="keyword">for</span> m <span class="keyword">in</span> metrics[-<span class="number">100</span>:]]  <span class="comment"># æœ€è¿‘100ä¸ªå€¼</span></span><br><span class="line">            </span><br><span class="line">            summary[metric_name] = &#123;</span><br><span class="line">                <span class="string">&quot;count&quot;</span>: <span class="built_in">len</span>(values),</span><br><span class="line">                <span class="string">&quot;min&quot;</span>: <span class="built_in">min</span>(values) <span class="keyword">if</span> values <span class="keyword">else</span> <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;max&quot;</span>: <span class="built_in">max</span>(values) <span class="keyword">if</span> values <span class="keyword">else</span> <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;avg&quot;</span>: np.mean(values) <span class="keyword">if</span> values <span class="keyword">else</span> <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;p95&quot;</span>: np.percentile(values, <span class="number">95</span>) <span class="keyword">if</span> values <span class="keyword">else</span> <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;latest&quot;</span>: values[-<span class="number">1</span>] <span class="keyword">if</span> values <span class="keyword">else</span> <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;latest_timestamp&quot;</span>: metrics[-<span class="number">1</span>].timestamp.isoformat() <span class="keyword">if</span> metrics <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> summary</span><br></pre></td></tr></table></figure>



<h2 id="ğŸ¯-æ‰©å±•åŠŸèƒ½å»ºè®®"><a href="#ğŸ¯-æ‰©å±•åŠŸèƒ½å»ºè®®" class="headerlink" title="ğŸ¯ æ‰©å±•åŠŸèƒ½å»ºè®®"></a>ğŸ¯ æ‰©å±•åŠŸèƒ½å»ºè®®</h2><h3 id="1-å•†ä¸šåŠŸèƒ½æ‰©å±•"><a href="#1-å•†ä¸šåŠŸèƒ½æ‰©å±•" class="headerlink" title="1. å•†ä¸šåŠŸèƒ½æ‰©å±•"></a>1. å•†ä¸šåŠŸèƒ½æ‰©å±•</h3><h4 id="1-1-å¤šç§Ÿæˆ·ç³»ç»Ÿ"><a href="#1-1-å¤šç§Ÿæˆ·ç³»ç»Ÿ" class="headerlink" title="1.1 å¤šç§Ÿæˆ·ç³»ç»Ÿ"></a>1.1 å¤šç§Ÿæˆ·ç³»ç»Ÿ</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/services/multi_tenant.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MultiTenantManager</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¤šç§Ÿæˆ·ç®¡ç†&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.tenants = &#123;&#125;  <span class="comment"># tenant_id -&gt; TenantConfig</span></span><br><span class="line">        self.tenant_databases = &#123;&#125;  <span class="comment"># tenant_id -&gt; database_url</span></span><br><span class="line">        self.isolation_levels = &#123;&#125;  <span class="comment"># tenant_id -&gt; isolation_level</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_tenant</span>(<span class="params">self, tenant_data</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆ›å»ºç§Ÿæˆ·&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">switch_tenant</span>(<span class="params">self, tenant_id</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆ‡æ¢ç§Ÿæˆ·&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>



<h4 id="1-2-ä»˜è´¹è®¢é˜…ç³»ç»Ÿ"><a href="#1-2-ä»˜è´¹è®¢é˜…ç³»ç»Ÿ" class="headerlink" title="1.2 ä»˜è´¹è®¢é˜…ç³»ç»Ÿ"></a>1.2 ä»˜è´¹è®¢é˜…ç³»ç»Ÿ</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/services/subscription.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SubscriptionManager</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è®¢é˜…ç®¡ç†ç³»ç»Ÿ&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    PLANS = &#123;</span><br><span class="line">        <span class="string">&quot;free&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;chat_limit&quot;</span>: <span class="number">100</span>,</span><br><span class="line">            <span class="string">&quot;ai_model&quot;</span>: <span class="string">&quot;gpt-3.5-turbo&quot;</span>,</span><br><span class="line">            <span class="string">&quot;storage&quot;</span>: <span class="number">100</span>,  <span class="comment"># MB</span></span><br><span class="line">            <span class="string">&quot;features&quot;</span>: [<span class="string">&quot;basic_chat&quot;</span>, <span class="string">&quot;history&quot;</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;pro&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;chat_limit&quot;</span>: <span class="number">1000</span>,</span><br><span class="line">            <span class="string">&quot;ai_model&quot;</span>: <span class="string">&quot;gpt-4&quot;</span>,</span><br><span class="line">            <span class="string">&quot;storage&quot;</span>: <span class="number">1000</span>,</span><br><span class="line">            <span class="string">&quot;features&quot;</span>: [<span class="string">&quot;advanced_ai&quot;</span>, <span class="string">&quot;analytics&quot;</span>, <span class="string">&quot;api_access&quot;</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;enterprise&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;chat_limit&quot;</span>: <span class="number">10000</span>,</span><br><span class="line">            <span class="string">&quot;ai_model&quot;</span>: <span class="string">&quot;gpt-4-turbo&quot;</span>,</span><br><span class="line">            <span class="string">&quot;storage&quot;</span>: <span class="number">10000</span>,</span><br><span class="line">            <span class="string">&quot;features&quot;</span>: [<span class="string">&quot;custom_model&quot;</span>, <span class="string">&quot;sla&quot;</span>, <span class="string">&quot;support&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-æŠ€æœ¯æ·±åº¦æ‰©å±•"><a href="#2-æŠ€æœ¯æ·±åº¦æ‰©å±•" class="headerlink" title="2. æŠ€æœ¯æ·±åº¦æ‰©å±•"></a>2. æŠ€æœ¯æ·±åº¦æ‰©å±•</h3><h4 id="2-1-æœºå™¨å­¦ä¹ å¹³å°é›†æˆ"><a href="#2-1-æœºå™¨å­¦ä¹ å¹³å°é›†æˆ" class="headerlink" title="2.1 æœºå™¨å­¦ä¹ å¹³å°é›†æˆ"></a>2.1 æœºå™¨å­¦ä¹ å¹³å°é›†æˆ</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># app/ml_platform/</span><br><span class="line"># â”œâ”€â”€ model_training.py</span><br><span class="line"># â”œâ”€â”€ model_serving.py</span><br><span class="line"># â”œâ”€â”€ feature_store.py</span><br><span class="line"># â””â”€â”€ experiment_tracking.py</span><br></pre></td></tr></table></figure>



<h4 id="2-2-å®æ—¶æµå¤„ç†"><a href="#2-2-å®æ—¶æµå¤„ç†" class="headerlink" title="2.2 å®æ—¶æµå¤„ç†"></a>2.2 å®æ—¶æµå¤„ç†</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># app/streaming/</span><br><span class="line"># â”œâ”€â”€ kafka_consumer.py</span><br><span class="line"># â”œâ”€â”€ spark_streaming.py</span><br><span class="line"># â””â”€â”€ flink_jobs.py</span><br></pre></td></tr></table></figure>



<h3 id="3-ç”¨æˆ·ä½“éªŒå¢å¼º"><a href="#3-ç”¨æˆ·ä½“éªŒå¢å¼º" class="headerlink" title="3. ç”¨æˆ·ä½“éªŒå¢å¼º"></a>3. ç”¨æˆ·ä½“éªŒå¢å¼º</h3><h4 id="3-1-è¯­éŸ³äº¤äº’"><a href="#3-1-è¯­éŸ³äº¤äº’" class="headerlink" title="3.1 è¯­éŸ³äº¤äº’"></a>3.1 è¯­éŸ³äº¤äº’</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/services/voice_service.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VoiceService</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è¯­éŸ³æœåŠ¡&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">speech_to_text</span>(<span class="params">self, audio_data</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è¯­éŸ³è½¬æ–‡å­—&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">text_to_speech</span>(<span class="params">self, text</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ–‡å­—è½¬è¯­éŸ³&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">voice_chat</span>(<span class="params">self, audio_input</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è¯­éŸ³èŠå¤©&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>



<h4 id="3-2-AR-VRé›†æˆ"><a href="#3-2-AR-VRé›†æˆ" class="headerlink" title="3.2 AR&#x2F;VRé›†æˆ"></a>3.2 AR&#x2F;VRé›†æˆ</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/services/ar_vr.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ARVRService</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;AR/VRæœåŠ¡&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_avatar</span>(<span class="params">self, user_data</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆ›å»ºè™šæ‹Ÿå½¢è±¡&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">render_3d_scene</span>(<span class="params">self, scene_data</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ¸²æŸ“3Dåœºæ™¯&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>



<h2 id="ğŸ“Š-æ€§èƒ½å¯¹æ¯”è¡¨"><a href="#ğŸ“Š-æ€§èƒ½å¯¹æ¯”è¡¨" class="headerlink" title="ğŸ“Š æ€§èƒ½å¯¹æ¯”è¡¨"></a>ğŸ“Š æ€§èƒ½å¯¹æ¯”è¡¨</h2><table>
<thead>
<tr>
<th align="left">ä¼˜åŒ–é¡¹</th>
<th align="left">ä¼˜åŒ–å‰</th>
<th align="left">ä¼˜åŒ–å</th>
<th align="left">æå‡å€æ•°</th>
</tr>
</thead>
<tbody><tr>
<td align="left">æ•°æ®åº“æŸ¥è¯¢</td>
<td align="left">200ms</td>
<td align="left">20ms</td>
<td align="left">10x</td>
</tr>
<tr>
<td align="left">ç¼“å­˜å‘½ä¸­ç‡</td>
<td align="left">30%</td>
<td align="left">85%</td>
<td align="left">2.8x</td>
</tr>
<tr>
<td align="left">AIå“åº”æ—¶é—´</td>
<td align="left">3s</td>
<td align="left">1.2s</td>
<td align="left">2.5x</td>
</tr>
<tr>
<td align="left">å¹¶å‘å¤„ç†</td>
<td align="left">100 QPS</td>
<td align="left">1000 QPS</td>
<td align="left">10x</td>
</tr>
<tr>
<td align="left">å†…å­˜ä½¿ç”¨</td>
<td align="left">2GB</td>
<td align="left">1.2GB</td>
<td align="left">1.7x</td>
</tr>
</tbody></table>
<h2 id="ğŸš€-éƒ¨ç½²æ¶æ„å‡çº§"><a href="#ğŸš€-éƒ¨ç½²æ¶æ„å‡çº§" class="headerlink" title="ğŸš€ éƒ¨ç½²æ¶æ„å‡çº§"></a>ğŸš€ éƒ¨ç½²æ¶æ„å‡çº§</h2><h3 id="1-Kuberneteséƒ¨ç½²"><a href="#1-Kuberneteséƒ¨ç½²" class="headerlink" title="1. Kuberneteséƒ¨ç½²"></a>1. Kuberneteséƒ¨ç½²</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># k8s/</span><br><span class="line"># â”œâ”€â”€ deployment.yaml</span><br><span class="line"># â”œâ”€â”€ service.yaml</span><br><span class="line"># â”œâ”€â”€ ingress.yaml</span><br><span class="line"># â”œâ”€â”€ configmap.yaml</span><br><span class="line"># â”œâ”€â”€ secret.yaml</span><br><span class="line"># â”œâ”€â”€ hpa.yaml (æ°´å¹³è‡ªåŠ¨æ‰©å±•)</span><br><span class="line"># â””â”€â”€ pdb.yaml (Podä¸­æ–­é¢„ç®—)</span><br></pre></td></tr></table></figure>



<h3 id="2-Serverlessæ¶æ„"><a href="#2-Serverlessæ¶æ„" class="headerlink" title="2. Serverlessæ¶æ„"></a>2. Serverlessæ¶æ„</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># serverless/</span><br><span class="line"># â”œâ”€â”€ lambda_functions/</span><br><span class="line"># â”œâ”€â”€ step_functions/</span><br><span class="line"># â”œâ”€â”€ api_gateway/</span><br><span class="line"># â””â”€â”€ cloud_formation/</span><br></pre></td></tr></table></figure>



<h3 id="3-å¤šäº‘éƒ¨ç½²"><a href="#3-å¤šäº‘éƒ¨ç½²" class="headerlink" title="3. å¤šäº‘éƒ¨ç½²"></a>3. å¤šäº‘éƒ¨ç½²</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># multi_cloud/</span><br><span class="line"># â”œâ”€â”€ aws/</span><br><span class="line"># â”œâ”€â”€ azure/</span><br><span class="line"># â”œâ”€â”€ gcp/</span><br><span class="line"># â””â”€â”€ hybrid/</span><br></pre></td></tr></table></figure>



<h2 id="ğŸ”§-å¼€å‘å·¥å…·é“¾å¢å¼º"><a href="#ğŸ”§-å¼€å‘å·¥å…·é“¾å¢å¼º" class="headerlink" title="ğŸ”§ å¼€å‘å·¥å…·é“¾å¢å¼º"></a>ğŸ”§ å¼€å‘å·¥å…·é“¾å¢å¼º</h2><h3 id="1-CI-CDæµæ°´çº¿"><a href="#1-CI-CDæµæ°´çº¿" class="headerlink" title="1. CI&#x2F;CDæµæ°´çº¿"></a>1. CI&#x2F;CDæµæ°´çº¿</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># .github/workflows/</span><br><span class="line"># â”œâ”€â”€ ci.yml</span><br><span class="line"># â”œâ”€â”€ cd.yml</span><br><span class="line"># â”œâ”€â”€ security-scan.yml</span><br><span class="line"># â””â”€â”€ performance-test.yml</span><br></pre></td></tr></table></figure>



<h3 id="2-å¼€å‘ç¯å¢ƒ"><a href="#2-å¼€å‘ç¯å¢ƒ" class="headerlink" title="2. å¼€å‘ç¯å¢ƒ"></a>2. å¼€å‘ç¯å¢ƒ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># devcontainer/</span><br><span class="line"># â”œâ”€â”€ Dockerfile</span><br><span class="line"># â”œâ”€â”€ docker-compose.yml</span><br><span class="line"># â””â”€â”€ devcontainer.json</span><br></pre></td></tr></table></figure>



<h2 id="ğŸ“ˆ-ç›‘æ§æŒ‡æ ‡æ‰©å±•"><a href="#ğŸ“ˆ-ç›‘æ§æŒ‡æ ‡æ‰©å±•" class="headerlink" title="ğŸ“ˆ ç›‘æ§æŒ‡æ ‡æ‰©å±•"></a>ğŸ“ˆ ç›‘æ§æŒ‡æ ‡æ‰©å±•</h2><h3 id="1-ä¸šåŠ¡æŒ‡æ ‡"><a href="#1-ä¸šåŠ¡æŒ‡æ ‡" class="headerlink" title="1. ä¸šåŠ¡æŒ‡æ ‡"></a>1. ä¸šåŠ¡æŒ‡æ ‡</h3><ul>
<li>ç”¨æˆ·æ´»è·ƒåº¦ï¼ˆDAU&#x2F;MAUï¼‰</li>
<li>ç•™å­˜ç‡</li>
<li>è½¬åŒ–ç‡</li>
<li>ç”¨æˆ·æ»¡æ„åº¦ï¼ˆNPSï¼‰</li>
</ul>
<h3 id="2-æŠ€æœ¯æŒ‡æ ‡"><a href="#2-æŠ€æœ¯æŒ‡æ ‡" class="headerlink" title="2. æŠ€æœ¯æŒ‡æ ‡"></a>2. æŠ€æœ¯æŒ‡æ ‡</h3><ul>
<li>P99å»¶è¿Ÿ</li>
<li>é”™è¯¯ç‡ï¼ˆSLO&#x2F;SLIï¼‰</li>
<li>èµ„æºåˆ©ç”¨ç‡</li>
<li>ç¼“å­˜æ•ˆç‡</li>
</ul>
<h3 id="3-AIæŒ‡æ ‡"><a href="#3-AIæŒ‡æ ‡" class="headerlink" title="3. AIæŒ‡æ ‡"></a>3. AIæŒ‡æ ‡</h3><ul>
<li>æ¨¡å‹å‡†ç¡®ç‡</li>
<li>æ„å›¾è¯†åˆ«å‡†ç¡®ç‡</li>
<li>å“åº”ç›¸å…³æ€§</li>
<li>ç”¨æˆ·åé¦ˆè¯„åˆ†</li>
</ul>
<h2 id="ğŸ¯-å®æ–½å»ºè®®"><a href="#ğŸ¯-å®æ–½å»ºè®®" class="headerlink" title="ğŸ¯ å®æ–½å»ºè®®"></a>ğŸ¯ å®æ–½å»ºè®®</h2><h3 id="ç¬¬ä¸€é˜¶æ®µï¼ˆ1-2ä¸ªæœˆï¼‰ï¼šåŸºç¡€ä¼˜åŒ–"><a href="#ç¬¬ä¸€é˜¶æ®µï¼ˆ1-2ä¸ªæœˆï¼‰ï¼šåŸºç¡€ä¼˜åŒ–" class="headerlink" title="ç¬¬ä¸€é˜¶æ®µï¼ˆ1-2ä¸ªæœˆï¼‰ï¼šåŸºç¡€ä¼˜åŒ–"></a>ç¬¬ä¸€é˜¶æ®µï¼ˆ1-2ä¸ªæœˆï¼‰ï¼šåŸºç¡€ä¼˜åŒ–</h3><ol>
<li>æ•°æ®åº“ç´¢å¼•å’ŒæŸ¥è¯¢ä¼˜åŒ–</li>
<li>Redisç¼“å­˜ç­–ç•¥å®ç°</li>
<li>å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—éƒ¨ç½²</li>
<li>åŸºç¡€ç›‘æ§å‘Šè­¦</li>
</ol>
<h3 id="ç¬¬äºŒé˜¶æ®µï¼ˆ2-3ä¸ªæœˆï¼‰ï¼šæ¶æ„å‡çº§"><a href="#ç¬¬äºŒé˜¶æ®µï¼ˆ2-3ä¸ªæœˆï¼‰ï¼šæ¶æ„å‡çº§" class="headerlink" title="ç¬¬äºŒé˜¶æ®µï¼ˆ2-3ä¸ªæœˆï¼‰ï¼šæ¶æ„å‡çº§"></a>ç¬¬äºŒé˜¶æ®µï¼ˆ2-3ä¸ªæœˆï¼‰ï¼šæ¶æ„å‡çº§</h3><ol>
<li>å¾®æœåŠ¡æ‹†åˆ†</li>
<li>APIç½‘å…³å®ç°</li>
<li>æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡</li>
<li>åˆ†å¸ƒå¼è¿½è¸ª</li>
</ol>
<h3 id="ç¬¬ä¸‰é˜¶æ®µï¼ˆ3-4ä¸ªæœˆï¼‰ï¼šAIå¢å¼º"><a href="#ç¬¬ä¸‰é˜¶æ®µï¼ˆ3-4ä¸ªæœˆï¼‰ï¼šAIå¢å¼º" class="headerlink" title="ç¬¬ä¸‰é˜¶æ®µï¼ˆ3-4ä¸ªæœˆï¼‰ï¼šAIå¢å¼º"></a>ç¬¬ä¸‰é˜¶æ®µï¼ˆ3-4ä¸ªæœˆï¼‰ï¼šAIå¢å¼º</h3><ol>
<li>å¤šæ¨¡å‹è·¯ç”±ç³»ç»Ÿ</li>
<li>RAGçŸ¥è¯†åº“å¢å¼º</li>
<li>æ¨¡å‹æ€§èƒ½ä¼˜åŒ–</li>
<li>å®æ—¶å­¦ä¹ ç³»ç»Ÿ</li>
</ol>
<h3 id="ç¬¬å››é˜¶æ®µï¼ˆæŒç»­ï¼‰ï¼šåˆ›æ–°æ‰©å±•"><a href="#ç¬¬å››é˜¶æ®µï¼ˆæŒç»­ï¼‰ï¼šåˆ›æ–°æ‰©å±•" class="headerlink" title="ç¬¬å››é˜¶æ®µï¼ˆæŒç»­ï¼‰ï¼šåˆ›æ–°æ‰©å±•"></a>ç¬¬å››é˜¶æ®µï¼ˆæŒç»­ï¼‰ï¼šåˆ›æ–°æ‰©å±•</h3><ol>
<li>è¯­éŸ³&#x2F;è§†è§‰èƒ½åŠ›</li>
<li>ä¸ªæ€§åŒ–æ¨è</li>
<li>é¢„æµ‹æ€§åˆ†æ</li>
<li>è‡ªåŠ¨åŒ–ä¼˜åŒ–</li>
</ol>
<h2 id="ğŸ’¡-åˆ›æ–°ç‚¹"><a href="#ğŸ’¡-åˆ›æ–°ç‚¹" class="headerlink" title="ğŸ’¡ åˆ›æ–°ç‚¹"></a>ğŸ’¡ åˆ›æ–°ç‚¹</h2><ol>
<li><strong>è‡ªé€‚åº”AIæ¨¡å‹é€‰æ‹©</strong>ï¼šæ ¹æ®æˆæœ¬ã€å»¶è¿Ÿã€å‡†ç¡®æ€§è‡ªåŠ¨é€‰æ‹©æœ€ä½³æ¨¡å‹</li>
<li><strong>å®æ—¶å­¦ä¹ ç³»ç»Ÿ</strong>ï¼šæ ¹æ®ç”¨æˆ·åé¦ˆå®æ—¶ä¼˜åŒ–æ¨¡å‹</li>
<li><strong>è¾¹ç¼˜è®¡ç®—æ”¯æŒ</strong>ï¼šåœ¨ç”¨æˆ·è®¾å¤‡ä¸Šè¿è¡Œè½»é‡çº§æ¨¡å‹</li>
<li><strong>è”é‚¦å­¦ä¹ </strong>ï¼šåœ¨ä¿æŠ¤éšç§çš„å‰æä¸‹å…±äº«å­¦ä¹ </li>
<li><strong>å¯è§£é‡ŠAI</strong>ï¼šæä¾›AIå†³ç­–çš„é€æ˜è§£é‡Š</li>
</ol>
<p>è¿™ä¸ªä¼˜åŒ–å’Œæ‰©å±•æ–¹æ¡ˆå°†ä½¿ä½ çš„AIèŠå¤©æœºå™¨äººç³»ç»Ÿä»â€èƒ½ç”¨â€å‡çº§åˆ°â€ä¼˜ç§€â€ï¼Œå…·å¤‡ä¼ä¸šçº§åº”ç”¨çš„æ€§èƒ½ã€å¯é æ€§å’Œæ‰©å±•æ€§ã€‚æ¯ä¸ªæ¨¡å—éƒ½å¯ä»¥ç‹¬ç«‹å®æ–½ï¼Œé€æ­¥æ”¹è¿›ç³»ç»Ÿèƒ½åŠ›ã€‚</p>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">
    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/43289129.html" rel="prev" title="Shellè„šæœ¬å®æˆ˜">
                  <i class="fa fa-angle-left"></i> Shellè„šæœ¬å®æˆ˜
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/ae6dd9bc.html" rel="next" title="Pythonå®è—çŒäººè®¾è®¡ä¸å®ç°">
                  Pythonå®è—çŒäººè®¾è®¡ä¸å®ç° <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa-regular fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder"></span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Word count total">368k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">22:18</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>

  <script class="next-config" data-name="wavedrom" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/wavedrom.min.js","integrity":"sha256-INLAoJc6quTNfiMWkGZniYO2cxE8mHpddnLow1m6RFs="}}</script>
  <script class="next-config" data-name="wavedrom_skin" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/skins/default.js","integrity":"sha256-fduc/Zszk5ezWws2uInY/ALWVmIrmV6VTgXbsYSReFI="}}</script>
  <script src="/js/third-party/tags/wavedrom.js"></script>




  





</body>
</html>
