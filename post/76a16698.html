<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"timewait7.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="多人聊天室实现我将为您实现一个功能丰富的多人聊天室应用，包含SpringBoot后端和美观的前端界面。 项目结构设计1234567891011121314chat-room&#x2F;├── src&#x2F;main&#x2F;java&#x2F;com&#x2F;chatroom&#x2F;│   ├── config&#x2F;           # 配置类│   ├── controller&#x2F;       # 控制器│   ├── model&#x2F;">
<meta property="og:type" content="article">
<meta property="og:title" content="Java实践:多人在线聊天室">
<meta property="og:url" content="http://timewait7.github.io/post/76a16698.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="多人聊天室实现我将为您实现一个功能丰富的多人聊天室应用，包含SpringBoot后端和美观的前端界面。 项目结构设计1234567891011121314chat-room&#x2F;├── src&#x2F;main&#x2F;java&#x2F;com&#x2F;chatroom&#x2F;│   ├── config&#x2F;           # 配置类│   ├── controller&#x2F;       # 控制器│   ├── model&#x2F;">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-12-17T11:06:31.000Z">
<meta property="article:modified_time" content="2025-12-19T15:31:38.480Z">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://timewait7.github.io/post/76a16698.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://timewait7.github.io/post/76a16698.html","path":"post/76a16698.html","title":"Java实践:多人在线聊天室"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Java实践:多人在线聊天室 | Hexo</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-archives"><a href="/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="Searching..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A4%9A%E4%BA%BA%E8%81%8A%E5%A4%A9%E5%AE%A4%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.</span> <span class="nav-text">多人聊天室实现</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.1.</span> <span class="nav-text">项目结构设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%90%8E%E7%AB%AF%E5%AE%9E%E7%8E%B0-Spring-Boot"><span class="nav-number">1.2.</span> <span class="nav-text">1. 后端实现 (Spring Boot)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-Maven%E4%BE%9D%E8%B5%96"><span class="nav-number">1.2.1.</span> <span class="nav-text">1.1 Maven依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E4%B8%BB%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E7%B1%BB"><span class="nav-number">1.2.2.</span> <span class="nav-text">1.2 主应用程序类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-WebSocket%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="nav-number">1.2.3.</span> <span class="nav-text">1.3 WebSocket配置类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E7%B1%BB"><span class="nav-number">1.2.4.</span> <span class="nav-text">1.4 数据模型类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E7%B1%BB"><span class="nav-number">1.2.5.</span> <span class="nav-text">1.5 用户管理类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-6-WebSocket%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="nav-number">1.2.6.</span> <span class="nav-text">1.6 WebSocket控制器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-7-%E5%BA%94%E7%94%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">1.2.7.</span> <span class="nav-text">1.7 应用配置文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%89%8D%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.3.</span> <span class="nav-text">2. 前端实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-HTML%E9%A1%B5%E9%9D%A2-index-html"><span class="nav-number">1.3.1.</span> <span class="nav-text">2.1 HTML页面 (index.html</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-CSS%E6%A0%B7%E5%BC%8F-chat-css"><span class="nav-number">1.3.2.</span> <span class="nav-text">2.2 CSS样式 (chat.css)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-JavaScript%E5%8A%9F%E8%83%BD-chat-js"><span class="nav-number">1.3.3.</span> <span class="nav-text">2.3 JavaScript功能 (chat.js)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E8%BF%90%E8%A1%8C%E8%AF%B4%E6%98%8E"><span class="nav-number">1.4.</span> <span class="nav-text">3. 运行说明</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-number">1.4.1.</span> <span class="nav-text">3.1 项目结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E8%BF%90%E8%A1%8C%E6%AD%A5%E9%AA%A4"><span class="nav-number">1.4.2.</span> <span class="nav-text">3.2 运行步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E8%AE%BF%E9%97%AE%E5%BA%94%E7%94%A8"><span class="nav-number">1.4.3.</span> <span class="nav-text">3.3 访问应用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%8A%9F%E8%83%BD%E7%89%B9%E7%82%B9"><span class="nav-number">1.5.</span> <span class="nav-text">4. 功能特点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD"><span class="nav-number">1.5.1.</span> <span class="nav-text">4.1 核心功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD"><span class="nav-number">1.5.2.</span> <span class="nav-text">4.2 高级功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-%E6%8A%80%E6%9C%AF%E7%89%B9%E7%82%B9"><span class="nav-number">1.5.3.</span> <span class="nav-text">4.3 技术特点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E6%89%A9%E5%B1%95%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.6.</span> <span class="nav-text">5. 扩展建议</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E5%8A%9F%E8%83%BD%E6%89%A9%E5%B1%95"><span class="nav-number">1.6.1.</span> <span class="nav-text">5.1 功能扩展</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E9%83%A8%E7%BD%B2%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.6.2.</span> <span class="nav-text">5.2 部署建议</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A4%9A%E4%BA%BA%E8%81%8A%E5%A4%A9%E5%AE%A4%E6%89%A9%E5%B1%95"><span class="nav-number">2.</span> <span class="nav-text">多人聊天室扩展</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E5%8A%9F%E8%83%BD%E6%B8%85%E5%8D%95"><span class="nav-number">2.1.</span> <span class="nav-text">扩展功能清单</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1-MySQL"><span class="nav-number">2.2.</span> <span class="nav-text">1. 数据库设计 (MySQL)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-SQL-%E8%84%9A%E6%9C%AC"><span class="nav-number">2.2.1.</span> <span class="nav-text">1.1 SQL 脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E6%9B%B4%E6%96%B0pom-xml%E4%BE%9D%E8%B5%96"><span class="nav-number">2.2.2.</span> <span class="nav-text">1.2 更新pom.xml依赖</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-JPA%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="nav-number">2.3.</span> <span class="nav-text">2. JPA实体类</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-User-%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="nav-number">2.3.1.</span> <span class="nav-text">2.1 User 实体类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-Message-%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="nav-number">2.3.2.</span> <span class="nav-text">2.2 Message 实体类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E5%85%B6%E4%BB%96%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="nav-number">2.3.3.</span> <span class="nav-text">2.3 其他实体类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Spring-Security%E9%85%8D%E7%BD%AE"><span class="nav-number">2.4.</span> <span class="nav-text">3. Spring Security配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-Security%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="nav-number">2.4.1.</span> <span class="nav-text">3.1 Security配置类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-JWT%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="nav-number">2.4.2.</span> <span class="nav-text">3.2 JWT工具类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-JWT%E8%AE%A4%E8%AF%81%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-number">2.4.3.</span> <span class="nav-text">3.3 JWT认证过滤器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E8%AE%A4%E8%AF%81%E5%92%8C%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86API"><span class="nav-number">2.5.</span> <span class="nav-text">4. 认证和用户管理API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E8%AE%A4%E8%AF%81%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="nav-number">2.5.1.</span> <span class="nav-text">4.1 认证控制器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-DTO%E7%B1%BB"><span class="nav-number">2.5.2.</span> <span class="nav-text">4.2 DTO类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E6%89%A9%E5%B1%95WebSocket%E5%8A%9F%E8%83%BD"><span class="nav-number">2.6.</span> <span class="nav-text">5. 扩展WebSocket功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-WebSocket%E8%AE%A4%E8%AF%81%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="nav-number">2.6.1.</span> <span class="nav-text">5.1 WebSocket认证拦截器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E5%A2%9E%E5%BC%BA%E7%9A%84WebSocket%E9%85%8D%E7%BD%AE"><span class="nav-number">2.6.2.</span> <span class="nav-text">5.2 增强的WebSocket配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-%E5%A2%9E%E5%BC%BA%E7%9A%84WebSocket%E5%A4%84%E7%90%86%E5%99%A8"><span class="nav-number">2.6.3.</span> <span class="nav-text">5.3 增强的WebSocket处理器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%8A%9F%E8%83%BD"><span class="nav-number">2.7.</span> <span class="nav-text">6. 文件上传功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%85%8D%E7%BD%AE"><span class="nav-number">2.7.1.</span> <span class="nav-text">6.1 文件上传配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1%E7%B1%BB"><span class="nav-number">2.7.2.</span> <span class="nav-text">6.2 文件服务类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E5%89%8D%E7%AB%AF%E6%89%A9%E5%B1%95"><span class="nav-number">2.8.</span> <span class="nav-text">7. 前端扩展</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-%E5%A2%9E%E5%BC%BA%E7%9A%84%E8%81%8A%E5%A4%A9%E9%A1%B5%E9%9D%A2-index-html%E6%89%A9%E5%B1%95"><span class="nav-number">2.8.1.</span> <span class="nav-text">7.1 增强的聊天页面 (index.html扩展)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-%E5%A2%9E%E5%BC%BA%E7%9A%84CSS%E6%A0%B7"><span class="nav-number">2.8.2.</span> <span class="nav-text">7.2 增强的CSS样</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-%E5%A2%9E%E5%BC%BA%E7%9A%84JavaScript%E5%8A%9F%E8%83%BD"><span class="nav-number">2.8.3.</span> <span class="nav-text">7.3 增强的JavaScript功能</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-%E5%BA%94%E7%94%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%9B%B4%E6%96%B0"><span class="nav-number">2.9.</span> <span class="nav-text">8. 应用配置文件更新</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-application-yml"><span class="nav-number">2.9.1.</span> <span class="nav-text">8.1 application.yml</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-Docker%E6%94%AF%E6%8C%81"><span class="nav-number">2.10.</span> <span class="nav-text">9. Docker支持</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-Dockerfile"><span class="nav-number">2.10.1.</span> <span class="nav-text">9.1 Dockerfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-docker-compose-yml"><span class="nav-number">2.10.2.</span> <span class="nav-text">9.2 docker-compose.yml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-3-Nginx%E9%85%8D%E7%BD%AE-nginx-conf"><span class="nav-number">2.10.3.</span> <span class="nav-text">9.3 Nginx配置 (nginx.conf)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-%E7%9B%91%E6%8E%A7%E5%92%8C%E8%BF%90%E7%BB%B4"><span class="nav-number">2.11.</span> <span class="nav-text">10. 监控和运维</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-1-Spring-Boot-Actuator%E9%85%8D%E7%BD%AE"><span class="nav-number">2.11.1.</span> <span class="nav-text">10.1 Spring Boot Actuator配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-2-%E5%BA%94%E7%94%A8%E7%9B%91%E6%8E%A7%E7%AB%AF%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="nav-number">2.11.2.</span> <span class="nav-text">10.2 应用监控端点配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">2.12.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A4%9A%E4%BA%BA%E8%81%8A%E5%A4%A9%E5%AE%A4%E5%86%8D%E6%89%A9%E5%B1%95"><span class="nav-number">3.</span> <span class="nav-text">多人聊天室再扩展</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E5%8A%9F%E8%83%BD%E6%B8%85%E5%8D%95-1"><span class="nav-number">3.1.</span> <span class="nav-text">扩展功能清单</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">3.2.</span> <span class="nav-text">1. 微服务架构设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-number">3.2.1.</span> <span class="nav-text">1.1 项目结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-API%E7%BD%91%E5%85%B3%E9%85%8D%E7%BD%AE-Gateway"><span class="nav-number">3.2.2.</span> <span class="nav-text">1.2 API网关配置 (Gateway)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-AI%E8%81%8A%E5%A4%A9%E5%8A%A9%E6%89%8B%E9%9B%86%E6%88%90"><span class="nav-number">3.3.</span> <span class="nav-text">2. AI聊天助手集成</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-AI%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE"><span class="nav-number">3.3.1.</span> <span class="nav-text">2.1 AI服务配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-AI%E6%8E%A7%E5%88%B6"><span class="nav-number">3.3.2.</span> <span class="nav-text">2.2 AI控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-AI%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="nav-number">3.3.3.</span> <span class="nav-text">2.3 AI配置类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-WebRTC%E8%A7%86%E9%A2%91%E9%80%9A%E8%AF%9D"><span class="nav-number">3.4.</span> <span class="nav-text">3. WebRTC视频通话</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E4%BF%A1%E4%BB%A4%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">3.4.1.</span> <span class="nav-text">3.1 信令服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E4%BF%A1%E4%BB%A4%E6%B6%88%E6%81%AF%E7%B1%BB"><span class="nav-number">3.4.2.</span> <span class="nav-text">3.2 信令消息类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-WebRTC%E9%85%8D%E7%BD%AE"><span class="nav-number">3.4.3.</span> <span class="nav-text">3.3 WebRTC配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%89%8D%E7%AB%AF%E8%A7%86%E9%A2%91%E9%80%9A%E8%AF%9D%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.5.</span> <span class="nav-text">4. 前端视频通话实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-WebRTC%E5%89%8D%E7%AB%AF%E7%BB%84%E4%BB%B6"><span class="nav-number">3.5.1.</span> <span class="nav-text">4.1 WebRTC前端组件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E8%A7%86%E9%A2%91%E9%80%9A%E8%AF%9DUI%E7%BB%84%E4%BB%B6"><span class="nav-number">3.5.2.</span> <span class="nav-text">4.2 视频通话UI组件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-%E8%A7%86%E9%A2%91%E9%80%9A%E8%AF%9DCSS"><span class="nav-number">3.5.3.</span> <span class="nav-text">4.3 视频通话CSS</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E9%9B%86%E6%88%90"><span class="nav-number">3.6.</span> <span class="nav-text">5. 消息队列集成</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-Kafka%E9%85%8D%E7%BD%AE"><span class="nav-number">3.6.1.</span> <span class="nav-text">5.1 Kafka配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-Kafka%E7%94%9F%E4%BA%A7%E8%80%85"><span class="nav-number">3.6.2.</span> <span class="nav-text">5.2 Kafka生产者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-Kafka%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-number">3.6.3.</span> <span class="nav-text">5.3 Kafka消费者</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E5%AE%9E%E6%97%B6%E5%8D%8F%E4%BD%9C%E7%99%BD%E6%9D%BF"><span class="nav-number">3.7.</span> <span class="nav-text">6. 实时协作白板</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%E7%99%BD%E6%9D%BF%E5%90%8E%E7%AB%AF"><span class="nav-number">3.7.1.</span> <span class="nav-text">6.1 白板后端</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-Kubernetes%E9%83%A8%E7%BD%B2%E9%85%8D%E7%BD%AE"><span class="nav-number">3.8.</span> <span class="nav-text">7. Kubernetes部署配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-Kubernetes%E9%83%A8%E7%BD%B2%E6%96%87%E4%BB%B6"><span class="nav-number">3.8.1.</span> <span class="nav-text">7.1 Kubernetes部署文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-Helm-Chart"><span class="nav-number">3.8.2.</span> <span class="nav-text">7.2 Helm Chart</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-%E7%9B%91%E6%8E%A7%E5%92%8C%E5%91%8A%E8%AD%A6"><span class="nav-number">3.9.</span> <span class="nav-text">8. 监控和告警</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-Prometheus%E9%85%8D%E7%BD%AE"><span class="nav-number">3.9.1.</span> <span class="nav-text">8.1 Prometheus配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-Grafana%E4%BB%AA%E8%A1%A8%E6%9D%BF"><span class="nav-number">3.9.2.</span> <span class="nav-text">8.2 Grafana仪表板</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-CI-CD%E6%B5%81%E6%B0%B4%E7%BA%BF"><span class="nav-number">3.10.</span> <span class="nav-text">9. CI&#x2F;CD流水线</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-GitLab-CI%E9%85%8D%E7%BD%AE"><span class="nav-number">3.10.1.</span> <span class="nav-text">9.1 GitLab CI配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-1"><span class="nav-number">3.11.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/">
          <span class="site-state-item-count">52</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://timewait7.github.io/post/76a16698.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Java实践:多人在线聊天室 | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Java实践:多人在线聊天室
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-12-17 19:06:31" itemprop="dateCreated datePublished" datetime="2025-12-17T19:06:31+08:00">2025-12-17</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>23k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1:23</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="多人聊天室实现"><a href="#多人聊天室实现" class="headerlink" title="多人聊天室实现"></a>多人聊天室实现</h1><p>我将为您实现一个功能丰富的多人聊天室应用，包含SpringBoot后端和美观的前端界面。</p>
<h2 id="项目结构设计"><a href="#项目结构设计" class="headerlink" title="项目结构设计"></a>项目结构设计</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">chat-room/</span><br><span class="line">├── src/main/java/com/chatroom/</span><br><span class="line">│   ├── config/           # 配置类</span><br><span class="line">│   ├── controller/       # 控制器</span><br><span class="line">│   ├── model/           # 数据模型</span><br><span class="line">│   ├── service/         # 业务逻辑</span><br><span class="line">│   ├── websocket/       # WebSocket配置</span><br><span class="line">│   └── ChatRoomApplication.java</span><br><span class="line">├── src/main/resources/</span><br><span class="line">│   ├── static/          # 静态资源(HTML/CSS/JS)</span><br><span class="line">│   ├── templates/       # 模板文件</span><br><span class="line">│   └── application.yml</span><br><span class="line">├── pom.xml</span><br><span class="line">└── README.md</span><br></pre></td></tr></table></figure>



<h2 id="1-后端实现-Spring-Boot"><a href="#1-后端实现-Spring-Boot" class="headerlink" title="1. 后端实现 (Spring Boot)"></a>1. 后端实现 (Spring Boot)</h2><h3 id="1-1-Maven依赖"><a href="#1-1-Maven依赖" class="headerlink" title="1.1 Maven依赖"></a>1.1 Maven依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 </span></span></span><br><span class="line"><span class="string"><span class="tag">         http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.chatroom<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>chat-room<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Chat Room Application<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>11<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Spring Boot Web --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- WebSocket --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- Thymeleaf (可选，用于模板) --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- JSON处理 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- 开发工具 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- 测试 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="1-2-主应用程序类"><a href="#1-2-主应用程序类" class="headerlink" title="1.2 主应用程序类"></a>1.2 主应用程序类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatRoomApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ChatRoomApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-3-WebSocket配置类"><a href="#1-3-WebSocket配置类" class="headerlink" title="1.3 WebSocket配置类"></a>1.3 WebSocket配置类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.simp.config.MessageBrokerRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.config.annotation.EnableWebSocketMessageBroker;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.config.annotation.StompEndpointRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.config.annotation.WebSocketMessageBrokerConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSocketMessageBroker</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketConfig</span> <span class="keyword">implements</span> <span class="title class_">WebSocketMessageBrokerConfigurer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureMessageBroker</span><span class="params">(MessageBrokerRegistry config)</span> &#123;</span><br><span class="line">        <span class="comment">// 启用简单代理，处理以/topic开头的消息</span></span><br><span class="line">        config.enableSimpleBroker(<span class="string">&quot;/topic&quot;</span>, <span class="string">&quot;/queue&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置应用程序前缀，客户端发送消息需要以/app开头</span></span><br><span class="line">        config.setApplicationDestinationPrefixes(<span class="string">&quot;/app&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置用户目的地前缀</span></span><br><span class="line">        config.setUserDestinationPrefix(<span class="string">&quot;/user&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerStompEndpoints</span><span class="params">(StompEndpointRegistry registry)</span> &#123;</span><br><span class="line">        <span class="comment">// 注册WebSocket端点，允许跨域</span></span><br><span class="line">        registry.addEndpoint(<span class="string">&quot;/ws-chat&quot;</span>)</span><br><span class="line">                .setAllowedOriginPatterns(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">                .withSockJS();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-4-数据模型类"><a href="#1-4-数据模型类" class="headerlink" title="1.4 数据模型类"></a>1.4 数据模型类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatMessage</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> MessageType type;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    <span class="keyword">private</span> String sender;</span><br><span class="line">    <span class="keyword">private</span> String receiver;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime timestamp;</span><br><span class="line">    <span class="keyword">private</span> String avatarColor;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">MessageType</span> &#123;</span><br><span class="line">        CHAT, JOIN, LEAVE, TYPING, NOTIFICATION</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构造函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ChatMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.timestamp = LocalDateTime.now();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ChatMessage</span><span class="params">(MessageType type, String content, String sender)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">        <span class="built_in">this</span>.content = content;</span><br><span class="line">        <span class="built_in">this</span>.sender = sender;</span><br><span class="line">        <span class="built_in">this</span>.timestamp = LocalDateTime.now();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Getter和Setter方法</span></span><br><span class="line">    <span class="keyword">public</span> MessageType <span class="title function_">getType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> type;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setType</span><span class="params">(MessageType type)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getContent</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> content;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setContent</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.content = content;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSender</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sender;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSender</span><span class="params">(String sender)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sender = sender;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getReceiver</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> receiver;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setReceiver</span><span class="params">(String receiver)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.receiver = receiver;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> LocalDateTime <span class="title function_">getTimestamp</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> timestamp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTimestamp</span><span class="params">(LocalDateTime timestamp)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.timestamp = timestamp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAvatarColor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> avatarColor;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAvatarColor</span><span class="params">(String avatarColor)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.avatarColor = avatarColor;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ChatMessage&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;type=&quot;</span> + type +</span><br><span class="line">                <span class="string">&quot;, content=&#x27;&quot;</span> + content + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, sender=&#x27;&quot;</span> + sender + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, receiver=&#x27;&quot;</span> + receiver + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, timestamp=&quot;</span> + timestamp +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-5-用户管理类"><a href="#1-5-用户管理类" class="headerlink" title="1.5 用户管理类"></a>1.5 用户管理类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserSession</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String sessionId;</span><br><span class="line">    <span class="keyword">private</span> String avatarColor;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> isOnline;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, UserSession&gt; activeUsers = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserSession</span><span class="params">(String username, String sessionId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.username = username;</span><br><span class="line">        <span class="built_in">this</span>.sessionId = sessionId;</span><br><span class="line">        <span class="built_in">this</span>.avatarColor = generateAvatarColor();</span><br><span class="line">        <span class="built_in">this</span>.isOnline = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">generateAvatarColor</span><span class="params">()</span> &#123;</span><br><span class="line">        String[] colors = &#123;</span><br><span class="line">            <span class="string">&quot;#FF6B6B&quot;</span>, <span class="string">&quot;#4ECDC4&quot;</span>, <span class="string">&quot;#FFD166&quot;</span>, <span class="string">&quot;#06D6A0&quot;</span>, </span><br><span class="line">            <span class="string">&quot;#118AB2&quot;</span>, <span class="string">&quot;#073B4C&quot;</span>, <span class="string">&quot;#EF476F&quot;</span>, <span class="string">&quot;#7209B7&quot;</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> colors[Math.abs(username.hashCode()) % colors.length];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addUser</span><span class="params">(String username, String sessionId)</span> &#123;</span><br><span class="line">        activeUsers.put(username, <span class="keyword">new</span> <span class="title class_">UserSession</span>(username, sessionId));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">removeUser</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        activeUsers.remove(username);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;String&gt; <span class="title function_">getOnlineUsers</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(activeUsers.keySet());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> UserSession <span class="title function_">getUser</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> activeUsers.get(username);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getOnlineCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> activeUsers.size();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Getter和Setter方法</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSessionId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sessionId;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAvatarColor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> avatarColor;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isOnline</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> isOnline;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOnline</span><span class="params">(<span class="type">boolean</span> online)</span> &#123;</span><br><span class="line">        isOnline = online;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-6-WebSocket控制器"><a href="#1-6-WebSocket控制器" class="headerlink" title="1.6 WebSocket控制器"></a>1.6 WebSocket控制器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.chatroom.model.ChatMessage;</span><br><span class="line"><span class="keyword">import</span> com.chatroom.model.UserSession;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.handler.annotation.MessageMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.handler.annotation.Payload;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.handler.annotation.SendTo;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.simp.SimpMessageHeaderAccessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.simp.SimpMessagingTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SimpMessagingTemplate messagingTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 处理用户加入聊天室</span></span><br><span class="line">    <span class="meta">@MessageMapping(&quot;/chat.addUser&quot;)</span></span><br><span class="line">    <span class="meta">@SendTo(&quot;/topic/public&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ChatMessage <span class="title function_">addUser</span><span class="params">(<span class="meta">@Payload</span> ChatMessage chatMessage, </span></span><br><span class="line"><span class="params">                              SimpMessageHeaderAccessor headerAccessor)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> chatMessage.getSender();</span><br><span class="line">        <span class="type">String</span> <span class="variable">sessionId</span> <span class="operator">=</span> headerAccessor.getSessionId();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 添加用户到在线列表</span></span><br><span class="line">        UserSession.addUser(username, sessionId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置头像颜色</span></span><br><span class="line">        chatMessage.setAvatarColor(UserSession.getUser(username).getAvatarColor());</span><br><span class="line">        chatMessage.setType(ChatMessage.MessageType.JOIN);</span><br><span class="line">        chatMessage.setContent(username + <span class="string">&quot; 加入了聊天室&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 广播在线用户列表更新</span></span><br><span class="line">        broadcastOnlineUsers();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> chatMessage;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 处理发送消息</span></span><br><span class="line">    <span class="meta">@MessageMapping(&quot;/chat.sendMessage&quot;)</span></span><br><span class="line">    <span class="meta">@SendTo(&quot;/topic/public&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ChatMessage <span class="title function_">sendMessage</span><span class="params">(<span class="meta">@Payload</span> ChatMessage chatMessage)</span> &#123;</span><br><span class="line">        chatMessage.setType(ChatMessage.MessageType.CHAT);</span><br><span class="line">        chatMessage.setTimestamp(java.time.LocalDateTime.now());</span><br><span class="line">        <span class="keyword">return</span> chatMessage;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 处理私聊消息</span></span><br><span class="line">    <span class="meta">@MessageMapping(&quot;/chat.sendPrivateMessage&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendPrivateMessage</span><span class="params">(<span class="meta">@Payload</span> ChatMessage chatMessage)</span> &#123;</span><br><span class="line">        chatMessage.setType(ChatMessage.MessageType.CHAT);</span><br><span class="line">        chatMessage.setTimestamp(java.time.LocalDateTime.now());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 发送给特定用户</span></span><br><span class="line">        messagingTemplate.convertAndSendToUser(</span><br><span class="line">            chatMessage.getReceiver(), </span><br><span class="line">            <span class="string">&quot;/queue/private&quot;</span>, </span><br><span class="line">            chatMessage</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 同时发送给自己（用于显示发送的消息）</span></span><br><span class="line">        messagingTemplate.convertAndSendToUser(</span><br><span class="line">            chatMessage.getSender(), </span><br><span class="line">            <span class="string">&quot;/queue/private&quot;</span>, </span><br><span class="line">            chatMessage</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 处理用户离开</span></span><br><span class="line">    <span class="meta">@MessageMapping(&quot;/chat.leave&quot;)</span></span><br><span class="line">    <span class="meta">@SendTo(&quot;/topic/public&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ChatMessage <span class="title function_">leaveUser</span><span class="params">(<span class="meta">@Payload</span> ChatMessage chatMessage)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> chatMessage.getSender();</span><br><span class="line">        </span><br><span class="line">        UserSession.removeUser(username);</span><br><span class="line">        </span><br><span class="line">        chatMessage.setType(ChatMessage.MessageType.LEAVE);</span><br><span class="line">        chatMessage.setContent(username + <span class="string">&quot; 离开了聊天室&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 广播在线用户列表更新</span></span><br><span class="line">        broadcastOnlineUsers();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> chatMessage;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 处理用户正在输入</span></span><br><span class="line">    <span class="meta">@MessageMapping(&quot;/chat.typing&quot;)</span></span><br><span class="line">    <span class="meta">@SendTo(&quot;/topic/public&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ChatMessage <span class="title function_">userTyping</span><span class="params">(<span class="meta">@Payload</span> ChatMessage chatMessage)</span> &#123;</span><br><span class="line">        chatMessage.setType(ChatMessage.MessageType.TYPING);</span><br><span class="line">        <span class="keyword">return</span> chatMessage;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 广播在线用户列表</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">broadcastOnlineUsers</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ChatMessage</span> <span class="variable">notification</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChatMessage</span>();</span><br><span class="line">        notification.setType(ChatMessage.MessageType.NOTIFICATION);</span><br><span class="line">        notification.setContent(String.valueOf(UserSession.getOnlineCount()));</span><br><span class="line">        notification.setSender(<span class="string">&quot;SYSTEM&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 发送在线用户数量</span></span><br><span class="line">        messagingTemplate.convertAndSend(<span class="string">&quot;/topic/onlineUsers&quot;</span>, </span><br><span class="line">            UserSession.getOnlineUsers());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 主页面</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-7-应用配置文件"><a href="#1-7-应用配置文件" class="headerlink" title="1.7 应用配置文件"></a>1.7 应用配置文件</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># src/main/resources/application.yml</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">chat-room</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 静态资源路径</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">static-locations:</span> <span class="string">classpath:/static/</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Thymeleaf配置</span></span><br><span class="line">  <span class="attr">thymeleaf:</span></span><br><span class="line">    <span class="attr">cache:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">prefix:</span> <span class="string">classpath:/templates/</span></span><br><span class="line">    <span class="attr">suffix:</span> <span class="string">.html</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">HTML</span></span><br><span class="line">    <span class="attr">encoding:</span> <span class="string">UTF-8</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 配置支持的最大消息大小</span></span><br><span class="line">  <span class="attr">max-http-header-size:</span> <span class="string">64KB</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.chatroom:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="attr">org.springframework.web.socket:</span> <span class="string">INFO</span></span><br></pre></td></tr></table></figure>



<h2 id="2-前端实现"><a href="#2-前端实现" class="headerlink" title="2. 前端实现"></a>2. 前端实现</h2><h3 id="2-1-HTML页面-index-html"><a href="#2-1-HTML页面-index-html" class="headerlink" title="2.1 HTML页面 (index.html"></a>2.1 HTML页面 (index.html</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh-CN&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>多人聊天室<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;css/chat.css&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&amp;display=swap&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 侧边栏 - 用户列表 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;sidebar&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;sidebar-header&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h2</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-comments&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 聊天室<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;online-status&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;status-indicator online&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;onlineCount&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span> 人在线</span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            </span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;user-profile&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;avatar&quot;</span> <span class="attr">id</span>=<span class="string">&quot;userAvatar&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;user-info&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h3</span> <span class="attr">id</span>=<span class="string">&quot;usernameDisplay&quot;</span>&gt;</span>请设置用户名<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;userStatus&quot;</span>&gt;</span>离线<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;changeUsernameBtn&quot;</span> <span class="attr">class</span>=<span class="string">&quot;icon-btn&quot;</span> <span class="attr">title</span>=<span class="string">&quot;更改用户名&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-edit&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            </span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;search-box&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;userSearch&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;搜索用户...&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-search&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            </span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;users-list&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h3</span>&gt;</span>在线用户 (<span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;userCount&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span>)<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;onlineUsersList&quot;</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- 用户列表将通过JS动态添加 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            </span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;chat-rooms&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h3</span>&gt;</span>聊天室<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;active&quot;</span> <span class="attr">data-room</span>=<span class="string">&quot;public&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-globe&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 公共聊天室</span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;badge&quot;</span> <span class="attr">id</span>=<span class="string">&quot;publicRoomCount&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">data-room</span>=<span class="string">&quot;private&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-user-friends&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 私聊</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- 主聊天区域 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;main-chat&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 聊天头 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;chat-header&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;chat-info&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h2</span> <span class="attr">id</span>=<span class="string">&quot;currentChatRoom&quot;</span>&gt;</span>公共聊天室<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;roomDescription&quot;</span>&gt;</span>与所有在线用户聊天<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;chat-actions&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;clearChatBtn&quot;</span> <span class="attr">class</span>=<span class="string">&quot;action-btn&quot;</span> <span class="attr">title</span>=<span class="string">&quot;清空聊天记录&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-trash&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;themeToggleBtn&quot;</span> <span class="attr">class</span>=<span class="string">&quot;action-btn&quot;</span> <span class="attr">title</span>=<span class="string">&quot;切换主题&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-moon&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;notificationsBtn&quot;</span> <span class="attr">class</span>=<span class="string">&quot;action-btn&quot;</span> <span class="attr">title</span>=<span class="string">&quot;通知设置&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-bell&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">&lt;!-- 消息区域 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;messages-container&quot;</span> <span class="attr">id</span>=<span class="string">&quot;messagesContainer&quot;</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 消息将通过JS动态添加 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;welcome-message&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;welcome-icon&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-comment-dots&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>欢迎来到聊天室!<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">p</span>&gt;</span>开始与大家聊天吧！输入消息并按回车键发送。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">&lt;!-- 输入区域 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-container&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-actions&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;input-action-btn&quot;</span> <span class="attr">title</span>=<span class="string">&quot;表情&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;far fa-smile&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;input-action-btn&quot;</span> <span class="attr">title</span>=<span class="string">&quot;上传文件&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-paperclip&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;input-action-btn&quot;</span> <span class="attr">title</span>=<span class="string">&quot;语音消息&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-microphone&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                </span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;message-input-wrapper&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">textarea</span> </span></span><br><span class="line"><span class="tag">                        <span class="attr">id</span>=<span class="string">&quot;messageInput&quot;</span> </span></span><br><span class="line"><span class="tag">                        <span class="attr">placeholder</span>=<span class="string">&quot;输入消息... (按Ctrl+Enter换行)&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">rows</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">disabled</span></span></span><br><span class="line"><span class="tag">                    &gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;typing-indicator&quot;</span> <span class="attr">id</span>=<span class="string">&quot;typingIndicator&quot;</span>&gt;</span></span><br><span class="line">                        有人正在输入...</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                </span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;sendButton&quot;</span> <span class="attr">class</span>=<span class="string">&quot;send-btn&quot;</span> <span class="attr">disabled</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-paper-plane&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- 私聊侧边栏 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;private-sidebar&quot;</span> <span class="attr">id</span>=<span class="string">&quot;privateSidebar&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;private-header&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h3</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-user-secret&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 私聊<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;closePrivateBtn&quot;</span> <span class="attr">class</span>=<span class="string">&quot;close-btn&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-times&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;private-chats&quot;</span> <span class="attr">id</span>=<span class="string">&quot;privateChats&quot;</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 私聊会话将通过JS动态添加 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 用户名设置模态框 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal-overlay&quot;</span> <span class="attr">id</span>=<span class="string">&quot;usernameModal&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal-header&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h3</span>&gt;</span>设置用户名<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;close-modal&quot;</span>&gt;</span><span class="symbol">&amp;times;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal-body&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;usernameInput&quot;</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> </span></span><br><span class="line"><span class="tag">                        <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> </span></span><br><span class="line"><span class="tag">                        <span class="attr">id</span>=<span class="string">&quot;usernameInput&quot;</span> </span></span><br><span class="line"><span class="tag">                        <span class="attr">placeholder</span>=<span class="string">&quot;输入您的用户名&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">maxlength</span>=<span class="string">&quot;20&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span></span></span><br><span class="line"><span class="tag">                    &gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;error-message&quot;</span> <span class="attr">id</span>=<span class="string">&quot;usernameError&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;avatar-selection&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">p</span>&gt;</span>选择头像颜色:<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;color-options&quot;</span> <span class="attr">id</span>=<span class="string">&quot;colorOptions&quot;</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 颜色选项将通过JS动态生成 --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal-footer&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;joinChatBtn&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn-primary&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-sign-in-alt&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 加入聊天室</span><br><span class="line">                <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 通知设置模态框 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal-overlay&quot;</span> <span class="attr">id</span>=<span class="string">&quot;settingsModal&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal-header&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h3</span>&gt;</span>通知设置<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;close-modal&quot;</span>&gt;</span><span class="symbol">&amp;times;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal-body&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;setting-item&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">label</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">id</span>=<span class="string">&quot;soundNotification&quot;</span> <span class="attr">checked</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span>&gt;</span>消息提示音<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;setting-item&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">label</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">id</span>=<span class="string">&quot;desktopNotification&quot;</span> <span class="attr">checked</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span>&gt;</span>桌面通知<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;setting-item&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">label</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">id</span>=<span class="string">&quot;typingNotification&quot;</span> <span class="attr">checked</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span>&gt;</span>显示&quot;正在输入&quot;状态<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 脚本 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/sockjs-client@1.5.0/dist/sockjs.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;js/chat.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="2-2-CSS样式-chat-css"><a href="#2-2-CSS样式-chat-css" class="headerlink" title="2.2 CSS样式 (chat.css)"></a>2.2 CSS样式 (chat.css)</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-pseudo">:root</span> &#123;</span><br><span class="line">    <span class="attr">--primary-color</span>: <span class="number">#4361ee</span>;</span><br><span class="line">    <span class="attr">--secondary-color</span>: <span class="number">#3a0ca3</span>;</span><br><span class="line">    <span class="attr">--success-color</span>: <span class="number">#06d6a0</span>;</span><br><span class="line">    <span class="attr">--danger-color</span>: <span class="number">#ef476f</span>;</span><br><span class="line">    <span class="attr">--warning-color</span>: <span class="number">#ffd166</span>;</span><br><span class="line">    <span class="attr">--dark-color</span>: <span class="number">#2b2d42</span>;</span><br><span class="line">    <span class="attr">--light-color</span>: <span class="number">#f8f9fa</span>;</span><br><span class="line">    <span class="attr">--gray-color</span>: <span class="number">#adb5bd</span>;</span><br><span class="line">    <span class="attr">--border-radius</span>: <span class="number">12px</span>;</span><br><span class="line">    <span class="attr">--box-shadow</span>: <span class="number">0</span> <span class="number">4px</span> <span class="number">20px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.08</span>);</span><br><span class="line">    <span class="attr">--transition</span>: all <span class="number">0.3s</span> ease;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">* &#123;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">box-sizing</span>: border-box;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="attribute">font-family</span>: <span class="string">&#x27;Poppins&#x27;</span>, sans-serif;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">135deg</span>, <span class="number">#667eea</span> <span class="number">0%</span>, <span class="number">#764ba2</span> <span class="number">100%</span>);</span><br><span class="line">    <span class="attribute">min-height</span>: <span class="number">100vh</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">20px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">max-width</span>: <span class="number">1400px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">90vh</span>;</span><br><span class="line">    <span class="attribute">background</span>: white;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="built_in">var</span>(--border-radius);</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    <span class="attribute">box-shadow</span>: <span class="built_in">var</span>(--box-shadow);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 侧边栏样式 */</span></span><br><span class="line"><span class="selector-class">.sidebar</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--dark-color);</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">flex-direction</span>: column;</span><br><span class="line">    <span class="attribute">border-right</span>: <span class="number">1px</span> solid <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.sidebar-header</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">25px</span> <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.sidebar-header</span> <span class="selector-tag">h2</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1.5rem</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">10px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.online-status</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.9rem</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--gray-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.status-indicator</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--success-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.status-indicator</span><span class="selector-class">.online</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--success-color);</span><br><span class="line">    <span class="attribute">animation</span>: pulse <span class="number">2s</span> infinite;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@keyframes</span> pulse &#123;</span><br><span class="line">    <span class="number">0%</span> &#123; <span class="attribute">opacity</span>: <span class="number">1</span>; &#125;</span><br><span class="line">    <span class="number">50%</span> &#123; <span class="attribute">opacity</span>: <span class="number">0.5</span>; &#125;</span><br><span class="line">    <span class="number">100%</span> &#123; <span class="attribute">opacity</span>: <span class="number">1</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-profile</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.avatar</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">50px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">50px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">font-weight</span>: bold;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1.2rem</span>;</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-info</span> &#123;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-info</span> <span class="selector-tag">h3</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1.1rem</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">5px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-info</span> <span class="selector-tag">p</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.85rem</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--gray-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.icon-btn</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.1</span>);</span><br><span class="line">    <span class="attribute">border</span>: none;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">36px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">36px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.icon-btn</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.search-box</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">15px</span> <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.search-box</span> <span class="selector-tag">input</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">10px</span> <span class="number">15px</span> <span class="number">10px</span> <span class="number">40px</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.1</span>);</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.2</span>);</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.9rem</span>;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.search-box</span> <span class="selector-tag">input</span><span class="selector-pseudo">:focus</span> &#123;</span><br><span class="line">    <span class="attribute">outline</span>: none;</span><br><span class="line">    <span class="attribute">border-color</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.15</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.search-box</span> <span class="selector-tag">i</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">35px</span>;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translateY</span>(-<span class="number">50%</span>);</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--gray-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.users-list</span>, <span class="selector-class">.chat-rooms</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">overflow-y</span>: auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.users-list</span> <span class="selector-tag">h3</span>, <span class="selector-class">.chat-rooms</span> <span class="selector-tag">h3</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.9rem</span>;</span><br><span class="line">    <span class="attribute">text-transform</span>: uppercase;</span><br><span class="line">    <span class="attribute">letter-spacing</span>: <span class="number">1px</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--gray-color);</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-between;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.users-list</span> <span class="selector-tag">ul</span>, <span class="selector-class">.chat-rooms</span> <span class="selector-tag">ul</span> &#123;</span><br><span class="line">    <span class="attribute">list-style</span>: none;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-item</span>, <span class="selector-class">.chat-rooms</span> <span class="selector-tag">li</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">12px</span> <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="built_in">var</span>(--border-radius);</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">5px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-item</span><span class="selector-pseudo">:hover</span>, <span class="selector-class">.chat-rooms</span> <span class="selector-tag">li</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-item</span><span class="selector-class">.active</span>, <span class="selector-class">.chat-rooms</span> <span class="selector-tag">li</span><span class="selector-class">.active</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">67</span>, <span class="number">97</span>, <span class="number">238</span>, <span class="number">0.2</span>);</span><br><span class="line">    <span class="attribute">border-left</span>: <span class="number">3px</span> solid <span class="built_in">var</span>(--primary-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-avatar</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">40px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">40px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">font-weight</span>: bold;</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-details</span> &#123;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-details</span> <span class="selector-tag">h4</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.95rem</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">3px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-details</span> <span class="selector-tag">p</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.8rem</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--gray-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-status</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-status</span><span class="selector-class">.online</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--success-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-status</span><span class="selector-class">.away</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--warning-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-status</span><span class="selector-class">.offline</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--danger-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.chat-rooms</span> <span class="selector-tag">li</span> &#123;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-between;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.badge</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">2px</span> <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.8rem</span>;</span><br><span class="line">    <span class="attribute">min-width</span>: <span class="number">25px</span>;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 主聊天区域 */</span></span><br><span class="line"><span class="selector-class">.main-chat</span> &#123;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">flex-direction</span>: column;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#f5f7fb</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.chat-header</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">20px</span> <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">background</span>: white;</span><br><span class="line">    <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="number">#eaeaea</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-between;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.chat-info</span> <span class="selector-tag">h2</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1.4rem</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--dark-color);</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">5px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.chat-info</span> <span class="selector-tag">p</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--gray-color);</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.9rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.chat-actions</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">10px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.action-btn</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: none;</span><br><span class="line">    <span class="attribute">border</span>: none;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">40px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">40px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--dark-color);</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1.1rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.action-btn</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#f0f0f0</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.messages-container</span> &#123;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">20px</span> <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">overflow-y</span>: auto;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">flex-direction</span>: column;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">15px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.welcome-message</span> &#123;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">40px</span> <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--gray-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.welcome-icon</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">3rem</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">0.5</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.message</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">max-width</span>: <span class="number">70%</span>;</span><br><span class="line">    <span class="attribute">animation</span>: fadeIn <span class="number">0.3s</span> ease;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@keyframes</span> fadeIn &#123;</span><br><span class="line">    <span class="selector-tag">from</span> &#123; <span class="attribute">opacity</span>: <span class="number">0</span>; <span class="attribute">transform</span>: <span class="built_in">translateY</span>(<span class="number">10px</span>); &#125;</span><br><span class="line">    <span class="selector-tag">to</span> &#123; <span class="attribute">opacity</span>: <span class="number">1</span>; <span class="attribute">transform</span>: <span class="built_in">translateY</span>(<span class="number">0</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.message</span><span class="selector-class">.incoming</span> &#123;</span><br><span class="line">    <span class="attribute">align-self</span>: flex-start;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.message</span><span class="selector-class">.outgoing</span> &#123;</span><br><span class="line">    <span class="attribute">align-self</span>: flex-end;</span><br><span class="line">    <span class="attribute">flex-direction</span>: row-reverse;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.message-avatar</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">40px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">40px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">font-weight</span>: bold;</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">flex-shrink</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.9rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.message-content</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: white;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="built_in">var</span>(--border-radius);</span><br><span class="line">    <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">2px</span> <span class="number">5px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.05</span>);</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.message</span><span class="selector-class">.incoming</span> <span class="selector-class">.message-content</span> &#123;</span><br><span class="line">    <span class="attribute">border-top-left-radius</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.message</span><span class="selector-class">.outgoing</span> <span class="selector-class">.message-content</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">border-top-right-radius</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.message-header</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-between;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">8px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.message-sender</span> &#123;</span><br><span class="line">    <span class="attribute">font-weight</span>: <span class="number">600</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.95rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.message-time</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.8rem</span>;</span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">0.7</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.message-text</span> &#123;</span><br><span class="line">    <span class="attribute">line-height</span>: <span class="number">1.5</span>;</span><br><span class="line">    <span class="attribute">word-break</span>: break-word;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.message-status</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: flex-end;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">margin-top</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.8rem</span>;</span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">0.7</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.join-leave-message</span> &#123;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">10px</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.join-leave-message</span> <span class="selector-class">.message-content</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.5</span>);</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--gray-color);</span><br><span class="line">    <span class="attribute">font-style</span>: italic;</span><br><span class="line">    <span class="attribute">display</span>: inline-block;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">8px</span> <span class="number">20px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 输入区域 */</span></span><br><span class="line"><span class="selector-class">.input-container</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">20px</span> <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">background</span>: white;</span><br><span class="line">    <span class="attribute">border-top</span>: <span class="number">1px</span> solid <span class="number">#eaeaea</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: flex-end;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">15px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.input-actions</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">flex-direction</span>: column;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">10px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.input-action-btn</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: none;</span><br><span class="line">    <span class="attribute">border</span>: none;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">40px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">40px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--gray-color);</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1.2rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.input-action-btn</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#f0f0f0</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.message-input-wrapper</span> &#123;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#messageInput</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">15px</span> <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#eaeaea</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="built_in">var</span>(--border-radius);</span><br><span class="line">    <span class="attribute">font-family</span>: <span class="string">&#x27;Poppins&#x27;</span>, sans-serif;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1rem</span>;</span><br><span class="line">    <span class="attribute">resize</span>: none;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">    <span class="attribute">max-height</span>: <span class="number">150px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#messageInput</span><span class="selector-pseudo">:focus</span> &#123;</span><br><span class="line">    <span class="attribute">outline</span>: none;</span><br><span class="line">    <span class="attribute">border-color</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">3px</span> <span class="built_in">rgba</span>(<span class="number">67</span>, <span class="number">97</span>, <span class="number">238</span>, <span class="number">0.1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#messageInput</span><span class="selector-pseudo">:disabled</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#f9f9f9</span>;</span><br><span class="line">    <span class="attribute">cursor</span>: not-allowed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.typing-indicator</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">bottom</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.85rem</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">5px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.typing-indicator</span><span class="selector-class">.show</span> &#123;</span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">bottom</span>: -<span class="number">25px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.send-btn</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">border</span>: none;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">50px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">50px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1.2rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.send-btn</span><span class="selector-pseudo">:hover</span><span class="selector-pseudo">:not</span>(<span class="selector-pseudo">:disabled</span>) &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--secondary-color);</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translateY</span>(-<span class="number">2px</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.send-btn</span><span class="selector-pseudo">:disabled</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--gray-color);</span><br><span class="line">    <span class="attribute">cursor</span>: not-allowed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 私聊侧边栏 */</span></span><br><span class="line"><span class="selector-class">.private-sidebar</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">350px</span>;</span><br><span class="line">    <span class="attribute">background</span>: white;</span><br><span class="line">    <span class="attribute">border-left</span>: <span class="number">1px</span> solid <span class="number">#eaeaea</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">flex-direction</span>: column;</span><br><span class="line">    <span class="attribute">display</span>: none;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.private-sidebar</span><span class="selector-class">.show</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.private-header</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="number">#eaeaea</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-between;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.private-header</span> <span class="selector-tag">h3</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--dark-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.close-btn</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: none;</span><br><span class="line">    <span class="attribute">border</span>: none;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--gray-color);</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.close-btn</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#f0f0f0</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--danger-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.private-chats</span> &#123;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">overflow-y</span>: auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.private-chat-item</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="built_in">var</span>(--border-radius);</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#f9f9f9</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid transparent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.private-chat-item</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#f0f0f0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.private-chat-item</span><span class="selector-class">.active</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: white;</span><br><span class="line">    <span class="attribute">border-color</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">2px</span> <span class="number">10px</span> <span class="built_in">rgba</span>(<span class="number">67</span>, <span class="number">97</span>, <span class="number">238</span>, <span class="number">0.1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.private-chat-header</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">10px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.private-chat-avatar</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">35px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">35px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">font-weight</span>: bold;</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.9rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.private-chat-info</span> <span class="selector-tag">h4</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.95rem</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">3px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.private-chat-info</span> <span class="selector-tag">p</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.8rem</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--gray-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.private-chat-preview</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.9rem</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#666</span>;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    <span class="attribute">text-overflow</span>: ellipsis;</span><br><span class="line">    <span class="attribute">white-space</span>: nowrap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 模态框样式 */</span></span><br><span class="line"><span class="selector-class">.modal-overlay</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: fixed;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.5</span>);</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">z-index</span>: <span class="number">1000</span>;</span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">visibility</span>: hidden;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.modal-overlay</span><span class="selector-class">.show</span> &#123;</span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">visibility</span>: visible;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.modal</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: white;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="built_in">var</span>(--border-radius);</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">90%</span>;</span><br><span class="line">    <span class="attribute">max-width</span>: <span class="number">500px</span>;</span><br><span class="line">    <span class="attribute">box-shadow</span>: <span class="built_in">var</span>(--box-shadow);</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translateY</span>(-<span class="number">20px</span>);</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.modal-overlay</span><span class="selector-class">.show</span> <span class="selector-class">.modal</span> &#123;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translateY</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.modal-header</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">25px</span> <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="number">#eaeaea</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-between;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.modal-header</span> <span class="selector-tag">h3</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--dark-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.close-modal</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: none;</span><br><span class="line">    <span class="attribute">border</span>: none;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1.5rem</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--gray-color);</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">    <span class="attribute">line-height</span>: <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.close-modal</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--danger-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.modal-body</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">30px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.form-group</span> &#123;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">25px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.form-group</span> <span class="selector-tag">label</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--dark-color);</span><br><span class="line">    <span class="attribute">font-weight</span>: <span class="number">500</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.form-group</span> <span class="selector-tag">input</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">12px</span> <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#ddd</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">font-family</span>: <span class="string">&#x27;Poppins&#x27;</span>, sans-serif;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1rem</span>;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.form-group</span> <span class="selector-tag">input</span><span class="selector-pseudo">:focus</span> &#123;</span><br><span class="line">    <span class="attribute">outline</span>: none;</span><br><span class="line">    <span class="attribute">border-color</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">3px</span> <span class="built_in">rgba</span>(<span class="number">67</span>, <span class="number">97</span>, <span class="number">238</span>, <span class="number">0.1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.error-message</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--danger-color);</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.85rem</span>;</span><br><span class="line">    <span class="attribute">margin-top</span>: <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">min-height</span>: <span class="number">20px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.avatar-selection</span> <span class="selector-tag">p</span> &#123;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--dark-color);</span><br><span class="line">    <span class="attribute">font-weight</span>: <span class="number">500</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.color-options</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">flex-wrap</span>: wrap;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">10px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.color-option</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">40px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">40px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">3px</span> solid transparent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.color-option</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">scale</span>(<span class="number">1.1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.color-option</span><span class="selector-class">.selected</span> &#123;</span><br><span class="line">    <span class="attribute">border-color</span>: <span class="built_in">var</span>(--dark-color);</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">scale</span>(<span class="number">1.1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.modal-footer</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span> <span class="number">30px</span> <span class="number">30px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.btn-primary</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">border</span>: none;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">12px</span> <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">font-family</span>: <span class="string">&#x27;Poppins&#x27;</span>, sans-serif;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1rem</span>;</span><br><span class="line">    <span class="attribute">font-weight</span>: <span class="number">500</span>;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.btn-primary</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--secondary-color);</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translateY</span>(-<span class="number">2px</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.setting-item</span> &#123;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.setting-item</span> <span class="selector-tag">label</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.setting-item</span> <span class="selector-tag">label</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#f9f9f9</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.setting-item</span> <span class="selector-tag">input</span><span class="selector-attr">[type=<span class="string">&quot;checkbox&quot;</span>]</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">18px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">18px</span>;</span><br><span class="line">    accent-<span class="attribute">color</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 响应式设计 */</span></span><br><span class="line"><span class="keyword">@media</span> (<span class="attribute">max-width</span>: <span class="number">1024px</span>) &#123;</span><br><span class="line">    <span class="selector-class">.container</span> &#123;</span><br><span class="line">        <span class="attribute">height</span>: <span class="number">95vh</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="selector-class">.sidebar</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">250px</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="selector-class">.private-sidebar</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">300px</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span> (<span class="attribute">max-width</span>: <span class="number">768px</span>) &#123;</span><br><span class="line">    <span class="selector-tag">body</span> &#123;</span><br><span class="line">        <span class="attribute">padding</span>: <span class="number">10px</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="selector-class">.container</span> &#123;</span><br><span class="line">        <span class="attribute">height</span>: <span class="number">95vh</span>;</span><br><span class="line">        <span class="attribute">flex-direction</span>: column;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="selector-class">.sidebar</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">        <span class="attribute">height</span>: <span class="number">200px</span>;</span><br><span class="line">        <span class="attribute">border-right</span>: none;</span><br><span class="line">        <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="selector-class">.main-chat</span> &#123;</span><br><span class="line">        <span class="attribute">height</span>: <span class="built_in">calc</span>(<span class="number">100%</span> - <span class="number">200px</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="selector-class">.private-sidebar</span> &#123;</span><br><span class="line">        <span class="attribute">position</span>: absolute;</span><br><span class="line">        <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">        <span class="attribute">right</span>: <span class="number">0</span>;</span><br><span class="line">        <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">        <span class="attribute">max-width</span>: <span class="number">400px</span>;</span><br><span class="line">        <span class="attribute">box-shadow</span>: -<span class="number">5px</span> <span class="number">0</span> <span class="number">20px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.1</span>);</span><br><span class="line">        <span class="attribute">z-index</span>: <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="selector-class">.messages-container</span> &#123;</span><br><span class="line">        <span class="attribute">padding</span>: <span class="number">15px</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="selector-class">.chat-header</span>, <span class="selector-class">.input-container</span> &#123;</span><br><span class="line">        <span class="attribute">padding</span>: <span class="number">15px</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 滚动条样式 */</span></span><br><span class="line">::-webkit-scrollbar &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">8px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">::-webkit-scrollbar-track &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.05</span>);</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">::-webkit-scrollbar-thumb &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.2</span>);</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">::-webkit-scrollbar-thumb:hover &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.3</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-3-JavaScript功能-chat-js"><a href="#2-3-JavaScript功能-chat-js" class="headerlink" title="2.3 JavaScript功能 (chat.js)"></a>2.3 JavaScript功能 (chat.js)</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 聊天室主要功能</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatRoom</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">stompClient</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">username</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">avatarColor</span> = <span class="string">&#x27;#4361ee&#x27;</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">connected</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">typingTimeout</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">privateChats</span> = <span class="keyword">new</span> <span class="title class_">Map</span>(); <span class="comment">// 存储私聊会话</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentPrivateChat</span> = <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 颜色选项</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">colorOptions</span> = [</span><br><span class="line">            <span class="string">&#x27;#FF6B6B&#x27;</span>, <span class="string">&#x27;#4ECDC4&#x27;</span>, <span class="string">&#x27;#FFD166&#x27;</span>, <span class="string">&#x27;#06D6A0&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;#118AB2&#x27;</span>, <span class="string">&#x27;#073B4C&#x27;</span>, <span class="string">&#x27;#EF476F&#x27;</span>, <span class="string">&#x27;#7209B7&#x27;</span></span><br><span class="line">        ];</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">init</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">cacheElements</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">bindEvents</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">showUsernameModal</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">initColorOptions</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">cacheElements</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// 模态框</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">usernameModal</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;usernameModal&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">settingsModal</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;settingsModal&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 输入元素</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">usernameInput</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;usernameInput&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">messageInput</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;messageInput&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 按钮</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">joinChatBtn</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;joinChatBtn&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">sendButton</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;sendButton&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">changeUsernameBtn</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;changeUsernameBtn&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">clearChatBtn</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;clearChatBtn&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">themeToggleBtn</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;themeToggleBtn&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">notificationsBtn</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;notificationsBtn&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">closePrivateBtn</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;closePrivateBtn&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 显示元素</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">usernameDisplay</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;usernameDisplay&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">userAvatar</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;userAvatar&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">onlineCount</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;onlineCount&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">userCount</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;userCount&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">onlineUsersList</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;onlineUsersList&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">messagesContainer</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;messagesContainer&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">typingIndicator</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;typingIndicator&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">privateSidebar</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;privateSidebar&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">privateChatsContainer</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;privateChats&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 聊天室切换</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">chatRooms</span> = <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.chat-rooms li&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentChatRoom</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;currentChatRoom&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 错误消息</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">usernameError</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;usernameError&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">bindEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// 用户名设置</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">joinChatBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">handleJoinChat</span>());</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">usernameInput</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;keypress&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;Enter&#x27;</span>) <span class="variable language_">this</span>.<span class="title function_">handleJoinChat</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 消息发送</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">sendButton</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">sendMessage</span>());</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">messageInput</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;keydown&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;Enter&#x27;</span> &amp;&amp; !e.<span class="property">shiftKey</span> &amp;&amp; !e.<span class="property">ctrlKey</span>) &#123;</span><br><span class="line">                e.<span class="title function_">preventDefault</span>();</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">sendMessage</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 触发输入事件（用于显示&quot;正在输入&quot;）</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">handleTyping</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 消息输入框自动调整高度</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">messageInput</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;input&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">messageInput</span>.<span class="property">style</span>.<span class="property">height</span> = <span class="string">&#x27;auto&#x27;</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">messageInput</span>.<span class="property">style</span>.<span class="property">height</span> = <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="variable language_">this</span>.<span class="property">messageInput</span>.<span class="property">scrollHeight</span>, <span class="number">150</span>) + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更改用户名</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">changeUsernameBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">showUsernameModal</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 清除聊天记录</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">clearChatBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">clearChat</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 切换主题</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">themeToggleBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">toggleTheme</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 通知设置</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">notificationsBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">showSettingsModal</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 关闭私聊侧边栏</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">closePrivateBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">hidePrivateSidebar</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 聊天室切换</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">chatRooms</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">room</span> =&gt;</span> &#123;</span><br><span class="line">            room.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">switchChatRoom</span>(e));</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 关闭模态框</span></span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.close-modal&#x27;</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">btn</span> =&gt;</span> &#123;</span><br><span class="line">            btn.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">closeAllModals</span>());</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 点击模态框外部关闭</span></span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.modal-overlay&#x27;</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">modal</span> =&gt;</span> &#123;</span><br><span class="line">            modal.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.<span class="property">target</span> === modal) <span class="variable language_">this</span>.<span class="title function_">closeAllModals</span>();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 搜索用户</span></span><br><span class="line">        <span class="keyword">const</span> userSearch = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;userSearch&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (userSearch) &#123;</span><br><span class="line">            userSearch.<span class="title function_">addEventListener</span>(<span class="string">&#x27;input&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">filterUsers</span>(e.<span class="property">target</span>.<span class="property">value</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">initColorOptions</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> container = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;colorOptions&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">colorOptions</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">color</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> div = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">            div.<span class="property">className</span> = <span class="string">&#x27;color-option&#x27;</span>;</span><br><span class="line">            div.<span class="property">style</span>.<span class="property">backgroundColor</span> = color;</span><br><span class="line">            div.<span class="property">dataset</span>.<span class="property">color</span> = color;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (color === <span class="variable language_">this</span>.<span class="property">avatarColor</span>) &#123;</span><br><span class="line">                div.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;selected&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            div.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.color-option&#x27;</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">opt</span> =&gt;</span> &#123;</span><br><span class="line">                    opt.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;selected&#x27;</span>);</span><br><span class="line">                &#125;);</span><br><span class="line">                div.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;selected&#x27;</span>);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">avatarColor</span> = color;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">updateUserAvatar</span>();</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            container.<span class="title function_">appendChild</span>(div);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">showUsernameModal</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">usernameModal</span>.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;show&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">usernameInput</span>.<span class="title function_">focus</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">showSettingsModal</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">settingsModal</span>.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;show&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">closeAllModals</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.modal-overlay&#x27;</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">modal</span> =&gt;</span> &#123;</span><br><span class="line">            modal.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;show&#x27;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">handleJoinChat</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> username = <span class="variable language_">this</span>.<span class="property">usernameInput</span>.<span class="property">value</span>.<span class="title function_">trim</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!username) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">showError</span>(<span class="string">&#x27;请输入用户名&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (username.<span class="property">length</span> &lt; <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">showError</span>(<span class="string">&#x27;用户名至少需要3个字符&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (username.<span class="property">length</span> &gt; <span class="number">20</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">showError</span>(<span class="string">&#x27;用户名不能超过20个字符&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!<span class="regexp">/^[a-zA-Z0-9\u4e00-\u9fa5_\-]+$/</span>.<span class="title function_">test</span>(username)) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">showError</span>(<span class="string">&#x27;用户名只能包含字母、数字、中文、下划线和连字符&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">username</span> = username;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">usernameDisplay</span>.<span class="property">textContent</span> = username;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">updateUserAvatar</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 连接到WebSocket</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">connect</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 关闭模态框</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">closeAllModals</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 启用输入框</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">messageInput</span>.<span class="property">disabled</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">sendButton</span>.<span class="property">disabled</span> = <span class="literal">false</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新用户状态</span></span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;userStatus&#x27;</span>).<span class="property">textContent</span> = <span class="string">&#x27;在线&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">showError</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">usernameError</span>.<span class="property">textContent</span> = message;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">updateUserAvatar</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> initials = <span class="variable language_">this</span>.<span class="property">username</span> ? <span class="variable language_">this</span>.<span class="property">username</span>.<span class="title function_">charAt</span>(<span class="number">0</span>).<span class="title function_">toUpperCase</span>() : <span class="string">&#x27;?&#x27;</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">userAvatar</span>.<span class="property">textContent</span> = initials;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">userAvatar</span>.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="variable language_">this</span>.<span class="property">avatarColor</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">connect</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> socket = <span class="keyword">new</span> <span class="title class_">SockJS</span>(<span class="string">&#x27;/ws-chat&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">stompClient</span> = <span class="title class_">Stomp</span>.<span class="title function_">over</span>(socket);</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">stompClient</span>.<span class="title function_">connect</span>(&#123;&#125;, <span class="function">(<span class="params">frame</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">connected</span> = <span class="literal">true</span>;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;连接成功:&#x27;</span>, frame);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 订阅公共聊天频道</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">stompClient</span>.<span class="title function_">subscribe</span>(<span class="string">&#x27;/topic/public&#x27;</span>, <span class="function">(<span class="params">message</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">handlePublicMessage</span>(<span class="title class_">JSON</span>.<span class="title function_">parse</span>(message.<span class="property">body</span>));</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 订阅在线用户更新</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">stompClient</span>.<span class="title function_">subscribe</span>(<span class="string">&#x27;/topic/onlineUsers&#x27;</span>, <span class="function">(<span class="params">message</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">updateOnlineUsers</span>(<span class="title class_">JSON</span>.<span class="title function_">parse</span>(message.<span class="property">body</span>));</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 订阅私聊频道</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">stompClient</span>.<span class="title function_">subscribe</span>(<span class="string">`/user/queue/private`</span>, <span class="function">(<span class="params">message</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">handlePrivateMessage</span>(<span class="title class_">JSON</span>.<span class="title function_">parse</span>(message.<span class="property">body</span>));</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 发送加入消息</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">sendJoinMessage</span>();</span><br><span class="line">            </span><br><span class="line">        &#125;, <span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;连接失败:&#x27;</span>, error);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">showNotification</span>(<span class="string">&#x27;连接失败，请刷新页面重试&#x27;</span>, <span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">connect</span>(), <span class="number">5000</span>); <span class="comment">// 5秒后重试</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">sendJoinMessage</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">stompClient</span> || !<span class="variable language_">this</span>.<span class="property">connected</span>) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> chatMessage = &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;JOIN&#x27;</span>,</span><br><span class="line">            <span class="attr">sender</span>: <span class="variable language_">this</span>.<span class="property">username</span>,</span><br><span class="line">            <span class="attr">content</span>: <span class="variable language_">this</span>.<span class="property">username</span> + <span class="string">&#x27; 加入了聊天室&#x27;</span>,</span><br><span class="line">            <span class="attr">avatarColor</span>: <span class="variable language_">this</span>.<span class="property">avatarColor</span></span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">stompClient</span>.<span class="title function_">send</span>(<span class="string">&#x27;/app/chat.addUser&#x27;</span>, &#123;&#125;, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(chatMessage));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">sendMessage</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> content = <span class="variable language_">this</span>.<span class="property">messageInput</span>.<span class="property">value</span>.<span class="title function_">trim</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!content || !<span class="variable language_">this</span>.<span class="property">stompClient</span> || !<span class="variable language_">this</span>.<span class="property">connected</span>) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果是私聊</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">currentPrivateChat</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">sendPrivateMessage</span>(content, <span class="variable language_">this</span>.<span class="property">currentPrivateChat</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 公共聊天</span></span><br><span class="line">            <span class="keyword">const</span> chatMessage = &#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&#x27;CHAT&#x27;</span>,</span><br><span class="line">                <span class="attr">sender</span>: <span class="variable language_">this</span>.<span class="property">username</span>,</span><br><span class="line">                <span class="attr">content</span>: content,</span><br><span class="line">                <span class="attr">avatarColor</span>: <span class="variable language_">this</span>.<span class="property">avatarColor</span>,</span><br><span class="line">                <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>()</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">stompClient</span>.<span class="title function_">send</span>(<span class="string">&#x27;/app/chat.sendMessage&#x27;</span>, &#123;&#125;, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(chatMessage));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 清空输入框并重置高度</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">messageInput</span>.<span class="property">value</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">messageInput</span>.<span class="property">style</span>.<span class="property">height</span> = <span class="string">&#x27;auto&#x27;</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">messageInput</span>.<span class="title function_">focus</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">sendPrivateMessage</span>(<span class="params">content, receiver</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">stompClient</span> || !<span class="variable language_">this</span>.<span class="property">connected</span>) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> chatMessage = &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;CHAT&#x27;</span>,</span><br><span class="line">            <span class="attr">sender</span>: <span class="variable language_">this</span>.<span class="property">username</span>,</span><br><span class="line">            <span class="attr">receiver</span>: receiver,</span><br><span class="line">            <span class="attr">content</span>: content,</span><br><span class="line">            <span class="attr">avatarColor</span>: <span class="variable language_">this</span>.<span class="property">avatarColor</span>,</span><br><span class="line">            <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>()</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">stompClient</span>.<span class="title function_">send</span>(<span class="string">&#x27;/app/chat.sendPrivateMessage&#x27;</span>, &#123;&#125;, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(chatMessage));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 添加到私聊历史</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">addPrivateMessageToHistory</span>(receiver, chatMessage, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">handlePublicMessage</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;收到公共消息:&#x27;</span>, message);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span>(message.<span class="property">type</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;JOIN&#x27;</span>:</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">displayJoinMessage</span>(message);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;LEAVE&#x27;</span>:</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">displayLeaveMessage</span>(message);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;CHAT&#x27;</span>:</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">displayPublicMessage</span>(message);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;TYPING&#x27;</span>:</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">displayTypingIndicator</span>(message);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">handlePrivateMessage</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;收到私聊消息:&#x27;</span>, message);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 添加到私聊历史</span></span><br><span class="line">        <span class="keyword">const</span> isFromMe = message.<span class="property">sender</span> === <span class="variable language_">this</span>.<span class="property">username</span>;</span><br><span class="line">        <span class="keyword">const</span> otherUser = isFromMe ? message.<span class="property">receiver</span> : message.<span class="property">sender</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">addPrivateMessageToHistory</span>(otherUser, message, isFromMe);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果当前不是这个私聊会话，显示通知</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">currentPrivateChat</span> !== otherUser) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">showPrivateNotification</span>(otherUser, message.<span class="property">content</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">addPrivateMessageToHistory</span>(<span class="params">user, message, isFromMe</span>) &#123;</span><br><span class="line">        <span class="comment">// 获取或创建私聊会话</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">privateChats</span>.<span class="title function_">has</span>(user)) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">privateChats</span>.<span class="title function_">set</span>(user, []);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">addPrivateChatItem</span>(user);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> messages = <span class="variable language_">this</span>.<span class="property">privateChats</span>.<span class="title function_">get</span>(user);</span><br><span class="line">        messages.<span class="title function_">push</span>(&#123;</span><br><span class="line">            ...message,</span><br><span class="line">            isFromMe</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新私聊预览</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">updatePrivateChatPreview</span>(user, message.<span class="property">content</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果当前正在查看这个私聊，显示消息</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">currentPrivateChat</span> === user) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">displayPrivateMessage</span>(message, isFromMe);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">addPrivateChatItem</span>(<span class="params">user</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> userSession = <span class="variable language_">this</span>.<span class="title function_">getUserSession</span>(user);</span><br><span class="line">        <span class="keyword">if</span> (!userSession) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> chatItem = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">        chatItem.<span class="property">className</span> = <span class="string">&#x27;private-chat-item&#x27;</span>;</span><br><span class="line">        chatItem.<span class="property">dataset</span>.<span class="property">user</span> = user;</span><br><span class="line">        </span><br><span class="line">        chatItem.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;private-chat-header&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;private-chat-avatar&quot; style=&quot;background-color: <span class="subst">$&#123;userSession.avatarColor&#125;</span>&quot;&gt;</span></span><br><span class="line"><span class="string">                    <span class="subst">$&#123;user.charAt(<span class="number">0</span>).toUpperCase()&#125;</span></span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;private-chat-info&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;h4&gt;<span class="subst">$&#123;user&#125;</span>&lt;/h4&gt;</span></span><br><span class="line"><span class="string">                    &lt;p&gt;在线&lt;/p&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;private-chat-preview&quot; data-preview=&quot;<span class="subst">$&#123;user&#125;</span>&quot;&gt;暂无消息&lt;/div&gt;</span></span><br><span class="line"><span class="string">        `</span>;</span><br><span class="line">        </span><br><span class="line">        chatItem.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">openPrivateChat</span>(user));</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">privateChatsContainer</span>.<span class="title function_">appendChild</span>(chatItem);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">updatePrivateChatPreview</span>(<span class="params">user, message</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> preview = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">`[data-preview=&quot;<span class="subst">$&#123;user&#125;</span>&quot;]`</span>);</span><br><span class="line">        <span class="keyword">if</span> (preview) &#123;</span><br><span class="line">            <span class="keyword">const</span> truncated = message.<span class="property">length</span> &gt; <span class="number">30</span> ? message.<span class="title function_">substring</span>(<span class="number">0</span>, <span class="number">30</span>) + <span class="string">&#x27;...&#x27;</span> : message;</span><br><span class="line">            preview.<span class="property">textContent</span> = truncated;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">openPrivateChat</span>(<span class="params">user</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentPrivateChat</span> = user;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新UI</span></span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.private-chat-item&#x27;</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">            item.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;active&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (item.<span class="property">dataset</span>.<span class="property">user</span> === user) &#123;</span><br><span class="line">                item.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;active&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 显示私聊侧边栏</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">showPrivateSidebar</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 清空当前消息显示</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">messagesContainer</span>.<span class="property">innerHTML</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 显示私聊消息历史</span></span><br><span class="line">        <span class="keyword">const</span> messages = <span class="variable language_">this</span>.<span class="property">privateChats</span>.<span class="title function_">get</span>(user) || [];</span><br><span class="line">        messages.<span class="title function_">forEach</span>(<span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">displayPrivateMessage</span>(msg, msg.<span class="property">isFromMe</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新聊天标题</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentChatRoom</span>.<span class="property">textContent</span> = <span class="string">`与 <span class="subst">$&#123;user&#125;</span> 的私聊`</span>;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;roomDescription&#x27;</span>).<span class="property">textContent</span> = <span class="string">&#x27;私人聊天&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">displayPrivateMessage</span>(<span class="params">message, isFromMe</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> messageElement = <span class="variable language_">this</span>.<span class="title function_">createMessageElement</span>(message, isFromMe);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">messagesContainer</span>.<span class="title function_">appendChild</span>(messageElement);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">scrollToBottom</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">showPrivateSidebar</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">privateSidebar</span>.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;show&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">hidePrivateSidebar</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">privateSidebar</span>.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;show&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentPrivateChat</span> = <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 切换回公共聊天室</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">switchToPublicRoom</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">switchToPublicRoom</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentChatRoom</span>.<span class="property">textContent</span> = <span class="string">&#x27;公共聊天室&#x27;</span>;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;roomDescription&#x27;</span>).<span class="property">textContent</span> = <span class="string">&#x27;与所有在线用户聊天&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 清空消息并显示欢迎信息</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">messagesContainer</span>.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;welcome-message&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;welcome-icon&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;i class=&quot;fas fa-comment-dots&quot;&gt;&lt;/i&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;h3&gt;欢迎来到聊天室!&lt;/h3&gt;</span></span><br><span class="line"><span class="string">                &lt;p&gt;开始与大家聊天吧！输入消息并按回车键发送。&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        `</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">displayPublicMessage</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> isFromMe = message.<span class="property">sender</span> === <span class="variable language_">this</span>.<span class="property">username</span>;</span><br><span class="line">        <span class="keyword">const</span> messageElement = <span class="variable language_">this</span>.<span class="title function_">createMessageElement</span>(message, isFromMe);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">messagesContainer</span>.<span class="title function_">appendChild</span>(messageElement);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">scrollToBottom</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">displayJoinMessage</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> messageElement = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">        messageElement.<span class="property">className</span> = <span class="string">&#x27;join-leave-message&#x27;</span>;</span><br><span class="line">        messageElement.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;message-content&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;i class=&quot;fas fa-user-plus&quot;&gt;&lt;/i&gt; <span class="subst">$&#123;message.content&#125;</span></span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        `</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">messagesContainer</span>.<span class="title function_">appendChild</span>(messageElement);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">scrollToBottom</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">displayLeaveMessage</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> messageElement = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">        messageElement.<span class="property">className</span> = <span class="string">&#x27;join-leave-message&#x27;</span>;</span><br><span class="line">        messageElement.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;message-content&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;i class=&quot;fas fa-user-minus&quot;&gt;&lt;/i&gt; <span class="subst">$&#123;message.content&#125;</span></span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        `</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">messagesContainer</span>.<span class="title function_">appendChild</span>(messageElement);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">scrollToBottom</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">createMessageElement</span>(<span class="params">message, isFromMe</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> messageElement = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">        messageElement.<span class="property">className</span> = <span class="string">`message <span class="subst">$&#123;isFromMe ? <span class="string">&#x27;outgoing&#x27;</span> : <span class="string">&#x27;incoming&#x27;</span>&#125;</span>`</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> time = <span class="keyword">new</span> <span class="title class_">Date</span>(message.<span class="property">timestamp</span>).<span class="title function_">toLocaleTimeString</span>([], &#123; </span><br><span class="line">            <span class="attr">hour</span>: <span class="string">&#x27;2-digit&#x27;</span>, </span><br><span class="line">            <span class="attr">minute</span>: <span class="string">&#x27;2-digit&#x27;</span> </span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        messageElement.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;message-avatar&quot; style=&quot;background-color: <span class="subst">$&#123;message.avatarColor || <span class="variable language_">this</span>.avatarColor&#125;</span>&quot;&gt;</span></span><br><span class="line"><span class="string">                <span class="subst">$&#123;message.sender ? message.sender.charAt(<span class="number">0</span>).toUpperCase() : <span class="string">&#x27;?&#x27;</span>&#125;</span></span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;message-content&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;message-header&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;span class=&quot;message-sender&quot;&gt;<span class="subst">$&#123;message.sender&#125;</span>&lt;/span&gt;</span></span><br><span class="line"><span class="string">                    &lt;span class=&quot;message-time&quot;&gt;<span class="subst">$&#123;time&#125;</span>&lt;/span&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;message-text&quot;&gt;<span class="subst">$&#123;<span class="variable language_">this</span>.escapeHtml(message.content)&#125;</span>&lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;message-status&quot;&gt;</span></span><br><span class="line"><span class="string">                    <span class="subst">$&#123;isFromMe ? <span class="string">&#x27;&lt;i class=&quot;fas fa-check&quot;&gt;&lt;/i&gt;&#x27;</span> : <span class="string">&#x27;&#x27;</span>&#125;</span></span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        `</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> messageElement;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">escapeHtml</span>(<span class="params">text</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> div = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">        div.<span class="property">textContent</span> = text;</span><br><span class="line">        <span class="keyword">return</span> div.<span class="property">innerHTML</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">handleTyping</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">stompClient</span> || !<span class="variable language_">this</span>.<span class="property">connected</span> || <span class="variable language_">this</span>.<span class="property">currentPrivateChat</span>) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 清除之前的定时器</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">typingTimeout</span>) &#123;</span><br><span class="line">            <span class="built_in">clearTimeout</span>(<span class="variable language_">this</span>.<span class="property">typingTimeout</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 发送正在输入状态</span></span><br><span class="line">        <span class="keyword">const</span> chatMessage = &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;TYPING&#x27;</span>,</span><br><span class="line">            <span class="attr">sender</span>: <span class="variable language_">this</span>.<span class="property">username</span>,</span><br><span class="line">            <span class="attr">content</span>: <span class="string">&#x27;正在输入...&#x27;</span></span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">stompClient</span>.<span class="title function_">send</span>(<span class="string">&#x27;/app/chat.typing&#x27;</span>, &#123;&#125;, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(chatMessage));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置定时器，3秒后停止显示&quot;正在输入&quot;</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">typingTimeout</span> = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">hideTypingIndicator</span>();</span><br><span class="line">        &#125;, <span class="number">3000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">displayTypingIndicator</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (message.<span class="property">sender</span> === <span class="variable language_">this</span>.<span class="property">username</span> || <span class="variable language_">this</span>.<span class="property">currentPrivateChat</span>) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">typingIndicator</span>.<span class="property">textContent</span> = <span class="string">`<span class="subst">$&#123;message.sender&#125;</span> 正在输入...`</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">typingIndicator</span>.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;show&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3秒后隐藏</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">hideTypingIndicator</span>();</span><br><span class="line">        &#125;, <span class="number">3000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">hideTypingIndicator</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">typingIndicator</span>.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;show&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">updateOnlineUsers</span>(<span class="params">users</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> onlineUsers = <span class="title class_">Array</span>.<span class="title function_">isArray</span>(users) ? users : [];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">onlineCount</span>.<span class="property">textContent</span> = onlineUsers.<span class="property">length</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">userCount</span>.<span class="property">textContent</span> = onlineUsers.<span class="property">length</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新用户列表</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">onlineUsersList</span>.<span class="property">innerHTML</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">        onlineUsers.<span class="title function_">forEach</span>(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (user === <span class="variable language_">this</span>.<span class="property">username</span>) <span class="keyword">return</span>; <span class="comment">// 不显示自己</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">const</span> userSession = <span class="variable language_">this</span>.<span class="title function_">getUserSession</span>(user);</span><br><span class="line">            <span class="keyword">const</span> li = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;li&#x27;</span>);</span><br><span class="line">            li.<span class="property">className</span> = <span class="string">&#x27;user-item&#x27;</span>;</span><br><span class="line">            li.<span class="property">dataset</span>.<span class="property">user</span> = user;</span><br><span class="line">            </span><br><span class="line">            li.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;user-avatar&quot; style=&quot;background-color: <span class="subst">$&#123;userSession ? userSession.avatarColor : <span class="string">&#x27;#4361ee&#x27;</span>&#125;</span>&quot;&gt;</span></span><br><span class="line"><span class="string">                    <span class="subst">$&#123;user.charAt(<span class="number">0</span>).toUpperCase()&#125;</span></span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;user-details&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;h4&gt;<span class="subst">$&#123;user&#125;</span>&lt;/h4&gt;</span></span><br><span class="line"><span class="string">                    &lt;p&gt;在线&lt;/p&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;user-status online&quot;&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;button class=&quot;private-chat-btn icon-btn&quot; title=&quot;私聊&quot; data-user=&quot;<span class="subst">$&#123;user&#125;</span>&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;i class=&quot;fas fa-comment-medical&quot;&gt;&lt;/i&gt;</span></span><br><span class="line"><span class="string">                &lt;/button&gt;</span></span><br><span class="line"><span class="string">            `</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 添加私聊按钮事件</span></span><br><span class="line">            <span class="keyword">const</span> privateBtn = li.<span class="title function_">querySelector</span>(<span class="string">&#x27;.private-chat-btn&#x27;</span>);</span><br><span class="line">            privateBtn.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">                e.<span class="title function_">stopPropagation</span>();</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">openPrivateChat</span>(user);</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">onlineUsersList</span>.<span class="title function_">appendChild</span>(li);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">getUserSession</span>(<span class="params">username</span>) &#123;</span><br><span class="line">        <span class="comment">// 这里应该从服务器获取用户信息</span></span><br><span class="line">        <span class="comment">// 暂时返回模拟数据</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">avatarColor</span>: <span class="variable language_">this</span>.<span class="title function_">generateColorFromString</span>(username)</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">generateColorFromString</span>(<span class="params">str</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> hash = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; str.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            hash = str.<span class="title function_">charCodeAt</span>(i) + ((hash &lt;&lt; <span class="number">5</span>) - hash);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> colors = [</span><br><span class="line">            <span class="string">&#x27;#FF6B6B&#x27;</span>, <span class="string">&#x27;#4ECDC4&#x27;</span>, <span class="string">&#x27;#FFD166&#x27;</span>, <span class="string">&#x27;#06D6A0&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;#118AB2&#x27;</span>, <span class="string">&#x27;#073B4C&#x27;</span>, <span class="string">&#x27;#EF476F&#x27;</span>, <span class="string">&#x27;#7209B7&#x27;</span></span><br><span class="line">        ];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> colors[<span class="title class_">Math</span>.<span class="title function_">abs</span>(hash) % colors.<span class="property">length</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">filterUsers</span>(<span class="params">query</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> userItems = <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.user-item&#x27;</span>);</span><br><span class="line">        <span class="keyword">const</span> queryLower = query.<span class="title function_">toLowerCase</span>();</span><br><span class="line">        </span><br><span class="line">        userItems.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> userName = item.<span class="property">dataset</span>.<span class="property">user</span>.<span class="title function_">toLowerCase</span>();</span><br><span class="line">            <span class="keyword">if</span> (userName.<span class="title function_">includes</span>(queryLower)) &#123;</span><br><span class="line">                item.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;flex&#x27;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                item.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">switchChatRoom</span>(<span class="params">event</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> room = event.<span class="property">currentTarget</span>.<span class="property">dataset</span>.<span class="property">room</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新活动状态</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">chatRooms</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">r</span> =&gt;</span> r.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;active&#x27;</span>));</span><br><span class="line">        event.<span class="property">currentTarget</span>.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;active&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (room === <span class="string">&#x27;private&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">showPrivateSidebar</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">hidePrivateSidebar</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">clearChat</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">confirm</span>(<span class="string">&#x27;确定要清空聊天记录吗？&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">messagesContainer</span>.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;welcome-message&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;welcome-icon&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;i class=&quot;fas fa-comment-dots&quot;&gt;&lt;/i&gt;</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string">                    &lt;h3&gt;聊天记录已清空&lt;/h3&gt;</span></span><br><span class="line"><span class="string">                    &lt;p&gt;开始新的聊天吧！&lt;/p&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            `</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">toggleTheme</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> isDark = <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">classList</span>.<span class="title function_">toggle</span>(<span class="string">&#x27;dark-theme&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">themeToggleBtn</span>.<span class="property">innerHTML</span> = isDark </span><br><span class="line">            ? <span class="string">&#x27;&lt;i class=&quot;fas fa-sun&quot;&gt;&lt;/i&gt;&#x27;</span></span><br><span class="line">            : <span class="string">&#x27;&lt;i class=&quot;fas fa-moon&quot;&gt;&lt;/i&gt;&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 保存主题偏好</span></span><br><span class="line">        <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;chatTheme&#x27;</span>, isDark ? <span class="string">&#x27;dark&#x27;</span> : <span class="string">&#x27;light&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">showPrivateNotification</span>(<span class="params">user, message</span>) &#123;</span><br><span class="line">        <span class="comment">// 检查通知权限</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">Notification</span>.<span class="property">permission</span> === <span class="string">&#x27;granted&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Notification</span>(<span class="string">`来自 <span class="subst">$&#123;user&#125;</span> 的消息`</span>, &#123;</span><br><span class="line">                <span class="attr">body</span>: message,</span><br><span class="line">                <span class="attr">icon</span>: <span class="string">&#x27;/favicon.ico&#x27;</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title class_">Notification</span>.<span class="property">permission</span> !== <span class="string">&#x27;denied&#x27;</span>) &#123;</span><br><span class="line">            <span class="title class_">Notification</span>.<span class="title function_">requestPermission</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">showNotification</span>(<span class="params">message, type = <span class="string">&#x27;info&#x27;</span></span>) &#123;</span><br><span class="line">        <span class="comment">// 创建通知元素</span></span><br><span class="line">        <span class="keyword">const</span> notification = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">        notification.<span class="property">className</span> = <span class="string">`notification <span class="subst">$&#123;type&#125;</span>`</span>;</span><br><span class="line">        notification.<span class="property">textContent</span> = message;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(notification);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 显示通知</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> notification.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;show&#x27;</span>), <span class="number">100</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3秒后移除</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            notification.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;show&#x27;</span>);</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> notification.<span class="title function_">remove</span>(), <span class="number">300</span>);</span><br><span class="line">        &#125;, <span class="number">3000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">scrollToBottom</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">messagesContainer</span>.<span class="property">scrollTop</span> = <span class="variable language_">this</span>.<span class="property">messagesContainer</span>.<span class="property">scrollHeight</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 页面卸载时发送离开消息</span></span><br><span class="line">    <span class="title function_">beforeUnload</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">stompClient</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">connected</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> chatMessage = &#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&#x27;LEAVE&#x27;</span>,</span><br><span class="line">                <span class="attr">sender</span>: <span class="variable language_">this</span>.<span class="property">username</span>,</span><br><span class="line">                <span class="attr">content</span>: <span class="variable language_">this</span>.<span class="property">username</span> + <span class="string">&#x27; 离开了聊天室&#x27;</span></span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">stompClient</span>.<span class="title function_">send</span>(<span class="string">&#x27;/app/chat.leave&#x27;</span>, &#123;&#125;, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(chatMessage));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 延迟断开连接</span></span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">stompClient</span>) &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">stompClient</span>.<span class="title function_">disconnect</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化聊天室</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;DOMContentLoaded&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> chatRoom = <span class="keyword">new</span> <span class="title class_">ChatRoom</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 页面卸载前发送离开消息</span></span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;beforeunload&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        chatRoom.<span class="title function_">beforeUnload</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查之前保存的主题</span></span><br><span class="line">    <span class="keyword">const</span> savedTheme = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;chatTheme&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (savedTheme === <span class="string">&#x27;dark&#x27;</span>) &#123;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;dark-theme&#x27;</span>);</span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#themeToggleBtn i&#x27;</span>).<span class="property">className</span> = <span class="string">&#x27;fas fa-sun&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 请求通知权限</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;Notification&#x27;</span> <span class="keyword">in</span> <span class="variable language_">window</span> &amp;&amp; <span class="title class_">Notification</span>.<span class="property">permission</span> === <span class="string">&#x27;default&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="title class_">Notification</span>.<span class="title function_">requestPermission</span>();</span><br><span class="line">        &#125;, <span class="number">2000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h2 id="3-运行说明"><a href="#3-运行说明" class="headerlink" title="3. 运行说明"></a>3. 运行说明</h2><h3 id="3-1-项目结构"><a href="#3-1-项目结构" class="headerlink" title="3.1 项目结构"></a>3.1 项目结构</h3><p>将上述代码按照目录结构创建文件，确保以下结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">chat-room/</span><br><span class="line">├── src/</span><br><span class="line">│   ├── main/</span><br><span class="line">│   │   ├── java/</span><br><span class="line">│   │   │   └── com/</span><br><span class="line">│   │   │       └── chatroom/</span><br><span class="line">│   │   │           ├── config/</span><br><span class="line">│   │   │           │   └── WebSocketConfig.java</span><br><span class="line">│   │   │           ├── controller/</span><br><span class="line">│   │   │           │   └── ChatController.java</span><br><span class="line">│   │   │           ├── model/</span><br><span class="line">│   │   │           │   ├── ChatMessage.java</span><br><span class="line">│   │   │           │   └── UserSession.java</span><br><span class="line">│   │   │           └── ChatRoomApplication.java</span><br><span class="line">│   │   └── resources/</span><br><span class="line">│   │       ├── static/</span><br><span class="line">│   │       │   ├── css/</span><br><span class="line">│   │       │   │   └── chat.css</span><br><span class="line">│   │       │   ├── js/</span><br><span class="line">│   │       │   │   └── chat.js</span><br><span class="line">│   │       │   └── index.html</span><br><span class="line">│   │       └── application.yml</span><br><span class="line">└── pom.xml</span><br></pre></td></tr></table></figure>



<h3 id="3-2-运行步骤"><a href="#3-2-运行步骤" class="headerlink" title="3.2 运行步骤"></a>3.2 运行步骤</h3><ol>
<li><p>确保已安装Java 11或更高版本</p>
</li>
<li><p>确保已安装Maven</p>
</li>
<li><p>在项目根目录执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mvn clean package</span><br><span class="line">java -jar target/chat-room-1.0.0.jar</span><br></pre></td></tr></table></figure>
</li>
<li><p>或者使用IDE（如IntelliJ IDEA或Eclipse）直接运行<code>ChatRoomApplication.java</code></p>
</li>
</ol>
<h3 id="3-3-访问应用"><a href="#3-3-访问应用" class="headerlink" title="3.3 访问应用"></a>3.3 访问应用</h3><p>打开浏览器，访问：<code>http://localhost:8080</code></p>
<h2 id="4-功能特点"><a href="#4-功能特点" class="headerlink" title="4. 功能特点"></a>4. 功能特点</h2><h3 id="4-1-核心功能"><a href="#4-1-核心功能" class="headerlink" title="4.1 核心功能"></a>4.1 核心功能</h3><ol>
<li><strong>用户管理</strong>：设置用户名和头像颜色</li>
<li><strong>实时聊天</strong>：公共聊天室支持所有在线用户</li>
<li><strong>私聊功能</strong>：支持一对一私密聊天</li>
<li><strong>用户列表</strong>：实时显示在线用户，支持搜索</li>
<li><strong>消息通知</strong>：桌面通知和提示音</li>
<li><strong>输入状态</strong>：显示用户”正在输入”状态</li>
<li><strong>消息历史</strong>：私聊会话保存历史记录</li>
</ol>
<h3 id="4-2-高级功能"><a href="#4-2-高级功能" class="headerlink" title="4.2 高级功能"></a>4.2 高级功能</h3><ol>
<li><strong>响应式设计</strong>：适配桌面和移动设备</li>
<li><strong>主题切换</strong>：支持亮色&#x2F;暗色主题</li>
<li><strong>表情支持</strong>：预留表情功能接口</li>
<li><strong>文件上传</strong>：预留文件上传功能接口</li>
<li><strong>消息状态</strong>：显示消息发送状态（已发送、已读）</li>
<li><strong>聊天记录</strong>：支持清空聊天记录</li>
</ol>
<h3 id="4-3-技术特点"><a href="#4-3-技术特点" class="headerlink" title="4.3 技术特点"></a>4.3 技术特点</h3><ol>
<li><strong>Spring Boot</strong>：简化后端开发</li>
<li><strong>WebSocket</strong>：实现实时双向通信</li>
<li><strong>STOMP</strong>：简单的消息传递协议</li>
<li><strong>SockJS</strong>：WebSocket备用方案</li>
<li><strong>纯前端技术</strong>：HTML5、CSS3、原生JavaScript</li>
<li><strong>响应式布局</strong>：CSS Flexbox和Grid</li>
</ol>
<h2 id="5-扩展建议"><a href="#5-扩展建议" class="headerlink" title="5. 扩展建议"></a>5. 扩展建议</h2><h3 id="5-1-功能扩展"><a href="#5-1-功能扩展" class="headerlink" title="5.1 功能扩展"></a>5.1 功能扩展</h3><ol>
<li><strong>数据库集成</strong>：添加MySQL&#x2F;PostgreSQL保存聊天记录</li>
<li><strong>用户认证</strong>：集成Spring Security实现登录</li>
<li><strong>房间功能</strong>：支持创建不同的聊天房间</li>
<li><strong>文件分享</strong>：支持上传和发送图片&#x2F;文件</li>
<li><strong>消息加密</strong>：端到端加密私聊消息</li>
<li><strong>语音&#x2F;视频</strong>：集成WebRTC实现语音视频聊天</li>
</ol>
<h3 id="5-2-部署建议"><a href="#5-2-部署建议" class="headerlink" title="5.2 部署建议"></a>5.2 部署建议</h3><ol>
<li><strong>Docker化</strong>：创建Docker镜像方便部署</li>
<li><strong>Nginx反向代理</strong>：配置SSL证书支持HTTPS</li>
<li><strong>负载均衡</strong>：多实例部署支持更多用户</li>
<li><strong>消息队列</strong>：集成RabbitMQ或Kafka处理高并发</li>
<li><strong>监控告警</strong>：集成Prometheus和Grafana监控</li>
</ol>
<p>这个聊天室项目涵盖了现代Web应用的主要技术栈，适合用于学习Java Web开发和实时通信技术。您可以根据需要进一步扩展和完善功能。</p>
<h1 id="多人聊天室扩展"><a href="#多人聊天室扩展" class="headerlink" title="多人聊天室扩展"></a>多人聊天室扩展</h1><p>我将继续扩展和完善这个聊天室项目，增加更多功能和优化。</p>
<h2 id="扩展功能清单"><a href="#扩展功能清单" class="headerlink" title="扩展功能清单"></a>扩展功能清单</h2><ol>
<li><strong>用户认证系统</strong> - 注册&#x2F;登录&#x2F;退出</li>
<li><strong>消息持久化</strong> - 数据库存储聊天记录</li>
<li><strong>文件上传</strong> - 支持发送图片和文件</li>
<li><strong>表情系统</strong> - 丰富的表情选择</li>
<li><strong>语音消息</strong> - 录制和发送语音</li>
<li><strong>管理员功能</strong> - 用户管理、消息管理</li>
<li><strong>高级搜索</strong> - 聊天记录搜索</li>
<li><strong>主题系统</strong> - 多套界面主题</li>
<li><strong>通知系统</strong> - 桌面通知和声音提醒</li>
<li><strong>性能优化</strong> - 消息分页、WebSocket连接优化</li>
</ol>
<h2 id="1-数据库设计-MySQL"><a href="#1-数据库设计-MySQL" class="headerlink" title="1. 数据库设计 (MySQL)"></a>1. 数据库设计 (MySQL)</h2><h3 id="1-1-SQL-脚本"><a href="#1-1-SQL-脚本" class="headerlink" title="1.1 SQL 脚本"></a>1.1 SQL 脚本</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建数据库</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> chat_room <span class="keyword">DEFAULT</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci;</span><br><span class="line">USE chat_room;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 用户表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> users (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">UNIQUE</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    password <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">UNIQUE</span>,</span><br><span class="line">    nickname <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    avatar_color <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;#4361ee&#x27;</span>,</span><br><span class="line">    avatar_url <span class="type">VARCHAR</span>(<span class="number">500</span>),</span><br><span class="line">    bio TEXT,</span><br><span class="line">    status ENUM(<span class="string">&#x27;ONLINE&#x27;</span>, <span class="string">&#x27;OFFLINE&#x27;</span>, <span class="string">&#x27;AWAY&#x27;</span>, <span class="string">&#x27;BUSY&#x27;</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;OFFLINE&#x27;</span>,</span><br><span class="line">    role ENUM(<span class="string">&#x27;USER&#x27;</span>, <span class="string">&#x27;MODERATOR&#x27;</span>, <span class="string">&#x27;ADMIN&#x27;</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;USER&#x27;</span>,</span><br><span class="line">    last_seen <span class="type">TIMESTAMP</span> <span class="keyword">NULL</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    INDEX idx_username (username),</span><br><span class="line">    INDEX idx_status (status)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 聊天消息表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> messages (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,</span><br><span class="line">    sender_id <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    receiver_id <span class="type">BIGINT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    room_id <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;public&#x27;</span>,</span><br><span class="line">    content TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    message_type ENUM(<span class="string">&#x27;TEXT&#x27;</span>, <span class="string">&#x27;IMAGE&#x27;</span>, <span class="string">&#x27;FILE&#x27;</span>, <span class="string">&#x27;VOICE&#x27;</span>, <span class="string">&#x27;SYSTEM&#x27;</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;TEXT&#x27;</span>,</span><br><span class="line">    file_url <span class="type">VARCHAR</span>(<span class="number">500</span>),</span><br><span class="line">    file_name <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">    file_size <span class="type">BIGINT</span>,</span><br><span class="line">    is_read <span class="type">BOOLEAN</span> <span class="keyword">DEFAULT</span> <span class="literal">FALSE</span>,</span><br><span class="line">    is_deleted <span class="type">BOOLEAN</span> <span class="keyword">DEFAULT</span> <span class="literal">FALSE</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    INDEX idx_sender_receiver (sender_id, receiver_id),</span><br><span class="line">    INDEX idx_room (room_id),</span><br><span class="line">    INDEX idx_created_at (created_at),</span><br><span class="line">    <span class="keyword">FOREIGN</span> KEY (sender_id) <span class="keyword">REFERENCES</span> users(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE,</span><br><span class="line">    <span class="keyword">FOREIGN</span> KEY (receiver_id) <span class="keyword">REFERENCES</span> users(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">SET</span> <span class="keyword">NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 聊天室表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> chat_rooms (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    description TEXT,</span><br><span class="line">    is_public <span class="type">BOOLEAN</span> <span class="keyword">DEFAULT</span> <span class="literal">TRUE</span>,</span><br><span class="line">    max_users <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">100</span>,</span><br><span class="line">    created_by <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    <span class="keyword">FOREIGN</span> KEY (created_by) <span class="keyword">REFERENCES</span> users(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE,</span><br><span class="line">    INDEX idx_is_public (is_public)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 聊天室成员表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> room_members (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,</span><br><span class="line">    room_id <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    user_id <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    joined_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    role ENUM(<span class="string">&#x27;MEMBER&#x27;</span>, <span class="string">&#x27;ADMIN&#x27;</span>, <span class="string">&#x27;OWNER&#x27;</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;MEMBER&#x27;</span>,</span><br><span class="line">    is_muted <span class="type">BOOLEAN</span> <span class="keyword">DEFAULT</span> <span class="literal">FALSE</span>,</span><br><span class="line">    <span class="keyword">UNIQUE</span> KEY unique_room_user (room_id, user_id),</span><br><span class="line">    <span class="keyword">FOREIGN</span> KEY (room_id) <span class="keyword">REFERENCES</span> chat_rooms(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE,</span><br><span class="line">    <span class="keyword">FOREIGN</span> KEY (user_id) <span class="keyword">REFERENCES</span> users(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE,</span><br><span class="line">    INDEX idx_user_id (user_id)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 用户会话表 (用于WebSocket连接管理)</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> user_sessions (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,</span><br><span class="line">    user_id <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    session_id <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    ip_address <span class="type">VARCHAR</span>(<span class="number">45</span>),</span><br><span class="line">    user_agent TEXT,</span><br><span class="line">    connected_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    disconnected_at <span class="type">TIMESTAMP</span> <span class="keyword">NULL</span>,</span><br><span class="line">    is_active <span class="type">BOOLEAN</span> <span class="keyword">DEFAULT</span> <span class="literal">TRUE</span>,</span><br><span class="line">    INDEX idx_user_id (user_id),</span><br><span class="line">    INDEX idx_session_id (session_id),</span><br><span class="line">    INDEX idx_is_active (is_active),</span><br><span class="line">    <span class="keyword">FOREIGN</span> KEY (user_id) <span class="keyword">REFERENCES</span> users(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 用户关系表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> user_relationships (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,</span><br><span class="line">    user_id <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    friend_id <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    status ENUM(<span class="string">&#x27;PENDING&#x27;</span>, <span class="string">&#x27;ACCEPTED&#x27;</span>, <span class="string">&#x27;BLOCKED&#x27;</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;PENDING&#x27;</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    <span class="keyword">UNIQUE</span> KEY unique_relationship (user_id, friend_id),</span><br><span class="line">    <span class="keyword">FOREIGN</span> KEY (user_id) <span class="keyword">REFERENCES</span> users(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE,</span><br><span class="line">    <span class="keyword">FOREIGN</span> KEY (friend_id) <span class="keyword">REFERENCES</span> users(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE,</span><br><span class="line">    INDEX idx_user_status (user_id, status),</span><br><span class="line">    INDEX idx_friend_status (friend_id, status)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 消息阅读状态表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> message_read_status (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,</span><br><span class="line">    message_id <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    user_id <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    read_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    <span class="keyword">UNIQUE</span> KEY unique_message_user (message_id, user_id),</span><br><span class="line">    <span class="keyword">FOREIGN</span> KEY (message_id) <span class="keyword">REFERENCES</span> messages(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE,</span><br><span class="line">    <span class="keyword">FOREIGN</span> KEY (user_id) <span class="keyword">REFERENCES</span> users(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入默认公共聊天室</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> chat_rooms (name, description, is_public, created_by) </span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;公共聊天室&#x27;</span>, <span class="string">&#x27;欢迎来到公共聊天室，这里可以和大家畅所欲言！&#x27;</span>, <span class="literal">TRUE</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入默认管理员用户 (密码: admin123)</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> users (username, password, nickname, role, status) </span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;$2a$10$YourHashedPasswordHere&#x27;</span>, <span class="string">&#x27;系统管理员&#x27;</span>, <span class="string">&#x27;ADMIN&#x27;</span>, <span class="string">&#x27;OFFLINE&#x27;</span>);</span><br></pre></td></tr></table></figure>



<h3 id="1-2-更新pom-xml依赖"><a href="#1-2-更新pom-xml依赖" class="headerlink" title="1.2 更新pom.xml依赖"></a>1.2 更新pom.xml依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 数据库相关依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.h2database<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>h2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 安全认证 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-jackson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 文件上传 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 缓存 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.ben-manes.caffeine<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>caffeine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="2-JPA实体类"><a href="#2-JPA实体类" class="headerlink" title="2. JPA实体类"></a>2. JPA实体类</h2><h3 id="2-1-User-实体类"><a href="#2-1-User-实体类" class="headerlink" title="2.1 User 实体类"></a>2.1 User 实体类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;users&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(unique = true, nullable = false, length = 50)</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(unique = true)</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(length = 50)</span></span><br><span class="line">    <span class="keyword">private</span> String nickname;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">avatarColor</span> <span class="operator">=</span> <span class="string">&quot;#4361ee&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String avatarUrl;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;TEXT&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String bio;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Enumerated(EnumType.STRING)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">UserStatus</span> <span class="variable">status</span> <span class="operator">=</span> UserStatus.OFFLINE;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Enumerated(EnumType.STRING)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">UserRole</span> <span class="variable">role</span> <span class="operator">=</span> UserRole.USER;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> LocalDateTime lastSeen;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(updatable = false)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createdAt;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> LocalDateTime updatedAt;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@OneToMany(mappedBy = &quot;sender&quot;, cascade = CascadeType.ALL)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Message&gt; sentMessages = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@OneToMany(mappedBy = &quot;receiver&quot;, cascade = CascadeType.ALL)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Message&gt; receivedMessages = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@OneToMany(mappedBy = &quot;user&quot;, cascade = CascadeType.ALL)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;UserSession&gt; sessions = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PrePersist</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123;</span><br><span class="line">        createdAt = LocalDateTime.now();</span><br><span class="line">        updatedAt = LocalDateTime.now();</span><br><span class="line">        <span class="keyword">if</span> (nickname == <span class="literal">null</span>) &#123;</span><br><span class="line">            nickname = username;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PreUpdate</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onUpdate</span><span class="params">()</span> &#123;</span><br><span class="line">        updatedAt = LocalDateTime.now();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 枚举定义</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">UserStatus</span> &#123;</span><br><span class="line">        ONLINE, OFFLINE, AWAY, BUSY</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">UserRole</span> &#123;</span><br><span class="line">        USER, MODERATOR, ADMIN</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Getters and Setters</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getId</span><span class="params">()</span> &#123; <span class="keyword">return</span> id; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Long id)</span> &#123; <span class="built_in">this</span>.id = id; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123; <span class="keyword">return</span> username; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUsername</span><span class="params">(String username)</span> &#123; <span class="built_in">this</span>.username = username; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123; <span class="keyword">return</span> password; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPassword</span><span class="params">(String password)</span> &#123; <span class="built_in">this</span>.password = password; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getEmail</span><span class="params">()</span> &#123; <span class="keyword">return</span> email; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEmail</span><span class="params">(String email)</span> &#123; <span class="built_in">this</span>.email = email; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getNickname</span><span class="params">()</span> &#123; <span class="keyword">return</span> nickname; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNickname</span><span class="params">(String nickname)</span> &#123; <span class="built_in">this</span>.nickname = nickname; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAvatarColor</span><span class="params">()</span> &#123; <span class="keyword">return</span> avatarColor; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAvatarColor</span><span class="params">(String avatarColor)</span> &#123; <span class="built_in">this</span>.avatarColor = avatarColor; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAvatarUrl</span><span class="params">()</span> &#123; <span class="keyword">return</span> avatarUrl; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAvatarUrl</span><span class="params">(String avatarUrl)</span> &#123; <span class="built_in">this</span>.avatarUrl = avatarUrl; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getBio</span><span class="params">()</span> &#123; <span class="keyword">return</span> bio; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBio</span><span class="params">(String bio)</span> &#123; <span class="built_in">this</span>.bio = bio; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> UserStatus <span class="title function_">getStatus</span><span class="params">()</span> &#123; <span class="keyword">return</span> status; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStatus</span><span class="params">(UserStatus status)</span> &#123; <span class="built_in">this</span>.status = status; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> UserRole <span class="title function_">getRole</span><span class="params">()</span> &#123; <span class="keyword">return</span> role; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRole</span><span class="params">(UserRole role)</span> &#123; <span class="built_in">this</span>.role = role; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> LocalDateTime <span class="title function_">getLastSeen</span><span class="params">()</span> &#123; <span class="keyword">return</span> lastSeen; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLastSeen</span><span class="params">(LocalDateTime lastSeen)</span> &#123; <span class="built_in">this</span>.lastSeen = lastSeen; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> LocalDateTime <span class="title function_">getCreatedAt</span><span class="params">()</span> &#123; <span class="keyword">return</span> createdAt; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCreatedAt</span><span class="params">(LocalDateTime createdAt)</span> &#123; <span class="built_in">this</span>.createdAt = createdAt; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> LocalDateTime <span class="title function_">getUpdatedAt</span><span class="params">()</span> &#123; <span class="keyword">return</span> updatedAt; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUpdatedAt</span><span class="params">(LocalDateTime updatedAt)</span> &#123; <span class="built_in">this</span>.updatedAt = updatedAt; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;Message&gt; <span class="title function_">getSentMessages</span><span class="params">()</span> &#123; <span class="keyword">return</span> sentMessages; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSentMessages</span><span class="params">(List&lt;Message&gt; sentMessages)</span> &#123; <span class="built_in">this</span>.sentMessages = sentMessages; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;Message&gt; <span class="title function_">getReceivedMessages</span><span class="params">()</span> &#123; <span class="keyword">return</span> receivedMessages; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setReceivedMessages</span><span class="params">(List&lt;Message&gt; receivedMessages)</span> &#123; <span class="built_in">this</span>.receivedMessages = receivedMessages; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;UserSession&gt; <span class="title function_">getSessions</span><span class="params">()</span> &#123; <span class="keyword">return</span> sessions; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSessions</span><span class="params">(List&lt;UserSession&gt; sessions)</span> &#123; <span class="built_in">this</span>.sessions = sessions; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-2-Message-实体类"><a href="#2-2-Message-实体类" class="headerlink" title="2.2 Message 实体类"></a>2.2 Message 实体类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;messages&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ManyToOne(fetch = FetchType.LAZY)</span></span><br><span class="line">    <span class="meta">@JoinColumn(name = &quot;sender_id&quot;, nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> User sender;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ManyToOne(fetch = FetchType.LAZY)</span></span><br><span class="line">    <span class="meta">@JoinColumn(name = &quot;receiver_id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> User receiver;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(name = &quot;room_id&quot;, length = 100)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">roomId</span> <span class="operator">=</span> <span class="string">&quot;public&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(nullable = false, columnDefinition = &quot;TEXT&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Enumerated(EnumType.STRING)</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;message_type&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">MessageType</span> <span class="variable">type</span> <span class="operator">=</span> MessageType.TEXT;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(name = &quot;file_url&quot;, length = 500)</span></span><br><span class="line">    <span class="keyword">private</span> String fileUrl;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(name = &quot;file_name&quot;, length = 255)</span></span><br><span class="line">    <span class="keyword">private</span> String fileName;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(name = &quot;file_size&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long fileSize;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(name = &quot;is_read&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">read</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(name = &quot;is_deleted&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">deleted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createdAt;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@OneToMany(mappedBy = &quot;message&quot;, cascade = CascadeType.ALL, fetch = FetchType.LAZY)</span></span><br><span class="line">    <span class="keyword">private</span> Set&lt;MessageReadStatus&gt; readStatuses = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PrePersist</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123;</span><br><span class="line">        createdAt = LocalDateTime.now();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 枚举定义</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">MessageType</span> &#123;</span><br><span class="line">        TEXT, IMAGE, FILE, VOICE, SYSTEM</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Getters and Setters</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getId</span><span class="params">()</span> &#123; <span class="keyword">return</span> id; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Long id)</span> &#123; <span class="built_in">this</span>.id = id; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getSender</span><span class="params">()</span> &#123; <span class="keyword">return</span> sender; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSender</span><span class="params">(User sender)</span> &#123; <span class="built_in">this</span>.sender = sender; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getReceiver</span><span class="params">()</span> &#123; <span class="keyword">return</span> receiver; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setReceiver</span><span class="params">(User receiver)</span> &#123; <span class="built_in">this</span>.receiver = receiver; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getRoomId</span><span class="params">()</span> &#123; <span class="keyword">return</span> roomId; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRoomId</span><span class="params">(String roomId)</span> &#123; <span class="built_in">this</span>.roomId = roomId; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getContent</span><span class="params">()</span> &#123; <span class="keyword">return</span> content; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setContent</span><span class="params">(String content)</span> &#123; <span class="built_in">this</span>.content = content; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> MessageType <span class="title function_">getType</span><span class="params">()</span> &#123; <span class="keyword">return</span> type; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setType</span><span class="params">(MessageType type)</span> &#123; <span class="built_in">this</span>.type = type; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getFileUrl</span><span class="params">()</span> &#123; <span class="keyword">return</span> fileUrl; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setFileUrl</span><span class="params">(String fileUrl)</span> &#123; <span class="built_in">this</span>.fileUrl = fileUrl; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getFileName</span><span class="params">()</span> &#123; <span class="keyword">return</span> fileName; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setFileName</span><span class="params">(String fileName)</span> &#123; <span class="built_in">this</span>.fileName = fileName; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getFileSize</span><span class="params">()</span> &#123; <span class="keyword">return</span> fileSize; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setFileSize</span><span class="params">(Long fileSize)</span> &#123; <span class="built_in">this</span>.fileSize = fileSize; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isRead</span><span class="params">()</span> &#123; <span class="keyword">return</span> read; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRead</span><span class="params">(<span class="type">boolean</span> read)</span> &#123; <span class="built_in">this</span>.read = read; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isDeleted</span><span class="params">()</span> &#123; <span class="keyword">return</span> deleted; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDeleted</span><span class="params">(<span class="type">boolean</span> deleted)</span> &#123; <span class="built_in">this</span>.deleted = deleted; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> LocalDateTime <span class="title function_">getCreatedAt</span><span class="params">()</span> &#123; <span class="keyword">return</span> createdAt; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCreatedAt</span><span class="params">(LocalDateTime createdAt)</span> &#123; <span class="built_in">this</span>.createdAt = createdAt; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Set&lt;MessageReadStatus&gt; <span class="title function_">getReadStatuses</span><span class="params">()</span> &#123; <span class="keyword">return</span> readStatuses; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setReadStatuses</span><span class="params">(Set&lt;MessageReadStatus&gt; readStatuses)</span> &#123; <span class="built_in">this</span>.readStatuses = readStatuses; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-3-其他实体类"><a href="#2-3-其他实体类" class="headerlink" title="2.3 其他实体类"></a>2.3 其他实体类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;chat_rooms&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatRoom</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(nullable = false, length = 100)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;TEXT&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(name = &quot;is_public&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isPublic</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(name = &quot;max_users&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">maxUsers</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ManyToOne(fetch = FetchType.LAZY)</span></span><br><span class="line">    <span class="meta">@JoinColumn(name = &quot;created_by&quot;, nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> User createdBy;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(updatable = false)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createdAt;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> LocalDateTime updatedAt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Getters and Setters...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;user_sessions&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserSession</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ManyToOne(fetch = FetchType.LAZY)</span></span><br><span class="line">    <span class="meta">@JoinColumn(name = &quot;user_id&quot;, nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(name = &quot;session_id&quot;, nullable = false, length = 100)</span></span><br><span class="line">    <span class="keyword">private</span> String sessionId;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(name = &quot;ip_address&quot;, length = 45)</span></span><br><span class="line">    <span class="keyword">private</span> String ipAddress;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(name = &quot;user_agent&quot;, columnDefinition = &quot;TEXT&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String userAgent;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(name = &quot;connected_at&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime connectedAt;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(name = &quot;disconnected_at&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime disconnectedAt;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(name = &quot;is_active&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">active</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Getters and Setters...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-Spring-Security配置"><a href="#3-Spring-Security配置" class="headerlink" title="3. Spring Security配置"></a>3. Spring Security配置</h2><h3 id="3-1-Security配置类"><a href="#3-1-Security配置类" class="headerlink" title="3.1 Security配置类"></a>3.1 Security配置类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.chatroom.security.JwtAuthenticationFilter;</span><br><span class="line"><span class="keyword">import</span> com.chatroom.security.JwtAuthenticationEntryPoint;</span><br><span class="line"><span class="keyword">import</span> com.chatroom.service.UserDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.http.SessionCreationPolicy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.CorsConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.CorsConfigurationSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.UrlBasedCorsConfigurationSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsServiceImpl userDetailsService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtAuthenticationEntryPoint unauthorizedHandler;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtAuthenticationFilter <span class="title function_">jwtAuthenticationFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtAuthenticationFilter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        auth.userDetailsService(userDetailsService).passwordEncoder(passwordEncoder());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">            .cors().and()</span><br><span class="line">            .csrf().disable()</span><br><span class="line">            .exceptionHandling()</span><br><span class="line">                .authenticationEntryPoint(unauthorizedHandler)</span><br><span class="line">                .and()</span><br><span class="line">            .sessionManagement()</span><br><span class="line">                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line">                .and()</span><br><span class="line">            .authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/api/auth/**&quot;</span>).permitAll()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/api/public/**&quot;</span>).permitAll()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/ws/**&quot;</span>).permitAll()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/css/**&quot;</span>, <span class="string">&quot;/js/**&quot;</span>, <span class="string">&quot;/images/**&quot;</span>, <span class="string">&quot;/favicon.ico&quot;</span>).permitAll()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;/index.html&quot;</span>, <span class="string">&quot;/login&quot;</span>, <span class="string">&quot;/register&quot;</span>).permitAll()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/admin/**&quot;</span>).hasRole(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">                .antMatchers(<span class="string">&quot;/moderator/**&quot;</span>).hasAnyRole(<span class="string">&quot;ADMIN&quot;</span>, <span class="string">&quot;MODERATOR&quot;</span>)</span><br><span class="line">                .anyRequest().authenticated();</span><br><span class="line">        </span><br><span class="line">        http.addFilterBefore(jwtAuthenticationFilter(), UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CorsConfigurationSource <span class="title function_">corsConfigurationSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">CorsConfiguration</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line">        configuration.setAllowedOrigins(Arrays.asList(<span class="string">&quot;*&quot;</span>));</span><br><span class="line">        configuration.setAllowedMethods(Arrays.asList(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>, <span class="string">&quot;PUT&quot;</span>, <span class="string">&quot;DELETE&quot;</span>, <span class="string">&quot;OPTIONS&quot;</span>));</span><br><span class="line">        configuration.setAllowedHeaders(Arrays.asList(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;X-Requested-With&quot;</span>));</span><br><span class="line">        configuration.setExposedHeaders(Arrays.asList(<span class="string">&quot;Authorization&quot;</span>));</span><br><span class="line">        configuration.setAllowCredentials(<span class="literal">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();</span><br><span class="line">        source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, configuration);</span><br><span class="line">        <span class="keyword">return</span> source;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-2-JWT工具类"><a href="#3-2-JWT工具类" class="headerlink" title="3.2 JWT工具类"></a>3.2 JWT工具类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.security;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.*;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.security.Keys;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.crypto.SecretKey;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtTokenProvider</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;app.jwt.secret&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String jwtSecret;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;app.jwt.expiration&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> jwtExpirationInMs;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> SecretKey <span class="title function_">getSigningKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Keys.hmacShaKeyFor(jwtSecret.getBytes());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateToken</span><span class="params">(Authentication authentication)</span> &#123;</span><br><span class="line">        <span class="type">UserPrincipal</span> <span class="variable">userPrincipal</span> <span class="operator">=</span> (UserPrincipal) authentication.getPrincipal();</span><br><span class="line">        </span><br><span class="line">        <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        <span class="type">Date</span> <span class="variable">expiryDate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>(now.getTime() + jwtExpirationInMs);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Jwts.builder()</span><br><span class="line">                .setSubject(Long.toString(userPrincipal.getId()))</span><br><span class="line">                .setIssuedAt(<span class="keyword">new</span> <span class="title class_">Date</span>())</span><br><span class="line">                .setExpiration(expiryDate)</span><br><span class="line">                .signWith(getSigningKey())</span><br><span class="line">                .compact();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getUserIdFromJWT</span><span class="params">(String token)</span> &#123;</span><br><span class="line">        <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> Jwts.parserBuilder()</span><br><span class="line">                .setSigningKey(getSigningKey())</span><br><span class="line">                .build()</span><br><span class="line">                .parseClaimsJws(token)</span><br><span class="line">                .getBody();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Long.parseLong(claims.getSubject());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">validateToken</span><span class="params">(String authToken)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Jwts.parserBuilder()</span><br><span class="line">                .setSigningKey(getSigningKey())</span><br><span class="line">                .build()</span><br><span class="line">                .parseClaimsJws(authToken);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MalformedJwtException ex) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Invalid JWT token&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ExpiredJwtException ex) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Expired JWT token&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedJwtException ex) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Unsupported JWT token&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;JWT claims string is empty&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-3-JWT认证过滤器"><a href="#3-3-JWT认证过滤器" class="headerlink" title="3.3 JWT认证过滤器"></a>3.3 JWT认证过滤器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.security;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.WebAuthenticationDetailsSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtTokenProvider tokenProvider;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsServiceImpl userDetailsService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, </span></span><br><span class="line"><span class="params">                                    HttpServletResponse response, </span></span><br><span class="line"><span class="params">                                    FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">jwt</span> <span class="operator">=</span> getJwtFromRequest(request);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (StringUtils.hasText(jwt) &amp;&amp; tokenProvider.validateToken(jwt)) &#123;</span><br><span class="line">                <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> tokenProvider.getUserIdFromJWT(jwt);</span><br><span class="line">                </span><br><span class="line">                <span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> userDetailsService.loadUserById(userId);</span><br><span class="line">                <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authentication</span> <span class="operator">=</span> </span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(userDetails, <span class="literal">null</span>, userDetails.getAuthorities());</span><br><span class="line">                authentication.setDetails(<span class="keyword">new</span> <span class="title class_">WebAuthenticationDetailsSource</span>().buildDetails(request));</span><br><span class="line">                </span><br><span class="line">                SecurityContextHolder.getContext().setAuthentication(authentication);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Could not set user authentication in security context: &quot;</span> + ex.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getJwtFromRequest</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">bearerToken</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(bearerToken) &amp;&amp; bearerToken.startsWith(<span class="string">&quot;Bearer &quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> bearerToken.substring(<span class="number">7</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-认证和用户管理API"><a href="#4-认证和用户管理API" class="headerlink" title="4. 认证和用户管理API"></a>4. 认证和用户管理API</h2><h3 id="4-1-认证控制器"><a href="#4-1-认证控制器" class="headerlink" title="4.1 认证控制器"></a>4.1 认证控制器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.controller.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.chatroom.dto.LoginRequest;</span><br><span class="line"><span class="keyword">import</span> com.chatroom.dto.RegisterRequest;</span><br><span class="line"><span class="keyword">import</span> com.chatroom.dto.ApiResponse;</span><br><span class="line"><span class="keyword">import</span> com.chatroom.dto.JwtAuthenticationResponse;</span><br><span class="line"><span class="keyword">import</span> com.chatroom.entity.User;</span><br><span class="line"><span class="keyword">import</span> com.chatroom.security.JwtTokenProvider;</span><br><span class="line"><span class="keyword">import</span> com.chatroom.service.UserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.Valid;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/auth&quot;)</span></span><br><span class="line"><span class="meta">@CrossOrigin(origins = &quot;*&quot;, maxAge = 3600)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtTokenProvider tokenProvider;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;?&gt; authenticateUser(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> LoginRequest loginRequest) &#123;</span><br><span class="line">        <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> authenticationManager.authenticate(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(</span><br><span class="line">                loginRequest.getUsernameOrEmail(),</span><br><span class="line">                loginRequest.getPassword()</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        SecurityContextHolder.getContext().setAuthentication(authentication);</span><br><span class="line">        <span class="type">String</span> <span class="variable">jwt</span> <span class="operator">=</span> tokenProvider.generateToken(authentication);</span><br><span class="line">        </span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findByUsernameOrEmail(loginRequest.getUsernameOrEmail());</span><br><span class="line">        userService.updateUserStatus(user.getId(), User.UserStatus.ONLINE);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(<span class="keyword">new</span> <span class="title class_">JwtAuthenticationResponse</span>(</span><br><span class="line">            jwt, </span><br><span class="line">            <span class="string">&quot;Bearer&quot;</span>,</span><br><span class="line">            user.getId(),</span><br><span class="line">            user.getUsername(),</span><br><span class="line">            user.getNickname(),</span><br><span class="line">            user.getEmail(),</span><br><span class="line">            user.getRole().name()</span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/register&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;?&gt; registerUser(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> RegisterRequest registerRequest) &#123;</span><br><span class="line">        <span class="keyword">if</span> (userService.existsByUsername(registerRequest.getUsername())) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.badRequest().body(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ApiResponse</span>(<span class="literal">false</span>, <span class="string">&quot;用户名已存在&quot;</span>)</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (userService.existsByEmail(registerRequest.getEmail())) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.badRequest().body(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ApiResponse</span>(<span class="literal">false</span>, <span class="string">&quot;邮箱已存在&quot;</span>)</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setUsername(registerRequest.getUsername());</span><br><span class="line">        user.setEmail(registerRequest.getEmail());</span><br><span class="line">        user.setPassword(registerRequest.getPassword());</span><br><span class="line">        user.setNickname(registerRequest.getNickname());</span><br><span class="line">        </span><br><span class="line">        userService.createUser(user);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(<span class="keyword">new</span> <span class="title class_">ApiResponse</span>(<span class="literal">true</span>, <span class="string">&quot;用户注册成功&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/logout&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;?&gt; logoutUser(<span class="meta">@RequestHeader(value = &quot;Authorization&quot;)</span> String token) &#123;</span><br><span class="line">        <span class="keyword">if</span> (token != <span class="literal">null</span> &amp;&amp; token.startsWith(<span class="string">&quot;Bearer &quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 可以在这里将token加入黑名单</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">jwt</span> <span class="operator">=</span> token.substring(<span class="number">7</span>);</span><br><span class="line">            <span class="comment">// token黑名单逻辑...</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新用户状态</span></span><br><span class="line">        <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">        <span class="keyword">if</span> (authentication != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">UserPrincipal</span> <span class="variable">userPrincipal</span> <span class="operator">=</span> (UserPrincipal) authentication.getPrincipal();</span><br><span class="line">            userService.updateUserStatus(userPrincipal.getId(), User.UserStatus.OFFLINE);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(<span class="keyword">new</span> <span class="title class_">ApiResponse</span>(<span class="literal">true</span>, <span class="string">&quot;登出成功&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/check-username/&#123;username&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Boolean&gt; <span class="title function_">checkUsernameAvailability</span><span class="params">(<span class="meta">@PathVariable</span> String username)</span> &#123;</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">isAvailable</span> <span class="operator">=</span> !userService.existsByUsername(username);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(isAvailable);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/check-email/&#123;email&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Boolean&gt; <span class="title function_">checkEmailAvailability</span><span class="params">(<span class="meta">@PathVariable</span> String email)</span> &#123;</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">isAvailable</span> <span class="operator">=</span> !userService.existsByEmail(email);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(isAvailable);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-2-DTO类"><a href="#4-2-DTO类" class="headerlink" title="4.2 DTO类"></a>4.2 DTO类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.Email;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.NotBlank;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.Size;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginRequest</span> &#123;</span><br><span class="line">    <span class="meta">@NotBlank</span></span><br><span class="line">    <span class="keyword">private</span> String usernameOrEmail;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotBlank</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Getters and Setters...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RegisterRequest</span> &#123;</span><br><span class="line">    <span class="meta">@NotBlank</span></span><br><span class="line">    <span class="meta">@Size(min = 3, max = 20)</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotBlank</span></span><br><span class="line">    <span class="meta">@Size(max = 50)</span></span><br><span class="line">    <span class="meta">@Email</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotBlank</span></span><br><span class="line">    <span class="meta">@Size(min = 6, max = 40)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Size(max = 50)</span></span><br><span class="line">    <span class="keyword">private</span> String nickname;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Getters and Setters...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationResponse</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String accessToken;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">tokenType</span> <span class="operator">=</span> <span class="string">&quot;Bearer&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String nickname;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="keyword">private</span> String role;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Constructor, Getters and Setters...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApiResponse</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Boolean success;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Constructor, Getters and Setters...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-扩展WebSocket功能"><a href="#5-扩展WebSocket功能" class="headerlink" title="5. 扩展WebSocket功能"></a>5. 扩展WebSocket功能</h2><h3 id="5-1-WebSocket认证拦截器"><a href="#5-1-WebSocket认证拦截器" class="headerlink" title="5.1 WebSocket认证拦截器"></a>5.1 WebSocket认证拦截器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.websocket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.chatroom.security.JwtTokenProvider;</span><br><span class="line"><span class="keyword">import</span> com.chatroom.service.UserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.ServerHttpRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.ServerHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.ServletServerHttpRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.WebSocketHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.server.HandshakeInterceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthHandshakeInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandshakeInterceptor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtTokenProvider tokenProvider;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">beforeHandshake</span><span class="params">(ServerHttpRequest request, ServerHttpResponse response, </span></span><br><span class="line"><span class="params">                                   WebSocketHandler wsHandler, Map&lt;String, Object&gt; attributes)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (request <span class="keyword">instanceof</span> ServletServerHttpRequest) &#123;</span><br><span class="line">            <span class="type">ServletServerHttpRequest</span> <span class="variable">servletRequest</span> <span class="operator">=</span> (ServletServerHttpRequest) request;</span><br><span class="line">            <span class="type">HttpServletRequest</span> <span class="variable">httpServletRequest</span> <span class="operator">=</span> servletRequest.getServletRequest();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 从请求参数或Header中获取token</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> httpServletRequest.getParameter(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (token == <span class="literal">null</span>) &#123;</span><br><span class="line">                token = httpServletRequest.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (token != <span class="literal">null</span> &amp;&amp; token.startsWith(<span class="string">&quot;Bearer &quot;</span>)) &#123;</span><br><span class="line">                    token = token.substring(<span class="number">7</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (token != <span class="literal">null</span> &amp;&amp; tokenProvider.validateToken(token)) &#123;</span><br><span class="line">                <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> tokenProvider.getUserIdFromJWT(token);</span><br><span class="line">                attributes.put(<span class="string">&quot;userId&quot;</span>, userId);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterHandshake</span><span class="params">(ServerHttpRequest request, ServerHttpResponse response, </span></span><br><span class="line"><span class="params">                               WebSocketHandler wsHandler, Exception exception)</span> &#123;</span><br><span class="line">        <span class="comment">// 握手后处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-2-增强的WebSocket配置"><a href="#5-2-增强的WebSocket配置" class="headerlink" title="5.2 增强的WebSocket配置"></a>5.2 增强的WebSocket配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.chatroom.websocket.AuthHandshakeInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.chatroom.websocket.PresenceChannelInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.simp.config.ChannelRegistration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.simp.config.MessageBrokerRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.config.annotation.EnableWebSocketMessageBroker;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.config.annotation.StompEndpointRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.config.annotation.WebSocketMessageBrokerConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSocketMessageBroker</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketConfig</span> <span class="keyword">implements</span> <span class="title class_">WebSocketMessageBrokerConfigurer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthHandshakeInterceptor authHandshakeInterceptor;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PresenceChannelInterceptor presenceChannelInterceptor;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureMessageBroker</span><span class="params">(MessageBrokerRegistry config)</span> &#123;</span><br><span class="line">        <span class="comment">// 启用简单消息代理，目标以/topic、/queue、/user开头</span></span><br><span class="line">        config.enableSimpleBroker(<span class="string">&quot;/topic&quot;</span>, <span class="string">&quot;/queue&quot;</span>, <span class="string">&quot;/user&quot;</span>);</span><br><span class="line">        <span class="comment">// 全局消息前缀</span></span><br><span class="line">        config.setApplicationDestinationPrefixes(<span class="string">&quot;/app&quot;</span>);</span><br><span class="line">        <span class="comment">// 点对点消息前缀</span></span><br><span class="line">        config.setUserDestinationPrefix(<span class="string">&quot;/user&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerStompEndpoints</span><span class="params">(StompEndpointRegistry registry)</span> &#123;</span><br><span class="line">        <span class="comment">// 注册WebSocket端点，允许跨域，添加认证拦截器</span></span><br><span class="line">        registry.addEndpoint(<span class="string">&quot;/ws&quot;</span>)</span><br><span class="line">                .addInterceptors(authHandshakeInterceptor)</span><br><span class="line">                .setAllowedOriginPatterns(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">                .withSockJS();</span><br><span class="line">        </span><br><span class="line">        registry.addEndpoint(<span class="string">&quot;/ws&quot;</span>)</span><br><span class="line">                .addInterceptors(authHandshakeInterceptor)</span><br><span class="line">                .setAllowedOriginPatterns(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureClientInboundChannel</span><span class="params">(ChannelRegistration registration)</span> &#123;</span><br><span class="line">        registration.interceptors(presenceChannelInterceptor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-3-增强的WebSocket处理器"><a href="#5-3-增强的WebSocket处理器" class="headerlink" title="5.3 增强的WebSocket处理器"></a>5.3 增强的WebSocket处理器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.websocket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.chatroom.dto.MessageDTO;</span><br><span class="line"><span class="keyword">import</span> com.chatroom.entity.Message;</span><br><span class="line"><span class="keyword">import</span> com.chatroom.entity.User;</span><br><span class="line"><span class="keyword">import</span> com.chatroom.service.MessageService;</span><br><span class="line"><span class="keyword">import</span> com.chatroom.service.UserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.event.EventListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.simp.SimpMessageHeaderAccessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.simp.SimpMessagingTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.simp.stomp.StompHeaderAccessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.messaging.SessionConnectEvent;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.messaging.SessionDisconnectEvent;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketEventListener</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SimpMessagingTemplate messagingTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MessageService messageService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String&gt; sessionUserMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleWebSocketConnectListener</span><span class="params">(SessionConnectEvent event)</span> &#123;</span><br><span class="line">        <span class="type">StompHeaderAccessor</span> <span class="variable">headerAccessor</span> <span class="operator">=</span> StompHeaderAccessor.wrap(event.getMessage());</span><br><span class="line">        Map&lt;String, Object&gt; sessionAttributes = headerAccessor.getSessionAttributes();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (sessionAttributes != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> (Long) sessionAttributes.get(<span class="string">&quot;userId&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (userId != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">sessionId</span> <span class="operator">=</span> headerAccessor.getSessionId();</span><br><span class="line">                sessionUserMap.put(sessionId, userId.toString());</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 更新用户状态为在线</span></span><br><span class="line">                userService.updateUserStatus(userId, User.UserStatus.ONLINE);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 广播用户上线通知</span></span><br><span class="line">                <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findById(userId);</span><br><span class="line">                <span class="type">MessageDTO</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageDTO</span>();</span><br><span class="line">                message.setType(Message.MessageType.SYSTEM);</span><br><span class="line">                message.setSender(<span class="string">&quot;系统&quot;</span>);</span><br><span class="line">                message.setContent(user.getNickname() + <span class="string">&quot; 上线了&quot;</span>);</span><br><span class="line">                message.setTimestamp(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">                </span><br><span class="line">                messagingTemplate.convertAndSend(<span class="string">&quot;/topic/public&quot;</span>, message);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 广播在线用户列表更新</span></span><br><span class="line">                broadcastOnlineUsers();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleWebSocketDisconnectListener</span><span class="params">(SessionDisconnectEvent event)</span> &#123;</span><br><span class="line">        <span class="type">StompHeaderAccessor</span> <span class="variable">headerAccessor</span> <span class="operator">=</span> StompHeaderAccessor.wrap(event.getMessage());</span><br><span class="line">        <span class="type">String</span> <span class="variable">sessionId</span> <span class="operator">=</span> headerAccessor.getSessionId();</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">userIdStr</span> <span class="operator">=</span> sessionUserMap.remove(sessionId);</span><br><span class="line">        <span class="keyword">if</span> (userIdStr != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> Long.parseLong(userIdStr);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果用户没有其他活跃会话，更新状态为离线</span></span><br><span class="line">            <span class="keyword">if</span> (!sessionUserMap.containsValue(userIdStr)) &#123;</span><br><span class="line">                userService.updateUserStatus(userId, User.UserStatus.OFFLINE);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 广播用户离线通知</span></span><br><span class="line">                <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findById(userId);</span><br><span class="line">                <span class="type">MessageDTO</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageDTO</span>();</span><br><span class="line">                message.setType(Message.MessageType.SYSTEM);</span><br><span class="line">                message.setSender(<span class="string">&quot;系统&quot;</span>);</span><br><span class="line">                message.setContent(user.getNickname() + <span class="string">&quot; 离线了&quot;</span>);</span><br><span class="line">                message.setTimestamp(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">                </span><br><span class="line">                messagingTemplate.convertAndSend(<span class="string">&quot;/topic/public&quot;</span>, message);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 广播在线用户列表更新</span></span><br><span class="line">                broadcastOnlineUsers();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">broadcastOnlineUsers</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 获取在线用户列表并广播</span></span><br><span class="line">        Map&lt;String, Object&gt; onlineUsers = userService.getOnlineUsers();</span><br><span class="line">        messagingTemplate.convertAndSend(<span class="string">&quot;/topic/online-users&quot;</span>, onlineUsers);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="6-文件上传功能"><a href="#6-文件上传功能" class="headerlink" title="6. 文件上传功能"></a>6. 文件上传功能</h2><h3 id="6-1-文件上传配置"><a href="#6-1-文件上传配置" class="headerlink" title="6.1 文件上传配置"></a>6.1 文件上传配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.commons.CommonsMultipartResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileUploadConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;file.upload-dir&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String uploadDir;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;file.max-size&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String maxFileSize;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MultipartResolver <span class="title function_">multipartResolver</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">CommonsMultipartResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonsMultipartResolver</span>();</span><br><span class="line">        resolver.setMaxUploadSizePerFile(<span class="number">50</span> * <span class="number">1024</span> * <span class="number">1024</span>); <span class="comment">// 50MB</span></span><br><span class="line">        resolver.setDefaultEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resolver;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> &#123;</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/uploads/**&quot;</span>)</span><br><span class="line">                .addResourceLocations(<span class="string">&quot;file:&quot;</span> + uploadDir + <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-2-文件服务类"><a href="#6-2-文件服务类" class="headerlink" title="6.2 文件服务类"></a>6.2 文件服务类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.StandardCopyOption;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;file.upload-dir&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String uploadDir;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Files.createDirectories(Paths.get(uploadDir, <span class="string">&quot;images&quot;</span>));</span><br><span class="line">            Files.createDirectories(Paths.get(uploadDir, <span class="string">&quot;files&quot;</span>));</span><br><span class="line">            Files.createDirectories(Paths.get(uploadDir, <span class="string">&quot;voices&quot;</span>));</span><br><span class="line">            Files.createDirectories(Paths.get(uploadDir, <span class="string">&quot;avatars&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Could not create upload directory&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">storeFile</span><span class="params">(MultipartFile file, String fileType)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 验证文件类型</span></span><br><span class="line">        <span class="keyword">if</span> (!isValidFileType(file, fileType)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Invalid file type&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 生成唯一文件名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">originalFilename</span> <span class="operator">=</span> file.getOriginalFilename();</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileExtension</span> <span class="operator">=</span> getFileExtension(originalFilename);</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> generateFileName(fileExtension);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 确定存储路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">storagePath</span> <span class="operator">=</span> getStoragePath(fileType);</span><br><span class="line">        <span class="type">Path</span> <span class="variable">targetLocation</span> <span class="operator">=</span> Paths.get(storagePath).resolve(fileName);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 保存文件</span></span><br><span class="line">        Files.copy(file.getInputStream(), targetLocation, StandardCopyOption.REPLACE_EXISTING);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 返回访问路径</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/uploads/&quot;</span> + getRelativePath(fileType) + <span class="string">&quot;/&quot;</span> + fileName;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteFile</span><span class="params">(String fileUrl)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (fileUrl == <span class="literal">null</span> || !fileUrl.startsWith(<span class="string">&quot;/uploads/&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> uploadDir + fileUrl.substring(<span class="string">&quot;/uploads&quot;</span>.length());</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(filePath);</span><br><span class="line">        <span class="keyword">return</span> file.delete();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">generateFileName</span><span class="params">(String extension)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">timestamp</span> <span class="operator">=</span> LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyyMMddHHmmss&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> UUID.randomUUID().toString().substring(<span class="number">0</span>, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">return</span> timestamp + <span class="string">&quot;_&quot;</span> + uuid + <span class="string">&quot;.&quot;</span> + extension;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getFileExtension</span><span class="params">(String filename)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (filename == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">lastDotIndex</span> <span class="operator">=</span> filename.lastIndexOf(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> lastDotIndex == -<span class="number">1</span> ? <span class="string">&quot;&quot;</span> : filename.substring(lastDotIndex + <span class="number">1</span>).toLowerCase();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isValidFileType</span><span class="params">(MultipartFile file, String fileType)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">contentType</span> <span class="operator">=</span> file.getContentType();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> (fileType) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;image&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> contentType != <span class="literal">null</span> &amp;&amp; contentType.startsWith(<span class="string">&quot;image/&quot;</span>);</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;voice&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> contentType != <span class="literal">null</span> &amp;&amp; contentType.startsWith(<span class="string">&quot;audio/&quot;</span>);</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;file&quot;</span>:</span><br><span class="line">                <span class="comment">// 允许所有文件类型，但可以限制大小</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getStoragePath</span><span class="params">(String fileType)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (fileType) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;image&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> uploadDir + <span class="string">&quot;/images&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;voice&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> uploadDir + <span class="string">&quot;/voices&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;avatar&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> uploadDir + <span class="string">&quot;/avatars&quot;</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> uploadDir + <span class="string">&quot;/files&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getRelativePath</span><span class="params">(String fileType)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (fileType) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;image&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;images&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;voice&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;voices&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;avatar&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;avatars&quot;</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;files&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getFileSizeReadable</span><span class="params">(<span class="type">long</span> size)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (size &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="string">&quot;0 B&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">final</span> String[] units = <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;B&quot;</span>, <span class="string">&quot;KB&quot;</span>, <span class="string">&quot;MB&quot;</span>, <span class="string">&quot;GB&quot;</span>, <span class="string">&quot;TB&quot;</span>&#125;;</span><br><span class="line">        <span class="type">int</span> <span class="variable">digitGroups</span> <span class="operator">=</span> (<span class="type">int</span>) (Math.log10(size) / Math.log10(<span class="number">1024</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;%.1f %s&quot;</span>, size / Math.pow(<span class="number">1024</span>, digitGroups), units[digitGroups]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="7-前端扩展"><a href="#7-前端扩展" class="headerlink" title="7. 前端扩展"></a>7. 前端扩展</h2><h3 id="7-1-增强的聊天页面-index-html扩展"><a href="#7-1-增强的聊天页面-index-html扩展" class="headerlink" title="7.1 增强的聊天页面 (index.html扩展)"></a>7.1 增强的聊天页面 (index.html扩展)</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 在原有基础上添加以下功能区域 --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 用户设置模态框 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal-overlay&quot;</span> <span class="attr">id</span>=<span class="string">&quot;userSettingsModal&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal-header&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h3</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-user-cog&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 用户设置<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;close-modal&quot;</span>&gt;</span><span class="symbol">&amp;times;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal-body&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;settings-tabs&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;tab-header&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;tab-btn active&quot;</span> <span class="attr">data-tab</span>=<span class="string">&quot;profile&quot;</span>&gt;</span>个人资料<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;tab-btn&quot;</span> <span class="attr">data-tab</span>=<span class="string">&quot;account&quot;</span>&gt;</span>账户设置<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;tab-btn&quot;</span> <span class="attr">data-tab</span>=<span class="string">&quot;privacy&quot;</span>&gt;</span>隐私设置<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;tab-btn&quot;</span> <span class="attr">data-tab</span>=<span class="string">&quot;notifications&quot;</span>&gt;</span>通知设置<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                </span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;tab-content active&quot;</span> <span class="attr">id</span>=<span class="string">&quot;profileTab&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;avatar-upload&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;avatar-preview&quot;</span> <span class="attr">id</span>=<span class="string">&quot;avatarPreview&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;头像预览&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;avatarUpload&quot;</span> <span class="attr">accept</span>=<span class="string">&quot;image/*&quot;</span> <span class="attr">hidden</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn-secondary&quot;</span> <span class="attr">id</span>=<span class="string">&quot;changeAvatarBtn&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-camera&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 更换头像</span><br><span class="line">                        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;editNickname&quot;</span>&gt;</span>昵称<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;editNickname&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入昵称&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;editBio&quot;</span>&gt;</span>个人简介<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">&quot;editBio&quot;</span> <span class="attr">rows</span>=<span class="string">&quot;3&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;介绍一下自己...&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">label</span>&gt;</span>状态<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;status-options&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;status-option&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;status&quot;</span> <span class="attr">value</span>=<span class="string">&quot;ONLINE&quot;</span> <span class="attr">checked</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;status-indicator online&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span>&gt;</span>在线<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;status-option&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;status&quot;</span> <span class="attr">value</span>=<span class="string">&quot;AWAY&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;status-indicator away&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span>&gt;</span>离开<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;status-option&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;status&quot;</span> <span class="attr">value</span>=<span class="string">&quot;BUSY&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;status-indicator busy&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span>&gt;</span>忙碌<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                </span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;tab-content&quot;</span> <span class="attr">id</span>=<span class="string">&quot;accountTab&quot;</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- 账户设置内容 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                </span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;tab-content&quot;</span> <span class="attr">id</span>=<span class="string">&quot;privacyTab&quot;</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- 隐私设置内容 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                </span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;tab-content&quot;</span> <span class="attr">id</span>=<span class="string">&quot;notificationsTab&quot;</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- 通知设置内容 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal-footer&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;saveSettingsBtn&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn-primary&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-save&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 保存设置</span><br><span class="line">            <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 表情选择器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;emoji-picker&quot;</span> <span class="attr">id</span>=<span class="string">&quot;emojiPicker&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;emoji-categories&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;emoji-category-btn active&quot;</span> <span class="attr">data-category</span>=<span class="string">&quot;smileys&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;far fa-smile&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;emoji-category-btn&quot;</span> <span class="attr">data-category</span>=<span class="string">&quot;animals&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-paw&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;emoji-category-btn&quot;</span> <span class="attr">data-category</span>=<span class="string">&quot;food&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-utensils&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;emoji-category-btn&quot;</span> <span class="attr">data-category</span>=<span class="string">&quot;travel&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-plane&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;emoji-category-btn&quot;</span> <span class="attr">data-category</span>=<span class="string">&quot;objects&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-lightbulb&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;emoji-category-btn&quot;</span> <span class="attr">data-category</span>=<span class="string">&quot;symbols&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-heart&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;emoji-grid&quot;</span> <span class="attr">id</span>=<span class="string">&quot;emojiGrid&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 表情将通过JS动态生成 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;emoji-search&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;emojiSearch&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;搜索表情...&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 文件上传模态框 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal-overlay&quot;</span> <span class="attr">id</span>=<span class="string">&quot;fileUploadModal&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal-header&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h3</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-cloud-upload-alt&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 上传文件<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;close-modal&quot;</span>&gt;</span><span class="symbol">&amp;times;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal-body&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;upload-area&quot;</span> <span class="attr">id</span>=<span class="string">&quot;uploadArea&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-cloud-upload-alt upload-icon&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>拖放文件到这里，或点击选择文件<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;fileInput&quot;</span> <span class="attr">multiple</span> <span class="attr">hidden</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn-secondary&quot;</span> <span class="attr">id</span>=<span class="string">&quot;selectFileBtn&quot;</span>&gt;</span>选择文件<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            </span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;upload-progress&quot;</span> <span class="attr">id</span>=<span class="string">&quot;uploadProgress&quot;</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 上传进度将通过JS动态生成 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            </span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;upload-preview&quot;</span> <span class="attr">id</span>=<span class="string">&quot;uploadPreview&quot;</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 文件预览 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal-footer&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;sendFilesBtn&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn-primary&quot;</span> <span class="attr">disabled</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-paper-plane&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 发送文件</span><br><span class="line">            <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 语音消息录制组件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;voice-recorder&quot;</span> <span class="attr">id</span>=<span class="string">&quot;voiceRecorder&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;recorder-header&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-microphone&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 录制语音消息<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;close-recorder&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-times&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;recorder-body&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;recorder-visualizer&quot;</span> <span class="attr">id</span>=<span class="string">&quot;visualizer&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 音频可视化 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;recorder-timer&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;recordingTime&quot;</span>&gt;</span>00:00<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;recorder-controls&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;recorder-btn record-btn&quot;</span> <span class="attr">id</span>=<span class="string">&quot;startRecordBtn&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-microphone&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;recorder-btn stop-btn&quot;</span> <span class="attr">id</span>=<span class="string">&quot;stopRecordBtn&quot;</span> <span class="attr">disabled</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-stop&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;recorder-btn play-btn&quot;</span> <span class="attr">id</span>=<span class="string">&quot;playRecordBtn&quot;</span> <span class="attr">disabled</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-play&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;recorder-btn send-btn&quot;</span> <span class="attr">id</span>=<span class="string">&quot;sendRecordBtn&quot;</span> <span class="attr">disabled</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-paper-plane&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 消息上下文菜单 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;context-menu&quot;</span> <span class="attr">id</span>=<span class="string">&quot;messageContextMenu&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">data-action</span>=<span class="string">&quot;copy&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-copy&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 复制<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">data-action</span>=<span class="string">&quot;reply&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-reply&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 回复<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">data-action</span>=<span class="string">&quot;forward&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-share&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 转发<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">data-action</span>=<span class="string">&quot;delete&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-trash&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 删除<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;separator&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">data-action</span>=<span class="string">&quot;report&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-flag&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 举报<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">data-action</span>=<span class="string">&quot;block&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-ban&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 屏蔽用户<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="7-2-增强的CSS样"><a href="#7-2-增强的CSS样" class="headerlink" title="7.2 增强的CSS样"></a>7.2 增强的CSS样</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 添加到chat.css中 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 主题系统 */</span></span><br><span class="line"><span class="selector-tag">body</span><span class="selector-class">.dark-theme</span> &#123;</span><br><span class="line">    <span class="attr">--primary-color</span>: <span class="number">#7289da</span>;</span><br><span class="line">    <span class="attr">--secondary-color</span>: <span class="number">#5865f2</span>;</span><br><span class="line">    <span class="attr">--dark-color</span>: <span class="number">#36393f</span>;</span><br><span class="line">    <span class="attr">--light-color</span>: <span class="number">#2f3136</span>;</span><br><span class="line">    <span class="attr">--gray-color</span>: <span class="number">#b9bbbe</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#202225</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span><span class="selector-class">.dark-theme</span> <span class="selector-class">.container</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--dark-color);</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#ffffff</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span><span class="selector-class">.dark-theme</span> <span class="selector-class">.sidebar</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--light-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span><span class="selector-class">.dark-theme</span> <span class="selector-class">.main-chat</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--dark-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span><span class="selector-class">.dark-theme</span> <span class="selector-class">.message-content</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--light-color);</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#dcddde</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span><span class="selector-class">.dark-theme</span> <span class="selector-class">.message</span><span class="selector-class">.outgoing</span> <span class="selector-class">.message-content</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 消息类型样式 */</span></span><br><span class="line"><span class="selector-class">.message</span><span class="selector-class">.file-message</span> <span class="selector-class">.message-content</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">max-width</span>: <span class="number">400px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.file-preview</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.05</span>);</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">10px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.file-icon</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">50px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">50px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1.5rem</span>;</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.file-icon</span><span class="selector-class">.image</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">135deg</span>, <span class="number">#667eea</span> <span class="number">0%</span>, <span class="number">#764ba2</span> <span class="number">100%</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.file-icon</span><span class="selector-class">.pdf</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">135deg</span>, <span class="number">#f093fb</span> <span class="number">0%</span>, <span class="number">#f5576c</span> <span class="number">100%</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.file-icon</span><span class="selector-class">.word</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">135deg</span>, <span class="number">#4facfe</span> <span class="number">0%</span>, <span class="number">#00f2fe</span> <span class="number">100%</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.file-icon</span><span class="selector-class">.excel</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">135deg</span>, <span class="number">#43e97b</span> <span class="number">0%</span>, <span class="number">#38f9d7</span> <span class="number">100%</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.file-icon</span><span class="selector-class">.zip</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">135deg</span>, <span class="number">#fa709a</span> <span class="number">0%</span>, <span class="number">#fee140</span> <span class="number">100%</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.file-info</span> &#123;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.file-name</span> &#123;</span><br><span class="line">    <span class="attribute">font-weight</span>: <span class="number">500</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">word-break</span>: break-all;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.file-size</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.85rem</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--gray-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.file-download</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">border</span>: none;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">40px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">40px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.file-download</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--secondary-color);</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translateY</span>(-<span class="number">2px</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 图片消息 */</span></span><br><span class="line"><span class="selector-class">.message</span><span class="selector-class">.image-message</span> <span class="selector-class">.message-content</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    <span class="attribute">max-width</span>: <span class="number">400px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.image-preview</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">max-height</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">object-fit</span>: cover;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="built_in">var</span>(--border-radius);</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.image-preview</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">scale</span>(<span class="number">1.02</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 语音消息 */</span></span><br><span class="line"><span class="selector-class">.message</span><span class="selector-class">.voice-message</span> <span class="selector-class">.message-content</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">10px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.voice-player</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.05</span>);</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">10px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.voice-play-btn</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">border</span>: none;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">40px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">40px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.voice-play-btn</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--secondary-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.voice-progress</span> &#123;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.voice-progress-bar</span> &#123;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">4px</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.1</span>);</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">2px</span>;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">5px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.voice-progress-filled</span> &#123;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">0%</span>;</span><br><span class="line">    <span class="attribute">transition</span>: width <span class="number">0.1s</span> linear;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.voice-duration</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-between;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.85rem</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--gray-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 表情选择器 */</span></span><br><span class="line"><span class="selector-class">.emoji-picker</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">bottom</span>: <span class="number">70px</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">350px</span>;</span><br><span class="line">    <span class="attribute">background</span>: white;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="built_in">var</span>(--border-radius);</span><br><span class="line">    <span class="attribute">box-shadow</span>: <span class="built_in">var</span>(--box-shadow);</span><br><span class="line">    <span class="attribute">display</span>: none;</span><br><span class="line">    <span class="attribute">flex-direction</span>: column;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    <span class="attribute">z-index</span>: <span class="number">1000</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span><span class="selector-class">.dark-theme</span> <span class="selector-class">.emoji-picker</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--light-color);</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.emoji-picker</span><span class="selector-class">.show</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.emoji-categories</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="number">#eaeaea</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#f8f9fa</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span><span class="selector-class">.dark-theme</span> <span class="selector-class">.emoji-categories</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#2a2d31</span>;</span><br><span class="line">    <span class="attribute">border-color</span>: <span class="number">#40444b</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.emoji-category-btn</span> &#123;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">background</span>: none;</span><br><span class="line">    <span class="attribute">border</span>: none;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--gray-color);</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.emoji-category-btn</span><span class="selector-pseudo">:hover</span>,</span><br><span class="line"><span class="selector-class">.emoji-category-btn</span><span class="selector-class">.active</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.emoji-grid</span> &#123;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">display</span>: grid;</span><br><span class="line">    <span class="attribute">grid-template-columns</span>: <span class="built_in">repeat</span>(<span class="number">6</span>, <span class="number">1</span>fr);</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">overflow-y</span>: auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.emoji-item</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1.5rem</span>;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.emoji-item</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">67</span>, <span class="number">97</span>, <span class="number">238</span>, <span class="number">0.1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span><span class="selector-class">.dark-theme</span> <span class="selector-class">.emoji-item</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">114</span>, <span class="number">137</span>, <span class="number">218</span>, <span class="number">0.2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.emoji-search</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">border-top</span>: <span class="number">1px</span> solid <span class="number">#eaeaea</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span><span class="selector-class">.dark-theme</span> <span class="selector-class">.emoji-search</span> &#123;</span><br><span class="line">    <span class="attribute">border-color</span>: <span class="number">#40444b</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.emoji-search</span> <span class="selector-tag">input</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">8px</span> <span class="number">12px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#eaeaea</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.9rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span><span class="selector-class">.dark-theme</span> <span class="selector-class">.emoji-search</span> <span class="selector-tag">input</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#40444b</span>;</span><br><span class="line">    <span class="attribute">border-color</span>: <span class="number">#40444b</span>;</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 上传区域 */</span></span><br><span class="line"><span class="selector-class">.upload-area</span> &#123;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">2px</span> dashed <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="built_in">var</span>(--border-radius);</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">40px</span> <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.upload-area</span><span class="selector-class">.drag-over</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">67</span>, <span class="number">97</span>, <span class="number">238</span>, <span class="number">0.1</span>);</span><br><span class="line">    <span class="attribute">border-color</span>: <span class="built_in">var</span>(--secondary-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.upload-icon</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">3rem</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">15px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.upload-progress</span> &#123;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">20px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.progress-item</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#f8f9fa</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">10px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span><span class="selector-class">.dark-theme</span> <span class="selector-class">.progress-item</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#2a2d31</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.progress-icon</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">40px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">40px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.progress-info</span> &#123;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.progress-name</span> &#123;</span><br><span class="line">    <span class="attribute">font-weight</span>: <span class="number">500</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">word-break</span>: break-all;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.progress-bar</span> &#123;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">6px</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.1</span>);</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">3px</span>;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">5px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.progress-filled</span> &#123;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">0%</span>;</span><br><span class="line">    <span class="attribute">transition</span>: width <span class="number">0.3s</span> ease;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.progress-status</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-between;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.85rem</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--gray-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 语音录制器 */</span></span><br><span class="line"><span class="selector-class">.voice-recorder</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">bottom</span>: <span class="number">70px</span>;</span><br><span class="line">    <span class="attribute">right</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">background</span>: white;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="built_in">var</span>(--border-radius);</span><br><span class="line">    <span class="attribute">box-shadow</span>: <span class="built_in">var</span>(--box-shadow);</span><br><span class="line">    <span class="attribute">display</span>: none;</span><br><span class="line">    <span class="attribute">flex-direction</span>: column;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    <span class="attribute">z-index</span>: <span class="number">1000</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span><span class="selector-class">.dark-theme</span> <span class="selector-class">.voice-recorder</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--light-color);</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.voice-recorder</span><span class="selector-class">.show</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.recorder-header</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="number">#eaeaea</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-between;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span><span class="selector-class">.dark-theme</span> <span class="selector-class">.recorder-header</span> &#123;</span><br><span class="line">    <span class="attribute">border-color</span>: <span class="number">#40444b</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.close-recorder</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: none;</span><br><span class="line">    <span class="attribute">border</span>: none;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--gray-color);</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1.2rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.recorder-body</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.recorder-visualizer</span> &#123;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">80px</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.recorder-timer</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">2rem</span>;</span><br><span class="line">    <span class="attribute">font-weight</span>: bold;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.recorder-controls</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">20px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.recorder-btn</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">60px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">60px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">border</span>: none;</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1.2rem</span>;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.record-btn</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--danger-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.record-btn</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#d8355f</span>;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">scale</span>(<span class="number">1.1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.record-btn</span><span class="selector-class">.recording</span> &#123;</span><br><span class="line">    <span class="attribute">animation</span>: pulse <span class="number">1.5s</span> infinite;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.stop-btn</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--warning-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.stop-btn</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#e6b83c</span>;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">scale</span>(<span class="number">1.1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.play-btn</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--success-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.play-btn</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#05c18f</span>;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">scale</span>(<span class="number">1.1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.send-btn</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.send-btn</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--secondary-color);</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">scale</span>(<span class="number">1.1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.recorder-btn</span><span class="selector-pseudo">:disabled</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--gray-color);</span><br><span class="line">    <span class="attribute">cursor</span>: not-allowed;</span><br><span class="line">    <span class="attribute">transform</span>: none <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 消息回复 */</span></span><br><span class="line"><span class="selector-class">.message-reply</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">67</span>, <span class="number">97</span>, <span class="number">238</span>, <span class="number">0.1</span>);</span><br><span class="line">    <span class="attribute">border-left</span>: <span class="number">3px</span> solid <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">10px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.reply-header</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-between;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">5px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.reply-sender</span> &#123;</span><br><span class="line">    <span class="attribute">font-weight</span>: <span class="number">500</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.9rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.reply-content</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.9rem</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--gray-color);</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    <span class="attribute">text-overflow</span>: ellipsis;</span><br><span class="line">    <span class="attribute">white-space</span>: nowrap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 消息上下文菜单 */</span></span><br><span class="line"><span class="selector-class">.context-menu</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: fixed;</span><br><span class="line">    <span class="attribute">background</span>: white;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">5px</span> <span class="number">20px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.15</span>);</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">8px</span> <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">min-width</span>: <span class="number">180px</span>;</span><br><span class="line">    <span class="attribute">z-index</span>: <span class="number">10000</span>;</span><br><span class="line">    <span class="attribute">display</span>: none;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span><span class="selector-class">.dark-theme</span> <span class="selector-class">.context-menu</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--light-color);</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.context-menu</span> <span class="selector-tag">ul</span> &#123;</span><br><span class="line">    <span class="attribute">list-style</span>: none;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.context-menu</span> <span class="selector-tag">li</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">10px</span> <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.context-menu</span> <span class="selector-tag">li</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">67</span>, <span class="number">97</span>, <span class="number">238</span>, <span class="number">0.1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span><span class="selector-class">.dark-theme</span> <span class="selector-class">.context-menu</span> <span class="selector-tag">li</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">114</span>, <span class="number">137</span>, <span class="number">218</span>, <span class="number">0.2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.context-menu</span> <span class="selector-class">.separator</span> &#123;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">1px</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#eaeaea</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">8px</span> <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span><span class="selector-class">.dark-theme</span> <span class="selector-class">.context-menu</span> <span class="selector-class">.separator</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#40444b</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 消息已读状态 */</span></span><br><span class="line"><span class="selector-class">.message-read-status</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">margin-top</span>: <span class="number">8px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.read-avatar</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.7rem</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 加载更多消息 */</span></span><br><span class="line"><span class="selector-class">.load-more-container</span> &#123;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">20px</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.load-more-btn</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: none;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">10px</span> <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.9rem</span>;</span><br><span class="line">    <span class="attribute">transition</span>: <span class="built_in">var</span>(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.load-more-btn</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.loading-spinner</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: inline-block;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">2px</span> solid <span class="built_in">rgba</span>(<span class="number">67</span>, <span class="number">97</span>, <span class="number">238</span>, <span class="number">0.3</span>);</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">border-top-color</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">animation</span>: spin <span class="number">1s</span> ease-in-out infinite;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@keyframes</span> spin &#123;</span><br><span class="line">    <span class="selector-tag">to</span> &#123; <span class="attribute">transform</span>: <span class="built_in">rotate</span>(<span class="number">360deg</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 响应式优化 */</span></span><br><span class="line"><span class="keyword">@media</span> (<span class="attribute">max-width</span>: <span class="number">768px</span>) &#123;</span><br><span class="line">    <span class="selector-class">.emoji-picker</span>,</span><br><span class="line">    <span class="selector-class">.voice-recorder</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="built_in">calc</span>(<span class="number">100%</span> - <span class="number">40px</span>);</span><br><span class="line">        <span class="attribute">left</span>: <span class="number">20px</span>;</span><br><span class="line">        <span class="attribute">right</span>: <span class="number">20px</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="selector-class">.file-preview</span> &#123;</span><br><span class="line">        <span class="attribute">flex-direction</span>: column;</span><br><span class="line">        <span class="attribute">text-align</span>: center;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="selector-class">.message</span> &#123;</span><br><span class="line">        <span class="attribute">max-width</span>: <span class="number">85%</span> <span class="meta">!important</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 动画效果 */</span></span><br><span class="line"><span class="keyword">@keyframes</span> slideIn &#123;</span><br><span class="line">    <span class="selector-tag">from</span> &#123;</span><br><span class="line">        <span class="attribute">opacity</span>: <span class="number">0</span>;</span><br><span class="line">        <span class="attribute">transform</span>: <span class="built_in">translateY</span>(<span class="number">20px</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-tag">to</span> &#123;</span><br><span class="line">        <span class="attribute">opacity</span>: <span class="number">1</span>;</span><br><span class="line">        <span class="attribute">transform</span>: <span class="built_in">translateY</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.message</span> &#123;</span><br><span class="line">    <span class="attribute">animation</span>: slideIn <span class="number">0.3s</span> ease;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 通知提醒 */</span></span><br><span class="line"><span class="selector-class">.notification-badge</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">top</span>: -<span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">right</span>: -<span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--danger-color);</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.7rem</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">animation</span>: bounce <span class="number">2s</span> infinite;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@keyframes</span> bounce &#123;</span><br><span class="line">    <span class="number">0%</span>, <span class="number">100%</span> &#123; <span class="attribute">transform</span>: <span class="built_in">scale</span>(<span class="number">1</span>); &#125;</span><br><span class="line">    <span class="number">50%</span> &#123; <span class="attribute">transform</span>: <span class="built_in">scale</span>(<span class="number">1.1</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 消息搜索 */</span></span><br><span class="line"><span class="selector-class">.search-highlight</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: yellow;</span><br><span class="line">    <span class="attribute">color</span>: black;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span> <span class="number">2px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">2px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-3-增强的JavaScript功能"><a href="#7-3-增强的JavaScript功能" class="headerlink" title="7.3 增强的JavaScript功能"></a>7.3 增强的JavaScript功能</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在原有ChatRoom类基础上扩展</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EnhancedChatRoom</span> <span class="keyword">extends</span> <span class="title class_ inherited__">ChatRoom</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentUser</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">token</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">messageHistory</span> = [];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isTyping</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">lastTypingTime</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">uploadQueue</span> = [];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">uploading</span> = <span class="literal">false</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">initEnhancedFeatures</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">initEnhancedFeatures</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">cacheEnhancedElements</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">bindEnhancedEvents</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">initEmojiPicker</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">initVoiceRecorder</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">checkAuthStatus</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">cacheEnhancedElements</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// 表情选择器</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">emojiPicker</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;emojiPicker&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">emojiGrid</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;emojiGrid&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">emojiSearch</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;emojiSearch&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">emojiCategoryBtns</span> = <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.emoji-category-btn&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 文件上传</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">fileUploadModal</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;fileUploadModal&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">uploadArea</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;uploadArea&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">fileInput</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;fileInput&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">selectFileBtn</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;selectFileBtn&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">sendFilesBtn</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;sendFilesBtn&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">uploadProgress</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;uploadProgress&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">uploadPreview</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;uploadPreview&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 语音录制</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">voiceRecorder</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;voiceRecorder&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">startRecordBtn</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;startRecordBtn&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">stopRecordBtn</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;stopRecordBtn&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">playRecordBtn</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;playRecordBtn&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">sendRecordBtn</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;sendRecordBtn&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">recordingTime</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;recordingTime&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">visualizer</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;visualizer&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 用户设置</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">userSettingsModal</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;userSettingsModal&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">avatarPreview</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;avatarPreview&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">avatarUpload</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;avatarUpload&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">changeAvatarBtn</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;changeAvatarBtn&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">editNickname</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;editNickname&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">editBio</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;editBio&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">saveSettingsBtn</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;saveSettingsBtn&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 上下文菜单</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">contextMenu</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;messageContextMenu&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 音频API</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">audioContext</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">analyser</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">recorder</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">audioChunks</span> = [];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isRecording</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isPlaying</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">recordingTimer</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">recordingStartTime</span> = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">bindEnhancedEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// 表情选择器</span></span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.input-action-btn&#x27;</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">btn</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (btn.<span class="title function_">querySelector</span>(<span class="string">&#x27;.fa-smile&#x27;</span>)) &#123;</span><br><span class="line">                btn.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">toggleEmojiPicker</span>());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (btn.<span class="title function_">querySelector</span>(<span class="string">&#x27;.fa-paperclip&#x27;</span>)) &#123;</span><br><span class="line">                btn.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">showFileUploadModal</span>());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (btn.<span class="title function_">querySelector</span>(<span class="string">&#x27;.fa-microphone&#x27;</span>)) &#123;</span><br><span class="line">                btn.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">toggleVoiceRecorder</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 表情分类切换</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">emojiCategoryBtns</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">btn</span> =&gt;</span> &#123;</span><br><span class="line">            btn.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">switchEmojiCategory</span>(btn));</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 表情搜索</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">emojiSearch</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;input&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">searchEmojis</span>(e.<span class="property">target</span>.<span class="property">value</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 文件上传</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">selectFileBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">fileInput</span>.<span class="title function_">click</span>());</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">fileInput</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;change&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">handleFileSelection</span>(e));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 拖放上传</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">uploadArea</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;dragover&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">            e.<span class="title function_">preventDefault</span>();</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">uploadArea</span>.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;drag-over&#x27;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">uploadArea</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;dragleave&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">uploadArea</span>.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;drag-over&#x27;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">uploadArea</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;drop&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">            e.<span class="title function_">preventDefault</span>();</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">uploadArea</span>.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;drag-over&#x27;</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">handleFileDrop</span>(e.<span class="property">dataTransfer</span>.<span class="property">files</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 语音录制</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">startRecordBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">startRecording</span>());</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">stopRecordBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">stopRecording</span>());</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">playRecordBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">playRecording</span>());</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">sendRecordBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">sendVoiceMessage</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 用户设置</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">changeAvatarBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">avatarUpload</span>.<span class="title function_">click</span>());</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">avatarUpload</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;change&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">handleAvatarUpload</span>(e));</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">saveSettingsBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">saveUserSettings</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 消息上下文菜单</span></span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;contextmenu&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">handleContextMenu</span>(e));</span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">hideContextMenu</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 点击表情选择器外部关闭</span></span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!e.<span class="property">target</span>.<span class="title function_">closest</span>(<span class="string">&#x27;.emoji-picker&#x27;</span>) &amp;&amp; </span><br><span class="line">                !e.<span class="property">target</span>.<span class="title function_">closest</span>(<span class="string">&#x27;.fa-smile&#x27;</span>)) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">hideEmojiPicker</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 页面可见性变化（用户切换标签页）</span></span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;visibilitychange&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">hidden</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">setUserStatus</span>(<span class="string">&#x27;AWAY&#x27;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">setUserStatus</span>(<span class="string">&#x27;ONLINE&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 认证检查</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">checkAuthStatus</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> token = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;chat_token&#x27;</span>);</span><br><span class="line">        <span class="keyword">const</span> userData = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;chat_user&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (token &amp;&amp; userData) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">token</span> = token;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">currentUser</span> = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(userData);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 验证token有效性</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;/api/auth/validate&#x27;</span>, &#123;</span><br><span class="line">                    <span class="attr">headers</span>: &#123;</span><br><span class="line">                        <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">`Bearer <span class="subst">$&#123;token&#125;</span>`</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (response.<span class="property">ok</span>) &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">username</span> = <span class="variable language_">this</span>.<span class="property">currentUser</span>.<span class="property">username</span>;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">usernameDisplay</span>.<span class="property">textContent</span> = <span class="variable language_">this</span>.<span class="property">currentUser</span>.<span class="property">nickname</span>;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">updateUserAvatar</span>();</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">connect</span>();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">showLoginModal</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Token验证失败:&#x27;</span>, error);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">showLoginModal</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">showLoginModal</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">showLoginModal</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> modal = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">        modal.<span class="property">className</span> = <span class="string">&#x27;modal-overlay show&#x27;</span>;</span><br><span class="line">        modal.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;modal&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;modal-header&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;h3&gt;&lt;i class=&quot;fas fa-sign-in-alt&quot;&gt;&lt;/i&gt; 登录&lt;/h3&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;modal-body&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;form-group&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;label&gt;用户名或邮箱&lt;/label&gt;</span></span><br><span class="line"><span class="string">                        &lt;input type=&quot;text&quot; id=&quot;loginUsername&quot; placeholder=&quot;请输入用户名或邮箱&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;form-group&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;label&gt;密码&lt;/label&gt;</span></span><br><span class="line"><span class="string">                        &lt;input type=&quot;password&quot; id=&quot;loginPassword&quot; placeholder=&quot;请输入密码&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;form-options&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;label&gt;</span></span><br><span class="line"><span class="string">                            &lt;input type=&quot;checkbox&quot; id=&quot;rememberMe&quot;&gt;</span></span><br><span class="line"><span class="string">                            &lt;span&gt;记住我&lt;/span&gt;</span></span><br><span class="line"><span class="string">                        &lt;/label&gt;</span></span><br><span class="line"><span class="string">                        &lt;a href=&quot;#&quot; class=&quot;forgot-password&quot;&gt;忘记密码?&lt;/a&gt;</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;error-message&quot; id=&quot;loginError&quot;&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;modal-footer&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;button id=&quot;loginBtn&quot; class=&quot;btn-primary&quot;&gt;登录&lt;/button&gt;</span></span><br><span class="line"><span class="string">                    &lt;button id=&quot;registerBtn&quot; class=&quot;btn-secondary&quot;&gt;注册&lt;/button&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        `</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(modal);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 绑定登录事件</span></span><br><span class="line">        modal.<span class="title function_">querySelector</span>(<span class="string">&#x27;#loginBtn&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">handleLogin</span>(modal));</span><br><span class="line">        modal.<span class="title function_">querySelector</span>(<span class="string">&#x27;#registerBtn&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">showRegisterModal</span>(modal));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">handleLogin</span>(<span class="params">modal</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> username = modal.<span class="title function_">querySelector</span>(<span class="string">&#x27;#loginUsername&#x27;</span>).<span class="property">value</span>;</span><br><span class="line">        <span class="keyword">const</span> password = modal.<span class="title function_">querySelector</span>(<span class="string">&#x27;#loginPassword&#x27;</span>).<span class="property">value</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!username || !password) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">showError</span>(<span class="string">&#x27;请输入用户名和密码&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;/api/auth/login&#x27;</span>, &#123;</span><br><span class="line">                <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">                <span class="attr">headers</span>: &#123;</span><br><span class="line">                    <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">                    <span class="attr">usernameOrEmail</span>: username,</span><br><span class="line">                    <span class="attr">password</span>: password</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (response.<span class="property">ok</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">token</span> = data.<span class="property">accessToken</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">currentUser</span> = &#123;</span><br><span class="line">                    <span class="attr">id</span>: data.<span class="property">userId</span>,</span><br><span class="line">                    <span class="attr">username</span>: data.<span class="property">username</span>,</span><br><span class="line">                    <span class="attr">nickname</span>: data.<span class="property">nickname</span>,</span><br><span class="line">                    <span class="attr">email</span>: data.<span class="property">email</span>,</span><br><span class="line">                    <span class="attr">role</span>: data.<span class="property">role</span></span><br><span class="line">                &#125;;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 保存到本地存储</span></span><br><span class="line">                <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;chat_token&#x27;</span>, <span class="variable language_">this</span>.<span class="property">token</span>);</span><br><span class="line">                <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;chat_user&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">currentUser</span>));</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 更新UI</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">username</span> = data.<span class="property">username</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">usernameDisplay</span>.<span class="property">textContent</span> = data.<span class="property">nickname</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">updateUserAvatar</span>();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 移除模态框</span></span><br><span class="line">                modal.<span class="title function_">remove</span>();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 连接到聊天室</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">connect</span>();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">showError</span>(data.<span class="property">message</span> || <span class="string">&#x27;登录失败&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;登录错误:&#x27;</span>, error);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">showError</span>(<span class="string">&#x27;网络错误，请稍后重试&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 表情选择器</span></span><br><span class="line">    <span class="title function_">initEmojiPicker</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> emojiCategories = &#123;</span><br><span class="line">            <span class="attr">smileys</span>: [<span class="string">&#x27;😀&#x27;</span>, <span class="string">&#x27;😃&#x27;</span>, <span class="string">&#x27;😄&#x27;</span>, <span class="string">&#x27;😁&#x27;</span>, <span class="string">&#x27;😆&#x27;</span>, <span class="string">&#x27;😅&#x27;</span>, <span class="string">&#x27;😂&#x27;</span>, <span class="string">&#x27;🤣&#x27;</span>, <span class="string">&#x27;😊&#x27;</span>, <span class="string">&#x27;😇&#x27;</span>, <span class="string">&#x27;🙂&#x27;</span>, <span class="string">&#x27;🙃&#x27;</span>, <span class="string">&#x27;😉&#x27;</span>, <span class="string">&#x27;😌&#x27;</span>, <span class="string">&#x27;😍&#x27;</span>, <span class="string">&#x27;🥰&#x27;</span>, <span class="string">&#x27;😘&#x27;</span>, <span class="string">&#x27;😗&#x27;</span>, <span class="string">&#x27;😙&#x27;</span>, <span class="string">&#x27;😚&#x27;</span>, <span class="string">&#x27;😋&#x27;</span>, <span class="string">&#x27;😛&#x27;</span>, <span class="string">&#x27;😝&#x27;</span>, <span class="string">&#x27;😜&#x27;</span>, <span class="string">&#x27;🤪&#x27;</span>, <span class="string">&#x27;🤨&#x27;</span>, <span class="string">&#x27;🧐&#x27;</span>, <span class="string">&#x27;🤓&#x27;</span>, <span class="string">&#x27;😎&#x27;</span>, <span class="string">&#x27;🤩&#x27;</span>, <span class="string">&#x27;🥳&#x27;</span>, <span class="string">&#x27;😏&#x27;</span>, <span class="string">&#x27;😒&#x27;</span>, <span class="string">&#x27;😞&#x27;</span>, <span class="string">&#x27;😔&#x27;</span>, <span class="string">&#x27;😟&#x27;</span>, <span class="string">&#x27;😕&#x27;</span>, <span class="string">&#x27;🙁&#x27;</span>, <span class="string">&#x27;😣&#x27;</span>, <span class="string">&#x27;😖&#x27;</span>, <span class="string">&#x27;😫&#x27;</span>, <span class="string">&#x27;😩&#x27;</span>, <span class="string">&#x27;🥺&#x27;</span>, <span class="string">&#x27;😢&#x27;</span>, <span class="string">&#x27;😭&#x27;</span>, <span class="string">&#x27;😤&#x27;</span>, <span class="string">&#x27;😠&#x27;</span>, <span class="string">&#x27;😡&#x27;</span>, <span class="string">&#x27;🤬&#x27;</span>, <span class="string">&#x27;🤯&#x27;</span>, <span class="string">&#x27;😳&#x27;</span>, <span class="string">&#x27;🥵&#x27;</span>, <span class="string">&#x27;🥶&#x27;</span>, <span class="string">&#x27;😱&#x27;</span>, <span class="string">&#x27;😨&#x27;</span>, <span class="string">&#x27;😰&#x27;</span>, <span class="string">&#x27;😥&#x27;</span>, <span class="string">&#x27;😓&#x27;</span>, <span class="string">&#x27;🤗&#x27;</span>, <span class="string">&#x27;🤔&#x27;</span>, <span class="string">&#x27;🤭&#x27;</span>, <span class="string">&#x27;🤫&#x27;</span>, <span class="string">&#x27;🤥&#x27;</span>, <span class="string">&#x27;😶&#x27;</span>, <span class="string">&#x27;😐&#x27;</span>, <span class="string">&#x27;😑&#x27;</span>, <span class="string">&#x27;😬&#x27;</span>, <span class="string">&#x27;🙄&#x27;</span>, <span class="string">&#x27;😯&#x27;</span>, <span class="string">&#x27;😦&#x27;</span>, <span class="string">&#x27;😧&#x27;</span>, <span class="string">&#x27;😮&#x27;</span>, <span class="string">&#x27;😲&#x27;</span>, <span class="string">&#x27;🥱&#x27;</span>, <span class="string">&#x27;😴&#x27;</span>, <span class="string">&#x27;🤤&#x27;</span>, <span class="string">&#x27;😪&#x27;</span>, <span class="string">&#x27;😵&#x27;</span>, <span class="string">&#x27;🤐&#x27;</span>, <span class="string">&#x27;🥴&#x27;</span>, <span class="string">&#x27;🤢&#x27;</span>, <span class="string">&#x27;🤮&#x27;</span>, <span class="string">&#x27;🤧&#x27;</span>, <span class="string">&#x27;😷&#x27;</span>, <span class="string">&#x27;🤒&#x27;</span>, <span class="string">&#x27;🤕&#x27;</span>, <span class="string">&#x27;🤑&#x27;</span>, <span class="string">&#x27;🤠&#x27;</span>],</span><br><span class="line">            <span class="attr">animals</span>: [<span class="string">&#x27;🐶&#x27;</span>, <span class="string">&#x27;🐱&#x27;</span>, <span class="string">&#x27;🐭&#x27;</span>, <span class="string">&#x27;🐹&#x27;</span>, <span class="string">&#x27;🐰&#x27;</span>, <span class="string">&#x27;🦊&#x27;</span>, <span class="string">&#x27;🐻&#x27;</span>, <span class="string">&#x27;🐼&#x27;</span>, <span class="string">&#x27;🐨&#x27;</span>, <span class="string">&#x27;🐯&#x27;</span>, <span class="string">&#x27;🦁&#x27;</span>, <span class="string">&#x27;🐮&#x27;</span>, <span class="string">&#x27;🐷&#x27;</span>, <span class="string">&#x27;🐽&#x27;</span>, <span class="string">&#x27;🐸&#x27;</span>, <span class="string">&#x27;🐵&#x27;</span>, <span class="string">&#x27;🙈&#x27;</span>, <span class="string">&#x27;🙉&#x27;</span>, <span class="string">&#x27;🙊&#x27;</span>, <span class="string">&#x27;🐒&#x27;</span>, <span class="string">&#x27;🐔&#x27;</span>, <span class="string">&#x27;🐧&#x27;</span>, <span class="string">&#x27;🐦&#x27;</span>, <span class="string">&#x27;🐤&#x27;</span>, <span class="string">&#x27;🐣&#x27;</span>, <span class="string">&#x27;🐥&#x27;</span>, <span class="string">&#x27;🦆&#x27;</span>, <span class="string">&#x27;🦅&#x27;</span>, <span class="string">&#x27;🦉&#x27;</span>, <span class="string">&#x27;🦇&#x27;</span>, <span class="string">&#x27;🐺&#x27;</span>, <span class="string">&#x27;🐗&#x27;</span>, <span class="string">&#x27;🐴&#x27;</span>, <span class="string">&#x27;🦄&#x27;</span>, <span class="string">&#x27;🐝&#x27;</span>, <span class="string">&#x27;🐛&#x27;</span>, <span class="string">&#x27;🦋&#x27;</span>, <span class="string">&#x27;🐌&#x27;</span>, <span class="string">&#x27;🐞&#x27;</span>, <span class="string">&#x27;🐜&#x27;</span>, <span class="string">&#x27;🦟&#x27;</span>, <span class="string">&#x27;🦗&#x27;</span>, <span class="string">&#x27;🕷&#x27;</span>, <span class="string">&#x27;🦂&#x27;</span>, <span class="string">&#x27;🐢&#x27;</span>, <span class="string">&#x27;🐍&#x27;</span>, <span class="string">&#x27;🦎&#x27;</span>, <span class="string">&#x27;🦖&#x27;</span>, <span class="string">&#x27;🦕&#x27;</span>, <span class="string">&#x27;🐙&#x27;</span>, <span class="string">&#x27;🦑&#x27;</span>, <span class="string">&#x27;🦐&#x27;</span>, <span class="string">&#x27;🦞&#x27;</span>, <span class="string">&#x27;🦀&#x27;</span>, <span class="string">&#x27;🐡&#x27;</span>, <span class="string">&#x27;🐠&#x27;</span>, <span class="string">&#x27;🐟&#x27;</span>, <span class="string">&#x27;🐬&#x27;</span>, <span class="string">&#x27;🐳&#x27;</span>, <span class="string">&#x27;🐋&#x27;</span>, <span class="string">&#x27;🦈&#x27;</span>, <span class="string">&#x27;🐊&#x27;</span>, <span class="string">&#x27;🐅&#x27;</span>, <span class="string">&#x27;🐆&#x27;</span>, <span class="string">&#x27;🦓&#x27;</span>, <span class="string">&#x27;🦍&#x27;</span>, <span class="string">&#x27;🦧&#x27;</span>, <span class="string">&#x27;🐘&#x27;</span>, <span class="string">&#x27;🦛&#x27;</span>, <span class="string">&#x27;🦏&#x27;</span>, <span class="string">&#x27;🐪&#x27;</span>, <span class="string">&#x27;🐫&#x27;</span>, <span class="string">&#x27;🦒&#x27;</span>, <span class="string">&#x27;🦘&#x27;</span>, <span class="string">&#x27;🐃&#x27;</span>, <span class="string">&#x27;🐂&#x27;</span>, <span class="string">&#x27;🐄&#x27;</span>, <span class="string">&#x27;🐎&#x27;</span>, <span class="string">&#x27;🐖&#x27;</span>, <span class="string">&#x27;🐏&#x27;</span>, <span class="string">&#x27;🐑&#x27;</span>, <span class="string">&#x27;🦙&#x27;</span>, <span class="string">&#x27;🐐&#x27;</span>, <span class="string">&#x27;🦌&#x27;</span>, <span class="string">&#x27;🐕&#x27;</span>, <span class="string">&#x27;🐩&#x27;</span>, <span class="string">&#x27;🦮&#x27;</span>, <span class="string">&#x27;🐕‍🦺&#x27;</span>, <span class="string">&#x27;🐈&#x27;</span>, <span class="string">&#x27;🐓&#x27;</span>, <span class="string">&#x27;🦃&#x27;</span>, <span class="string">&#x27;🦚&#x27;</span>, <span class="string">&#x27;🦜&#x27;</span>, <span class="string">&#x27;🦢&#x27;</span>, <span class="string">&#x27;🦩&#x27;</span>, <span class="string">&#x27;🐇&#x27;</span>, <span class="string">&#x27;🦝&#x27;</span>, <span class="string">&#x27;🦨&#x27;</span>, <span class="string">&#x27;🦡&#x27;</span>, <span class="string">&#x27;🦦&#x27;</span>, <span class="string">&#x27;🦥&#x27;</span>, <span class="string">&#x27;🐁&#x27;</span>, <span class="string">&#x27;🐀&#x27;</span>, <span class="string">&#x27;🐿&#x27;</span>, <span class="string">&#x27;🦔&#x27;</span>],</span><br><span class="line">            <span class="attr">food</span>: [<span class="string">&#x27;🍏&#x27;</span>, <span class="string">&#x27;🍎&#x27;</span>, <span class="string">&#x27;🍐&#x27;</span>, <span class="string">&#x27;🍊&#x27;</span>, <span class="string">&#x27;🍋&#x27;</span>, <span class="string">&#x27;🍌&#x27;</span>, <span class="string">&#x27;🍉&#x27;</span>, <span class="string">&#x27;🍇&#x27;</span>, <span class="string">&#x27;🍓&#x27;</span>, <span class="string">&#x27;🫐&#x27;</span>, <span class="string">&#x27;🍈&#x27;</span>, <span class="string">&#x27;🍒&#x27;</span>, <span class="string">&#x27;🍑&#x27;</span>, <span class="string">&#x27;🥭&#x27;</span>, <span class="string">&#x27;🍍&#x27;</span>, <span class="string">&#x27;🥥&#x27;</span>, <span class="string">&#x27;🥝&#x27;</span>, <span class="string">&#x27;🍅&#x27;</span>, <span class="string">&#x27;🍆&#x27;</span>, <span class="string">&#x27;🥑&#x27;</span>, <span class="string">&#x27;🥦&#x27;</span>, <span class="string">&#x27;🥬&#x27;</span>, <span class="string">&#x27;🥒&#x27;</span>, <span class="string">&#x27;🌶&#x27;</span>, <span class="string">&#x27;🫑&#x27;</span>, <span class="string">&#x27;🌽&#x27;</span>, <span class="string">&#x27;🥕&#x27;</span>, <span class="string">&#x27;🫒&#x27;</span>, <span class="string">&#x27;🧄&#x27;</span>, <span class="string">&#x27;🧅&#x27;</span>, <span class="string">&#x27;🥔&#x27;</span>, <span class="string">&#x27;🍠&#x27;</span>, <span class="string">&#x27;🥐&#x27;</span>, <span class="string">&#x27;🥯&#x27;</span>, <span class="string">&#x27;🍞&#x27;</span>, <span class="string">&#x27;🥖&#x27;</span>, <span class="string">&#x27;🥨&#x27;</span>, <span class="string">&#x27;🧀&#x27;</span>, <span class="string">&#x27;🥚&#x27;</span>, <span class="string">&#x27;🍳&#x27;</span>, <span class="string">&#x27;🧈&#x27;</span>, <span class="string">&#x27;🥞&#x27;</span>, <span class="string">&#x27;🧇&#x27;</span>, <span class="string">&#x27;🥓&#x27;</span>, <span class="string">&#x27;🥩&#x27;</span>, <span class="string">&#x27;🍗&#x27;</span>, <span class="string">&#x27;🍖&#x27;</span>, <span class="string">&#x27;🦴&#x27;</span>, <span class="string">&#x27;🌭&#x27;</span>, <span class="string">&#x27;🍔&#x27;</span>, <span class="string">&#x27;🍟&#x27;</span>, <span class="string">&#x27;🍕&#x27;</span>, <span class="string">&#x27;🫓&#x27;</span>, <span class="string">&#x27;🥪&#x27;</span>, <span class="string">&#x27;🥙&#x27;</span>, <span class="string">&#x27;🧆&#x27;</span>, <span class="string">&#x27;🌮&#x27;</span>, <span class="string">&#x27;🌯&#x27;</span>, <span class="string">&#x27;🫔&#x27;</span>, <span class="string">&#x27;🥗&#x27;</span>, <span class="string">&#x27;🥘&#x27;</span>, <span class="string">&#x27;🫕&#x27;</span>, <span class="string">&#x27;🥫&#x27;</span>, <span class="string">&#x27;🍝&#x27;</span>, <span class="string">&#x27;🍜&#x27;</span>, <span class="string">&#x27;🍲&#x27;</span>, <span class="string">&#x27;🍛&#x27;</span>, <span class="string">&#x27;🍣&#x27;</span>, <span class="string">&#x27;🍱&#x27;</span>, <span class="string">&#x27;🥟&#x27;</span>, <span class="string">&#x27;🦪&#x27;</span>, <span class="string">&#x27;🍤&#x27;</span>, <span class="string">&#x27;🍙&#x27;</span>, <span class="string">&#x27;🍚&#x27;</span>, <span class="string">&#x27;🍘&#x27;</span>, <span class="string">&#x27;🍥&#x27;</span>, <span class="string">&#x27;🥠&#x27;</span>, <span class="string">&#x27;🥮&#x27;</span>, <span class="string">&#x27;🍢&#x27;</span>, <span class="string">&#x27;🍡&#x27;</span>, <span class="string">&#x27;🍧&#x27;</span>, <span class="string">&#x27;🍨&#x27;</span>, <span class="string">&#x27;🍦&#x27;</span>, <span class="string">&#x27;🥧&#x27;</span>, <span class="string">&#x27;🧁&#x27;</span>, <span class="string">&#x27;🍰&#x27;</span>, <span class="string">&#x27;🎂&#x27;</span>, <span class="string">&#x27;🍮&#x27;</span>, <span class="string">&#x27;🍭&#x27;</span>, <span class="string">&#x27;🍬&#x27;</span>, <span class="string">&#x27;🍫&#x27;</span>, <span class="string">&#x27;🍿&#x27;</span>, <span class="string">&#x27;🧈&#x27;</span>, <span class="string">&#x27;🍩&#x27;</span>, <span class="string">&#x27;🍪&#x27;</span>, <span class="string">&#x27;🌰&#x27;</span>, <span class="string">&#x27;🥜&#x27;</span>, <span class="string">&#x27;🍯&#x27;</span>],</span><br><span class="line">            <span class="attr">travel</span>: [<span class="string">&#x27;🚗&#x27;</span>, <span class="string">&#x27;🚕&#x27;</span>, <span class="string">&#x27;🚙&#x27;</span>, <span class="string">&#x27;🚌&#x27;</span>, <span class="string">&#x27;🚎&#x27;</span>, <span class="string">&#x27;🏎&#x27;</span>, <span class="string">&#x27;🚓&#x27;</span>, <span class="string">&#x27;🚑&#x27;</span>, <span class="string">&#x27;🚒&#x27;</span>, <span class="string">&#x27;🚐&#x27;</span>, <span class="string">&#x27;🛻&#x27;</span>, <span class="string">&#x27;🚚&#x27;</span>, <span class="string">&#x27;🚛&#x27;</span>, <span class="string">&#x27;🚜&#x27;</span>, <span class="string">&#x27;🦯&#x27;</span>, <span class="string">&#x27;🦽&#x27;</span>, <span class="string">&#x27;🦼&#x27;</span>, <span class="string">&#x27;🛴&#x27;</span>, <span class="string">&#x27;🚲&#x27;</span>, <span class="string">&#x27;🛵&#x27;</span>, <span class="string">&#x27;🏍&#x27;</span>, <span class="string">&#x27;🛺&#x27;</span>, <span class="string">&#x27;🚨&#x27;</span>, <span class="string">&#x27;🚔&#x27;</span>, <span class="string">&#x27;🚍&#x27;</span>, <span class="string">&#x27;🚘&#x27;</span>, <span class="string">&#x27;🚖&#x27;</span>, <span class="string">&#x27;🚡&#x27;</span>, <span class="string">&#x27;🚠&#x27;</span>, <span class="string">&#x27;🚟&#x27;</span>, <span class="string">&#x27;🚃&#x27;</span>, <span class="string">&#x27;🚋&#x27;</span>, <span class="string">&#x27;🚞&#x27;</span>, <span class="string">&#x27;🚝&#x27;</span>, <span class="string">&#x27;🚄&#x27;</span>, <span class="string">&#x27;🚅&#x27;</span>, <span class="string">&#x27;🚈&#x27;</span>, <span class="string">&#x27;🚂&#x27;</span>, <span class="string">&#x27;🚆&#x27;</span>, <span class="string">&#x27;🚇&#x27;</span>, <span class="string">&#x27;🚊&#x27;</span>, <span class="string">&#x27;🚉&#x27;</span>, <span class="string">&#x27;✈️&#x27;</span>, <span class="string">&#x27;🛫&#x27;</span>, <span class="string">&#x27;🛬&#x27;</span>, <span class="string">&#x27;🛩&#x27;</span>, <span class="string">&#x27;💺&#x27;</span>, <span class="string">&#x27;🛰&#x27;</span>, <span class="string">&#x27;🚀&#x27;</span>, <span class="string">&#x27;🛸&#x27;</span>, <span class="string">&#x27;🚁&#x27;</span>, <span class="string">&#x27;🛶&#x27;</span>, <span class="string">&#x27;⛵️&#x27;</span>, <span class="string">&#x27;🚤&#x27;</span>, <span class="string">&#x27;🛥&#x27;</span>, <span class="string">&#x27;🛳&#x27;</span>, <span class="string">&#x27;⛴&#x27;</span>, <span class="string">&#x27;🚢&#x27;</span>, <span class="string">&#x27;⚓️&#x27;</span>, <span class="string">&#x27;⛽️&#x27;</span>, <span class="string">&#x27;🚧&#x27;</span>, <span class="string">&#x27;🚦&#x27;</span>, <span class="string">&#x27;🚥&#x27;</span>, <span class="string">&#x27;🚏&#x27;</span>, <span class="string">&#x27;🗺&#x27;</span>, <span class="string">&#x27;🗿&#x27;</span>, <span class="string">&#x27;🗽&#x27;</span>, <span class="string">&#x27;🗼&#x27;</span>, <span class="string">&#x27;🏰&#x27;</span>, <span class="string">&#x27;🏯&#x27;</span>, <span class="string">&#x27;🏟&#x27;</span>, <span class="string">&#x27;🎡&#x27;</span>, <span class="string">&#x27;🎢&#x27;</span>, <span class="string">&#x27;🎠&#x27;</span>, <span class="string">&#x27;⛲️&#x27;</span>, <span class="string">&#x27;⛱&#x27;</span>, <span class="string">&#x27;🏖&#x27;</span>, <span class="string">&#x27;🏝&#x27;</span>, <span class="string">&#x27;🏜&#x27;</span>, <span class="string">&#x27;🌋&#x27;</span>, <span class="string">&#x27;⛰&#x27;</span>, <span class="string">&#x27;🏔&#x27;</span>, <span class="string">&#x27;🗻&#x27;</span>, <span class="string">&#x27;🏕&#x27;</span>, <span class="string">&#x27;⛺️&#x27;</span>, <span class="string">&#x27;🛖&#x27;</span>, <span class="string">&#x27;🏠&#x27;</span>, <span class="string">&#x27;🏡&#x27;</span>, <span class="string">&#x27;🏘&#x27;</span>, <span class="string">&#x27;🏚&#x27;</span>, <span class="string">&#x27;🏗&#x27;</span>, <span class="string">&#x27;🏭&#x27;</span>, <span class="string">&#x27;🏢&#x27;</span>, <span class="string">&#x27;🏬&#x27;</span>, <span class="string">&#x27;🏣&#x27;</span>, <span class="string">&#x27;🏤&#x27;</span>, <span class="string">&#x27;🏥&#x27;</span>, <span class="string">&#x27;🏦&#x27;</span>, <span class="string">&#x27;🏨&#x27;</span>, <span class="string">&#x27;🏪&#x27;</span>, <span class="string">&#x27;🏫&#x27;</span>, <span class="string">&#x27;🏩&#x27;</span>, <span class="string">&#x27;💒&#x27;</span>, <span class="string">&#x27;🏛&#x27;</span>, <span class="string">&#x27;⛪️&#x27;</span>, <span class="string">&#x27;🕌&#x27;</span>, <span class="string">&#x27;🛕&#x27;</span>, <span class="string">&#x27;🕍&#x27;</span>, <span class="string">&#x27;⛩&#x27;</span>, <span class="string">&#x27;🕋&#x27;</span>, <span class="string">&#x27;⛺️&#x27;</span>],</span><br><span class="line">            <span class="attr">objects</span>: [<span class="string">&#x27;⌚️&#x27;</span>, <span class="string">&#x27;📱&#x27;</span>, <span class="string">&#x27;📲&#x27;</span>, <span class="string">&#x27;💻&#x27;</span>, <span class="string">&#x27;⌨️&#x27;</span>, <span class="string">&#x27;🖥&#x27;</span>, <span class="string">&#x27;🖨&#x27;</span>, <span class="string">&#x27;🖱&#x27;</span>, <span class="string">&#x27;🖲&#x27;</span>, <span class="string">&#x27;🕹&#x27;</span>, <span class="string">&#x27;🗜&#x27;</span>, <span class="string">&#x27;💽&#x27;</span>, <span class="string">&#x27;💾&#x27;</span>, <span class="string">&#x27;💿&#x27;</span>, <span class="string">&#x27;📀&#x27;</span>, <span class="string">&#x27;📼&#x27;</span>, <span class="string">&#x27;📷&#x27;</span>, <span class="string">&#x27;📸&#x27;</span>, <span class="string">&#x27;📹&#x27;</span>, <span class="string">&#x27;🎥&#x27;</span>, <span class="string">&#x27;📽&#x27;</span>, <span class="string">&#x27;🎞&#x27;</span>, <span class="string">&#x27;📞&#x27;</span>, <span class="string">&#x27;☎️&#x27;</span>, <span class="string">&#x27;📟&#x27;</span>, <span class="string">&#x27;📠&#x27;</span>, <span class="string">&#x27;📺&#x27;</span>, <span class="string">&#x27;📻&#x27;</span>, <span class="string">&#x27;🎙&#x27;</span>, <span class="string">&#x27;🎚&#x27;</span>, <span class="string">&#x27;🎛&#x27;</span>, <span class="string">&#x27;🧭&#x27;</span>, <span class="string">&#x27;⏱&#x27;</span>, <span class="string">&#x27;⏲&#x27;</span>, <span class="string">&#x27;⏰&#x27;</span>, <span class="string">&#x27;🕰&#x27;</span>, <span class="string">&#x27;⌛️&#x27;</span>, <span class="string">&#x27;⏳&#x27;</span>, <span class="string">&#x27;📡&#x27;</span>, <span class="string">&#x27;🔋&#x27;</span>, <span class="string">&#x27;🔌&#x27;</span>, <span class="string">&#x27;💡&#x27;</span>, <span class="string">&#x27;🔦&#x27;</span>, <span class="string">&#x27;🕯&#x27;</span>, <span class="string">&#x27;🪔&#x27;</span>, <span class="string">&#x27;🧯&#x27;</span>, <span class="string">&#x27;🛢&#x27;</span>, <span class="string">&#x27;💸&#x27;</span>, <span class="string">&#x27;💵&#x27;</span>, <span class="string">&#x27;💴&#x27;</span>, <span class="string">&#x27;💶&#x27;</span>, <span class="string">&#x27;💷&#x27;</span>, <span class="string">&#x27;💰&#x27;</span>, <span class="string">&#x27;💳&#x27;</span>, <span class="string">&#x27;💎&#x27;</span>, <span class="string">&#x27;⚖️&#x27;</span>, <span class="string">&#x27;🧰&#x27;</span>, <span class="string">&#x27;🔧&#x27;</span>, <span class="string">&#x27;🔨&#x27;</span>, <span class="string">&#x27;⚒&#x27;</span>, <span class="string">&#x27;🛠&#x27;</span>, <span class="string">&#x27;⛏&#x27;</span>, <span class="string">&#x27;🔩&#x27;</span>, <span class="string">&#x27;⚙️&#x27;</span>, <span class="string">&#x27;🧱&#x27;</span>, <span class="string">&#x27;⛓&#x27;</span>, <span class="string">&#x27;🧲&#x27;</span>, <span class="string">&#x27;🔫&#x27;</span>, <span class="string">&#x27;💣&#x27;</span>, <span class="string">&#x27;🧨&#x27;</span>, <span class="string">&#x27;🪓&#x27;</span>, <span class="string">&#x27;🔪&#x27;</span>, <span class="string">&#x27;🗡&#x27;</span>, <span class="string">&#x27;⚔️&#x27;</span>, <span class="string">&#x27;🛡&#x27;</span>, <span class="string">&#x27;🚬&#x27;</span>, <span class="string">&#x27;⚰️&#x27;</span>, <span class="string">&#x27;⚱️&#x27;</span>, <span class="string">&#x27;🏺&#x27;</span>, <span class="string">&#x27;🔮&#x27;</span>, <span class="string">&#x27;📿&#x27;</span>, <span class="string">&#x27;🧿&#x27;</span>, <span class="string">&#x27;💈&#x27;</span>, <span class="string">&#x27;⚗️&#x27;</span>, <span class="string">&#x27;🔭&#x27;</span>, <span class="string">&#x27;🔬&#x27;</span>, <span class="string">&#x27;🕳&#x27;</span>, <span class="string">&#x27;💊&#x27;</span>, <span class="string">&#x27;💉&#x27;</span>, <span class="string">&#x27;🩸&#x27;</span>, <span class="string">&#x27;🧬&#x27;</span>, <span class="string">&#x27;🦠&#x27;</span>, <span class="string">&#x27;🧫&#x27;</span>, <span class="string">&#x27;🧪&#x27;</span>, <span class="string">&#x27;🌡&#x27;</span>, <span class="string">&#x27;🧹&#x27;</span>, <span class="string">&#x27;🧺&#x27;</span>, <span class="string">&#x27;🧻&#x27;</span>, <span class="string">&#x27;🚽&#x27;</span>, <span class="string">&#x27;🚰&#x27;</span>, <span class="string">&#x27;🚿&#x27;</span>, <span class="string">&#x27;🛁&#x27;</span>, <span class="string">&#x27;🛀&#x27;</span>, <span class="string">&#x27;🧼&#x27;</span>, <span class="string">&#x27;🪒&#x27;</span>, <span class="string">&#x27;🧽&#x27;</span>, <span class="string">&#x27;🧴&#x27;</span>, <span class="string">&#x27;🛎&#x27;</span>, <span class="string">&#x27;🔑&#x27;</span>, <span class="string">&#x27;🗝&#x27;</span>, <span class="string">&#x27;🚪&#x27;</span>, <span class="string">&#x27;🪑&#x27;</span>, <span class="string">&#x27;🛋&#x27;</span>, <span class="string">&#x27;🛏&#x27;</span>, <span class="string">&#x27;🧸&#x27;</span>, <span class="string">&#x27;🛍&#x27;</span>, <span class="string">&#x27;🛒&#x27;</span>, <span class="string">&#x27;🎁&#x27;</span>, <span class="string">&#x27;🎈&#x27;</span>, <span class="string">&#x27;🎏&#x27;</span>, <span class="string">&#x27;🎀&#x27;</span>, <span class="string">&#x27;🎊&#x27;</span>, <span class="string">&#x27;🎉&#x27;</span>, <span class="string">&#x27;🎎&#x27;</span>, <span class="string">&#x27;🏮&#x27;</span>, <span class="string">&#x27;🎐&#x27;</span>, <span class="string">&#x27;🧧&#x27;</span>, <span class="string">&#x27;✉️&#x27;</span>, <span class="string">&#x27;📩&#x27;</span>, <span class="string">&#x27;📨&#x27;</span>, <span class="string">&#x27;📧&#x27;</span>, <span class="string">&#x27;💌&#x27;</span>, <span class="string">&#x27;📥&#x27;</span>, <span class="string">&#x27;📤&#x27;</span>, <span class="string">&#x27;📦&#x27;</span>, <span class="string">&#x27;🏷&#x27;</span>, <span class="string">&#x27;📪&#x27;</span>, <span class="string">&#x27;📫&#x27;</span>, <span class="string">&#x27;📬&#x27;</span>, <span class="string">&#x27;📭&#x27;</span>, <span class="string">&#x27;📮&#x27;</span>, <span class="string">&#x27;📯&#x27;</span>, <span class="string">&#x27;📜&#x27;</span>, <span class="string">&#x27;📃&#x27;</span>, <span class="string">&#x27;📄&#x27;</span>, <span class="string">&#x27;📑&#x27;</span>, <span class="string">&#x27;🧾&#x27;</span>, <span class="string">&#x27;📊&#x27;</span>, <span class="string">&#x27;📈&#x27;</span>, <span class="string">&#x27;📉&#x27;</span>, <span class="string">&#x27;🗒&#x27;</span>, <span class="string">&#x27;🗓&#x27;</span>, <span class="string">&#x27;📆&#x27;</span>, <span class="string">&#x27;📅&#x27;</span>, <span class="string">&#x27;🗑&#x27;</span>, <span class="string">&#x27;📇&#x27;</span>, <span class="string">&#x27;🗃&#x27;</span>, <span class="string">&#x27;🗳&#x27;</span>, <span class="string">&#x27;🗄&#x27;</span>, <span class="string">&#x27;📋&#x27;</span>, <span class="string">&#x27;📁&#x27;</span>, <span class="string">&#x27;📂&#x27;</span>, <span class="string">&#x27;🗂&#x27;</span>, <span class="string">&#x27;🗞&#x27;</span>, <span class="string">&#x27;📰&#x27;</span>, <span class="string">&#x27;📓&#x27;</span>, <span class="string">&#x27;📔&#x27;</span>, <span class="string">&#x27;📒&#x27;</span>, <span class="string">&#x27;📕&#x27;</span>, <span class="string">&#x27;📗&#x27;</span>, <span class="string">&#x27;📘&#x27;</span>, <span class="string">&#x27;📙&#x27;</span>, <span class="string">&#x27;📚&#x27;</span>, <span class="string">&#x27;📖&#x27;</span>, <span class="string">&#x27;🔖&#x27;</span>, <span class="string">&#x27;🧷&#x27;</span>, <span class="string">&#x27;🔗&#x27;</span>, <span class="string">&#x27;📎&#x27;</span>, <span class="string">&#x27;🖇&#x27;</span>, <span class="string">&#x27;📐&#x27;</span>, <span class="string">&#x27;📏&#x27;</span>, <span class="string">&#x27;🧮&#x27;</span>, <span class="string">&#x27;📌&#x27;</span>, <span class="string">&#x27;📍&#x27;</span>, <span class="string">&#x27;✂️&#x27;</span>, <span class="string">&#x27;🖊&#x27;</span>, <span class="string">&#x27;🖋&#x27;</span>, <span class="string">&#x27;✒️&#x27;</span>, <span class="string">&#x27;🖌&#x27;</span>, <span class="string">&#x27;🖍&#x27;</span>, <span class="string">&#x27;📝&#x27;</span>, <span class="string">&#x27;✏️&#x27;</span>, <span class="string">&#x27;🔍&#x27;</span>, <span class="string">&#x27;🔎&#x27;</span>, <span class="string">&#x27;🔏&#x27;</span>, <span class="string">&#x27;🔐&#x27;</span>, <span class="string">&#x27;🔒&#x27;</span>, <span class="string">&#x27;🔓&#x27;</span>]</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">emojiCategories</span> = emojiCategories;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">renderEmojiCategory</span>(<span class="string">&#x27;smileys&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">renderEmojiCategory</span>(<span class="params">category</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">emojiGrid</span>.<span class="property">innerHTML</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> emojis = <span class="variable language_">this</span>.<span class="property">emojiCategories</span>[category] || [];</span><br><span class="line">        emojis.<span class="title function_">forEach</span>(<span class="function"><span class="params">emoji</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> emojiElement = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">            emojiElement.<span class="property">className</span> = <span class="string">&#x27;emoji-item&#x27;</span>;</span><br><span class="line">            emojiElement.<span class="property">textContent</span> = emoji;</span><br><span class="line">            emojiElement.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">insertEmoji</span>(emoji));</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">emojiGrid</span>.<span class="title function_">appendChild</span>(emojiElement);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">switchEmojiCategory</span>(<span class="params">button</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">emojiCategoryBtns</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">btn</span> =&gt;</span> btn.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;active&#x27;</span>));</span><br><span class="line">        button.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;active&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> category = button.<span class="property">dataset</span>.<span class="property">category</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">renderEmojiCategory</span>(category);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">searchEmojis</span>(<span class="params">query</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> allEmojis = <span class="title class_">Object</span>.<span class="title function_">values</span>(<span class="variable language_">this</span>.<span class="property">emojiCategories</span>).<span class="title function_">flat</span>();</span><br><span class="line">        <span class="keyword">const</span> filteredEmojis = allEmojis.<span class="title function_">filter</span>(<span class="function"><span class="params">emoji</span> =&gt;</span> </span><br><span class="line">            emoji.<span class="title function_">includes</span>(query) || </span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">getEmojiDescription</span>(emoji).<span class="title function_">toLowerCase</span>().<span class="title function_">includes</span>(query.<span class="title function_">toLowerCase</span>())</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">emojiGrid</span>.<span class="property">innerHTML</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        filteredEmojis.<span class="title function_">forEach</span>(<span class="function"><span class="params">emoji</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> emojiElement = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">            emojiElement.<span class="property">className</span> = <span class="string">&#x27;emoji-item&#x27;</span>;</span><br><span class="line">            emojiElement.<span class="property">textContent</span> = emoji;</span><br><span class="line">            emojiElement.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">insertEmoji</span>(emoji));</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">emojiGrid</span>.<span class="title function_">appendChild</span>(emojiElement);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">getEmojiDescription</span>(<span class="params">emoji</span>) &#123;</span><br><span class="line">        <span class="comment">// 这里可以添加表情描述</span></span><br><span class="line">        <span class="keyword">const</span> descriptions = &#123;</span><br><span class="line">            <span class="string">&#x27;😀&#x27;</span>: <span class="string">&#x27;笑脸&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;❤️&#x27;</span>: <span class="string">&#x27;红心&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;👍&#x27;</span>: <span class="string">&#x27;大拇指&#x27;</span>,</span><br><span class="line">            <span class="comment">// 更多表情描述...</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> descriptions[emoji] || <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">toggleEmojiPicker</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">emojiPicker</span>.<span class="property">classList</span>.<span class="title function_">toggle</span>(<span class="string">&#x27;show&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">emojiPicker</span>.<span class="property">classList</span>.<span class="title function_">contains</span>(<span class="string">&#x27;show&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">emojiSearch</span>.<span class="title function_">focus</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">hideEmojiPicker</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">emojiPicker</span>.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;show&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">insertEmoji</span>(<span class="params">emoji</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> input = <span class="variable language_">this</span>.<span class="property">messageInput</span>;</span><br><span class="line">        <span class="keyword">const</span> start = input.<span class="property">selectionStart</span>;</span><br><span class="line">        <span class="keyword">const</span> end = input.<span class="property">selectionEnd</span>;</span><br><span class="line">        <span class="keyword">const</span> text = input.<span class="property">value</span>;</span><br><span class="line">        </span><br><span class="line">        input.<span class="property">value</span> = text.<span class="title function_">substring</span>(<span class="number">0</span>, start) + emoji + text.<span class="title function_">substring</span>(end);</span><br><span class="line">        input.<span class="title function_">focus</span>();</span><br><span class="line">        input.<span class="property">selectionStart</span> = input.<span class="property">selectionEnd</span> = start + emoji.<span class="property">length</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 触发输入事件</span></span><br><span class="line">        input.<span class="title function_">dispatchEvent</span>(<span class="keyword">new</span> <span class="title class_">Event</span>(<span class="string">&#x27;input&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 文件上传功能</span></span><br><span class="line">    <span class="title function_">showFileUploadModal</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">fileUploadModal</span>.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;show&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">uploadPreview</span>.<span class="property">innerHTML</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">uploadQueue</span> = [];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">handleFileSelection</span>(<span class="params">event</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> files = <span class="title class_">Array</span>.<span class="title function_">from</span>(event.<span class="property">target</span>.<span class="property">files</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">addFilesToQueue</span>(files);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">handleFileDrop</span>(<span class="params">files</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">addFilesToQueue</span>(<span class="title class_">Array</span>.<span class="title function_">from</span>(files));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">addFilesToQueue</span>(<span class="params">files</span>) &#123;</span><br><span class="line">        files.<span class="title function_">forEach</span>(<span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (file.<span class="property">size</span> &gt; <span class="number">50</span> * <span class="number">1024</span> * <span class="number">1024</span>) &#123; <span class="comment">// 50MB限制</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">showNotification</span>(<span class="string">`文件 <span class="subst">$&#123;file.name&#125;</span> 超过大小限制`</span>, <span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">const</span> fileType = <span class="variable language_">this</span>.<span class="title function_">getFileType</span>(file);</span><br><span class="line">            <span class="keyword">const</span> fileItem = &#123;</span><br><span class="line">                <span class="attr">id</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>() + <span class="title class_">Math</span>.<span class="title function_">random</span>(),</span><br><span class="line">                <span class="attr">file</span>: file,</span><br><span class="line">                <span class="attr">type</span>: fileType,</span><br><span class="line">                <span class="attr">progress</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">status</span>: <span class="string">&#x27;pending&#x27;</span></span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">uploadQueue</span>.<span class="title function_">push</span>(fileItem);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">renderFilePreview</span>(fileItem);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">sendFilesBtn</span>.<span class="property">disabled</span> = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">getFileType</span>(<span class="params">file</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (file.<span class="property">type</span>.<span class="title function_">startsWith</span>(<span class="string">&#x27;image/&#x27;</span>)) <span class="keyword">return</span> <span class="string">&#x27;image&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (file.<span class="property">type</span>.<span class="title function_">startsWith</span>(<span class="string">&#x27;audio/&#x27;</span>)) <span class="keyword">return</span> <span class="string">&#x27;voice&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (file.<span class="property">type</span> === <span class="string">&#x27;application/pdf&#x27;</span>) <span class="keyword">return</span> <span class="string">&#x27;pdf&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (file.<span class="property">type</span>.<span class="title function_">includes</span>(<span class="string">&#x27;word&#x27;</span>)) <span class="keyword">return</span> <span class="string">&#x27;word&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (file.<span class="property">type</span>.<span class="title function_">includes</span>(<span class="string">&#x27;excel&#x27;</span>) || file.<span class="property">type</span>.<span class="title function_">includes</span>(<span class="string">&#x27;sheet&#x27;</span>)) <span class="keyword">return</span> <span class="string">&#x27;excel&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (file.<span class="property">type</span>.<span class="title function_">includes</span>(<span class="string">&#x27;zip&#x27;</span>) || file.<span class="property">type</span>.<span class="title function_">includes</span>(<span class="string">&#x27;compressed&#x27;</span>)) <span class="keyword">return</span> <span class="string">&#x27;zip&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;file&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">renderFilePreview</span>(<span class="params">fileItem</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> preview = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">        preview.<span class="property">className</span> = <span class="string">&#x27;progress-item&#x27;</span>;</span><br><span class="line">        preview.<span class="property">id</span> = <span class="string">`file-<span class="subst">$&#123;fileItem.id&#125;</span>`</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> fileIcon = <span class="variable language_">this</span>.<span class="title function_">getFileIcon</span>(fileItem.<span class="property">type</span>);</span><br><span class="line">        </span><br><span class="line">        preview.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;progress-icon <span class="subst">$&#123;fileItem.type&#125;</span>&quot;&gt;</span></span><br><span class="line"><span class="string">                <span class="subst">$&#123;fileIcon&#125;</span></span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;progress-info&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;progress-name&quot;&gt;<span class="subst">$&#123;fileItem.file.name&#125;</span>&lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;progress-bar&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;progress-filled&quot; style=&quot;width: <span class="subst">$&#123;fileItem.progress&#125;</span>%&quot;&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;progress-status&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;span class=&quot;progress-percent&quot;&gt;<span class="subst">$&#123;fileItem.progress&#125;</span>%&lt;/span&gt;</span></span><br><span class="line"><span class="string">                    &lt;span class=&quot;progress-size&quot;&gt;<span class="subst">$&#123;<span class="variable language_">this</span>.formatFileSize(fileItem.file.size)&#125;</span>&lt;/span&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;button class=&quot;remove-file&quot; data-id=&quot;<span class="subst">$&#123;fileItem.id&#125;</span>&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;i class=&quot;fas fa-times&quot;&gt;&lt;/i&gt;</span></span><br><span class="line"><span class="string">            &lt;/button&gt;</span></span><br><span class="line"><span class="string">        `</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">uploadPreview</span>.<span class="title function_">appendChild</span>(preview);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 添加删除按钮事件</span></span><br><span class="line">        preview.<span class="title function_">querySelector</span>(<span class="string">&#x27;.remove-file&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">            e.<span class="title function_">stopPropagation</span>();</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">removeFileFromQueue</span>(fileItem.<span class="property">id</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">getFileIcon</span>(<span class="params">type</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> icons = &#123;</span><br><span class="line">            <span class="attr">image</span>: <span class="string">&#x27;&lt;i class=&quot;fas fa-image&quot;&gt;&lt;/i&gt;&#x27;</span>,</span><br><span class="line">            <span class="attr">voice</span>: <span class="string">&#x27;&lt;i class=&quot;fas fa-microphone-alt&quot;&gt;&lt;/i&gt;&#x27;</span>,</span><br><span class="line">            <span class="attr">pdf</span>: <span class="string">&#x27;&lt;i class=&quot;fas fa-file-pdf&quot;&gt;&lt;/i&gt;&#x27;</span>,</span><br><span class="line">            <span class="attr">word</span>: <span class="string">&#x27;&lt;i class=&quot;fas fa-file-word&quot;&gt;&lt;/i&gt;&#x27;</span>,</span><br><span class="line">            <span class="attr">excel</span>: <span class="string">&#x27;&lt;i class=&quot;fas fa-file-excel&quot;&gt;&lt;/i&gt;&#x27;</span>,</span><br><span class="line">            <span class="attr">zip</span>: <span class="string">&#x27;&lt;i class=&quot;fas fa-file-archive&quot;&gt;&lt;/i&gt;&#x27;</span>,</span><br><span class="line">            <span class="attr">file</span>: <span class="string">&#x27;&lt;i class=&quot;fas fa-file&quot;&gt;&lt;/i&gt;&#x27;</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> icons[type] || icons.<span class="property">file</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">formatFileSize</span>(<span class="params">bytes</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (bytes === <span class="number">0</span>) <span class="keyword">return</span> <span class="string">&#x27;0 Bytes&#x27;</span>;</span><br><span class="line">        <span class="keyword">const</span> k = <span class="number">1024</span>;</span><br><span class="line">        <span class="keyword">const</span> sizes = [<span class="string">&#x27;Bytes&#x27;</span>, <span class="string">&#x27;KB&#x27;</span>, <span class="string">&#x27;MB&#x27;</span>, <span class="string">&#x27;GB&#x27;</span>];</span><br><span class="line">        <span class="keyword">const</span> i = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">log</span>(bytes) / <span class="title class_">Math</span>.<span class="title function_">log</span>(k));</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">parseFloat</span>((bytes / <span class="title class_">Math</span>.<span class="title function_">pow</span>(k, i)).<span class="title function_">toFixed</span>(<span class="number">2</span>)) + <span class="string">&#x27; &#x27;</span> + sizes[i];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">sendFiles</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">uploadQueue</span>.<span class="property">length</span> === <span class="number">0</span> || <span class="variable language_">this</span>.<span class="property">uploading</span>) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">uploading</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">sendFilesBtn</span>.<span class="property">disabled</span> = <span class="literal">true</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> fileItem <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">uploadQueue</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (fileItem.<span class="property">status</span> === <span class="string">&#x27;pending&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">uploadFile</span>(fileItem);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">uploading</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">fileUploadModal</span>.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;show&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">uploadFile</span>(<span class="params">fileItem</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> formData = <span class="keyword">new</span> <span class="title class_">FormData</span>();</span><br><span class="line">        formData.<span class="title function_">append</span>(<span class="string">&#x27;file&#x27;</span>, fileItem.<span class="property">file</span>);</span><br><span class="line">        formData.<span class="title function_">append</span>(<span class="string">&#x27;type&#x27;</span>, fileItem.<span class="property">type</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">            </span><br><span class="line">            xhr.<span class="property">upload</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;progress&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (event.<span class="property">lengthComputable</span>) &#123;</span><br><span class="line">                    <span class="keyword">const</span> progress = <span class="title class_">Math</span>.<span class="title function_">round</span>((event.<span class="property">loaded</span> * <span class="number">100</span>) / event.<span class="property">total</span>);</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">updateFileProgress</span>(fileItem.<span class="property">id</span>, progress);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            xhr.<span class="title function_">addEventListener</span>(<span class="string">&#x27;load&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (xhr.<span class="property">status</span> === <span class="number">200</span>) &#123;</span><br><span class="line">                    <span class="keyword">const</span> response = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(xhr.<span class="property">responseText</span>);</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">sendFileMessage</span>(response.<span class="property">fileUrl</span>, fileItem);</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">updateFileStatus</span>(fileItem.<span class="property">id</span>, <span class="string">&#x27;completed&#x27;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">updateFileStatus</span>(fileItem.<span class="property">id</span>, <span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">showNotification</span>(<span class="string">`文件 <span class="subst">$&#123;fileItem.file.name&#125;</span> 上传失败`</span>, <span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            xhr.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">updateFileStatus</span>(fileItem.<span class="property">id</span>, <span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">showNotification</span>(<span class="string">`文件 <span class="subst">$&#123;fileItem.file.name&#125;</span> 上传失败`</span>, <span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            xhr.<span class="title function_">open</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/api/files/upload&#x27;</span>);</span><br><span class="line">            xhr.<span class="title function_">setRequestHeader</span>(<span class="string">&#x27;Authorization&#x27;</span>, <span class="string">`Bearer <span class="subst">$&#123;<span class="variable language_">this</span>.token&#125;</span>`</span>);</span><br><span class="line">            xhr.<span class="title function_">send</span>(formData);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;上传错误:&#x27;</span>, error);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">updateFileStatus</span>(fileItem.<span class="property">id</span>, <span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">updateFileProgress</span>(<span class="params">fileId, progress</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> preview = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">`file-<span class="subst">$&#123;fileId&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">if</span> (preview) &#123;</span><br><span class="line">            preview.<span class="title function_">querySelector</span>(<span class="string">&#x27;.progress-filled&#x27;</span>).<span class="property">style</span>.<span class="property">width</span> = <span class="string">`<span class="subst">$&#123;progress&#125;</span>%`</span>;</span><br><span class="line">            preview.<span class="title function_">querySelector</span>(<span class="string">&#x27;.progress-percent&#x27;</span>).<span class="property">textContent</span> = <span class="string">`<span class="subst">$&#123;progress&#125;</span>%`</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">updateFileStatus</span>(<span class="params">fileId, status</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> preview = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">`file-<span class="subst">$&#123;fileId&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">if</span> (preview) &#123;</span><br><span class="line">            preview.<span class="property">dataset</span>.<span class="property">status</span> = status;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">removeFileFromQueue</span>(<span class="params">fileId</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">uploadQueue</span> = <span class="variable language_">this</span>.<span class="property">uploadQueue</span>.<span class="title function_">filter</span>(<span class="function"><span class="params">item</span> =&gt;</span> item.<span class="property">id</span> !== fileId);</span><br><span class="line">        <span class="keyword">const</span> preview = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">`file-<span class="subst">$&#123;fileId&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">if</span> (preview) &#123;</span><br><span class="line">            preview.<span class="title function_">remove</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">uploadQueue</span>.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">sendFilesBtn</span>.<span class="property">disabled</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">sendFileMessage</span>(<span class="params">fileUrl, fileItem</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> message = &#123;</span><br><span class="line">            <span class="attr">type</span>: fileItem.<span class="property">type</span> === <span class="string">&#x27;image&#x27;</span> ? <span class="string">&#x27;IMAGE&#x27;</span> : <span class="string">&#x27;FILE&#x27;</span>,</span><br><span class="line">            <span class="attr">sender</span>: <span class="variable language_">this</span>.<span class="property">username</span>,</span><br><span class="line">            <span class="attr">content</span>: fileItem.<span class="property">file</span>.<span class="property">name</span>,</span><br><span class="line">            <span class="attr">fileUrl</span>: fileUrl,</span><br><span class="line">            <span class="attr">fileName</span>: fileItem.<span class="property">file</span>.<span class="property">name</span>,</span><br><span class="line">            <span class="attr">fileSize</span>: fileItem.<span class="property">file</span>.<span class="property">size</span>,</span><br><span class="line">            <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>()</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">stompClient</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">connected</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">currentPrivateChat</span>) &#123;</span><br><span class="line">                message.<span class="property">receiver</span> = <span class="variable language_">this</span>.<span class="property">currentPrivateChat</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">stompClient</span>.<span class="title function_">send</span>(<span class="string">&#x27;/app/chat.sendPrivateMessage&#x27;</span>, &#123;&#125;, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(message));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">stompClient</span>.<span class="title function_">send</span>(<span class="string">&#x27;/app/chat.sendMessage&#x27;</span>, &#123;&#125;, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(message));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 语音录制功能</span></span><br><span class="line">    <span class="title function_">initVoiceRecorder</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">audioContext</span> = <span class="keyword">new</span> (<span class="variable language_">window</span>.<span class="property">AudioContext</span> || <span class="variable language_">window</span>.<span class="property">webkitAudioContext</span>)();</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">analyser</span> = <span class="variable language_">this</span>.<span class="property">audioContext</span>.<span class="title function_">createAnalyser</span>();</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">analyser</span>.<span class="property">fftSize</span> = <span class="number">256</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;音频上下文初始化失败:&#x27;</span>, error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">startRecording</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> stream = <span class="keyword">await</span> navigator.<span class="property">mediaDevices</span>.<span class="title function_">getUserMedia</span>(&#123; <span class="attr">audio</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">mediaRecorder</span> = <span class="keyword">new</span> <span class="title class_">MediaRecorder</span>(stream);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">audioChunks</span> = [];</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">mediaRecorder</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;dataavailable&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">audioChunks</span>.<span class="title function_">push</span>(event.<span class="property">data</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">mediaRecorder</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;stop&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> audioBlob = <span class="keyword">new</span> <span class="title class_">Blob</span>(<span class="variable language_">this</span>.<span class="property">audioChunks</span>, &#123; <span class="attr">type</span>: <span class="string">&#x27;audio/webm&#x27;</span> &#125;);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">audioUrl</span> = <span class="variable constant_">URL</span>.<span class="title function_">createObjectURL</span>(audioBlob);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">audioBlob</span> = audioBlob;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">playRecordBtn</span>.<span class="property">disabled</span> = <span class="literal">false</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">sendRecordBtn</span>.<span class="property">disabled</span> = <span class="literal">false</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">mediaRecorder</span>.<span class="title function_">start</span>();</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">isRecording</span> = <span class="literal">true</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">startRecordBtn</span>.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;recording&#x27;</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">stopRecordBtn</span>.<span class="property">disabled</span> = <span class="literal">false</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 开始计时</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">recordingStartTime</span> = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">recordingTimer</span> = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> elapsed = <span class="title class_">Date</span>.<span class="title function_">now</span>() - <span class="variable language_">this</span>.<span class="property">recordingStartTime</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">updateRecordingTime</span>(elapsed);</span><br><span class="line">            &#125;, <span class="number">1000</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 可视化</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">startVisualization</span>(stream);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;录音失败:&#x27;</span>, error);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">showNotification</span>(<span class="string">&#x27;无法访问麦克风&#x27;</span>, <span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">stopRecording</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">mediaRecorder</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">isRecording</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">mediaRecorder</span>.<span class="title function_">stop</span>();</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">isRecording</span> = <span class="literal">false</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">startRecordBtn</span>.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;recording&#x27;</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">stopRecordBtn</span>.<span class="property">disabled</span> = <span class="literal">true</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 停止计时</span></span><br><span class="line">            <span class="built_in">clearInterval</span>(<span class="variable language_">this</span>.<span class="property">recordingTimer</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 停止可视化</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">stopVisualization</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">playRecording</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">audioUrl</span> || <span class="variable language_">this</span>.<span class="property">isPlaying</span>) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> audio = <span class="keyword">new</span> <span class="title class_">Audio</span>(<span class="variable language_">this</span>.<span class="property">audioUrl</span>);</span><br><span class="line">        audio.<span class="title function_">addEventListener</span>(<span class="string">&#x27;ended&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">isPlaying</span> = <span class="literal">false</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">playRecordBtn</span>.<span class="property">innerHTML</span> = <span class="string">&#x27;&lt;i class=&quot;fas fa-play&quot;&gt;&lt;/i&gt;&#x27;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        audio.<span class="title function_">play</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isPlaying</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">playRecordBtn</span>.<span class="property">innerHTML</span> = <span class="string">&#x27;&lt;i class=&quot;fas fa-pause&quot;&gt;&lt;/i&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">sendVoiceMessage</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">audioBlob</span>) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> formData = <span class="keyword">new</span> <span class="title class_">FormData</span>();</span><br><span class="line">        formData.<span class="title function_">append</span>(<span class="string">&#x27;file&#x27;</span>, <span class="variable language_">this</span>.<span class="property">audioBlob</span>, <span class="string">&#x27;voice.webm&#x27;</span>);</span><br><span class="line">        formData.<span class="title function_">append</span>(<span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;voice&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;/api/files/upload&#x27;</span>, &#123;</span><br><span class="line">                <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">                <span class="attr">headers</span>: &#123;</span><br><span class="line">                    <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">`Bearer <span class="subst">$&#123;<span class="variable language_">this</span>.token&#125;</span>`</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">body</span>: formData</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (response.<span class="property">ok</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">sendVoiceMessageToServer</span>(data.<span class="property">fileUrl</span>);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">hideVoiceRecorder</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;语音上传失败:&#x27;</span>, error);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">showNotification</span>(<span class="string">&#x27;语音发送失败&#x27;</span>, <span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">sendVoiceMessageToServer</span>(<span class="params">fileUrl</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> duration = <span class="title class_">Math</span>.<span class="title function_">round</span>((<span class="title class_">Date</span>.<span class="title function_">now</span>() - <span class="variable language_">this</span>.<span class="property">recordingStartTime</span>) / <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">const</span> message = &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;VOICE&#x27;</span>,</span><br><span class="line">            <span class="attr">sender</span>: <span class="variable language_">this</span>.<span class="property">username</span>,</span><br><span class="line">            <span class="attr">content</span>: <span class="string">`语音消息 <span class="subst">$&#123;duration&#125;</span>秒`</span>,</span><br><span class="line">            <span class="attr">fileUrl</span>: fileUrl,</span><br><span class="line">            <span class="attr">fileName</span>: <span class="string">&#x27;voice.webm&#x27;</span>,</span><br><span class="line">            <span class="attr">fileSize</span>: <span class="variable language_">this</span>.<span class="property">audioBlob</span>.<span class="property">size</span>,</span><br><span class="line">            <span class="attr">duration</span>: duration,</span><br><span class="line">            <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>()</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">stompClient</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">connected</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">currentPrivateChat</span>) &#123;</span><br><span class="line">                message.<span class="property">receiver</span> = <span class="variable language_">this</span>.<span class="property">currentPrivateChat</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">stompClient</span>.<span class="title function_">send</span>(<span class="string">&#x27;/app/chat.sendPrivateMessage&#x27;</span>, &#123;&#125;, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(message));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">stompClient</span>.<span class="title function_">send</span>(<span class="string">&#x27;/app/chat.sendMessage&#x27;</span>, &#123;&#125;, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(message));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">updateRecordingTime</span>(<span class="params">elapsed</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> seconds = <span class="title class_">Math</span>.<span class="title function_">floor</span>(elapsed / <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">const</span> minutes = <span class="title class_">Math</span>.<span class="title function_">floor</span>(seconds / <span class="number">60</span>);</span><br><span class="line">        <span class="keyword">const</span> remainingSeconds = seconds % <span class="number">60</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">recordingTime</span>.<span class="property">textContent</span> = </span><br><span class="line">            <span class="string">`<span class="subst">$&#123;minutes.toString().padStart(<span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>)&#125;</span>:<span class="subst">$&#123;remainingSeconds.toString().padStart(<span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>)&#125;</span>`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">startVisualization</span>(<span class="params">stream</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> source = <span class="variable language_">this</span>.<span class="property">audioContext</span>.<span class="title function_">createMediaStreamSource</span>(stream);</span><br><span class="line">        source.<span class="title function_">connect</span>(<span class="variable language_">this</span>.<span class="property">analyser</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> bufferLength = <span class="variable language_">this</span>.<span class="property">analyser</span>.<span class="property">frequencyBinCount</span>;</span><br><span class="line">        <span class="keyword">const</span> dataArray = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(bufferLength);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">draw</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">isRecording</span>) <span class="keyword">return</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="title function_">requestAnimationFrame</span>(draw);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">analyser</span>.<span class="title function_">getByteFrequencyData</span>(dataArray);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 绘制可视化</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">drawVisualizer</span>(dataArray, bufferLength);</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="title function_">draw</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">drawVisualizer</span>(<span class="params">dataArray, bufferLength</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">visualizer</span>.<span class="property">innerHTML</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">const</span> width = <span class="variable language_">this</span>.<span class="property">visualizer</span>.<span class="property">clientWidth</span>;</span><br><span class="line">        <span class="keyword">const</span> height = <span class="variable language_">this</span>.<span class="property">visualizer</span>.<span class="property">clientHeight</span>;</span><br><span class="line">        <span class="keyword">const</span> barWidth = (width / bufferLength) * <span class="number">2.5</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> x = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; bufferLength; i++) &#123;</span><br><span class="line">            <span class="keyword">const</span> barHeight = (dataArray[i] / <span class="number">255</span>) * height;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">const</span> bar = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">            bar.<span class="property">style</span>.<span class="property">position</span> = <span class="string">&#x27;absolute&#x27;</span>;</span><br><span class="line">            bar.<span class="property">style</span>.<span class="property">left</span> = x + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">            bar.<span class="property">style</span>.<span class="property">bottom</span> = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">            bar.<span class="property">style</span>.<span class="property">width</span> = barWidth + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">            bar.<span class="property">style</span>.<span class="property">height</span> = barHeight + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">            bar.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">&#x27;var(--primary-color)&#x27;</span>;</span><br><span class="line">            bar.<span class="property">style</span>.<span class="property">borderRadius</span> = <span class="string">&#x27;2px&#x27;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">visualizer</span>.<span class="title function_">appendChild</span>(bar);</span><br><span class="line">            x += barWidth + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">stopVisualization</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">visualizer</span>.<span class="property">innerHTML</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">toggleVoiceRecorder</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">voiceRecorder</span>.<span class="property">classList</span>.<span class="title function_">toggle</span>(<span class="string">&#x27;show&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">hideVoiceRecorder</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">voiceRecorder</span>.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;show&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 用户设置</span></span><br><span class="line">    <span class="title function_">showUserSettings</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">editNickname</span>.<span class="property">value</span> = <span class="variable language_">this</span>.<span class="property">currentUser</span>.<span class="property">nickname</span> || <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">editBio</span>.<span class="property">value</span> = <span class="variable language_">this</span>.<span class="property">currentUser</span>.<span class="property">bio</span> || <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置状态</span></span><br><span class="line">        <span class="keyword">const</span> statusInput = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">`input[name=&quot;status&quot;][value=&quot;<span class="subst">$&#123;<span class="variable language_">this</span>.currentUser.status || <span class="string">&#x27;ONLINE&#x27;</span>&#125;</span>&quot;]`</span>);</span><br><span class="line">        <span class="keyword">if</span> (statusInput) &#123;</span><br><span class="line">            statusInput.<span class="property">checked</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">userSettingsModal</span>.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;show&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">handleAvatarUpload</span>(<span class="params">event</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> file = event.<span class="property">target</span>.<span class="property">files</span>[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (!file) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!file.<span class="property">type</span>.<span class="title function_">startsWith</span>(<span class="string">&#x27;image/&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">showNotification</span>(<span class="string">&#x27;请选择图片文件&#x27;</span>, <span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (file.<span class="property">size</span> &gt; <span class="number">5</span> * <span class="number">1024</span> * <span class="number">1024</span>) &#123; <span class="comment">// 5MB限制</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">showNotification</span>(<span class="string">&#x27;图片大小不能超过5MB&#x27;</span>, <span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> reader = <span class="keyword">new</span> <span class="title class_">FileReader</span>();</span><br><span class="line">        reader.<span class="property">onload</span> = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">avatarPreview</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;img&#x27;</span>).<span class="property">src</span> = e.<span class="property">target</span>.<span class="property">result</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        reader.<span class="title function_">readAsDataURL</span>(file);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">saveUserSettings</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> formData = <span class="keyword">new</span> <span class="title class_">FormData</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 头像上传</span></span><br><span class="line">        <span class="keyword">const</span> avatarFile = <span class="variable language_">this</span>.<span class="property">avatarUpload</span>.<span class="property">files</span>[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (avatarFile) &#123;</span><br><span class="line">            formData.<span class="title function_">append</span>(<span class="string">&#x27;avatar&#x27;</span>, avatarFile);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        formData.<span class="title function_">append</span>(<span class="string">&#x27;nickname&#x27;</span>, <span class="variable language_">this</span>.<span class="property">editNickname</span>.<span class="property">value</span>);</span><br><span class="line">        formData.<span class="title function_">append</span>(<span class="string">&#x27;bio&#x27;</span>, <span class="variable language_">this</span>.<span class="property">editBio</span>.<span class="property">value</span>);</span><br><span class="line">        formData.<span class="title function_">append</span>(<span class="string">&#x27;status&#x27;</span>, <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;input[name=&quot;status&quot;]:checked&#x27;</span>).<span class="property">value</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;/api/user/profile&#x27;</span>, &#123;</span><br><span class="line">                <span class="attr">method</span>: <span class="string">&#x27;PUT&#x27;</span>,</span><br><span class="line">                <span class="attr">headers</span>: &#123;</span><br><span class="line">                    <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">`Bearer <span class="subst">$&#123;<span class="variable language_">this</span>.token&#125;</span>`</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">body</span>: formData</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (response.<span class="property">ok</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">currentUser</span> = &#123; ...<span class="variable language_">this</span>.<span class="property">currentUser</span>, ...data &#125;;</span><br><span class="line">                <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;chat_user&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">currentUser</span>));</span><br><span class="line">                </span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">usernameDisplay</span>.<span class="property">textContent</span> = data.<span class="property">nickname</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">showNotification</span>(<span class="string">&#x27;设置已保存&#x27;</span>, <span class="string">&#x27;success&#x27;</span>);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">userSettingsModal</span>.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;show&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;保存设置失败:&#x27;</span>, error);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">showNotification</span>(<span class="string">&#x27;保存失败&#x27;</span>, <span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 上下文菜单</span></span><br><span class="line">    <span class="title function_">handleContextMenu</span>(<span class="params">event</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> messageElement = event.<span class="property">target</span>.<span class="title function_">closest</span>(<span class="string">&#x27;.message&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!messageElement) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        event.<span class="title function_">preventDefault</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> messageId = messageElement.<span class="property">dataset</span>.<span class="property">messageId</span>;</span><br><span class="line">        <span class="keyword">if</span> (!messageId) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取消息信息</span></span><br><span class="line">        <span class="keyword">const</span> message = <span class="variable language_">this</span>.<span class="title function_">getMessageById</span>(messageId);</span><br><span class="line">        <span class="keyword">if</span> (!message) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查权限（是否可以删除、举报等）</span></span><br><span class="line">        <span class="keyword">const</span> canDelete = message.<span class="property">sender</span> === <span class="variable language_">this</span>.<span class="property">username</span> || <span class="variable language_">this</span>.<span class="property">currentUser</span>.<span class="property">role</span> === <span class="string">&#x27;ADMIN&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新菜单项状态</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">updateContextMenu</span>(canDelete);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 显示菜单</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">contextMenu</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;block&#x27;</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">contextMenu</span>.<span class="property">style</span>.<span class="property">left</span> = <span class="string">`<span class="subst">$&#123;event.pageX&#125;</span>px`</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">contextMenu</span>.<span class="property">style</span>.<span class="property">top</span> = <span class="string">`<span class="subst">$&#123;event.pageY&#125;</span>px`</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 保存当前消息ID</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">contextMenu</span>.<span class="property">dataset</span>.<span class="property">messageId</span> = messageId;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">updateContextMenu</span>(<span class="params">canDelete</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> deleteItem = <span class="variable language_">this</span>.<span class="property">contextMenu</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;[data-action=&quot;delete&quot;]&#x27;</span>);</span><br><span class="line">        <span class="keyword">const</span> reportItem = <span class="variable language_">this</span>.<span class="property">contextMenu</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;[data-action=&quot;report&quot;]&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (canDelete) &#123;</span><br><span class="line">            deleteItem.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;block&#x27;</span>;</span><br><span class="line">            reportItem.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            deleteItem.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span>;</span><br><span class="line">            reportItem.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;block&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">hideContextMenu</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">contextMenu</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">getMessageById</span>(<span class="params">messageId</span>) &#123;</span><br><span class="line">        <span class="comment">// 从历史消息中查找</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">messageHistory</span>.<span class="title function_">find</span>(<span class="function"><span class="params">msg</span> =&gt;</span> msg.<span class="property">id</span> === messageId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 其他增强功能</span></span><br><span class="line">    <span class="title function_">setUserStatus</span>(<span class="params">status</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">currentUser</span>) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="title function_">fetch</span>(<span class="string">&#x27;/api/user/status&#x27;</span>, &#123;</span><br><span class="line">            <span class="attr">method</span>: <span class="string">&#x27;PUT&#x27;</span>,</span><br><span class="line">            <span class="attr">headers</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">`Bearer <span class="subst">$&#123;<span class="variable language_">this</span>.token&#125;</span>`</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123; <span class="attr">status</span>: status &#125;)</span><br><span class="line">        &#125;).<span class="title function_">catch</span>(<span class="variable language_">console</span>.<span class="property">error</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">loadMoreMessages</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">loadingMessages</span>) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">loadingMessages</span> = <span class="literal">true</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">`/api/messages/history?offset=<span class="subst">$&#123;<span class="variable language_">this</span>.messageHistory.length&#125;</span>&amp;limit=50`</span>, &#123;</span><br><span class="line">                <span class="attr">headers</span>: &#123;</span><br><span class="line">                    <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">`Bearer <span class="subst">$&#123;<span class="variable language_">this</span>.token&#125;</span>`</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (response.<span class="property">ok</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> messages = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">                <span class="keyword">if</span> (messages.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">prependMessages</span>(messages);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;加载消息失败:&#x27;</span>, error);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">loadingMessages</span> = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">prependMessages</span>(<span class="params">messages</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> fragment = <span class="variable language_">document</span>.<span class="title function_">createDocumentFragment</span>();</span><br><span class="line">        </span><br><span class="line">        messages.<span class="title function_">reverse</span>().<span class="title function_">forEach</span>(<span class="function"><span class="params">message</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> messageElement = <span class="variable language_">this</span>.<span class="title function_">createMessageElement</span>(message);</span><br><span class="line">            fragment.<span class="title function_">appendChild</span>(messageElement);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">messagesContainer</span>.<span class="title function_">insertBefore</span>(fragment, <span class="variable language_">this</span>.<span class="property">messagesContainer</span>.<span class="property">firstChild</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">messageHistory</span>.<span class="title function_">unshift</span>(...messages);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 消息搜索功能</span></span><br><span class="line">    <span class="title function_">searchMessages</span>(<span class="params">keyword</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!keyword) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> results = <span class="variable language_">this</span>.<span class="property">messageHistory</span>.<span class="title function_">filter</span>(<span class="function"><span class="params">msg</span> =&gt;</span> </span><br><span class="line">            msg.<span class="property">content</span>.<span class="title function_">toLowerCase</span>().<span class="title function_">includes</span>(keyword.<span class="title function_">toLowerCase</span>()) ||</span><br><span class="line">            msg.<span class="property">sender</span>.<span class="title function_">toLowerCase</span>().<span class="title function_">includes</span>(keyword.<span class="title function_">toLowerCase</span>())</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">highlightSearchResults</span>(results, keyword);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">highlightSearchResults</span>(<span class="params">results, keyword</span>) &#123;</span><br><span class="line">        <span class="comment">// 移除之前的高亮</span></span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.search-highlight&#x27;</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">el</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> parent = el.<span class="property">parentNode</span>;</span><br><span class="line">            parent.<span class="title function_">replaceChild</span>(<span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(el.<span class="property">textContent</span>), el);</span><br><span class="line">            parent.<span class="title function_">normalize</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 添加新的高亮</span></span><br><span class="line">        results.<span class="title function_">forEach</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> messageElement = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">`[data-message-id=&quot;<span class="subst">$&#123;result.id&#125;</span>&quot;]`</span>);</span><br><span class="line">            <span class="keyword">if</span> (messageElement) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">highlightText</span>(messageElement, keyword);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">highlightText</span>(<span class="params">element, keyword</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> regex = <span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">`(<span class="subst">$&#123;keyword&#125;</span>)`</span>, <span class="string">&#x27;gi&#x27;</span>);</span><br><span class="line">        <span class="keyword">const</span> nodes = <span class="variable language_">this</span>.<span class="title function_">getTextNodes</span>(element);</span><br><span class="line">        </span><br><span class="line">        nodes.<span class="title function_">forEach</span>(<span class="function"><span class="params">node</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> text = node.<span class="property">textContent</span>;</span><br><span class="line">            <span class="keyword">const</span> matches = [...text.<span class="title function_">matchAll</span>(regex)];</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (matches.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> fragment = <span class="variable language_">document</span>.<span class="title function_">createDocumentFragment</span>();</span><br><span class="line">                <span class="keyword">let</span> lastIndex = <span class="number">0</span>;</span><br><span class="line">                </span><br><span class="line">                matches.<span class="title function_">forEach</span>(<span class="function"><span class="params">match</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">const</span> matchIndex = match.<span class="property">index</span>;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 添加匹配前的文本</span></span><br><span class="line">                    <span class="keyword">if</span> (matchIndex &gt; lastIndex) &#123;</span><br><span class="line">                        fragment.<span class="title function_">appendChild</span>(<span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(text.<span class="title function_">substring</span>(lastIndex, matchIndex)));</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 添加高亮文本</span></span><br><span class="line">                    <span class="keyword">const</span> highlight = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;span&#x27;</span>);</span><br><span class="line">                    highlight.<span class="property">className</span> = <span class="string">&#x27;search-highlight&#x27;</span>;</span><br><span class="line">                    highlight.<span class="property">textContent</span> = match[<span class="number">0</span>];</span><br><span class="line">                    fragment.<span class="title function_">appendChild</span>(highlight);</span><br><span class="line">                    </span><br><span class="line">                    lastIndex = matchIndex + match[<span class="number">0</span>].<span class="property">length</span>;</span><br><span class="line">                &#125;);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 添加剩余的文本</span></span><br><span class="line">                <span class="keyword">if</span> (lastIndex &lt; text.<span class="property">length</span>) &#123;</span><br><span class="line">                    fragment.<span class="title function_">appendChild</span>(<span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(text.<span class="title function_">substring</span>(lastIndex)));</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                node.<span class="property">parentNode</span>.<span class="title function_">replaceChild</span>(fragment, node);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">getTextNodes</span>(<span class="params">element</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> walker = <span class="variable language_">document</span>.<span class="title function_">createTreeWalker</span>(</span><br><span class="line">            element,</span><br><span class="line">            <span class="title class_">NodeFilter</span>.<span class="property">SHOW_TEXT</span>,</span><br><span class="line">            <span class="literal">null</span>,</span><br><span class="line">            <span class="literal">false</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> nodes = [];</span><br><span class="line">        <span class="keyword">let</span> node;</span><br><span class="line">        <span class="keyword">while</span> (node = walker.<span class="title function_">nextNode</span>()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (node.<span class="property">textContent</span>.<span class="title function_">trim</span>()) &#123;</span><br><span class="line">                nodes.<span class="title function_">push</span>(node);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> nodes;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 显示通知</span></span><br><span class="line">    <span class="title function_">showNotification</span>(<span class="params">message, type = <span class="string">&#x27;info&#x27;</span></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> notification = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">        notification.<span class="property">className</span> = <span class="string">`notification notification-<span class="subst">$&#123;type&#125;</span>`</span>;</span><br><span class="line">        notification.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;notification-icon&quot;&gt;</span></span><br><span class="line"><span class="string">                <span class="subst">$&#123;<span class="variable language_">this</span>.getNotificationIcon(type)&#125;</span></span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;notification-content&quot;&gt;<span class="subst">$&#123;message&#125;</span>&lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;button class=&quot;notification-close&quot;&gt;&amp;times;&lt;/button&gt;</span></span><br><span class="line"><span class="string">        `</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(notification);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 显示动画</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> notification.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;show&#x27;</span>), <span class="number">100</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 关闭按钮</span></span><br><span class="line">        notification.<span class="title function_">querySelector</span>(<span class="string">&#x27;.notification-close&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            notification.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;show&#x27;</span>);</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> notification.<span class="title function_">remove</span>(), <span class="number">300</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 自动关闭</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (notification.<span class="property">parentNode</span>) &#123;</span><br><span class="line">                notification.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;show&#x27;</span>);</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> notification.<span class="title function_">remove</span>(), <span class="number">300</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">5000</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 播放提示音</span></span><br><span class="line">        <span class="keyword">if</span> (type === <span class="string">&#x27;info&#x27;</span> || type === <span class="string">&#x27;success&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">playNotificationSound</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">getNotificationIcon</span>(<span class="params">type</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> icons = &#123;</span><br><span class="line">            <span class="attr">info</span>: <span class="string">&#x27;&lt;i class=&quot;fas fa-info-circle&quot;&gt;&lt;/i&gt;&#x27;</span>,</span><br><span class="line">            <span class="attr">success</span>: <span class="string">&#x27;&lt;i class=&quot;fas fa-check-circle&quot;&gt;&lt;/i&gt;&#x27;</span>,</span><br><span class="line">            <span class="attr">warning</span>: <span class="string">&#x27;&lt;i class=&quot;fas fa-exclamation-triangle&quot;&gt;&lt;/i&gt;&#x27;</span>,</span><br><span class="line">            <span class="attr">error</span>: <span class="string">&#x27;&lt;i class=&quot;fas fa-times-circle&quot;&gt;&lt;/i&gt;&#x27;</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> icons[type] || icons.<span class="property">info</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">playNotificationSound</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> audio = <span class="keyword">new</span> <span class="title class_">Audio</span>(<span class="string">&#x27;/sounds/notification.mp3&#x27;</span>);</span><br><span class="line">        audio.<span class="property">volume</span> = <span class="number">0.3</span>;</span><br><span class="line">        audio.<span class="title function_">play</span>().<span class="title function_">catch</span>(<span class="variable language_">console</span>.<span class="property">error</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化增强版聊天室</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;DOMContentLoaded&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> chatRoom = <span class="keyword">new</span> <span class="title class_">EnhancedChatRoom</span>();</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">chatRoom</span> = chatRoom; <span class="comment">// 暴露给控制台调试</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h2 id="8-应用配置文件更新"><a href="#8-应用配置文件更新" class="headerlink" title="8. 应用配置文件更新"></a>8. 应用配置文件更新</h2><h3 id="8-1-application-yml"><a href="#8-1-application-yml" class="headerlink" title="8.1 application.yml"></a>8.1 application.yml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">chat-room</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 数据库配置</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/chat_room?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root123</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">hikari:</span></span><br><span class="line">      <span class="attr">maximum-pool-size:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">minimum-idle:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">connection-timeout:</span> <span class="number">30000</span></span><br><span class="line">      <span class="attr">idle-timeout:</span> <span class="number">600000</span></span><br><span class="line">      <span class="attr">max-lifetime:</span> <span class="number">1800000</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># JPA配置</span></span><br><span class="line">  <span class="attr">jpa:</span></span><br><span class="line">    <span class="attr">hibernate:</span></span><br><span class="line">      <span class="attr">ddl-auto:</span> <span class="string">update</span></span><br><span class="line">    <span class="attr">show-sql:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">hibernate:</span></span><br><span class="line">        <span class="attr">format_sql:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">dialect:</span> <span class="string">org.hibernate.dialect.MySQL8Dialect</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 文件上传配置</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">multipart:</span></span><br><span class="line">      <span class="attr">max-file-size:</span> <span class="string">50MB</span></span><br><span class="line">      <span class="attr">max-request-size:</span> <span class="string">100MB</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 缓存配置</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">caffeine</span></span><br><span class="line">    <span class="attr">caffeine:</span></span><br><span class="line">      <span class="attr">spec:</span> <span class="string">maximumSize=500,expireAfterAccess=600s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用配置</span></span><br><span class="line"><span class="attr">app:</span></span><br><span class="line">  <span class="attr">jwt:</span></span><br><span class="line">    <span class="attr">secret:</span> <span class="string">your-super-secret-jwt-key-change-this-in-production</span></span><br><span class="line">    <span class="attr">expiration:</span> <span class="number">86400000</span> <span class="comment"># 24小时</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">upload-dir:</span> <span class="string">./uploads</span></span><br><span class="line">    <span class="attr">max-size:</span> <span class="string">50MB</span></span><br><span class="line">  <span class="attr">cors:</span></span><br><span class="line">    <span class="attr">allowed-origins:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">    <span class="attr">allowed-methods:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">    <span class="attr">allowed-headers:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">    <span class="attr">allow-credentials:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志配置</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.chatroom:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="attr">org.springframework.web.socket:</span> <span class="string">INFO</span></span><br><span class="line">    <span class="attr">org.springframework.security:</span> <span class="string">INFO</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">logs/chat-room.log</span></span><br><span class="line">  <span class="attr">pattern:</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">&quot;%d&#123;yyyy-MM-dd HH:mm:ss&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务器配置</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">session:</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">30m</span></span><br><span class="line">  <span class="attr">compression:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">mime-types:</span> <span class="string">text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json</span></span><br><span class="line">    <span class="attr">min-response-size:</span> <span class="number">1024</span></span><br></pre></td></tr></table></figure>



<h2 id="9-Docker支持"><a href="#9-Docker支持" class="headerlink" title="9. Docker支持"></a>9. Docker支持</h2><h3 id="9-1-Dockerfile"><a href="#9-1-Dockerfile" class="headerlink" title="9.1 Dockerfile"></a>9.1 Dockerfile</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用多阶段构建</span></span><br><span class="line"><span class="keyword">FROM</span> maven:<span class="number">3.8</span>.<span class="number">4</span>-openjdk-<span class="number">11</span> AS build</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> pom.xml .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> mvn dependency:go-offline</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> src ./src</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> mvn clean package -DskipTests</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">11</span>-jre-slim</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=build /app/target/*.jar app.jar</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建上传目录</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p /app/uploads &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">chmod</span> 755 /app/uploads</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line"><span class="keyword">ENV</span> SPRING_PROFILES_ACTIVE=production</span><br><span class="line"><span class="keyword">ENV</span> JAVA_OPTS=<span class="string">&quot;-Xmx512m -Xms256m&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;java <span class="variable">$JAVA_OPTS</span> -jar app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>



<h3 id="9-2-docker-compose-yml"><a href="#9-2-docker-compose-yml" class="headerlink" title="9.2 docker-compose.yml"></a>9.2 docker-compose.yml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:8.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">chat-mysql</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">root123</span></span><br><span class="line">      <span class="attr">MYSQL_DATABASE:</span> <span class="string">chat_room</span></span><br><span class="line">      <span class="attr">MYSQL_USER:</span> <span class="string">chat_user</span></span><br><span class="line">      <span class="attr">MYSQL_PASSWORD:</span> <span class="string">chat123</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3307:3306&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_data:/var/lib/mysql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./init.sql:/docker-entrypoint-initdb.d/init.sql</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">chat-network</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;mysqladmin&quot;</span>, <span class="string">&quot;ping&quot;</span>, <span class="string">&quot;-h&quot;</span>, <span class="string">&quot;localhost&quot;</span>]</span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">20s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:7-alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">chat-redis</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis_data:/data</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">chat-network</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--appendonly</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">chat-app:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">chat-app</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="attr">mysql:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">service_healthy</span></span><br><span class="line">      <span class="attr">redis:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">service_started</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">SPRING_DATASOURCE_URL:</span> <span class="string">jdbc:mysql://mysql:3306/chat_room?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">      <span class="attr">SPRING_DATASOURCE_USERNAME:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">SPRING_DATASOURCE_PASSWORD:</span> <span class="string">root123</span></span><br><span class="line">      <span class="attr">SPRING_REDIS_HOST:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">APP_JWT_SECRET:</span> <span class="string">your-production-jwt-secret-change-this</span></span><br><span class="line">      <span class="attr">APP_FILE_UPLOAD_DIR:</span> <span class="string">/app/uploads</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">uploads:/app/uploads</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">logs:/app/logs</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">chat-network</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">chat-nginx</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;443:443&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx.conf:/etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./ssl:/etc/nginx/ssl</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">chat-app</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">chat-network</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">mysql_data:</span></span><br><span class="line">  <span class="attr">redis_data:</span></span><br><span class="line">  <span class="attr">uploads:</span></span><br><span class="line">  <span class="attr">logs:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">chat-network:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure>



<h3 id="9-3-Nginx配置-nginx-conf"><a href="#9-3-Nginx配置-nginx-conf" class="headerlink" title="9.3 Nginx配置 (nginx.conf)"></a>9.3 Nginx配置 (nginx.conf)</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="section">upstream</span> chat_backend &#123;</span><br><span class="line">        <span class="attribute">server</span> chat-app:<span class="number">8080</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span> chat.example.com;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 重定向到HTTPS</span></span><br><span class="line">        <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line">        <span class="attribute">server_name</span> chat.example.com;</span><br><span class="line">        </span><br><span class="line">        <span class="attribute">ssl_certificate</span> /etc/nginx/ssl/chat.example.com.crt;</span><br><span class="line">        <span class="attribute">ssl_certificate_key</span> /etc/nginx/ssl/chat.example.com.key;</span><br><span class="line">        <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line">        <span class="attribute">ssl_ciphers</span> HIGH:!aNULL:!MD5;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># WebSocket支持</span></span><br><span class="line">        <span class="section">location</span> /ws &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://chat_backend;</span><br><span class="line">            <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Connection <span class="string">&quot;upgrade&quot;</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">            <span class="attribute">proxy_read_timeout</span> <span class="number">86400</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 静态文件</span></span><br><span class="line">        <span class="section">location</span> /uploads &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://chat_backend;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># API请求</span></span><br><span class="line">        <span class="section">location</span> /api &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://chat_backend;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 应用</span></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://chat_backend;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 缓存静态资源</span></span><br><span class="line">        <span class="section">location</span> <span class="regexp">~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$</span> &#123;</span><br><span class="line">            <span class="attribute">expires</span> <span class="number">1y</span>;</span><br><span class="line">            <span class="attribute">add_header</span> Cache-Control <span class="string">&quot;public, immutable&quot;</span>;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://chat_backend;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="10-监控和运维"><a href="#10-监控和运维" class="headerlink" title="10. 监控和运维"></a>10. 监控和运维</h2><h3 id="10-1-Spring-Boot-Actuator配置"><a href="#10-1-Spring-Boot-Actuator配置" class="headerlink" title="10.1 Spring Boot Actuator配置"></a>10.1 Spring Boot Actuator配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.actuate.autoconfigure.security.servlet.EndpointRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActuatorSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">            .requestMatcher(EndpointRequest.toAnyEndpoint())</span><br><span class="line">            .authorizeRequests()</span><br><span class="line">                .requestMatchers(EndpointRequest.to(<span class="string">&quot;health&quot;</span>, <span class="string">&quot;info&quot;</span>)).permitAll()</span><br><span class="line">                .anyRequest().hasRole(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">                .and()</span><br><span class="line">            .httpBasic();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="10-2-应用监控端点配置"><a href="#10-2-应用监控端点配置" class="headerlink" title="10.2 应用监控端点配置"></a>10.2 应用监控端点配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 添加到application.yml</span><br><span class="line">management:</span><br><span class="line">  endpoints:</span><br><span class="line">    web:</span><br><span class="line">      exposure:</span><br><span class="line">        include: health,info,metrics,prometheus</span><br><span class="line">      base-path: /actuator</span><br><span class="line">    enabled-by-<span class="keyword">default</span>: <span class="literal">false</span></span><br><span class="line">  endpoint:</span><br><span class="line">    health:</span><br><span class="line">      enabled: <span class="literal">true</span></span><br><span class="line">      show-details: always</span><br><span class="line">    metrics:</span><br><span class="line">      enabled: <span class="literal">true</span></span><br><span class="line">    prometheus:</span><br><span class="line">      enabled: <span class="literal">true</span></span><br><span class="line">  metrics:</span><br><span class="line">    export:</span><br><span class="line">      prometheus:</span><br><span class="line">        enabled: <span class="literal">true</span></span><br></pre></td></tr></table></figure>



<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这个扩展版本的多人聊天室具备了以下功能：</p>
<ol>
<li><strong>完整的用户系统</strong>：注册、登录、个人资料管理</li>
<li><strong>消息持久化</strong>：数据库存储所有聊天记录</li>
<li><strong>文件上传</strong>：支持图片、文件、语音消息</li>
<li><strong>表情系统</strong>：丰富的表情选择</li>
<li><strong>语音消息</strong>：录制和发送语音</li>
<li><strong>主题系统</strong>：亮色&#x2F;暗色主题切换</li>
<li><strong>搜索功能</strong>：消息搜索和用户搜索</li>
<li><strong>通知系统</strong>：桌面通知和声音提醒</li>
<li><strong>上下文菜单</strong>：消息操作（复制、回复、删除等）</li>
<li><strong>管理员功能</strong>：用户管理、消息管理</li>
<li><strong>Docker支持</strong>：容器化部署</li>
<li><strong>监控功能</strong>：Spring Boot Actuator集成</li>
<li><strong>性能优化</strong>：消息分页、缓存、WebSocket优化</li>
</ol>
<p>这个项目现在已经是一个功能完整的实时聊天应用，可以作为学习Java全栈开发的优秀示例。您可以根据需要进一步扩展，比如添加视频通话、群组管理、消息加密等功能。</p>
<h1 id="多人聊天室再扩展"><a href="#多人聊天室再扩展" class="headerlink" title="多人聊天室再扩展"></a>多人聊天室再扩展</h1><p>我将进一步扩展聊天室项目，增加企业级功能，包括：微服务架构、AI集成、视频通话、屏幕共享、分布式部署、监控告警等。</p>
<h2 id="扩展功能清单-1"><a href="#扩展功能清单-1" class="headerlink" title="扩展功能清单"></a>扩展功能清单</h2><ol>
<li><strong>微服务架构</strong> - 拆分为多个微服务</li>
<li><strong>AI聊天助手</strong> - 集成AI大模型</li>
<li><strong>视频通话</strong> - WebRTC视频会议</li>
<li><strong>屏幕共享</strong> - 共享桌面和应用</li>
<li><strong>分布式消息队列</strong> - Kafka&#x2F;RabbitMQ</li>
<li><strong>缓存优化</strong> - Redis集群</li>
<li><strong>实时协作</strong> - 白板、文档协作</li>
<li><strong>消息加密</strong> - 端到端加密</li>
<li><strong>行为分析</strong> - 用户行为追踪和分析</li>
<li><strong>API网关</strong> - Spring Cloud Gateway</li>
<li><strong>服务注册发现</strong> - Eureka&#x2F;Nacos</li>
<li><strong>配置中心</strong> - Spring Cloud Config</li>
<li><strong>链路追踪</strong> - Sleuth&#x2F;Zipkin</li>
<li><strong>容器编排</strong> - Kubernetes部署</li>
<li><strong>CI&#x2F;CD流水线</strong> - Jenkins&#x2F;GitLab CI</li>
</ol>
<h2 id="1-微服务架构设计"><a href="#1-微服务架构设计" class="headerlink" title="1. 微服务架构设计"></a>1. 微服务架构设计</h2><h3 id="1-1-项目结构"><a href="#1-1-项目结构" class="headerlink" title="1.1 项目结构"></a>1.1 项目结构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">chat-microservices/</span><br><span class="line">├── gateway/                    # API网关</span><br><span class="line">├── discovery/                  # 服务注册中心</span><br><span class="line">├── config/                     # 配置中心</span><br><span class="line">├── auth-service/              # 认证服务</span><br><span class="line">├── user-service/              # 用户服务</span><br><span class="line">├── chat-service/              # 聊天服务</span><br><span class="line">├── file-service/              # 文件服务</span><br><span class="line">├── notification-service/      # 通知服务</span><br><span class="line">├── ai-service/                # AI服务</span><br><span class="line">├── webrtc-service/            # WebRTC信令服务</span><br><span class="line">├── monitoring/                # 监控服务</span><br><span class="line">└── docker-compose.yml</span><br></pre></td></tr></table></figure>



<h3 id="1-2-API网关配置-Gateway"><a href="#1-2-API网关配置-Gateway" class="headerlink" title="1.2 API网关配置 (Gateway)"></a>1.2 API网关配置 (Gateway)</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.yml</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">auth-service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://AUTH-SERVICE</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/auth/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CircuitBreaker</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">auth-service</span></span><br><span class="line">                <span class="attr">fallbackUri:</span> <span class="string">forward:/fallback/auth</span></span><br><span class="line">                </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">user-service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://USER-SERVICE</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/users/**,/api/profile/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line">            </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">chat-service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://CHAT-SERVICE</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/messages/**,/api/rooms/**,/api/chats/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line">            </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">file-service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://FILE-SERVICE</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/files/**,/api/upload/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RequestRateLimiter</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">redis-rate-limiter.replenishRate:</span> <span class="number">10</span></span><br><span class="line">                <span class="attr">redis-rate-limiter.burstCapacity:</span> <span class="number">20</span></span><br><span class="line">                </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">ai-service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://AI-SERVICE</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/ai/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line">            </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">webrtc-service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://WEBRTC-SERVICE</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/webrtc/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line">            </span><br><span class="line">      <span class="attr">default-filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GlobalFilter</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JwtAuthFilter</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RateLimiter</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="attr">key-resolver:</span> <span class="string">&quot;#&#123;@userKeyResolver&#125;&quot;</span></span><br><span class="line">            <span class="attr">redis-rate-limiter.replenishRate:</span> <span class="number">100</span></span><br><span class="line">            <span class="attr">redis-rate-limiter.burstCapacity:</span> <span class="number">200</span></span><br><span class="line">            </span><br><span class="line">      <span class="attr">globalcors:</span></span><br><span class="line">        <span class="attr">cors-configurations:</span></span><br><span class="line">          <span class="string">&#x27;[/**]&#x27;</span><span class="string">:</span></span><br><span class="line">            <span class="attr">allowedOrigins:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">            <span class="attr">allowedMethods:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">            <span class="attr">allowedHeaders:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">            <span class="attr">allowCredentials:</span> <span class="literal">true</span></span><br><span class="line">            </span><br><span class="line">    <span class="attr">circuitbreaker:</span></span><br><span class="line">      <span class="attr">instances:</span></span><br><span class="line">        <span class="attr">auth-service:</span></span><br><span class="line">          <span class="attr">slidingWindowSize:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">minimumNumberOfCalls:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">permittedNumberOfCallsInHalfOpenState:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">automaticTransitionFromOpenToHalfOpenEnabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">waitDurationInOpenState:</span> <span class="number">5000</span></span><br><span class="line">          <span class="attr">failureRateThreshold:</span> <span class="number">50</span></span><br><span class="line">          <span class="attr">slowCallRateThreshold:</span> <span class="number">100</span></span><br><span class="line">          <span class="attr">slowCallDurationThreshold:</span> <span class="number">2000</span></span><br><span class="line">          </span><br><span class="line">    <span class="attr">loadbalancer:</span></span><br><span class="line">      <span class="attr">configurations:</span></span><br><span class="line">        <span class="attr">default:</span></span><br><span class="line">          <span class="attr">health-check:</span></span><br><span class="line">            <span class="attr">initial-delay:</span> <span class="number">2000</span></span><br><span class="line">            <span class="attr">interval:</span> <span class="number">30000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 限流配置</span></span><br><span class="line"><span class="attr">resilience4j:</span></span><br><span class="line">  <span class="attr">ratelimiter:</span></span><br><span class="line">    <span class="attr">instances:</span></span><br><span class="line">      <span class="attr">user-service:</span></span><br><span class="line">        <span class="attr">limit-for-period:</span> <span class="number">100</span></span><br><span class="line">        <span class="attr">limit-refresh-period:</span> <span class="string">1s</span></span><br><span class="line">        <span class="attr">timeout-duration:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">register-health-indicator:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>



<h2 id="2-AI聊天助手集成"><a href="#2-AI聊天助手集成" class="headerlink" title="2. AI聊天助手集成"></a>2. AI聊天助手集成</h2><h3 id="2-1-AI服务配置"><a href="#2-1-AI服务配置" class="headerlink" title="2.1 AI服务配置"></a>2.1 AI服务配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.ai;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.ChatResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.Prompt;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.PromptTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.UserMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.AssistantMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.SystemMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AIService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChatClient chatClient;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;ai.model&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String model;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;ai.temperature&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> temperature;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;ai.max-tokens&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> maxTokens;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AIService</span><span class="params">(ChatClient chatClient)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.chatClient = chatClient;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ChatResponse <span class="title function_">chat</span><span class="params">(String userMessage, String context)</span> &#123;</span><br><span class="line">        <span class="type">SystemMessage</span> <span class="variable">systemMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SystemMessage</span>(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            你是一个友好的聊天助手，帮助用户在聊天室中解决问题和提供信息。</span></span><br><span class="line"><span class="string">            请保持回答简洁、有帮助且友好。</span></span><br><span class="line"><span class="string">            当前聊天上下文：%s</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>.formatted(context));</span><br><span class="line">        </span><br><span class="line">        <span class="type">UserMessage</span> <span class="variable">userMsg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserMessage</span>(userMessage);</span><br><span class="line">        </span><br><span class="line">        <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Prompt</span>(List.of(systemMessage, userMsg));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> chatClient.call(prompt);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">summarizeConversation</span><span class="params">(List&lt;Message&gt; messages)</span> &#123;</span><br><span class="line">        <span class="type">PromptTemplate</span> <span class="variable">promptTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PromptTemplate</span>(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            请总结以下对话的主要内容：</span></span><br><span class="line"><span class="string">            &#123;conversation&#125;</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            总结要求：</span></span><br><span class="line"><span class="string">            1. 提取关键信息</span></span><br><span class="line"><span class="string">            2. 总结讨论主题</span></span><br><span class="line"><span class="string">            3. 不超过200字</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">conversationText</span> <span class="operator">=</span> messages.stream()</span><br><span class="line">            .map(msg -&gt; msg.getMessageType().name() + <span class="string">&quot;: &quot;</span> + msg.getContent())</span><br><span class="line">            .reduce(<span class="string">&quot;&quot;</span>, (a, b) -&gt; a + <span class="string">&quot;\n&quot;</span> + b);</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, Object&gt; params = Map.of(<span class="string">&quot;conversation&quot;</span>, conversationText);</span><br><span class="line">        <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> promptTemplate.create(params);</span><br><span class="line">        </span><br><span class="line">        <span class="type">ChatResponse</span> <span class="variable">response</span> <span class="operator">=</span> chatClient.call(prompt);</span><br><span class="line">        <span class="keyword">return</span> response.getResult().getOutput().getContent();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">translateText</span><span class="params">(String text, String targetLanguage)</span> &#123;</span><br><span class="line">        <span class="type">PromptTemplate</span> <span class="variable">promptTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PromptTemplate</span>(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            请将以下文本翻译成&#123;targetLanguage&#125;：</span></span><br><span class="line"><span class="string">            &#123;text&#125;</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            要求：</span></span><br><span class="line"><span class="string">            1. 保持原意</span></span><br><span class="line"><span class="string">            2. 语言自然流畅</span></span><br><span class="line"><span class="string">            3. 如果是聊天用语，保持口语化</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, Object&gt; params = Map.of(</span><br><span class="line">            <span class="string">&quot;text&quot;</span>, text,</span><br><span class="line">            <span class="string">&quot;targetLanguage&quot;</span>, targetLanguage</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> promptTemplate.create(params);</span><br><span class="line">        <span class="type">ChatResponse</span> <span class="variable">response</span> <span class="operator">=</span> chatClient.call(prompt);</span><br><span class="line">        <span class="keyword">return</span> response.getResult().getOutput().getContent();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateResponseSuggestion</span><span class="params">(String conversation)</span> &#123;</span><br><span class="line">        <span class="type">PromptTemplate</span> <span class="variable">promptTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PromptTemplate</span>(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            基于以下对话，生成3个可能的回复建议：</span></span><br><span class="line"><span class="string">            &#123;conversation&#125;</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            要求：</span></span><br><span class="line"><span class="string">            1. 回复要自然、相关</span></span><br><span class="line"><span class="string">            2. 风格多样（提问、陈述、表情等）</span></span><br><span class="line"><span class="string">            3. 每个建议不超过20字</span></span><br><span class="line"><span class="string">            4. 格式：用换行分隔每个建议</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, Object&gt; params = Map.of(<span class="string">&quot;conversation&quot;</span>, conversation);</span><br><span class="line">        <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> promptTemplate.create(params);</span><br><span class="line">        </span><br><span class="line">        <span class="type">ChatResponse</span> <span class="variable">response</span> <span class="operator">=</span> chatClient.call(prompt);</span><br><span class="line">        <span class="keyword">return</span> response.getResult().getOutput().getContent();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ChatResponse <span class="title function_">moderateContent</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="type">SystemMessage</span> <span class="variable">systemMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SystemMessage</span>(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            你是一个内容审核助手。请分析以下内容是否包含：</span></span><br><span class="line"><span class="string">            1. 不当言论或侮辱性语言</span></span><br><span class="line"><span class="string">            2. 政治敏感内容</span></span><br><span class="line"><span class="string">            3. 广告或垃圾信息</span></span><br><span class="line"><span class="string">            4. 暴力或危险内容</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            请给出审核结果：</span></span><br><span class="line"><span class="string">            - 是否通过</span></span><br><span class="line"><span class="string">            - 风险等级（低/中/高）</span></span><br><span class="line"><span class="string">            - 理由</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">UserMessage</span> <span class="variable">userMsg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserMessage</span>(content);</span><br><span class="line">        <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Prompt</span>(List.of(systemMessage, userMsg));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> chatClient.call(prompt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-2-AI控制"><a href="#2-2-AI控制" class="headerlink" title="2.2 AI控制"></a>2.2 AI控制</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.ai.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.chatroom.ai.AIService;</span><br><span class="line"><span class="keyword">import</span> com.chatroom.dto.ApiResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/ai&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AIController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AIService aiService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/chat&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResponse <span class="title function_">chat</span><span class="params">(<span class="meta">@RequestBody</span> Map&lt;String, String&gt; request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> request.get(<span class="string">&quot;message&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">context</span> <span class="operator">=</span> request.get(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">response</span> <span class="operator">=</span> aiService.chat(message, context);</span><br><span class="line">            <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> response.getResult().getOutput().getContent();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiResponse</span>(<span class="literal">true</span>, <span class="string">&quot;AI回复生成成功&quot;</span>, content);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiResponse</span>(<span class="literal">false</span>, <span class="string">&quot;AI服务暂时不可用&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/translate&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResponse <span class="title function_">translate</span><span class="params">(<span class="meta">@RequestBody</span> Map&lt;String, String&gt; request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> request.get(<span class="string">&quot;text&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">targetLanguage</span> <span class="operator">=</span> request.get(<span class="string">&quot;targetLanguage&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">translated</span> <span class="operator">=</span> aiService.translateText(text, targetLanguage);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiResponse</span>(<span class="literal">true</span>, <span class="string">&quot;翻译成功&quot;</span>, translated);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiResponse</span>(<span class="literal">false</span>, <span class="string">&quot;翻译服务暂时不可用&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/suggest&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResponse <span class="title function_">suggest</span><span class="params">(<span class="meta">@RequestBody</span> Map&lt;String, String&gt; request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">conversation</span> <span class="operator">=</span> request.get(<span class="string">&quot;conversation&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">suggestions</span> <span class="operator">=</span> aiService.generateResponseSuggestion(conversation);</span><br><span class="line">            List&lt;String&gt; suggestionList = List.of(suggestions.split(<span class="string">&quot;\n&quot;</span>));</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiResponse</span>(<span class="literal">true</span>, <span class="string">&quot;回复建议生成成功&quot;</span>, suggestionList);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiResponse</span>(<span class="literal">false</span>, <span class="string">&quot;建议生成失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/moderate&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResponse <span class="title function_">moderate</span><span class="params">(<span class="meta">@RequestBody</span> Map&lt;String, String&gt; request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> request.get(<span class="string">&quot;content&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">response</span> <span class="operator">=</span> aiService.moderateContent(content);</span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> response.getResult().getOutput().getContent();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiResponse</span>(<span class="literal">true</span>, <span class="string">&quot;内容审核完成&quot;</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiResponse</span>(<span class="literal">false</span>, <span class="string">&quot;审核服务暂时不可用&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/summarize&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResponse <span class="title function_">summarize</span><span class="params">(<span class="meta">@RequestBody</span> Map&lt;String, Object&gt; request)</span> &#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        List&lt;Map&lt;String, String&gt;&gt; messages = (List&lt;Map&lt;String, String&gt;&gt;) request.get(<span class="string">&quot;messages&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 转换消息格式</span></span><br><span class="line">            List&lt;org.springframework.ai.chat.messages.Message&gt; aiMessages = messages.stream()</span><br><span class="line">                .map(msg -&gt; &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">role</span> <span class="operator">=</span> msg.get(<span class="string">&quot;role&quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> msg.get(<span class="string">&quot;content&quot;</span>);</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">switch</span> (role.toUpperCase()) &#123;</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">&quot;USER&quot;</span> -&gt; <span class="keyword">new</span> <span class="title class_">org</span>.springframework.ai.chat.messages.UserMessage(content);</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">&quot;ASSISTANT&quot;</span> -&gt; <span class="keyword">new</span> <span class="title class_">org</span>.springframework.ai.chat.messages.AssistantMessage(content);</span><br><span class="line">                        <span class="keyword">default</span> -&gt; <span class="keyword">new</span> <span class="title class_">org</span>.springframework.ai.chat.messages.SystemMessage(content);</span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;)</span><br><span class="line">                .toList();</span><br><span class="line">            </span><br><span class="line">            <span class="type">String</span> <span class="variable">summary</span> <span class="operator">=</span> aiService.summarizeConversation(aiMessages);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiResponse</span>(<span class="literal">true</span>, <span class="string">&quot;对话总结生成成功&quot;</span>, summary);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiResponse</span>(<span class="literal">false</span>, <span class="string">&quot;总结生成失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-3-AI配置类"><a href="#2-3-AI配置类" class="headerlink" title="2.3 AI配置类"></a>2.3 AI配置类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.ai.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.autoconfigure.openai.OpenAiAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.openai.OpenAiChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.openai.OpenAiChatOptions;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AIConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;ai.openai.api-key&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String apiKey;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;ai.openai.model:gpt-3.5-turbo&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String model;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;ai.openai.temperature:0.7&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> temperature;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;ai.openai.max-tokens:1000&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> maxTokens;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatClient <span class="title function_">chatClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">OpenAiChatOptions</span> <span class="variable">options</span> <span class="operator">=</span> OpenAiChatOptions.builder()</span><br><span class="line">            .model(model)</span><br><span class="line">            .temperature(temperature)</span><br><span class="line">            .maxTokens(maxTokens)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OpenAiChatClient</span>(apiKey, options);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-WebRTC视频通话"><a href="#3-WebRTC视频通话" class="headerlink" title="3. WebRTC视频通话"></a>3. WebRTC视频通话</h2><h3 id="3-1-信令服务器"><a href="#3-1-信令服务器" class="headerlink" title="3.1 信令服务器"></a>3.1 信令服务器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.webrtc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.handler.TextWebSocketHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebRTCSignalingHandler</span> <span class="keyword">extends</span> <span class="title class_">TextWebSocketHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, WebSocketSession&gt; sessions = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String&gt; userRooms = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterConnectionEstablished</span><span class="params">(WebSocketSession session)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> getUserId(session);</span><br><span class="line">        sessions.put(userId, session);</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;WebRTC连接建立: &quot;</span> + userId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">handleTextMessage</span><span class="params">(WebSocketSession session, TextMessage message)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> message.getPayload();</span><br><span class="line">        <span class="type">SignalingMessage</span> <span class="variable">signalingMessage</span> <span class="operator">=</span> SignalingMessage.fromJson(payload);</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> getUserId(session);</span><br><span class="line">        <span class="type">String</span> <span class="variable">targetUserId</span> <span class="operator">=</span> signalingMessage.getTarget();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> (signalingMessage.getType()) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;offer&quot;</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;answer&quot;</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;candidate&quot;</span>:</span><br><span class="line">                <span class="comment">// 转发到目标用户</span></span><br><span class="line">                forwardMessage(userId, targetUserId, signalingMessage);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;join-room&quot;</span>:</span><br><span class="line">                <span class="type">String</span> <span class="variable">roomId</span> <span class="operator">=</span> signalingMessage.getRoomId();</span><br><span class="line">                joinRoom(userId, roomId);</span><br><span class="line">                broadcastToRoom(roomId, userId, <span class="keyword">new</span> <span class="title class_">SignalingMessage</span>(<span class="string">&quot;user-joined&quot;</span>, userId, <span class="literal">null</span>));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;leave-room&quot;</span>:</span><br><span class="line">                leaveRoom(userId);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;get-users&quot;</span>:</span><br><span class="line">                <span class="type">String</span> <span class="variable">room</span> <span class="operator">=</span> userRooms.get(userId);</span><br><span class="line">                <span class="keyword">if</span> (room != <span class="literal">null</span>) &#123;</span><br><span class="line">                    sendRoomUsers(userId, room);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">forwardMessage</span><span class="params">(String from, String to, SignalingMessage message)</span> &#123;</span><br><span class="line">        <span class="type">WebSocketSession</span> <span class="variable">targetSession</span> <span class="operator">=</span> sessions.get(to);</span><br><span class="line">        <span class="keyword">if</span> (targetSession != <span class="literal">null</span> &amp;&amp; targetSession.isOpen()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                targetSession.sendMessage(<span class="keyword">new</span> <span class="title class_">TextMessage</span>(message.toJson()));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">joinRoom</span><span class="params">(String userId, String roomId)</span> &#123;</span><br><span class="line">        userRooms.put(userId, roomId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">leaveRoom</span><span class="params">(String userId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">roomId</span> <span class="operator">=</span> userRooms.remove(userId);</span><br><span class="line">        <span class="keyword">if</span> (roomId != <span class="literal">null</span>) &#123;</span><br><span class="line">            broadcastToRoom(roomId, userId, <span class="keyword">new</span> <span class="title class_">SignalingMessage</span>(<span class="string">&quot;user-left&quot;</span>, userId, <span class="literal">null</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        sessions.remove(userId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">broadcastToRoom</span><span class="params">(String roomId, String from, SignalingMessage message)</span> &#123;</span><br><span class="line">        sessions.forEach((userId, session) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (!userId.equals(from) &amp;&amp; roomId.equals(userRooms.get(userId))) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    session.sendMessage(<span class="keyword">new</span> <span class="title class_">TextMessage</span>(message.toJson()));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendRoomUsers</span><span class="params">(String userId, String roomId)</span> &#123;</span><br><span class="line">        <span class="type">WebSocketSession</span> <span class="variable">session</span> <span class="operator">=</span> sessions.get(userId);</span><br><span class="line">        <span class="keyword">if</span> (session != <span class="literal">null</span> &amp;&amp; session.isOpen()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">var</span> <span class="variable">users</span> <span class="operator">=</span> userRooms.entrySet().stream()</span><br><span class="line">                    .filter(entry -&gt; roomId.equals(entry.getValue()))</span><br><span class="line">                    .map(Map.Entry::getKey)</span><br><span class="line">                    .filter(id -&gt; !id.equals(userId))</span><br><span class="line">                    .toList();</span><br><span class="line">                </span><br><span class="line">                <span class="type">SignalingMessage</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignalingMessage</span>(<span class="string">&quot;room-users&quot;</span>, <span class="literal">null</span>, Map.of(<span class="string">&quot;users&quot;</span>, users));</span><br><span class="line">                session.sendMessage(<span class="keyword">new</span> <span class="title class_">TextMessage</span>(message.toJson()));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getUserId</span><span class="params">(WebSocketSession session)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; attributes = session.getAttributes();</span><br><span class="line">        <span class="keyword">return</span> attributes.get(<span class="string">&quot;userId&quot;</span>).toString();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterConnectionClosed</span><span class="params">(WebSocketSession session, CloseStatus status)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> getUserId(session);</span><br><span class="line">        leaveRoom(userId);</span><br><span class="line">        System.out.println(<span class="string">&quot;WebRTC连接关闭: &quot;</span> + userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-2-信令消息类"><a href="#3-2-信令消息类" class="headerlink" title="3.2 信令消息类"></a>3.2 信令消息类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.webrtc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SignalingMessage</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line">    <span class="keyword">private</span> String target;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; data;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SignalingMessage</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SignalingMessage</span><span class="params">(String type, String target, Map&lt;String, Object&gt; data)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">        <span class="built_in">this</span>.target = target;</span><br><span class="line">        <span class="built_in">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toJson</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">            <span class="keyword">return</span> mapper.writeValueAsString(<span class="built_in">this</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SignalingMessage <span class="title function_">fromJson</span><span class="params">(String json)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">            <span class="keyword">return</span> mapper.readValue(json, SignalingMessage.class);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-3-WebRTC配置"><a href="#3-3-WebRTC配置" class="headerlink" title="3.3 WebRTC配置"></a>3.3 WebRTC配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.webrtc.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.config.annotation.EnableWebSocket;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.config.annotation.WebSocketConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.config.annotation.WebSocketHandlerRegistry;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSocket</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebRTCConfig</span> <span class="keyword">implements</span> <span class="title class_">WebSocketConfigurer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerWebSocketHandlers</span><span class="params">(WebSocketHandlerRegistry registry)</span> &#123;</span><br><span class="line">        registry.addHandler(<span class="keyword">new</span> <span class="title class_">WebRTCSignalingHandler</span>(), <span class="string">&quot;/ws/webrtc&quot;</span>)</span><br><span class="line">                .setAllowedOriginPatterns(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">                .addInterceptors(<span class="keyword">new</span> <span class="title class_">WebRTCAuthInterceptor</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-前端视频通话实现"><a href="#4-前端视频通话实现" class="headerlink" title="4. 前端视频通话实现"></a>4. 前端视频通话实现</h2><h3 id="4-1-WebRTC前端组件"><a href="#4-1-WebRTC前端组件" class="headerlink" title="4.1 WebRTC前端组件"></a>4.1 WebRTC前端组件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webrtc.js</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WebRTCManager</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">localStream</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">peerConnections</span> = &#123;&#125;;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">dataChannels</span> = &#123;&#125;;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">socket</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">userId</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">roomId</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">configuration</span> = &#123;</span><br><span class="line">            <span class="attr">iceServers</span>: [</span><br><span class="line">                &#123; <span class="attr">urls</span>: <span class="string">&#x27;stun:stun.l.google.com:19302&#x27;</span> &#125;,</span><br><span class="line">                &#123; <span class="attr">urls</span>: <span class="string">&#x27;stun:stun1.l.google.com:19302&#x27;</span> &#125;,</span><br><span class="line">                &#123; <span class="attr">urls</span>: <span class="string">&#x27;stun:stun2.l.google.com:19302&#x27;</span> &#125;,</span><br><span class="line">                &#123; <span class="attr">urls</span>: <span class="string">&#x27;stun:stun3.l.google.com:19302&#x27;</span> &#125;,</span><br><span class="line">                &#123; <span class="attr">urls</span>: <span class="string">&#x27;stun:stun4.l.google.com:19302&#x27;</span> &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">init</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setupMediaDevices</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">setupMediaDevices</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 检查媒体设备权限</span></span><br><span class="line">            <span class="keyword">const</span> devices = <span class="keyword">await</span> navigator.<span class="property">mediaDevices</span>.<span class="title function_">enumerateDevices</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;可用设备:&#x27;</span>, devices);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;设备枚举失败:&#x27;</span>, error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">connectToSignaling</span>(<span class="params">token</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">socket</span> = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">`ws://<span class="subst">$&#123;<span class="variable language_">window</span>.location.host&#125;</span>/ws/webrtc?token=<span class="subst">$&#123;token&#125;</span>`</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="property">onopen</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;WebRTC信令连接已建立&#x27;</span>);</span><br><span class="line">                <span class="title function_">resolve</span>();</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="property">onmessage</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">handleSignalingMessage</span>(<span class="title class_">JSON</span>.<span class="title function_">parse</span>(event.<span class="property">data</span>));</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="property">onerror</span> = <span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;WebRTC信令错误:&#x27;</span>, error);</span><br><span class="line">                <span class="title function_">reject</span>(error);</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="property">onclose</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;WebRTC信令连接已关闭&#x27;</span>);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">cleanup</span>();</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">joinRoom</span>(<span class="params">roomId, userId</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">roomId</span> = roomId;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">userId</span> = userId;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">connectToSignaling</span>(<span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;chat_token&#x27;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 发送加入房间消息</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">sendSignalingMessage</span>(&#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;join-room&#x27;</span>,</span><br><span class="line">            <span class="attr">roomId</span>: roomId,</span><br><span class="line">            <span class="attr">target</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">data</span>: &#123; <span class="attr">userId</span>: userId &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">startVideoCall</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> constraints = &#123;</span><br><span class="line">            <span class="attr">video</span>: options.<span class="property">video</span> !== <span class="literal">false</span> ? &#123;</span><br><span class="line">                <span class="attr">width</span>: &#123; <span class="attr">ideal</span>: <span class="number">1280</span> &#125;,</span><br><span class="line">                <span class="attr">height</span>: &#123; <span class="attr">ideal</span>: <span class="number">720</span> &#125;,</span><br><span class="line">                <span class="attr">frameRate</span>: &#123; <span class="attr">ideal</span>: <span class="number">30</span> &#125;</span><br><span class="line">            &#125; : <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">audio</span>: options.<span class="property">audio</span> !== <span class="literal">false</span></span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">localStream</span> = <span class="keyword">await</span> navigator.<span class="property">mediaDevices</span>.<span class="title function_">getUserMedia</span>(constraints);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">onLocalStream</span>(<span class="variable language_">this</span>.<span class="property">localStream</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 获取房间内其他用户</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">sendSignalingMessage</span>(&#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&#x27;get-users&#x27;</span>,</span><br><span class="line">                <span class="attr">roomId</span>: <span class="variable language_">this</span>.<span class="property">roomId</span>,</span><br><span class="line">                <span class="attr">target</span>: <span class="literal">null</span>,</span><br><span class="line">                <span class="attr">data</span>: &#123;&#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;获取媒体流失败:&#x27;</span>, error);</span><br><span class="line">            <span class="keyword">throw</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">startScreenShare</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> stream = <span class="keyword">await</span> navigator.<span class="property">mediaDevices</span>.<span class="title function_">getDisplayMedia</span>(&#123;</span><br><span class="line">                <span class="attr">video</span>: &#123;</span><br><span class="line">                    <span class="attr">displaySurface</span>: <span class="string">&#x27;monitor&#x27;</span>,</span><br><span class="line">                    <span class="attr">frameRate</span>: &#123; <span class="attr">ideal</span>: <span class="number">30</span> &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">audio</span>: <span class="literal">false</span></span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 替换视频轨道</span></span><br><span class="line">            <span class="keyword">const</span> videoTrack = stream.<span class="title function_">getVideoTracks</span>()[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> (videoTrack) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">replaceVideoTrack</span>(videoTrack);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 监听停止共享</span></span><br><span class="line">            videoTrack.<span class="property">onended</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">restoreCameraVideo</span>();</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> stream;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;屏幕共享失败:&#x27;</span>, error);</span><br><span class="line">            <span class="keyword">throw</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">createPeerConnection</span>(<span class="params">targetUserId</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> pc = <span class="keyword">new</span> <span class="title class_">RTCPeerConnection</span>(<span class="variable language_">this</span>.<span class="property">configuration</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 添加本地流</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">localStream</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">localStream</span>.<span class="title function_">getTracks</span>().<span class="title function_">forEach</span>(<span class="function"><span class="params">track</span> =&gt;</span> &#123;</span><br><span class="line">                pc.<span class="title function_">addTrack</span>(track, <span class="variable language_">this</span>.<span class="property">localStream</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建数据通道</span></span><br><span class="line">        <span class="keyword">const</span> dataChannel = pc.<span class="title function_">createDataChannel</span>(<span class="string">&#x27;chat&#x27;</span>, &#123;</span><br><span class="line">            <span class="attr">ordered</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">maxRetransmits</span>: <span class="number">3</span></span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setupDataChannel</span>(dataChannel, targetUserId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ICE Candidate处理</span></span><br><span class="line">        pc.<span class="property">onicecandidate</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (event.<span class="property">candidate</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">sendSignalingMessage</span>(&#123;</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">&#x27;candidate&#x27;</span>,</span><br><span class="line">                    <span class="attr">target</span>: targetUserId,</span><br><span class="line">                    <span class="attr">data</span>: &#123;</span><br><span class="line">                        <span class="attr">candidate</span>: event.<span class="property">candidate</span>,</span><br><span class="line">                        <span class="attr">sdpMid</span>: event.<span class="property">candidate</span>.<span class="property">sdpMid</span>,</span><br><span class="line">                        <span class="attr">sdpMLineIndex</span>: event.<span class="property">candidate</span>.<span class="property">sdpMLineIndex</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 连接状态变化</span></span><br><span class="line">        pc.<span class="property">onconnectionstatechange</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`与 <span class="subst">$&#123;targetUserId&#125;</span> 的连接状态:`</span>, pc.<span class="property">connectionState</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (pc.<span class="property">connectionState</span> === <span class="string">&#x27;connected&#x27;</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">onPeerConnected</span>(targetUserId);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pc.<span class="property">connectionState</span> === <span class="string">&#x27;disconnected&#x27;</span> || </span><br><span class="line">                       pc.<span class="property">connectionState</span> === <span class="string">&#x27;failed&#x27;</span> || </span><br><span class="line">                       pc.<span class="property">connectionState</span> === <span class="string">&#x27;closed&#x27;</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">cleanupPeerConnection</span>(targetUserId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 远程流到达</span></span><br><span class="line">        pc.<span class="property">ontrack</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">onRemoteStream</span>(targetUserId, event.<span class="property">streams</span>[<span class="number">0</span>]);</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">peerConnections</span>[targetUserId] = pc;</span><br><span class="line">        <span class="keyword">return</span> pc;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">createOffer</span>(<span class="params">targetUserId</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> pc = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">createPeerConnection</span>(targetUserId);</span><br><span class="line">            <span class="keyword">const</span> offer = <span class="keyword">await</span> pc.<span class="title function_">createOffer</span>(&#123;</span><br><span class="line">                <span class="attr">offerToReceiveAudio</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">offerToReceiveVideo</span>: <span class="literal">true</span></span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">await</span> pc.<span class="title function_">setLocalDescription</span>(offer);</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">sendSignalingMessage</span>(&#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&#x27;offer&#x27;</span>,</span><br><span class="line">                <span class="attr">target</span>: targetUserId,</span><br><span class="line">                <span class="attr">data</span>: &#123; <span class="attr">sdp</span>: offer &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;创建Offer失败:&#x27;</span>, error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">handleOffer</span>(<span class="params">fromUserId, sdp</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> pc = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">createPeerConnection</span>(fromUserId);</span><br><span class="line">            <span class="keyword">await</span> pc.<span class="title function_">setRemoteDescription</span>(<span class="keyword">new</span> <span class="title class_">RTCSessionDescription</span>(sdp));</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">const</span> answer = <span class="keyword">await</span> pc.<span class="title function_">createAnswer</span>();</span><br><span class="line">            <span class="keyword">await</span> pc.<span class="title function_">setLocalDescription</span>(answer);</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">sendSignalingMessage</span>(&#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&#x27;answer&#x27;</span>,</span><br><span class="line">                <span class="attr">target</span>: fromUserId,</span><br><span class="line">                <span class="attr">data</span>: &#123; <span class="attr">sdp</span>: answer &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;处理Offer失败:&#x27;</span>, error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">handleAnswer</span>(<span class="params">fromUserId, sdp</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> pc = <span class="variable language_">this</span>.<span class="property">peerConnections</span>[fromUserId];</span><br><span class="line">        <span class="keyword">if</span> (pc) &#123;</span><br><span class="line">            <span class="keyword">await</span> pc.<span class="title function_">setRemoteDescription</span>(<span class="keyword">new</span> <span class="title class_">RTCSessionDescription</span>(sdp));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">handleCandidate</span>(<span class="params">fromUserId, candidate</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> pc = <span class="variable language_">this</span>.<span class="property">peerConnections</span>[fromUserId];</span><br><span class="line">        <span class="keyword">if</span> (pc &amp;&amp; pc.<span class="property">remoteDescription</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">await</span> pc.<span class="title function_">addIceCandidate</span>(<span class="keyword">new</span> <span class="title class_">RTCIceCandidate</span>(candidate));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;添加ICE Candidate失败:&#x27;</span>, error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">setupDataChannel</span>(<span class="params">dataChannel, targetUserId</span>) &#123;</span><br><span class="line">        dataChannel.<span class="property">onopen</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`与 <span class="subst">$&#123;targetUserId&#125;</span> 的数据通道已打开`</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">onDataChannelOpen</span>(targetUserId, dataChannel);</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        dataChannel.<span class="property">onmessage</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> message = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(event.<span class="property">data</span>);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">onDataChannelMessage</span>(targetUserId, message);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;解析数据通道消息失败:&#x27;</span>, error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        dataChannel.<span class="property">onclose</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`与 <span class="subst">$&#123;targetUserId&#125;</span> 的数据通道已关闭`</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">onDataChannelClose</span>(targetUserId);</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">dataChannels</span>[targetUserId] = dataChannel;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">sendDataMessage</span>(<span class="params">targetUserId, message</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> dataChannel = <span class="variable language_">this</span>.<span class="property">dataChannels</span>[targetUserId];</span><br><span class="line">        <span class="keyword">if</span> (dataChannel &amp;&amp; dataChannel.<span class="property">readyState</span> === <span class="string">&#x27;open&#x27;</span>) &#123;</span><br><span class="line">            dataChannel.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(message));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">broadcastDataMessage</span>(<span class="params">message, excludeUserId = <span class="literal">null</span></span>) &#123;</span><br><span class="line">        <span class="title class_">Object</span>.<span class="title function_">entries</span>(<span class="variable language_">this</span>.<span class="property">dataChannels</span>).<span class="title function_">forEach</span>(<span class="function">(<span class="params">[userId, dataChannel]</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (userId !== excludeUserId &amp;&amp; dataChannel.<span class="property">readyState</span> === <span class="string">&#x27;open&#x27;</span>) &#123;</span><br><span class="line">                dataChannel.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(message));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">replaceVideoTrack</span>(<span class="params">newTrack</span>) &#123;</span><br><span class="line">        <span class="title class_">Object</span>.<span class="title function_">values</span>(<span class="variable language_">this</span>.<span class="property">peerConnections</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">pc</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> senders = pc.<span class="title function_">getSenders</span>();</span><br><span class="line">            <span class="keyword">const</span> videoSender = senders.<span class="title function_">find</span>(<span class="function"><span class="params">sender</span> =&gt;</span> </span><br><span class="line">                sender.<span class="property">track</span> &amp;&amp; sender.<span class="property">track</span>.<span class="property">kind</span> === <span class="string">&#x27;video&#x27;</span></span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (videoSender) &#123;</span><br><span class="line">                videoSender.<span class="title function_">replaceTrack</span>(newTrack);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">restoreCameraVideo</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">localStream</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> videoTrack = <span class="variable language_">this</span>.<span class="property">localStream</span>.<span class="title function_">getVideoTracks</span>()[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> (videoTrack) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">replaceVideoTrack</span>(videoTrack);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">toggleVideo</span>(<span class="params">enabled</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">localStream</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> videoTrack = <span class="variable language_">this</span>.<span class="property">localStream</span>.<span class="title function_">getVideoTracks</span>()[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> (videoTrack) &#123;</span><br><span class="line">                videoTrack.<span class="property">enabled</span> = enabled;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 通知其他用户</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">broadcastDataMessage</span>(&#123;</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">&#x27;video-toggle&#x27;</span>,</span><br><span class="line">                    <span class="attr">enabled</span>: enabled</span><br><span class="line">                &#125;, <span class="variable language_">this</span>.<span class="property">userId</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">toggleAudio</span>(<span class="params">enabled</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">localStream</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> audioTrack = <span class="variable language_">this</span>.<span class="property">localStream</span>.<span class="title function_">getAudioTracks</span>()[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> (audioTrack) &#123;</span><br><span class="line">                audioTrack.<span class="property">enabled</span> = enabled;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 通知其他用户</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">broadcastDataMessage</span>(&#123;</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">&#x27;audio-toggle&#x27;</span>,</span><br><span class="line">                    <span class="attr">enabled</span>: enabled</span><br><span class="line">                &#125;, <span class="variable language_">this</span>.<span class="property">userId</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">handleSignalingMessage</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (message.<span class="property">type</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;offer&#x27;</span>:</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">handleOffer</span>(message.<span class="property">sender</span>, message.<span class="property">data</span>.<span class="property">sdp</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;answer&#x27;</span>:</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">handleAnswer</span>(message.<span class="property">sender</span>, message.<span class="property">data</span>.<span class="property">sdp</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;candidate&#x27;</span>:</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">handleCandidate</span>(message.<span class="property">sender</span>, message.<span class="property">data</span>.<span class="property">candidate</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;user-joined&#x27;</span>:</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">onUserJoined</span>(message.<span class="property">sender</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;user-left&#x27;</span>:</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">onUserLeft</span>(message.<span class="property">sender</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;room-users&#x27;</span>:</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">onRoomUsers</span>(message.<span class="property">data</span>.<span class="property">users</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">sendSignalingMessage</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">socket</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="property">readyState</span> === <span class="title class_">WebSocket</span>.<span class="property">OPEN</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">                ...message,</span><br><span class="line">                <span class="attr">sender</span>: <span class="variable language_">this</span>.<span class="property">userId</span></span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">cleanupPeerConnection</span>(<span class="params">userId</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> pc = <span class="variable language_">this</span>.<span class="property">peerConnections</span>[userId];</span><br><span class="line">        <span class="keyword">if</span> (pc) &#123;</span><br><span class="line">            pc.<span class="title function_">close</span>();</span><br><span class="line">            <span class="keyword">delete</span> <span class="variable language_">this</span>.<span class="property">peerConnections</span>[userId];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">delete</span> <span class="variable language_">this</span>.<span class="property">dataChannels</span>[userId];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">onPeerDisconnected</span>(userId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">cleanup</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// 关闭所有Peer连接</span></span><br><span class="line">        <span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="variable language_">this</span>.<span class="property">peerConnections</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">userId</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">cleanupPeerConnection</span>(userId);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 停止本地流</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">localStream</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">localStream</span>.<span class="title function_">getTracks</span>().<span class="title function_">forEach</span>(<span class="function"><span class="params">track</span> =&gt;</span> track.<span class="title function_">stop</span>());</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">localStream</span> = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 关闭WebSocket</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">socket</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="title function_">close</span>();</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">socket</span> = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 离开房间</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">roomId</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">userId</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">sendSignalingMessage</span>(&#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&#x27;leave-room&#x27;</span>,</span><br><span class="line">                <span class="attr">roomId</span>: <span class="variable language_">this</span>.<span class="property">roomId</span>,</span><br><span class="line">                <span class="attr">target</span>: <span class="literal">null</span>,</span><br><span class="line">                <span class="attr">data</span>: &#123;&#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">onCleanup</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 事件回调函数（需要被子类覆盖）</span></span><br><span class="line">    <span class="title function_">onLocalStream</span>(<span class="params">stream</span>) &#123;&#125;</span><br><span class="line">    <span class="title function_">onRemoteStream</span>(<span class="params">userId, stream</span>) &#123;&#125;</span><br><span class="line">    <span class="title function_">onPeerConnected</span>(<span class="params">userId</span>) &#123;&#125;</span><br><span class="line">    <span class="title function_">onPeerDisconnected</span>(<span class="params">userId</span>) &#123;&#125;</span><br><span class="line">    <span class="title function_">onUserJoined</span>(<span class="params">userId</span>) &#123;&#125;</span><br><span class="line">    <span class="title function_">onUserLeft</span>(<span class="params">userId</span>) &#123;&#125;</span><br><span class="line">    <span class="title function_">onRoomUsers</span>(<span class="params">users</span>) &#123;&#125;</span><br><span class="line">    <span class="title function_">onDataChannelOpen</span>(<span class="params">userId, channel</span>) &#123;&#125;</span><br><span class="line">    <span class="title function_">onDataChannelMessage</span>(<span class="params">userId, message</span>) &#123;&#125;</span><br><span class="line">    <span class="title function_">onDataChannelClose</span>(<span class="params">userId</span>) &#123;&#125;</span><br><span class="line">    <span class="title function_">onCleanup</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-2-视频通话UI组件"><a href="#4-2-视频通话UI组件" class="headerlink" title="4.2 视频通话UI组件"></a>4.2 视频通话UI组件</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- video-call.html --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh-CN&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>视频通话<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;css/video-call.css&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;video-call-container&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 本地视频 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;local-video-container&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">video</span> <span class="attr">id</span>=<span class="string">&quot;localVideo&quot;</span> <span class="attr">autoplay</span> <span class="attr">muted</span> <span class="attr">playsinline</span>&gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;local-video-info&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;user-info&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;user-avatar&quot;</span> <span class="attr">id</span>=<span class="string">&quot;localAvatar&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;user-name&quot;</span> <span class="attr">id</span>=<span class="string">&quot;localUsername&quot;</span>&gt;</span>我<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;video-stats&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;stat-item&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-microphone&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;audioStatus&quot;</span>&gt;</span>开启<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;stat-item&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-video&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;videoStatus&quot;</span>&gt;</span>开启<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- 远程视频网格 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;remote-videos-grid&quot;</span> <span class="attr">id</span>=<span class="string">&quot;remoteVideosGrid&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 远程视频将通过JS动态添加 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- 控制栏 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;control-bar&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;control-left&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;control-btn&quot;</span> <span class="attr">id</span>=<span class="string">&quot;toggleAudioBtn&quot;</span> <span class="attr">title</span>=<span class="string">&quot;静音/取消静音&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-microphone&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;control-btn&quot;</span> <span class="attr">id</span>=<span class="string">&quot;toggleVideoBtn&quot;</span> <span class="attr">title</span>=<span class="string">&quot;开启/关闭视频&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-video&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;control-btn&quot;</span> <span class="attr">id</span>=<span class="string">&quot;screenShareBtn&quot;</span> <span class="attr">title</span>=<span class="string">&quot;共享屏幕&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-desktop&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;control-btn&quot;</span> <span class="attr">id</span>=<span class="string">&quot;toggleChatBtn&quot;</span> <span class="attr">title</span>=<span class="string">&quot;显示/隐藏聊天&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-comment&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            </span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;control-center&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;control-btn record-btn&quot;</span> <span class="attr">id</span>=<span class="string">&quot;recordBtn&quot;</span> <span class="attr">title</span>=<span class="string">&quot;开始录制&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-circle&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;control-btn end-call-btn&quot;</span> <span class="attr">id</span>=<span class="string">&quot;endCallBtn&quot;</span> <span class="attr">title</span>=<span class="string">&quot;结束通话&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-phone-slash&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            </span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;control-right&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;control-btn&quot;</span> <span class="attr">id</span>=<span class="string">&quot;settingsBtn&quot;</span> <span class="attr">title</span>=<span class="string">&quot;设置&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-cog&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;control-btn&quot;</span> <span class="attr">id</span>=<span class="string">&quot;toggleFullscreenBtn&quot;</span> <span class="attr">title</span>=<span class="string">&quot;全屏&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-expand&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- 聊天侧边栏 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;chat-sidebar&quot;</span> <span class="attr">id</span>=<span class="string">&quot;chatSidebar&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;chat-header&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h3</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-comments&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 通话聊天<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;close-chat&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-times&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;chat-messages&quot;</span> <span class="attr">id</span>=<span class="string">&quot;callChatMessages&quot;</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 聊天消息 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;chat-input&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;callChatInput&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;输入消息...&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;sendCallMessageBtn&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-paper-plane&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- 通话信息面板 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;call-info-panel&quot;</span> <span class="attr">id</span>=<span class="string">&quot;callInfoPanel&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-info-circle&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 通话信息<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;info-content&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;info-item&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;info-label&quot;</span>&gt;</span>房间ID:<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;info-value&quot;</span> <span class="attr">id</span>=<span class="string">&quot;callRoomId&quot;</span>&gt;</span>-<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;info-item&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;info-label&quot;</span>&gt;</span>参与人数:<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;info-value&quot;</span> <span class="attr">id</span>=<span class="string">&quot;callParticipants&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;info-item&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;info-label&quot;</span>&gt;</span>通话时长:<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;info-value&quot;</span> <span class="attr">id</span>=<span class="string">&quot;callDuration&quot;</span>&gt;</span>00:00<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;info-item&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;info-label&quot;</span>&gt;</span>网络状态:<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;info-value&quot;</span> <span class="attr">id</span>=<span class="string">&quot;networkStatus&quot;</span>&gt;</span>良好<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- 通话邀请模态框 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal-overlay&quot;</span> <span class="attr">id</span>=<span class="string">&quot;inviteModal&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal-header&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h3</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-user-plus&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 邀请加入通话<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;close-modal&quot;</span>&gt;</span><span class="symbol">&amp;times;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal-body&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;user-search&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;inviteUserSearch&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;搜索用户...&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-search&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;user-list&quot;</span> <span class="attr">id</span>=<span class="string">&quot;inviteUserList&quot;</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 用户列表 --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;invite-link&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">p</span>&gt;</span>或分享链接:<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;link-container&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;inviteLink&quot;</span> <span class="attr">readonly</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;copy-link-btn&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-copy&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;js/webrtc.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;js/video-call.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="4-3-视频通话CSS"><a href="#4-3-视频通话CSS" class="headerlink" title="4.3 视频通话CSS"></a>4.3 视频通话CSS</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* video-call.css */</span></span><br><span class="line"><span class="selector-pseudo">:root</span> &#123;</span><br><span class="line">    <span class="attr">--primary-color</span>: <span class="number">#4361ee</span>;</span><br><span class="line">    <span class="attr">--danger-color</span>: <span class="number">#ef476f</span>;</span><br><span class="line">    <span class="attr">--success-color</span>: <span class="number">#06d6a0</span>;</span><br><span class="line">    <span class="attr">--warning-color</span>: <span class="number">#ffd166</span>;</span><br><span class="line">    <span class="attr">--dark-color</span>: <span class="number">#2b2d42</span>;</span><br><span class="line">    <span class="attr">--light-color</span>: <span class="number">#f8f9fa</span>;</span><br><span class="line">    <span class="attr">--video-bg</span>: <span class="number">#000000</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">* &#123;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">box-sizing</span>: border-box;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="attribute">font-family</span>: <span class="string">&#x27;Poppins&#x27;</span>, sans-serif;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--dark-color);</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100vh</span>;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.video-call-container</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">flex-direction</span>: column;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100vh</span>;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 本地视频 */</span></span><br><span class="line"><span class="selector-class">.local-video-container</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">right</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">200px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">5px</span> <span class="number">20px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.3</span>);</span><br><span class="line">    <span class="attribute">z-index</span>: <span class="number">10</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--video-bg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#localVideo</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">object-fit</span>: cover;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.local-video-info</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">bottom</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">right</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(to top, <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.8</span>), transparent);</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-between;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-info</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">10px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-avatar</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">font-weight</span>: bold;</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-name</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.9rem</span>;</span><br><span class="line">    <span class="attribute">font-weight</span>: <span class="number">500</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.video-stats</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">15px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.stat-item</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.8rem</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.8</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 远程视频网格 */</span></span><br><span class="line"><span class="selector-class">.remote-videos-grid</span> &#123;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">display</span>: grid;</span><br><span class="line">    <span class="attribute">grid-template-columns</span>: <span class="built_in">repeat</span>(auto-fit, <span class="built_in">minmax</span>(<span class="number">300px</span>, <span class="number">1</span>fr));</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">overflow-y</span>: auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.remote-video-item</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--video-bg);</span><br><span class="line">    <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">5px</span> <span class="number">15px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.2</span>);</span><br><span class="line">    <span class="attribute">transition</span>: transform <span class="number">0.3s</span> ease;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.remote-video-item</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translateY</span>(-<span class="number">5px</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.remote-video-item</span> <span class="selector-tag">video</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">object-fit</span>: cover;</span><br><span class="line">    <span class="attribute">min-height</span>: <span class="number">200px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.remote-video-info</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">bottom</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">right</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(to top, <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.8</span>), transparent);</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-between;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.remote-user-info</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">10px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.remote-user-avatar</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">font-weight</span>: bold;</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.remote-user-name</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.9rem</span>;</span><br><span class="line">    <span class="attribute">font-weight</span>: <span class="number">500</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.remote-user-status</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--success-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.remote-user-status</span><span class="selector-class">.muted</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--danger-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 控制栏 */</span></span><br><span class="line"><span class="selector-class">.control-bar</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.8</span>);</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">15px</span> <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-between;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    backdrop-<span class="attribute">filter</span>: <span class="built_in">blur</span>(<span class="number">10px</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.control-left</span>,</span><br><span class="line"><span class="selector-class">.control-center</span>,</span><br><span class="line"><span class="selector-class">.control-right</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">15px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.control-btn</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">50px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">50px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">border</span>: none;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.1</span>);</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1.2rem</span>;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">transition</span>: all <span class="number">0.3s</span> ease;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.control-btn</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.2</span>);</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">scale</span>(<span class="number">1.1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.control-btn</span><span class="selector-class">.active</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.control-btn</span><span class="selector-pseudo">:disabled</span> &#123;</span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">0.5</span>;</span><br><span class="line">    <span class="attribute">cursor</span>: not-allowed;</span><br><span class="line">    <span class="attribute">transform</span>: none <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.end-call-btn</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--danger-color);</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">60px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">60px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.end-call-btn</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#d8355f</span>;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">scale</span>(<span class="number">1.1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.record-btn</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--danger-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.record-btn</span><span class="selector-class">.recording</span> &#123;</span><br><span class="line">    <span class="attribute">animation</span>: pulse <span class="number">1.5s</span> infinite;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@keyframes</span> pulse &#123;</span><br><span class="line">    <span class="number">0%</span> &#123; <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="built_in">rgba</span>(<span class="number">239</span>, <span class="number">71</span>, <span class="number">111</span>, <span class="number">0.7</span>); &#125;</span><br><span class="line">    <span class="number">70%</span> &#123; <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">10px</span> <span class="built_in">rgba</span>(<span class="number">239</span>, <span class="number">71</span>, <span class="number">111</span>, <span class="number">0</span>); &#125;</span><br><span class="line">    <span class="number">100%</span> &#123; <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="built_in">rgba</span>(<span class="number">239</span>, <span class="number">71</span>, <span class="number">111</span>, <span class="number">0</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 聊天侧边栏 */</span></span><br><span class="line"><span class="selector-class">.chat-sidebar</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: fixed;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">right</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">350px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">43</span>, <span class="number">45</span>, <span class="number">66</span>, <span class="number">0.95</span>);</span><br><span class="line">    backdrop-<span class="attribute">filter</span>: <span class="built_in">blur</span>(<span class="number">10px</span>);</span><br><span class="line">    <span class="attribute">border-left</span>: <span class="number">1px</span> solid <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.1</span>);</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translateX</span>(<span class="number">100%</span>);</span><br><span class="line">    <span class="attribute">transition</span>: transform <span class="number">0.3s</span> ease;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">flex-direction</span>: column;</span><br><span class="line">    <span class="attribute">z-index</span>: <span class="number">100</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.chat-sidebar</span><span class="selector-class">.show</span> &#123;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translateX</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.chat-header</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.1</span>);</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-between;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.chat-header</span> <span class="selector-tag">h3</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1.2rem</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">10px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.close-chat</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: none;</span><br><span class="line">    <span class="attribute">border</span>: none;</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1.2rem</span>;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.chat-messages</span> &#123;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">overflow-y</span>: auto;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">flex-direction</span>: column;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">15px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.call-message</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">10px</span> <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.1</span>);</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">max-width</span>: <span class="number">80%</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.call-message</span><span class="selector-class">.sent</span> &#123;</span><br><span class="line">    <span class="attribute">align-self</span>: flex-end;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.call-message</span><span class="selector-class">.received</span> &#123;</span><br><span class="line">    <span class="attribute">align-self</span>: flex-start;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.message-sender</span> &#123;</span><br><span class="line">    <span class="attribute">font-weight</span>: <span class="number">500</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.9rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.message-content</span> &#123;</span><br><span class="line">    <span class="attribute">word-break</span>: break-word;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.message-time</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.8rem</span>;</span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">0.7</span>;</span><br><span class="line">    <span class="attribute">margin-top</span>: <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">text-align</span>: right;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.chat-input</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">15px</span> <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">border-top</span>: <span class="number">1px</span> solid <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.1</span>);</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">10px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.chat-input</span> <span class="selector-tag">input</span> &#123;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">10px</span> <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.2</span>);</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.1</span>);</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.9rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.chat-input</span> <span class="selector-tag">input</span><span class="selector-pseudo">:focus</span> &#123;</span><br><span class="line">    <span class="attribute">outline</span>: none;</span><br><span class="line">    <span class="attribute">border-color</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.chat-input</span> <span class="selector-tag">button</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">40px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">40px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">border</span>: none;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 通话信息面板 */</span></span><br><span class="line"><span class="selector-class">.call-info-panel</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.8</span>);</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">20px</span>;</span><br><span class="line">    backdrop-<span class="attribute">filter</span>: <span class="built_in">blur</span>(<span class="number">10px</span>);</span><br><span class="line">    <span class="attribute">z-index</span>: <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.call-info-panel</span> <span class="selector-tag">h4</span> &#123;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.info-content</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">flex-direction</span>: column;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">10px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.info-item</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-between;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.info-label</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.9rem</span>;</span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">0.8</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.info-value</span> &#123;</span><br><span class="line">    <span class="attribute">font-weight</span>: <span class="number">500</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--success-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 邀请模态框 */</span></span><br><span class="line"><span class="selector-class">.modal-overlay</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: fixed;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.7</span>);</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">z-index</span>: <span class="number">1000</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.modal</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--dark-color);</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">90%</span>;</span><br><span class="line">    <span class="attribute">max-width</span>: <span class="number">500px</span>;</span><br><span class="line">    <span class="attribute">max-height</span>: <span class="number">80vh</span>;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">flex-direction</span>: column;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.modal-header</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.1</span>);</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-between;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.modal-body</span> &#123;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">overflow-y</span>: auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-search</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">20px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-search</span> <span class="selector-tag">input</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">10px</span> <span class="number">15px</span> <span class="number">10px</span> <span class="number">40px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.2</span>);</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.1</span>);</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.9rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-search</span> <span class="selector-tag">i</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translateY</span>(-<span class="number">50%</span>);</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.5</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-list</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">flex-direction</span>: column;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">max-height</span>: <span class="number">200px</span>;</span><br><span class="line">    <span class="attribute">overflow-y</span>: auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-list-item</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">10px</span> <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.05</span>);</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">transition</span>: background <span class="number">0.3s</span> ease;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-list-item</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-list-item</span><span class="selector-class">.selected</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">67</span>, <span class="number">97</span>, <span class="number">238</span>, <span class="number">0.2</span>);</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="built_in">var</span>(--primary-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.invite-link</span> <span class="selector-tag">p</span> &#123;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">0.8</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.link-container</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">10px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.link-container</span> <span class="selector-tag">input</span> &#123;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">10px</span> <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.2</span>);</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.1</span>);</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.9rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.copy-link-btn</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">10px</span> <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">border</span>: none;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">var</span>(--primary-color);</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">5px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 全屏样式 */</span></span><br><span class="line"><span class="selector-tag">body</span><span class="selector-class">.fullscreen</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span><span class="selector-class">.fullscreen</span> <span class="selector-class">.local-video-container</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">150px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span><span class="selector-class">.fullscreen</span> <span class="selector-class">.call-info-panel</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: none;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 响应式设计 */</span></span><br><span class="line"><span class="keyword">@media</span> (<span class="attribute">max-width</span>: <span class="number">1024px</span>) &#123;</span><br><span class="line">    <span class="selector-class">.remote-videos-grid</span> &#123;</span><br><span class="line">        <span class="attribute">grid-template-columns</span>: <span class="built_in">repeat</span>(auto-fit, <span class="built_in">minmax</span>(<span class="number">250px</span>, <span class="number">1</span>fr));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="selector-class">.local-video-container</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">250px</span>;</span><br><span class="line">        <span class="attribute">height</span>: <span class="number">150px</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span> (<span class="attribute">max-width</span>: <span class="number">768px</span>) &#123;</span><br><span class="line">    <span class="selector-class">.remote-videos-grid</span> &#123;</span><br><span class="line">        <span class="attribute">grid-template-columns</span>: <span class="number">1</span>fr;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="selector-class">.local-video-container</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">150px</span>;</span><br><span class="line">        <span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line">        <span class="attribute">top</span>: <span class="number">10px</span>;</span><br><span class="line">        <span class="attribute">right</span>: <span class="number">10px</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="selector-class">.call-info-panel</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">250px</span>;</span><br><span class="line">        <span class="attribute">padding</span>: <span class="number">15px</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="selector-class">.control-bar</span> &#123;</span><br><span class="line">        <span class="attribute">padding</span>: <span class="number">10px</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="selector-class">.control-btn</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">40px</span>;</span><br><span class="line">        <span class="attribute">height</span>: <span class="number">40px</span>;</span><br><span class="line">        <span class="attribute">font-size</span>: <span class="number">1rem</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="selector-class">.end-call-btn</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">50px</span>;</span><br><span class="line">        <span class="attribute">height</span>: <span class="number">50px</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="selector-class">.chat-sidebar</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-消息队列集成"><a href="#5-消息队列集成" class="headerlink" title="5. 消息队列集成"></a>5. 消息队列集成</h2><h3 id="5-1-Kafka配置"><a href="#5-1-Kafka配置" class="headerlink" title="5.1 Kafka配置"></a>5.1 Kafka配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.mq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.admin.NewTopic;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.kafka.config.TopicBuilder;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KafkaConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> NewTopic <span class="title function_">chatMessagesTopic</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> TopicBuilder.name(<span class="string">&quot;chat.messages&quot;</span>)</span><br><span class="line">                .partitions(<span class="number">3</span>)</span><br><span class="line">                .replicas(<span class="number">2</span>)</span><br><span class="line">                .config(<span class="string">&quot;retention.ms&quot;</span>, <span class="string">&quot;604800000&quot;</span>) <span class="comment">// 7天</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> NewTopic <span class="title function_">chatNotificationsTopic</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> TopicBuilder.name(<span class="string">&quot;chat.notifications&quot;</span>)</span><br><span class="line">                .partitions(<span class="number">2</span>)</span><br><span class="line">                .replicas(<span class="number">2</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> NewTopic <span class="title function_">chatEventsTopic</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> TopicBuilder.name(<span class="string">&quot;chat.events&quot;</span>)</span><br><span class="line">                .partitions(<span class="number">5</span>)</span><br><span class="line">                .replicas(<span class="number">2</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> NewTopic <span class="title function_">chatPresenceTopic</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> TopicBuilder.name(<span class="string">&quot;chat.presence&quot;</span>)</span><br><span class="line">                .partitions(<span class="number">2</span>)</span><br><span class="line">                .replicas(<span class="number">2</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-2-Kafka生产者"><a href="#5-2-Kafka生产者" class="headerlink" title="5.2 Kafka生产者"></a>5.2 Kafka生产者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.mq.producer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.chatroom.dto.ChatMessageDTO;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.kafka.core.KafkaTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatMessageProducer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(ChatMessageDTO message)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> objectMapper.writeValueAsString(message);</span><br><span class="line">            kafkaTemplate.send(<span class="string">&quot;chat.messages&quot;</span>, message.getRoomId(), payload);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 发送事件</span></span><br><span class="line">            sendEvent(<span class="string">&quot;message.sent&quot;</span>, Map.of(</span><br><span class="line">                <span class="string">&quot;messageId&quot;</span>, message.getId(),</span><br><span class="line">                <span class="string">&quot;sender&quot;</span>, message.getSender(),</span><br><span class="line">                <span class="string">&quot;roomId&quot;</span>, message.getRoomId(),</span><br><span class="line">                <span class="string">&quot;timestamp&quot;</span>, message.getTimestamp()</span><br><span class="line">            ));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to serialize message&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendNotification</span><span class="params">(String userId, String type, Object data)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Map&lt;String, Object&gt; notification = Map.of(</span><br><span class="line">                <span class="string">&quot;userId&quot;</span>, userId,</span><br><span class="line">                <span class="string">&quot;type&quot;</span>, type,</span><br><span class="line">                <span class="string">&quot;data&quot;</span>, data,</span><br><span class="line">                <span class="string">&quot;timestamp&quot;</span>, System.currentTimeMillis()</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> objectMapper.writeValueAsString(notification);</span><br><span class="line">            kafkaTemplate.send(<span class="string">&quot;chat.notifications&quot;</span>, userId, payload);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to serialize notification&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendEvent</span><span class="params">(String eventType, Map&lt;String, Object&gt; data)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Map&lt;String, Object&gt; event = Map.of(</span><br><span class="line">                <span class="string">&quot;type&quot;</span>, eventType,</span><br><span class="line">                <span class="string">&quot;data&quot;</span>, data,</span><br><span class="line">                <span class="string">&quot;timestamp&quot;</span>, System.currentTimeMillis(),</span><br><span class="line">                <span class="string">&quot;service&quot;</span>, <span class="string">&quot;chat-service&quot;</span></span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> objectMapper.writeValueAsString(event);</span><br><span class="line">            kafkaTemplate.send(<span class="string">&quot;chat.events&quot;</span>, eventType, payload);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to serialize event&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updatePresence</span><span class="params">(String userId, String status)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Map&lt;String, Object&gt; presence = Map.of(</span><br><span class="line">                <span class="string">&quot;userId&quot;</span>, userId,</span><br><span class="line">                <span class="string">&quot;status&quot;</span>, status,</span><br><span class="line">                <span class="string">&quot;timestamp&quot;</span>, System.currentTimeMillis()</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> objectMapper.writeValueAsString(presence);</span><br><span class="line">            kafkaTemplate.send(<span class="string">&quot;chat.presence&quot;</span>, userId, payload);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to serialize presence&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-3-Kafka消费者"><a href="#5-3-Kafka消费者" class="headerlink" title="5.3 Kafka消费者"></a>5.3 Kafka消费者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.chatroom.mq.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.chatroom.service.MessageService;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.kafka.annotation.KafkaListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatMessageConsumer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MessageService messageService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@KafkaListener(topics = &quot;chat.messages&quot;, groupId = &quot;chat-service&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">consumeMessage</span><span class="params">(String payload)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Map&lt;String, Object&gt; message = objectMapper.readValue(payload, Map.class);</span><br><span class="line">            <span class="comment">// 处理消息逻辑</span></span><br><span class="line">            processIncomingMessage(message);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Failed to process message: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@KafkaListener(topics = &quot;chat.notifications&quot;, groupId = &quot;notification-service&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">consumeNotification</span><span class="params">(String payload)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Map&lt;String, Object&gt; notification = objectMapper.readValue(payload, Map.class);</span><br><span class="line">            <span class="comment">// 处理通知逻辑</span></span><br><span class="line">            processNotification(notification);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Failed to process notification: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processIncomingMessage</span><span class="params">(Map&lt;String, Object&gt; message)</span> &#123;</span><br><span class="line">        <span class="comment">// 消息处理逻辑</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Processing message: &quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processNotification</span><span class="params">(Map&lt;String, Object&gt; notification)</span> &#123;</span><br><span class="line">        <span class="comment">// 通知处理逻辑</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Processing notification: &quot;</span> + notification);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="6-实时协作白板"><a href="#6-实时协作白板" class="headerlink" title="6. 实时协作白板"></a>6. 实时协作白板</h2><h3 id="6-1-白板后端"><a href="#6-1-白板后端" class="headerlink" title="6.1 白板后端"></a>6.1 白板后端</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.whiteboard;</span><br><span class="line"></span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line">import org.springframework.web.socket.*;</span><br><span class="line">import org.springframework.web.socket.handler.TextWebSocketHandler;</span><br><span class="line"></span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">public class WhiteboardHandler extends TextWebSocketHandler &#123;</span><br><span class="line">    </span><br><span class="line">    private final Map&lt;String, WhiteboardSession&gt; sessions = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    private final Map&lt;String, WhiteboardRoom&gt; rooms = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void afterConnectionEstablished(WebSocketSession session) throws Exception &#123;</span><br><span class="line">        String whiteboardId = getWhiteboardId(session);</span><br><span class="line">        String userId = getUserId(session);</span><br><span class="line">        </span><br><span class="line">        WhiteboardSession ws = new WhiteboardSession(session, userId);</span><br><span class="line">        sessions.put(whiteboardId, ws);</span><br><span class="line">        </span><br><span class="line">        System.out.println(&quot;白板连接建立: &quot; + whiteboardId + &quot;, 用户: &quot; + userId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    protected void handleTextMessage(WebSocketSession session, TextMessage message) throws Exception &#123;</span><br><span class="line">        String whiteboardId = getWhiteboardId(session);</span><br><span class="line">        String userId = getUserId(session);</span><br><span class="line">        </span><br><span class="line">        WhiteboardMessage wbMessage = WhiteboardMessage.fromJson(message.getPayload());</span><br><span class="line">        </span><br><span class="line">        switch (wbMessage.getType()) &#123;</span><br><span class="line">            case &quot;join&quot;:</span><br><span class="line">                joinWhiteboard(whiteboardId, userId, wbMessage);</span><br><span class="line">                break;</span><br><span class="line">                </span><br><span class="line">            case &quot;draw&quot;:</span><br><span class="line">            case &quot;erase&quot;:</span><br><span class="line">            case &quot;clear&quot;:</span><br><span class="line">            case &quot;undo&quot;:</span><br><span class="line">            case &quot;redo&quot;:</span><br><span class="line">                broadcastToWhiteboard(whiteboardId, userId, wbMessage);</span><br><span class="line">                break;</span><br><span class="line">                </span><br><span class="line">            case &quot;cursor&quot;:</span><br><span class="line">                broadcastCursor(whiteboardId, userId, wbMessage);</span><br><span class="line">                break;</span><br><span class="line">                </span><br><span class="line">            case &quot;sync&quot;:</span><br><span class="line">                syncWhiteboard(whiteboardId, userId);</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void joinWhiteboard(String whiteboardId, String userId, WhiteboardMessage message) &#123;</span><br><span class="line">        WhiteboardRoom room = rooms.computeIfAbsent(whiteboardId, id -&gt; new WhiteboardRoom(id));</span><br><span class="line">        room.addUser(userId);</span><br><span class="line">        </span><br><span class="line">        // 发送历史数据</span><br><span class="line">        WhiteboardSession session = sessions.get(whiteboardId);</span><br><span class="line">        if (session != null) &#123;</span><br><span class="line">            WhiteboardMessage syncMessage = new WhiteboardMessage();</span><br><span class="line">            syncMessage.setType(&quot;sync-response&quot;);</span><br><span class="line">            syncMessage.setData(Map.of(&quot;history&quot;, room.getHistory()));</span><br><span class="line">            </span><br><span class="line">            try &#123;</span><br><span class="line">                session.getWebSocketSession().sendMessage(</span><br><span class="line">                    new TextMessage(syncMessage.toJson())</span><br><span class="line">                );</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 通知其他用户</span><br><span class="line">        WhiteboardMessage joinMessage = new WhiteboardMessage();</span><br><span class="line">        joinMessage.setType(&quot;user-joined&quot;);</span><br><span class="line">        joinMessage.setData(Map.of(&quot;userId&quot;, userId));</span><br><span class="line">        </span><br><span class="line">        broadcastToWhiteboard(whiteboardId, userId, joinMessage);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void broadcastToWhiteboard(String whiteboardId, String senderId, WhiteboardMessage message) &#123;</span><br><span class="line">        WhiteboardRoom room = rooms.get(whiteboardId);</span><br><span class="line">        if (room != null) &#123;</span><br><span class="line">            // 保存到历史</span><br><span class="line">            if (shouldSaveToHistory(message.getType())) &#123;</span><br><span class="line">                room.addToHistory(message);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 广播给其他用户</span><br><span class="line">            room.getUsers().forEach(userId -&gt; &#123;</span><br><span class="line">                if (!userId.equals(senderId)) &#123;</span><br><span class="line">                    WhiteboardSession session = sessions.values().stream()</span><br><span class="line">                        .filter(s -&gt; userId.equals(s.getUserId()))</span><br><span class="line">                        .findFirst()</span><br><span class="line">                        .orElse(null);</span><br><span class="line">                    </span><br><span class="line">                    if (session != null &amp;&amp; session.getWebSocketSession().isOpen()) &#123;</span><br><span class="line">                        try &#123;</span><br><span class="line">                            session.getWebSocketSession().sendMessage(</span><br><span class="line">                                new TextMessage(message.toJson())</span><br><span class="line">                            );</span><br><span class="line">                        &#125; catch (Exception e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void broadcastCursor(String whiteboardId, String userId, WhiteboardMessage message) &#123;</span><br><span class="line">        WhiteboardRoom room = rooms.get(whiteboardId);</span><br><span class="line">        if (room != null) &#123;</span><br><span class="line">            WhiteboardMessage cursorMessage = new WhiteboardMessage();</span><br><span class="line">            cursorMessage.setType(&quot;cursor-update&quot;);</span><br><span class="line">            cursorMessage.setData(Map.of(</span><br><span class="line">                &quot;userId&quot;, userId,</span><br><span class="line">                &quot;position&quot;, message.getData().get(&quot;position&quot;)</span><br><span class="line">            ));</span><br><span class="line">            </span><br><span class="line">            broadcastToWhiteboard(whiteboardId, userId, cursorMessage);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void syncWhiteboard(String whiteboardId, String userId) &#123;</span><br><span class="line">        WhiteboardRoom room = rooms.get(whiteboardId);</span><br><span class="line">        if (room != null) &#123;</span><br><span class="line">            WhiteboardSession session = sessions.values().stream()</span><br><span class="line">                .filter(s -&gt; userId.equals(s.getUserId()))</span><br><span class="line">                .findFirst()</span><br><span class="line">                .orElse(null);</span><br><span class="line">            </span><br><span class="line">            if (session != null) &#123;</span><br><span class="line">                WhiteboardMessage syncMessage = new WhiteboardMessage();</span><br><span class="line">                syncMessage.setType(&quot;sync-response&quot;);</span><br><span class="line">                syncMessage.setData(Map.of(&quot;history&quot;, room.getHistory()));</span><br><span class="line">                </span><br><span class="line">                try &#123;</span><br><span class="line">                    session.getWebSocketSession().sendMessage(</span><br><span class="line">                        new TextMessage(syncMessage.toJson())</span><br><span class="line">                    );</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private boolean shouldSaveToHistory(String type) &#123;</span><br><span class="line">        return !type.equals(&quot;cursor&quot;) &amp;&amp; !type.equals(&quot;cursor-update&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private String getWhiteboardId(WebSocketSession session) &#123;</span><br><span class="line">        Map&lt;String, Object&gt; attributes = session.getAttributes();</span><br><span class="line">        return attributes.get(&quot;whiteboardId&quot;).toString();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private String getUserId(WebSocketSession session) &#123;</span><br><span class="line">        Map&lt;String, Object&gt; attributes = session.getAttributes();</span><br><span class="line">        return attributes.get(&quot;userId&quot;).toString();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void afterConnectionClosed(WebSocketSession session, CloseStatus status) throws Exception &#123;</span><br><span class="line">        String whiteboardId = getWhiteboardId(session);</span><br><span class="line">        String userId = getUserId(session);</span><br><span class="line">        </span><br><span class="line">        sessions.remove(whiteboardId);</span><br><span class="line">        </span><br><span class="line">        WhiteboardRoom room = rooms.get(whiteboardId);</span><br><span class="line">        if (room != null) &#123;</span><br><span class="line">            room.removeUser(userId);</span><br><span class="line">            </span><br><span class="line">            // 通知其他用户</span><br><span class="line">            WhiteboardMessage leaveMessage = new WhiteboardMessage();</span><br><span class="line">            leaveMessage.setType(&quot;user-left&quot;);</span><br><span class="line">            leaveMessage.setData(Map.of(&quot;userId&quot;, userId));</span><br><span class="line">            </span><br><span class="line">            broadcastToWhiteboard(whiteboardId, userId, leaveMessage);</span><br><span class="line">            </span><br><span class="line">            // 如果没有用户，清理房间</span><br><span class="line">            if (room.getUsers().isEmpty()) &#123;</span><br><span class="line">                rooms.remove(whiteboardId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        System.out.println(&quot;白板连接关闭: &quot; + whiteboardId + &quot;, 用户: &quot; + userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="7-Kubernetes部署配置"><a href="#7-Kubernetes部署配置" class="headerlink" title="7. Kubernetes部署配置"></a>7. Kubernetes部署配置</h2><h3 id="7-1-Kubernetes部署文件"><a href="#7-1-Kubernetes部署文件" class="headerlink" title="7.1 Kubernetes部署文件"></a>7.1 Kubernetes部署文件</h3><p>yaml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br></pre></td><td class="code"><pre><span class="line"># k8s/namespace.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: chat-system</span><br><span class="line">---</span><br><span class="line"># k8s/config-map.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: chat-config</span><br><span class="line">  namespace: chat-system</span><br><span class="line">data:</span><br><span class="line">  application.yml: |</span><br><span class="line">    spring:</span><br><span class="line">      application:</span><br><span class="line">        name: chat-service</span><br><span class="line">      datasource:</span><br><span class="line">        url: jdbc:mysql://mysql-chat:3306/chat_room</span><br><span class="line">        username: $&#123;DB_USERNAME&#125;</span><br><span class="line">        password: $&#123;DB_PASSWORD&#125;</span><br><span class="line">      redis:</span><br><span class="line">        host: redis-chat</span><br><span class="line">        port: 6379</span><br><span class="line">      kafka:</span><br><span class="line">        bootstrap-servers: kafka-chat:9092</span><br><span class="line">    app:</span><br><span class="line">      jwt:</span><br><span class="line">        secret: $&#123;JWT_SECRET&#125;</span><br><span class="line">      file:</span><br><span class="line">        upload-dir: /app/uploads</span><br><span class="line">---</span><br><span class="line"># k8s/secret.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: chat-secrets</span><br><span class="line">  namespace: chat-system</span><br><span class="line">type: Opaque</span><br><span class="line">data:</span><br><span class="line">  db-username: Y2hhdF91c2Vy</span><br><span class="line">  db-password: Y2hhdDEyMzQ1</span><br><span class="line">  jwt-secret: eW91ci1zdXBlci1zZWNyZXQta2V5LWNoYW5nZS10aGlzLWluLXByb2R1Y3Rpb24=</span><br><span class="line">---</span><br><span class="line"># k8s/mysql.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-chat</span><br><span class="line">  namespace: chat-system</span><br><span class="line">spec:</span><br><span class="line">  serviceName: mysql-chat</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: mysql-chat</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: mysql-chat</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: mysql</span><br><span class="line">        image: mysql:8.0</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 3306</span><br><span class="line">        env:</span><br><span class="line">        - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">          valueFrom:</span><br><span class="line">            secretKeyRef:</span><br><span class="line">              name: chat-secrets</span><br><span class="line">              key: db-password</span><br><span class="line">        - name: MYSQL_DATABASE</span><br><span class="line">          value: &quot;chat_room&quot;</span><br><span class="line">        - name: MYSQL_USER</span><br><span class="line">          valueFrom:</span><br><span class="line">            secretKeyRef:</span><br><span class="line">              name: chat-secrets</span><br><span class="line">              key: db-username</span><br><span class="line">        - name: MYSQL_PASSWORD</span><br><span class="line">          valueFrom:</span><br><span class="line">            secretKeyRef:</span><br><span class="line">              name: chat-secrets</span><br><span class="line">              key: db-password</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: mysql-data</span><br><span class="line">          mountPath: /var/lib/mysql</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: &quot;512Mi&quot;</span><br><span class="line">            cpu: &quot;250m&quot;</span><br><span class="line">          limits:</span><br><span class="line">            memory: &quot;1Gi&quot;</span><br><span class="line">            cpu: &quot;500m&quot;</span><br><span class="line">        livenessProbe:</span><br><span class="line">          exec:</span><br><span class="line">            command: [&quot;mysqladmin&quot;, &quot;ping&quot;, &quot;-h&quot;, &quot;localhost&quot;]</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        readinessProbe:</span><br><span class="line">          exec:</span><br><span class="line">            command: [&quot;mysql&quot;, &quot;-h&quot;, &quot;localhost&quot;, &quot;-u&quot;, &quot;root&quot;, &quot;-p$&#123;MYSQL_ROOT_PASSWORD&#125;&quot;, &quot;-e&quot;, &quot;SELECT 1&quot;]</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          periodSeconds: 2</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">      volumes:</span><br><span class="line">      - name: mysql-data</span><br><span class="line">        persistentVolumeClaim:</span><br><span class="line">          claimName: mysql-pvc</span><br><span class="line">---</span><br><span class="line"># k8s/redis.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: redis-chat</span><br><span class="line">  namespace: chat-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: redis-chat</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: redis-chat</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: redis</span><br><span class="line">        image: redis:7-alpine</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 6379</span><br><span class="line">        command: [&quot;redis-server&quot;, &quot;--appendonly&quot;, &quot;yes&quot;]</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: &quot;256Mi&quot;</span><br><span class="line">            cpu: &quot;100m&quot;</span><br><span class="line">          limits:</span><br><span class="line">            memory: &quot;512Mi&quot;</span><br><span class="line">            cpu: &quot;200m&quot;</span><br><span class="line">        livenessProbe:</span><br><span class="line">          exec:</span><br><span class="line">            command: [&quot;redis-cli&quot;, &quot;ping&quot;]</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">        readinessProbe:</span><br><span class="line">          exec:</span><br><span class="line">            command: [&quot;redis-cli&quot;, &quot;ping&quot;]</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          periodSeconds: 2</span><br><span class="line">---</span><br><span class="line"># k8s/kafka.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: kafka-chat</span><br><span class="line">  namespace: chat-system</span><br><span class="line">spec:</span><br><span class="line">  serviceName: kafka-chat</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: kafka-chat</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: kafka-chat</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kafka</span><br><span class="line">        image: confluentinc/cp-kafka:latest</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9092</span><br><span class="line">        env:</span><br><span class="line">        - name: KAFKA_BROKER_ID</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.name</span><br><span class="line">        - name: KAFKA_ZOOKEEPER_CONNECT</span><br><span class="line">          value: &quot;zookeeper-chat:2181&quot;</span><br><span class="line">        - name: KAFKA_ADVERTISED_LISTENERS</span><br><span class="line">          value: &quot;PLAINTEXT://$(POD_NAME).kafka-chat.chat-system.svc.cluster.local:9092&quot;</span><br><span class="line">        - name: KAFKA_LISTENER_SECURITY_PROTOCOL_MAP</span><br><span class="line">          value: &quot;PLAINTEXT:PLAINTEXT&quot;</span><br><span class="line">        - name: KAFKA_INTER_BROKER_LISTENER_NAME</span><br><span class="line">          value: &quot;PLAINTEXT&quot;</span><br><span class="line">        - name: KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR</span><br><span class="line">          value: &quot;3&quot;</span><br><span class="line">        - name: POD_NAME</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.name</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: &quot;512Mi&quot;</span><br><span class="line">            cpu: &quot;250m&quot;</span><br><span class="line">          limits:</span><br><span class="line">            memory: &quot;1Gi&quot;</span><br><span class="line">            cpu: &quot;500m&quot;</span><br><span class="line">        livenessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 9092</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">---</span><br><span class="line"># k8s/gateway.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: gateway</span><br><span class="line">  namespace: chat-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: gateway</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: gateway</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: gateway</span><br><span class="line">        image: chat/gateway:latest</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">        env:</span><br><span class="line">        - name: SPRING_PROFILES_ACTIVE</span><br><span class="line">          value: &quot;kubernetes&quot;</span><br><span class="line">        - name: JWT_SECRET</span><br><span class="line">          valueFrom:</span><br><span class="line">            secretKeyRef:</span><br><span class="line">              name: chat-secrets</span><br><span class="line">              key: jwt-secret</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: &quot;256Mi&quot;</span><br><span class="line">            cpu: &quot;100m&quot;</span><br><span class="line">          limits:</span><br><span class="line">            memory: &quot;512Mi&quot;</span><br><span class="line">            cpu: &quot;200m&quot;</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /actuator/health</span><br><span class="line">            port: 8080</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /actuator/health/readiness</span><br><span class="line">            port: 8080</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          periodSeconds: 5</span><br><span class="line">---</span><br><span class="line"># k8s/service.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: gateway-service</span><br><span class="line">  namespace: chat-system</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: gateway</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  type: LoadBalancer</span><br><span class="line">---</span><br><span class="line"># k8s/hpa.yaml</span><br><span class="line">apiVersion: autoscaling/v2</span><br><span class="line">kind: HorizontalPodAutoscaler</span><br><span class="line">metadata:</span><br><span class="line">  name: gateway-hpa</span><br><span class="line">  namespace: chat-system</span><br><span class="line">spec:</span><br><span class="line">  scaleTargetRef:</span><br><span class="line">    apiVersion: apps/v1</span><br><span class="line">    kind: Deployment</span><br><span class="line">    name: gateway</span><br><span class="line">  minReplicas: 2</span><br><span class="line">  maxReplicas: 10</span><br><span class="line">  metrics:</span><br><span class="line">  - type: Resource</span><br><span class="line">    resource:</span><br><span class="line">      name: cpu</span><br><span class="line">      target:</span><br><span class="line">        type: Utilization</span><br><span class="line">        averageUtilization: 70</span><br><span class="line">  - type: Resource</span><br><span class="line">    resource:</span><br><span class="line">      name: memory</span><br><span class="line">      target:</span><br><span class="line">        type: Utilization</span><br><span class="line">        averageUtilization: 80</span><br></pre></td></tr></table></figure>



<h3 id="7-2-Helm-Chart"><a href="#7-2-Helm-Chart" class="headerlink" title="7.2 Helm Chart"></a>7.2 Helm Chart</h3><p>yaml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"># helm/chat-room/Chart.yaml</span><br><span class="line">apiVersion: v2</span><br><span class="line">name: chat-room</span><br><span class="line">description: A Helm chart for deploying Chat Room microservices</span><br><span class="line">type: application</span><br><span class="line">version: 1.0.0</span><br><span class="line">appVersion: &quot;1.0.0&quot;</span><br><span class="line"></span><br><span class="line"># helm/chat-room/values.yaml</span><br><span class="line">replicaCount: 2</span><br><span class="line"></span><br><span class="line">image:</span><br><span class="line">  repository: chat</span><br><span class="line">  pullPolicy: IfNotPresent</span><br><span class="line">  tag: &quot;latest&quot;</span><br><span class="line"></span><br><span class="line">imagePullSecrets: []</span><br><span class="line">nameOverride: &quot;&quot;</span><br><span class="line">fullnameOverride: &quot;&quot;</span><br><span class="line"></span><br><span class="line">service:</span><br><span class="line">  type: LoadBalancer</span><br><span class="line">  port: 80</span><br><span class="line"></span><br><span class="line">ingress:</span><br><span class="line">  enabled: true</span><br><span class="line">  className: &quot;nginx&quot;</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: nginx</span><br><span class="line">    cert-manager.io/cluster-issuer: &quot;letsencrypt-prod&quot;</span><br><span class="line">  hosts:</span><br><span class="line">    - host: chat.example.com</span><br><span class="line">      paths:</span><br><span class="line">        - path: /</span><br><span class="line">          pathType: Prefix</span><br><span class="line">  tls:</span><br><span class="line">   - secretName: chat-tls</span><br><span class="line">     hosts:</span><br><span class="line">       - chat.example.com</span><br><span class="line"></span><br><span class="line">resources:</span><br><span class="line">  limits:</span><br><span class="line">    cpu: 200m</span><br><span class="line">    memory: 512Mi</span><br><span class="line">  requests:</span><br><span class="line">    cpu: 100m</span><br><span class="line">    memory: 256Mi</span><br><span class="line"></span><br><span class="line">autoscaling:</span><br><span class="line">  enabled: true</span><br><span class="line">  minReplicas: 2</span><br><span class="line">  maxReplicas: 10</span><br><span class="line">  targetCPUUtilizationPercentage: 70</span><br><span class="line">  targetMemoryUtilizationPercentage: 80</span><br><span class="line"></span><br><span class="line">nodeSelector: &#123;&#125;</span><br><span class="line"></span><br><span class="line">tolerations: []</span><br><span class="line"></span><br><span class="line">affinity: &#123;&#125;</span><br><span class="line"></span><br><span class="line">config:</span><br><span class="line">  mysql:</span><br><span class="line">    host: mysql-chat</span><br><span class="line">    port: 3306</span><br><span class="line">    database: chat_room</span><br><span class="line">    username: chat_user</span><br><span class="line">    password: chat123</span><br><span class="line">  redis:</span><br><span class="line">    host: redis-chat</span><br><span class="line">    port: 6379</span><br><span class="line">  kafka:</span><br><span class="line">    bootstrapServers: kafka-chat:9092</span><br><span class="line">  jwt:</span><br><span class="line">    secret: your-super-secret-jwt-key</span><br><span class="line">    expiration: 86400000</span><br></pre></td></tr></table></figure>



<h2 id="8-监控和告警"><a href="#8-监控和告警" class="headerlink" title="8. 监控和告警"></a>8. 监控和告警</h2><h3 id="8-1-Prometheus配置"><a href="#8-1-Prometheus配置" class="headerlink" title="8.1 Prometheus配置"></a>8.1 Prometheus配置</h3><p>yaml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># monitoring/prometheus.yml</span><br><span class="line">global:</span><br><span class="line">  scrape_interval: 15s</span><br><span class="line">  evaluation_interval: 15s</span><br><span class="line"></span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">    - static_configs:</span><br><span class="line">        - targets: [&#x27;alertmanager:9093&#x27;]</span><br><span class="line"></span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;rules/*.yml&quot;</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &#x27;kubernetes-pods&#x27;</span><br><span class="line">    kubernetes_sd_configs:</span><br><span class="line">      - role: pod</span><br><span class="line">    relabel_configs:</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: true</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __metrics_path__</span><br><span class="line">        regex: (.+)</span><br><span class="line">      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><br><span class="line">        action: replace</span><br><span class="line">        regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">        replacement: $1:$2</span><br><span class="line">        target_label: __address__</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_namespace</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_pod_name</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;chat-services&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - &#x27;gateway-service.chat-system:8080&#x27;</span><br><span class="line">        - &#x27;auth-service.chat-system:8080&#x27;</span><br><span class="line">        - &#x27;chat-service.chat-system:8080&#x27;</span><br><span class="line">        - &#x27;user-service.chat-system:8080&#x27;</span><br><span class="line">        - &#x27;file-service.chat-system:8080&#x27;</span><br><span class="line">        - &#x27;notification-service.chat-system:8080&#x27;</span><br></pre></td></tr></table></figure>



<h3 id="8-2-Grafana仪表板"><a href="#8-2-Grafana仪表板" class="headerlink" title="8.2 Grafana仪表板"></a>8.2 Grafana仪表板</h3><p>json</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;dashboard&quot;: &#123;</span><br><span class="line">    &quot;title&quot;: &quot;Chat Room Dashboard&quot;,</span><br><span class="line">    &quot;panels&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;title&quot;: &quot;API请求率&quot;,</span><br><span class="line">        &quot;targets&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;expr&quot;: &quot;rate(http_server_requests_seconds_count[5m])&quot;,</span><br><span class="line">            &quot;legendFormat&quot;: &quot;&#123;&#123;method&#125;&#125; &#123;&#123;uri&#125;&#125; &#123;&#123;status&#125;&#125;&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;type&quot;: &quot;graph&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;title&quot;: &quot;JVM内存使用&quot;,</span><br><span class="line">        &quot;targets&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;expr&quot;: &quot;jvm_memory_used_bytes&#123;area=\&quot;heap\&quot;&#125;&quot;,</span><br><span class="line">            &quot;legendFormat&quot;: &quot;&#123;&#123;instance&#125;&#125; &#123;&#123;area&#125;&#125;&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;type&quot;: &quot;graph&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;title&quot;: &quot;在线用户数&quot;,</span><br><span class="line">        &quot;targets&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;expr&quot;: &quot;chat_users_online_total&quot;,</span><br><span class="line">            &quot;legendFormat&quot;: &quot;在线用户&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;type&quot;: &quot;stat&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;title&quot;: &quot;消息处理延迟&quot;,</span><br><span class="line">        &quot;targets&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;expr&quot;: &quot;histogram_quantile(0.95, rate(chat_message_processing_duration_seconds_bucket[5m]))&quot;,</span><br><span class="line">            &quot;legendFormat&quot;: &quot;P95延迟&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;type&quot;: &quot;graph&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;title&quot;: &quot;WebSocket连接数&quot;,</span><br><span class="line">        &quot;targets&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;expr&quot;: &quot;chat_websocket_connections&quot;,</span><br><span class="line">            &quot;legendFormat&quot;: &quot;活跃连接&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;type&quot;: &quot;graph&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;title&quot;: &quot;数据库连接池&quot;,</span><br><span class="line">        &quot;targets&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;expr&quot;: &quot;hikaricp_connections_active&quot;,</span><br><span class="line">            &quot;legendFormat&quot;: &quot;活跃连接&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;expr&quot;: &quot;hikaricp_connections_idle&quot;,</span><br><span class="line">            &quot;legendFormat&quot;: &quot;空闲连接&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;type&quot;: &quot;graph&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="9-CI-CD流水线"><a href="#9-CI-CD流水线" class="headerlink" title="9. CI&#x2F;CD流水线"></a>9. CI&#x2F;CD流水线</h2><h3 id="9-1-GitLab-CI配置"><a href="#9-1-GitLab-CI配置" class="headerlink" title="9.1 GitLab CI配置"></a>9.1 GitLab CI配置</h3><p>yaml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"># .gitlab-ci.yml</span><br><span class="line">stages:</span><br><span class="line">  - build</span><br><span class="line">  - test</span><br><span class="line">  - scan</span><br><span class="line">  - package</span><br><span class="line">  - deploy</span><br><span class="line"></span><br><span class="line">variables:</span><br><span class="line">  MAVEN_OPTS: &quot;-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository&quot;</span><br><span class="line">  DOCKER_DRIVER: overlay2</span><br><span class="line">  DOCKER_TLS_CERTDIR: &quot;&quot;</span><br><span class="line"></span><br><span class="line">cache:</span><br><span class="line">  paths:</span><br><span class="line">    - .m2/repository</span><br><span class="line">    - target</span><br><span class="line"></span><br><span class="line">build:</span><br><span class="line">  stage: build</span><br><span class="line">  image: maven:3.8.4-openjdk-11</span><br><span class="line">  script:</span><br><span class="line">    - mvn clean compile -DskipTests</span><br><span class="line">  artifacts:</span><br><span class="line">    paths:</span><br><span class="line">      - target/classes</span><br><span class="line">    expire_in: 1 hour</span><br><span class="line"></span><br><span class="line">unit-test:</span><br><span class="line">  stage: test</span><br><span class="line">  image: maven:3.8.4-openjdk-11</span><br><span class="line">  script:</span><br><span class="line">    - mvn test</span><br><span class="line">  artifacts:</span><br><span class="line">    reports:</span><br><span class="line">      junit:</span><br><span class="line">        - target/surefire-reports/TEST-*.xml</span><br><span class="line">    paths:</span><br><span class="line">      - target/surefire-reports/</span><br><span class="line">    expire_in: 1 week</span><br><span class="line"></span><br><span class="line">integration-test:</span><br><span class="line">  stage: test</span><br><span class="line">  image: maven:3.8.4-openjdk-11</span><br><span class="line">  services:</span><br><span class="line">    - mysql:8.0</span><br><span class="line">    - redis:7-alpine</span><br><span class="line">  variables:</span><br><span class="line">    MYSQL_ROOT_PASSWORD: &quot;test123&quot;</span><br><span class="line">    MYSQL_DATABASE: &quot;chat_test&quot;</span><br><span class="line">  script:</span><br><span class="line">    - mvn verify -Dit.test=*IT</span><br><span class="line">  artifacts:</span><br><span class="line">    reports:</span><br><span class="line">      junit:</span><br><span class="line">        - target/failsafe-reports/TEST-*.xml</span><br><span class="line">    paths:</span><br><span class="line">      - target/failsafe-reports/</span><br><span class="line">    expire_in: 1 week</span><br><span class="line"></span><br><span class="line">sonar-scan:</span><br><span class="line">  stage: scan</span><br><span class="line">  image: maven:3.8.4-openjdk-11</span><br><span class="line">  variables:</span><br><span class="line">    SONAR_USER_HOME: &quot;$&#123;CI_PROJECT_DIR&#125;/.sonar&quot;</span><br><span class="line">    GIT_DEPTH: &quot;0&quot;</span><br><span class="line">  cache:</span><br><span class="line">    key: &quot;$&#123;CI_JOB_NAME&#125;&quot;</span><br><span class="line">    paths:</span><br><span class="line">      - .sonar/cache</span><br><span class="line">  script:</span><br><span class="line">    - mvn sonar:sonar</span><br><span class="line">  only:</span><br><span class="line">    - master</span><br><span class="line">    - merge_requests</span><br><span class="line"></span><br><span class="line">security-scan:</span><br><span class="line">  stage: scan</span><br><span class="line">  image: aquasec/trivy:latest</span><br><span class="line">  script:</span><br><span class="line">    - trivy filesystem --exit-code 1 --no-progress /</span><br><span class="line">  allow_failure: true</span><br><span class="line"></span><br><span class="line">build-image:</span><br><span class="line">  stage: package</span><br><span class="line">  image: docker:20.10.16</span><br><span class="line">  services:</span><br><span class="line">    - docker:20.10.16-dind</span><br><span class="line">  variables:</span><br><span class="line">    DOCKER_HOST: tcp://docker:2375</span><br><span class="line">    DOCKER_TLS_CERTDIR: &quot;&quot;</span><br><span class="line">  script:</span><br><span class="line">    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA .</span><br><span class="line">    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA</span><br><span class="line">  only:</span><br><span class="line">    - master</span><br><span class="line"></span><br><span class="line">deploy-staging:</span><br><span class="line">  stage: deploy</span><br><span class="line">  image: bitnami/kubectl:latest</span><br><span class="line">  script:</span><br><span class="line">    - kubectl config use-context staging</span><br><span class="line">    - kubectl set image deployment/chat-app chat-app=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA -n chat-staging</span><br><span class="line">    - kubectl rollout status deployment/chat-app -n chat-staging</span><br><span class="line">  environment:</span><br><span class="line">    name: staging</span><br><span class="line">    url: https://staging.chat.example.com</span><br><span class="line">  only:</span><br><span class="line">    - master</span><br><span class="line"></span><br><span class="line">deploy-production:</span><br><span class="line">  stage: deploy</span><br><span class="line">  image: bitnami/kubectl:latest</span><br><span class="line">  script:</span><br><span class="line">    - kubectl config use-context production</span><br><span class="line">    - kubectl set image deployment/chat-app chat-app=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA -n chat-production</span><br><span class="line">    - kubectl rollout status deployment/chat-app -n chat-production</span><br><span class="line">  environment:</span><br><span class="line">    name: production</span><br><span class="line">    url: https://chat.example.com</span><br><span class="line">  when: manual</span><br><span class="line">  only:</span><br><span class="line">    - master</span><br></pre></td></tr></table></figure>



<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>这个企业级聊天室扩展方案包含了：</p>
<ol>
<li><strong>微服务架构</strong> - 服务拆分、API网关、服务发现</li>
<li><strong>AI集成</strong> - 智能聊天、翻译、内容审核</li>
<li><strong>实时通信</strong> - 视频通话、屏幕共享、白板协作</li>
<li><strong>消息队列</strong> - Kafka分布式消息处理</li>
<li><strong>容器化部署</strong> - Docker、Kubernetes、Helm</li>
<li><strong>监控告警</strong> - Prometheus、Grafana、告警规则</li>
<li><strong>CI&#x2F;CD</strong> - 完整的持续集成&#x2F;持续部署流水线</li>
<li><strong>安全增强</strong> - 安全扫描、漏洞检测</li>
<li><strong>性能优化</strong> - 水平扩展、自动伸缩、缓存策略</li>
<li><strong>高可用</strong> - 多副本部署、负载均衡、故障转移</li>
</ol>
<p>这个方案可以支持大规模用户并发，具备企业级应用的可靠性、可扩展性和可维护性。您可以根据具体需求选择实现其中的部分或全部功能。</p>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">
    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/25278399.html" rel="prev" title="Java实践:RPC框架">
                  <i class="fa fa-angle-left"></i> Java实践:RPC框架
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/c25083a1.html" rel="next" title="Java实践:个人博客系统">
                  Java实践:个人博客系统 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa-regular fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder"></span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Word count total">393k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">23:48</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>

  <script class="next-config" data-name="wavedrom" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/wavedrom.min.js","integrity":"sha256-INLAoJc6quTNfiMWkGZniYO2cxE8mHpddnLow1m6RFs="}}</script>
  <script class="next-config" data-name="wavedrom_skin" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/skins/default.js","integrity":"sha256-fduc/Zszk5ezWws2uInY/ALWVmIrmV6VTgXbsYSReFI="}}</script>
  <script src="/js/third-party/tags/wavedrom.js"></script>




  





</body>
</html>
