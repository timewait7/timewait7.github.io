<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"timewait7.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="多人聊天室 - Java实现方案我将为您实现一个功能丰富的多人聊天室应用，包含SpringBoot后端和美观的前端界面。 项目结构设计text 1234567891011121314chat-room&#x2F;├── src&#x2F;main&#x2F;java&#x2F;com&#x2F;chatroom&#x2F;│   ├── config&#x2F;           # 配置类│   ├── controller&#x2F;       # 控制器│   ├─">
<meta property="og:type" content="article">
<meta property="og:title" content="Java实践:多人在线聊天室">
<meta property="og:url" content="http://timewait7.github.io/post/76a16698.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="多人聊天室 - Java实现方案我将为您实现一个功能丰富的多人聊天室应用，包含SpringBoot后端和美观的前端界面。 项目结构设计text 1234567891011121314chat-room&#x2F;├── src&#x2F;main&#x2F;java&#x2F;com&#x2F;chatroom&#x2F;│   ├── config&#x2F;           # 配置类│   ├── controller&#x2F;       # 控制器│   ├─">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-12-17T11:03:31.000Z">
<meta property="article:modified_time" content="2025-12-17T16:15:26.399Z">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://timewait7.github.io/post/76a16698.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://timewait7.github.io/post/76a16698.html","path":"post/76a16698.html","title":"Java实践:多人在线聊天室"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Java实践:多人在线聊天室 | Hexo</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-archives"><a href="/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="Searching..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A4%9A%E4%BA%BA%E8%81%8A%E5%A4%A9%E5%AE%A4-Java%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88"><span class="nav-number">1.</span> <span class="nav-text">多人聊天室 - Java实现方案</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.1.</span> <span class="nav-text">项目结构设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%90%8E%E7%AB%AF%E5%AE%9E%E7%8E%B0-Spring-Boot"><span class="nav-number">1.2.</span> <span class="nav-text">1. 后端实现 (Spring Boot)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-Maven%E4%BE%9D%E8%B5%96-pom-xml"><span class="nav-number">1.2.1.</span> <span class="nav-text">1.1 Maven依赖 (pom.xml)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E4%B8%BB%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E7%B1%BB"><span class="nav-number">1.2.2.</span> <span class="nav-text">1.2 主应用程序类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-WebSocket%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="nav-number">1.2.3.</span> <span class="nav-text">1.3 WebSocket配置类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E7%B1%BB"><span class="nav-number">1.2.4.</span> <span class="nav-text">1.4 数据模型类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E7%B1%BB"><span class="nav-number">1.2.5.</span> <span class="nav-text">1.5 用户管理类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-6-WebSocket%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="nav-number">1.2.6.</span> <span class="nav-text">1.6 WebSocket控制器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-7-%E5%BA%94%E7%94%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">1.2.7.</span> <span class="nav-text">1.7 应用配置文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%89%8D%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.3.</span> <span class="nav-text">2. 前端实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-HTML%E9%A1%B5%E9%9D%A2-index-html"><span class="nav-number">1.3.1.</span> <span class="nav-text">2.1 HTML页面 (index.html)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-CSS%E6%A0%B7%E5%BC%8F-chat-css"><span class="nav-number">1.3.2.</span> <span class="nav-text">2.2 CSS样式 (chat.css)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-JavaScript%E5%8A%9F%E8%83%BD-chat-js"><span class="nav-number">1.3.3.</span> <span class="nav-text">2.3 JavaScript功能 (chat.js)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E8%BF%90%E8%A1%8C%E8%AF%B4%E6%98%8E"><span class="nav-number">1.4.</span> <span class="nav-text">3. 运行说明</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-number">1.4.1.</span> <span class="nav-text">3.1 项目结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E8%BF%90%E8%A1%8C%E6%AD%A5%E9%AA%A4"><span class="nav-number">1.4.2.</span> <span class="nav-text">3.2 运行步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E8%AE%BF%E9%97%AE%E5%BA%94%E7%94%A8"><span class="nav-number">1.4.3.</span> <span class="nav-text">3.3 访问应用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%8A%9F%E8%83%BD%E7%89%B9%E7%82%B9"><span class="nav-number">1.5.</span> <span class="nav-text">4. 功能特点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD"><span class="nav-number">1.5.1.</span> <span class="nav-text">4.1 核心功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD"><span class="nav-number">1.5.2.</span> <span class="nav-text">4.2 高级功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-%E6%8A%80%E6%9C%AF%E7%89%B9%E7%82%B9"><span class="nav-number">1.5.3.</span> <span class="nav-text">4.3 技术特点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E6%89%A9%E5%B1%95%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.6.</span> <span class="nav-text">5. 扩展建议</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E5%8A%9F%E8%83%BD%E6%89%A9%E5%B1%95"><span class="nav-number">1.6.1.</span> <span class="nav-text">5.1 功能扩展</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E9%83%A8%E7%BD%B2%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.6.2.</span> <span class="nav-text">5.2 部署建议</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A4%9A%E4%BA%BA%E8%81%8A%E5%A4%A9%E5%AE%A4-%E6%89%A9%E5%B1%95%E5%AE%8C%E5%96%84%E6%96%B9%E6%A1%88"><span class="nav-number">2.</span> <span class="nav-text">多人聊天室 - 扩展完善方案</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E5%8A%9F%E8%83%BD%E6%B8%85%E5%8D%95"><span class="nav-number">2.1.</span> <span class="nav-text">扩展功能清单</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1-MySQL"><span class="nav-number">2.2.</span> <span class="nav-text">1. 数据库设计 (MySQL)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-SQL-%E8%84%9A%E6%9C%AC"><span class="nav-number">2.2.1.</span> <span class="nav-text">1.1 SQL 脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E6%9B%B4%E6%96%B0pom-xml%E4%BE%9D%E8%B5%96"><span class="nav-number">2.2.2.</span> <span class="nav-text">1.2 更新pom.xml依赖</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-JPA%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="nav-number">2.3.</span> <span class="nav-text">2. JPA实体类</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-User-%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="nav-number">2.3.1.</span> <span class="nav-text">2.1 User 实体类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-Message-%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="nav-number">2.3.2.</span> <span class="nav-text">2.2 Message 实体类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E5%85%B6%E4%BB%96%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="nav-number">2.3.3.</span> <span class="nav-text">2.3 其他实体类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Spring-Security%E9%85%8D%E7%BD%AE"><span class="nav-number">2.4.</span> <span class="nav-text">3. Spring Security配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-Security%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="nav-number">2.4.1.</span> <span class="nav-text">3.1 Security配置类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-JWT%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="nav-number">2.4.2.</span> <span class="nav-text">3.2 JWT工具类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-JWT%E8%AE%A4%E8%AF%81%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-number">2.4.3.</span> <span class="nav-text">3.3 JWT认证过滤器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E8%AE%A4%E8%AF%81%E5%92%8C%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86API"><span class="nav-number">2.5.</span> <span class="nav-text">4. 认证和用户管理API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E8%AE%A4%E8%AF%81%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="nav-number">2.5.1.</span> <span class="nav-text">4.1 认证控制器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-DTO%E7%B1%BB"><span class="nav-number">2.5.2.</span> <span class="nav-text">4.2 DTO类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E6%89%A9%E5%B1%95WebSocket%E5%8A%9F%E8%83%BD"><span class="nav-number">2.6.</span> <span class="nav-text">5. 扩展WebSocket功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-WebSocket%E8%AE%A4%E8%AF%81%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="nav-number">2.6.1.</span> <span class="nav-text">5.1 WebSocket认证拦截器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E5%A2%9E%E5%BC%BA%E7%9A%84WebSocket%E9%85%8D%E7%BD%AE"><span class="nav-number">2.6.2.</span> <span class="nav-text">5.2 增强的WebSocket配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-%E5%A2%9E%E5%BC%BA%E7%9A%84WebSocket%E5%A4%84%E7%90%86%E5%99%A8"><span class="nav-number">2.6.3.</span> <span class="nav-text">5.3 增强的WebSocket处理器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%8A%9F%E8%83%BD"><span class="nav-number">2.7.</span> <span class="nav-text">6. 文件上传功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%85%8D%E7%BD%AE"><span class="nav-number">2.7.1.</span> <span class="nav-text">6.1 文件上传配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1%E7%B1%BB"><span class="nav-number">2.7.2.</span> <span class="nav-text">6.2 文件服务类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E5%89%8D%E7%AB%AF%E6%89%A9%E5%B1%95"><span class="nav-number">2.8.</span> <span class="nav-text">7. 前端扩展</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-%E5%A2%9E%E5%BC%BA%E7%9A%84%E8%81%8A%E5%A4%A9%E9%A1%B5%E9%9D%A2-index-html%E6%89%A9%E5%B1%95"><span class="nav-number">2.8.1.</span> <span class="nav-text">7.1 增强的聊天页面 (index.html扩展)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-%E5%A2%9E%E5%BC%BA%E7%9A%84CSS%E6%A0%B7%E5%BC%8F"><span class="nav-number">2.8.2.</span> <span class="nav-text">7.2 增强的CSS样式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-%E5%A2%9E%E5%BC%BA%E7%9A%84JavaScript%E5%8A%9F%E8%83%BD"><span class="nav-number">2.8.3.</span> <span class="nav-text">7.3 增强的JavaScript功能</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-%E5%BA%94%E7%94%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%9B%B4%E6%96%B0"><span class="nav-number">2.9.</span> <span class="nav-text">8. 应用配置文件更新</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-application-yml"><span class="nav-number">2.9.1.</span> <span class="nav-text">8.1 application.yml</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-Docker%E6%94%AF%E6%8C%81"><span class="nav-number">2.10.</span> <span class="nav-text">9. Docker支持</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-Dockerfile"><span class="nav-number">2.10.1.</span> <span class="nav-text">9.1 Dockerfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-docker-compose-yml"><span class="nav-number">2.10.2.</span> <span class="nav-text">9.2 docker-compose.yml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-3-Nginx%E9%85%8D%E7%BD%AE-nginx-conf"><span class="nav-number">2.10.3.</span> <span class="nav-text">9.3 Nginx配置 (nginx.conf)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-%E7%9B%91%E6%8E%A7%E5%92%8C%E8%BF%90%E7%BB%B4"><span class="nav-number">2.11.</span> <span class="nav-text">10. 监控和运维</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-1-Spring-Boot-Actuator%E9%85%8D%E7%BD%AE"><span class="nav-number">2.11.1.</span> <span class="nav-text">10.1 Spring Boot Actuator配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-2-%E5%BA%94%E7%94%A8%E7%9B%91%E6%8E%A7%E7%AB%AF%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="nav-number">2.11.2.</span> <span class="nav-text">10.2 应用监控端点配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">2.12.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%B6%88%E6%81%AF%E5%9B%9E%E6%89%A7%EF%BC%88%E5%B7%B2%E8%AF%BB%E7%8A%B6%E6%80%81%EF%BC%89"><span class="nav-number">2.13.</span> <span class="nav-text">1. 消息回执（已读状态）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9B%B4%E6%96%B0"><span class="nav-number">2.13.1.</span> <span class="nav-text">1.1 数据库更新</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E5%90%8E%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.13.2.</span> <span class="nav-text">1.2 后端实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-1-%E6%B6%88%E6%81%AF%E5%B7%B2%E8%AF%BB%E7%8A%B6%E6%80%81%E6%9B%B4%E6%96%B0%E6%8E%A5%E5%8F%A3"><span class="nav-number">2.13.2.1.</span> <span class="nav-text">1.2.1 消息已读状态更新接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-2-%E5%89%8D%E7%AB%AF%E5%8F%91%E9%80%81%E5%B7%B2%E8%AF%BB%E5%9B%9E%E6%89%A7"><span class="nav-number">2.13.2.2.</span> <span class="nav-text">1.2.2 前端发送已读回执</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E5%89%8D%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.13.3.</span> <span class="nav-text">1.3 前端实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%B6%88%E6%81%AF%E6%92%A4%E5%9B%9E"><span class="nav-number">2.14.</span> <span class="nav-text">2. 消息撤回</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E5%90%8E%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.14.1.</span> <span class="nav-text">2.1 后端实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-1-%E6%B6%88%E6%81%AF%E6%92%A4%E5%9B%9E%E6%8E%A5%E5%8F%A3"><span class="nav-number">2.14.1.1.</span> <span class="nav-text">2.1.1 消息撤回接口</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E5%89%8D%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.14.2.</span> <span class="nav-text">2.2 前端实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E7%BE%A4%E7%BB%84%E7%AE%A1%E7%90%86"><span class="nav-number">2.15.</span> <span class="nav-text">3. 群组管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9B%B4%E6%96%B0"><span class="nav-number">2.15.1.</span> <span class="nav-text">3.1 数据库更新</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E5%90%8E%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.15.2.</span> <span class="nav-text">3.2 后端实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-1-%E5%88%9B%E5%BB%BA%E7%BE%A4%E7%BB%84%E6%8E%A5%E5%8F%A3"><span class="nav-number">2.15.2.1.</span> <span class="nav-text">3.2.1 创建群组接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-2-%E7%BE%A4%E7%BB%84%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86"><span class="nav-number">2.15.2.2.</span> <span class="nav-text">3.2.2 群组消息处理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E5%89%8D%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.15.3.</span> <span class="nav-text">3.3 前端实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%85%B6%E4%BB%96%E6%89%A9%E5%B1%95%E5%8A%9F%E8%83%BD"><span class="nav-number">2.16.</span> <span class="nav-text">4. 其他扩展功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E6%B6%88%E6%81%AF%E6%94%B6%E8%97%8F"><span class="nav-number">2.16.1.</span> <span class="nav-text">4.1 消息收藏</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E8%81%8A%E5%A4%A9%E8%AE%B0%E5%BD%95%E5%AF%BC%E5%87%BA"><span class="nav-number">2.16.2.</span> <span class="nav-text">4.2 聊天记录导出</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-%E6%88%AA%E5%9B%BE%E5%88%86%E4%BA%AB"><span class="nav-number">2.16.3.</span> <span class="nav-text">4.3 截图分享</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-AI%E8%81%8A%E5%A4%A9%E5%8A%A9%E6%89%8B"><span class="nav-number">2.16.4.</span> <span class="nav-text">4.4 AI聊天助手</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-%E6%B6%88%E6%81%AF%E7%BF%BB%E8%AF%91"><span class="nav-number">2.16.5.</span> <span class="nav-text">4.5 消息翻译</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">2.17.</span> <span class="nav-text">5. 性能优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E6%B6%88%E6%81%AF%E5%88%86%E9%A1%B5%E5%8A%A0%E8%BD%BD"><span class="nav-number">2.17.1.</span> <span class="nav-text">5.1 消息分页加载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-WebSocket%E8%BF%9E%E6%8E%A5%E4%BC%98%E5%8C%96"><span class="nav-number">2.17.2.</span> <span class="nav-text">5.2 WebSocket连接优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-%E5%89%8D%E7%AB%AF%E8%99%9A%E6%8B%9F%E6%BB%9A%E5%8A%A8"><span class="nav-number">2.17.3.</span> <span class="nav-text">5.3 前端虚拟滚动</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E5%AE%89%E5%85%A8%E6%80%A7%E5%A2%9E%E5%BC%BA"><span class="nav-number">2.18.</span> <span class="nav-text">6. 安全性增强</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%E8%BE%93%E5%85%A5%E9%AA%8C%E8%AF%81%E5%92%8C%E8%BF%87%E6%BB%A4"><span class="nav-number">2.18.1.</span> <span class="nav-text">6.1 输入验证和过滤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%AE%89%E5%85%A8"><span class="nav-number">2.18.2.</span> <span class="nav-text">6.2 文件上传安全</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-%E9%80%9A%E4%BF%A1%E5%8A%A0%E5%AF%86"><span class="nav-number">2.18.3.</span> <span class="nav-text">6.3 通信加密</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E9%83%A8%E7%BD%B2%E5%92%8C%E8%BF%90%E7%BB%B4"><span class="nav-number">2.19.</span> <span class="nav-text">7. 部署和运维</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-%E4%BD%BF%E7%94%A8Docker-Compose%E9%83%A8%E7%BD%B2"><span class="nav-number">2.19.1.</span> <span class="nav-text">7.1 使用Docker Compose部署</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-%E6%97%A5%E5%BF%97%E5%92%8C%E7%9B%91%E6%8E%A7"><span class="nav-number">2.19.2.</span> <span class="nav-text">7.2 日志和监控</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95"><span class="nav-number">2.19.3.</span> <span class="nav-text">7.3 自动化测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-%E6%80%BB%E7%BB%93"><span class="nav-number">2.20.</span> <span class="nav-text">8. 总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A4%9A%E4%BA%BA%E8%81%8A%E5%A4%A9%E5%AE%A4-%E4%BC%81%E4%B8%9A%E7%BA%A7%E6%89%A9%E5%B1%95%E6%96%B9%E6%A1%88"><span class="nav-number">3.</span> <span class="nav-text">多人聊天室 - 企业级扩展方案</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E5%8A%9F%E8%83%BD%E6%B8%85%E5%8D%95-1"><span class="nav-number">3.1.</span> <span class="nav-text">扩展功能清单</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">3.2.</span> <span class="nav-text">1. 微服务架构设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-number">3.2.1.</span> <span class="nav-text">1.1 项目结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-API%E7%BD%91%E5%85%B3%E9%85%8D%E7%BD%AE-Gateway"><span class="nav-number">3.2.2.</span> <span class="nav-text">1.2 API网关配置 (Gateway)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-AI%E8%81%8A%E5%A4%A9%E5%8A%A9%E6%89%8B%E9%9B%86%E6%88%90"><span class="nav-number">3.3.</span> <span class="nav-text">2. AI聊天助手集成</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-AI%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE"><span class="nav-number">3.3.1.</span> <span class="nav-text">2.1 AI服务配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-AI%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="nav-number">3.3.2.</span> <span class="nav-text">2.2 AI控制器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-AI%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="nav-number">3.3.3.</span> <span class="nav-text">2.3 AI配置类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-WebRTC%E8%A7%86%E9%A2%91%E9%80%9A%E8%AF%9D"><span class="nav-number">3.4.</span> <span class="nav-text">3. WebRTC视频通话</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E4%BF%A1%E4%BB%A4%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">3.4.1.</span> <span class="nav-text">3.1 信令服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E4%BF%A1%E4%BB%A4%E6%B6%88%E6%81%AF%E7%B1%BB"><span class="nav-number">3.4.2.</span> <span class="nav-text">3.2 信令消息类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-WebRTC%E9%85%8D%E7%BD%AE"><span class="nav-number">3.4.3.</span> <span class="nav-text">3.3 WebRTC配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%89%8D%E7%AB%AF%E8%A7%86%E9%A2%91%E9%80%9A%E8%AF%9D%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.5.</span> <span class="nav-text">4. 前端视频通话实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-WebRTC%E5%89%8D%E7%AB%AF%E7%BB%84%E4%BB%B6"><span class="nav-number">3.5.1.</span> <span class="nav-text">4.1 WebRTC前端组件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E8%A7%86%E9%A2%91%E9%80%9A%E8%AF%9DUI%E7%BB%84%E4%BB%B6"><span class="nav-number">3.5.2.</span> <span class="nav-text">4.2 视频通话UI组件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-%E8%A7%86%E9%A2%91%E9%80%9A%E8%AF%9DCSS"><span class="nav-number">3.5.3.</span> <span class="nav-text">4.3 视频通话CSS</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E9%9B%86%E6%88%90"><span class="nav-number">3.6.</span> <span class="nav-text">5. 消息队列集成</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-Kafka%E9%85%8D%E7%BD%AE"><span class="nav-number">3.6.1.</span> <span class="nav-text">5.1 Kafka配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-Kafka%E7%94%9F%E4%BA%A7%E8%80%85"><span class="nav-number">3.6.2.</span> <span class="nav-text">5.2 Kafka生产者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-Kafka%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-number">3.6.3.</span> <span class="nav-text">5.3 Kafka消费者</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E5%AE%9E%E6%97%B6%E5%8D%8F%E4%BD%9C%E7%99%BD%E6%9D%BF"><span class="nav-number">3.7.</span> <span class="nav-text">6. 实时协作白板</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%E7%99%BD%E6%9D%BF%E5%90%8E%E7%AB%AF"><span class="nav-number">3.7.1.</span> <span class="nav-text">6.1 白板后端</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-Kubernetes%E9%83%A8%E7%BD%B2%E9%85%8D%E7%BD%AE"><span class="nav-number">3.8.</span> <span class="nav-text">7. Kubernetes部署配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-Kubernetes%E9%83%A8%E7%BD%B2%E6%96%87%E4%BB%B6"><span class="nav-number">3.8.1.</span> <span class="nav-text">7.1 Kubernetes部署文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-Helm-Chart"><span class="nav-number">3.8.2.</span> <span class="nav-text">7.2 Helm Chart</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-%E7%9B%91%E6%8E%A7%E5%92%8C%E5%91%8A%E8%AD%A6"><span class="nav-number">3.9.</span> <span class="nav-text">8. 监控和告警</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-Prometheus%E9%85%8D%E7%BD%AE"><span class="nav-number">3.9.1.</span> <span class="nav-text">8.1 Prometheus配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-Grafana%E4%BB%AA%E8%A1%A8%E6%9D%BF"><span class="nav-number">3.9.2.</span> <span class="nav-text">8.2 Grafana仪表板</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-CI-CD%E6%B5%81%E6%B0%B4%E7%BA%BF"><span class="nav-number">3.10.</span> <span class="nav-text">9. CI&#x2F;CD流水线</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-GitLab-CI%E9%85%8D%E7%BD%AE"><span class="nav-number">3.10.1.</span> <span class="nav-text">9.1 GitLab CI配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-1"><span class="nav-number">3.11.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/">
          <span class="site-state-item-count">56</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://timewait7.github.io/post/76a16698.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Java实践:多人在线聊天室 | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Java实践:多人在线聊天室
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-12-17 19:03:31" itemprop="dateCreated datePublished" datetime="2025-12-17T19:03:31+08:00">2025-12-17</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>26k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1:35</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="多人聊天室-Java实现方案"><a href="#多人聊天室-Java实现方案" class="headerlink" title="多人聊天室 - Java实现方案"></a>多人聊天室 - Java实现方案</h1><p>我将为您实现一个功能丰富的多人聊天室应用，包含SpringBoot后端和美观的前端界面。</p>
<h2 id="项目结构设计"><a href="#项目结构设计" class="headerlink" title="项目结构设计"></a>项目结构设计</h2><p>text</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">chat-room/</span><br><span class="line">├── src/main/java/com/chatroom/</span><br><span class="line">│   ├── config/           # 配置类</span><br><span class="line">│   ├── controller/       # 控制器</span><br><span class="line">│   ├── model/           # 数据模型</span><br><span class="line">│   ├── service/         # 业务逻辑</span><br><span class="line">│   ├── websocket/       # WebSocket配置</span><br><span class="line">│   └── ChatRoomApplication.java</span><br><span class="line">├── src/main/resources/</span><br><span class="line">│   ├── static/          # 静态资源(HTML/CSS/JS)</span><br><span class="line">│   ├── templates/       # 模板文件</span><br><span class="line">│   └── application.yml</span><br><span class="line">├── pom.xml</span><br><span class="line">└── README.md</span><br></pre></td></tr></table></figure>



<h2 id="1-后端实现-Spring-Boot"><a href="#1-后端实现-Spring-Boot" class="headerlink" title="1. 后端实现 (Spring Boot)"></a>1. 后端实现 (Spring Boot)</h2><h3 id="1-1-Maven依赖-pom-xml"><a href="#1-1-Maven依赖-pom-xml" class="headerlink" title="1.1 Maven依赖 (pom.xml)"></a>1.1 Maven依赖 (pom.xml)</h3><p>xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 </span><br><span class="line">         http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.7.0&lt;/version&gt;</span><br><span class="line">        &lt;relativePath/&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;groupId&gt;com.chatroom&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;chat-room&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0.0&lt;/version&gt;</span><br><span class="line">    &lt;name&gt;Chat Room Application&lt;/name&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;java.version&gt;11&lt;/java.version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;!-- Spring Boot Web --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- WebSocket --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-websocket&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- Thymeleaf (可选，用于模板) --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- JSON处理 --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- 开发工具 --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">            &lt;optional&gt;true&lt;/optional&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- 测试 --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>



<h3 id="1-2-主应用程序类"><a href="#1-2-主应用程序类" class="headerlink" title="1.2 主应用程序类"></a>1.2 主应用程序类</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom;</span><br><span class="line"></span><br><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class ChatRoomApplication &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(ChatRoomApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-3-WebSocket配置类"><a href="#1-3-WebSocket配置类" class="headerlink" title="1.3 WebSocket配置类"></a>1.3 WebSocket配置类</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.config;</span><br><span class="line"></span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.messaging.simp.config.MessageBrokerRegistry;</span><br><span class="line">import org.springframework.web.socket.config.annotation.EnableWebSocketMessageBroker;</span><br><span class="line">import org.springframework.web.socket.config.annotation.StompEndpointRegistry;</span><br><span class="line">import org.springframework.web.socket.config.annotation.WebSocketMessageBrokerConfigurer;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">@EnableWebSocketMessageBroker</span><br><span class="line">public class WebSocketConfig implements WebSocketMessageBrokerConfigurer &#123;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void configureMessageBroker(MessageBrokerRegistry config) &#123;</span><br><span class="line">        // 启用简单代理，处理以/topic开头的消息</span><br><span class="line">        config.enableSimpleBroker(&quot;/topic&quot;, &quot;/queue&quot;);</span><br><span class="line">        // 设置应用程序前缀，客户端发送消息需要以/app开头</span><br><span class="line">        config.setApplicationDestinationPrefixes(&quot;/app&quot;);</span><br><span class="line">        // 设置用户目的地前缀</span><br><span class="line">        config.setUserDestinationPrefix(&quot;/user&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void registerStompEndpoints(StompEndpointRegistry registry) &#123;</span><br><span class="line">        // 注册WebSocket端点，允许跨域</span><br><span class="line">        registry.addEndpoint(&quot;/ws-chat&quot;)</span><br><span class="line">                .setAllowedOriginPatterns(&quot;*&quot;)</span><br><span class="line">                .withSockJS();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-4-数据模型类"><a href="#1-4-数据模型类" class="headerlink" title="1.4 数据模型类"></a>1.4 数据模型类</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.model;</span><br><span class="line"></span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line">public class ChatMessage &#123;</span><br><span class="line">    private MessageType type;</span><br><span class="line">    private String content;</span><br><span class="line">    private String sender;</span><br><span class="line">    private String receiver;</span><br><span class="line">    private LocalDateTime timestamp;</span><br><span class="line">    private String avatarColor;</span><br><span class="line">    </span><br><span class="line">    public enum MessageType &#123;</span><br><span class="line">        CHAT, JOIN, LEAVE, TYPING, NOTIFICATION</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 构造函数</span><br><span class="line">    public ChatMessage() &#123;</span><br><span class="line">        this.timestamp = LocalDateTime.now();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public ChatMessage(MessageType type, String content, String sender) &#123;</span><br><span class="line">        this.type = type;</span><br><span class="line">        this.content = content;</span><br><span class="line">        this.sender = sender;</span><br><span class="line">        this.timestamp = LocalDateTime.now();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Getter和Setter方法</span><br><span class="line">    public MessageType getType() &#123;</span><br><span class="line">        return type;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void setType(MessageType type) &#123;</span><br><span class="line">        this.type = type;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public String getContent() &#123;</span><br><span class="line">        return content;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void setContent(String content) &#123;</span><br><span class="line">        this.content = content;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public String getSender() &#123;</span><br><span class="line">        return sender;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void setSender(String sender) &#123;</span><br><span class="line">        this.sender = sender;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public String getReceiver() &#123;</span><br><span class="line">        return receiver;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void setReceiver(String receiver) &#123;</span><br><span class="line">        this.receiver = receiver;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public LocalDateTime getTimestamp() &#123;</span><br><span class="line">        return timestamp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void setTimestamp(LocalDateTime timestamp) &#123;</span><br><span class="line">        this.timestamp = timestamp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public String getAvatarColor() &#123;</span><br><span class="line">        return avatarColor;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void setAvatarColor(String avatarColor) &#123;</span><br><span class="line">        this.avatarColor = avatarColor;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;ChatMessage&#123;&quot; +</span><br><span class="line">                &quot;type=&quot; + type +</span><br><span class="line">                &quot;, content=&#x27;&quot; + content + &#x27;\&#x27;&#x27; +</span><br><span class="line">                &quot;, sender=&#x27;&quot; + sender + &#x27;\&#x27;&#x27; +</span><br><span class="line">                &quot;, receiver=&#x27;&quot; + receiver + &#x27;\&#x27;&#x27; +</span><br><span class="line">                &quot;, timestamp=&quot; + timestamp +</span><br><span class="line">                &#x27;&#125;&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-5-用户管理类"><a href="#1-5-用户管理类" class="headerlink" title="1.5 用户管理类"></a>1.5 用户管理类</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.model;</span><br><span class="line"></span><br><span class="line">import java.util.HashSet;</span><br><span class="line">import java.util.Set;</span><br><span class="line">import java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line">public class UserSession &#123;</span><br><span class="line">    private String username;</span><br><span class="line">    private String sessionId;</span><br><span class="line">    private String avatarColor;</span><br><span class="line">    private boolean isOnline;</span><br><span class="line">    </span><br><span class="line">    private static final ConcurrentHashMap&lt;String, UserSession&gt; activeUsers = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    public UserSession(String username, String sessionId) &#123;</span><br><span class="line">        this.username = username;</span><br><span class="line">        this.sessionId = sessionId;</span><br><span class="line">        this.avatarColor = generateAvatarColor();</span><br><span class="line">        this.isOnline = true;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private String generateAvatarColor() &#123;</span><br><span class="line">        String[] colors = &#123;</span><br><span class="line">            &quot;#FF6B6B&quot;, &quot;#4ECDC4&quot;, &quot;#FFD166&quot;, &quot;#06D6A0&quot;, </span><br><span class="line">            &quot;#118AB2&quot;, &quot;#073B4C&quot;, &quot;#EF476F&quot;, &quot;#7209B7&quot;</span><br><span class="line">        &#125;;</span><br><span class="line">        return colors[Math.abs(username.hashCode()) % colors.length];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public static void addUser(String username, String sessionId) &#123;</span><br><span class="line">        activeUsers.put(username, new UserSession(username, sessionId));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public static void removeUser(String username) &#123;</span><br><span class="line">        activeUsers.remove(username);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public static Set&lt;String&gt; getOnlineUsers() &#123;</span><br><span class="line">        return new HashSet&lt;&gt;(activeUsers.keySet());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public static UserSession getUser(String username) &#123;</span><br><span class="line">        return activeUsers.get(username);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public static int getOnlineCount() &#123;</span><br><span class="line">        return activeUsers.size();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Getter和Setter方法</span><br><span class="line">    public String getUsername() &#123;</span><br><span class="line">        return username;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public String getSessionId() &#123;</span><br><span class="line">        return sessionId;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public String getAvatarColor() &#123;</span><br><span class="line">        return avatarColor;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public boolean isOnline() &#123;</span><br><span class="line">        return isOnline;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void setOnline(boolean online) &#123;</span><br><span class="line">        isOnline = online;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-6-WebSocket控制器"><a href="#1-6-WebSocket控制器" class="headerlink" title="1.6 WebSocket控制器"></a>1.6 WebSocket控制器</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.controller;</span><br><span class="line"></span><br><span class="line">import com.chatroom.model.ChatMessage;</span><br><span class="line">import com.chatroom.model.UserSession;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.messaging.handler.annotation.MessageMapping;</span><br><span class="line">import org.springframework.messaging.handler.annotation.Payload;</span><br><span class="line">import org.springframework.messaging.handler.annotation.SendTo;</span><br><span class="line">import org.springframework.messaging.simp.SimpMessageHeaderAccessor;</span><br><span class="line">import org.springframework.messaging.simp.SimpMessagingTemplate;</span><br><span class="line">import org.springframework.stereotype.Controller;</span><br><span class="line">import org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"></span><br><span class="line">import java.time.format.DateTimeFormatter;</span><br><span class="line"></span><br><span class="line">@Controller</span><br><span class="line">public class ChatController &#123;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private SimpMessagingTemplate messagingTemplate;</span><br><span class="line">    </span><br><span class="line">    // 处理用户加入聊天室</span><br><span class="line">    @MessageMapping(&quot;/chat.addUser&quot;)</span><br><span class="line">    @SendTo(&quot;/topic/public&quot;)</span><br><span class="line">    public ChatMessage addUser(@Payload ChatMessage chatMessage, </span><br><span class="line">                              SimpMessageHeaderAccessor headerAccessor) &#123;</span><br><span class="line">        </span><br><span class="line">        String username = chatMessage.getSender();</span><br><span class="line">        String sessionId = headerAccessor.getSessionId();</span><br><span class="line">        </span><br><span class="line">        // 添加用户到在线列表</span><br><span class="line">        UserSession.addUser(username, sessionId);</span><br><span class="line">        </span><br><span class="line">        // 设置头像颜色</span><br><span class="line">        chatMessage.setAvatarColor(UserSession.getUser(username).getAvatarColor());</span><br><span class="line">        chatMessage.setType(ChatMessage.MessageType.JOIN);</span><br><span class="line">        chatMessage.setContent(username + &quot; 加入了聊天室&quot;);</span><br><span class="line">        </span><br><span class="line">        // 广播在线用户列表更新</span><br><span class="line">        broadcastOnlineUsers();</span><br><span class="line">        </span><br><span class="line">        return chatMessage;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 处理发送消息</span><br><span class="line">    @MessageMapping(&quot;/chat.sendMessage&quot;)</span><br><span class="line">    @SendTo(&quot;/topic/public&quot;)</span><br><span class="line">    public ChatMessage sendMessage(@Payload ChatMessage chatMessage) &#123;</span><br><span class="line">        chatMessage.setType(ChatMessage.MessageType.CHAT);</span><br><span class="line">        chatMessage.setTimestamp(java.time.LocalDateTime.now());</span><br><span class="line">        return chatMessage;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 处理私聊消息</span><br><span class="line">    @MessageMapping(&quot;/chat.sendPrivateMessage&quot;)</span><br><span class="line">    public void sendPrivateMessage(@Payload ChatMessage chatMessage) &#123;</span><br><span class="line">        chatMessage.setType(ChatMessage.MessageType.CHAT);</span><br><span class="line">        chatMessage.setTimestamp(java.time.LocalDateTime.now());</span><br><span class="line">        </span><br><span class="line">        // 发送给特定用户</span><br><span class="line">        messagingTemplate.convertAndSendToUser(</span><br><span class="line">            chatMessage.getReceiver(), </span><br><span class="line">            &quot;/queue/private&quot;, </span><br><span class="line">            chatMessage</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        // 同时发送给自己（用于显示发送的消息）</span><br><span class="line">        messagingTemplate.convertAndSendToUser(</span><br><span class="line">            chatMessage.getSender(), </span><br><span class="line">            &quot;/queue/private&quot;, </span><br><span class="line">            chatMessage</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 处理用户离开</span><br><span class="line">    @MessageMapping(&quot;/chat.leave&quot;)</span><br><span class="line">    @SendTo(&quot;/topic/public&quot;)</span><br><span class="line">    public ChatMessage leaveUser(@Payload ChatMessage chatMessage) &#123;</span><br><span class="line">        String username = chatMessage.getSender();</span><br><span class="line">        </span><br><span class="line">        UserSession.removeUser(username);</span><br><span class="line">        </span><br><span class="line">        chatMessage.setType(ChatMessage.MessageType.LEAVE);</span><br><span class="line">        chatMessage.setContent(username + &quot; 离开了聊天室&quot;);</span><br><span class="line">        </span><br><span class="line">        // 广播在线用户列表更新</span><br><span class="line">        broadcastOnlineUsers();</span><br><span class="line">        </span><br><span class="line">        return chatMessage;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 处理用户正在输入</span><br><span class="line">    @MessageMapping(&quot;/chat.typing&quot;)</span><br><span class="line">    @SendTo(&quot;/topic/public&quot;)</span><br><span class="line">    public ChatMessage userTyping(@Payload ChatMessage chatMessage) &#123;</span><br><span class="line">        chatMessage.setType(ChatMessage.MessageType.TYPING);</span><br><span class="line">        return chatMessage;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 广播在线用户列表</span><br><span class="line">    private void broadcastOnlineUsers() &#123;</span><br><span class="line">        ChatMessage notification = new ChatMessage();</span><br><span class="line">        notification.setType(ChatMessage.MessageType.NOTIFICATION);</span><br><span class="line">        notification.setContent(String.valueOf(UserSession.getOnlineCount()));</span><br><span class="line">        notification.setSender(&quot;SYSTEM&quot;);</span><br><span class="line">        </span><br><span class="line">        // 发送在线用户数量</span><br><span class="line">        messagingTemplate.convertAndSend(&quot;/topic/onlineUsers&quot;, </span><br><span class="line">            UserSession.getOnlineUsers());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 主页面</span><br><span class="line">    @GetMapping(&quot;/&quot;)</span><br><span class="line">    public String index() &#123;</span><br><span class="line">        return &quot;index&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-7-应用配置文件"><a href="#1-7-应用配置文件" class="headerlink" title="1.7 应用配置文件"></a>1.7 应用配置文件</h3><p>yaml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># src/main/resources/application.yml</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: chat-room</span><br><span class="line">  </span><br><span class="line">  # 静态资源路径</span><br><span class="line">  resources:</span><br><span class="line">    static-locations: classpath:/static/</span><br><span class="line">  </span><br><span class="line">  # Thymeleaf配置</span><br><span class="line">  thymeleaf:</span><br><span class="line">    cache: false</span><br><span class="line">    prefix: classpath:/templates/</span><br><span class="line">    suffix: .html</span><br><span class="line">    mode: HTML</span><br><span class="line">    encoding: UTF-8</span><br><span class="line">    </span><br><span class="line">server:</span><br><span class="line">  port: 8080</span><br><span class="line">  servlet:</span><br><span class="line">    context-path: /</span><br><span class="line">  </span><br><span class="line">  # 配置支持的最大消息大小</span><br><span class="line">  max-http-header-size: 64KB</span><br><span class="line">  </span><br><span class="line">logging:</span><br><span class="line">  level:</span><br><span class="line">    com.chatroom: DEBUG</span><br><span class="line">    org.springframework.web.socket: INFO</span><br></pre></td></tr></table></figure>



<h2 id="2-前端实现"><a href="#2-前端实现" class="headerlink" title="2. 前端实现"></a>2. 前端实现</h2><h3 id="2-1-HTML页面-index-html"><a href="#2-1-HTML页面-index-html" class="headerlink" title="2.1 HTML页面 (index.html)"></a>2.1 HTML页面 (index.html)</h3><p>html</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;zh-CN&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br><span class="line">    &lt;title&gt;多人聊天室&lt;/title&gt;</span><br><span class="line">    &lt;link rel=&quot;stylesheet&quot; href=&quot;css/chat.css&quot;&gt;</span><br><span class="line">    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css&quot;&gt;</span><br><span class="line">    &lt;link href=&quot;https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&amp;display=swap&quot; rel=&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;div class=&quot;container&quot;&gt;</span><br><span class="line">        &lt;!-- 侧边栏 - 用户列表 --&gt;</span><br><span class="line">        &lt;div class=&quot;sidebar&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;sidebar-header&quot;&gt;</span><br><span class="line">                &lt;h2&gt;&lt;i class=&quot;fas fa-comments&quot;&gt;&lt;/i&gt; 聊天室&lt;/h2&gt;</span><br><span class="line">                &lt;div class=&quot;online-status&quot;&gt;</span><br><span class="line">                    &lt;span class=&quot;status-indicator online&quot;&gt;&lt;/span&gt;</span><br><span class="line">                    &lt;span id=&quot;onlineCount&quot;&gt;0&lt;/span&gt; 人在线</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            </span><br><span class="line">            &lt;div class=&quot;user-profile&quot;&gt;</span><br><span class="line">                &lt;div class=&quot;avatar&quot; id=&quot;userAvatar&quot;&gt;&lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;user-info&quot;&gt;</span><br><span class="line">                    &lt;h3 id=&quot;usernameDisplay&quot;&gt;请设置用户名&lt;/h3&gt;</span><br><span class="line">                    &lt;p id=&quot;userStatus&quot;&gt;离线&lt;/p&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;button id=&quot;changeUsernameBtn&quot; class=&quot;icon-btn&quot; title=&quot;更改用户名&quot;&gt;</span><br><span class="line">                    &lt;i class=&quot;fas fa-edit&quot;&gt;&lt;/i&gt;</span><br><span class="line">                &lt;/button&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            </span><br><span class="line">            &lt;div class=&quot;search-box&quot;&gt;</span><br><span class="line">                &lt;input type=&quot;text&quot; id=&quot;userSearch&quot; placeholder=&quot;搜索用户...&quot;&gt;</span><br><span class="line">                &lt;i class=&quot;fas fa-search&quot;&gt;&lt;/i&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            </span><br><span class="line">            &lt;div class=&quot;users-list&quot;&gt;</span><br><span class="line">                &lt;h3&gt;在线用户 (&lt;span id=&quot;userCount&quot;&gt;0&lt;/span&gt;)&lt;/h3&gt;</span><br><span class="line">                &lt;ul id=&quot;onlineUsersList&quot;&gt;</span><br><span class="line">                    &lt;!-- 用户列表将通过JS动态添加 --&gt;</span><br><span class="line">                &lt;/ul&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            </span><br><span class="line">            &lt;div class=&quot;chat-rooms&quot;&gt;</span><br><span class="line">                &lt;h3&gt;聊天室&lt;/h3&gt;</span><br><span class="line">                &lt;ul&gt;</span><br><span class="line">                    &lt;li class=&quot;active&quot; data-room=&quot;public&quot;&gt;</span><br><span class="line">                        &lt;i class=&quot;fas fa-globe&quot;&gt;&lt;/i&gt; 公共聊天室</span><br><span class="line">                        &lt;span class=&quot;badge&quot; id=&quot;publicRoomCount&quot;&gt;0&lt;/span&gt;</span><br><span class="line">                    &lt;/li&gt;</span><br><span class="line">                    &lt;li data-room=&quot;private&quot;&gt;</span><br><span class="line">                        &lt;i class=&quot;fas fa-user-friends&quot;&gt;&lt;/i&gt; 私聊</span><br><span class="line">                    &lt;/li&gt;</span><br><span class="line">                &lt;/ul&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- 主聊天区域 --&gt;</span><br><span class="line">        &lt;div class=&quot;main-chat&quot;&gt;</span><br><span class="line">            &lt;!-- 聊天头 --&gt;</span><br><span class="line">            &lt;div class=&quot;chat-header&quot;&gt;</span><br><span class="line">                &lt;div class=&quot;chat-info&quot;&gt;</span><br><span class="line">                    &lt;h2 id=&quot;currentChatRoom&quot;&gt;公共聊天室&lt;/h2&gt;</span><br><span class="line">                    &lt;p id=&quot;roomDescription&quot;&gt;与所有在线用户聊天&lt;/p&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;chat-actions&quot;&gt;</span><br><span class="line">                    &lt;button id=&quot;clearChatBtn&quot; class=&quot;action-btn&quot; title=&quot;清空聊天记录&quot;&gt;</span><br><span class="line">                        &lt;i class=&quot;fas fa-trash&quot;&gt;&lt;/i&gt;</span><br><span class="line">                    &lt;/button&gt;</span><br><span class="line">                    &lt;button id=&quot;themeToggleBtn&quot; class=&quot;action-btn&quot; title=&quot;切换主题&quot;&gt;</span><br><span class="line">                        &lt;i class=&quot;fas fa-moon&quot;&gt;&lt;/i&gt;</span><br><span class="line">                    &lt;/button&gt;</span><br><span class="line">                    &lt;button id=&quot;notificationsBtn&quot; class=&quot;action-btn&quot; title=&quot;通知设置&quot;&gt;</span><br><span class="line">                        &lt;i class=&quot;fas fa-bell&quot;&gt;&lt;/i&gt;</span><br><span class="line">                    &lt;/button&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            </span><br><span class="line">            &lt;!-- 消息区域 --&gt;</span><br><span class="line">            &lt;div class=&quot;messages-container&quot; id=&quot;messagesContainer&quot;&gt;</span><br><span class="line">                &lt;!-- 消息将通过JS动态添加 --&gt;</span><br><span class="line">                &lt;div class=&quot;welcome-message&quot;&gt;</span><br><span class="line">                    &lt;div class=&quot;welcome-icon&quot;&gt;</span><br><span class="line">                        &lt;i class=&quot;fas fa-comment-dots&quot;&gt;&lt;/i&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                    &lt;h3&gt;欢迎来到聊天室!&lt;/h3&gt;</span><br><span class="line">                    &lt;p&gt;开始与大家聊天吧！输入消息并按回车键发送。&lt;/p&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            </span><br><span class="line">            &lt;!-- 输入区域 --&gt;</span><br><span class="line">            &lt;div class=&quot;input-container&quot;&gt;</span><br><span class="line">                &lt;div class=&quot;input-actions&quot;&gt;</span><br><span class="line">                    &lt;button class=&quot;input-action-btn&quot; title=&quot;表情&quot;&gt;</span><br><span class="line">                        &lt;i class=&quot;far fa-smile&quot;&gt;&lt;/i&gt;</span><br><span class="line">                    &lt;/button&gt;</span><br><span class="line">                    &lt;button class=&quot;input-action-btn&quot; title=&quot;上传文件&quot;&gt;</span><br><span class="line">                        &lt;i class=&quot;fas fa-paperclip&quot;&gt;&lt;/i&gt;</span><br><span class="line">                    &lt;/button&gt;</span><br><span class="line">                    &lt;button class=&quot;input-action-btn&quot; title=&quot;语音消息&quot;&gt;</span><br><span class="line">                        &lt;i class=&quot;fas fa-microphone&quot;&gt;&lt;/i&gt;</span><br><span class="line">                    &lt;/button&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                </span><br><span class="line">                &lt;div class=&quot;message-input-wrapper&quot;&gt;</span><br><span class="line">                    &lt;textarea </span><br><span class="line">                        id=&quot;messageInput&quot; </span><br><span class="line">                        placeholder=&quot;输入消息... (按Ctrl+Enter换行)&quot;</span><br><span class="line">                        rows=&quot;1&quot;</span><br><span class="line">                        disabled</span><br><span class="line">                    &gt;&lt;/textarea&gt;</span><br><span class="line">                    &lt;div class=&quot;typing-indicator&quot; id=&quot;typingIndicator&quot;&gt;</span><br><span class="line">                        有人正在输入...</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                </span><br><span class="line">                &lt;button id=&quot;sendButton&quot; class=&quot;send-btn&quot; disabled&gt;</span><br><span class="line">                    &lt;i class=&quot;fas fa-paper-plane&quot;&gt;&lt;/i&gt;</span><br><span class="line">                &lt;/button&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- 私聊侧边栏 --&gt;</span><br><span class="line">        &lt;div class=&quot;private-sidebar&quot; id=&quot;privateSidebar&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;private-header&quot;&gt;</span><br><span class="line">                &lt;h3&gt;&lt;i class=&quot;fas fa-user-secret&quot;&gt;&lt;/i&gt; 私聊&lt;/h3&gt;</span><br><span class="line">                &lt;button id=&quot;closePrivateBtn&quot; class=&quot;close-btn&quot;&gt;</span><br><span class="line">                    &lt;i class=&quot;fas fa-times&quot;&gt;&lt;/i&gt;</span><br><span class="line">                &lt;/button&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;private-chats&quot; id=&quot;privateChats&quot;&gt;</span><br><span class="line">                &lt;!-- 私聊会话将通过JS动态添加 --&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!-- 用户名设置模态框 --&gt;</span><br><span class="line">    &lt;div class=&quot;modal-overlay&quot; id=&quot;usernameModal&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;modal&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;modal-header&quot;&gt;</span><br><span class="line">                &lt;h3&gt;设置用户名&lt;/h3&gt;</span><br><span class="line">                &lt;button class=&quot;close-modal&quot;&gt;&amp;times;&lt;/button&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;modal-body&quot;&gt;</span><br><span class="line">                &lt;div class=&quot;form-group&quot;&gt;</span><br><span class="line">                    &lt;label for=&quot;usernameInput&quot;&gt;用户名&lt;/label&gt;</span><br><span class="line">                    &lt;input </span><br><span class="line">                        type=&quot;text&quot; </span><br><span class="line">                        id=&quot;usernameInput&quot; </span><br><span class="line">                        placeholder=&quot;输入您的用户名&quot;</span><br><span class="line">                        maxlength=&quot;20&quot;</span><br><span class="line">                        autocomplete=&quot;off&quot;</span><br><span class="line">                    &gt;</span><br><span class="line">                    &lt;div class=&quot;error-message&quot; id=&quot;usernameError&quot;&gt;&lt;/div&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;avatar-selection&quot;&gt;</span><br><span class="line">                    &lt;p&gt;选择头像颜色:&lt;/p&gt;</span><br><span class="line">                    &lt;div class=&quot;color-options&quot; id=&quot;colorOptions&quot;&gt;</span><br><span class="line">                        &lt;!-- 颜色选项将通过JS动态生成 --&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;modal-footer&quot;&gt;</span><br><span class="line">                &lt;button id=&quot;joinChatBtn&quot; class=&quot;btn-primary&quot;&gt;</span><br><span class="line">                    &lt;i class=&quot;fas fa-sign-in-alt&quot;&gt;&lt;/i&gt; 加入聊天室</span><br><span class="line">                &lt;/button&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!-- 通知设置模态框 --&gt;</span><br><span class="line">    &lt;div class=&quot;modal-overlay&quot; id=&quot;settingsModal&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;modal&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;modal-header&quot;&gt;</span><br><span class="line">                &lt;h3&gt;通知设置&lt;/h3&gt;</span><br><span class="line">                &lt;button class=&quot;close-modal&quot;&gt;&amp;times;&lt;/button&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;modal-body&quot;&gt;</span><br><span class="line">                &lt;div class=&quot;setting-item&quot;&gt;</span><br><span class="line">                    &lt;label&gt;</span><br><span class="line">                        &lt;input type=&quot;checkbox&quot; id=&quot;soundNotification&quot; checked&gt;</span><br><span class="line">                        &lt;span&gt;消息提示音&lt;/span&gt;</span><br><span class="line">                    &lt;/label&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;setting-item&quot;&gt;</span><br><span class="line">                    &lt;label&gt;</span><br><span class="line">                        &lt;input type=&quot;checkbox&quot; id=&quot;desktopNotification&quot; checked&gt;</span><br><span class="line">                        &lt;span&gt;桌面通知&lt;/span&gt;</span><br><span class="line">                    &lt;/label&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;setting-item&quot;&gt;</span><br><span class="line">                    &lt;label&gt;</span><br><span class="line">                        &lt;input type=&quot;checkbox&quot; id=&quot;typingNotification&quot; checked&gt;</span><br><span class="line">                        &lt;span&gt;显示&quot;正在输入&quot;状态&lt;/span&gt;</span><br><span class="line">                    &lt;/label&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!-- 脚本 --&gt;</span><br><span class="line">    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/sockjs-client@1.5.0/dist/sockjs.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=&quot;js/chat.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>



<h3 id="2-2-CSS样式-chat-css"><a href="#2-2-CSS样式-chat-css" class="headerlink" title="2.2 CSS样式 (chat.css)"></a>2.2 CSS样式 (chat.css)</h3><p>css</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br></pre></td><td class="code"><pre><span class="line">:root &#123;</span><br><span class="line">    --primary-color: #4361ee;</span><br><span class="line">    --secondary-color: #3a0ca3;</span><br><span class="line">    --success-color: #06d6a0;</span><br><span class="line">    --danger-color: #ef476f;</span><br><span class="line">    --warning-color: #ffd166;</span><br><span class="line">    --dark-color: #2b2d42;</span><br><span class="line">    --light-color: #f8f9fa;</span><br><span class="line">    --gray-color: #adb5bd;</span><br><span class="line">    --border-radius: 12px;</span><br><span class="line">    --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);</span><br><span class="line">    --transition: all 0.3s ease;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">* &#123;</span><br><span class="line">    margin: 0;</span><br><span class="line">    padding: 0;</span><br><span class="line">    box-sizing: border-box;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body &#123;</span><br><span class="line">    font-family: &#x27;Poppins&#x27;, sans-serif;</span><br><span class="line">    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);</span><br><span class="line">    min-height: 100vh;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    align-items: center;</span><br><span class="line">    padding: 20px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.container &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    width: 100%;</span><br><span class="line">    max-width: 1400px;</span><br><span class="line">    height: 90vh;</span><br><span class="line">    background: white;</span><br><span class="line">    border-radius: var(--border-radius);</span><br><span class="line">    overflow: hidden;</span><br><span class="line">    box-shadow: var(--box-shadow);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 侧边栏样式 */</span><br><span class="line">.sidebar &#123;</span><br><span class="line">    width: 300px;</span><br><span class="line">    background: var(--dark-color);</span><br><span class="line">    color: white;</span><br><span class="line">    display: flex;</span><br><span class="line">    flex-direction: column;</span><br><span class="line">    border-right: 1px solid rgba(255, 255, 255, 0.1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.sidebar-header &#123;</span><br><span class="line">    padding: 25px 20px;</span><br><span class="line">    border-bottom: 1px solid rgba(255, 255, 255, 0.1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.sidebar-header h2 &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    gap: 10px;</span><br><span class="line">    font-size: 1.5rem;</span><br><span class="line">    margin-bottom: 10px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.online-status &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    gap: 8px;</span><br><span class="line">    font-size: 0.9rem;</span><br><span class="line">    color: var(--gray-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.status-indicator &#123;</span><br><span class="line">    width: 8px;</span><br><span class="line">    height: 8px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    background: var(--success-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.status-indicator.online &#123;</span><br><span class="line">    background: var(--success-color);</span><br><span class="line">    animation: pulse 2s infinite;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@keyframes pulse &#123;</span><br><span class="line">    0% &#123; opacity: 1; &#125;</span><br><span class="line">    50% &#123; opacity: 0.5; &#125;</span><br><span class="line">    100% &#123; opacity: 1; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-profile &#123;</span><br><span class="line">    padding: 20px;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    gap: 15px;</span><br><span class="line">    border-bottom: 1px solid rgba(255, 255, 255, 0.1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.avatar &#123;</span><br><span class="line">    width: 50px;</span><br><span class="line">    height: 50px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    font-weight: bold;</span><br><span class="line">    font-size: 1.2rem;</span><br><span class="line">    color: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-info &#123;</span><br><span class="line">    flex: 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-info h3 &#123;</span><br><span class="line">    font-size: 1.1rem;</span><br><span class="line">    margin-bottom: 5px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-info p &#123;</span><br><span class="line">    font-size: 0.85rem;</span><br><span class="line">    color: var(--gray-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.icon-btn &#123;</span><br><span class="line">    background: rgba(255, 255, 255, 0.1);</span><br><span class="line">    border: none;</span><br><span class="line">    width: 36px;</span><br><span class="line">    height: 36px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    color: white;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.icon-btn:hover &#123;</span><br><span class="line">    background: rgba(255, 255, 255, 0.2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.search-box &#123;</span><br><span class="line">    padding: 15px 20px;</span><br><span class="line">    position: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.search-box input &#123;</span><br><span class="line">    width: 100%;</span><br><span class="line">    padding: 10px 15px 10px 40px;</span><br><span class="line">    background: rgba(255, 255, 255, 0.1);</span><br><span class="line">    border: 1px solid rgba(255, 255, 255, 0.2);</span><br><span class="line">    border-radius: 20px;</span><br><span class="line">    color: white;</span><br><span class="line">    font-size: 0.9rem;</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.search-box input:focus &#123;</span><br><span class="line">    outline: none;</span><br><span class="line">    border-color: var(--primary-color);</span><br><span class="line">    background: rgba(255, 255, 255, 0.15);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.search-box i &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    left: 35px;</span><br><span class="line">    top: 50%;</span><br><span class="line">    transform: translateY(-50%);</span><br><span class="line">    color: var(--gray-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.users-list, .chat-rooms &#123;</span><br><span class="line">    padding: 20px;</span><br><span class="line">    flex: 1;</span><br><span class="line">    overflow-y: auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.users-list h3, .chat-rooms h3 &#123;</span><br><span class="line">    font-size: 0.9rem;</span><br><span class="line">    text-transform: uppercase;</span><br><span class="line">    letter-spacing: 1px;</span><br><span class="line">    margin-bottom: 15px;</span><br><span class="line">    color: var(--gray-color);</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    align-items: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.users-list ul, .chat-rooms ul &#123;</span><br><span class="line">    list-style: none;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-item, .chat-rooms li &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    gap: 10px;</span><br><span class="line">    padding: 12px 15px;</span><br><span class="line">    border-radius: var(--border-radius);</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">    margin-bottom: 5px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-item:hover, .chat-rooms li:hover &#123;</span><br><span class="line">    background: rgba(255, 255, 255, 0.1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-item.active, .chat-rooms li.active &#123;</span><br><span class="line">    background: rgba(67, 97, 238, 0.2);</span><br><span class="line">    border-left: 3px solid var(--primary-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-avatar &#123;</span><br><span class="line">    width: 40px;</span><br><span class="line">    height: 40px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    font-weight: bold;</span><br><span class="line">    color: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-details &#123;</span><br><span class="line">    flex: 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-details h4 &#123;</span><br><span class="line">    font-size: 0.95rem;</span><br><span class="line">    margin-bottom: 3px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-details p &#123;</span><br><span class="line">    font-size: 0.8rem;</span><br><span class="line">    color: var(--gray-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-status &#123;</span><br><span class="line">    width: 8px;</span><br><span class="line">    height: 8px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-status.online &#123;</span><br><span class="line">    background: var(--success-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-status.away &#123;</span><br><span class="line">    background: var(--warning-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-status.offline &#123;</span><br><span class="line">    background: var(--danger-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.chat-rooms li &#123;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.badge &#123;</span><br><span class="line">    background: var(--primary-color);</span><br><span class="line">    color: white;</span><br><span class="line">    padding: 2px 8px;</span><br><span class="line">    border-radius: 10px;</span><br><span class="line">    font-size: 0.8rem;</span><br><span class="line">    min-width: 25px;</span><br><span class="line">    text-align: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 主聊天区域 */</span><br><span class="line">.main-chat &#123;</span><br><span class="line">    flex: 1;</span><br><span class="line">    display: flex;</span><br><span class="line">    flex-direction: column;</span><br><span class="line">    background: #f5f7fb;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.chat-header &#123;</span><br><span class="line">    padding: 20px 30px;</span><br><span class="line">    background: white;</span><br><span class="line">    border-bottom: 1px solid #eaeaea;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    align-items: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.chat-info h2 &#123;</span><br><span class="line">    font-size: 1.4rem;</span><br><span class="line">    color: var(--dark-color);</span><br><span class="line">    margin-bottom: 5px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.chat-info p &#123;</span><br><span class="line">    color: var(--gray-color);</span><br><span class="line">    font-size: 0.9rem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.chat-actions &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    gap: 10px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.action-btn &#123;</span><br><span class="line">    background: none;</span><br><span class="line">    border: none;</span><br><span class="line">    width: 40px;</span><br><span class="line">    height: 40px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    color: var(--dark-color);</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">    font-size: 1.1rem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.action-btn:hover &#123;</span><br><span class="line">    background: #f0f0f0;</span><br><span class="line">    color: var(--primary-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.messages-container &#123;</span><br><span class="line">    flex: 1;</span><br><span class="line">    padding: 20px 30px;</span><br><span class="line">    overflow-y: auto;</span><br><span class="line">    display: flex;</span><br><span class="line">    flex-direction: column;</span><br><span class="line">    gap: 15px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.welcome-message &#123;</span><br><span class="line">    text-align: center;</span><br><span class="line">    padding: 40px 20px;</span><br><span class="line">    color: var(--gray-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.welcome-icon &#123;</span><br><span class="line">    font-size: 3rem;</span><br><span class="line">    color: var(--primary-color);</span><br><span class="line">    margin-bottom: 20px;</span><br><span class="line">    opacity: 0.5;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.message &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    gap: 15px;</span><br><span class="line">    max-width: 70%;</span><br><span class="line">    animation: fadeIn 0.3s ease;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@keyframes fadeIn &#123;</span><br><span class="line">    from &#123; opacity: 0; transform: translateY(10px); &#125;</span><br><span class="line">    to &#123; opacity: 1; transform: translateY(0); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.message.incoming &#123;</span><br><span class="line">    align-self: flex-start;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.message.outgoing &#123;</span><br><span class="line">    align-self: flex-end;</span><br><span class="line">    flex-direction: row-reverse;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.message-avatar &#123;</span><br><span class="line">    width: 40px;</span><br><span class="line">    height: 40px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    font-weight: bold;</span><br><span class="line">    color: white;</span><br><span class="line">    flex-shrink: 0;</span><br><span class="line">    font-size: 0.9rem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.message-content &#123;</span><br><span class="line">    background: white;</span><br><span class="line">    padding: 15px;</span><br><span class="line">    border-radius: var(--border-radius);</span><br><span class="line">    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);</span><br><span class="line">    position: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.message.incoming .message-content &#123;</span><br><span class="line">    border-top-left-radius: 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.message.outgoing .message-content &#123;</span><br><span class="line">    background: var(--primary-color);</span><br><span class="line">    color: white;</span><br><span class="line">    border-top-right-radius: 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.message-header &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    align-items: center;</span><br><span class="line">    margin-bottom: 8px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.message-sender &#123;</span><br><span class="line">    font-weight: 600;</span><br><span class="line">    font-size: 0.95rem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.message-time &#123;</span><br><span class="line">    font-size: 0.8rem;</span><br><span class="line">    opacity: 0.7;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.message-text &#123;</span><br><span class="line">    line-height: 1.5;</span><br><span class="line">    word-break: break-word;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.message-status &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: flex-end;</span><br><span class="line">    gap: 5px;</span><br><span class="line">    margin-top: 8px;</span><br><span class="line">    font-size: 0.8rem;</span><br><span class="line">    opacity: 0.7;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.join-leave-message &#123;</span><br><span class="line">    text-align: center;</span><br><span class="line">    margin: 10px 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.join-leave-message .message-content &#123;</span><br><span class="line">    background: rgba(255, 255, 255, 0.5);</span><br><span class="line">    color: var(--gray-color);</span><br><span class="line">    font-style: italic;</span><br><span class="line">    display: inline-block;</span><br><span class="line">    padding: 8px 20px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 输入区域 */</span><br><span class="line">.input-container &#123;</span><br><span class="line">    padding: 20px 30px;</span><br><span class="line">    background: white;</span><br><span class="line">    border-top: 1px solid #eaeaea;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: flex-end;</span><br><span class="line">    gap: 15px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.input-actions &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    flex-direction: column;</span><br><span class="line">    gap: 10px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.input-action-btn &#123;</span><br><span class="line">    background: none;</span><br><span class="line">    border: none;</span><br><span class="line">    width: 40px;</span><br><span class="line">    height: 40px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    color: var(--gray-color);</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">    font-size: 1.2rem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.input-action-btn:hover &#123;</span><br><span class="line">    background: #f0f0f0;</span><br><span class="line">    color: var(--primary-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.message-input-wrapper &#123;</span><br><span class="line">    flex: 1;</span><br><span class="line">    position: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#messageInput &#123;</span><br><span class="line">    width: 100%;</span><br><span class="line">    padding: 15px 20px;</span><br><span class="line">    border: 1px solid #eaeaea;</span><br><span class="line">    border-radius: var(--border-radius);</span><br><span class="line">    font-family: &#x27;Poppins&#x27;, sans-serif;</span><br><span class="line">    font-size: 1rem;</span><br><span class="line">    resize: none;</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">    max-height: 150px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#messageInput:focus &#123;</span><br><span class="line">    outline: none;</span><br><span class="line">    border-color: var(--primary-color);</span><br><span class="line">    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#messageInput:disabled &#123;</span><br><span class="line">    background: #f9f9f9;</span><br><span class="line">    cursor: not-allowed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.typing-indicator &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    bottom: 10px;</span><br><span class="line">    left: 20px;</span><br><span class="line">    font-size: 0.85rem;</span><br><span class="line">    color: var(--primary-color);</span><br><span class="line">    opacity: 0;</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    gap: 5px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.typing-indicator.show &#123;</span><br><span class="line">    opacity: 1;</span><br><span class="line">    bottom: -25px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.send-btn &#123;</span><br><span class="line">    background: var(--primary-color);</span><br><span class="line">    border: none;</span><br><span class="line">    width: 50px;</span><br><span class="line">    height: 50px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    color: white;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">    font-size: 1.2rem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.send-btn:hover:not(:disabled) &#123;</span><br><span class="line">    background: var(--secondary-color);</span><br><span class="line">    transform: translateY(-2px);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.send-btn:disabled &#123;</span><br><span class="line">    background: var(--gray-color);</span><br><span class="line">    cursor: not-allowed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 私聊侧边栏 */</span><br><span class="line">.private-sidebar &#123;</span><br><span class="line">    width: 350px;</span><br><span class="line">    background: white;</span><br><span class="line">    border-left: 1px solid #eaeaea;</span><br><span class="line">    display: flex;</span><br><span class="line">    flex-direction: column;</span><br><span class="line">    display: none;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.private-sidebar.show &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.private-header &#123;</span><br><span class="line">    padding: 20px;</span><br><span class="line">    border-bottom: 1px solid #eaeaea;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    align-items: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.private-header h3 &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    gap: 10px;</span><br><span class="line">    color: var(--dark-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.close-btn &#123;</span><br><span class="line">    background: none;</span><br><span class="line">    border: none;</span><br><span class="line">    width: 30px;</span><br><span class="line">    height: 30px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    color: var(--gray-color);</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.close-btn:hover &#123;</span><br><span class="line">    background: #f0f0f0;</span><br><span class="line">    color: var(--danger-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.private-chats &#123;</span><br><span class="line">    flex: 1;</span><br><span class="line">    padding: 20px;</span><br><span class="line">    overflow-y: auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.private-chat-item &#123;</span><br><span class="line">    padding: 15px;</span><br><span class="line">    border-radius: var(--border-radius);</span><br><span class="line">    background: #f9f9f9;</span><br><span class="line">    margin-bottom: 15px;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">    border: 1px solid transparent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.private-chat-item:hover &#123;</span><br><span class="line">    background: #f0f0f0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.private-chat-item.active &#123;</span><br><span class="line">    background: white;</span><br><span class="line">    border-color: var(--primary-color);</span><br><span class="line">    box-shadow: 0 2px 10px rgba(67, 97, 238, 0.1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.private-chat-header &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    gap: 10px;</span><br><span class="line">    margin-bottom: 10px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.private-chat-avatar &#123;</span><br><span class="line">    width: 35px;</span><br><span class="line">    height: 35px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    font-weight: bold;</span><br><span class="line">    color: white;</span><br><span class="line">    font-size: 0.9rem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.private-chat-info h4 &#123;</span><br><span class="line">    font-size: 0.95rem;</span><br><span class="line">    margin-bottom: 3px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.private-chat-info p &#123;</span><br><span class="line">    font-size: 0.8rem;</span><br><span class="line">    color: var(--gray-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.private-chat-preview &#123;</span><br><span class="line">    font-size: 0.9rem;</span><br><span class="line">    color: #666;</span><br><span class="line">    overflow: hidden;</span><br><span class="line">    text-overflow: ellipsis;</span><br><span class="line">    white-space: nowrap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 模态框样式 */</span><br><span class="line">.modal-overlay &#123;</span><br><span class="line">    position: fixed;</span><br><span class="line">    top: 0;</span><br><span class="line">    left: 0;</span><br><span class="line">    width: 100%;</span><br><span class="line">    height: 100%;</span><br><span class="line">    background: rgba(0, 0, 0, 0.5);</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    align-items: center;</span><br><span class="line">    z-index: 1000;</span><br><span class="line">    opacity: 0;</span><br><span class="line">    visibility: hidden;</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.modal-overlay.show &#123;</span><br><span class="line">    opacity: 1;</span><br><span class="line">    visibility: visible;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.modal &#123;</span><br><span class="line">    background: white;</span><br><span class="line">    border-radius: var(--border-radius);</span><br><span class="line">    width: 90%;</span><br><span class="line">    max-width: 500px;</span><br><span class="line">    box-shadow: var(--box-shadow);</span><br><span class="line">    transform: translateY(-20px);</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.modal-overlay.show .modal &#123;</span><br><span class="line">    transform: translateY(0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.modal-header &#123;</span><br><span class="line">    padding: 25px 30px;</span><br><span class="line">    border-bottom: 1px solid #eaeaea;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    align-items: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.modal-header h3 &#123;</span><br><span class="line">    color: var(--dark-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.close-modal &#123;</span><br><span class="line">    background: none;</span><br><span class="line">    border: none;</span><br><span class="line">    font-size: 1.5rem;</span><br><span class="line">    color: var(--gray-color);</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">    line-height: 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.close-modal:hover &#123;</span><br><span class="line">    color: var(--danger-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.modal-body &#123;</span><br><span class="line">    padding: 30px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.form-group &#123;</span><br><span class="line">    margin-bottom: 25px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.form-group label &#123;</span><br><span class="line">    display: block;</span><br><span class="line">    margin-bottom: 8px;</span><br><span class="line">    color: var(--dark-color);</span><br><span class="line">    font-weight: 500;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.form-group input &#123;</span><br><span class="line">    width: 100%;</span><br><span class="line">    padding: 12px 15px;</span><br><span class="line">    border: 1px solid #ddd;</span><br><span class="line">    border-radius: 8px;</span><br><span class="line">    font-family: &#x27;Poppins&#x27;, sans-serif;</span><br><span class="line">    font-size: 1rem;</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.form-group input:focus &#123;</span><br><span class="line">    outline: none;</span><br><span class="line">    border-color: var(--primary-color);</span><br><span class="line">    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.error-message &#123;</span><br><span class="line">    color: var(--danger-color);</span><br><span class="line">    font-size: 0.85rem;</span><br><span class="line">    margin-top: 5px;</span><br><span class="line">    min-height: 20px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.avatar-selection p &#123;</span><br><span class="line">    margin-bottom: 10px;</span><br><span class="line">    color: var(--dark-color);</span><br><span class="line">    font-weight: 500;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.color-options &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    flex-wrap: wrap;</span><br><span class="line">    gap: 10px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.color-option &#123;</span><br><span class="line">    width: 40px;</span><br><span class="line">    height: 40px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">    border: 3px solid transparent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.color-option:hover &#123;</span><br><span class="line">    transform: scale(1.1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.color-option.selected &#123;</span><br><span class="line">    border-color: var(--dark-color);</span><br><span class="line">    transform: scale(1.1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.modal-footer &#123;</span><br><span class="line">    padding: 0 30px 30px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.btn-primary &#123;</span><br><span class="line">    background: var(--primary-color);</span><br><span class="line">    color: white;</span><br><span class="line">    border: none;</span><br><span class="line">    padding: 12px 30px;</span><br><span class="line">    border-radius: 8px;</span><br><span class="line">    font-family: &#x27;Poppins&#x27;, sans-serif;</span><br><span class="line">    font-size: 1rem;</span><br><span class="line">    font-weight: 500;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    gap: 10px;</span><br><span class="line">    width: 100%;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.btn-primary:hover &#123;</span><br><span class="line">    background: var(--secondary-color);</span><br><span class="line">    transform: translateY(-2px);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.setting-item &#123;</span><br><span class="line">    margin-bottom: 15px;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.setting-item label &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    gap: 10px;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    width: 100%;</span><br><span class="line">    padding: 10px;</span><br><span class="line">    border-radius: 8px;</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.setting-item label:hover &#123;</span><br><span class="line">    background: #f9f9f9;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.setting-item input[type=&quot;checkbox&quot;] &#123;</span><br><span class="line">    width: 18px;</span><br><span class="line">    height: 18px;</span><br><span class="line">    accent-color: var(--primary-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 响应式设计 */</span><br><span class="line">@media (max-width: 1024px) &#123;</span><br><span class="line">    .container &#123;</span><br><span class="line">        height: 95vh;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    .sidebar &#123;</span><br><span class="line">        width: 250px;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    .private-sidebar &#123;</span><br><span class="line">        width: 300px;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@media (max-width: 768px) &#123;</span><br><span class="line">    body &#123;</span><br><span class="line">        padding: 10px;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    .container &#123;</span><br><span class="line">        height: 95vh;</span><br><span class="line">        flex-direction: column;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    .sidebar &#123;</span><br><span class="line">        width: 100%;</span><br><span class="line">        height: 200px;</span><br><span class="line">        border-right: none;</span><br><span class="line">        border-bottom: 1px solid rgba(255, 255, 255, 0.1);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    .main-chat &#123;</span><br><span class="line">        height: calc(100% - 200px);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    .private-sidebar &#123;</span><br><span class="line">        position: absolute;</span><br><span class="line">        top: 0;</span><br><span class="line">        right: 0;</span><br><span class="line">        height: 100%;</span><br><span class="line">        width: 100%;</span><br><span class="line">        max-width: 400px;</span><br><span class="line">        box-shadow: -5px 0 20px rgba(0, 0, 0, 0.1);</span><br><span class="line">        z-index: 100;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    .messages-container &#123;</span><br><span class="line">        padding: 15px;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    .chat-header, .input-container &#123;</span><br><span class="line">        padding: 15px;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 滚动条样式 */</span><br><span class="line">::-webkit-scrollbar &#123;</span><br><span class="line">    width: 8px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">::-webkit-scrollbar-track &#123;</span><br><span class="line">    background: rgba(0, 0, 0, 0.05);</span><br><span class="line">    border-radius: 4px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">::-webkit-scrollbar-thumb &#123;</span><br><span class="line">    background: rgba(0, 0, 0, 0.2);</span><br><span class="line">    border-radius: 4px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">::-webkit-scrollbar-thumb:hover &#123;</span><br><span class="line">    background: rgba(0, 0, 0, 0.3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-3-JavaScript功能-chat-js"><a href="#2-3-JavaScript功能-chat-js" class="headerlink" title="2.3 JavaScript功能 (chat.js)"></a>2.3 JavaScript功能 (chat.js)</h3><p>javascript</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br></pre></td><td class="code"><pre><span class="line">// 聊天室主要功能</span><br><span class="line">class ChatRoom &#123;</span><br><span class="line">    constructor() &#123;</span><br><span class="line">        this.stompClient = null;</span><br><span class="line">        this.username = null;</span><br><span class="line">        this.avatarColor = &#x27;#4361ee&#x27;;</span><br><span class="line">        this.connected = false;</span><br><span class="line">        this.typingTimeout = null;</span><br><span class="line">        this.privateChats = new Map(); // 存储私聊会话</span><br><span class="line">        this.currentPrivateChat = null;</span><br><span class="line">        </span><br><span class="line">        // 颜色选项</span><br><span class="line">        this.colorOptions = [</span><br><span class="line">            &#x27;#FF6B6B&#x27;, &#x27;#4ECDC4&#x27;, &#x27;#FFD166&#x27;, &#x27;#06D6A0&#x27;,</span><br><span class="line">            &#x27;#118AB2&#x27;, &#x27;#073B4C&#x27;, &#x27;#EF476F&#x27;, &#x27;#7209B7&#x27;</span><br><span class="line">        ];</span><br><span class="line">        </span><br><span class="line">        this.init();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    init() &#123;</span><br><span class="line">        this.cacheElements();</span><br><span class="line">        this.bindEvents();</span><br><span class="line">        this.showUsernameModal();</span><br><span class="line">        this.initColorOptions();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    cacheElements() &#123;</span><br><span class="line">        // 模态框</span><br><span class="line">        this.usernameModal = document.getElementById(&#x27;usernameModal&#x27;);</span><br><span class="line">        this.settingsModal = document.getElementById(&#x27;settingsModal&#x27;);</span><br><span class="line">        </span><br><span class="line">        // 输入元素</span><br><span class="line">        this.usernameInput = document.getElementById(&#x27;usernameInput&#x27;);</span><br><span class="line">        this.messageInput = document.getElementById(&#x27;messageInput&#x27;);</span><br><span class="line">        </span><br><span class="line">        // 按钮</span><br><span class="line">        this.joinChatBtn = document.getElementById(&#x27;joinChatBtn&#x27;);</span><br><span class="line">        this.sendButton = document.getElementById(&#x27;sendButton&#x27;);</span><br><span class="line">        this.changeUsernameBtn = document.getElementById(&#x27;changeUsernameBtn&#x27;);</span><br><span class="line">        this.clearChatBtn = document.getElementById(&#x27;clearChatBtn&#x27;);</span><br><span class="line">        this.themeToggleBtn = document.getElementById(&#x27;themeToggleBtn&#x27;);</span><br><span class="line">        this.notificationsBtn = document.getElementById(&#x27;notificationsBtn&#x27;);</span><br><span class="line">        this.closePrivateBtn = document.getElementById(&#x27;closePrivateBtn&#x27;);</span><br><span class="line">        </span><br><span class="line">        // 显示元素</span><br><span class="line">        this.usernameDisplay = document.getElementById(&#x27;usernameDisplay&#x27;);</span><br><span class="line">        this.userAvatar = document.getElementById(&#x27;userAvatar&#x27;);</span><br><span class="line">        this.onlineCount = document.getElementById(&#x27;onlineCount&#x27;);</span><br><span class="line">        this.userCount = document.getElementById(&#x27;userCount&#x27;);</span><br><span class="line">        this.onlineUsersList = document.getElementById(&#x27;onlineUsersList&#x27;);</span><br><span class="line">        this.messagesContainer = document.getElementById(&#x27;messagesContainer&#x27;);</span><br><span class="line">        this.typingIndicator = document.getElementById(&#x27;typingIndicator&#x27;);</span><br><span class="line">        this.privateSidebar = document.getElementById(&#x27;privateSidebar&#x27;);</span><br><span class="line">        this.privateChatsContainer = document.getElementById(&#x27;privateChats&#x27;);</span><br><span class="line">        </span><br><span class="line">        // 聊天室切换</span><br><span class="line">        this.chatRooms = document.querySelectorAll(&#x27;.chat-rooms li&#x27;);</span><br><span class="line">        this.currentChatRoom = document.getElementById(&#x27;currentChatRoom&#x27;);</span><br><span class="line">        </span><br><span class="line">        // 错误消息</span><br><span class="line">        this.usernameError = document.getElementById(&#x27;usernameError&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    bindEvents() &#123;</span><br><span class="line">        // 用户名设置</span><br><span class="line">        this.joinChatBtn.addEventListener(&#x27;click&#x27;, () =&gt; this.handleJoinChat());</span><br><span class="line">        this.usernameInput.addEventListener(&#x27;keypress&#x27;, (e) =&gt; &#123;</span><br><span class="line">            if (e.key === &#x27;Enter&#x27;) this.handleJoinChat();</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        // 消息发送</span><br><span class="line">        this.sendButton.addEventListener(&#x27;click&#x27;, () =&gt; this.sendMessage());</span><br><span class="line">        this.messageInput.addEventListener(&#x27;keydown&#x27;, (e) =&gt; &#123;</span><br><span class="line">            if (e.key === &#x27;Enter&#x27; &amp;&amp; !e.shiftKey &amp;&amp; !e.ctrlKey) &#123;</span><br><span class="line">                e.preventDefault();</span><br><span class="line">                this.sendMessage();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 触发输入事件（用于显示&quot;正在输入&quot;）</span><br><span class="line">            this.handleTyping();</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        // 消息输入框自动调整高度</span><br><span class="line">        this.messageInput.addEventListener(&#x27;input&#x27;, () =&gt; &#123;</span><br><span class="line">            this.messageInput.style.height = &#x27;auto&#x27;;</span><br><span class="line">            this.messageInput.style.height = Math.min(this.messageInput.scrollHeight, 150) + &#x27;px&#x27;;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        // 更改用户名</span><br><span class="line">        this.changeUsernameBtn.addEventListener(&#x27;click&#x27;, () =&gt; this.showUsernameModal());</span><br><span class="line">        </span><br><span class="line">        // 清除聊天记录</span><br><span class="line">        this.clearChatBtn.addEventListener(&#x27;click&#x27;, () =&gt; this.clearChat());</span><br><span class="line">        </span><br><span class="line">        // 切换主题</span><br><span class="line">        this.themeToggleBtn.addEventListener(&#x27;click&#x27;, () =&gt; this.toggleTheme());</span><br><span class="line">        </span><br><span class="line">        // 通知设置</span><br><span class="line">        this.notificationsBtn.addEventListener(&#x27;click&#x27;, () =&gt; this.showSettingsModal());</span><br><span class="line">        </span><br><span class="line">        // 关闭私聊侧边栏</span><br><span class="line">        this.closePrivateBtn.addEventListener(&#x27;click&#x27;, () =&gt; this.hidePrivateSidebar());</span><br><span class="line">        </span><br><span class="line">        // 聊天室切换</span><br><span class="line">        this.chatRooms.forEach(room =&gt; &#123;</span><br><span class="line">            room.addEventListener(&#x27;click&#x27;, (e) =&gt; this.switchChatRoom(e));</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        // 关闭模态框</span><br><span class="line">        document.querySelectorAll(&#x27;.close-modal&#x27;).forEach(btn =&gt; &#123;</span><br><span class="line">            btn.addEventListener(&#x27;click&#x27;, () =&gt; this.closeAllModals());</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        // 点击模态框外部关闭</span><br><span class="line">        document.querySelectorAll(&#x27;.modal-overlay&#x27;).forEach(modal =&gt; &#123;</span><br><span class="line">            modal.addEventListener(&#x27;click&#x27;, (e) =&gt; &#123;</span><br><span class="line">                if (e.target === modal) this.closeAllModals();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        // 搜索用户</span><br><span class="line">        const userSearch = document.getElementById(&#x27;userSearch&#x27;);</span><br><span class="line">        if (userSearch) &#123;</span><br><span class="line">            userSearch.addEventListener(&#x27;input&#x27;, (e) =&gt; this.filterUsers(e.target.value));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    initColorOptions() &#123;</span><br><span class="line">        const container = document.getElementById(&#x27;colorOptions&#x27;);</span><br><span class="line">        this.colorOptions.forEach(color =&gt; &#123;</span><br><span class="line">            const div = document.createElement(&#x27;div&#x27;);</span><br><span class="line">            div.className = &#x27;color-option&#x27;;</span><br><span class="line">            div.style.backgroundColor = color;</span><br><span class="line">            div.dataset.color = color;</span><br><span class="line">            </span><br><span class="line">            if (color === this.avatarColor) &#123;</span><br><span class="line">                div.classList.add(&#x27;selected&#x27;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            div.addEventListener(&#x27;click&#x27;, () =&gt; &#123;</span><br><span class="line">                document.querySelectorAll(&#x27;.color-option&#x27;).forEach(opt =&gt; &#123;</span><br><span class="line">                    opt.classList.remove(&#x27;selected&#x27;);</span><br><span class="line">                &#125;);</span><br><span class="line">                div.classList.add(&#x27;selected&#x27;);</span><br><span class="line">                this.avatarColor = color;</span><br><span class="line">                this.updateUserAvatar();</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            container.appendChild(div);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    showUsernameModal() &#123;</span><br><span class="line">        this.usernameModal.classList.add(&#x27;show&#x27;);</span><br><span class="line">        this.usernameInput.focus();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    showSettingsModal() &#123;</span><br><span class="line">        this.settingsModal.classList.add(&#x27;show&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    closeAllModals() &#123;</span><br><span class="line">        document.querySelectorAll(&#x27;.modal-overlay&#x27;).forEach(modal =&gt; &#123;</span><br><span class="line">            modal.classList.remove(&#x27;show&#x27;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    handleJoinChat() &#123;</span><br><span class="line">        const username = this.usernameInput.value.trim();</span><br><span class="line">        </span><br><span class="line">        if (!username) &#123;</span><br><span class="line">            this.showError(&#x27;请输入用户名&#x27;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (username.length &lt; 3) &#123;</span><br><span class="line">            this.showError(&#x27;用户名至少需要3个字符&#x27;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (username.length &gt; 20) &#123;</span><br><span class="line">            this.showError(&#x27;用户名不能超过20个字符&#x27;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (!/^[a-zA-Z0-9\u4e00-\u9fa5_\-]+$/.test(username)) &#123;</span><br><span class="line">            this.showError(&#x27;用户名只能包含字母、数字、中文、下划线和连字符&#x27;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        this.username = username;</span><br><span class="line">        this.usernameDisplay.textContent = username;</span><br><span class="line">        this.updateUserAvatar();</span><br><span class="line">        </span><br><span class="line">        // 连接到WebSocket</span><br><span class="line">        this.connect();</span><br><span class="line">        </span><br><span class="line">        // 关闭模态框</span><br><span class="line">        this.closeAllModals();</span><br><span class="line">        </span><br><span class="line">        // 启用输入框</span><br><span class="line">        this.messageInput.disabled = false;</span><br><span class="line">        this.sendButton.disabled = false;</span><br><span class="line">        </span><br><span class="line">        // 更新用户状态</span><br><span class="line">        document.getElementById(&#x27;userStatus&#x27;).textContent = &#x27;在线&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    showError(message) &#123;</span><br><span class="line">        this.usernameError.textContent = message;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    updateUserAvatar() &#123;</span><br><span class="line">        const initials = this.username ? this.username.charAt(0).toUpperCase() : &#x27;?&#x27;;</span><br><span class="line">        this.userAvatar.textContent = initials;</span><br><span class="line">        this.userAvatar.style.backgroundColor = this.avatarColor;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    connect() &#123;</span><br><span class="line">        const socket = new SockJS(&#x27;/ws-chat&#x27;);</span><br><span class="line">        this.stompClient = Stomp.over(socket);</span><br><span class="line">        </span><br><span class="line">        this.stompClient.connect(&#123;&#125;, (frame) =&gt; &#123;</span><br><span class="line">            this.connected = true;</span><br><span class="line">            console.log(&#x27;连接成功:&#x27;, frame);</span><br><span class="line">            </span><br><span class="line">            // 订阅公共聊天频道</span><br><span class="line">            this.stompClient.subscribe(&#x27;/topic/public&#x27;, (message) =&gt; &#123;</span><br><span class="line">                this.handlePublicMessage(JSON.parse(message.body));</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            // 订阅在线用户更新</span><br><span class="line">            this.stompClient.subscribe(&#x27;/topic/onlineUsers&#x27;, (message) =&gt; &#123;</span><br><span class="line">                this.updateOnlineUsers(JSON.parse(message.body));</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            // 订阅私聊频道</span><br><span class="line">            this.stompClient.subscribe(`/user/queue/private`, (message) =&gt; &#123;</span><br><span class="line">                this.handlePrivateMessage(JSON.parse(message.body));</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            // 发送加入消息</span><br><span class="line">            this.sendJoinMessage();</span><br><span class="line">            </span><br><span class="line">        &#125;, (error) =&gt; &#123;</span><br><span class="line">            console.error(&#x27;连接失败:&#x27;, error);</span><br><span class="line">            this.showNotification(&#x27;连接失败，请刷新页面重试&#x27;, &#x27;error&#x27;);</span><br><span class="line">            setTimeout(() =&gt; this.connect(), 5000); // 5秒后重试</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    sendJoinMessage() &#123;</span><br><span class="line">        if (!this.stompClient || !this.connected) return;</span><br><span class="line">        </span><br><span class="line">        const chatMessage = &#123;</span><br><span class="line">            type: &#x27;JOIN&#x27;,</span><br><span class="line">            sender: this.username,</span><br><span class="line">            content: this.username + &#x27; 加入了聊天室&#x27;,</span><br><span class="line">            avatarColor: this.avatarColor</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        this.stompClient.send(&#x27;/app/chat.addUser&#x27;, &#123;&#125;, JSON.stringify(chatMessage));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    sendMessage() &#123;</span><br><span class="line">        const content = this.messageInput.value.trim();</span><br><span class="line">        </span><br><span class="line">        if (!content || !this.stompClient || !this.connected) return;</span><br><span class="line">        </span><br><span class="line">        // 如果是私聊</span><br><span class="line">        if (this.currentPrivateChat) &#123;</span><br><span class="line">            this.sendPrivateMessage(content, this.currentPrivateChat);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // 公共聊天</span><br><span class="line">            const chatMessage = &#123;</span><br><span class="line">                type: &#x27;CHAT&#x27;,</span><br><span class="line">                sender: this.username,</span><br><span class="line">                content: content,</span><br><span class="line">                avatarColor: this.avatarColor,</span><br><span class="line">                timestamp: new Date().toISOString()</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            this.stompClient.send(&#x27;/app/chat.sendMessage&#x27;, &#123;&#125;, JSON.stringify(chatMessage));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 清空输入框并重置高度</span><br><span class="line">        this.messageInput.value = &#x27;&#x27;;</span><br><span class="line">        this.messageInput.style.height = &#x27;auto&#x27;;</span><br><span class="line">        this.messageInput.focus();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    sendPrivateMessage(content, receiver) &#123;</span><br><span class="line">        if (!this.stompClient || !this.connected) return;</span><br><span class="line">        </span><br><span class="line">        const chatMessage = &#123;</span><br><span class="line">            type: &#x27;CHAT&#x27;,</span><br><span class="line">            sender: this.username,</span><br><span class="line">            receiver: receiver,</span><br><span class="line">            content: content,</span><br><span class="line">            avatarColor: this.avatarColor,</span><br><span class="line">            timestamp: new Date().toISOString()</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        this.stompClient.send(&#x27;/app/chat.sendPrivateMessage&#x27;, &#123;&#125;, JSON.stringify(chatMessage));</span><br><span class="line">        </span><br><span class="line">        // 添加到私聊历史</span><br><span class="line">        this.addPrivateMessageToHistory(receiver, chatMessage, true);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    handlePublicMessage(message) &#123;</span><br><span class="line">        console.log(&#x27;收到公共消息:&#x27;, message);</span><br><span class="line">        </span><br><span class="line">        switch(message.type) &#123;</span><br><span class="line">            case &#x27;JOIN&#x27;:</span><br><span class="line">                this.displayJoinMessage(message);</span><br><span class="line">                break;</span><br><span class="line">            case &#x27;LEAVE&#x27;:</span><br><span class="line">                this.displayLeaveMessage(message);</span><br><span class="line">                break;</span><br><span class="line">            case &#x27;CHAT&#x27;:</span><br><span class="line">                this.displayPublicMessage(message);</span><br><span class="line">                break;</span><br><span class="line">            case &#x27;TYPING&#x27;:</span><br><span class="line">                this.displayTypingIndicator(message);</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    handlePrivateMessage(message) &#123;</span><br><span class="line">        console.log(&#x27;收到私聊消息:&#x27;, message);</span><br><span class="line">        </span><br><span class="line">        // 添加到私聊历史</span><br><span class="line">        const isFromMe = message.sender === this.username;</span><br><span class="line">        const otherUser = isFromMe ? message.receiver : message.sender;</span><br><span class="line">        </span><br><span class="line">        this.addPrivateMessageToHistory(otherUser, message, isFromMe);</span><br><span class="line">        </span><br><span class="line">        // 如果当前不是这个私聊会话，显示通知</span><br><span class="line">        if (this.currentPrivateChat !== otherUser) &#123;</span><br><span class="line">            this.showPrivateNotification(otherUser, message.content);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    addPrivateMessageToHistory(user, message, isFromMe) &#123;</span><br><span class="line">        // 获取或创建私聊会话</span><br><span class="line">        if (!this.privateChats.has(user)) &#123;</span><br><span class="line">            this.privateChats.set(user, []);</span><br><span class="line">            this.addPrivateChatItem(user);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        const messages = this.privateChats.get(user);</span><br><span class="line">        messages.push(&#123;</span><br><span class="line">            ...message,</span><br><span class="line">            isFromMe</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        // 更新私聊预览</span><br><span class="line">        this.updatePrivateChatPreview(user, message.content);</span><br><span class="line">        </span><br><span class="line">        // 如果当前正在查看这个私聊，显示消息</span><br><span class="line">        if (this.currentPrivateChat === user) &#123;</span><br><span class="line">            this.displayPrivateMessage(message, isFromMe);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    addPrivateChatItem(user) &#123;</span><br><span class="line">        const userSession = this.getUserSession(user);</span><br><span class="line">        if (!userSession) return;</span><br><span class="line">        </span><br><span class="line">        const chatItem = document.createElement(&#x27;div&#x27;);</span><br><span class="line">        chatItem.className = &#x27;private-chat-item&#x27;;</span><br><span class="line">        chatItem.dataset.user = user;</span><br><span class="line">        </span><br><span class="line">        chatItem.innerHTML = `</span><br><span class="line">            &lt;div class=&quot;private-chat-header&quot;&gt;</span><br><span class="line">                &lt;div class=&quot;private-chat-avatar&quot; style=&quot;background-color: $&#123;userSession.avatarColor&#125;&quot;&gt;</span><br><span class="line">                    $&#123;user.charAt(0).toUpperCase()&#125;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;private-chat-info&quot;&gt;</span><br><span class="line">                    &lt;h4&gt;$&#123;user&#125;&lt;/h4&gt;</span><br><span class="line">                    &lt;p&gt;在线&lt;/p&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;private-chat-preview&quot; data-preview=&quot;$&#123;user&#125;&quot;&gt;暂无消息&lt;/div&gt;</span><br><span class="line">        `;</span><br><span class="line">        </span><br><span class="line">        chatItem.addEventListener(&#x27;click&#x27;, () =&gt; this.openPrivateChat(user));</span><br><span class="line">        this.privateChatsContainer.appendChild(chatItem);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    updatePrivateChatPreview(user, message) &#123;</span><br><span class="line">        const preview = document.querySelector(`[data-preview=&quot;$&#123;user&#125;&quot;]`);</span><br><span class="line">        if (preview) &#123;</span><br><span class="line">            const truncated = message.length &gt; 30 ? message.substring(0, 30) + &#x27;...&#x27; : message;</span><br><span class="line">            preview.textContent = truncated;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    openPrivateChat(user) &#123;</span><br><span class="line">        this.currentPrivateChat = user;</span><br><span class="line">        </span><br><span class="line">        // 更新UI</span><br><span class="line">        document.querySelectorAll(&#x27;.private-chat-item&#x27;).forEach(item =&gt; &#123;</span><br><span class="line">            item.classList.remove(&#x27;active&#x27;);</span><br><span class="line">            if (item.dataset.user === user) &#123;</span><br><span class="line">                item.classList.add(&#x27;active&#x27;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        // 显示私聊侧边栏</span><br><span class="line">        this.showPrivateSidebar();</span><br><span class="line">        </span><br><span class="line">        // 清空当前消息显示</span><br><span class="line">        this.messagesContainer.innerHTML = &#x27;&#x27;;</span><br><span class="line">        </span><br><span class="line">        // 显示私聊消息历史</span><br><span class="line">        const messages = this.privateChats.get(user) || [];</span><br><span class="line">        messages.forEach(msg =&gt; &#123;</span><br><span class="line">            this.displayPrivateMessage(msg, msg.isFromMe);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        // 更新聊天标题</span><br><span class="line">        this.currentChatRoom.textContent = `与 $&#123;user&#125; 的私聊`;</span><br><span class="line">        document.getElementById(&#x27;roomDescription&#x27;).textContent = &#x27;私人聊天&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    displayPrivateMessage(message, isFromMe) &#123;</span><br><span class="line">        const messageElement = this.createMessageElement(message, isFromMe);</span><br><span class="line">        this.messagesContainer.appendChild(messageElement);</span><br><span class="line">        this.scrollToBottom();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    showPrivateSidebar() &#123;</span><br><span class="line">        this.privateSidebar.classList.add(&#x27;show&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    hidePrivateSidebar() &#123;</span><br><span class="line">        this.privateSidebar.classList.remove(&#x27;show&#x27;);</span><br><span class="line">        this.currentPrivateChat = null;</span><br><span class="line">        </span><br><span class="line">        // 切换回公共聊天室</span><br><span class="line">        this.switchToPublicRoom();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    switchToPublicRoom() &#123;</span><br><span class="line">        this.currentChatRoom.textContent = &#x27;公共聊天室&#x27;;</span><br><span class="line">        document.getElementById(&#x27;roomDescription&#x27;).textContent = &#x27;与所有在线用户聊天&#x27;;</span><br><span class="line">        </span><br><span class="line">        // 清空消息并显示欢迎信息</span><br><span class="line">        this.messagesContainer.innerHTML = `</span><br><span class="line">            &lt;div class=&quot;welcome-message&quot;&gt;</span><br><span class="line">                &lt;div class=&quot;welcome-icon&quot;&gt;</span><br><span class="line">                    &lt;i class=&quot;fas fa-comment-dots&quot;&gt;&lt;/i&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;h3&gt;欢迎来到聊天室!&lt;/h3&gt;</span><br><span class="line">                &lt;p&gt;开始与大家聊天吧！输入消息并按回车键发送。&lt;/p&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        `;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    displayPublicMessage(message) &#123;</span><br><span class="line">        const isFromMe = message.sender === this.username;</span><br><span class="line">        const messageElement = this.createMessageElement(message, isFromMe);</span><br><span class="line">        this.messagesContainer.appendChild(messageElement);</span><br><span class="line">        this.scrollToBottom();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    displayJoinMessage(message) &#123;</span><br><span class="line">        const messageElement = document.createElement(&#x27;div&#x27;);</span><br><span class="line">        messageElement.className = &#x27;join-leave-message&#x27;;</span><br><span class="line">        messageElement.innerHTML = `</span><br><span class="line">            &lt;div class=&quot;message-content&quot;&gt;</span><br><span class="line">                &lt;i class=&quot;fas fa-user-plus&quot;&gt;&lt;/i&gt; $&#123;message.content&#125;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        `;</span><br><span class="line">        this.messagesContainer.appendChild(messageElement);</span><br><span class="line">        this.scrollToBottom();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    displayLeaveMessage(message) &#123;</span><br><span class="line">        const messageElement = document.createElement(&#x27;div&#x27;);</span><br><span class="line">        messageElement.className = &#x27;join-leave-message&#x27;;</span><br><span class="line">        messageElement.innerHTML = `</span><br><span class="line">            &lt;div class=&quot;message-content&quot;&gt;</span><br><span class="line">                &lt;i class=&quot;fas fa-user-minus&quot;&gt;&lt;/i&gt; $&#123;message.content&#125;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        `;</span><br><span class="line">        this.messagesContainer.appendChild(messageElement);</span><br><span class="line">        this.scrollToBottom();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    createMessageElement(message, isFromMe) &#123;</span><br><span class="line">        const messageElement = document.createElement(&#x27;div&#x27;);</span><br><span class="line">        messageElement.className = `message $&#123;isFromMe ? &#x27;outgoing&#x27; : &#x27;incoming&#x27;&#125;`;</span><br><span class="line">        </span><br><span class="line">        const time = new Date(message.timestamp).toLocaleTimeString([], &#123; </span><br><span class="line">            hour: &#x27;2-digit&#x27;, </span><br><span class="line">            minute: &#x27;2-digit&#x27; </span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        messageElement.innerHTML = `</span><br><span class="line">            &lt;div class=&quot;message-avatar&quot; style=&quot;background-color: $&#123;message.avatarColor || this.avatarColor&#125;&quot;&gt;</span><br><span class="line">                $&#123;message.sender ? message.sender.charAt(0).toUpperCase() : &#x27;?&#x27;&#125;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;message-content&quot;&gt;</span><br><span class="line">                &lt;div class=&quot;message-header&quot;&gt;</span><br><span class="line">                    &lt;span class=&quot;message-sender&quot;&gt;$&#123;message.sender&#125;&lt;/span&gt;</span><br><span class="line">                    &lt;span class=&quot;message-time&quot;&gt;$&#123;time&#125;&lt;/span&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;message-text&quot;&gt;$&#123;this.escapeHtml(message.content)&#125;&lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;message-status&quot;&gt;</span><br><span class="line">                    $&#123;isFromMe ? &#x27;&lt;i class=&quot;fas fa-check&quot;&gt;&lt;/i&gt;&#x27; : &#x27;&#x27;&#125;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        `;</span><br><span class="line">        </span><br><span class="line">        return messageElement;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    escapeHtml(text) &#123;</span><br><span class="line">        const div = document.createElement(&#x27;div&#x27;);</span><br><span class="line">        div.textContent = text;</span><br><span class="line">        return div.innerHTML;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    handleTyping() &#123;</span><br><span class="line">        if (!this.stompClient || !this.connected || this.currentPrivateChat) return;</span><br><span class="line">        </span><br><span class="line">        // 清除之前的定时器</span><br><span class="line">        if (this.typingTimeout) &#123;</span><br><span class="line">            clearTimeout(this.typingTimeout);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 发送正在输入状态</span><br><span class="line">        const chatMessage = &#123;</span><br><span class="line">            type: &#x27;TYPING&#x27;,</span><br><span class="line">            sender: this.username,</span><br><span class="line">            content: &#x27;正在输入...&#x27;</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        this.stompClient.send(&#x27;/app/chat.typing&#x27;, &#123;&#125;, JSON.stringify(chatMessage));</span><br><span class="line">        </span><br><span class="line">        // 设置定时器，3秒后停止显示&quot;正在输入&quot;</span><br><span class="line">        this.typingTimeout = setTimeout(() =&gt; &#123;</span><br><span class="line">            this.hideTypingIndicator();</span><br><span class="line">        &#125;, 3000);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    displayTypingIndicator(message) &#123;</span><br><span class="line">        if (message.sender === this.username || this.currentPrivateChat) return;</span><br><span class="line">        </span><br><span class="line">        this.typingIndicator.textContent = `$&#123;message.sender&#125; 正在输入...`;</span><br><span class="line">        this.typingIndicator.classList.add(&#x27;show&#x27;);</span><br><span class="line">        </span><br><span class="line">        // 3秒后隐藏</span><br><span class="line">        setTimeout(() =&gt; &#123;</span><br><span class="line">            this.hideTypingIndicator();</span><br><span class="line">        &#125;, 3000);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    hideTypingIndicator() &#123;</span><br><span class="line">        this.typingIndicator.classList.remove(&#x27;show&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    updateOnlineUsers(users) &#123;</span><br><span class="line">        const onlineUsers = Array.isArray(users) ? users : [];</span><br><span class="line">        this.onlineCount.textContent = onlineUsers.length;</span><br><span class="line">        this.userCount.textContent = onlineUsers.length;</span><br><span class="line">        </span><br><span class="line">        // 更新用户列表</span><br><span class="line">        this.onlineUsersList.innerHTML = &#x27;&#x27;;</span><br><span class="line">        </span><br><span class="line">        onlineUsers.forEach(user =&gt; &#123;</span><br><span class="line">            if (user === this.username) return; // 不显示自己</span><br><span class="line">            </span><br><span class="line">            const userSession = this.getUserSession(user);</span><br><span class="line">            const li = document.createElement(&#x27;li&#x27;);</span><br><span class="line">            li.className = &#x27;user-item&#x27;;</span><br><span class="line">            li.dataset.user = user;</span><br><span class="line">            </span><br><span class="line">            li.innerHTML = `</span><br><span class="line">                &lt;div class=&quot;user-avatar&quot; style=&quot;background-color: $&#123;userSession ? userSession.avatarColor : &#x27;#4361ee&#x27;&#125;&quot;&gt;</span><br><span class="line">                    $&#123;user.charAt(0).toUpperCase()&#125;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;user-details&quot;&gt;</span><br><span class="line">                    &lt;h4&gt;$&#123;user&#125;&lt;/h4&gt;</span><br><span class="line">                    &lt;p&gt;在线&lt;/p&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;user-status online&quot;&gt;&lt;/div&gt;</span><br><span class="line">                &lt;button class=&quot;private-chat-btn icon-btn&quot; title=&quot;私聊&quot; data-user=&quot;$&#123;user&#125;&quot;&gt;</span><br><span class="line">                    &lt;i class=&quot;fas fa-comment-medical&quot;&gt;&lt;/i&gt;</span><br><span class="line">                &lt;/button&gt;</span><br><span class="line">            `;</span><br><span class="line">            </span><br><span class="line">            // 添加私聊按钮事件</span><br><span class="line">            const privateBtn = li.querySelector(&#x27;.private-chat-btn&#x27;);</span><br><span class="line">            privateBtn.addEventListener(&#x27;click&#x27;, (e) =&gt; &#123;</span><br><span class="line">                e.stopPropagation();</span><br><span class="line">                this.openPrivateChat(user);</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            this.onlineUsersList.appendChild(li);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    getUserSession(username) &#123;</span><br><span class="line">        // 这里应该从服务器获取用户信息</span><br><span class="line">        // 暂时返回模拟数据</span><br><span class="line">        return &#123;</span><br><span class="line">            avatarColor: this.generateColorFromString(username)</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    generateColorFromString(str) &#123;</span><br><span class="line">        let hash = 0;</span><br><span class="line">        for (let i = 0; i &lt; str.length; i++) &#123;</span><br><span class="line">            hash = str.charCodeAt(i) + ((hash &lt;&lt; 5) - hash);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        const colors = [</span><br><span class="line">            &#x27;#FF6B6B&#x27;, &#x27;#4ECDC4&#x27;, &#x27;#FFD166&#x27;, &#x27;#06D6A0&#x27;,</span><br><span class="line">            &#x27;#118AB2&#x27;, &#x27;#073B4C&#x27;, &#x27;#EF476F&#x27;, &#x27;#7209B7&#x27;</span><br><span class="line">        ];</span><br><span class="line">        </span><br><span class="line">        return colors[Math.abs(hash) % colors.length];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    filterUsers(query) &#123;</span><br><span class="line">        const userItems = document.querySelectorAll(&#x27;.user-item&#x27;);</span><br><span class="line">        const queryLower = query.toLowerCase();</span><br><span class="line">        </span><br><span class="line">        userItems.forEach(item =&gt; &#123;</span><br><span class="line">            const userName = item.dataset.user.toLowerCase();</span><br><span class="line">            if (userName.includes(queryLower)) &#123;</span><br><span class="line">                item.style.display = &#x27;flex&#x27;;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                item.style.display = &#x27;none&#x27;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    switchChatRoom(event) &#123;</span><br><span class="line">        const room = event.currentTarget.dataset.room;</span><br><span class="line">        </span><br><span class="line">        // 更新活动状态</span><br><span class="line">        this.chatRooms.forEach(r =&gt; r.classList.remove(&#x27;active&#x27;));</span><br><span class="line">        event.currentTarget.classList.add(&#x27;active&#x27;);</span><br><span class="line">        </span><br><span class="line">        if (room === &#x27;private&#x27;) &#123;</span><br><span class="line">            this.showPrivateSidebar();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            this.hidePrivateSidebar();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    clearChat() &#123;</span><br><span class="line">        if (confirm(&#x27;确定要清空聊天记录吗？&#x27;)) &#123;</span><br><span class="line">            this.messagesContainer.innerHTML = `</span><br><span class="line">                &lt;div class=&quot;welcome-message&quot;&gt;</span><br><span class="line">                    &lt;div class=&quot;welcome-icon&quot;&gt;</span><br><span class="line">                        &lt;i class=&quot;fas fa-comment-dots&quot;&gt;&lt;/i&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                    &lt;h3&gt;聊天记录已清空&lt;/h3&gt;</span><br><span class="line">                    &lt;p&gt;开始新的聊天吧！&lt;/p&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            `;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    toggleTheme() &#123;</span><br><span class="line">        const isDark = document.body.classList.toggle(&#x27;dark-theme&#x27;);</span><br><span class="line">        this.themeToggleBtn.innerHTML = isDark </span><br><span class="line">            ? &#x27;&lt;i class=&quot;fas fa-sun&quot;&gt;&lt;/i&gt;&#x27;</span><br><span class="line">            : &#x27;&lt;i class=&quot;fas fa-moon&quot;&gt;&lt;/i&gt;&#x27;;</span><br><span class="line">        </span><br><span class="line">        // 保存主题偏好</span><br><span class="line">        localStorage.setItem(&#x27;chatTheme&#x27;, isDark ? &#x27;dark&#x27; : &#x27;light&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    showPrivateNotification(user, message) &#123;</span><br><span class="line">        // 检查通知权限</span><br><span class="line">        if (Notification.permission === &#x27;granted&#x27;) &#123;</span><br><span class="line">            new Notification(`来自 $&#123;user&#125; 的消息`, &#123;</span><br><span class="line">                body: message,</span><br><span class="line">                icon: &#x27;/favicon.ico&#x27;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; else if (Notification.permission !== &#x27;denied&#x27;) &#123;</span><br><span class="line">            Notification.requestPermission();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    showNotification(message, type = &#x27;info&#x27;) &#123;</span><br><span class="line">        // 创建通知元素</span><br><span class="line">        const notification = document.createElement(&#x27;div&#x27;);</span><br><span class="line">        notification.className = `notification $&#123;type&#125;`;</span><br><span class="line">        notification.textContent = message;</span><br><span class="line">        </span><br><span class="line">        document.body.appendChild(notification);</span><br><span class="line">        </span><br><span class="line">        // 显示通知</span><br><span class="line">        setTimeout(() =&gt; notification.classList.add(&#x27;show&#x27;), 100);</span><br><span class="line">        </span><br><span class="line">        // 3秒后移除</span><br><span class="line">        setTimeout(() =&gt; &#123;</span><br><span class="line">            notification.classList.remove(&#x27;show&#x27;);</span><br><span class="line">            setTimeout(() =&gt; notification.remove(), 300);</span><br><span class="line">        &#125;, 3000);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    scrollToBottom() &#123;</span><br><span class="line">        this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 页面卸载时发送离开消息</span><br><span class="line">    beforeUnload() &#123;</span><br><span class="line">        if (this.stompClient &amp;&amp; this.connected) &#123;</span><br><span class="line">            const chatMessage = &#123;</span><br><span class="line">                type: &#x27;LEAVE&#x27;,</span><br><span class="line">                sender: this.username,</span><br><span class="line">                content: this.username + &#x27; 离开了聊天室&#x27;</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            this.stompClient.send(&#x27;/app/chat.leave&#x27;, &#123;&#125;, JSON.stringify(chatMessage));</span><br><span class="line">            </span><br><span class="line">            // 延迟断开连接</span><br><span class="line">            setTimeout(() =&gt; &#123;</span><br><span class="line">                if (this.stompClient) &#123;</span><br><span class="line">                    this.stompClient.disconnect();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, 100);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 初始化聊天室</span><br><span class="line">document.addEventListener(&#x27;DOMContentLoaded&#x27;, () =&gt; &#123;</span><br><span class="line">    const chatRoom = new ChatRoom();</span><br><span class="line">    </span><br><span class="line">    // 页面卸载前发送离开消息</span><br><span class="line">    window.addEventListener(&#x27;beforeunload&#x27;, () =&gt; &#123;</span><br><span class="line">        chatRoom.beforeUnload();</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    // 检查之前保存的主题</span><br><span class="line">    const savedTheme = localStorage.getItem(&#x27;chatTheme&#x27;);</span><br><span class="line">    if (savedTheme === &#x27;dark&#x27;) &#123;</span><br><span class="line">        document.body.classList.add(&#x27;dark-theme&#x27;);</span><br><span class="line">        document.querySelector(&#x27;#themeToggleBtn i&#x27;).className = &#x27;fas fa-sun&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 请求通知权限</span><br><span class="line">    if (&#x27;Notification&#x27; in window &amp;&amp; Notification.permission === &#x27;default&#x27;) &#123;</span><br><span class="line">        setTimeout(() =&gt; &#123;</span><br><span class="line">            Notification.requestPermission();</span><br><span class="line">        &#125;, 2000);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h2 id="3-运行说明"><a href="#3-运行说明" class="headerlink" title="3. 运行说明"></a>3. 运行说明</h2><h3 id="3-1-项目结构"><a href="#3-1-项目结构" class="headerlink" title="3.1 项目结构"></a>3.1 项目结构</h3><p>将上述代码按照目录结构创建文件，确保以下结构：</p>
<p>text</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">chat-room/</span><br><span class="line">├── src/</span><br><span class="line">│   ├── main/</span><br><span class="line">│   │   ├── java/</span><br><span class="line">│   │   │   └── com/</span><br><span class="line">│   │   │       └── chatroom/</span><br><span class="line">│   │   │           ├── config/</span><br><span class="line">│   │   │           │   └── WebSocketConfig.java</span><br><span class="line">│   │   │           ├── controller/</span><br><span class="line">│   │   │           │   └── ChatController.java</span><br><span class="line">│   │   │           ├── model/</span><br><span class="line">│   │   │           │   ├── ChatMessage.java</span><br><span class="line">│   │   │           │   └── UserSession.java</span><br><span class="line">│   │   │           └── ChatRoomApplication.java</span><br><span class="line">│   │   └── resources/</span><br><span class="line">│   │       ├── static/</span><br><span class="line">│   │       │   ├── css/</span><br><span class="line">│   │       │   │   └── chat.css</span><br><span class="line">│   │       │   ├── js/</span><br><span class="line">│   │       │   │   └── chat.js</span><br><span class="line">│   │       │   └── index.html</span><br><span class="line">│   │       └── application.yml</span><br><span class="line">└── pom.xml</span><br></pre></td></tr></table></figure>



<h3 id="3-2-运行步骤"><a href="#3-2-运行步骤" class="headerlink" title="3.2 运行步骤"></a>3.2 运行步骤</h3><ol>
<li><p>确保已安装Java 11或更高版本</p>
</li>
<li><p>确保已安装Maven</p>
</li>
<li><p>在项目根目录执行：</p>
<p>bash</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mvn clean package</span><br><span class="line">java -jar target/chat-room-1.0.0.jar</span><br></pre></td></tr></table></figure>


</li>
<li><p>或者使用IDE（如IntelliJ IDEA或Eclipse）直接运行<code>ChatRoomApplication.java</code></p>
</li>
</ol>
<h3 id="3-3-访问应用"><a href="#3-3-访问应用" class="headerlink" title="3.3 访问应用"></a>3.3 访问应用</h3><p>打开浏览器，访问：<code>http://localhost:8080</code></p>
<h2 id="4-功能特点"><a href="#4-功能特点" class="headerlink" title="4. 功能特点"></a>4. 功能特点</h2><h3 id="4-1-核心功能"><a href="#4-1-核心功能" class="headerlink" title="4.1 核心功能"></a>4.1 核心功能</h3><ol>
<li><strong>用户管理</strong>：设置用户名和头像颜色</li>
<li><strong>实时聊天</strong>：公共聊天室支持所有在线用户</li>
<li><strong>私聊功能</strong>：支持一对一私密聊天</li>
<li><strong>用户列表</strong>：实时显示在线用户，支持搜索</li>
<li><strong>消息通知</strong>：桌面通知和提示音</li>
<li><strong>输入状态</strong>：显示用户”正在输入”状态</li>
<li><strong>消息历史</strong>：私聊会话保存历史记录</li>
</ol>
<h3 id="4-2-高级功能"><a href="#4-2-高级功能" class="headerlink" title="4.2 高级功能"></a>4.2 高级功能</h3><ol>
<li><strong>响应式设计</strong>：适配桌面和移动设备</li>
<li><strong>主题切换</strong>：支持亮色&#x2F;暗色主题</li>
<li><strong>表情支持</strong>：预留表情功能接口</li>
<li><strong>文件上传</strong>：预留文件上传功能接口</li>
<li><strong>消息状态</strong>：显示消息发送状态（已发送、已读）</li>
<li><strong>聊天记录</strong>：支持清空聊天记录</li>
</ol>
<h3 id="4-3-技术特点"><a href="#4-3-技术特点" class="headerlink" title="4.3 技术特点"></a>4.3 技术特点</h3><ol>
<li><strong>Spring Boot</strong>：简化后端开发</li>
<li><strong>WebSocket</strong>：实现实时双向通信</li>
<li><strong>STOMP</strong>：简单的消息传递协议</li>
<li><strong>SockJS</strong>：WebSocket备用方案</li>
<li><strong>纯前端技术</strong>：HTML5、CSS3、原生JavaScript</li>
<li><strong>响应式布局</strong>：CSS Flexbox和Grid</li>
</ol>
<h2 id="5-扩展建议"><a href="#5-扩展建议" class="headerlink" title="5. 扩展建议"></a>5. 扩展建议</h2><h3 id="5-1-功能扩展"><a href="#5-1-功能扩展" class="headerlink" title="5.1 功能扩展"></a>5.1 功能扩展</h3><ol>
<li><strong>数据库集成</strong>：添加MySQL&#x2F;PostgreSQL保存聊天记录</li>
<li><strong>用户认证</strong>：集成Spring Security实现登录</li>
<li><strong>房间功能</strong>：支持创建不同的聊天房间</li>
<li><strong>文件分享</strong>：支持上传和发送图片&#x2F;文件</li>
<li><strong>消息加密</strong>：端到端加密私聊消息</li>
<li><strong>语音&#x2F;视频</strong>：集成WebRTC实现语音视频聊天</li>
</ol>
<h3 id="5-2-部署建议"><a href="#5-2-部署建议" class="headerlink" title="5.2 部署建议"></a>5.2 部署建议</h3><ol>
<li><strong>Docker化</strong>：创建Docker镜像方便部署</li>
<li><strong>Nginx反向代理</strong>：配置SSL证书支持HTTPS</li>
<li><strong>负载均衡</strong>：多实例部署支持更多用户</li>
<li><strong>消息队列</strong>：集成RabbitMQ或Kafka处理高并发</li>
<li><strong>监控告警</strong>：集成Prometheus和Grafana监控</li>
</ol>
<p>这个聊天室项目涵盖了现代Web应用的主要技术栈，适合用于学习Java Web开发和实时通信技术。您可以根据需要进一步扩展和完善功能。</p>
<p>继续扩展完善</p>
<p>我们继续扩展和完善这个多人聊天室项目。我们将增加以下功能：</p>
<ol>
<li>数据库支持：使用MySQL来存储用户信息和聊天记录。</li>
<li>用户认证：使用Spring Security实现用户注册和登录。</li>
<li>消息持久化：将聊天消息保存到数据库。</li>
<li>历史消息查询：可以查看过去的聊天记录。</li>
<li>用户状态管理：更精确地管理用户在线状态（在线、离开、离线）。</li>
<li>前端改进：添加更多交互功能，如消息通知声音、消息搜索等。</li>
</ol>
<p>由于代码量会很大，我将分步骤进行，并给出关键代码。</p>
<p>第一步：添加数据库支持</p>
<ol>
<li>添加依赖（pom.xml）：<ul>
<li>Spring Boot Data JPA</li>
<li>MySQL驱动</li>
</ul>
</li>
<li>创建数据库表：<ul>
<li>用户表（users）</li>
<li>聊天消息表（chat_messages）</li>
</ul>
</li>
</ol>
<p>第二步：集成Spring Security</p>
<ol>
<li>添加依赖（pom.xml）：<ul>
<li>Spring Boot Security</li>
</ul>
</li>
<li>创建用户注册和登录的API和页面。</li>
</ol>
<p>第三步：消息持久化</p>
<ol>
<li>修改WebSocket处理器，将消息保存到数据库。</li>
</ol>
<p>第四步：历史消息查询</p>
<ol>
<li>创建API来获取历史消息。</li>
</ol>
<p>第五步：改进前端</p>
<ol>
<li>添加历史消息加载、消息搜索、通知声音等功能。</li>
</ol>
<p>由于这是一个扩展，我将从第一步开始，并逐步进行。</p>
<p>注意：由于代码量巨大，我将只给出关键部分的代码，并尽量保持简洁。</p>
<p>让我们开始吧。</p>
<p>第一步：添加数据库支持</p>
<p>1.1 修改pom.xml，添加以下依赖：</p>
<p>xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">    &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>



<p>1.2 配置数据库连接（application.yml）：</p>
<p>yaml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    url: jdbc:mysql://localhost:3306/chatroom?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=Asia/Shanghai</span><br><span class="line">    username: root</span><br><span class="line">    password: yourpassword</span><br><span class="line">    driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">  jpa:</span><br><span class="line">    hibernate:</span><br><span class="line">      ddl-auto: update</span><br><span class="line">    show-sql: true</span><br><span class="line">    properties:</span><br><span class="line">      hibernate:</span><br><span class="line">        format_sql: true</span><br></pre></td></tr></table></figure>



<p>1.3 创建实体类：</p>
<p>User实体：</p>
<p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.model;</span><br><span class="line"></span><br><span class="line">import javax.persistence.*;</span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line">import java.util.Set;</span><br><span class="line"></span><br><span class="line">@Entity</span><br><span class="line">@Table(name = &quot;users&quot;)</span><br><span class="line">public class User &#123;</span><br><span class="line">    @Id</span><br><span class="line">    @GeneratedValue(strategy = GenerationType.IDENTITY)</span><br><span class="line">    private Long id;</span><br><span class="line"></span><br><span class="line">    @Column(unique = true, nullable = false)</span><br><span class="line">    private String username;</span><br><span class="line"></span><br><span class="line">    @Column(nullable = false)</span><br><span class="line">    private String password;</span><br><span class="line"></span><br><span class="line">    private String avatarColor;</span><br><span class="line">    private boolean online;</span><br><span class="line"></span><br><span class="line">    @Column(name = &quot;created_at&quot;)</span><br><span class="line">    private LocalDateTime createdAt;</span><br><span class="line"></span><br><span class="line">    @OneToMany(mappedBy = &quot;sender&quot;)</span><br><span class="line">    private Set&lt;ChatMessage&gt; messages;</span><br><span class="line"></span><br><span class="line">    // 构造函数、Getter和Setter省略</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ChatMessage实体：</p>
<p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.model;</span><br><span class="line"></span><br><span class="line">import javax.persistence.*;</span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line">@Entity</span><br><span class="line">@Table(name = &quot;chat_messages&quot;)</span><br><span class="line">public class ChatMessage &#123;</span><br><span class="line">    @Id</span><br><span class="line">    @GeneratedValue(strategy = GenerationType.IDENTITY)</span><br><span class="line">    private Long id;</span><br><span class="line"></span><br><span class="line">    @Enumerated(EnumType.STRING)</span><br><span class="line">    private MessageType type;</span><br><span class="line"></span><br><span class="line">    @Column(length = 2000)</span><br><span class="line">    private String content;</span><br><span class="line"></span><br><span class="line">    @ManyToOne</span><br><span class="line">    @JoinColumn(name = &quot;sender_id&quot;)</span><br><span class="line">    private User sender;</span><br><span class="line"></span><br><span class="line">    @ManyToOne</span><br><span class="line">    @JoinColumn(name = &quot;receiver_id&quot;)</span><br><span class="line">    private User receiver;</span><br><span class="line"></span><br><span class="line">    private LocalDateTime timestamp;</span><br><span class="line"></span><br><span class="line">    // 构造函数、Getter和Setter省略</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>1.4 创建Repository：</p>
<p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.repository;</span><br><span class="line"></span><br><span class="line">import com.chatroom.model.ChatMessage;</span><br><span class="line">import org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line">import org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">@Repository</span><br><span class="line">public interface ChatMessageRepository extends JpaRepository&lt;ChatMessage, Long&gt; &#123;</span><br><span class="line">    List&lt;ChatMessage&gt; findTop100ByOrderByTimestampDesc();</span><br><span class="line">    List&lt;ChatMessage&gt; findBySenderIdAndReceiverIdOrReceiverIdAndSenderIdOrderByTimestamp(Long senderId1, Long receiverId1, Long receiverId2, Long senderId2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>第二步：集成Spring Security</p>
<p>2.1 添加依赖：</p>
<p>xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>



<p>2.2 创建UserDetailsService实现：</p>
<p>由于时间关系，这里只给出简单的实现，实际中需要加密密码等。</p>
<p>我们使用内存用户详情，或者可以连接数据库。这里为了简单，先使用内存用户。</p>
<p>但是，我们最终要使用数据库中的用户。所以，我们创建一个从数据库加载用户的UserDetailsService。</p>
<p>创建UserDetailsServiceImpl：</p>
<p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.service;</span><br><span class="line"></span><br><span class="line">import com.chatroom.model.User;</span><br><span class="line">import com.chatroom.repository.UserRepository;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line">import org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line">import org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">@Service</span><br><span class="line">public class UserDetailsServiceImpl implements UserDetailsService &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;</span><br><span class="line">        User user = userRepository.findByUsername(username)</span><br><span class="line">                .orElseThrow(() -&gt; new UsernameNotFoundException(&quot;User not found with username: &quot; + username));</span><br><span class="line"></span><br><span class="line">        return org.springframework.security.core.userdetails.User</span><br><span class="line">                .withUsername(user.getUsername())</span><br><span class="line">                .password(user.getPassword())</span><br><span class="line">                .authorities(&quot;USER&quot;)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>2.3 配置Spring Security：</p>
<p>创建SecurityConfig类，配置登录、注册等。</p>
<p>由于这是一个聊天应用，我们可能需要允许WebSocket连接，所以需要调整安全配置。</p>
<p>注意：我们还需要一个注册页面和API。</p>
<p>由于篇幅限制，这里只给出部分配置。</p>
<p>第三步：消息持久化</p>
<p>3.1 修改ChatController，在收到消息时保存到数据库。</p>
<p>第四步：历史消息查询</p>
<p>4.1 创建API，返回历史消息。</p>
<p>第五步：改进前端</p>
<p>5.1 添加历史消息加载功能。</p>
<p>由于代码量巨大，我将只给出部分关键代码，并且尽量简洁。</p>
<p>由于我们是在原有基础上扩展，所以需要逐步修改。</p>
<p>考虑到时间，我将先给出数据库和Spring Security的配置，然后逐步修改其他部分。</p>
<p>由于这是一个示例，我将尽量保持简单。</p>
<p>实际上，我们还需要考虑很多细节，比如密码加密、会话管理、跨域等。</p>
<p>让我们先修改主应用程序，添加数据库和Security配置。</p>
<p>由于代码量巨大，我无法一次性提供所有代码，但我会给出关键部分。</p>
<p>我们首先修改ChatRoomApplication.java，确保Spring Boot能够扫描到所有组件。</p>
<p>然后，我们创建SecurityConfig：</p>
<p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.config;</span><br><span class="line"></span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line">import org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line">import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line">import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line">import org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line">import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line">import org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">@EnableWebSecurity</span><br><span class="line">public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">        http</span><br><span class="line">            .authorizeRequests()</span><br><span class="line">                .antMatchers(&quot;/&quot;, &quot;/register&quot;, &quot;/login&quot;, &quot;/css/**&quot;, &quot;/js/**&quot;, &quot;/ws/**&quot;).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">            .formLogin()</span><br><span class="line">                .loginPage(&quot;/login&quot;)</span><br><span class="line">                .defaultSuccessUrl(&quot;/chat&quot;)</span><br><span class="line">                .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">            .logout()</span><br><span class="line">                .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">            .csrf().disable() // 为了WebSocket，暂时禁用CSRF</span><br><span class="line">            .headers().frameOptions().sameOrigin(); // 允许同源iframe</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception &#123;</span><br><span class="line">        auth.userDetailsService(userDetailsService).passwordEncoder(passwordEncoder());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public PasswordEncoder passwordEncoder() &#123;</span><br><span class="line">        return new BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>创建注册和登录的Controller和页面。</p>
<p>由于篇幅，这里只给出注册的Controller示例：</p>
<p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.controller;</span><br><span class="line"></span><br><span class="line">import com.chatroom.model.User;</span><br><span class="line">import com.chatroom.repository.UserRepository;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line">import org.springframework.stereotype.Controller;</span><br><span class="line">import org.springframework.ui.Model;</span><br><span class="line">import org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"></span><br><span class="line">@Controller</span><br><span class="line">public class AuthController &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;/login&quot;)</span><br><span class="line">    public String login() &#123;</span><br><span class="line">        return &quot;login&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;/register&quot;)</span><br><span class="line">    public String register() &#123;</span><br><span class="line">        return &quot;register&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @PostMapping(&quot;/register&quot;)</span><br><span class="line">    public String registerUser(String username, String password, Model model) &#123;</span><br><span class="line">        if (userRepository.findByUsername(username).isPresent()) &#123;</span><br><span class="line">            model.addAttribute(&quot;error&quot;, &quot;用户名已存在&quot;);</span><br><span class="line">            return &quot;register&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        User user = new User();</span><br><span class="line">        user.setUsername(username);</span><br><span class="line">        user.setPassword(passwordEncoder.encode(password));</span><br><span class="line">        user.setAvatarColor(generateAvatarColor(username));</span><br><span class="line">        user.setOnline(false);</span><br><span class="line">        user.setCreatedAt(java.time.LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">        userRepository.save(user);</span><br><span class="line"></span><br><span class="line">        return &quot;redirect:/login&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private String generateAvatarColor(String username) &#123;</span><br><span class="line">        String[] colors = &#123;</span><br><span class="line">            &quot;#FF6B6B&quot;, &quot;#4ECDC4&quot;, &quot;#FFD166&quot;, &quot;#06D6A0&quot;, </span><br><span class="line">            &quot;#118AB2&quot;, &quot;#073B4C&quot;, &quot;#EF476F&quot;, &quot;#7209B7&quot;</span><br><span class="line">        &#125;;</span><br><span class="line">        return colors[Math.abs(username.hashCode()) % colors.length];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>然后，我们需要修改WebSocket配置，确保WebSocket连接在安全环境下工作。</p>
<p>由于我们使用了Spring Security，我们需要确保WebSocket端点也被保护。</p>
<p>但是，为了简单，我们先允许所有WebSocket连接。</p>
<p>实际上，我们可以使用相同的认证机制（例如，在WebSocket握手时进行用户认证）。</p>
<p>由于时间关系，我们暂时不处理WebSocket的安全，但实际应用中必须处理。</p>
<p>接下来，我们修改ChatController，在发送消息时保存到数据库。</p>
<p>我们还需要一个服务层来处理业务逻辑。</p>
<p>创建ChatService：</p>
<p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.service;</span><br><span class="line"></span><br><span class="line">import com.chatroom.model.ChatMessage;</span><br><span class="line">import com.chatroom.model.User;</span><br><span class="line">import com.chatroom.repository.ChatMessageRepository;</span><br><span class="line">import com.chatroom.repository.UserRepository;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">@Service</span><br><span class="line">public class ChatService &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private ChatMessageRepository chatMessageRepository;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    public ChatMessage saveMessage(ChatMessage message) &#123;</span><br><span class="line">        return chatMessageRepository.save(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public List&lt;ChatMessage&gt; getRecentMessages() &#123;</span><br><span class="line">        return chatMessageRepository.findTop100ByOrderByTimestampDesc();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public List&lt;ChatMessage&gt; getPrivateMessages(Long user1Id, Long user2Id) &#123;</span><br><span class="line">        return chatMessageRepository.findBySenderIdAndReceiverIdOrReceiverIdAndSenderIdOrderByTimestamp(user1Id, user2Id, user1Id, user2Id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public User findUserByUsername(String username) &#123;</span><br><span class="line">        return userRepository.findByUsername(username).orElse(null);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setUserOnline(String username, boolean online) &#123;</span><br><span class="line">        User user = findUserByUsername(username);</span><br><span class="line">        if (user != null) &#123;</span><br><span class="line">            user.setOnline(online);</span><br><span class="line">            userRepository.save(user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>然后修改ChatController，使用ChatService。</p>
<p>由于代码量巨大，我无法在这里展示所有修改。</p>
<p>最后，前端需要修改以支持登录和注册，以及历史消息加载。</p>
<p>由于这是一个巨大的工程，我建议分步骤实现。</p>
<p>由于时间限制，我在这里只能提供一个扩展的方向和关键代码。</p>
<p>如果您需要更详细的代码，请告诉我具体需要哪一部分，我可以提供更详细的代码。</p>
<p>考虑到这是一个学习项目，我建议您按照以下步骤自己实现：</p>
<ol>
<li>先实现数据库和JPA，确保可以保存用户和消息。</li>
<li>集成Spring Security，实现注册和登录。</li>
<li>修改WebSocket部分，将消息保存到数据库，并在用户加入和离开时更新在线状态。</li>
<li>创建API来获取历史消息，并在前端加载。</li>
<li>改进前端，添加更多功能。</li>
</ol>
<p>希望这个扩展方向对您有帮助！如果您在实现过程中遇到具体问题，可以再询问。</p>
<h1 id="多人聊天室-扩展完善方案"><a href="#多人聊天室-扩展完善方案" class="headerlink" title="多人聊天室 - 扩展完善方案"></a>多人聊天室 - 扩展完善方案</h1><p>我将继续扩展和完善这个聊天室项目，增加更多功能和优化。</p>
<h2 id="扩展功能清单"><a href="#扩展功能清单" class="headerlink" title="扩展功能清单"></a>扩展功能清单</h2><ol>
<li><strong>用户认证系统</strong> - 注册&#x2F;登录&#x2F;退出</li>
<li><strong>消息持久化</strong> - 数据库存储聊天记录</li>
<li><strong>文件上传</strong> - 支持发送图片和文件</li>
<li><strong>表情系统</strong> - 丰富的表情选择</li>
<li><strong>语音消息</strong> - 录制和发送语音</li>
<li><strong>管理员功能</strong> - 用户管理、消息管理</li>
<li><strong>高级搜索</strong> - 聊天记录搜索</li>
<li><strong>主题系统</strong> - 多套界面主题</li>
<li><strong>通知系统</strong> - 桌面通知和声音提醒</li>
<li><strong>性能优化</strong> - 消息分页、WebSocket连接优化</li>
</ol>
<h2 id="1-数据库设计-MySQL"><a href="#1-数据库设计-MySQL" class="headerlink" title="1. 数据库设计 (MySQL)"></a>1. 数据库设计 (MySQL)</h2><h3 id="1-1-SQL-脚本"><a href="#1-1-SQL-脚本" class="headerlink" title="1.1 SQL 脚本"></a>1.1 SQL 脚本</h3><p>sql</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">-- 创建数据库</span><br><span class="line">CREATE DATABASE IF NOT EXISTS chat_room DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;</span><br><span class="line">USE chat_room;</span><br><span class="line"></span><br><span class="line">-- 用户表</span><br><span class="line">CREATE TABLE users (</span><br><span class="line">    id BIGINT PRIMARY KEY AUTO_INCREMENT,</span><br><span class="line">    username VARCHAR(50) UNIQUE NOT NULL,</span><br><span class="line">    password VARCHAR(255) NOT NULL,</span><br><span class="line">    email VARCHAR(100) UNIQUE,</span><br><span class="line">    nickname VARCHAR(50),</span><br><span class="line">    avatar_color VARCHAR(20) DEFAULT &#x27;#4361ee&#x27;,</span><br><span class="line">    avatar_url VARCHAR(500),</span><br><span class="line">    bio TEXT,</span><br><span class="line">    status ENUM(&#x27;ONLINE&#x27;, &#x27;OFFLINE&#x27;, &#x27;AWAY&#x27;, &#x27;BUSY&#x27;) DEFAULT &#x27;OFFLINE&#x27;,</span><br><span class="line">    role ENUM(&#x27;USER&#x27;, &#x27;MODERATOR&#x27;, &#x27;ADMIN&#x27;) DEFAULT &#x27;USER&#x27;,</span><br><span class="line">    last_seen TIMESTAMP NULL,</span><br><span class="line">    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,</span><br><span class="line">    INDEX idx_username (username),</span><br><span class="line">    INDEX idx_status (status)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br><span class="line">-- 聊天消息表</span><br><span class="line">CREATE TABLE messages (</span><br><span class="line">    id BIGINT PRIMARY KEY AUTO_INCREMENT,</span><br><span class="line">    sender_id BIGINT NOT NULL,</span><br><span class="line">    receiver_id BIGINT NULL,</span><br><span class="line">    room_id VARCHAR(100) DEFAULT &#x27;public&#x27;,</span><br><span class="line">    content TEXT NOT NULL,</span><br><span class="line">    message_type ENUM(&#x27;TEXT&#x27;, &#x27;IMAGE&#x27;, &#x27;FILE&#x27;, &#x27;VOICE&#x27;, &#x27;SYSTEM&#x27;) DEFAULT &#x27;TEXT&#x27;,</span><br><span class="line">    file_url VARCHAR(500),</span><br><span class="line">    file_name VARCHAR(255),</span><br><span class="line">    file_size BIGINT,</span><br><span class="line">    is_read BOOLEAN DEFAULT FALSE,</span><br><span class="line">    is_deleted BOOLEAN DEFAULT FALSE,</span><br><span class="line">    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">    INDEX idx_sender_receiver (sender_id, receiver_id),</span><br><span class="line">    INDEX idx_room (room_id),</span><br><span class="line">    INDEX idx_created_at (created_at),</span><br><span class="line">    FOREIGN KEY (sender_id) REFERENCES users(id) ON DELETE CASCADE,</span><br><span class="line">    FOREIGN KEY (receiver_id) REFERENCES users(id) ON DELETE SET NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br><span class="line">-- 聊天室表</span><br><span class="line">CREATE TABLE chat_rooms (</span><br><span class="line">    id BIGINT PRIMARY KEY AUTO_INCREMENT,</span><br><span class="line">    name VARCHAR(100) NOT NULL,</span><br><span class="line">    description TEXT,</span><br><span class="line">    is_public BOOLEAN DEFAULT TRUE,</span><br><span class="line">    max_users INT DEFAULT 100,</span><br><span class="line">    created_by BIGINT NOT NULL,</span><br><span class="line">    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,</span><br><span class="line">    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE CASCADE,</span><br><span class="line">    INDEX idx_is_public (is_public)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br><span class="line">-- 聊天室成员表</span><br><span class="line">CREATE TABLE room_members (</span><br><span class="line">    id BIGINT PRIMARY KEY AUTO_INCREMENT,</span><br><span class="line">    room_id BIGINT NOT NULL,</span><br><span class="line">    user_id BIGINT NOT NULL,</span><br><span class="line">    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">    role ENUM(&#x27;MEMBER&#x27;, &#x27;ADMIN&#x27;, &#x27;OWNER&#x27;) DEFAULT &#x27;MEMBER&#x27;,</span><br><span class="line">    is_muted BOOLEAN DEFAULT FALSE,</span><br><span class="line">    UNIQUE KEY unique_room_user (room_id, user_id),</span><br><span class="line">    FOREIGN KEY (room_id) REFERENCES chat_rooms(id) ON DELETE CASCADE,</span><br><span class="line">    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,</span><br><span class="line">    INDEX idx_user_id (user_id)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br><span class="line">-- 用户会话表 (用于WebSocket连接管理)</span><br><span class="line">CREATE TABLE user_sessions (</span><br><span class="line">    id BIGINT PRIMARY KEY AUTO_INCREMENT,</span><br><span class="line">    user_id BIGINT NOT NULL,</span><br><span class="line">    session_id VARCHAR(100) NOT NULL,</span><br><span class="line">    ip_address VARCHAR(45),</span><br><span class="line">    user_agent TEXT,</span><br><span class="line">    connected_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">    disconnected_at TIMESTAMP NULL,</span><br><span class="line">    is_active BOOLEAN DEFAULT TRUE,</span><br><span class="line">    INDEX idx_user_id (user_id),</span><br><span class="line">    INDEX idx_session_id (session_id),</span><br><span class="line">    INDEX idx_is_active (is_active),</span><br><span class="line">    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br><span class="line">-- 用户关系表</span><br><span class="line">CREATE TABLE user_relationships (</span><br><span class="line">    id BIGINT PRIMARY KEY AUTO_INCREMENT,</span><br><span class="line">    user_id BIGINT NOT NULL,</span><br><span class="line">    friend_id BIGINT NOT NULL,</span><br><span class="line">    status ENUM(&#x27;PENDING&#x27;, &#x27;ACCEPTED&#x27;, &#x27;BLOCKED&#x27;) DEFAULT &#x27;PENDING&#x27;,</span><br><span class="line">    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,</span><br><span class="line">    UNIQUE KEY unique_relationship (user_id, friend_id),</span><br><span class="line">    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,</span><br><span class="line">    FOREIGN KEY (friend_id) REFERENCES users(id) ON DELETE CASCADE,</span><br><span class="line">    INDEX idx_user_status (user_id, status),</span><br><span class="line">    INDEX idx_friend_status (friend_id, status)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br><span class="line">-- 消息阅读状态表</span><br><span class="line">CREATE TABLE message_read_status (</span><br><span class="line">    id BIGINT PRIMARY KEY AUTO_INCREMENT,</span><br><span class="line">    message_id BIGINT NOT NULL,</span><br><span class="line">    user_id BIGINT NOT NULL,</span><br><span class="line">    read_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">    UNIQUE KEY unique_message_user (message_id, user_id),</span><br><span class="line">    FOREIGN KEY (message_id) REFERENCES messages(id) ON DELETE CASCADE,</span><br><span class="line">    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br><span class="line">-- 插入默认公共聊天室</span><br><span class="line">INSERT INTO chat_rooms (name, description, is_public, created_by) </span><br><span class="line">VALUES (&#x27;公共聊天室&#x27;, &#x27;欢迎来到公共聊天室，这里可以和大家畅所欲言！&#x27;, TRUE, 1);</span><br><span class="line"></span><br><span class="line">-- 插入默认管理员用户 (密码: admin123)</span><br><span class="line">INSERT INTO users (username, password, nickname, role, status) </span><br><span class="line">VALUES (&#x27;admin&#x27;, &#x27;$2a$10$YourHashedPasswordHere&#x27;, &#x27;系统管理员&#x27;, &#x27;ADMIN&#x27;, &#x27;OFFLINE&#x27;);</span><br></pre></td></tr></table></figure>



<h3 id="1-2-更新pom-xml依赖"><a href="#1-2-更新pom-xml依赖" class="headerlink" title="1.2 更新pom.xml依赖"></a>1.2 更新pom.xml依赖</h3><p>xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 数据库相关依赖 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">    &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.h2database&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;h2&lt;/artifactId&gt;</span><br><span class="line">    &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 安全认证 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;jjwt-api&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.11.5&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;jjwt-impl&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.11.5&lt;/version&gt;</span><br><span class="line">    &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;jjwt-jackson&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.11.5&lt;/version&gt;</span><br><span class="line">    &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 文件上传 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;commons-io&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;commons-io&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.11.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;commons-fileupload&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;commons-fileupload&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.4&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 缓存 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-cache&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.github.ben-manes.caffeine&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;caffeine&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>



<h2 id="2-JPA实体类"><a href="#2-JPA实体类" class="headerlink" title="2. JPA实体类"></a>2. JPA实体类</h2><h3 id="2-1-User-实体类"><a href="#2-1-User-实体类" class="headerlink" title="2.1 User 实体类"></a>2.1 User 实体类</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.entity;</span><br><span class="line"></span><br><span class="line">import javax.persistence.*;</span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">@Entity</span><br><span class="line">@Table(name = &quot;users&quot;)</span><br><span class="line">public class User &#123;</span><br><span class="line">    </span><br><span class="line">    @Id</span><br><span class="line">    @GeneratedValue(strategy = GenerationType.IDENTITY)</span><br><span class="line">    private Long id;</span><br><span class="line">    </span><br><span class="line">    @Column(unique = true, nullable = false, length = 50)</span><br><span class="line">    private String username;</span><br><span class="line">    </span><br><span class="line">    @Column(nullable = false)</span><br><span class="line">    private String password;</span><br><span class="line">    </span><br><span class="line">    @Column(unique = true)</span><br><span class="line">    private String email;</span><br><span class="line">    </span><br><span class="line">    @Column(length = 50)</span><br><span class="line">    private String nickname;</span><br><span class="line">    </span><br><span class="line">    private String avatarColor = &quot;#4361ee&quot;;</span><br><span class="line">    </span><br><span class="line">    private String avatarUrl;</span><br><span class="line">    </span><br><span class="line">    @Column(columnDefinition = &quot;TEXT&quot;)</span><br><span class="line">    private String bio;</span><br><span class="line">    </span><br><span class="line">    @Enumerated(EnumType.STRING)</span><br><span class="line">    private UserStatus status = UserStatus.OFFLINE;</span><br><span class="line">    </span><br><span class="line">    @Enumerated(EnumType.STRING)</span><br><span class="line">    private UserRole role = UserRole.USER;</span><br><span class="line">    </span><br><span class="line">    private LocalDateTime lastSeen;</span><br><span class="line">    </span><br><span class="line">    @Column(updatable = false)</span><br><span class="line">    private LocalDateTime createdAt;</span><br><span class="line">    </span><br><span class="line">    private LocalDateTime updatedAt;</span><br><span class="line">    </span><br><span class="line">    @OneToMany(mappedBy = &quot;sender&quot;, cascade = CascadeType.ALL)</span><br><span class="line">    private List&lt;Message&gt; sentMessages = new ArrayList&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    @OneToMany(mappedBy = &quot;receiver&quot;, cascade = CascadeType.ALL)</span><br><span class="line">    private List&lt;Message&gt; receivedMessages = new ArrayList&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    @OneToMany(mappedBy = &quot;user&quot;, cascade = CascadeType.ALL)</span><br><span class="line">    private List&lt;UserSession&gt; sessions = new ArrayList&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    @PrePersist</span><br><span class="line">    protected void onCreate() &#123;</span><br><span class="line">        createdAt = LocalDateTime.now();</span><br><span class="line">        updatedAt = LocalDateTime.now();</span><br><span class="line">        if (nickname == null) &#123;</span><br><span class="line">            nickname = username;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PreUpdate</span><br><span class="line">    protected void onUpdate() &#123;</span><br><span class="line">        updatedAt = LocalDateTime.now();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 枚举定义</span><br><span class="line">    public enum UserStatus &#123;</span><br><span class="line">        ONLINE, OFFLINE, AWAY, BUSY</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public enum UserRole &#123;</span><br><span class="line">        USER, MODERATOR, ADMIN</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Getters and Setters</span><br><span class="line">    public Long getId() &#123; return id; &#125;</span><br><span class="line">    public void setId(Long id) &#123; this.id = id; &#125;</span><br><span class="line">    </span><br><span class="line">    public String getUsername() &#123; return username; &#125;</span><br><span class="line">    public void setUsername(String username) &#123; this.username = username; &#125;</span><br><span class="line">    </span><br><span class="line">    public String getPassword() &#123; return password; &#125;</span><br><span class="line">    public void setPassword(String password) &#123; this.password = password; &#125;</span><br><span class="line">    </span><br><span class="line">    public String getEmail() &#123; return email; &#125;</span><br><span class="line">    public void setEmail(String email) &#123; this.email = email; &#125;</span><br><span class="line">    </span><br><span class="line">    public String getNickname() &#123; return nickname; &#125;</span><br><span class="line">    public void setNickname(String nickname) &#123; this.nickname = nickname; &#125;</span><br><span class="line">    </span><br><span class="line">    public String getAvatarColor() &#123; return avatarColor; &#125;</span><br><span class="line">    public void setAvatarColor(String avatarColor) &#123; this.avatarColor = avatarColor; &#125;</span><br><span class="line">    </span><br><span class="line">    public String getAvatarUrl() &#123; return avatarUrl; &#125;</span><br><span class="line">    public void setAvatarUrl(String avatarUrl) &#123; this.avatarUrl = avatarUrl; &#125;</span><br><span class="line">    </span><br><span class="line">    public String getBio() &#123; return bio; &#125;</span><br><span class="line">    public void setBio(String bio) &#123; this.bio = bio; &#125;</span><br><span class="line">    </span><br><span class="line">    public UserStatus getStatus() &#123; return status; &#125;</span><br><span class="line">    public void setStatus(UserStatus status) &#123; this.status = status; &#125;</span><br><span class="line">    </span><br><span class="line">    public UserRole getRole() &#123; return role; &#125;</span><br><span class="line">    public void setRole(UserRole role) &#123; this.role = role; &#125;</span><br><span class="line">    </span><br><span class="line">    public LocalDateTime getLastSeen() &#123; return lastSeen; &#125;</span><br><span class="line">    public void setLastSeen(LocalDateTime lastSeen) &#123; this.lastSeen = lastSeen; &#125;</span><br><span class="line">    </span><br><span class="line">    public LocalDateTime getCreatedAt() &#123; return createdAt; &#125;</span><br><span class="line">    public void setCreatedAt(LocalDateTime createdAt) &#123; this.createdAt = createdAt; &#125;</span><br><span class="line">    </span><br><span class="line">    public LocalDateTime getUpdatedAt() &#123; return updatedAt; &#125;</span><br><span class="line">    public void setUpdatedAt(LocalDateTime updatedAt) &#123; this.updatedAt = updatedAt; &#125;</span><br><span class="line">    </span><br><span class="line">    public List&lt;Message&gt; getSentMessages() &#123; return sentMessages; &#125;</span><br><span class="line">    public void setSentMessages(List&lt;Message&gt; sentMessages) &#123; this.sentMessages = sentMessages; &#125;</span><br><span class="line">    </span><br><span class="line">    public List&lt;Message&gt; getReceivedMessages() &#123; return receivedMessages; &#125;</span><br><span class="line">    public void setReceivedMessages(List&lt;Message&gt; receivedMessages) &#123; this.receivedMessages = receivedMessages; &#125;</span><br><span class="line">    </span><br><span class="line">    public List&lt;UserSession&gt; getSessions() &#123; return sessions; &#125;</span><br><span class="line">    public void setSessions(List&lt;UserSession&gt; sessions) &#123; this.sessions = sessions; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-2-Message-实体类"><a href="#2-2-Message-实体类" class="headerlink" title="2.2 Message 实体类"></a>2.2 Message 实体类</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.entity;</span><br><span class="line"></span><br><span class="line">import javax.persistence.*;</span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line">import java.util.HashSet;</span><br><span class="line">import java.util.Set;</span><br><span class="line"></span><br><span class="line">@Entity</span><br><span class="line">@Table(name = &quot;messages&quot;)</span><br><span class="line">public class Message &#123;</span><br><span class="line">    </span><br><span class="line">    @Id</span><br><span class="line">    @GeneratedValue(strategy = GenerationType.IDENTITY)</span><br><span class="line">    private Long id;</span><br><span class="line">    </span><br><span class="line">    @ManyToOne(fetch = FetchType.LAZY)</span><br><span class="line">    @JoinColumn(name = &quot;sender_id&quot;, nullable = false)</span><br><span class="line">    private User sender;</span><br><span class="line">    </span><br><span class="line">    @ManyToOne(fetch = FetchType.LAZY)</span><br><span class="line">    @JoinColumn(name = &quot;receiver_id&quot;)</span><br><span class="line">    private User receiver;</span><br><span class="line">    </span><br><span class="line">    @Column(name = &quot;room_id&quot;, length = 100)</span><br><span class="line">    private String roomId = &quot;public&quot;;</span><br><span class="line">    </span><br><span class="line">    @Column(nullable = false, columnDefinition = &quot;TEXT&quot;)</span><br><span class="line">    private String content;</span><br><span class="line">    </span><br><span class="line">    @Enumerated(EnumType.STRING)</span><br><span class="line">    @Column(name = &quot;message_type&quot;)</span><br><span class="line">    private MessageType type = MessageType.TEXT;</span><br><span class="line">    </span><br><span class="line">    @Column(name = &quot;file_url&quot;, length = 500)</span><br><span class="line">    private String fileUrl;</span><br><span class="line">    </span><br><span class="line">    @Column(name = &quot;file_name&quot;, length = 255)</span><br><span class="line">    private String fileName;</span><br><span class="line">    </span><br><span class="line">    @Column(name = &quot;file_size&quot;)</span><br><span class="line">    private Long fileSize;</span><br><span class="line">    </span><br><span class="line">    @Column(name = &quot;is_read&quot;)</span><br><span class="line">    private boolean read = false;</span><br><span class="line">    </span><br><span class="line">    @Column(name = &quot;is_deleted&quot;)</span><br><span class="line">    private boolean deleted = false;</span><br><span class="line">    </span><br><span class="line">    private LocalDateTime createdAt;</span><br><span class="line">    </span><br><span class="line">    @OneToMany(mappedBy = &quot;message&quot;, cascade = CascadeType.ALL, fetch = FetchType.LAZY)</span><br><span class="line">    private Set&lt;MessageReadStatus&gt; readStatuses = new HashSet&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    @PrePersist</span><br><span class="line">    protected void onCreate() &#123;</span><br><span class="line">        createdAt = LocalDateTime.now();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 枚举定义</span><br><span class="line">    public enum MessageType &#123;</span><br><span class="line">        TEXT, IMAGE, FILE, VOICE, SYSTEM</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Getters and Setters</span><br><span class="line">    public Long getId() &#123; return id; &#125;</span><br><span class="line">    public void setId(Long id) &#123; this.id = id; &#125;</span><br><span class="line">    </span><br><span class="line">    public User getSender() &#123; return sender; &#125;</span><br><span class="line">    public void setSender(User sender) &#123; this.sender = sender; &#125;</span><br><span class="line">    </span><br><span class="line">    public User getReceiver() &#123; return receiver; &#125;</span><br><span class="line">    public void setReceiver(User receiver) &#123; this.receiver = receiver; &#125;</span><br><span class="line">    </span><br><span class="line">    public String getRoomId() &#123; return roomId; &#125;</span><br><span class="line">    public void setRoomId(String roomId) &#123; this.roomId = roomId; &#125;</span><br><span class="line">    </span><br><span class="line">    public String getContent() &#123; return content; &#125;</span><br><span class="line">    public void setContent(String content) &#123; this.content = content; &#125;</span><br><span class="line">    </span><br><span class="line">    public MessageType getType() &#123; return type; &#125;</span><br><span class="line">    public void setType(MessageType type) &#123; this.type = type; &#125;</span><br><span class="line">    </span><br><span class="line">    public String getFileUrl() &#123; return fileUrl; &#125;</span><br><span class="line">    public void setFileUrl(String fileUrl) &#123; this.fileUrl = fileUrl; &#125;</span><br><span class="line">    </span><br><span class="line">    public String getFileName() &#123; return fileName; &#125;</span><br><span class="line">    public void setFileName(String fileName) &#123; this.fileName = fileName; &#125;</span><br><span class="line">    </span><br><span class="line">    public Long getFileSize() &#123; return fileSize; &#125;</span><br><span class="line">    public void setFileSize(Long fileSize) &#123; this.fileSize = fileSize; &#125;</span><br><span class="line">    </span><br><span class="line">    public boolean isRead() &#123; return read; &#125;</span><br><span class="line">    public void setRead(boolean read) &#123; this.read = read; &#125;</span><br><span class="line">    </span><br><span class="line">    public boolean isDeleted() &#123; return deleted; &#125;</span><br><span class="line">    public void setDeleted(boolean deleted) &#123; this.deleted = deleted; &#125;</span><br><span class="line">    </span><br><span class="line">    public LocalDateTime getCreatedAt() &#123; return createdAt; &#125;</span><br><span class="line">    public void setCreatedAt(LocalDateTime createdAt) &#123; this.createdAt = createdAt; &#125;</span><br><span class="line">    </span><br><span class="line">    public Set&lt;MessageReadStatus&gt; getReadStatuses() &#123; return readStatuses; &#125;</span><br><span class="line">    public void setReadStatuses(Set&lt;MessageReadStatus&gt; readStatuses) &#123; this.readStatuses = readStatuses; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-3-其他实体类"><a href="#2-3-其他实体类" class="headerlink" title="2.3 其他实体类"></a>2.3 其他实体类</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.entity;</span><br><span class="line"></span><br><span class="line">import javax.persistence.*;</span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line">@Entity</span><br><span class="line">@Table(name = &quot;chat_rooms&quot;)</span><br><span class="line">public class ChatRoom &#123;</span><br><span class="line">    @Id</span><br><span class="line">    @GeneratedValue(strategy = GenerationType.IDENTITY)</span><br><span class="line">    private Long id;</span><br><span class="line">    </span><br><span class="line">    @Column(nullable = false, length = 100)</span><br><span class="line">    private String name;</span><br><span class="line">    </span><br><span class="line">    @Column(columnDefinition = &quot;TEXT&quot;)</span><br><span class="line">    private String description;</span><br><span class="line">    </span><br><span class="line">    @Column(name = &quot;is_public&quot;)</span><br><span class="line">    private boolean isPublic = true;</span><br><span class="line">    </span><br><span class="line">    @Column(name = &quot;max_users&quot;)</span><br><span class="line">    private Integer maxUsers = 100;</span><br><span class="line">    </span><br><span class="line">    @ManyToOne(fetch = FetchType.LAZY)</span><br><span class="line">    @JoinColumn(name = &quot;created_by&quot;, nullable = false)</span><br><span class="line">    private User createdBy;</span><br><span class="line">    </span><br><span class="line">    @Column(updatable = false)</span><br><span class="line">    private LocalDateTime createdAt;</span><br><span class="line">    </span><br><span class="line">    private LocalDateTime updatedAt;</span><br><span class="line">    </span><br><span class="line">    // Getters and Setters...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Entity</span><br><span class="line">@Table(name = &quot;user_sessions&quot;)</span><br><span class="line">public class UserSession &#123;</span><br><span class="line">    @Id</span><br><span class="line">    @GeneratedValue(strategy = GenerationType.IDENTITY)</span><br><span class="line">    private Long id;</span><br><span class="line">    </span><br><span class="line">    @ManyToOne(fetch = FetchType.LAZY)</span><br><span class="line">    @JoinColumn(name = &quot;user_id&quot;, nullable = false)</span><br><span class="line">    private User user;</span><br><span class="line">    </span><br><span class="line">    @Column(name = &quot;session_id&quot;, nullable = false, length = 100)</span><br><span class="line">    private String sessionId;</span><br><span class="line">    </span><br><span class="line">    @Column(name = &quot;ip_address&quot;, length = 45)</span><br><span class="line">    private String ipAddress;</span><br><span class="line">    </span><br><span class="line">    @Column(name = &quot;user_agent&quot;, columnDefinition = &quot;TEXT&quot;)</span><br><span class="line">    private String userAgent;</span><br><span class="line">    </span><br><span class="line">    @Column(name = &quot;connected_at&quot;)</span><br><span class="line">    private LocalDateTime connectedAt;</span><br><span class="line">    </span><br><span class="line">    @Column(name = &quot;disconnected_at&quot;)</span><br><span class="line">    private LocalDateTime disconnectedAt;</span><br><span class="line">    </span><br><span class="line">    @Column(name = &quot;is_active&quot;)</span><br><span class="line">    private boolean active = true;</span><br><span class="line">    </span><br><span class="line">    // Getters and Setters...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-Spring-Security配置"><a href="#3-Spring-Security配置" class="headerlink" title="3. Spring Security配置"></a>3. Spring Security配置</h2><h3 id="3-1-Security配置类"><a href="#3-1-Security配置类" class="headerlink" title="3.1 Security配置类"></a>3.1 Security配置类</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.config;</span><br><span class="line"></span><br><span class="line">import com.chatroom.security.JwtAuthenticationFilter;</span><br><span class="line">import com.chatroom.security.JwtAuthenticationEntryPoint;</span><br><span class="line">import com.chatroom.service.UserDetailsServiceImpl;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line">import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line">import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;</span><br><span class="line">import org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line">import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line">import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line">import org.springframework.security.config.http.SessionCreationPolicy;</span><br><span class="line">import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line">import org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line">import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br><span class="line">import org.springframework.web.cors.CorsConfiguration;</span><br><span class="line">import org.springframework.web.cors.CorsConfigurationSource;</span><br><span class="line">import org.springframework.web.cors.UrlBasedCorsConfigurationSource;</span><br><span class="line"></span><br><span class="line">import java.util.Arrays;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">@EnableWebSecurity</span><br><span class="line">@EnableGlobalMethodSecurity(prePostEnabled = true)</span><br><span class="line">public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private UserDetailsServiceImpl userDetailsService;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private JwtAuthenticationEntryPoint unauthorizedHandler;</span><br><span class="line">    </span><br><span class="line">    @Bean</span><br><span class="line">    public JwtAuthenticationFilter jwtAuthenticationFilter() &#123;</span><br><span class="line">        return new JwtAuthenticationFilter();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    protected void configure(AuthenticationManagerBuilder auth) throws Exception &#123;</span><br><span class="line">        auth.userDetailsService(userDetailsService).passwordEncoder(passwordEncoder());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Bean</span><br><span class="line">    @Override</span><br><span class="line">    public AuthenticationManager authenticationManagerBean() throws Exception &#123;</span><br><span class="line">        return super.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Bean</span><br><span class="line">    public PasswordEncoder passwordEncoder() &#123;</span><br><span class="line">        return new BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">        http</span><br><span class="line">            .cors().and()</span><br><span class="line">            .csrf().disable()</span><br><span class="line">            .exceptionHandling()</span><br><span class="line">                .authenticationEntryPoint(unauthorizedHandler)</span><br><span class="line">                .and()</span><br><span class="line">            .sessionManagement()</span><br><span class="line">                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line">                .and()</span><br><span class="line">            .authorizeRequests()</span><br><span class="line">                .antMatchers(&quot;/api/auth/**&quot;).permitAll()</span><br><span class="line">                .antMatchers(&quot;/api/public/**&quot;).permitAll()</span><br><span class="line">                .antMatchers(&quot;/ws/**&quot;).permitAll()</span><br><span class="line">                .antMatchers(&quot;/css/**&quot;, &quot;/js/**&quot;, &quot;/images/**&quot;, &quot;/favicon.ico&quot;).permitAll()</span><br><span class="line">                .antMatchers(&quot;/&quot;, &quot;/index.html&quot;, &quot;/login&quot;, &quot;/register&quot;).permitAll()</span><br><span class="line">                .antMatchers(&quot;/admin/**&quot;).hasRole(&quot;ADMIN&quot;)</span><br><span class="line">                .antMatchers(&quot;/moderator/**&quot;).hasAnyRole(&quot;ADMIN&quot;, &quot;MODERATOR&quot;)</span><br><span class="line">                .anyRequest().authenticated();</span><br><span class="line">        </span><br><span class="line">        http.addFilterBefore(jwtAuthenticationFilter(), UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Bean</span><br><span class="line">    public CorsConfigurationSource corsConfigurationSource() &#123;</span><br><span class="line">        CorsConfiguration configuration = new CorsConfiguration();</span><br><span class="line">        configuration.setAllowedOrigins(Arrays.asList(&quot;*&quot;));</span><br><span class="line">        configuration.setAllowedMethods(Arrays.asList(&quot;GET&quot;, &quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;, &quot;OPTIONS&quot;));</span><br><span class="line">        configuration.setAllowedHeaders(Arrays.asList(&quot;Authorization&quot;, &quot;Content-Type&quot;, &quot;X-Requested-With&quot;));</span><br><span class="line">        configuration.setExposedHeaders(Arrays.asList(&quot;Authorization&quot;));</span><br><span class="line">        configuration.setAllowCredentials(true);</span><br><span class="line">        </span><br><span class="line">        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();</span><br><span class="line">        source.registerCorsConfiguration(&quot;/**&quot;, configuration);</span><br><span class="line">        return source;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-2-JWT工具类"><a href="#3-2-JWT工具类" class="headerlink" title="3.2 JWT工具类"></a>3.2 JWT工具类</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.security;</span><br><span class="line"></span><br><span class="line">import io.jsonwebtoken.*;</span><br><span class="line">import io.jsonwebtoken.security.Keys;</span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.security.core.Authentication;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import javax.crypto.SecretKey;</span><br><span class="line">import java.util.Date;</span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">public class JwtTokenProvider &#123;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;app.jwt.secret&#125;&quot;)</span><br><span class="line">    private String jwtSecret;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;app.jwt.expiration&#125;&quot;)</span><br><span class="line">    private int jwtExpirationInMs;</span><br><span class="line">    </span><br><span class="line">    private SecretKey getSigningKey() &#123;</span><br><span class="line">        return Keys.hmacShaKeyFor(jwtSecret.getBytes());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public String generateToken(Authentication authentication) &#123;</span><br><span class="line">        UserPrincipal userPrincipal = (UserPrincipal) authentication.getPrincipal();</span><br><span class="line">        </span><br><span class="line">        Date now = new Date();</span><br><span class="line">        Date expiryDate = new Date(now.getTime() + jwtExpirationInMs);</span><br><span class="line">        </span><br><span class="line">        return Jwts.builder()</span><br><span class="line">                .setSubject(Long.toString(userPrincipal.getId()))</span><br><span class="line">                .setIssuedAt(new Date())</span><br><span class="line">                .setExpiration(expiryDate)</span><br><span class="line">                .signWith(getSigningKey())</span><br><span class="line">                .compact();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public Long getUserIdFromJWT(String token) &#123;</span><br><span class="line">        Claims claims = Jwts.parserBuilder()</span><br><span class="line">                .setSigningKey(getSigningKey())</span><br><span class="line">                .build()</span><br><span class="line">                .parseClaimsJws(token)</span><br><span class="line">                .getBody();</span><br><span class="line">        </span><br><span class="line">        return Long.parseLong(claims.getSubject());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public boolean validateToken(String authToken) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Jwts.parserBuilder()</span><br><span class="line">                .setSigningKey(getSigningKey())</span><br><span class="line">                .build()</span><br><span class="line">                .parseClaimsJws(authToken);</span><br><span class="line">            return true;</span><br><span class="line">        &#125; catch (MalformedJwtException ex) &#123;</span><br><span class="line">            System.err.println(&quot;Invalid JWT token&quot;);</span><br><span class="line">        &#125; catch (ExpiredJwtException ex) &#123;</span><br><span class="line">            System.err.println(&quot;Expired JWT token&quot;);</span><br><span class="line">        &#125; catch (UnsupportedJwtException ex) &#123;</span><br><span class="line">            System.err.println(&quot;Unsupported JWT token&quot;);</span><br><span class="line">        &#125; catch (IllegalArgumentException ex) &#123;</span><br><span class="line">            System.err.println(&quot;JWT claims string is empty&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-3-JWT认证过滤器"><a href="#3-3-JWT认证过滤器" class="headerlink" title="3.3 JWT认证过滤器"></a>3.3 JWT认证过滤器</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.security;</span><br><span class="line"></span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line">import org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line">import org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line">import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;</span><br><span class="line">import org.springframework.util.StringUtils;</span><br><span class="line">import org.springframework.web.filter.OncePerRequestFilter;</span><br><span class="line"></span><br><span class="line">import javax.servlet.FilterChain;</span><br><span class="line">import javax.servlet.ServletException;</span><br><span class="line">import javax.servlet.http.HttpServletRequest;</span><br><span class="line">import javax.servlet.http.HttpServletResponse;</span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">public class JwtAuthenticationFilter extends OncePerRequestFilter &#123;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private JwtTokenProvider tokenProvider;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private UserDetailsServiceImpl userDetailsService;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    protected void doFilterInternal(HttpServletRequest request, </span><br><span class="line">                                    HttpServletResponse response, </span><br><span class="line">                                    FilterChain filterChain) throws ServletException, IOException &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            String jwt = getJwtFromRequest(request);</span><br><span class="line">            </span><br><span class="line">            if (StringUtils.hasText(jwt) &amp;&amp; tokenProvider.validateToken(jwt)) &#123;</span><br><span class="line">                Long userId = tokenProvider.getUserIdFromJWT(jwt);</span><br><span class="line">                </span><br><span class="line">                UserDetails userDetails = userDetailsService.loadUserById(userId);</span><br><span class="line">                UsernamePasswordAuthenticationToken authentication = </span><br><span class="line">                    new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());</span><br><span class="line">                authentication.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));</span><br><span class="line">                </span><br><span class="line">                SecurityContextHolder.getContext().setAuthentication(authentication);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception ex) &#123;</span><br><span class="line">            System.err.println(&quot;Could not set user authentication in security context: &quot; + ex.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private String getJwtFromRequest(HttpServletRequest request) &#123;</span><br><span class="line">        String bearerToken = request.getHeader(&quot;Authorization&quot;);</span><br><span class="line">        if (StringUtils.hasText(bearerToken) &amp;&amp; bearerToken.startsWith(&quot;Bearer &quot;)) &#123;</span><br><span class="line">            return bearerToken.substring(7);</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-认证和用户管理API"><a href="#4-认证和用户管理API" class="headerlink" title="4. 认证和用户管理API"></a>4. 认证和用户管理API</h2><h3 id="4-1-认证控制器"><a href="#4-1-认证控制器" class="headerlink" title="4.1 认证控制器"></a>4.1 认证控制器</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.controller.api;</span><br><span class="line"></span><br><span class="line">import com.chatroom.dto.LoginRequest;</span><br><span class="line">import com.chatroom.dto.RegisterRequest;</span><br><span class="line">import com.chatroom.dto.ApiResponse;</span><br><span class="line">import com.chatroom.dto.JwtAuthenticationResponse;</span><br><span class="line">import com.chatroom.entity.User;</span><br><span class="line">import com.chatroom.security.JwtTokenProvider;</span><br><span class="line">import com.chatroom.service.UserService;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.http.ResponseEntity;</span><br><span class="line">import org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line">import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line">import org.springframework.security.core.Authentication;</span><br><span class="line">import org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line">import org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line">import javax.validation.Valid;</span><br><span class="line"></span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/api/auth&quot;)</span><br><span class="line">@CrossOrigin(origins = &quot;*&quot;, maxAge = 3600)</span><br><span class="line">public class AuthController &#123;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private AuthenticationManager authenticationManager;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private UserService userService;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private JwtTokenProvider tokenProvider;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/login&quot;)</span><br><span class="line">    public ResponseEntity&lt;?&gt; authenticateUser(@Valid @RequestBody LoginRequest loginRequest) &#123;</span><br><span class="line">        Authentication authentication = authenticationManager.authenticate(</span><br><span class="line">            new UsernamePasswordAuthenticationToken(</span><br><span class="line">                loginRequest.getUsernameOrEmail(),</span><br><span class="line">                loginRequest.getPassword()</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        SecurityContextHolder.getContext().setAuthentication(authentication);</span><br><span class="line">        String jwt = tokenProvider.generateToken(authentication);</span><br><span class="line">        </span><br><span class="line">        User user = userService.findByUsernameOrEmail(loginRequest.getUsernameOrEmail());</span><br><span class="line">        userService.updateUserStatus(user.getId(), User.UserStatus.ONLINE);</span><br><span class="line">        </span><br><span class="line">        return ResponseEntity.ok(new JwtAuthenticationResponse(</span><br><span class="line">            jwt, </span><br><span class="line">            &quot;Bearer&quot;,</span><br><span class="line">            user.getId(),</span><br><span class="line">            user.getUsername(),</span><br><span class="line">            user.getNickname(),</span><br><span class="line">            user.getEmail(),</span><br><span class="line">            user.getRole().name()</span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/register&quot;)</span><br><span class="line">    public ResponseEntity&lt;?&gt; registerUser(@Valid @RequestBody RegisterRequest registerRequest) &#123;</span><br><span class="line">        if (userService.existsByUsername(registerRequest.getUsername())) &#123;</span><br><span class="line">            return ResponseEntity.badRequest().body(</span><br><span class="line">                new ApiResponse(false, &quot;用户名已存在&quot;)</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (userService.existsByEmail(registerRequest.getEmail())) &#123;</span><br><span class="line">            return ResponseEntity.badRequest().body(</span><br><span class="line">                new ApiResponse(false, &quot;邮箱已存在&quot;)</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        User user = new User();</span><br><span class="line">        user.setUsername(registerRequest.getUsername());</span><br><span class="line">        user.setEmail(registerRequest.getEmail());</span><br><span class="line">        user.setPassword(registerRequest.getPassword());</span><br><span class="line">        user.setNickname(registerRequest.getNickname());</span><br><span class="line">        </span><br><span class="line">        userService.createUser(user);</span><br><span class="line">        </span><br><span class="line">        return ResponseEntity.ok(new ApiResponse(true, &quot;用户注册成功&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/logout&quot;)</span><br><span class="line">    public ResponseEntity&lt;?&gt; logoutUser(@RequestHeader(value = &quot;Authorization&quot;) String token) &#123;</span><br><span class="line">        if (token != null &amp;&amp; token.startsWith(&quot;Bearer &quot;)) &#123;</span><br><span class="line">            // 可以在这里将token加入黑名单</span><br><span class="line">            String jwt = token.substring(7);</span><br><span class="line">            // token黑名单逻辑...</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 更新用户状态</span><br><span class="line">        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">        if (authentication != null) &#123;</span><br><span class="line">            UserPrincipal userPrincipal = (UserPrincipal) authentication.getPrincipal();</span><br><span class="line">            userService.updateUserStatus(userPrincipal.getId(), User.UserStatus.OFFLINE);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return ResponseEntity.ok(new ApiResponse(true, &quot;登出成功&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/check-username/&#123;username&#125;&quot;)</span><br><span class="line">    public ResponseEntity&lt;Boolean&gt; checkUsernameAvailability(@PathVariable String username) &#123;</span><br><span class="line">        Boolean isAvailable = !userService.existsByUsername(username);</span><br><span class="line">        return ResponseEntity.ok(isAvailable);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/check-email/&#123;email&#125;&quot;)</span><br><span class="line">    public ResponseEntity&lt;Boolean&gt; checkEmailAvailability(@PathVariable String email) &#123;</span><br><span class="line">        Boolean isAvailable = !userService.existsByEmail(email);</span><br><span class="line">        return ResponseEntity.ok(isAvailable);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-2-DTO类"><a href="#4-2-DTO类" class="headerlink" title="4.2 DTO类"></a>4.2 DTO类</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.dto;</span><br><span class="line"></span><br><span class="line">import javax.validation.constraints.Email;</span><br><span class="line">import javax.validation.constraints.NotBlank;</span><br><span class="line">import javax.validation.constraints.Size;</span><br><span class="line"></span><br><span class="line">public class LoginRequest &#123;</span><br><span class="line">    @NotBlank</span><br><span class="line">    private String usernameOrEmail;</span><br><span class="line">    </span><br><span class="line">    @NotBlank</span><br><span class="line">    private String password;</span><br><span class="line">    </span><br><span class="line">    // Getters and Setters...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class RegisterRequest &#123;</span><br><span class="line">    @NotBlank</span><br><span class="line">    @Size(min = 3, max = 20)</span><br><span class="line">    private String username;</span><br><span class="line">    </span><br><span class="line">    @NotBlank</span><br><span class="line">    @Size(max = 50)</span><br><span class="line">    @Email</span><br><span class="line">    private String email;</span><br><span class="line">    </span><br><span class="line">    @NotBlank</span><br><span class="line">    @Size(min = 6, max = 40)</span><br><span class="line">    private String password;</span><br><span class="line">    </span><br><span class="line">    @Size(max = 50)</span><br><span class="line">    private String nickname;</span><br><span class="line">    </span><br><span class="line">    // Getters and Setters...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class JwtAuthenticationResponse &#123;</span><br><span class="line">    private String accessToken;</span><br><span class="line">    private String tokenType = &quot;Bearer&quot;;</span><br><span class="line">    private Long userId;</span><br><span class="line">    private String username;</span><br><span class="line">    private String nickname;</span><br><span class="line">    private String email;</span><br><span class="line">    private String role;</span><br><span class="line">    </span><br><span class="line">    // Constructor, Getters and Setters...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class ApiResponse &#123;</span><br><span class="line">    private Boolean success;</span><br><span class="line">    private String message;</span><br><span class="line">    </span><br><span class="line">    // Constructor, Getters and Setters...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-扩展WebSocket功能"><a href="#5-扩展WebSocket功能" class="headerlink" title="5. 扩展WebSocket功能"></a>5. 扩展WebSocket功能</h2><h3 id="5-1-WebSocket认证拦截器"><a href="#5-1-WebSocket认证拦截器" class="headerlink" title="5.1 WebSocket认证拦截器"></a>5.1 WebSocket认证拦截器</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.websocket;</span><br><span class="line"></span><br><span class="line">import com.chatroom.security.JwtTokenProvider;</span><br><span class="line">import com.chatroom.service.UserService;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.http.server.ServerHttpRequest;</span><br><span class="line">import org.springframework.http.server.ServerHttpResponse;</span><br><span class="line">import org.springframework.http.server.ServletServerHttpRequest;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line">import org.springframework.web.socket.WebSocketHandler;</span><br><span class="line">import org.springframework.web.socket.server.HandshakeInterceptor;</span><br><span class="line"></span><br><span class="line">import javax.servlet.http.HttpServletRequest;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">public class AuthHandshakeInterceptor implements HandshakeInterceptor &#123;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private JwtTokenProvider tokenProvider;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private UserService userService;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public boolean beforeHandshake(ServerHttpRequest request, ServerHttpResponse response, </span><br><span class="line">                                   WebSocketHandler wsHandler, Map&lt;String, Object&gt; attributes) throws Exception &#123;</span><br><span class="line">        </span><br><span class="line">        if (request instanceof ServletServerHttpRequest) &#123;</span><br><span class="line">            ServletServerHttpRequest servletRequest = (ServletServerHttpRequest) request;</span><br><span class="line">            HttpServletRequest httpServletRequest = servletRequest.getServletRequest();</span><br><span class="line">            </span><br><span class="line">            // 从请求参数或Header中获取token</span><br><span class="line">            String token = httpServletRequest.getParameter(&quot;token&quot;);</span><br><span class="line">            if (token == null) &#123;</span><br><span class="line">                token = httpServletRequest.getHeader(&quot;Authorization&quot;);</span><br><span class="line">                if (token != null &amp;&amp; token.startsWith(&quot;Bearer &quot;)) &#123;</span><br><span class="line">                    token = token.substring(7);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            if (token != null &amp;&amp; tokenProvider.validateToken(token)) &#123;</span><br><span class="line">                Long userId = tokenProvider.getUserIdFromJWT(token);</span><br><span class="line">                attributes.put(&quot;userId&quot;, userId);</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void afterHandshake(ServerHttpRequest request, ServerHttpResponse response, </span><br><span class="line">                               WebSocketHandler wsHandler, Exception exception) &#123;</span><br><span class="line">        // 握手后处理</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-2-增强的WebSocket配置"><a href="#5-2-增强的WebSocket配置" class="headerlink" title="5.2 增强的WebSocket配置"></a>5.2 增强的WebSocket配置</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.config;</span><br><span class="line"></span><br><span class="line">import com.chatroom.websocket.AuthHandshakeInterceptor;</span><br><span class="line">import com.chatroom.websocket.PresenceChannelInterceptor;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.messaging.simp.config.ChannelRegistration;</span><br><span class="line">import org.springframework.messaging.simp.config.MessageBrokerRegistry;</span><br><span class="line">import org.springframework.web.socket.config.annotation.EnableWebSocketMessageBroker;</span><br><span class="line">import org.springframework.web.socket.config.annotation.StompEndpointRegistry;</span><br><span class="line">import org.springframework.web.socket.config.annotation.WebSocketMessageBrokerConfigurer;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">@EnableWebSocketMessageBroker</span><br><span class="line">public class WebSocketConfig implements WebSocketMessageBrokerConfigurer &#123;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private AuthHandshakeInterceptor authHandshakeInterceptor;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private PresenceChannelInterceptor presenceChannelInterceptor;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void configureMessageBroker(MessageBrokerRegistry config) &#123;</span><br><span class="line">        // 启用简单消息代理，目标以/topic、/queue、/user开头</span><br><span class="line">        config.enableSimpleBroker(&quot;/topic&quot;, &quot;/queue&quot;, &quot;/user&quot;);</span><br><span class="line">        // 全局消息前缀</span><br><span class="line">        config.setApplicationDestinationPrefixes(&quot;/app&quot;);</span><br><span class="line">        // 点对点消息前缀</span><br><span class="line">        config.setUserDestinationPrefix(&quot;/user&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void registerStompEndpoints(StompEndpointRegistry registry) &#123;</span><br><span class="line">        // 注册WebSocket端点，允许跨域，添加认证拦截器</span><br><span class="line">        registry.addEndpoint(&quot;/ws&quot;)</span><br><span class="line">                .addInterceptors(authHandshakeInterceptor)</span><br><span class="line">                .setAllowedOriginPatterns(&quot;*&quot;)</span><br><span class="line">                .withSockJS();</span><br><span class="line">        </span><br><span class="line">        registry.addEndpoint(&quot;/ws&quot;)</span><br><span class="line">                .addInterceptors(authHandshakeInterceptor)</span><br><span class="line">                .setAllowedOriginPatterns(&quot;*&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void configureClientInboundChannel(ChannelRegistration registration) &#123;</span><br><span class="line">        registration.interceptors(presenceChannelInterceptor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-3-增强的WebSocket处理器"><a href="#5-3-增强的WebSocket处理器" class="headerlink" title="5.3 增强的WebSocket处理器"></a>5.3 增强的WebSocket处理器</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.websocket;</span><br><span class="line"></span><br><span class="line">import com.chatroom.dto.MessageDTO;</span><br><span class="line">import com.chatroom.entity.Message;</span><br><span class="line">import com.chatroom.entity.User;</span><br><span class="line">import com.chatroom.service.MessageService;</span><br><span class="line">import com.chatroom.service.UserService;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.context.event.EventListener;</span><br><span class="line">import org.springframework.messaging.simp.SimpMessageHeaderAccessor;</span><br><span class="line">import org.springframework.messaging.simp.SimpMessagingTemplate;</span><br><span class="line">import org.springframework.messaging.simp.stomp.StompHeaderAccessor;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line">import org.springframework.web.socket.messaging.SessionConnectEvent;</span><br><span class="line">import org.springframework.web.socket.messaging.SessionDisconnectEvent;</span><br><span class="line"></span><br><span class="line">import java.util.Date;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">public class WebSocketEventListener &#123;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private SimpMessagingTemplate messagingTemplate;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private UserService userService;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private MessageService messageService;</span><br><span class="line">    </span><br><span class="line">    private final Map&lt;String, String&gt; sessionUserMap = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    @EventListener</span><br><span class="line">    public void handleWebSocketConnectListener(SessionConnectEvent event) &#123;</span><br><span class="line">        StompHeaderAccessor headerAccessor = StompHeaderAccessor.wrap(event.getMessage());</span><br><span class="line">        Map&lt;String, Object&gt; sessionAttributes = headerAccessor.getSessionAttributes();</span><br><span class="line">        </span><br><span class="line">        if (sessionAttributes != null) &#123;</span><br><span class="line">            Long userId = (Long) sessionAttributes.get(&quot;userId&quot;);</span><br><span class="line">            if (userId != null) &#123;</span><br><span class="line">                String sessionId = headerAccessor.getSessionId();</span><br><span class="line">                sessionUserMap.put(sessionId, userId.toString());</span><br><span class="line">                </span><br><span class="line">                // 更新用户状态为在线</span><br><span class="line">                userService.updateUserStatus(userId, User.UserStatus.ONLINE);</span><br><span class="line">                </span><br><span class="line">                // 广播用户上线通知</span><br><span class="line">                User user = userService.findById(userId);</span><br><span class="line">                MessageDTO message = new MessageDTO();</span><br><span class="line">                message.setType(Message.MessageType.SYSTEM);</span><br><span class="line">                message.setSender(&quot;系统&quot;);</span><br><span class="line">                message.setContent(user.getNickname() + &quot; 上线了&quot;);</span><br><span class="line">                message.setTimestamp(new Date());</span><br><span class="line">                </span><br><span class="line">                messagingTemplate.convertAndSend(&quot;/topic/public&quot;, message);</span><br><span class="line">                </span><br><span class="line">                // 广播在线用户列表更新</span><br><span class="line">                broadcastOnlineUsers();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @EventListener</span><br><span class="line">    public void handleWebSocketDisconnectListener(SessionDisconnectEvent event) &#123;</span><br><span class="line">        StompHeaderAccessor headerAccessor = StompHeaderAccessor.wrap(event.getMessage());</span><br><span class="line">        String sessionId = headerAccessor.getSessionId();</span><br><span class="line">        </span><br><span class="line">        String userIdStr = sessionUserMap.remove(sessionId);</span><br><span class="line">        if (userIdStr != null) &#123;</span><br><span class="line">            Long userId = Long.parseLong(userIdStr);</span><br><span class="line">            </span><br><span class="line">            // 如果用户没有其他活跃会话，更新状态为离线</span><br><span class="line">            if (!sessionUserMap.containsValue(userIdStr)) &#123;</span><br><span class="line">                userService.updateUserStatus(userId, User.UserStatus.OFFLINE);</span><br><span class="line">                </span><br><span class="line">                // 广播用户离线通知</span><br><span class="line">                User user = userService.findById(userId);</span><br><span class="line">                MessageDTO message = new MessageDTO();</span><br><span class="line">                message.setType(Message.MessageType.SYSTEM);</span><br><span class="line">                message.setSender(&quot;系统&quot;);</span><br><span class="line">                message.setContent(user.getNickname() + &quot; 离线了&quot;);</span><br><span class="line">                message.setTimestamp(new Date());</span><br><span class="line">                </span><br><span class="line">                messagingTemplate.convertAndSend(&quot;/topic/public&quot;, message);</span><br><span class="line">                </span><br><span class="line">                // 广播在线用户列表更新</span><br><span class="line">                broadcastOnlineUsers();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void broadcastOnlineUsers() &#123;</span><br><span class="line">        // 获取在线用户列表并广播</span><br><span class="line">        Map&lt;String, Object&gt; onlineUsers = userService.getOnlineUsers();</span><br><span class="line">        messagingTemplate.convertAndSend(&quot;/topic/online-users&quot;, onlineUsers);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="6-文件上传功能"><a href="#6-文件上传功能" class="headerlink" title="6. 文件上传功能"></a>6. 文件上传功能</h2><h3 id="6-1-文件上传配置"><a href="#6-1-文件上传配置" class="headerlink" title="6.1 文件上传配置"></a>6.1 文件上传配置</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.config;</span><br><span class="line"></span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.web.multipart.MultipartResolver;</span><br><span class="line">import org.springframework.web.multipart.commons.CommonsMultipartResolver;</span><br><span class="line">import org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;</span><br><span class="line">import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">public class FileUploadConfig implements WebMvcConfigurer &#123;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;file.upload-dir&#125;&quot;)</span><br><span class="line">    private String uploadDir;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;file.max-size&#125;&quot;)</span><br><span class="line">    private String maxFileSize;</span><br><span class="line">    </span><br><span class="line">    @Bean</span><br><span class="line">    public MultipartResolver multipartResolver() &#123;</span><br><span class="line">        CommonsMultipartResolver resolver = new CommonsMultipartResolver();</span><br><span class="line">        resolver.setMaxUploadSizePerFile(50 * 1024 * 1024); // 50MB</span><br><span class="line">        resolver.setDefaultEncoding(&quot;UTF-8&quot;);</span><br><span class="line">        return resolver;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void addResourceHandlers(ResourceHandlerRegistry registry) &#123;</span><br><span class="line">        registry.addResourceHandler(&quot;/uploads/**&quot;)</span><br><span class="line">                .addResourceLocations(&quot;file:&quot; + uploadDir + &quot;/&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-2-文件服务类"><a href="#6-2-文件服务类" class="headerlink" title="6.2 文件服务类"></a>6.2 文件服务类</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.service;</span><br><span class="line"></span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line">import org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line">import javax.annotation.PostConstruct;</span><br><span class="line">import java.io.File;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.nio.file.Files;</span><br><span class="line">import java.nio.file.Path;</span><br><span class="line">import java.nio.file.Paths;</span><br><span class="line">import java.nio.file.StandardCopyOption;</span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line">import java.time.format.DateTimeFormatter;</span><br><span class="line">import java.util.UUID;</span><br><span class="line"></span><br><span class="line">@Service</span><br><span class="line">public class FileStorageService &#123;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;file.upload-dir&#125;&quot;)</span><br><span class="line">    private String uploadDir;</span><br><span class="line">    </span><br><span class="line">    @PostConstruct</span><br><span class="line">    public void init() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Files.createDirectories(Paths.get(uploadDir, &quot;images&quot;));</span><br><span class="line">            Files.createDirectories(Paths.get(uploadDir, &quot;files&quot;));</span><br><span class="line">            Files.createDirectories(Paths.get(uploadDir, &quot;voices&quot;));</span><br><span class="line">            Files.createDirectories(Paths.get(uploadDir, &quot;avatars&quot;));</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            throw new RuntimeException(&quot;Could not create upload directory&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public String storeFile(MultipartFile file, String fileType) throws IOException &#123;</span><br><span class="line">        // 验证文件类型</span><br><span class="line">        if (!isValidFileType(file, fileType)) &#123;</span><br><span class="line">            throw new IllegalArgumentException(&quot;Invalid file type&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 生成唯一文件名</span><br><span class="line">        String originalFilename = file.getOriginalFilename();</span><br><span class="line">        String fileExtension = getFileExtension(originalFilename);</span><br><span class="line">        String fileName = generateFileName(fileExtension);</span><br><span class="line">        </span><br><span class="line">        // 确定存储路径</span><br><span class="line">        String storagePath = getStoragePath(fileType);</span><br><span class="line">        Path targetLocation = Paths.get(storagePath).resolve(fileName);</span><br><span class="line">        </span><br><span class="line">        // 保存文件</span><br><span class="line">        Files.copy(file.getInputStream(), targetLocation, StandardCopyOption.REPLACE_EXISTING);</span><br><span class="line">        </span><br><span class="line">        // 返回访问路径</span><br><span class="line">        return &quot;/uploads/&quot; + getRelativePath(fileType) + &quot;/&quot; + fileName;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public boolean deleteFile(String fileUrl) &#123;</span><br><span class="line">        if (fileUrl == null || !fileUrl.startsWith(&quot;/uploads/&quot;)) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        String filePath = uploadDir + fileUrl.substring(&quot;/uploads&quot;.length());</span><br><span class="line">        File file = new File(filePath);</span><br><span class="line">        return file.delete();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private String generateFileName(String extension) &#123;</span><br><span class="line">        String timestamp = LocalDateTime.now().format(DateTimeFormatter.ofPattern(&quot;yyyyMMddHHmmss&quot;));</span><br><span class="line">        String uuid = UUID.randomUUID().toString().substring(0, 8);</span><br><span class="line">        return timestamp + &quot;_&quot; + uuid + &quot;.&quot; + extension;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private String getFileExtension(String filename) &#123;</span><br><span class="line">        if (filename == null) &#123;</span><br><span class="line">            return &quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        int lastDotIndex = filename.lastIndexOf(&quot;.&quot;);</span><br><span class="line">        return lastDotIndex == -1 ? &quot;&quot; : filename.substring(lastDotIndex + 1).toLowerCase();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private boolean isValidFileType(MultipartFile file, String fileType) &#123;</span><br><span class="line">        String contentType = file.getContentType();</span><br><span class="line">        </span><br><span class="line">        switch (fileType) &#123;</span><br><span class="line">            case &quot;image&quot;:</span><br><span class="line">                return contentType != null &amp;&amp; contentType.startsWith(&quot;image/&quot;);</span><br><span class="line">            case &quot;voice&quot;:</span><br><span class="line">                return contentType != null &amp;&amp; contentType.startsWith(&quot;audio/&quot;);</span><br><span class="line">            case &quot;file&quot;:</span><br><span class="line">                // 允许所有文件类型，但可以限制大小</span><br><span class="line">                return true;</span><br><span class="line">            default:</span><br><span class="line">                return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private String getStoragePath(String fileType) &#123;</span><br><span class="line">        switch (fileType) &#123;</span><br><span class="line">            case &quot;image&quot;:</span><br><span class="line">                return uploadDir + &quot;/images&quot;;</span><br><span class="line">            case &quot;voice&quot;:</span><br><span class="line">                return uploadDir + &quot;/voices&quot;;</span><br><span class="line">            case &quot;avatar&quot;:</span><br><span class="line">                return uploadDir + &quot;/avatars&quot;;</span><br><span class="line">            default:</span><br><span class="line">                return uploadDir + &quot;/files&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private String getRelativePath(String fileType) &#123;</span><br><span class="line">        switch (fileType) &#123;</span><br><span class="line">            case &quot;image&quot;:</span><br><span class="line">                return &quot;images&quot;;</span><br><span class="line">            case &quot;voice&quot;:</span><br><span class="line">                return &quot;voices&quot;;</span><br><span class="line">            case &quot;avatar&quot;:</span><br><span class="line">                return &quot;avatars&quot;;</span><br><span class="line">            default:</span><br><span class="line">                return &quot;files&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public String getFileSizeReadable(long size) &#123;</span><br><span class="line">        if (size &lt;= 0) return &quot;0 B&quot;;</span><br><span class="line">        </span><br><span class="line">        final String[] units = new String[] &#123;&quot;B&quot;, &quot;KB&quot;, &quot;MB&quot;, &quot;GB&quot;, &quot;TB&quot;&#125;;</span><br><span class="line">        int digitGroups = (int) (Math.log10(size) / Math.log10(1024));</span><br><span class="line">        </span><br><span class="line">        return String.format(&quot;%.1f %s&quot;, size / Math.pow(1024, digitGroups), units[digitGroups]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="7-前端扩展"><a href="#7-前端扩展" class="headerlink" title="7. 前端扩展"></a>7. 前端扩展</h2><h3 id="7-1-增强的聊天页面-index-html扩展"><a href="#7-1-增强的聊天页面-index-html扩展" class="headerlink" title="7.1 增强的聊天页面 (index.html扩展)"></a>7.1 增强的聊天页面 (index.html扩展)</h3><p>html</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 在原有基础上添加以下功能区域 --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 用户设置模态框 --&gt;</span><br><span class="line">&lt;div class=&quot;modal-overlay&quot; id=&quot;userSettingsModal&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;modal&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;modal-header&quot;&gt;</span><br><span class="line">            &lt;h3&gt;&lt;i class=&quot;fas fa-user-cog&quot;&gt;&lt;/i&gt; 用户设置&lt;/h3&gt;</span><br><span class="line">            &lt;button class=&quot;close-modal&quot;&gt;&amp;times;&lt;/button&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;modal-body&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;settings-tabs&quot;&gt;</span><br><span class="line">                &lt;div class=&quot;tab-header&quot;&gt;</span><br><span class="line">                    &lt;button class=&quot;tab-btn active&quot; data-tab=&quot;profile&quot;&gt;个人资料&lt;/button&gt;</span><br><span class="line">                    &lt;button class=&quot;tab-btn&quot; data-tab=&quot;account&quot;&gt;账户设置&lt;/button&gt;</span><br><span class="line">                    &lt;button class=&quot;tab-btn&quot; data-tab=&quot;privacy&quot;&gt;隐私设置&lt;/button&gt;</span><br><span class="line">                    &lt;button class=&quot;tab-btn&quot; data-tab=&quot;notifications&quot;&gt;通知设置&lt;/button&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                </span><br><span class="line">                &lt;div class=&quot;tab-content active&quot; id=&quot;profileTab&quot;&gt;</span><br><span class="line">                    &lt;div class=&quot;avatar-upload&quot;&gt;</span><br><span class="line">                        &lt;div class=&quot;avatar-preview&quot; id=&quot;avatarPreview&quot;&gt;</span><br><span class="line">                            &lt;img src=&quot;&quot; alt=&quot;头像预览&quot;&gt;</span><br><span class="line">                        &lt;/div&gt;</span><br><span class="line">                        &lt;input type=&quot;file&quot; id=&quot;avatarUpload&quot; accept=&quot;image/*&quot; hidden&gt;</span><br><span class="line">                        &lt;button class=&quot;btn-secondary&quot; id=&quot;changeAvatarBtn&quot;&gt;</span><br><span class="line">                            &lt;i class=&quot;fas fa-camera&quot;&gt;&lt;/i&gt; 更换头像</span><br><span class="line">                        &lt;/button&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                    </span><br><span class="line">                    &lt;div class=&quot;form-group&quot;&gt;</span><br><span class="line">                        &lt;label for=&quot;editNickname&quot;&gt;昵称&lt;/label&gt;</span><br><span class="line">                        &lt;input type=&quot;text&quot; id=&quot;editNickname&quot; placeholder=&quot;请输入昵称&quot;&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                    </span><br><span class="line">                    &lt;div class=&quot;form-group&quot;&gt;</span><br><span class="line">                        &lt;label for=&quot;editBio&quot;&gt;个人简介&lt;/label&gt;</span><br><span class="line">                        &lt;textarea id=&quot;editBio&quot; rows=&quot;3&quot; placeholder=&quot;介绍一下自己...&quot;&gt;&lt;/textarea&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                    </span><br><span class="line">                    &lt;div class=&quot;form-group&quot;&gt;</span><br><span class="line">                        &lt;label&gt;状态&lt;/label&gt;</span><br><span class="line">                        &lt;div class=&quot;status-options&quot;&gt;</span><br><span class="line">                            &lt;label class=&quot;status-option&quot;&gt;</span><br><span class="line">                                &lt;input type=&quot;radio&quot; name=&quot;status&quot; value=&quot;ONLINE&quot; checked&gt;</span><br><span class="line">                                &lt;span class=&quot;status-indicator online&quot;&gt;&lt;/span&gt;</span><br><span class="line">                                &lt;span&gt;在线&lt;/span&gt;</span><br><span class="line">                            &lt;/label&gt;</span><br><span class="line">                            &lt;label class=&quot;status-option&quot;&gt;</span><br><span class="line">                                &lt;input type=&quot;radio&quot; name=&quot;status&quot; value=&quot;AWAY&quot;&gt;</span><br><span class="line">                                &lt;span class=&quot;status-indicator away&quot;&gt;&lt;/span&gt;</span><br><span class="line">                                &lt;span&gt;离开&lt;/span&gt;</span><br><span class="line">                            &lt;/label&gt;</span><br><span class="line">                            &lt;label class=&quot;status-option&quot;&gt;</span><br><span class="line">                                &lt;input type=&quot;radio&quot; name=&quot;status&quot; value=&quot;BUSY&quot;&gt;</span><br><span class="line">                                &lt;span class=&quot;status-indicator busy&quot;&gt;&lt;/span&gt;</span><br><span class="line">                                &lt;span&gt;忙碌&lt;/span&gt;</span><br><span class="line">                            &lt;/label&gt;</span><br><span class="line">                        &lt;/div&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                </span><br><span class="line">                &lt;div class=&quot;tab-content&quot; id=&quot;accountTab&quot;&gt;</span><br><span class="line">                    &lt;!-- 账户设置内容 --&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                </span><br><span class="line">                &lt;div class=&quot;tab-content&quot; id=&quot;privacyTab&quot;&gt;</span><br><span class="line">                    &lt;!-- 隐私设置内容 --&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                </span><br><span class="line">                &lt;div class=&quot;tab-content&quot; id=&quot;notificationsTab&quot;&gt;</span><br><span class="line">                    &lt;!-- 通知设置内容 --&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;modal-footer&quot;&gt;</span><br><span class="line">            &lt;button id=&quot;saveSettingsBtn&quot; class=&quot;btn-primary&quot;&gt;</span><br><span class="line">                &lt;i class=&quot;fas fa-save&quot;&gt;&lt;/i&gt; 保存设置</span><br><span class="line">            &lt;/button&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 表情选择器 --&gt;</span><br><span class="line">&lt;div class=&quot;emoji-picker&quot; id=&quot;emojiPicker&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;emoji-categories&quot;&gt;</span><br><span class="line">        &lt;button class=&quot;emoji-category-btn active&quot; data-category=&quot;smileys&quot;&gt;</span><br><span class="line">            &lt;i class=&quot;far fa-smile&quot;&gt;&lt;/i&gt;</span><br><span class="line">        &lt;/button&gt;</span><br><span class="line">        &lt;button class=&quot;emoji-category-btn&quot; data-category=&quot;animals&quot;&gt;</span><br><span class="line">            &lt;i class=&quot;fas fa-paw&quot;&gt;&lt;/i&gt;</span><br><span class="line">        &lt;/button&gt;</span><br><span class="line">        &lt;button class=&quot;emoji-category-btn&quot; data-category=&quot;food&quot;&gt;</span><br><span class="line">            &lt;i class=&quot;fas fa-utensils&quot;&gt;&lt;/i&gt;</span><br><span class="line">        &lt;/button&gt;</span><br><span class="line">        &lt;button class=&quot;emoji-category-btn&quot; data-category=&quot;travel&quot;&gt;</span><br><span class="line">            &lt;i class=&quot;fas fa-plane&quot;&gt;&lt;/i&gt;</span><br><span class="line">        &lt;/button&gt;</span><br><span class="line">        &lt;button class=&quot;emoji-category-btn&quot; data-category=&quot;objects&quot;&gt;</span><br><span class="line">            &lt;i class=&quot;fas fa-lightbulb&quot;&gt;&lt;/i&gt;</span><br><span class="line">        &lt;/button&gt;</span><br><span class="line">        &lt;button class=&quot;emoji-category-btn&quot; data-category=&quot;symbols&quot;&gt;</span><br><span class="line">            &lt;i class=&quot;fas fa-heart&quot;&gt;&lt;/i&gt;</span><br><span class="line">        &lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;div class=&quot;emoji-grid&quot; id=&quot;emojiGrid&quot;&gt;</span><br><span class="line">        &lt;!-- 表情将通过JS动态生成 --&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;div class=&quot;emoji-search&quot;&gt;</span><br><span class="line">        &lt;input type=&quot;text&quot; id=&quot;emojiSearch&quot; placeholder=&quot;搜索表情...&quot;&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 文件上传模态框 --&gt;</span><br><span class="line">&lt;div class=&quot;modal-overlay&quot; id=&quot;fileUploadModal&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;modal&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;modal-header&quot;&gt;</span><br><span class="line">            &lt;h3&gt;&lt;i class=&quot;fas fa-cloud-upload-alt&quot;&gt;&lt;/i&gt; 上传文件&lt;/h3&gt;</span><br><span class="line">            &lt;button class=&quot;close-modal&quot;&gt;&amp;times;&lt;/button&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;modal-body&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;upload-area&quot; id=&quot;uploadArea&quot;&gt;</span><br><span class="line">                &lt;i class=&quot;fas fa-cloud-upload-alt upload-icon&quot;&gt;&lt;/i&gt;</span><br><span class="line">                &lt;p&gt;拖放文件到这里，或点击选择文件&lt;/p&gt;</span><br><span class="line">                &lt;input type=&quot;file&quot; id=&quot;fileInput&quot; multiple hidden&gt;</span><br><span class="line">                &lt;button class=&quot;btn-secondary&quot; id=&quot;selectFileBtn&quot;&gt;选择文件&lt;/button&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            </span><br><span class="line">            &lt;div class=&quot;upload-progress&quot; id=&quot;uploadProgress&quot;&gt;</span><br><span class="line">                &lt;!-- 上传进度将通过JS动态生成 --&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            </span><br><span class="line">            &lt;div class=&quot;upload-preview&quot; id=&quot;uploadPreview&quot;&gt;</span><br><span class="line">                &lt;!-- 文件预览 --&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;modal-footer&quot;&gt;</span><br><span class="line">            &lt;button id=&quot;sendFilesBtn&quot; class=&quot;btn-primary&quot; disabled&gt;</span><br><span class="line">                &lt;i class=&quot;fas fa-paper-plane&quot;&gt;&lt;/i&gt; 发送文件</span><br><span class="line">            &lt;/button&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 语音消息录制组件 --&gt;</span><br><span class="line">&lt;div class=&quot;voice-recorder&quot; id=&quot;voiceRecorder&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;recorder-header&quot;&gt;</span><br><span class="line">        &lt;h4&gt;&lt;i class=&quot;fas fa-microphone&quot;&gt;&lt;/i&gt; 录制语音消息&lt;/h4&gt;</span><br><span class="line">        &lt;button class=&quot;close-recorder&quot;&gt;</span><br><span class="line">            &lt;i class=&quot;fas fa-times&quot;&gt;&lt;/i&gt;</span><br><span class="line">        &lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;div class=&quot;recorder-body&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;recorder-visualizer&quot; id=&quot;visualizer&quot;&gt;</span><br><span class="line">            &lt;!-- 音频可视化 --&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;div class=&quot;recorder-timer&quot;&gt;</span><br><span class="line">            &lt;span id=&quot;recordingTime&quot;&gt;00:00&lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;div class=&quot;recorder-controls&quot;&gt;</span><br><span class="line">            &lt;button class=&quot;recorder-btn record-btn&quot; id=&quot;startRecordBtn&quot;&gt;</span><br><span class="line">                &lt;i class=&quot;fas fa-microphone&quot;&gt;&lt;/i&gt;</span><br><span class="line">            &lt;/button&gt;</span><br><span class="line">            &lt;button class=&quot;recorder-btn stop-btn&quot; id=&quot;stopRecordBtn&quot; disabled&gt;</span><br><span class="line">                &lt;i class=&quot;fas fa-stop&quot;&gt;&lt;/i&gt;</span><br><span class="line">            &lt;/button&gt;</span><br><span class="line">            &lt;button class=&quot;recorder-btn play-btn&quot; id=&quot;playRecordBtn&quot; disabled&gt;</span><br><span class="line">                &lt;i class=&quot;fas fa-play&quot;&gt;&lt;/i&gt;</span><br><span class="line">            &lt;/button&gt;</span><br><span class="line">            &lt;button class=&quot;recorder-btn send-btn&quot; id=&quot;sendRecordBtn&quot; disabled&gt;</span><br><span class="line">                &lt;i class=&quot;fas fa-paper-plane&quot;&gt;&lt;/i&gt;</span><br><span class="line">            &lt;/button&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 消息上下文菜单 --&gt;</span><br><span class="line">&lt;div class=&quot;context-menu&quot; id=&quot;messageContextMenu&quot;&gt;</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">        &lt;li data-action=&quot;copy&quot;&gt;&lt;i class=&quot;fas fa-copy&quot;&gt;&lt;/i&gt; 复制&lt;/li&gt;</span><br><span class="line">        &lt;li data-action=&quot;reply&quot;&gt;&lt;i class=&quot;fas fa-reply&quot;&gt;&lt;/i&gt; 回复&lt;/li&gt;</span><br><span class="line">        &lt;li data-action=&quot;forward&quot;&gt;&lt;i class=&quot;fas fa-share&quot;&gt;&lt;/i&gt; 转发&lt;/li&gt;</span><br><span class="line">        &lt;li data-action=&quot;delete&quot;&gt;&lt;i class=&quot;fas fa-trash&quot;&gt;&lt;/i&gt; 删除&lt;/li&gt;</span><br><span class="line">        &lt;li class=&quot;separator&quot;&gt;&lt;/li&gt;</span><br><span class="line">        &lt;li data-action=&quot;report&quot;&gt;&lt;i class=&quot;fas fa-flag&quot;&gt;&lt;/i&gt; 举报&lt;/li&gt;</span><br><span class="line">        &lt;li data-action=&quot;block&quot;&gt;&lt;i class=&quot;fas fa-ban&quot;&gt;&lt;/i&gt; 屏蔽用户&lt;/li&gt;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>



<h3 id="7-2-增强的CSS样式"><a href="#7-2-增强的CSS样式" class="headerlink" title="7.2 增强的CSS样式"></a>7.2 增强的CSS样式</h3><p>css</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br></pre></td><td class="code"><pre><span class="line">/* 添加到chat.css中 */</span><br><span class="line"></span><br><span class="line">/* 主题系统 */</span><br><span class="line">body.dark-theme &#123;</span><br><span class="line">    --primary-color: #7289da;</span><br><span class="line">    --secondary-color: #5865f2;</span><br><span class="line">    --dark-color: #36393f;</span><br><span class="line">    --light-color: #2f3136;</span><br><span class="line">    --gray-color: #b9bbbe;</span><br><span class="line">    background: #202225;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body.dark-theme .container &#123;</span><br><span class="line">    background: var(--dark-color);</span><br><span class="line">    color: #ffffff;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body.dark-theme .sidebar &#123;</span><br><span class="line">    background: var(--light-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body.dark-theme .main-chat &#123;</span><br><span class="line">    background: var(--dark-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body.dark-theme .message-content &#123;</span><br><span class="line">    background: var(--light-color);</span><br><span class="line">    color: #dcddde;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body.dark-theme .message.outgoing .message-content &#123;</span><br><span class="line">    background: var(--primary-color);</span><br><span class="line">    color: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 消息类型样式 */</span><br><span class="line">.message.file-message .message-content &#123;</span><br><span class="line">    padding: 10px;</span><br><span class="line">    max-width: 400px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.file-preview &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    gap: 15px;</span><br><span class="line">    padding: 15px;</span><br><span class="line">    background: rgba(255, 255, 255, 0.05);</span><br><span class="line">    border-radius: 10px;</span><br><span class="line">    margin-bottom: 10px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.file-icon &#123;</span><br><span class="line">    width: 50px;</span><br><span class="line">    height: 50px;</span><br><span class="line">    border-radius: 10px;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    font-size: 1.5rem;</span><br><span class="line">    color: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.file-icon.image &#123;</span><br><span class="line">    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.file-icon.pdf &#123;</span><br><span class="line">    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.file-icon.word &#123;</span><br><span class="line">    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.file-icon.excel &#123;</span><br><span class="line">    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.file-icon.zip &#123;</span><br><span class="line">    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.file-info &#123;</span><br><span class="line">    flex: 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.file-name &#123;</span><br><span class="line">    font-weight: 500;</span><br><span class="line">    margin-bottom: 5px;</span><br><span class="line">    word-break: break-all;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.file-size &#123;</span><br><span class="line">    font-size: 0.85rem;</span><br><span class="line">    color: var(--gray-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.file-download &#123;</span><br><span class="line">    background: var(--primary-color);</span><br><span class="line">    color: white;</span><br><span class="line">    border: none;</span><br><span class="line">    width: 40px;</span><br><span class="line">    height: 40px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.file-download:hover &#123;</span><br><span class="line">    background: var(--secondary-color);</span><br><span class="line">    transform: translateY(-2px);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 图片消息 */</span><br><span class="line">.message.image-message .message-content &#123;</span><br><span class="line">    padding: 0;</span><br><span class="line">    overflow: hidden;</span><br><span class="line">    max-width: 400px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.image-preview &#123;</span><br><span class="line">    width: 100%;</span><br><span class="line">    max-height: 300px;</span><br><span class="line">    object-fit: cover;</span><br><span class="line">    border-radius: var(--border-radius);</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.image-preview:hover &#123;</span><br><span class="line">    transform: scale(1.02);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 语音消息 */</span><br><span class="line">.message.voice-message .message-content &#123;</span><br><span class="line">    padding: 10px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.voice-player &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    gap: 15px;</span><br><span class="line">    padding: 15px;</span><br><span class="line">    background: rgba(255, 255, 255, 0.05);</span><br><span class="line">    border-radius: 10px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.voice-play-btn &#123;</span><br><span class="line">    background: var(--primary-color);</span><br><span class="line">    color: white;</span><br><span class="line">    border: none;</span><br><span class="line">    width: 40px;</span><br><span class="line">    height: 40px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.voice-play-btn:hover &#123;</span><br><span class="line">    background: var(--secondary-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.voice-progress &#123;</span><br><span class="line">    flex: 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.voice-progress-bar &#123;</span><br><span class="line">    height: 4px;</span><br><span class="line">    background: rgba(255, 255, 255, 0.1);</span><br><span class="line">    border-radius: 2px;</span><br><span class="line">    overflow: hidden;</span><br><span class="line">    margin-bottom: 5px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.voice-progress-filled &#123;</span><br><span class="line">    height: 100%;</span><br><span class="line">    background: var(--primary-color);</span><br><span class="line">    width: 0%;</span><br><span class="line">    transition: width 0.1s linear;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.voice-duration &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    font-size: 0.85rem;</span><br><span class="line">    color: var(--gray-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 表情选择器 */</span><br><span class="line">.emoji-picker &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    bottom: 70px;</span><br><span class="line">    left: 20px;</span><br><span class="line">    width: 300px;</span><br><span class="line">    height: 350px;</span><br><span class="line">    background: white;</span><br><span class="line">    border-radius: var(--border-radius);</span><br><span class="line">    box-shadow: var(--box-shadow);</span><br><span class="line">    display: none;</span><br><span class="line">    flex-direction: column;</span><br><span class="line">    overflow: hidden;</span><br><span class="line">    z-index: 1000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body.dark-theme .emoji-picker &#123;</span><br><span class="line">    background: var(--light-color);</span><br><span class="line">    color: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.emoji-picker.show &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.emoji-categories &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    padding: 10px;</span><br><span class="line">    border-bottom: 1px solid #eaeaea;</span><br><span class="line">    background: #f8f9fa;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body.dark-theme .emoji-categories &#123;</span><br><span class="line">    background: #2a2d31;</span><br><span class="line">    border-color: #40444b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.emoji-category-btn &#123;</span><br><span class="line">    flex: 1;</span><br><span class="line">    background: none;</span><br><span class="line">    border: none;</span><br><span class="line">    padding: 8px;</span><br><span class="line">    border-radius: 5px;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    color: var(--gray-color);</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.emoji-category-btn:hover,</span><br><span class="line">.emoji-category-btn.active &#123;</span><br><span class="line">    background: var(--primary-color);</span><br><span class="line">    color: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.emoji-grid &#123;</span><br><span class="line">    flex: 1;</span><br><span class="line">    display: grid;</span><br><span class="line">    grid-template-columns: repeat(6, 1fr);</span><br><span class="line">    gap: 5px;</span><br><span class="line">    padding: 15px;</span><br><span class="line">    overflow-y: auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.emoji-item &#123;</span><br><span class="line">    font-size: 1.5rem;</span><br><span class="line">    text-align: center;</span><br><span class="line">    padding: 8px;</span><br><span class="line">    border-radius: 5px;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.emoji-item:hover &#123;</span><br><span class="line">    background: rgba(67, 97, 238, 0.1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body.dark-theme .emoji-item:hover &#123;</span><br><span class="line">    background: rgba(114, 137, 218, 0.2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.emoji-search &#123;</span><br><span class="line">    padding: 10px;</span><br><span class="line">    border-top: 1px solid #eaeaea;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body.dark-theme .emoji-search &#123;</span><br><span class="line">    border-color: #40444b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.emoji-search input &#123;</span><br><span class="line">    width: 100%;</span><br><span class="line">    padding: 8px 12px;</span><br><span class="line">    border: 1px solid #eaeaea;</span><br><span class="line">    border-radius: 5px;</span><br><span class="line">    font-size: 0.9rem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body.dark-theme .emoji-search input &#123;</span><br><span class="line">    background: #40444b;</span><br><span class="line">    border-color: #40444b;</span><br><span class="line">    color: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 上传区域 */</span><br><span class="line">.upload-area &#123;</span><br><span class="line">    border: 2px dashed var(--primary-color);</span><br><span class="line">    border-radius: var(--border-radius);</span><br><span class="line">    padding: 40px 20px;</span><br><span class="line">    text-align: center;</span><br><span class="line">    margin-bottom: 20px;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.upload-area.drag-over &#123;</span><br><span class="line">    background: rgba(67, 97, 238, 0.1);</span><br><span class="line">    border-color: var(--secondary-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.upload-icon &#123;</span><br><span class="line">    font-size: 3rem;</span><br><span class="line">    color: var(--primary-color);</span><br><span class="line">    margin-bottom: 15px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.upload-progress &#123;</span><br><span class="line">    margin-bottom: 20px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.progress-item &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    gap: 15px;</span><br><span class="line">    padding: 10px;</span><br><span class="line">    border-radius: 8px;</span><br><span class="line">    background: #f8f9fa;</span><br><span class="line">    margin-bottom: 10px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body.dark-theme .progress-item &#123;</span><br><span class="line">    background: #2a2d31;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.progress-icon &#123;</span><br><span class="line">    width: 40px;</span><br><span class="line">    height: 40px;</span><br><span class="line">    border-radius: 8px;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    color: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.progress-info &#123;</span><br><span class="line">    flex: 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.progress-name &#123;</span><br><span class="line">    font-weight: 500;</span><br><span class="line">    margin-bottom: 5px;</span><br><span class="line">    word-break: break-all;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.progress-bar &#123;</span><br><span class="line">    height: 6px;</span><br><span class="line">    background: rgba(0, 0, 0, 0.1);</span><br><span class="line">    border-radius: 3px;</span><br><span class="line">    overflow: hidden;</span><br><span class="line">    margin-bottom: 5px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.progress-filled &#123;</span><br><span class="line">    height: 100%;</span><br><span class="line">    background: var(--primary-color);</span><br><span class="line">    width: 0%;</span><br><span class="line">    transition: width 0.3s ease;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.progress-status &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    font-size: 0.85rem;</span><br><span class="line">    color: var(--gray-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 语音录制器 */</span><br><span class="line">.voice-recorder &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    bottom: 70px;</span><br><span class="line">    right: 20px;</span><br><span class="line">    width: 300px;</span><br><span class="line">    background: white;</span><br><span class="line">    border-radius: var(--border-radius);</span><br><span class="line">    box-shadow: var(--box-shadow);</span><br><span class="line">    display: none;</span><br><span class="line">    flex-direction: column;</span><br><span class="line">    overflow: hidden;</span><br><span class="line">    z-index: 1000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body.dark-theme .voice-recorder &#123;</span><br><span class="line">    background: var(--light-color);</span><br><span class="line">    color: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.voice-recorder.show &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.recorder-header &#123;</span><br><span class="line">    padding: 15px;</span><br><span class="line">    border-bottom: 1px solid #eaeaea;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    align-items: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body.dark-theme .recorder-header &#123;</span><br><span class="line">    border-color: #40444b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.close-recorder &#123;</span><br><span class="line">    background: none;</span><br><span class="line">    border: none;</span><br><span class="line">    color: var(--gray-color);</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    font-size: 1.2rem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.recorder-body &#123;</span><br><span class="line">    padding: 20px;</span><br><span class="line">    text-align: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.recorder-visualizer &#123;</span><br><span class="line">    height: 80px;</span><br><span class="line">    margin-bottom: 20px;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.recorder-timer &#123;</span><br><span class="line">    font-size: 2rem;</span><br><span class="line">    font-weight: bold;</span><br><span class="line">    margin-bottom: 30px;</span><br><span class="line">    color: var(--primary-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.recorder-controls &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    gap: 20px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.recorder-btn &#123;</span><br><span class="line">    width: 60px;</span><br><span class="line">    height: 60px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    border: none;</span><br><span class="line">    color: white;</span><br><span class="line">    font-size: 1.2rem;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.record-btn &#123;</span><br><span class="line">    background: var(--danger-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.record-btn:hover &#123;</span><br><span class="line">    background: #d8355f;</span><br><span class="line">    transform: scale(1.1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.record-btn.recording &#123;</span><br><span class="line">    animation: pulse 1.5s infinite;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.stop-btn &#123;</span><br><span class="line">    background: var(--warning-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.stop-btn:hover &#123;</span><br><span class="line">    background: #e6b83c;</span><br><span class="line">    transform: scale(1.1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.play-btn &#123;</span><br><span class="line">    background: var(--success-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.play-btn:hover &#123;</span><br><span class="line">    background: #05c18f;</span><br><span class="line">    transform: scale(1.1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.send-btn &#123;</span><br><span class="line">    background: var(--primary-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.send-btn:hover &#123;</span><br><span class="line">    background: var(--secondary-color);</span><br><span class="line">    transform: scale(1.1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.recorder-btn:disabled &#123;</span><br><span class="line">    background: var(--gray-color);</span><br><span class="line">    cursor: not-allowed;</span><br><span class="line">    transform: none !important;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 消息回复 */</span><br><span class="line">.message-reply &#123;</span><br><span class="line">    background: rgba(67, 97, 238, 0.1);</span><br><span class="line">    border-left: 3px solid var(--primary-color);</span><br><span class="line">    padding: 10px;</span><br><span class="line">    border-radius: 5px;</span><br><span class="line">    margin-bottom: 10px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.reply-header &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    align-items: center;</span><br><span class="line">    margin-bottom: 5px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.reply-sender &#123;</span><br><span class="line">    font-weight: 500;</span><br><span class="line">    color: var(--primary-color);</span><br><span class="line">    font-size: 0.9rem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.reply-content &#123;</span><br><span class="line">    font-size: 0.9rem;</span><br><span class="line">    color: var(--gray-color);</span><br><span class="line">    overflow: hidden;</span><br><span class="line">    text-overflow: ellipsis;</span><br><span class="line">    white-space: nowrap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 消息上下文菜单 */</span><br><span class="line">.context-menu &#123;</span><br><span class="line">    position: fixed;</span><br><span class="line">    background: white;</span><br><span class="line">    border-radius: 8px;</span><br><span class="line">    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);</span><br><span class="line">    padding: 8px 0;</span><br><span class="line">    min-width: 180px;</span><br><span class="line">    z-index: 10000;</span><br><span class="line">    display: none;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body.dark-theme .context-menu &#123;</span><br><span class="line">    background: var(--light-color);</span><br><span class="line">    color: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.context-menu ul &#123;</span><br><span class="line">    list-style: none;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.context-menu li &#123;</span><br><span class="line">    padding: 10px 20px;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    gap: 10px;</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.context-menu li:hover &#123;</span><br><span class="line">    background: rgba(67, 97, 238, 0.1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body.dark-theme .context-menu li:hover &#123;</span><br><span class="line">    background: rgba(114, 137, 218, 0.2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.context-menu .separator &#123;</span><br><span class="line">    height: 1px;</span><br><span class="line">    background: #eaeaea;</span><br><span class="line">    margin: 8px 0;</span><br><span class="line">    padding: 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body.dark-theme .context-menu .separator &#123;</span><br><span class="line">    background: #40444b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 消息已读状态 */</span><br><span class="line">.message-read-status &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    gap: 5px;</span><br><span class="line">    margin-top: 8px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.read-avatar &#123;</span><br><span class="line">    width: 20px;</span><br><span class="line">    height: 20px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    font-size: 0.7rem;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    color: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 加载更多消息 */</span><br><span class="line">.load-more-container &#123;</span><br><span class="line">    text-align: center;</span><br><span class="line">    margin: 20px 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.load-more-btn &#123;</span><br><span class="line">    background: none;</span><br><span class="line">    border: 1px solid var(--primary-color);</span><br><span class="line">    color: var(--primary-color);</span><br><span class="line">    padding: 10px 20px;</span><br><span class="line">    border-radius: 20px;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    font-size: 0.9rem;</span><br><span class="line">    transition: var(--transition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.load-more-btn:hover &#123;</span><br><span class="line">    background: var(--primary-color);</span><br><span class="line">    color: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.loading-spinner &#123;</span><br><span class="line">    display: inline-block;</span><br><span class="line">    width: 20px;</span><br><span class="line">    height: 20px;</span><br><span class="line">    border: 2px solid rgba(67, 97, 238, 0.3);</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    border-top-color: var(--primary-color);</span><br><span class="line">    animation: spin 1s ease-in-out infinite;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@keyframes spin &#123;</span><br><span class="line">    to &#123; transform: rotate(360deg); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 响应式优化 */</span><br><span class="line">@media (max-width: 768px) &#123;</span><br><span class="line">    .emoji-picker,</span><br><span class="line">    .voice-recorder &#123;</span><br><span class="line">        width: calc(100% - 40px);</span><br><span class="line">        left: 20px;</span><br><span class="line">        right: 20px;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    .file-preview &#123;</span><br><span class="line">        flex-direction: column;</span><br><span class="line">        text-align: center;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    .message &#123;</span><br><span class="line">        max-width: 85% !important;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 动画效果 */</span><br><span class="line">@keyframes slideIn &#123;</span><br><span class="line">    from &#123;</span><br><span class="line">        opacity: 0;</span><br><span class="line">        transform: translateY(20px);</span><br><span class="line">    &#125;</span><br><span class="line">    to &#123;</span><br><span class="line">        opacity: 1;</span><br><span class="line">        transform: translateY(0);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.message &#123;</span><br><span class="line">    animation: slideIn 0.3s ease;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 通知提醒 */</span><br><span class="line">.notification-badge &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    top: -5px;</span><br><span class="line">    right: -5px;</span><br><span class="line">    background: var(--danger-color);</span><br><span class="line">    color: white;</span><br><span class="line">    width: 20px;</span><br><span class="line">    height: 20px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    font-size: 0.7rem;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    animation: bounce 2s infinite;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@keyframes bounce &#123;</span><br><span class="line">    0%, 100% &#123; transform: scale(1); &#125;</span><br><span class="line">    50% &#123; transform: scale(1.1); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 消息搜索 */</span><br><span class="line">.search-highlight &#123;</span><br><span class="line">    background: yellow;</span><br><span class="line">    color: black;</span><br><span class="line">    padding: 0 2px;</span><br><span class="line">    border-radius: 2px;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-3-增强的JavaScript功能"><a href="#7-3-增强的JavaScript功能" class="headerlink" title="7.3 增强的JavaScript功能"></a>7.3 增强的JavaScript功能</h3><p>javascript</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br></pre></td><td class="code"><pre><span class="line">// 在原有ChatRoom类基础上扩展</span><br><span class="line"></span><br><span class="line">class EnhancedChatRoom extends ChatRoom &#123;</span><br><span class="line">    constructor() &#123;</span><br><span class="line">        super();</span><br><span class="line">        this.currentUser = null;</span><br><span class="line">        this.token = null;</span><br><span class="line">        this.messageHistory = [];</span><br><span class="line">        this.isTyping = false;</span><br><span class="line">        this.lastTypingTime = 0;</span><br><span class="line">        this.uploadQueue = [];</span><br><span class="line">        this.uploading = false;</span><br><span class="line">        </span><br><span class="line">        this.initEnhancedFeatures();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    initEnhancedFeatures() &#123;</span><br><span class="line">        this.cacheEnhancedElements();</span><br><span class="line">        this.bindEnhancedEvents();</span><br><span class="line">        this.initEmojiPicker();</span><br><span class="line">        this.initVoiceRecorder();</span><br><span class="line">        this.checkAuthStatus();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    cacheEnhancedElements() &#123;</span><br><span class="line">        // 表情选择器</span><br><span class="line">        this.emojiPicker = document.getElementById(&#x27;emojiPicker&#x27;);</span><br><span class="line">        this.emojiGrid = document.getElementById(&#x27;emojiGrid&#x27;);</span><br><span class="line">        this.emojiSearch = document.getElementById(&#x27;emojiSearch&#x27;);</span><br><span class="line">        this.emojiCategoryBtns = document.querySelectorAll(&#x27;.emoji-category-btn&#x27;);</span><br><span class="line">        </span><br><span class="line">        // 文件上传</span><br><span class="line">        this.fileUploadModal = document.getElementById(&#x27;fileUploadModal&#x27;);</span><br><span class="line">        this.uploadArea = document.getElementById(&#x27;uploadArea&#x27;);</span><br><span class="line">        this.fileInput = document.getElementById(&#x27;fileInput&#x27;);</span><br><span class="line">        this.selectFileBtn = document.getElementById(&#x27;selectFileBtn&#x27;);</span><br><span class="line">        this.sendFilesBtn = document.getElementById(&#x27;sendFilesBtn&#x27;);</span><br><span class="line">        this.uploadProgress = document.getElementById(&#x27;uploadProgress&#x27;);</span><br><span class="line">        this.uploadPreview = document.getElementById(&#x27;uploadPreview&#x27;);</span><br><span class="line">        </span><br><span class="line">        // 语音录制</span><br><span class="line">        this.voiceRecorder = document.getElementById(&#x27;voiceRecorder&#x27;);</span><br><span class="line">        this.startRecordBtn = document.getElementById(&#x27;startRecordBtn&#x27;);</span><br><span class="line">        this.stopRecordBtn = document.getElementById(&#x27;stopRecordBtn&#x27;);</span><br><span class="line">        this.playRecordBtn = document.getElementById(&#x27;playRecordBtn&#x27;);</span><br><span class="line">        this.sendRecordBtn = document.getElementById(&#x27;sendRecordBtn&#x27;);</span><br><span class="line">        this.recordingTime = document.getElementById(&#x27;recordingTime&#x27;);</span><br><span class="line">        this.visualizer = document.getElementById(&#x27;visualizer&#x27;);</span><br><span class="line">        </span><br><span class="line">        // 用户设置</span><br><span class="line">        this.userSettingsModal = document.getElementById(&#x27;userSettingsModal&#x27;);</span><br><span class="line">        this.avatarPreview = document.getElementById(&#x27;avatarPreview&#x27;);</span><br><span class="line">        this.avatarUpload = document.getElementById(&#x27;avatarUpload&#x27;);</span><br><span class="line">        this.changeAvatarBtn = document.getElementById(&#x27;changeAvatarBtn&#x27;);</span><br><span class="line">        this.editNickname = document.getElementById(&#x27;editNickname&#x27;);</span><br><span class="line">        this.editBio = document.getElementById(&#x27;editBio&#x27;);</span><br><span class="line">        this.saveSettingsBtn = document.getElementById(&#x27;saveSettingsBtn&#x27;);</span><br><span class="line">        </span><br><span class="line">        // 上下文菜单</span><br><span class="line">        this.contextMenu = document.getElementById(&#x27;messageContextMenu&#x27;);</span><br><span class="line">        </span><br><span class="line">        // 音频API</span><br><span class="line">        this.audioContext = null;</span><br><span class="line">        this.analyser = null;</span><br><span class="line">        this.recorder = null;</span><br><span class="line">        this.audioChunks = [];</span><br><span class="line">        this.isRecording = false;</span><br><span class="line">        this.isPlaying = false;</span><br><span class="line">        this.recordingTimer = null;</span><br><span class="line">        this.recordingStartTime = null;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    bindEnhancedEvents() &#123;</span><br><span class="line">        // 表情选择器</span><br><span class="line">        document.querySelectorAll(&#x27;.input-action-btn&#x27;).forEach(btn =&gt; &#123;</span><br><span class="line">            if (btn.querySelector(&#x27;.fa-smile&#x27;)) &#123;</span><br><span class="line">                btn.addEventListener(&#x27;click&#x27;, () =&gt; this.toggleEmojiPicker());</span><br><span class="line">            &#125;</span><br><span class="line">            if (btn.querySelector(&#x27;.fa-paperclip&#x27;)) &#123;</span><br><span class="line">                btn.addEventListener(&#x27;click&#x27;, () =&gt; this.showFileUploadModal());</span><br><span class="line">            &#125;</span><br><span class="line">            if (btn.querySelector(&#x27;.fa-microphone&#x27;)) &#123;</span><br><span class="line">                btn.addEventListener(&#x27;click&#x27;, () =&gt; this.toggleVoiceRecorder());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        // 表情分类切换</span><br><span class="line">        this.emojiCategoryBtns.forEach(btn =&gt; &#123;</span><br><span class="line">            btn.addEventListener(&#x27;click&#x27;, () =&gt; this.switchEmojiCategory(btn));</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        // 表情搜索</span><br><span class="line">        this.emojiSearch.addEventListener(&#x27;input&#x27;, (e) =&gt; this.searchEmojis(e.target.value));</span><br><span class="line">        </span><br><span class="line">        // 文件上传</span><br><span class="line">        this.selectFileBtn.addEventListener(&#x27;click&#x27;, () =&gt; this.fileInput.click());</span><br><span class="line">        this.fileInput.addEventListener(&#x27;change&#x27;, (e) =&gt; this.handleFileSelection(e));</span><br><span class="line">        </span><br><span class="line">        // 拖放上传</span><br><span class="line">        this.uploadArea.addEventListener(&#x27;dragover&#x27;, (e) =&gt; &#123;</span><br><span class="line">            e.preventDefault();</span><br><span class="line">            this.uploadArea.classList.add(&#x27;drag-over&#x27;);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        this.uploadArea.addEventListener(&#x27;dragleave&#x27;, () =&gt; &#123;</span><br><span class="line">            this.uploadArea.classList.remove(&#x27;drag-over&#x27;);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        this.uploadArea.addEventListener(&#x27;drop&#x27;, (e) =&gt; &#123;</span><br><span class="line">            e.preventDefault();</span><br><span class="line">            this.uploadArea.classList.remove(&#x27;drag-over&#x27;);</span><br><span class="line">            this.handleFileDrop(e.dataTransfer.files);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        // 语音录制</span><br><span class="line">        this.startRecordBtn.addEventListener(&#x27;click&#x27;, () =&gt; this.startRecording());</span><br><span class="line">        this.stopRecordBtn.addEventListener(&#x27;click&#x27;, () =&gt; this.stopRecording());</span><br><span class="line">        this.playRecordBtn.addEventListener(&#x27;click&#x27;, () =&gt; this.playRecording());</span><br><span class="line">        this.sendRecordBtn.addEventListener(&#x27;click&#x27;, () =&gt; this.sendVoiceMessage());</span><br><span class="line">        </span><br><span class="line">        // 用户设置</span><br><span class="line">        this.changeAvatarBtn.addEventListener(&#x27;click&#x27;, () =&gt; this.avatarUpload.click());</span><br><span class="line">        this.avatarUpload.addEventListener(&#x27;change&#x27;, (e) =&gt; this.handleAvatarUpload(e));</span><br><span class="line">        this.saveSettingsBtn.addEventListener(&#x27;click&#x27;, () =&gt; this.saveUserSettings());</span><br><span class="line">        </span><br><span class="line">        // 消息上下文菜单</span><br><span class="line">        document.addEventListener(&#x27;contextmenu&#x27;, (e) =&gt; this.handleContextMenu(e));</span><br><span class="line">        document.addEventListener(&#x27;click&#x27;, () =&gt; this.hideContextMenu());</span><br><span class="line">        </span><br><span class="line">        // 点击表情选择器外部关闭</span><br><span class="line">        document.addEventListener(&#x27;click&#x27;, (e) =&gt; &#123;</span><br><span class="line">            if (!e.target.closest(&#x27;.emoji-picker&#x27;) &amp;&amp; </span><br><span class="line">                !e.target.closest(&#x27;.fa-smile&#x27;)) &#123;</span><br><span class="line">                this.hideEmojiPicker();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        // 页面可见性变化（用户切换标签页）</span><br><span class="line">        document.addEventListener(&#x27;visibilitychange&#x27;, () =&gt; &#123;</span><br><span class="line">            if (document.hidden) &#123;</span><br><span class="line">                this.setUserStatus(&#x27;AWAY&#x27;);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                this.setUserStatus(&#x27;ONLINE&#x27;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 认证检查</span><br><span class="line">    async checkAuthStatus() &#123;</span><br><span class="line">        const token = localStorage.getItem(&#x27;chat_token&#x27;);</span><br><span class="line">        const userData = localStorage.getItem(&#x27;chat_user&#x27;);</span><br><span class="line">        </span><br><span class="line">        if (token &amp;&amp; userData) &#123;</span><br><span class="line">            this.token = token;</span><br><span class="line">            this.currentUser = JSON.parse(userData);</span><br><span class="line">            </span><br><span class="line">            // 验证token有效性</span><br><span class="line">            try &#123;</span><br><span class="line">                const response = await fetch(&#x27;/api/auth/validate&#x27;, &#123;</span><br><span class="line">                    headers: &#123;</span><br><span class="line">                        &#x27;Authorization&#x27;: `Bearer $&#123;token&#125;`</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                </span><br><span class="line">                if (response.ok) &#123;</span><br><span class="line">                    this.username = this.currentUser.username;</span><br><span class="line">                    this.usernameDisplay.textContent = this.currentUser.nickname;</span><br><span class="line">                    this.updateUserAvatar();</span><br><span class="line">                    this.connect();</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    this.showLoginModal();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (error) &#123;</span><br><span class="line">                console.error(&#x27;Token验证失败:&#x27;, error);</span><br><span class="line">                this.showLoginModal();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            this.showLoginModal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    showLoginModal() &#123;</span><br><span class="line">        const modal = document.createElement(&#x27;div&#x27;);</span><br><span class="line">        modal.className = &#x27;modal-overlay show&#x27;;</span><br><span class="line">        modal.innerHTML = `</span><br><span class="line">            &lt;div class=&quot;modal&quot;&gt;</span><br><span class="line">                &lt;div class=&quot;modal-header&quot;&gt;</span><br><span class="line">                    &lt;h3&gt;&lt;i class=&quot;fas fa-sign-in-alt&quot;&gt;&lt;/i&gt; 登录&lt;/h3&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;modal-body&quot;&gt;</span><br><span class="line">                    &lt;div class=&quot;form-group&quot;&gt;</span><br><span class="line">                        &lt;label&gt;用户名或邮箱&lt;/label&gt;</span><br><span class="line">                        &lt;input type=&quot;text&quot; id=&quot;loginUsername&quot; placeholder=&quot;请输入用户名或邮箱&quot;&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                    &lt;div class=&quot;form-group&quot;&gt;</span><br><span class="line">                        &lt;label&gt;密码&lt;/label&gt;</span><br><span class="line">                        &lt;input type=&quot;password&quot; id=&quot;loginPassword&quot; placeholder=&quot;请输入密码&quot;&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                    &lt;div class=&quot;form-options&quot;&gt;</span><br><span class="line">                        &lt;label&gt;</span><br><span class="line">                            &lt;input type=&quot;checkbox&quot; id=&quot;rememberMe&quot;&gt;</span><br><span class="line">                            &lt;span&gt;记住我&lt;/span&gt;</span><br><span class="line">                        &lt;/label&gt;</span><br><span class="line">                        &lt;a href=&quot;#&quot; class=&quot;forgot-password&quot;&gt;忘记密码?&lt;/a&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                    &lt;div class=&quot;error-message&quot; id=&quot;loginError&quot;&gt;&lt;/div&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;modal-footer&quot;&gt;</span><br><span class="line">                    &lt;button id=&quot;loginBtn&quot; class=&quot;btn-primary&quot;&gt;登录&lt;/button&gt;</span><br><span class="line">                    &lt;button id=&quot;registerBtn&quot; class=&quot;btn-secondary&quot;&gt;注册&lt;/button&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        `;</span><br><span class="line">        </span><br><span class="line">        document.body.appendChild(modal);</span><br><span class="line">        </span><br><span class="line">        // 绑定登录事件</span><br><span class="line">        modal.querySelector(&#x27;#loginBtn&#x27;).addEventListener(&#x27;click&#x27;, () =&gt; this.handleLogin(modal));</span><br><span class="line">        modal.querySelector(&#x27;#registerBtn&#x27;).addEventListener(&#x27;click&#x27;, () =&gt; this.showRegisterModal(modal));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    async handleLogin(modal) &#123;</span><br><span class="line">        const username = modal.querySelector(&#x27;#loginUsername&#x27;).value;</span><br><span class="line">        const password = modal.querySelector(&#x27;#loginPassword&#x27;).value;</span><br><span class="line">        </span><br><span class="line">        if (!username || !password) &#123;</span><br><span class="line">            this.showError(&#x27;请输入用户名和密码&#x27;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            const response = await fetch(&#x27;/api/auth/login&#x27;, &#123;</span><br><span class="line">                method: &#x27;POST&#x27;,</span><br><span class="line">                headers: &#123;</span><br><span class="line">                    &#x27;Content-Type&#x27;: &#x27;application/json&#x27;</span><br><span class="line">                &#125;,</span><br><span class="line">                body: JSON.stringify(&#123;</span><br><span class="line">                    usernameOrEmail: username,</span><br><span class="line">                    password: password</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            const data = await response.json();</span><br><span class="line">            </span><br><span class="line">            if (response.ok) &#123;</span><br><span class="line">                this.token = data.accessToken;</span><br><span class="line">                this.currentUser = &#123;</span><br><span class="line">                    id: data.userId,</span><br><span class="line">                    username: data.username,</span><br><span class="line">                    nickname: data.nickname,</span><br><span class="line">                    email: data.email,</span><br><span class="line">                    role: data.role</span><br><span class="line">                &#125;;</span><br><span class="line">                </span><br><span class="line">                // 保存到本地存储</span><br><span class="line">                localStorage.setItem(&#x27;chat_token&#x27;, this.token);</span><br><span class="line">                localStorage.setItem(&#x27;chat_user&#x27;, JSON.stringify(this.currentUser));</span><br><span class="line">                </span><br><span class="line">                // 更新UI</span><br><span class="line">                this.username = data.username;</span><br><span class="line">                this.usernameDisplay.textContent = data.nickname;</span><br><span class="line">                this.updateUserAvatar();</span><br><span class="line">                </span><br><span class="line">                // 移除模态框</span><br><span class="line">                modal.remove();</span><br><span class="line">                </span><br><span class="line">                // 连接到聊天室</span><br><span class="line">                this.connect();</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                this.showError(data.message || &#x27;登录失败&#x27;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (error) &#123;</span><br><span class="line">            console.error(&#x27;登录错误:&#x27;, error);</span><br><span class="line">            this.showError(&#x27;网络错误，请稍后重试&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 表情选择器</span><br><span class="line">    initEmojiPicker() &#123;</span><br><span class="line">        const emojiCategories = &#123;</span><br><span class="line">            smileys: [&#x27;😀&#x27;, &#x27;😃&#x27;, &#x27;😄&#x27;, &#x27;😁&#x27;, &#x27;😆&#x27;, &#x27;😅&#x27;, &#x27;😂&#x27;, &#x27;🤣&#x27;, &#x27;😊&#x27;, &#x27;😇&#x27;, &#x27;🙂&#x27;, &#x27;🙃&#x27;, &#x27;😉&#x27;, &#x27;😌&#x27;, &#x27;😍&#x27;, &#x27;🥰&#x27;, &#x27;😘&#x27;, &#x27;😗&#x27;, &#x27;😙&#x27;, &#x27;😚&#x27;, &#x27;😋&#x27;, &#x27;😛&#x27;, &#x27;😝&#x27;, &#x27;😜&#x27;, &#x27;🤪&#x27;, &#x27;🤨&#x27;, &#x27;🧐&#x27;, &#x27;🤓&#x27;, &#x27;😎&#x27;, &#x27;🤩&#x27;, &#x27;🥳&#x27;, &#x27;😏&#x27;, &#x27;😒&#x27;, &#x27;😞&#x27;, &#x27;😔&#x27;, &#x27;😟&#x27;, &#x27;😕&#x27;, &#x27;🙁&#x27;, &#x27;😣&#x27;, &#x27;😖&#x27;, &#x27;😫&#x27;, &#x27;😩&#x27;, &#x27;🥺&#x27;, &#x27;😢&#x27;, &#x27;😭&#x27;, &#x27;😤&#x27;, &#x27;😠&#x27;, &#x27;😡&#x27;, &#x27;🤬&#x27;, &#x27;🤯&#x27;, &#x27;😳&#x27;, &#x27;🥵&#x27;, &#x27;🥶&#x27;, &#x27;😱&#x27;, &#x27;😨&#x27;, &#x27;😰&#x27;, &#x27;😥&#x27;, &#x27;😓&#x27;, &#x27;🤗&#x27;, &#x27;🤔&#x27;, &#x27;🤭&#x27;, &#x27;🤫&#x27;, &#x27;🤥&#x27;, &#x27;😶&#x27;, &#x27;😐&#x27;, &#x27;😑&#x27;, &#x27;😬&#x27;, &#x27;🙄&#x27;, &#x27;😯&#x27;, &#x27;😦&#x27;, &#x27;😧&#x27;, &#x27;😮&#x27;, &#x27;😲&#x27;, &#x27;🥱&#x27;, &#x27;😴&#x27;, &#x27;🤤&#x27;, &#x27;😪&#x27;, &#x27;😵&#x27;, &#x27;🤐&#x27;, &#x27;🥴&#x27;, &#x27;🤢&#x27;, &#x27;🤮&#x27;, &#x27;🤧&#x27;, &#x27;😷&#x27;, &#x27;🤒&#x27;, &#x27;🤕&#x27;, &#x27;🤑&#x27;, &#x27;🤠&#x27;],</span><br><span class="line">            animals: [&#x27;🐶&#x27;, &#x27;🐱&#x27;, &#x27;🐭&#x27;, &#x27;🐹&#x27;, &#x27;🐰&#x27;, &#x27;🦊&#x27;, &#x27;🐻&#x27;, &#x27;🐼&#x27;, &#x27;🐨&#x27;, &#x27;🐯&#x27;, &#x27;🦁&#x27;, &#x27;🐮&#x27;, &#x27;🐷&#x27;, &#x27;🐽&#x27;, &#x27;🐸&#x27;, &#x27;🐵&#x27;, &#x27;🙈&#x27;, &#x27;🙉&#x27;, &#x27;🙊&#x27;, &#x27;🐒&#x27;, &#x27;🐔&#x27;, &#x27;🐧&#x27;, &#x27;🐦&#x27;, &#x27;🐤&#x27;, &#x27;🐣&#x27;, &#x27;🐥&#x27;, &#x27;🦆&#x27;, &#x27;🦅&#x27;, &#x27;🦉&#x27;, &#x27;🦇&#x27;, &#x27;🐺&#x27;, &#x27;🐗&#x27;, &#x27;🐴&#x27;, &#x27;🦄&#x27;, &#x27;🐝&#x27;, &#x27;🐛&#x27;, &#x27;🦋&#x27;, &#x27;🐌&#x27;, &#x27;🐞&#x27;, &#x27;🐜&#x27;, &#x27;🦟&#x27;, &#x27;🦗&#x27;, &#x27;🕷&#x27;, &#x27;🦂&#x27;, &#x27;🐢&#x27;, &#x27;🐍&#x27;, &#x27;🦎&#x27;, &#x27;🦖&#x27;, &#x27;🦕&#x27;, &#x27;🐙&#x27;, &#x27;🦑&#x27;, &#x27;🦐&#x27;, &#x27;🦞&#x27;, &#x27;🦀&#x27;, &#x27;🐡&#x27;, &#x27;🐠&#x27;, &#x27;🐟&#x27;, &#x27;🐬&#x27;, &#x27;🐳&#x27;, &#x27;🐋&#x27;, &#x27;🦈&#x27;, &#x27;🐊&#x27;, &#x27;🐅&#x27;, &#x27;🐆&#x27;, &#x27;🦓&#x27;, &#x27;🦍&#x27;, &#x27;🦧&#x27;, &#x27;🐘&#x27;, &#x27;🦛&#x27;, &#x27;🦏&#x27;, &#x27;🐪&#x27;, &#x27;🐫&#x27;, &#x27;🦒&#x27;, &#x27;🦘&#x27;, &#x27;🐃&#x27;, &#x27;🐂&#x27;, &#x27;🐄&#x27;, &#x27;🐎&#x27;, &#x27;🐖&#x27;, &#x27;🐏&#x27;, &#x27;🐑&#x27;, &#x27;🦙&#x27;, &#x27;🐐&#x27;, &#x27;🦌&#x27;, &#x27;🐕&#x27;, &#x27;🐩&#x27;, &#x27;🦮&#x27;, &#x27;🐕‍🦺&#x27;, &#x27;🐈&#x27;, &#x27;🐓&#x27;, &#x27;🦃&#x27;, &#x27;🦚&#x27;, &#x27;🦜&#x27;, &#x27;🦢&#x27;, &#x27;🦩&#x27;, &#x27;🐇&#x27;, &#x27;🦝&#x27;, &#x27;🦨&#x27;, &#x27;🦡&#x27;, &#x27;🦦&#x27;, &#x27;🦥&#x27;, &#x27;🐁&#x27;, &#x27;🐀&#x27;, &#x27;🐿&#x27;, &#x27;🦔&#x27;],</span><br><span class="line">            food: [&#x27;🍏&#x27;, &#x27;🍎&#x27;, &#x27;🍐&#x27;, &#x27;🍊&#x27;, &#x27;🍋&#x27;, &#x27;🍌&#x27;, &#x27;🍉&#x27;, &#x27;🍇&#x27;, &#x27;🍓&#x27;, &#x27;🫐&#x27;, &#x27;🍈&#x27;, &#x27;🍒&#x27;, &#x27;🍑&#x27;, &#x27;🥭&#x27;, &#x27;🍍&#x27;, &#x27;🥥&#x27;, &#x27;🥝&#x27;, &#x27;🍅&#x27;, &#x27;🍆&#x27;, &#x27;🥑&#x27;, &#x27;🥦&#x27;, &#x27;🥬&#x27;, &#x27;🥒&#x27;, &#x27;🌶&#x27;, &#x27;🫑&#x27;, &#x27;🌽&#x27;, &#x27;🥕&#x27;, &#x27;🫒&#x27;, &#x27;🧄&#x27;, &#x27;🧅&#x27;, &#x27;🥔&#x27;, &#x27;🍠&#x27;, &#x27;🥐&#x27;, &#x27;🥯&#x27;, &#x27;🍞&#x27;, &#x27;🥖&#x27;, &#x27;🥨&#x27;, &#x27;🧀&#x27;, &#x27;🥚&#x27;, &#x27;🍳&#x27;, &#x27;🧈&#x27;, &#x27;🥞&#x27;, &#x27;🧇&#x27;, &#x27;🥓&#x27;, &#x27;🥩&#x27;, &#x27;🍗&#x27;, &#x27;🍖&#x27;, &#x27;🦴&#x27;, &#x27;🌭&#x27;, &#x27;🍔&#x27;, &#x27;🍟&#x27;, &#x27;🍕&#x27;, &#x27;🫓&#x27;, &#x27;🥪&#x27;, &#x27;🥙&#x27;, &#x27;🧆&#x27;, &#x27;🌮&#x27;, &#x27;🌯&#x27;, &#x27;🫔&#x27;, &#x27;🥗&#x27;, &#x27;🥘&#x27;, &#x27;🫕&#x27;, &#x27;🥫&#x27;, &#x27;🍝&#x27;, &#x27;🍜&#x27;, &#x27;🍲&#x27;, &#x27;🍛&#x27;, &#x27;🍣&#x27;, &#x27;🍱&#x27;, &#x27;🥟&#x27;, &#x27;🦪&#x27;, &#x27;🍤&#x27;, &#x27;🍙&#x27;, &#x27;🍚&#x27;, &#x27;🍘&#x27;, &#x27;🍥&#x27;, &#x27;🥠&#x27;, &#x27;🥮&#x27;, &#x27;🍢&#x27;, &#x27;🍡&#x27;, &#x27;🍧&#x27;, &#x27;🍨&#x27;, &#x27;🍦&#x27;, &#x27;🥧&#x27;, &#x27;🧁&#x27;, &#x27;🍰&#x27;, &#x27;🎂&#x27;, &#x27;🍮&#x27;, &#x27;🍭&#x27;, &#x27;🍬&#x27;, &#x27;🍫&#x27;, &#x27;🍿&#x27;, &#x27;🧈&#x27;, &#x27;🍩&#x27;, &#x27;🍪&#x27;, &#x27;🌰&#x27;, &#x27;🥜&#x27;, &#x27;🍯&#x27;],</span><br><span class="line">            travel: [&#x27;🚗&#x27;, &#x27;🚕&#x27;, &#x27;🚙&#x27;, &#x27;🚌&#x27;, &#x27;🚎&#x27;, &#x27;🏎&#x27;, &#x27;🚓&#x27;, &#x27;🚑&#x27;, &#x27;🚒&#x27;, &#x27;🚐&#x27;, &#x27;🛻&#x27;, &#x27;🚚&#x27;, &#x27;🚛&#x27;, &#x27;🚜&#x27;, &#x27;🦯&#x27;, &#x27;🦽&#x27;, &#x27;🦼&#x27;, &#x27;🛴&#x27;, &#x27;🚲&#x27;, &#x27;🛵&#x27;, &#x27;🏍&#x27;, &#x27;🛺&#x27;, &#x27;🚨&#x27;, &#x27;🚔&#x27;, &#x27;🚍&#x27;, &#x27;🚘&#x27;, &#x27;🚖&#x27;, &#x27;🚡&#x27;, &#x27;🚠&#x27;, &#x27;🚟&#x27;, &#x27;🚃&#x27;, &#x27;🚋&#x27;, &#x27;🚞&#x27;, &#x27;🚝&#x27;, &#x27;🚄&#x27;, &#x27;🚅&#x27;, &#x27;🚈&#x27;, &#x27;🚂&#x27;, &#x27;🚆&#x27;, &#x27;🚇&#x27;, &#x27;🚊&#x27;, &#x27;🚉&#x27;, &#x27;✈️&#x27;, &#x27;🛫&#x27;, &#x27;🛬&#x27;, &#x27;🛩&#x27;, &#x27;💺&#x27;, &#x27;🛰&#x27;, &#x27;🚀&#x27;, &#x27;🛸&#x27;, &#x27;🚁&#x27;, &#x27;🛶&#x27;, &#x27;⛵️&#x27;, &#x27;🚤&#x27;, &#x27;🛥&#x27;, &#x27;🛳&#x27;, &#x27;⛴&#x27;, &#x27;🚢&#x27;, &#x27;⚓️&#x27;, &#x27;⛽️&#x27;, &#x27;🚧&#x27;, &#x27;🚦&#x27;, &#x27;🚥&#x27;, &#x27;🚏&#x27;, &#x27;🗺&#x27;, &#x27;🗿&#x27;, &#x27;🗽&#x27;, &#x27;🗼&#x27;, &#x27;🏰&#x27;, &#x27;🏯&#x27;, &#x27;🏟&#x27;, &#x27;🎡&#x27;, &#x27;🎢&#x27;, &#x27;🎠&#x27;, &#x27;⛲️&#x27;, &#x27;⛱&#x27;, &#x27;🏖&#x27;, &#x27;🏝&#x27;, &#x27;🏜&#x27;, &#x27;🌋&#x27;, &#x27;⛰&#x27;, &#x27;🏔&#x27;, &#x27;🗻&#x27;, &#x27;🏕&#x27;, &#x27;⛺️&#x27;, &#x27;🛖&#x27;, &#x27;🏠&#x27;, &#x27;🏡&#x27;, &#x27;🏘&#x27;, &#x27;🏚&#x27;, &#x27;🏗&#x27;, &#x27;🏭&#x27;, &#x27;🏢&#x27;, &#x27;🏬&#x27;, &#x27;🏣&#x27;, &#x27;🏤&#x27;, &#x27;🏥&#x27;, &#x27;🏦&#x27;, &#x27;🏨&#x27;, &#x27;🏪&#x27;, &#x27;🏫&#x27;, &#x27;🏩&#x27;, &#x27;💒&#x27;, &#x27;🏛&#x27;, &#x27;⛪️&#x27;, &#x27;🕌&#x27;, &#x27;🛕&#x27;, &#x27;🕍&#x27;, &#x27;⛩&#x27;, &#x27;🕋&#x27;, &#x27;⛺️&#x27;],</span><br><span class="line">            objects: [&#x27;⌚️&#x27;, &#x27;📱&#x27;, &#x27;📲&#x27;, &#x27;💻&#x27;, &#x27;⌨️&#x27;, &#x27;🖥&#x27;, &#x27;🖨&#x27;, &#x27;🖱&#x27;, &#x27;🖲&#x27;, &#x27;🕹&#x27;, &#x27;🗜&#x27;, &#x27;💽&#x27;, &#x27;💾&#x27;, &#x27;💿&#x27;, &#x27;📀&#x27;, &#x27;📼&#x27;, &#x27;📷&#x27;, &#x27;📸&#x27;, &#x27;📹&#x27;, &#x27;🎥&#x27;, &#x27;📽&#x27;, &#x27;🎞&#x27;, &#x27;📞&#x27;, &#x27;☎️&#x27;, &#x27;📟&#x27;, &#x27;📠&#x27;, &#x27;📺&#x27;, &#x27;📻&#x27;, &#x27;🎙&#x27;, &#x27;🎚&#x27;, &#x27;🎛&#x27;, &#x27;🧭&#x27;, &#x27;⏱&#x27;, &#x27;⏲&#x27;, &#x27;⏰&#x27;, &#x27;🕰&#x27;, &#x27;⌛️&#x27;, &#x27;⏳&#x27;, &#x27;📡&#x27;, &#x27;🔋&#x27;, &#x27;🔌&#x27;, &#x27;💡&#x27;, &#x27;🔦&#x27;, &#x27;🕯&#x27;, &#x27;🪔&#x27;, &#x27;🧯&#x27;, &#x27;🛢&#x27;, &#x27;💸&#x27;, &#x27;💵&#x27;, &#x27;💴&#x27;, &#x27;💶&#x27;, &#x27;💷&#x27;, &#x27;💰&#x27;, &#x27;💳&#x27;, &#x27;💎&#x27;, &#x27;⚖️&#x27;, &#x27;🧰&#x27;, &#x27;🔧&#x27;, &#x27;🔨&#x27;, &#x27;⚒&#x27;, &#x27;🛠&#x27;, &#x27;⛏&#x27;, &#x27;🔩&#x27;, &#x27;⚙️&#x27;, &#x27;🧱&#x27;, &#x27;⛓&#x27;, &#x27;🧲&#x27;, &#x27;🔫&#x27;, &#x27;💣&#x27;, &#x27;🧨&#x27;, &#x27;🪓&#x27;, &#x27;🔪&#x27;, &#x27;🗡&#x27;, &#x27;⚔️&#x27;, &#x27;🛡&#x27;, &#x27;🚬&#x27;, &#x27;⚰️&#x27;, &#x27;⚱️&#x27;, &#x27;🏺&#x27;, &#x27;🔮&#x27;, &#x27;📿&#x27;, &#x27;🧿&#x27;, &#x27;💈&#x27;, &#x27;⚗️&#x27;, &#x27;🔭&#x27;, &#x27;🔬&#x27;, &#x27;🕳&#x27;, &#x27;💊&#x27;, &#x27;💉&#x27;, &#x27;🩸&#x27;, &#x27;🧬&#x27;, &#x27;🦠&#x27;, &#x27;🧫&#x27;, &#x27;🧪&#x27;, &#x27;🌡&#x27;, &#x27;🧹&#x27;, &#x27;🧺&#x27;, &#x27;🧻&#x27;, &#x27;🚽&#x27;, &#x27;🚰&#x27;, &#x27;🚿&#x27;, &#x27;🛁&#x27;, &#x27;🛀&#x27;, &#x27;🧼&#x27;, &#x27;🪒&#x27;, &#x27;🧽&#x27;, &#x27;🧴&#x27;, &#x27;🛎&#x27;, &#x27;🔑&#x27;, &#x27;🗝&#x27;, &#x27;🚪&#x27;, &#x27;🪑&#x27;, &#x27;🛋&#x27;, &#x27;🛏&#x27;, &#x27;🧸&#x27;, &#x27;🛍&#x27;, &#x27;🛒&#x27;, &#x27;🎁&#x27;, &#x27;🎈&#x27;, &#x27;🎏&#x27;, &#x27;🎀&#x27;, &#x27;🎊&#x27;, &#x27;🎉&#x27;, &#x27;🎎&#x27;, &#x27;🏮&#x27;, &#x27;🎐&#x27;, &#x27;🧧&#x27;, &#x27;✉️&#x27;, &#x27;📩&#x27;, &#x27;📨&#x27;, &#x27;📧&#x27;, &#x27;💌&#x27;, &#x27;📥&#x27;, &#x27;📤&#x27;, &#x27;📦&#x27;, &#x27;🏷&#x27;, &#x27;📪&#x27;, &#x27;📫&#x27;, &#x27;📬&#x27;, &#x27;📭&#x27;, &#x27;📮&#x27;, &#x27;📯&#x27;, &#x27;📜&#x27;, &#x27;📃&#x27;, &#x27;📄&#x27;, &#x27;📑&#x27;, &#x27;🧾&#x27;, &#x27;📊&#x27;, &#x27;📈&#x27;, &#x27;📉&#x27;, &#x27;🗒&#x27;, &#x27;🗓&#x27;, &#x27;📆&#x27;, &#x27;📅&#x27;, &#x27;🗑&#x27;, &#x27;📇&#x27;, &#x27;🗃&#x27;, &#x27;🗳&#x27;, &#x27;🗄&#x27;, &#x27;📋&#x27;, &#x27;📁&#x27;, &#x27;📂&#x27;, &#x27;🗂&#x27;, &#x27;🗞&#x27;, &#x27;📰&#x27;, &#x27;📓&#x27;, &#x27;📔&#x27;, &#x27;📒&#x27;, &#x27;📕&#x27;, &#x27;📗&#x27;, &#x27;📘&#x27;, &#x27;📙&#x27;, &#x27;📚&#x27;, &#x27;📖&#x27;, &#x27;🔖&#x27;, &#x27;🧷&#x27;, &#x27;🔗&#x27;, &#x27;📎&#x27;, &#x27;🖇&#x27;, &#x27;📐&#x27;, &#x27;📏&#x27;, &#x27;🧮&#x27;, &#x27;📌&#x27;, &#x27;📍&#x27;, &#x27;✂️&#x27;, &#x27;🖊&#x27;, &#x27;🖋&#x27;, &#x27;✒️&#x27;, &#x27;🖌&#x27;, &#x27;🖍&#x27;, &#x27;📝&#x27;, &#x27;✏️&#x27;, &#x27;🔍&#x27;, &#x27;🔎&#x27;, &#x27;🔏&#x27;, &#x27;🔐&#x27;, &#x27;🔒&#x27;, &#x27;🔓&#x27;]</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        this.emojiCategories = emojiCategories;</span><br><span class="line">        this.renderEmojiCategory(&#x27;smileys&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    renderEmojiCategory(category) &#123;</span><br><span class="line">        this.emojiGrid.innerHTML = &#x27;&#x27;;</span><br><span class="line">        </span><br><span class="line">        const emojis = this.emojiCategories[category] || [];</span><br><span class="line">        emojis.forEach(emoji =&gt; &#123;</span><br><span class="line">            const emojiElement = document.createElement(&#x27;div&#x27;);</span><br><span class="line">            emojiElement.className = &#x27;emoji-item&#x27;;</span><br><span class="line">            emojiElement.textContent = emoji;</span><br><span class="line">            emojiElement.addEventListener(&#x27;click&#x27;, () =&gt; this.insertEmoji(emoji));</span><br><span class="line">            this.emojiGrid.appendChild(emojiElement);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    switchEmojiCategory(button) &#123;</span><br><span class="line">        this.emojiCategoryBtns.forEach(btn =&gt; btn.classList.remove(&#x27;active&#x27;));</span><br><span class="line">        button.classList.add(&#x27;active&#x27;);</span><br><span class="line">        </span><br><span class="line">        const category = button.dataset.category;</span><br><span class="line">        this.renderEmojiCategory(category);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    searchEmojis(query) &#123;</span><br><span class="line">        const allEmojis = Object.values(this.emojiCategories).flat();</span><br><span class="line">        const filteredEmojis = allEmojis.filter(emoji =&gt; </span><br><span class="line">            emoji.includes(query) || </span><br><span class="line">            this.getEmojiDescription(emoji).toLowerCase().includes(query.toLowerCase())</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        this.emojiGrid.innerHTML = &#x27;&#x27;;</span><br><span class="line">        filteredEmojis.forEach(emoji =&gt; &#123;</span><br><span class="line">            const emojiElement = document.createElement(&#x27;div&#x27;);</span><br><span class="line">            emojiElement.className = &#x27;emoji-item&#x27;;</span><br><span class="line">            emojiElement.textContent = emoji;</span><br><span class="line">            emojiElement.addEventListener(&#x27;click&#x27;, () =&gt; this.insertEmoji(emoji));</span><br><span class="line">            this.emojiGrid.appendChild(emojiElement);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    getEmojiDescription(emoji) &#123;</span><br><span class="line">        // 这里可以添加表情描述</span><br><span class="line">        const descriptions = &#123;</span><br><span class="line">            &#x27;😀&#x27;: &#x27;笑脸&#x27;,</span><br><span class="line">            &#x27;❤️&#x27;: &#x27;红心&#x27;,</span><br><span class="line">            &#x27;👍&#x27;: &#x27;大拇指&#x27;,</span><br><span class="line">            // 更多表情描述...</span><br><span class="line">        &#125;;</span><br><span class="line">        return descriptions[emoji] || &#x27;&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    toggleEmojiPicker() &#123;</span><br><span class="line">        this.emojiPicker.classList.toggle(&#x27;show&#x27;);</span><br><span class="line">        if (this.emojiPicker.classList.contains(&#x27;show&#x27;)) &#123;</span><br><span class="line">            this.emojiSearch.focus();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    hideEmojiPicker() &#123;</span><br><span class="line">        this.emojiPicker.classList.remove(&#x27;show&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    insertEmoji(emoji) &#123;</span><br><span class="line">        const input = this.messageInput;</span><br><span class="line">        const start = input.selectionStart;</span><br><span class="line">        const end = input.selectionEnd;</span><br><span class="line">        const text = input.value;</span><br><span class="line">        </span><br><span class="line">        input.value = text.substring(0, start) + emoji + text.substring(end);</span><br><span class="line">        input.focus();</span><br><span class="line">        input.selectionStart = input.selectionEnd = start + emoji.length;</span><br><span class="line">        </span><br><span class="line">        // 触发输入事件</span><br><span class="line">        input.dispatchEvent(new Event(&#x27;input&#x27;));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 文件上传功能</span><br><span class="line">    showFileUploadModal() &#123;</span><br><span class="line">        this.fileUploadModal.classList.add(&#x27;show&#x27;);</span><br><span class="line">        this.uploadPreview.innerHTML = &#x27;&#x27;;</span><br><span class="line">        this.uploadQueue = [];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    handleFileSelection(event) &#123;</span><br><span class="line">        const files = Array.from(event.target.files);</span><br><span class="line">        this.addFilesToQueue(files);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    handleFileDrop(files) &#123;</span><br><span class="line">        this.addFilesToQueue(Array.from(files));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    addFilesToQueue(files) &#123;</span><br><span class="line">        files.forEach(file =&gt; &#123;</span><br><span class="line">            if (file.size &gt; 50 * 1024 * 1024) &#123; // 50MB限制</span><br><span class="line">                this.showNotification(`文件 $&#123;file.name&#125; 超过大小限制`, &#x27;error&#x27;);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            const fileType = this.getFileType(file);</span><br><span class="line">            const fileItem = &#123;</span><br><span class="line">                id: Date.now() + Math.random(),</span><br><span class="line">                file: file,</span><br><span class="line">                type: fileType,</span><br><span class="line">                progress: 0,</span><br><span class="line">                status: &#x27;pending&#x27;</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            this.uploadQueue.push(fileItem);</span><br><span class="line">            this.renderFilePreview(fileItem);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        this.sendFilesBtn.disabled = false;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    getFileType(file) &#123;</span><br><span class="line">        if (file.type.startsWith(&#x27;image/&#x27;)) return &#x27;image&#x27;;</span><br><span class="line">        if (file.type.startsWith(&#x27;audio/&#x27;)) return &#x27;voice&#x27;;</span><br><span class="line">        if (file.type === &#x27;application/pdf&#x27;) return &#x27;pdf&#x27;;</span><br><span class="line">        if (file.type.includes(&#x27;word&#x27;)) return &#x27;word&#x27;;</span><br><span class="line">        if (file.type.includes(&#x27;excel&#x27;) || file.type.includes(&#x27;sheet&#x27;)) return &#x27;excel&#x27;;</span><br><span class="line">        if (file.type.includes(&#x27;zip&#x27;) || file.type.includes(&#x27;compressed&#x27;)) return &#x27;zip&#x27;;</span><br><span class="line">        return &#x27;file&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    renderFilePreview(fileItem) &#123;</span><br><span class="line">        const preview = document.createElement(&#x27;div&#x27;);</span><br><span class="line">        preview.className = &#x27;progress-item&#x27;;</span><br><span class="line">        preview.id = `file-$&#123;fileItem.id&#125;`;</span><br><span class="line">        </span><br><span class="line">        const fileIcon = this.getFileIcon(fileItem.type);</span><br><span class="line">        </span><br><span class="line">        preview.innerHTML = `</span><br><span class="line">            &lt;div class=&quot;progress-icon $&#123;fileItem.type&#125;&quot;&gt;</span><br><span class="line">                $&#123;fileIcon&#125;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;progress-info&quot;&gt;</span><br><span class="line">                &lt;div class=&quot;progress-name&quot;&gt;$&#123;fileItem.file.name&#125;&lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;progress-bar&quot;&gt;</span><br><span class="line">                    &lt;div class=&quot;progress-filled&quot; style=&quot;width: $&#123;fileItem.progress&#125;%&quot;&gt;&lt;/div&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;progress-status&quot;&gt;</span><br><span class="line">                    &lt;span class=&quot;progress-percent&quot;&gt;$&#123;fileItem.progress&#125;%&lt;/span&gt;</span><br><span class="line">                    &lt;span class=&quot;progress-size&quot;&gt;$&#123;this.formatFileSize(fileItem.file.size)&#125;&lt;/span&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;button class=&quot;remove-file&quot; data-id=&quot;$&#123;fileItem.id&#125;&quot;&gt;</span><br><span class="line">                &lt;i class=&quot;fas fa-times&quot;&gt;&lt;/i&gt;</span><br><span class="line">            &lt;/button&gt;</span><br><span class="line">        `;</span><br><span class="line">        </span><br><span class="line">        this.uploadPreview.appendChild(preview);</span><br><span class="line">        </span><br><span class="line">        // 添加删除按钮事件</span><br><span class="line">        preview.querySelector(&#x27;.remove-file&#x27;).addEventListener(&#x27;click&#x27;, (e) =&gt; &#123;</span><br><span class="line">            e.stopPropagation();</span><br><span class="line">            this.removeFileFromQueue(fileItem.id);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    getFileIcon(type) &#123;</span><br><span class="line">        const icons = &#123;</span><br><span class="line">            image: &#x27;&lt;i class=&quot;fas fa-image&quot;&gt;&lt;/i&gt;&#x27;,</span><br><span class="line">            voice: &#x27;&lt;i class=&quot;fas fa-microphone-alt&quot;&gt;&lt;/i&gt;&#x27;,</span><br><span class="line">            pdf: &#x27;&lt;i class=&quot;fas fa-file-pdf&quot;&gt;&lt;/i&gt;&#x27;,</span><br><span class="line">            word: &#x27;&lt;i class=&quot;fas fa-file-word&quot;&gt;&lt;/i&gt;&#x27;,</span><br><span class="line">            excel: &#x27;&lt;i class=&quot;fas fa-file-excel&quot;&gt;&lt;/i&gt;&#x27;,</span><br><span class="line">            zip: &#x27;&lt;i class=&quot;fas fa-file-archive&quot;&gt;&lt;/i&gt;&#x27;,</span><br><span class="line">            file: &#x27;&lt;i class=&quot;fas fa-file&quot;&gt;&lt;/i&gt;&#x27;</span><br><span class="line">        &#125;;</span><br><span class="line">        return icons[type] || icons.file;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    formatFileSize(bytes) &#123;</span><br><span class="line">        if (bytes === 0) return &#x27;0 Bytes&#x27;;</span><br><span class="line">        const k = 1024;</span><br><span class="line">        const sizes = [&#x27;Bytes&#x27;, &#x27;KB&#x27;, &#x27;MB&#x27;, &#x27;GB&#x27;];</span><br><span class="line">        const i = Math.floor(Math.log(bytes) / Math.log(k));</span><br><span class="line">        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + &#x27; &#x27; + sizes[i];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    async sendFiles() &#123;</span><br><span class="line">        if (this.uploadQueue.length === 0 || this.uploading) return;</span><br><span class="line">        </span><br><span class="line">        this.uploading = true;</span><br><span class="line">        this.sendFilesBtn.disabled = true;</span><br><span class="line">        </span><br><span class="line">        for (const fileItem of this.uploadQueue) &#123;</span><br><span class="line">            if (fileItem.status === &#x27;pending&#x27;) &#123;</span><br><span class="line">                await this.uploadFile(fileItem);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        this.uploading = false;</span><br><span class="line">        this.fileUploadModal.classList.remove(&#x27;show&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    async uploadFile(fileItem) &#123;</span><br><span class="line">        const formData = new FormData();</span><br><span class="line">        formData.append(&#x27;file&#x27;, fileItem.file);</span><br><span class="line">        formData.append(&#x27;type&#x27;, fileItem.type);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            const xhr = new XMLHttpRequest();</span><br><span class="line">            </span><br><span class="line">            xhr.upload.addEventListener(&#x27;progress&#x27;, (event) =&gt; &#123;</span><br><span class="line">                if (event.lengthComputable) &#123;</span><br><span class="line">                    const progress = Math.round((event.loaded * 100) / event.total);</span><br><span class="line">                    this.updateFileProgress(fileItem.id, progress);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            xhr.addEventListener(&#x27;load&#x27;, () =&gt; &#123;</span><br><span class="line">                if (xhr.status === 200) &#123;</span><br><span class="line">                    const response = JSON.parse(xhr.responseText);</span><br><span class="line">                    this.sendFileMessage(response.fileUrl, fileItem);</span><br><span class="line">                    this.updateFileStatus(fileItem.id, &#x27;completed&#x27;);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    this.updateFileStatus(fileItem.id, &#x27;error&#x27;);</span><br><span class="line">                    this.showNotification(`文件 $&#123;fileItem.file.name&#125; 上传失败`, &#x27;error&#x27;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            xhr.addEventListener(&#x27;error&#x27;, () =&gt; &#123;</span><br><span class="line">                this.updateFileStatus(fileItem.id, &#x27;error&#x27;);</span><br><span class="line">                this.showNotification(`文件 $&#123;fileItem.file.name&#125; 上传失败`, &#x27;error&#x27;);</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            xhr.open(&#x27;POST&#x27;, &#x27;/api/files/upload&#x27;);</span><br><span class="line">            xhr.setRequestHeader(&#x27;Authorization&#x27;, `Bearer $&#123;this.token&#125;`);</span><br><span class="line">            xhr.send(formData);</span><br><span class="line">            </span><br><span class="line">        &#125; catch (error) &#123;</span><br><span class="line">            console.error(&#x27;上传错误:&#x27;, error);</span><br><span class="line">            this.updateFileStatus(fileItem.id, &#x27;error&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    updateFileProgress(fileId, progress) &#123;</span><br><span class="line">        const preview = document.getElementById(`file-$&#123;fileId&#125;`);</span><br><span class="line">        if (preview) &#123;</span><br><span class="line">            preview.querySelector(&#x27;.progress-filled&#x27;).style.width = `$&#123;progress&#125;%`;</span><br><span class="line">            preview.querySelector(&#x27;.progress-percent&#x27;).textContent = `$&#123;progress&#125;%`;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    updateFileStatus(fileId, status) &#123;</span><br><span class="line">        const preview = document.getElementById(`file-$&#123;fileId&#125;`);</span><br><span class="line">        if (preview) &#123;</span><br><span class="line">            preview.dataset.status = status;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    removeFileFromQueue(fileId) &#123;</span><br><span class="line">        this.uploadQueue = this.uploadQueue.filter(item =&gt; item.id !== fileId);</span><br><span class="line">        const preview = document.getElementById(`file-$&#123;fileId&#125;`);</span><br><span class="line">        if (preview) &#123;</span><br><span class="line">            preview.remove();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (this.uploadQueue.length === 0) &#123;</span><br><span class="line">            this.sendFilesBtn.disabled = true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    sendFileMessage(fileUrl, fileItem) &#123;</span><br><span class="line">        const message = &#123;</span><br><span class="line">            type: fileItem.type === &#x27;image&#x27; ? &#x27;IMAGE&#x27; : &#x27;FILE&#x27;,</span><br><span class="line">            sender: this.username,</span><br><span class="line">            content: fileItem.file.name,</span><br><span class="line">            fileUrl: fileUrl,</span><br><span class="line">            fileName: fileItem.file.name,</span><br><span class="line">            fileSize: fileItem.file.size,</span><br><span class="line">            timestamp: new Date().toISOString()</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        if (this.stompClient &amp;&amp; this.connected) &#123;</span><br><span class="line">            if (this.currentPrivateChat) &#123;</span><br><span class="line">                message.receiver = this.currentPrivateChat;</span><br><span class="line">                this.stompClient.send(&#x27;/app/chat.sendPrivateMessage&#x27;, &#123;&#125;, JSON.stringify(message));</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                this.stompClient.send(&#x27;/app/chat.sendMessage&#x27;, &#123;&#125;, JSON.stringify(message));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 语音录制功能</span><br><span class="line">    initVoiceRecorder() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();</span><br><span class="line">            this.analyser = this.audioContext.createAnalyser();</span><br><span class="line">            this.analyser.fftSize = 256;</span><br><span class="line">        &#125; catch (error) &#123;</span><br><span class="line">            console.error(&#x27;音频上下文初始化失败:&#x27;, error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    async startRecording() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            const stream = await navigator.mediaDevices.getUserMedia(&#123; audio: true &#125;);</span><br><span class="line">            this.mediaRecorder = new MediaRecorder(stream);</span><br><span class="line">            this.audioChunks = [];</span><br><span class="line">            </span><br><span class="line">            this.mediaRecorder.addEventListener(&#x27;dataavailable&#x27;, (event) =&gt; &#123;</span><br><span class="line">                this.audioChunks.push(event.data);</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            this.mediaRecorder.addEventListener(&#x27;stop&#x27;, () =&gt; &#123;</span><br><span class="line">                const audioBlob = new Blob(this.audioChunks, &#123; type: &#x27;audio/webm&#x27; &#125;);</span><br><span class="line">                this.audioUrl = URL.createObjectURL(audioBlob);</span><br><span class="line">                this.audioBlob = audioBlob;</span><br><span class="line">                this.playRecordBtn.disabled = false;</span><br><span class="line">                this.sendRecordBtn.disabled = false;</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            this.mediaRecorder.start();</span><br><span class="line">            this.isRecording = true;</span><br><span class="line">            this.startRecordBtn.classList.add(&#x27;recording&#x27;);</span><br><span class="line">            this.stopRecordBtn.disabled = false;</span><br><span class="line">            </span><br><span class="line">            // 开始计时</span><br><span class="line">            this.recordingStartTime = Date.now();</span><br><span class="line">            this.recordingTimer = setInterval(() =&gt; &#123;</span><br><span class="line">                const elapsed = Date.now() - this.recordingStartTime;</span><br><span class="line">                this.updateRecordingTime(elapsed);</span><br><span class="line">            &#125;, 1000);</span><br><span class="line">            </span><br><span class="line">            // 可视化</span><br><span class="line">            this.startVisualization(stream);</span><br><span class="line">            </span><br><span class="line">        &#125; catch (error) &#123;</span><br><span class="line">            console.error(&#x27;录音失败:&#x27;, error);</span><br><span class="line">            this.showNotification(&#x27;无法访问麦克风&#x27;, &#x27;error&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    stopRecording() &#123;</span><br><span class="line">        if (this.mediaRecorder &amp;&amp; this.isRecording) &#123;</span><br><span class="line">            this.mediaRecorder.stop();</span><br><span class="line">            this.isRecording = false;</span><br><span class="line">            this.startRecordBtn.classList.remove(&#x27;recording&#x27;);</span><br><span class="line">            this.stopRecordBtn.disabled = true;</span><br><span class="line">            </span><br><span class="line">            // 停止计时</span><br><span class="line">            clearInterval(this.recordingTimer);</span><br><span class="line">            </span><br><span class="line">            // 停止可视化</span><br><span class="line">            this.stopVisualization();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    playRecording() &#123;</span><br><span class="line">        if (!this.audioUrl || this.isPlaying) return;</span><br><span class="line">        </span><br><span class="line">        const audio = new Audio(this.audioUrl);</span><br><span class="line">        audio.addEventListener(&#x27;ended&#x27;, () =&gt; &#123;</span><br><span class="line">            this.isPlaying = false;</span><br><span class="line">            this.playRecordBtn.innerHTML = &#x27;&lt;i class=&quot;fas fa-play&quot;&gt;&lt;/i&gt;&#x27;;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        audio.play();</span><br><span class="line">        this.isPlaying = true;</span><br><span class="line">        this.playRecordBtn.innerHTML = &#x27;&lt;i class=&quot;fas fa-pause&quot;&gt;&lt;/i&gt;&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    async sendVoiceMessage() &#123;</span><br><span class="line">        if (!this.audioBlob) return;</span><br><span class="line">        </span><br><span class="line">        const formData = new FormData();</span><br><span class="line">        formData.append(&#x27;file&#x27;, this.audioBlob, &#x27;voice.webm&#x27;);</span><br><span class="line">        formData.append(&#x27;type&#x27;, &#x27;voice&#x27;);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            const response = await fetch(&#x27;/api/files/upload&#x27;, &#123;</span><br><span class="line">                method: &#x27;POST&#x27;,</span><br><span class="line">                headers: &#123;</span><br><span class="line">                    &#x27;Authorization&#x27;: `Bearer $&#123;this.token&#125;`</span><br><span class="line">                &#125;,</span><br><span class="line">                body: formData</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            if (response.ok) &#123;</span><br><span class="line">                const data = await response.json();</span><br><span class="line">                this.sendVoiceMessageToServer(data.fileUrl);</span><br><span class="line">                this.hideVoiceRecorder();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (error) &#123;</span><br><span class="line">            console.error(&#x27;语音上传失败:&#x27;, error);</span><br><span class="line">            this.showNotification(&#x27;语音发送失败&#x27;, &#x27;error&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    sendVoiceMessageToServer(fileUrl) &#123;</span><br><span class="line">        const duration = Math.round((Date.now() - this.recordingStartTime) / 1000);</span><br><span class="line">        const message = &#123;</span><br><span class="line">            type: &#x27;VOICE&#x27;,</span><br><span class="line">            sender: this.username,</span><br><span class="line">            content: `语音消息 $&#123;duration&#125;秒`,</span><br><span class="line">            fileUrl: fileUrl,</span><br><span class="line">            fileName: &#x27;voice.webm&#x27;,</span><br><span class="line">            fileSize: this.audioBlob.size,</span><br><span class="line">            duration: duration,</span><br><span class="line">            timestamp: new Date().toISOString()</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        if (this.stompClient &amp;&amp; this.connected) &#123;</span><br><span class="line">            if (this.currentPrivateChat) &#123;</span><br><span class="line">                message.receiver = this.currentPrivateChat;</span><br><span class="line">                this.stompClient.send(&#x27;/app/chat.sendPrivateMessage&#x27;, &#123;&#125;, JSON.stringify(message));</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                this.stompClient.send(&#x27;/app/chat.sendMessage&#x27;, &#123;&#125;, JSON.stringify(message));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    updateRecordingTime(elapsed) &#123;</span><br><span class="line">        const seconds = Math.floor(elapsed / 1000);</span><br><span class="line">        const minutes = Math.floor(seconds / 60);</span><br><span class="line">        const remainingSeconds = seconds % 60;</span><br><span class="line">        </span><br><span class="line">        this.recordingTime.textContent = </span><br><span class="line">            `$&#123;minutes.toString().padStart(2, &#x27;0&#x27;)&#125;:$&#123;remainingSeconds.toString().padStart(2, &#x27;0&#x27;)&#125;`;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    startVisualization(stream) &#123;</span><br><span class="line">        const source = this.audioContext.createMediaStreamSource(stream);</span><br><span class="line">        source.connect(this.analyser);</span><br><span class="line">        </span><br><span class="line">        const bufferLength = this.analyser.frequencyBinCount;</span><br><span class="line">        const dataArray = new Uint8Array(bufferLength);</span><br><span class="line">        </span><br><span class="line">        const draw = () =&gt; &#123;</span><br><span class="line">            if (!this.isRecording) return;</span><br><span class="line">            </span><br><span class="line">            requestAnimationFrame(draw);</span><br><span class="line">            this.analyser.getByteFrequencyData(dataArray);</span><br><span class="line">            </span><br><span class="line">            // 绘制可视化</span><br><span class="line">            this.drawVisualizer(dataArray, bufferLength);</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        draw();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    drawVisualizer(dataArray, bufferLength) &#123;</span><br><span class="line">        this.visualizer.innerHTML = &#x27;&#x27;;</span><br><span class="line">        const width = this.visualizer.clientWidth;</span><br><span class="line">        const height = this.visualizer.clientHeight;</span><br><span class="line">        const barWidth = (width / bufferLength) * 2.5;</span><br><span class="line">        </span><br><span class="line">        let x = 0;</span><br><span class="line">        </span><br><span class="line">        for (let i = 0; i &lt; bufferLength; i++) &#123;</span><br><span class="line">            const barHeight = (dataArray[i] / 255) * height;</span><br><span class="line">            </span><br><span class="line">            const bar = document.createElement(&#x27;div&#x27;);</span><br><span class="line">            bar.style.position = &#x27;absolute&#x27;;</span><br><span class="line">            bar.style.left = x + &#x27;px&#x27;;</span><br><span class="line">            bar.style.bottom = &#x27;0&#x27;;</span><br><span class="line">            bar.style.width = barWidth + &#x27;px&#x27;;</span><br><span class="line">            bar.style.height = barHeight + &#x27;px&#x27;;</span><br><span class="line">            bar.style.backgroundColor = &#x27;var(--primary-color)&#x27;;</span><br><span class="line">            bar.style.borderRadius = &#x27;2px&#x27;;</span><br><span class="line">            </span><br><span class="line">            this.visualizer.appendChild(bar);</span><br><span class="line">            x += barWidth + 1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    stopVisualization() &#123;</span><br><span class="line">        this.visualizer.innerHTML = &#x27;&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    toggleVoiceRecorder() &#123;</span><br><span class="line">        this.voiceRecorder.classList.toggle(&#x27;show&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    hideVoiceRecorder() &#123;</span><br><span class="line">        this.voiceRecorder.classList.remove(&#x27;show&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 用户设置</span><br><span class="line">    showUserSettings() &#123;</span><br><span class="line">        this.editNickname.value = this.currentUser.nickname || &#x27;&#x27;;</span><br><span class="line">        this.editBio.value = this.currentUser.bio || &#x27;&#x27;;</span><br><span class="line">        </span><br><span class="line">        // 设置状态</span><br><span class="line">        const statusInput = document.querySelector(`input[name=&quot;status&quot;][value=&quot;$&#123;this.currentUser.status || &#x27;ONLINE&#x27;&#125;&quot;]`);</span><br><span class="line">        if (statusInput) &#123;</span><br><span class="line">            statusInput.checked = true;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        this.userSettingsModal.classList.add(&#x27;show&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    handleAvatarUpload(event) &#123;</span><br><span class="line">        const file = event.target.files[0];</span><br><span class="line">        if (!file) return;</span><br><span class="line">        </span><br><span class="line">        if (!file.type.startsWith(&#x27;image/&#x27;)) &#123;</span><br><span class="line">            this.showNotification(&#x27;请选择图片文件&#x27;, &#x27;error&#x27;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (file.size &gt; 5 * 1024 * 1024) &#123; // 5MB限制</span><br><span class="line">            this.showNotification(&#x27;图片大小不能超过5MB&#x27;, &#x27;error&#x27;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        const reader = new FileReader();</span><br><span class="line">        reader.onload = (e) =&gt; &#123;</span><br><span class="line">            this.avatarPreview.querySelector(&#x27;img&#x27;).src = e.target.result;</span><br><span class="line">        &#125;;</span><br><span class="line">        reader.readAsDataURL(file);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    async saveUserSettings() &#123;</span><br><span class="line">        const formData = new FormData();</span><br><span class="line">        </span><br><span class="line">        // 头像上传</span><br><span class="line">        const avatarFile = this.avatarUpload.files[0];</span><br><span class="line">        if (avatarFile) &#123;</span><br><span class="line">            formData.append(&#x27;avatar&#x27;, avatarFile);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        formData.append(&#x27;nickname&#x27;, this.editNickname.value);</span><br><span class="line">        formData.append(&#x27;bio&#x27;, this.editBio.value);</span><br><span class="line">        formData.append(&#x27;status&#x27;, document.querySelector(&#x27;input[name=&quot;status&quot;]:checked&#x27;).value);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            const response = await fetch(&#x27;/api/user/profile&#x27;, &#123;</span><br><span class="line">                method: &#x27;PUT&#x27;,</span><br><span class="line">                headers: &#123;</span><br><span class="line">                    &#x27;Authorization&#x27;: `Bearer $&#123;this.token&#125;`</span><br><span class="line">                &#125;,</span><br><span class="line">                body: formData</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            if (response.ok) &#123;</span><br><span class="line">                const data = await response.json();</span><br><span class="line">                this.currentUser = &#123; ...this.currentUser, ...data &#125;;</span><br><span class="line">                localStorage.setItem(&#x27;chat_user&#x27;, JSON.stringify(this.currentUser));</span><br><span class="line">                </span><br><span class="line">                this.usernameDisplay.textContent = data.nickname;</span><br><span class="line">                this.showNotification(&#x27;设置已保存&#x27;, &#x27;success&#x27;);</span><br><span class="line">                this.userSettingsModal.classList.remove(&#x27;show&#x27;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (error) &#123;</span><br><span class="line">            console.error(&#x27;保存设置失败:&#x27;, error);</span><br><span class="line">            this.showNotification(&#x27;保存失败&#x27;, &#x27;error&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 上下文菜单</span><br><span class="line">    handleContextMenu(event) &#123;</span><br><span class="line">        const messageElement = event.target.closest(&#x27;.message&#x27;);</span><br><span class="line">        if (!messageElement) return;</span><br><span class="line">        </span><br><span class="line">        event.preventDefault();</span><br><span class="line">        </span><br><span class="line">        const messageId = messageElement.dataset.messageId;</span><br><span class="line">        if (!messageId) return;</span><br><span class="line">        </span><br><span class="line">        // 获取消息信息</span><br><span class="line">        const message = this.getMessageById(messageId);</span><br><span class="line">        if (!message) return;</span><br><span class="line">        </span><br><span class="line">        // 检查权限（是否可以删除、举报等）</span><br><span class="line">        const canDelete = message.sender === this.username || this.currentUser.role === &#x27;ADMIN&#x27;;</span><br><span class="line">        </span><br><span class="line">        // 更新菜单项状态</span><br><span class="line">        this.updateContextMenu(canDelete);</span><br><span class="line">        </span><br><span class="line">        // 显示菜单</span><br><span class="line">        this.contextMenu.style.display = &#x27;block&#x27;;</span><br><span class="line">        this.contextMenu.style.left = `$&#123;event.pageX&#125;px`;</span><br><span class="line">        this.contextMenu.style.top = `$&#123;event.pageY&#125;px`;</span><br><span class="line">        </span><br><span class="line">        // 保存当前消息ID</span><br><span class="line">        this.contextMenu.dataset.messageId = messageId;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    updateContextMenu(canDelete) &#123;</span><br><span class="line">        const deleteItem = this.contextMenu.querySelector(&#x27;[data-action=&quot;delete&quot;]&#x27;);</span><br><span class="line">        const reportItem = this.contextMenu.querySelector(&#x27;[data-action=&quot;report&quot;]&#x27;);</span><br><span class="line">        </span><br><span class="line">        if (canDelete) &#123;</span><br><span class="line">            deleteItem.style.display = &#x27;block&#x27;;</span><br><span class="line">            reportItem.style.display = &#x27;none&#x27;;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            deleteItem.style.display = &#x27;none&#x27;;</span><br><span class="line">            reportItem.style.display = &#x27;block&#x27;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    hideContextMenu() &#123;</span><br><span class="line">        this.contextMenu.style.display = &#x27;none&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    getMessageById(messageId) &#123;</span><br><span class="line">        // 从历史消息中查找</span><br><span class="line">        return this.messageHistory.find(msg =&gt; msg.id === messageId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 其他增强功能</span><br><span class="line">    setUserStatus(status) &#123;</span><br><span class="line">        if (!this.currentUser) return;</span><br><span class="line">        </span><br><span class="line">        fetch(&#x27;/api/user/status&#x27;, &#123;</span><br><span class="line">            method: &#x27;PUT&#x27;,</span><br><span class="line">            headers: &#123;</span><br><span class="line">                &#x27;Content-Type&#x27;: &#x27;application/json&#x27;,</span><br><span class="line">                &#x27;Authorization&#x27;: `Bearer $&#123;this.token&#125;`</span><br><span class="line">            &#125;,</span><br><span class="line">            body: JSON.stringify(&#123; status: status &#125;)</span><br><span class="line">        &#125;).catch(console.error);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    async loadMoreMessages() &#123;</span><br><span class="line">        if (this.loadingMessages) return;</span><br><span class="line">        </span><br><span class="line">        this.loadingMessages = true;</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            const response = await fetch(`/api/messages/history?offset=$&#123;this.messageHistory.length&#125;&amp;limit=50`, &#123;</span><br><span class="line">                headers: &#123;</span><br><span class="line">                    &#x27;Authorization&#x27;: `Bearer $&#123;this.token&#125;`</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            if (response.ok) &#123;</span><br><span class="line">                const messages = await response.json();</span><br><span class="line">                if (messages.length &gt; 0) &#123;</span><br><span class="line">                    this.prependMessages(messages);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (error) &#123;</span><br><span class="line">            console.error(&#x27;加载消息失败:&#x27;, error);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            this.loadingMessages = false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    prependMessages(messages) &#123;</span><br><span class="line">        const fragment = document.createDocumentFragment();</span><br><span class="line">        </span><br><span class="line">        messages.reverse().forEach(message =&gt; &#123;</span><br><span class="line">            const messageElement = this.createMessageElement(message);</span><br><span class="line">            fragment.appendChild(messageElement);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        this.messagesContainer.insertBefore(fragment, this.messagesContainer.firstChild);</span><br><span class="line">        this.messageHistory.unshift(...messages);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 消息搜索功能</span><br><span class="line">    searchMessages(keyword) &#123;</span><br><span class="line">        if (!keyword) return;</span><br><span class="line">        </span><br><span class="line">        const results = this.messageHistory.filter(msg =&gt; </span><br><span class="line">            msg.content.toLowerCase().includes(keyword.toLowerCase()) ||</span><br><span class="line">            msg.sender.toLowerCase().includes(keyword.toLowerCase())</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        this.highlightSearchResults(results, keyword);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    highlightSearchResults(results, keyword) &#123;</span><br><span class="line">        // 移除之前的高亮</span><br><span class="line">        document.querySelectorAll(&#x27;.search-highlight&#x27;).forEach(el =&gt; &#123;</span><br><span class="line">            const parent = el.parentNode;</span><br><span class="line">            parent.replaceChild(document.createTextNode(el.textContent), el);</span><br><span class="line">            parent.normalize();</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        // 添加新的高亮</span><br><span class="line">        results.forEach(result =&gt; &#123;</span><br><span class="line">            const messageElement = document.querySelector(`[data-message-id=&quot;$&#123;result.id&#125;&quot;]`);</span><br><span class="line">            if (messageElement) &#123;</span><br><span class="line">                this.highlightText(messageElement, keyword);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    highlightText(element, keyword) &#123;</span><br><span class="line">        const regex = new RegExp(`($&#123;keyword&#125;)`, &#x27;gi&#x27;);</span><br><span class="line">        const nodes = this.getTextNodes(element);</span><br><span class="line">        </span><br><span class="line">        nodes.forEach(node =&gt; &#123;</span><br><span class="line">            const text = node.textContent;</span><br><span class="line">            const matches = [...text.matchAll(regex)];</span><br><span class="line">            </span><br><span class="line">            if (matches.length &gt; 0) &#123;</span><br><span class="line">                const fragment = document.createDocumentFragment();</span><br><span class="line">                let lastIndex = 0;</span><br><span class="line">                </span><br><span class="line">                matches.forEach(match =&gt; &#123;</span><br><span class="line">                    const matchIndex = match.index;</span><br><span class="line">                    </span><br><span class="line">                    // 添加匹配前的文本</span><br><span class="line">                    if (matchIndex &gt; lastIndex) &#123;</span><br><span class="line">                        fragment.appendChild(document.createTextNode(text.substring(lastIndex, matchIndex)));</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    // 添加高亮文本</span><br><span class="line">                    const highlight = document.createElement(&#x27;span&#x27;);</span><br><span class="line">                    highlight.className = &#x27;search-highlight&#x27;;</span><br><span class="line">                    highlight.textContent = match[0];</span><br><span class="line">                    fragment.appendChild(highlight);</span><br><span class="line">                    </span><br><span class="line">                    lastIndex = matchIndex + match[0].length;</span><br><span class="line">                &#125;);</span><br><span class="line">                </span><br><span class="line">                // 添加剩余的文本</span><br><span class="line">                if (lastIndex &lt; text.length) &#123;</span><br><span class="line">                    fragment.appendChild(document.createTextNode(text.substring(lastIndex)));</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                node.parentNode.replaceChild(fragment, node);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    getTextNodes(element) &#123;</span><br><span class="line">        const walker = document.createTreeWalker(</span><br><span class="line">            element,</span><br><span class="line">            NodeFilter.SHOW_TEXT,</span><br><span class="line">            null,</span><br><span class="line">            false</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        const nodes = [];</span><br><span class="line">        let node;</span><br><span class="line">        while (node = walker.nextNode()) &#123;</span><br><span class="line">            if (node.textContent.trim()) &#123;</span><br><span class="line">                nodes.push(node);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return nodes;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 显示通知</span><br><span class="line">    showNotification(message, type = &#x27;info&#x27;) &#123;</span><br><span class="line">        const notification = document.createElement(&#x27;div&#x27;);</span><br><span class="line">        notification.className = `notification notification-$&#123;type&#125;`;</span><br><span class="line">        notification.innerHTML = `</span><br><span class="line">            &lt;div class=&quot;notification-icon&quot;&gt;</span><br><span class="line">                $&#123;this.getNotificationIcon(type)&#125;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;notification-content&quot;&gt;$&#123;message&#125;&lt;/div&gt;</span><br><span class="line">            &lt;button class=&quot;notification-close&quot;&gt;&amp;times;&lt;/button&gt;</span><br><span class="line">        `;</span><br><span class="line">        </span><br><span class="line">        document.body.appendChild(notification);</span><br><span class="line">        </span><br><span class="line">        // 显示动画</span><br><span class="line">        setTimeout(() =&gt; notification.classList.add(&#x27;show&#x27;), 100);</span><br><span class="line">        </span><br><span class="line">        // 关闭按钮</span><br><span class="line">        notification.querySelector(&#x27;.notification-close&#x27;).addEventListener(&#x27;click&#x27;, () =&gt; &#123;</span><br><span class="line">            notification.classList.remove(&#x27;show&#x27;);</span><br><span class="line">            setTimeout(() =&gt; notification.remove(), 300);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        // 自动关闭</span><br><span class="line">        setTimeout(() =&gt; &#123;</span><br><span class="line">            if (notification.parentNode) &#123;</span><br><span class="line">                notification.classList.remove(&#x27;show&#x27;);</span><br><span class="line">                setTimeout(() =&gt; notification.remove(), 300);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, 5000);</span><br><span class="line">        </span><br><span class="line">        // 播放提示音</span><br><span class="line">        if (type === &#x27;info&#x27; || type === &#x27;success&#x27;) &#123;</span><br><span class="line">            this.playNotificationSound();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    getNotificationIcon(type) &#123;</span><br><span class="line">        const icons = &#123;</span><br><span class="line">            info: &#x27;&lt;i class=&quot;fas fa-info-circle&quot;&gt;&lt;/i&gt;&#x27;,</span><br><span class="line">            success: &#x27;&lt;i class=&quot;fas fa-check-circle&quot;&gt;&lt;/i&gt;&#x27;,</span><br><span class="line">            warning: &#x27;&lt;i class=&quot;fas fa-exclamation-triangle&quot;&gt;&lt;/i&gt;&#x27;,</span><br><span class="line">            error: &#x27;&lt;i class=&quot;fas fa-times-circle&quot;&gt;&lt;/i&gt;&#x27;</span><br><span class="line">        &#125;;</span><br><span class="line">        return icons[type] || icons.info;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    playNotificationSound() &#123;</span><br><span class="line">        const audio = new Audio(&#x27;/sounds/notification.mp3&#x27;);</span><br><span class="line">        audio.volume = 0.3;</span><br><span class="line">        audio.play().catch(console.error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 初始化增强版聊天室</span><br><span class="line">document.addEventListener(&#x27;DOMContentLoaded&#x27;, () =&gt; &#123;</span><br><span class="line">    const chatRoom = new EnhancedChatRoom();</span><br><span class="line">    window.chatRoom = chatRoom; // 暴露给控制台调试</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h2 id="8-应用配置文件更新"><a href="#8-应用配置文件更新" class="headerlink" title="8. 应用配置文件更新"></a>8. 应用配置文件更新</h2><h3 id="8-1-application-yml"><a href="#8-1-application-yml" class="headerlink" title="8.1 application.yml"></a>8.1 application.yml</h3><p>yaml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: chat-room</span><br><span class="line">  </span><br><span class="line">  # 数据库配置</span><br><span class="line">  datasource:</span><br><span class="line">    url: jdbc:mysql://localhost:3306/chat_room?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=Asia/Shanghai</span><br><span class="line">    username: root</span><br><span class="line">    password: root123</span><br><span class="line">    driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">    hikari:</span><br><span class="line">      maximum-pool-size: 10</span><br><span class="line">      minimum-idle: 5</span><br><span class="line">      connection-timeout: 30000</span><br><span class="line">      idle-timeout: 600000</span><br><span class="line">      max-lifetime: 1800000</span><br><span class="line">  </span><br><span class="line">  # JPA配置</span><br><span class="line">  jpa:</span><br><span class="line">    hibernate:</span><br><span class="line">      ddl-auto: update</span><br><span class="line">    show-sql: true</span><br><span class="line">    properties:</span><br><span class="line">      hibernate:</span><br><span class="line">        format_sql: true</span><br><span class="line">        dialect: org.hibernate.dialect.MySQL8Dialect</span><br><span class="line">  </span><br><span class="line">  # 文件上传配置</span><br><span class="line">  servlet:</span><br><span class="line">    multipart:</span><br><span class="line">      max-file-size: 50MB</span><br><span class="line">      max-request-size: 100MB</span><br><span class="line">  </span><br><span class="line">  # 缓存配置</span><br><span class="line">  cache:</span><br><span class="line">    type: caffeine</span><br><span class="line">    caffeine:</span><br><span class="line">      spec: maximumSize=500,expireAfterAccess=600s</span><br><span class="line"></span><br><span class="line"># 应用配置</span><br><span class="line">app:</span><br><span class="line">  jwt:</span><br><span class="line">    secret: your-super-secret-jwt-key-change-this-in-production</span><br><span class="line">    expiration: 86400000 # 24小时</span><br><span class="line">  file:</span><br><span class="line">    upload-dir: ./uploads</span><br><span class="line">    max-size: 50MB</span><br><span class="line">  cors:</span><br><span class="line">    allowed-origins: &quot;*&quot;</span><br><span class="line">    allowed-methods: &quot;*&quot;</span><br><span class="line">    allowed-headers: &quot;*&quot;</span><br><span class="line">    allow-credentials: true</span><br><span class="line"></span><br><span class="line"># 日志配置</span><br><span class="line">logging:</span><br><span class="line">  level:</span><br><span class="line">    com.chatroom: DEBUG</span><br><span class="line">    org.springframework.web.socket: INFO</span><br><span class="line">    org.springframework.security: INFO</span><br><span class="line">  file:</span><br><span class="line">    name: logs/chat-room.log</span><br><span class="line">  pattern:</span><br><span class="line">    file: &quot;%d&#123;yyyy-MM-dd HH:mm:ss&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n&quot;</span><br><span class="line"></span><br><span class="line"># 服务器配置</span><br><span class="line">server:</span><br><span class="line">  port: 8080</span><br><span class="line">  servlet:</span><br><span class="line">    context-path: /</span><br><span class="line">    session:</span><br><span class="line">      timeout: 30m</span><br><span class="line">  compression:</span><br><span class="line">    enabled: true</span><br><span class="line">    mime-types: text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json</span><br><span class="line">    min-response-size: 1024</span><br></pre></td></tr></table></figure>



<h2 id="9-Docker支持"><a href="#9-Docker支持" class="headerlink" title="9. Docker支持"></a>9. Docker支持</h2><h3 id="9-1-Dockerfile"><a href="#9-1-Dockerfile" class="headerlink" title="9.1 Dockerfile"></a>9.1 Dockerfile</h3><p>dockerfile</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># 使用多阶段构建</span><br><span class="line">FROM maven:3.8.4-openjdk-11 AS build</span><br><span class="line">WORKDIR /app</span><br><span class="line">COPY pom.xml .</span><br><span class="line">RUN mvn dependency:go-offline</span><br><span class="line">COPY src ./src</span><br><span class="line">RUN mvn clean package -DskipTests</span><br><span class="line"></span><br><span class="line">FROM openjdk:11-jre-slim</span><br><span class="line">WORKDIR /app</span><br><span class="line">COPY --from=build /app/target/*.jar app.jar</span><br><span class="line"></span><br><span class="line"># 创建上传目录</span><br><span class="line">RUN mkdir -p /app/uploads &amp;&amp; \</span><br><span class="line">    chmod 755 /app/uploads</span><br><span class="line"></span><br><span class="line"># 设置环境变量</span><br><span class="line">ENV SPRING_PROFILES_ACTIVE=production</span><br><span class="line">ENV JAVA_OPTS=&quot;-Xmx512m -Xms256m&quot;</span><br><span class="line"></span><br><span class="line">EXPOSE 8080</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [&quot;sh&quot;, &quot;-c&quot;, &quot;java $JAVA_OPTS -jar app.jar&quot;]</span><br></pre></td></tr></table></figure>



<h3 id="9-2-docker-compose-yml"><a href="#9-2-docker-compose-yml" class="headerlink" title="9.2 docker-compose.yml"></a>9.2 docker-compose.yml</h3><p>yaml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">version: &#x27;3.8&#x27;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  mysql:</span><br><span class="line">    image: mysql:8.0</span><br><span class="line">    container_name: chat-mysql</span><br><span class="line">    environment:</span><br><span class="line">      MYSQL_ROOT_PASSWORD: root123</span><br><span class="line">      MYSQL_DATABASE: chat_room</span><br><span class="line">      MYSQL_USER: chat_user</span><br><span class="line">      MYSQL_PASSWORD: chat123</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;3307:3306&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - mysql_data:/var/lib/mysql</span><br><span class="line">      - ./init.sql:/docker-entrypoint-initdb.d/init.sql</span><br><span class="line">    networks:</span><br><span class="line">      - chat-network</span><br><span class="line">    healthcheck:</span><br><span class="line">      test: [&quot;CMD&quot;, &quot;mysqladmin&quot;, &quot;ping&quot;, &quot;-h&quot;, &quot;localhost&quot;]</span><br><span class="line">      timeout: 20s</span><br><span class="line">      retries: 10</span><br><span class="line"></span><br><span class="line">  redis:</span><br><span class="line">    image: redis:7-alpine</span><br><span class="line">    container_name: chat-redis</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;6379:6379&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - redis_data:/data</span><br><span class="line">    networks:</span><br><span class="line">      - chat-network</span><br><span class="line">    command: redis-server --appendonly yes</span><br><span class="line"></span><br><span class="line">  chat-app:</span><br><span class="line">    build: .</span><br><span class="line">    container_name: chat-app</span><br><span class="line">    depends_on:</span><br><span class="line">      mysql:</span><br><span class="line">        condition: service_healthy</span><br><span class="line">      redis:</span><br><span class="line">        condition: service_started</span><br><span class="line">    environment:</span><br><span class="line">      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/chat_room?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=Asia/Shanghai</span><br><span class="line">      SPRING_DATASOURCE_USERNAME: root</span><br><span class="line">      SPRING_DATASOURCE_PASSWORD: root123</span><br><span class="line">      SPRING_REDIS_HOST: redis</span><br><span class="line">      APP_JWT_SECRET: your-production-jwt-secret-change-this</span><br><span class="line">      APP_FILE_UPLOAD_DIR: /app/uploads</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;8080:8080&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - uploads:/app/uploads</span><br><span class="line">      - logs:/app/logs</span><br><span class="line">    networks:</span><br><span class="line">      - chat-network</span><br><span class="line"></span><br><span class="line">  nginx:</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    container_name: chat-nginx</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;80:80&quot;</span><br><span class="line">      - &quot;443:443&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - ./nginx.conf:/etc/nginx/nginx.conf</span><br><span class="line">      - ./ssl:/etc/nginx/ssl</span><br><span class="line">    depends_on:</span><br><span class="line">      - chat-app</span><br><span class="line">    networks:</span><br><span class="line">      - chat-network</span><br><span class="line"></span><br><span class="line">volumes:</span><br><span class="line">  mysql_data:</span><br><span class="line">  redis_data:</span><br><span class="line">  uploads:</span><br><span class="line">  logs:</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  chat-network:</span><br><span class="line">    driver: bridge</span><br></pre></td></tr></table></figure>



<h3 id="9-3-Nginx配置-nginx-conf"><a href="#9-3-Nginx配置-nginx-conf" class="headerlink" title="9.3 Nginx配置 (nginx.conf)"></a>9.3 Nginx配置 (nginx.conf)</h3><p>nginx</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    upstream chat_backend &#123;</span><br><span class="line">        server chat-app:8080;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name chat.example.com;</span><br><span class="line">        </span><br><span class="line">        # 重定向到HTTPS</span><br><span class="line">        return 301 https://$server_name$request_uri;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 443 ssl http2;</span><br><span class="line">        server_name chat.example.com;</span><br><span class="line">        </span><br><span class="line">        ssl_certificate /etc/nginx/ssl/chat.example.com.crt;</span><br><span class="line">        ssl_certificate_key /etc/nginx/ssl/chat.example.com.key;</span><br><span class="line">        ssl_protocols TLSv1.2 TLSv1.3;</span><br><span class="line">        ssl_ciphers HIGH:!aNULL:!MD5;</span><br><span class="line">        </span><br><span class="line">        # WebSocket支持</span><br><span class="line">        location /ws &#123;</span><br><span class="line">            proxy_pass http://chat_backend;</span><br><span class="line">            proxy_http_version 1.1;</span><br><span class="line">            proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">            proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">            proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">            proxy_read_timeout 86400;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        # 静态文件</span><br><span class="line">        location /uploads &#123;</span><br><span class="line">            proxy_pass http://chat_backend;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        # API请求</span><br><span class="line">        location /api &#123;</span><br><span class="line">            proxy_pass http://chat_backend;</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">            proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        # 应用</span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://chat_backend;</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">            proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        # 缓存静态资源</span><br><span class="line">        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ &#123;</span><br><span class="line">            expires 1y;</span><br><span class="line">            add_header Cache-Control &quot;public, immutable&quot;;</span><br><span class="line">            proxy_pass http://chat_backend;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="10-监控和运维"><a href="#10-监控和运维" class="headerlink" title="10. 监控和运维"></a>10. 监控和运维</h2><h3 id="10-1-Spring-Boot-Actuator配置"><a href="#10-1-Spring-Boot-Actuator配置" class="headerlink" title="10.1 Spring Boot Actuator配置"></a>10.1 Spring Boot Actuator配置</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.config;</span><br><span class="line"></span><br><span class="line">import org.springframework.boot.actuate.autoconfigure.security.servlet.EndpointRequest;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line">import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">public class ActuatorSecurityConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">        http</span><br><span class="line">            .requestMatcher(EndpointRequest.toAnyEndpoint())</span><br><span class="line">            .authorizeRequests()</span><br><span class="line">                .requestMatchers(EndpointRequest.to(&quot;health&quot;, &quot;info&quot;)).permitAll()</span><br><span class="line">                .anyRequest().hasRole(&quot;ADMIN&quot;)</span><br><span class="line">                .and()</span><br><span class="line">            .httpBasic();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="10-2-应用监控端点配置"><a href="#10-2-应用监控端点配置" class="headerlink" title="10.2 应用监控端点配置"></a>10.2 应用监控端点配置</h3><p>yaml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 添加到application.yml</span><br><span class="line">management:</span><br><span class="line">  endpoints:</span><br><span class="line">    web:</span><br><span class="line">      exposure:</span><br><span class="line">        include: health,info,metrics,prometheus</span><br><span class="line">      base-path: /actuator</span><br><span class="line">    enabled-by-default: false</span><br><span class="line">  endpoint:</span><br><span class="line">    health:</span><br><span class="line">      enabled: true</span><br><span class="line">      show-details: always</span><br><span class="line">    metrics:</span><br><span class="line">      enabled: true</span><br><span class="line">    prometheus:</span><br><span class="line">      enabled: true</span><br><span class="line">  metrics:</span><br><span class="line">    export:</span><br><span class="line">      prometheus:</span><br><span class="line">        enabled: true</span><br></pre></td></tr></table></figure>



<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这个扩展版本的多人聊天室具备了以下功能：</p>
<ol>
<li><strong>完整的用户系统</strong>：注册、登录、个人资料管理</li>
<li><strong>消息持久化</strong>：数据库存储所有聊天记录</li>
<li><strong>文件上传</strong>：支持图片、文件、语音消息</li>
<li><strong>表情系统</strong>：丰富的表情选择</li>
<li><strong>语音消息</strong>：录制和发送语音</li>
<li><strong>主题系统</strong>：亮色&#x2F;暗色主题切换</li>
<li><strong>搜索功能</strong>：消息搜索和用户搜索</li>
<li><strong>通知系统</strong>：桌面通知和声音提醒</li>
<li><strong>上下文菜单</strong>：消息操作（复制、回复、删除等）</li>
<li><strong>管理员功能</strong>：用户管理、消息管理</li>
<li><strong>Docker支持</strong>：容器化部署</li>
<li><strong>监控功能</strong>：Spring Boot Actuator集成</li>
<li><strong>性能优化</strong>：消息分页、缓存、WebSocket优化</li>
</ol>
<p>这个项目现在已经是一个功能完整的实时聊天应用，可以作为学习Java全栈开发的优秀示例。您可以根据需要进一步扩展，比如添加视频通话、群组管理、消息加密等功能。</p>
<p>本回答由 AI 生成，内容仅供参考，请仔细甄别。</p>
<p>进一步扩展</p>
<p>我们将在已有基础上进一步扩展，增加更多高级功能和优化。以下是一些扩展方向：</p>
<ol>
<li><strong>消息回执</strong>：消息发送状态（发送中、已发送、已读）</li>
<li><strong>消息撤回</strong>：用户可撤回已发送的消息</li>
<li><strong>消息收藏</strong>：收藏重要的消息</li>
<li><strong>聊天记录导出</strong>：导出聊天记录为文本或图片</li>
<li><strong>群组管理</strong>：创建群聊，设置群管理员，群公告等</li>
<li><strong>视频&#x2F;语音通话</strong>：集成WebRTC实现点对点通话</li>
<li><strong>AI聊天助手</strong>：集成AI聊天机器人</li>
<li><strong>消息翻译</strong>：支持将消息翻译成其他语言</li>
<li><strong>截图分享</strong>：截图并分享到聊天</li>
<li><strong>屏幕共享</strong>：在群组中共享屏幕</li>
</ol>
<p>由于篇幅限制，我们将选择其中几个功能进行实现。这里我们重点实现：</p>
<ol>
<li>消息回执（已读状态）</li>
<li>消息撤回</li>
<li>群组管理（创建群聊，群成员管理）</li>
</ol>
<h2 id="1-消息回执（已读状态）"><a href="#1-消息回执（已读状态）" class="headerlink" title="1. 消息回执（已读状态）"></a>1. 消息回执（已读状态）</h2><h3 id="1-1-数据库更新"><a href="#1-1-数据库更新" class="headerlink" title="1.1 数据库更新"></a>1.1 数据库更新</h3><p>在messages表中，我们已经有了is_read字段。同时，我们创建了message_read_status表来记录每个用户对每条消息的阅读状态。</p>
<h3 id="1-2-后端实现"><a href="#1-2-后端实现" class="headerlink" title="1.2 后端实现"></a>1.2 后端实现</h3><h4 id="1-2-1-消息已读状态更新接口"><a href="#1-2-1-消息已读状态更新接口" class="headerlink" title="1.2.1 消息已读状态更新接口"></a>1.2.1 消息已读状态更新接口</h4><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@MessageMapping(&quot;/chat.messageRead&quot;)</span><br><span class="line">public void messageRead(@Payload MessageReadRequest request, SimpMessageHeaderAccessor headerAccessor) &#123;</span><br><span class="line">    String username = (String) headerAccessor.getSessionAttributes().get(&quot;username&quot;);</span><br><span class="line">    Long messageId = request.getMessageId();</span><br><span class="line">    </span><br><span class="line">    // 更新消息阅读状态</span><br><span class="line">    messageService.markMessageAsRead(messageId, username);</span><br><span class="line">    </span><br><span class="line">    // 通知发送者消息已读（如果发送者在线）</span><br><span class="line">    Message message = messageService.getMessageById(messageId);</span><br><span class="line">    if (message != null &amp;&amp; message.getSender() != null) &#123;</span><br><span class="line">        ChatMessage readReceipt = new ChatMessage();</span><br><span class="line">        readReceipt.setType(ChatMessage.MessageType.READ_RECEIPT);</span><br><span class="line">        readReceipt.setSender(username);</span><br><span class="line">        readReceipt.setReceiver(message.getSender().getUsername());</span><br><span class="line">        readReceipt.setContent(messageId.toString());</span><br><span class="line">        readReceipt.setTimestamp(LocalDateTime.now());</span><br><span class="line">        </span><br><span class="line">        messagingTemplate.convertAndSendToUser(</span><br><span class="line">            message.getSender().getUsername(),</span><br><span class="line">            &quot;/queue/readReceipt&quot;,</span><br><span class="line">            readReceipt</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="1-2-2-前端发送已读回执"><a href="#1-2-2-前端发送已读回执" class="headerlink" title="1.2.2 前端发送已读回执"></a>1.2.2 前端发送已读回执</h4><p>当用户查看消息时，前端发送已读回执给服务器。</p>
<h3 id="1-3-前端实现"><a href="#1-3-前端实现" class="headerlink" title="1.3 前端实现"></a>1.3 前端实现</h3><p>在聊天界面中，当消息进入可视区域时，发送已读回执。</p>
<h2 id="2-消息撤回"><a href="#2-消息撤回" class="headerlink" title="2. 消息撤回"></a>2. 消息撤回</h2><h3 id="2-1-后端实现"><a href="#2-1-后端实现" class="headerlink" title="2.1 后端实现"></a>2.1 后端实现</h3><h4 id="2-1-1-消息撤回接口"><a href="#2-1-1-消息撤回接口" class="headerlink" title="2.1.1 消息撤回接口"></a>2.1.1 消息撤回接口</h4><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">@MessageMapping(&quot;/chat.recallMessage&quot;)</span><br><span class="line">public ChatMessage recallMessage(@Payload MessageRecallRequest request, SimpMessageHeaderAccessor headerAccessor) &#123;</span><br><span class="line">    String username = (String) headerAccessor.getSessionAttributes().get(&quot;username&quot;);</span><br><span class="line">    Long messageId = request.getMessageId();</span><br><span class="line">    </span><br><span class="line">    // 检查用户是否有权限撤回该消息（发送者或管理员）</span><br><span class="line">    Message message = messageService.getMessageById(messageId);</span><br><span class="line">    if (message == null || !message.getSender().getUsername().equals(username)) &#123;</span><br><span class="line">        // 如果不是发送者，检查是否是管理员</span><br><span class="line">        User currentUser = userService.findByUsername(username);</span><br><span class="line">        if (currentUser.getRole() != UserRole.ADMIN &amp;&amp; currentUser.getRole() != UserRole.MODERATOR) &#123;</span><br><span class="line">            throw new SecurityException(&quot;无权撤回该消息&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 标记消息为已撤回</span><br><span class="line">    messageService.recallMessage(messageId);</span><br><span class="line">    </span><br><span class="line">    // 广播消息撤回通知</span><br><span class="line">    ChatMessage recallMessage = new ChatMessage();</span><br><span class="line">    recallMessage.setType(ChatMessage.MessageType.RECALL);</span><br><span class="line">    recallMessage.setSender(username);</span><br><span class="line">    recallMessage.setContent(messageId.toString());</span><br><span class="line">    recallMessage.setTimestamp(LocalDateTime.now());</span><br><span class="line">    </span><br><span class="line">    // 如果是私聊，只发送给接收者；如果是群聊，发送到群</span><br><span class="line">    if (message.getReceiver() != null) &#123;</span><br><span class="line">        messagingTemplate.convertAndSendToUser(</span><br><span class="line">            message.getReceiver().getUsername(),</span><br><span class="line">            &quot;/queue/recall&quot;,</span><br><span class="line">            recallMessage</span><br><span class="line">        );</span><br><span class="line">        // 同时发送给自己</span><br><span class="line">        messagingTemplate.convertAndSendToUser(</span><br><span class="line">            username,</span><br><span class="line">            &quot;/queue/recall&quot;,</span><br><span class="line">            recallMessage</span><br><span class="line">        );</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        messagingTemplate.convertAndSend(&quot;/topic/public&quot;, recallMessage);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return recallMessage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-2-前端实现"><a href="#2-2-前端实现" class="headerlink" title="2.2 前端实现"></a>2.2 前端实现</h3><p>在消息上下文菜单中添加“撤回”选项，点击后发送撤回请求。</p>
<h2 id="3-群组管理"><a href="#3-群组管理" class="headerlink" title="3. 群组管理"></a>3. 群组管理</h2><h3 id="3-1-数据库更新"><a href="#3-1-数据库更新" class="headerlink" title="3.1 数据库更新"></a>3.1 数据库更新</h3><p>我们已经有了chat_rooms表和room_members表。</p>
<h3 id="3-2-后端实现"><a href="#3-2-后端实现" class="headerlink" title="3.2 后端实现"></a>3.2 后端实现</h3><h4 id="3-2-1-创建群组接口"><a href="#3-2-1-创建群组接口" class="headerlink" title="3.2.1 创建群组接口"></a>3.2.1 创建群组接口</h4><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(&quot;/api/rooms/create&quot;)</span><br><span class="line">public ResponseEntity&lt;?&gt; createRoom(@RequestBody CreateRoomRequest request, </span><br><span class="line">                                    @AuthenticationPrincipal UserPrincipal currentUser) &#123;</span><br><span class="line">    User creator = userService.findById(currentUser.getId());</span><br><span class="line">    </span><br><span class="line">    ChatRoom room = new ChatRoom();</span><br><span class="line">    room.setName(request.getName());</span><br><span class="line">    room.setDescription(request.getDescription());</span><br><span class="line">    room.setPublic(request.isPublic());</span><br><span class="line">    room.setCreatedBy(creator);</span><br><span class="line">    </span><br><span class="line">    ChatRoom savedRoom = roomService.createRoom(room, request.getMemberIds());</span><br><span class="line">    </span><br><span class="line">    return ResponseEntity.ok(savedRoom);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-2-2-群组消息处理"><a href="#3-2-2-群组消息处理" class="headerlink" title="3.2.2 群组消息处理"></a>3.2.2 群组消息处理</h4><p>修改消息发送逻辑，支持发送到群组。</p>
<h3 id="3-3-前端实现"><a href="#3-3-前端实现" class="headerlink" title="3.3 前端实现"></a>3.3 前端实现</h3><p>添加创建群组的界面，以及群组列表。</p>
<h2 id="4-其他扩展功能"><a href="#4-其他扩展功能" class="headerlink" title="4. 其他扩展功能"></a>4. 其他扩展功能</h2><h3 id="4-1-消息收藏"><a href="#4-1-消息收藏" class="headerlink" title="4.1 消息收藏"></a>4.1 消息收藏</h3><p>添加消息收藏功能，用户可以将重要的消息收藏起来，方便以后查看。</p>
<h3 id="4-2-聊天记录导出"><a href="#4-2-聊天记录导出" class="headerlink" title="4.2 聊天记录导出"></a>4.2 聊天记录导出</h3><p>提供将聊天记录导出为文本文件或图片的功能。</p>
<h3 id="4-3-截图分享"><a href="#4-3-截图分享" class="headerlink" title="4.3 截图分享"></a>4.3 截图分享</h3><p>使用HTML5的Canvas API实现截图功能，并上传到服务器分享。</p>
<h3 id="4-4-AI聊天助手"><a href="#4-4-AI聊天助手" class="headerlink" title="4.4 AI聊天助手"></a>4.4 AI聊天助手</h3><p>集成OpenAI的GPT API或类似的AI服务，提供智能聊天机器人。</p>
<h3 id="4-5-消息翻译"><a href="#4-5-消息翻译" class="headerlink" title="4.5 消息翻译"></a>4.5 消息翻译</h3><p>集成翻译API（如Google Translate），支持将消息翻译成用户指定的语言。</p>
<h2 id="5-性能优化"><a href="#5-性能优化" class="headerlink" title="5. 性能优化"></a>5. 性能优化</h2><h3 id="5-1-消息分页加载"><a href="#5-1-消息分页加载" class="headerlink" title="5.1 消息分页加载"></a>5.1 消息分页加载</h3><p>对于历史消息，采用分页加载，避免一次性加载过多消息导致性能问题。</p>
<h3 id="5-2-WebSocket连接优化"><a href="#5-2-WebSocket连接优化" class="headerlink" title="5.2 WebSocket连接优化"></a>5.2 WebSocket连接优化</h3><p>使用心跳机制保持连接，并处理重连逻辑。</p>
<h3 id="5-3-前端虚拟滚动"><a href="#5-3-前端虚拟滚动" class="headerlink" title="5.3 前端虚拟滚动"></a>5.3 前端虚拟滚动</h3><p>对于大量消息，使用虚拟滚动技术提高渲染性能。</p>
<h2 id="6-安全性增强"><a href="#6-安全性增强" class="headerlink" title="6. 安全性增强"></a>6. 安全性增强</h2><h3 id="6-1-输入验证和过滤"><a href="#6-1-输入验证和过滤" class="headerlink" title="6.1 输入验证和过滤"></a>6.1 输入验证和过滤</h3><p>对用户输入进行严格的验证和过滤，防止XSS攻击。</p>
<h3 id="6-2-文件上传安全"><a href="#6-2-文件上传安全" class="headerlink" title="6.2 文件上传安全"></a>6.2 文件上传安全</h3><p>对上传的文件进行病毒扫描，并限制文件类型和大小。</p>
<h3 id="6-3-通信加密"><a href="#6-3-通信加密" class="headerlink" title="6.3 通信加密"></a>6.3 通信加密</h3><p>使用WSS（WebSocket Secure）和HTTPS确保通信安全。</p>
<h2 id="7-部署和运维"><a href="#7-部署和运维" class="headerlink" title="7. 部署和运维"></a>7. 部署和运维</h2><h3 id="7-1-使用Docker-Compose部署"><a href="#7-1-使用Docker-Compose部署" class="headerlink" title="7.1 使用Docker Compose部署"></a>7.1 使用Docker Compose部署</h3><p>提供完整的Docker Compose部署文件，包括MySQL、Redis、Nginx和Spring Boot应用。</p>
<h3 id="7-2-日志和监控"><a href="#7-2-日志和监控" class="headerlink" title="7.2 日志和监控"></a>7.2 日志和监控</h3><p>集成ELK（Elasticsearch, Logstash, Kibana）进行日志收集和分析，使用Prometheus和Grafana进行监控。</p>
<h3 id="7-3-自动化测试"><a href="#7-3-自动化测试" class="headerlink" title="7.3 自动化测试"></a>7.3 自动化测试</h3><p>编写单元测试和集成测试，确保代码质量。</p>
<h2 id="8-总结"><a href="#8-总结" class="headerlink" title="8. 总结"></a>8. 总结</h2><p>通过以上扩展，我们的聊天室应用将变得更加强大和实用。这些功能涵盖了实时通信、社交互动、内容管理等多个方面，可以满足大多数聊天场景的需求。当然，根据实际需求，还可以进一步扩展其他功能，如视频通话、屏幕共享、游戏等。</p>
<p>由于篇幅限制，我们无法在这里提供所有功能的完整代码，但以上给出了关键的后端接口和前端思路。在实现时，请根据具体需求进行设计和编码。</p>
<h1 id="多人聊天室-企业级扩展方案"><a href="#多人聊天室-企业级扩展方案" class="headerlink" title="多人聊天室 - 企业级扩展方案"></a>多人聊天室 - 企业级扩展方案</h1><p>我将进一步扩展聊天室项目，增加企业级功能，包括：微服务架构、AI集成、视频通话、屏幕共享、分布式部署、监控告警等。</p>
<h2 id="扩展功能清单-1"><a href="#扩展功能清单-1" class="headerlink" title="扩展功能清单"></a>扩展功能清单</h2><ol>
<li><strong>微服务架构</strong> - 拆分为多个微服务</li>
<li><strong>AI聊天助手</strong> - 集成AI大模型</li>
<li><strong>视频通话</strong> - WebRTC视频会议</li>
<li><strong>屏幕共享</strong> - 共享桌面和应用</li>
<li><strong>分布式消息队列</strong> - Kafka&#x2F;RabbitMQ</li>
<li><strong>缓存优化</strong> - Redis集群</li>
<li><strong>实时协作</strong> - 白板、文档协作</li>
<li><strong>消息加密</strong> - 端到端加密</li>
<li><strong>行为分析</strong> - 用户行为追踪和分析</li>
<li><strong>API网关</strong> - Spring Cloud Gateway</li>
<li><strong>服务注册发现</strong> - Eureka&#x2F;Nacos</li>
<li><strong>配置中心</strong> - Spring Cloud Config</li>
<li><strong>链路追踪</strong> - Sleuth&#x2F;Zipkin</li>
<li><strong>容器编排</strong> - Kubernetes部署</li>
<li><strong>CI&#x2F;CD流水线</strong> - Jenkins&#x2F;GitLab CI</li>
</ol>
<h2 id="1-微服务架构设计"><a href="#1-微服务架构设计" class="headerlink" title="1. 微服务架构设计"></a>1. 微服务架构设计</h2><h3 id="1-1-项目结构"><a href="#1-1-项目结构" class="headerlink" title="1.1 项目结构"></a>1.1 项目结构</h3><p>text</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">chat-microservices/</span><br><span class="line">├── gateway/                    # API网关</span><br><span class="line">├── discovery/                  # 服务注册中心</span><br><span class="line">├── config/                     # 配置中心</span><br><span class="line">├── auth-service/              # 认证服务</span><br><span class="line">├── user-service/              # 用户服务</span><br><span class="line">├── chat-service/              # 聊天服务</span><br><span class="line">├── file-service/              # 文件服务</span><br><span class="line">├── notification-service/      # 通知服务</span><br><span class="line">├── ai-service/                # AI服务</span><br><span class="line">├── webrtc-service/            # WebRTC信令服务</span><br><span class="line">├── monitoring/                # 监控服务</span><br><span class="line">└── docker-compose.yml</span><br></pre></td></tr></table></figure>



<h3 id="1-2-API网关配置-Gateway"><a href="#1-2-API网关配置-Gateway" class="headerlink" title="1.2 API网关配置 (Gateway)"></a>1.2 API网关配置 (Gateway)</h3><p>yaml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"># application.yml</span><br><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">        - id: auth-service</span><br><span class="line">          uri: lb://AUTH-SERVICE</span><br><span class="line">          predicates:</span><br><span class="line">            - Path=/api/auth/**</span><br><span class="line">          filters:</span><br><span class="line">            - name: CircuitBreaker</span><br><span class="line">              args:</span><br><span class="line">                name: auth-service</span><br><span class="line">                fallbackUri: forward:/fallback/auth</span><br><span class="line">                </span><br><span class="line">        - id: user-service</span><br><span class="line">          uri: lb://USER-SERVICE</span><br><span class="line">          predicates:</span><br><span class="line">            - Path=/api/users/**,/api/profile/**</span><br><span class="line">          filters:</span><br><span class="line">            - StripPrefix=1</span><br><span class="line">            </span><br><span class="line">        - id: chat-service</span><br><span class="line">          uri: lb://CHAT-SERVICE</span><br><span class="line">          predicates:</span><br><span class="line">            - Path=/api/messages/**,/api/rooms/**,/api/chats/**</span><br><span class="line">          filters:</span><br><span class="line">            - StripPrefix=1</span><br><span class="line">            </span><br><span class="line">        - id: file-service</span><br><span class="line">          uri: lb://FILE-SERVICE</span><br><span class="line">          predicates:</span><br><span class="line">            - Path=/api/files/**,/api/upload/**</span><br><span class="line">          filters:</span><br><span class="line">            - StripPrefix=1</span><br><span class="line">            - name: RequestRateLimiter</span><br><span class="line">              args:</span><br><span class="line">                redis-rate-limiter.replenishRate: 10</span><br><span class="line">                redis-rate-limiter.burstCapacity: 20</span><br><span class="line">                </span><br><span class="line">        - id: ai-service</span><br><span class="line">          uri: lb://AI-SERVICE</span><br><span class="line">          predicates:</span><br><span class="line">            - Path=/api/ai/**</span><br><span class="line">          filters:</span><br><span class="line">            - StripPrefix=1</span><br><span class="line">            </span><br><span class="line">        - id: webrtc-service</span><br><span class="line">          uri: lb://WEBRTC-SERVICE</span><br><span class="line">          predicates:</span><br><span class="line">            - Path=/api/webrtc/**</span><br><span class="line">          filters:</span><br><span class="line">            - StripPrefix=1</span><br><span class="line">            </span><br><span class="line">      default-filters:</span><br><span class="line">        - name: GlobalFilter</span><br><span class="line">        - name: JwtAuthFilter</span><br><span class="line">        - name: RateLimiter</span><br><span class="line">          args:</span><br><span class="line">            key-resolver: &quot;#&#123;@userKeyResolver&#125;&quot;</span><br><span class="line">            redis-rate-limiter.replenishRate: 100</span><br><span class="line">            redis-rate-limiter.burstCapacity: 200</span><br><span class="line">            </span><br><span class="line">      globalcors:</span><br><span class="line">        cors-configurations:</span><br><span class="line">          &#x27;[/**]&#x27;:</span><br><span class="line">            allowedOrigins: &quot;*&quot;</span><br><span class="line">            allowedMethods: &quot;*&quot;</span><br><span class="line">            allowedHeaders: &quot;*&quot;</span><br><span class="line">            allowCredentials: true</span><br><span class="line">            </span><br><span class="line">    circuitbreaker:</span><br><span class="line">      instances:</span><br><span class="line">        auth-service:</span><br><span class="line">          slidingWindowSize: 10</span><br><span class="line">          minimumNumberOfCalls: 5</span><br><span class="line">          permittedNumberOfCallsInHalfOpenState: 3</span><br><span class="line">          automaticTransitionFromOpenToHalfOpenEnabled: true</span><br><span class="line">          waitDurationInOpenState: 5000</span><br><span class="line">          failureRateThreshold: 50</span><br><span class="line">          slowCallRateThreshold: 100</span><br><span class="line">          slowCallDurationThreshold: 2000</span><br><span class="line">          </span><br><span class="line">    loadbalancer:</span><br><span class="line">      configurations:</span><br><span class="line">        default:</span><br><span class="line">          health-check:</span><br><span class="line">            initial-delay: 2000</span><br><span class="line">            interval: 30000</span><br><span class="line"></span><br><span class="line"># 限流配置</span><br><span class="line">resilience4j:</span><br><span class="line">  ratelimiter:</span><br><span class="line">    instances:</span><br><span class="line">      user-service:</span><br><span class="line">        limit-for-period: 100</span><br><span class="line">        limit-refresh-period: 1s</span><br><span class="line">        timeout-duration: 0</span><br><span class="line">        register-health-indicator: true</span><br></pre></td></tr></table></figure>



<h2 id="2-AI聊天助手集成"><a href="#2-AI聊天助手集成" class="headerlink" title="2. AI聊天助手集成"></a>2. AI聊天助手集成</h2><h3 id="2-1-AI服务配置"><a href="#2-1-AI服务配置" class="headerlink" title="2.1 AI服务配置"></a>2.1 AI服务配置</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.ai;</span><br><span class="line"></span><br><span class="line">import org.springframework.ai.chat.ChatClient;</span><br><span class="line">import org.springframework.ai.chat.ChatResponse;</span><br><span class="line">import org.springframework.ai.chat.prompt.Prompt;</span><br><span class="line">import org.springframework.ai.chat.prompt.PromptTemplate;</span><br><span class="line">import org.springframework.ai.chat.messages.Message;</span><br><span class="line">import org.springframework.ai.chat.messages.UserMessage;</span><br><span class="line">import org.springframework.ai.chat.messages.AssistantMessage;</span><br><span class="line">import org.springframework.ai.chat.messages.SystemMessage;</span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">@Service</span><br><span class="line">public class AIService &#123;</span><br><span class="line">    </span><br><span class="line">    private final ChatClient chatClient;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;ai.model&#125;&quot;)</span><br><span class="line">    private String model;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;ai.temperature&#125;&quot;)</span><br><span class="line">    private double temperature;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;ai.max-tokens&#125;&quot;)</span><br><span class="line">    private int maxTokens;</span><br><span class="line">    </span><br><span class="line">    public AIService(ChatClient chatClient) &#123;</span><br><span class="line">        this.chatClient = chatClient;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public ChatResponse chat(String userMessage, String context) &#123;</span><br><span class="line">        SystemMessage systemMessage = new SystemMessage(&quot;&quot;&quot;</span><br><span class="line">            你是一个友好的聊天助手，帮助用户在聊天室中解决问题和提供信息。</span><br><span class="line">            请保持回答简洁、有帮助且友好。</span><br><span class="line">            当前聊天上下文：%s</span><br><span class="line">            &quot;&quot;&quot;.formatted(context));</span><br><span class="line">        </span><br><span class="line">        UserMessage userMsg = new UserMessage(userMessage);</span><br><span class="line">        </span><br><span class="line">        Prompt prompt = new Prompt(List.of(systemMessage, userMsg));</span><br><span class="line">        </span><br><span class="line">        return chatClient.call(prompt);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public String summarizeConversation(List&lt;Message&gt; messages) &#123;</span><br><span class="line">        PromptTemplate promptTemplate = new PromptTemplate(&quot;&quot;&quot;</span><br><span class="line">            请总结以下对话的主要内容：</span><br><span class="line">            &#123;conversation&#125;</span><br><span class="line">            </span><br><span class="line">            总结要求：</span><br><span class="line">            1. 提取关键信息</span><br><span class="line">            2. 总结讨论主题</span><br><span class="line">            3. 不超过200字</span><br><span class="line">            &quot;&quot;&quot;);</span><br><span class="line">        </span><br><span class="line">        String conversationText = messages.stream()</span><br><span class="line">            .map(msg -&gt; msg.getMessageType().name() + &quot;: &quot; + msg.getContent())</span><br><span class="line">            .reduce(&quot;&quot;, (a, b) -&gt; a + &quot;\n&quot; + b);</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, Object&gt; params = Map.of(&quot;conversation&quot;, conversationText);</span><br><span class="line">        Prompt prompt = promptTemplate.create(params);</span><br><span class="line">        </span><br><span class="line">        ChatResponse response = chatClient.call(prompt);</span><br><span class="line">        return response.getResult().getOutput().getContent();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public String translateText(String text, String targetLanguage) &#123;</span><br><span class="line">        PromptTemplate promptTemplate = new PromptTemplate(&quot;&quot;&quot;</span><br><span class="line">            请将以下文本翻译成&#123;targetLanguage&#125;：</span><br><span class="line">            &#123;text&#125;</span><br><span class="line">            </span><br><span class="line">            要求：</span><br><span class="line">            1. 保持原意</span><br><span class="line">            2. 语言自然流畅</span><br><span class="line">            3. 如果是聊天用语，保持口语化</span><br><span class="line">            &quot;&quot;&quot;);</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, Object&gt; params = Map.of(</span><br><span class="line">            &quot;text&quot;, text,</span><br><span class="line">            &quot;targetLanguage&quot;, targetLanguage</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        Prompt prompt = promptTemplate.create(params);</span><br><span class="line">        ChatResponse response = chatClient.call(prompt);</span><br><span class="line">        return response.getResult().getOutput().getContent();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public String generateResponseSuggestion(String conversation) &#123;</span><br><span class="line">        PromptTemplate promptTemplate = new PromptTemplate(&quot;&quot;&quot;</span><br><span class="line">            基于以下对话，生成3个可能的回复建议：</span><br><span class="line">            &#123;conversation&#125;</span><br><span class="line">            </span><br><span class="line">            要求：</span><br><span class="line">            1. 回复要自然、相关</span><br><span class="line">            2. 风格多样（提问、陈述、表情等）</span><br><span class="line">            3. 每个建议不超过20字</span><br><span class="line">            4. 格式：用换行分隔每个建议</span><br><span class="line">            &quot;&quot;&quot;);</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, Object&gt; params = Map.of(&quot;conversation&quot;, conversation);</span><br><span class="line">        Prompt prompt = promptTemplate.create(params);</span><br><span class="line">        </span><br><span class="line">        ChatResponse response = chatClient.call(prompt);</span><br><span class="line">        return response.getResult().getOutput().getContent();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public ChatResponse moderateContent(String content) &#123;</span><br><span class="line">        SystemMessage systemMessage = new SystemMessage(&quot;&quot;&quot;</span><br><span class="line">            你是一个内容审核助手。请分析以下内容是否包含：</span><br><span class="line">            1. 不当言论或侮辱性语言</span><br><span class="line">            2. 政治敏感内容</span><br><span class="line">            3. 广告或垃圾信息</span><br><span class="line">            4. 暴力或危险内容</span><br><span class="line">            </span><br><span class="line">            请给出审核结果：</span><br><span class="line">            - 是否通过</span><br><span class="line">            - 风险等级（低/中/高）</span><br><span class="line">            - 理由</span><br><span class="line">            &quot;&quot;&quot;);</span><br><span class="line">        </span><br><span class="line">        UserMessage userMsg = new UserMessage(content);</span><br><span class="line">        Prompt prompt = new Prompt(List.of(systemMessage, userMsg));</span><br><span class="line">        </span><br><span class="line">        return chatClient.call(prompt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-2-AI控制器"><a href="#2-2-AI控制器" class="headerlink" title="2.2 AI控制器"></a>2.2 AI控制器</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.ai.controller;</span><br><span class="line"></span><br><span class="line">import com.chatroom.ai.AIService;</span><br><span class="line">import com.chatroom.dto.ApiResponse;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/api/ai&quot;)</span><br><span class="line">public class AIController &#123;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private AIService aiService;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/chat&quot;)</span><br><span class="line">    public ApiResponse chat(@RequestBody Map&lt;String, String&gt; request) &#123;</span><br><span class="line">        String message = request.get(&quot;message&quot;);</span><br><span class="line">        String context = request.get(&quot;context&quot;);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            var response = aiService.chat(message, context);</span><br><span class="line">            String content = response.getResult().getOutput().getContent();</span><br><span class="line">            </span><br><span class="line">            return new ApiResponse(true, &quot;AI回复生成成功&quot;, content);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            return new ApiResponse(false, &quot;AI服务暂时不可用&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/translate&quot;)</span><br><span class="line">    public ApiResponse translate(@RequestBody Map&lt;String, String&gt; request) &#123;</span><br><span class="line">        String text = request.get(&quot;text&quot;);</span><br><span class="line">        String targetLanguage = request.get(&quot;targetLanguage&quot;);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            String translated = aiService.translateText(text, targetLanguage);</span><br><span class="line">            return new ApiResponse(true, &quot;翻译成功&quot;, translated);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            return new ApiResponse(false, &quot;翻译服务暂时不可用&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/suggest&quot;)</span><br><span class="line">    public ApiResponse suggest(@RequestBody Map&lt;String, String&gt; request) &#123;</span><br><span class="line">        String conversation = request.get(&quot;conversation&quot;);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            String suggestions = aiService.generateResponseSuggestion(conversation);</span><br><span class="line">            List&lt;String&gt; suggestionList = List.of(suggestions.split(&quot;\n&quot;));</span><br><span class="line">            </span><br><span class="line">            return new ApiResponse(true, &quot;回复建议生成成功&quot;, suggestionList);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            return new ApiResponse(false, &quot;建议生成失败&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/moderate&quot;)</span><br><span class="line">    public ApiResponse moderate(@RequestBody Map&lt;String, String&gt; request) &#123;</span><br><span class="line">        String content = request.get(&quot;content&quot;);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            var response = aiService.moderateContent(content);</span><br><span class="line">            String result = response.getResult().getOutput().getContent();</span><br><span class="line">            </span><br><span class="line">            return new ApiResponse(true, &quot;内容审核完成&quot;, result);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            return new ApiResponse(false, &quot;审核服务暂时不可用&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/summarize&quot;)</span><br><span class="line">    public ApiResponse summarize(@RequestBody Map&lt;String, Object&gt; request) &#123;</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">        List&lt;Map&lt;String, String&gt;&gt; messages = (List&lt;Map&lt;String, String&gt;&gt;) request.get(&quot;messages&quot;);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            // 转换消息格式</span><br><span class="line">            List&lt;org.springframework.ai.chat.messages.Message&gt; aiMessages = messages.stream()</span><br><span class="line">                .map(msg -&gt; &#123;</span><br><span class="line">                    String role = msg.get(&quot;role&quot;);</span><br><span class="line">                    String content = msg.get(&quot;content&quot;);</span><br><span class="line">                    </span><br><span class="line">                    return switch (role.toUpperCase()) &#123;</span><br><span class="line">                        case &quot;USER&quot; -&gt; new org.springframework.ai.chat.messages.UserMessage(content);</span><br><span class="line">                        case &quot;ASSISTANT&quot; -&gt; new org.springframework.ai.chat.messages.AssistantMessage(content);</span><br><span class="line">                        default -&gt; new org.springframework.ai.chat.messages.SystemMessage(content);</span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;)</span><br><span class="line">                .toList();</span><br><span class="line">            </span><br><span class="line">            String summary = aiService.summarizeConversation(aiMessages);</span><br><span class="line">            return new ApiResponse(true, &quot;对话总结生成成功&quot;, summary);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            return new ApiResponse(false, &quot;总结生成失败&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-3-AI配置类"><a href="#2-3-AI配置类" class="headerlink" title="2.3 AI配置类"></a>2.3 AI配置类</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.ai.config;</span><br><span class="line"></span><br><span class="line">import org.springframework.ai.autoconfigure.openai.OpenAiAutoConfiguration;</span><br><span class="line">import org.springframework.ai.chat.ChatClient;</span><br><span class="line">import org.springframework.ai.openai.OpenAiChatClient;</span><br><span class="line">import org.springframework.ai.openai.OpenAiChatOptions;</span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">public class AIConfig &#123;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;ai.openai.api-key&#125;&quot;)</span><br><span class="line">    private String apiKey;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;ai.openai.model:gpt-3.5-turbo&#125;&quot;)</span><br><span class="line">    private String model;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;ai.openai.temperature:0.7&#125;&quot;)</span><br><span class="line">    private double temperature;</span><br><span class="line">    </span><br><span class="line">    @Value(&quot;$&#123;ai.openai.max-tokens:1000&#125;&quot;)</span><br><span class="line">    private int maxTokens;</span><br><span class="line">    </span><br><span class="line">    @Bean</span><br><span class="line">    public ChatClient chatClient() &#123;</span><br><span class="line">        OpenAiChatOptions options = OpenAiChatOptions.builder()</span><br><span class="line">            .model(model)</span><br><span class="line">            .temperature(temperature)</span><br><span class="line">            .maxTokens(maxTokens)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        return new OpenAiChatClient(apiKey, options);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-WebRTC视频通话"><a href="#3-WebRTC视频通话" class="headerlink" title="3. WebRTC视频通话"></a>3. WebRTC视频通话</h2><h3 id="3-1-信令服务器"><a href="#3-1-信令服务器" class="headerlink" title="3.1 信令服务器"></a>3.1 信令服务器</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.webrtc;</span><br><span class="line"></span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line">import org.springframework.web.socket.*;</span><br><span class="line">import org.springframework.web.socket.handler.TextWebSocketHandler;</span><br><span class="line"></span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">public class WebRTCSignalingHandler extends TextWebSocketHandler &#123;</span><br><span class="line">    </span><br><span class="line">    private final Map&lt;String, WebSocketSession&gt; sessions = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    private final Map&lt;String, String&gt; userRooms = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void afterConnectionEstablished(WebSocketSession session) throws Exception &#123;</span><br><span class="line">        String userId = getUserId(session);</span><br><span class="line">        sessions.put(userId, session);</span><br><span class="line">        </span><br><span class="line">        System.out.println(&quot;WebRTC连接建立: &quot; + userId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    protected void handleTextMessage(WebSocketSession session, TextMessage message) throws Exception &#123;</span><br><span class="line">        String payload = message.getPayload();</span><br><span class="line">        SignalingMessage signalingMessage = SignalingMessage.fromJson(payload);</span><br><span class="line">        </span><br><span class="line">        String userId = getUserId(session);</span><br><span class="line">        String targetUserId = signalingMessage.getTarget();</span><br><span class="line">        </span><br><span class="line">        switch (signalingMessage.getType()) &#123;</span><br><span class="line">            case &quot;offer&quot;:</span><br><span class="line">            case &quot;answer&quot;:</span><br><span class="line">            case &quot;candidate&quot;:</span><br><span class="line">                // 转发到目标用户</span><br><span class="line">                forwardMessage(userId, targetUserId, signalingMessage);</span><br><span class="line">                break;</span><br><span class="line">                </span><br><span class="line">            case &quot;join-room&quot;:</span><br><span class="line">                String roomId = signalingMessage.getRoomId();</span><br><span class="line">                joinRoom(userId, roomId);</span><br><span class="line">                broadcastToRoom(roomId, userId, new SignalingMessage(&quot;user-joined&quot;, userId, null));</span><br><span class="line">                break;</span><br><span class="line">                </span><br><span class="line">            case &quot;leave-room&quot;:</span><br><span class="line">                leaveRoom(userId);</span><br><span class="line">                break;</span><br><span class="line">                </span><br><span class="line">            case &quot;get-users&quot;:</span><br><span class="line">                String room = userRooms.get(userId);</span><br><span class="line">                if (room != null) &#123;</span><br><span class="line">                    sendRoomUsers(userId, room);</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void forwardMessage(String from, String to, SignalingMessage message) &#123;</span><br><span class="line">        WebSocketSession targetSession = sessions.get(to);</span><br><span class="line">        if (targetSession != null &amp;&amp; targetSession.isOpen()) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                targetSession.sendMessage(new TextMessage(message.toJson()));</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void joinRoom(String userId, String roomId) &#123;</span><br><span class="line">        userRooms.put(userId, roomId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void leaveRoom(String userId) &#123;</span><br><span class="line">        String roomId = userRooms.remove(userId);</span><br><span class="line">        if (roomId != null) &#123;</span><br><span class="line">            broadcastToRoom(roomId, userId, new SignalingMessage(&quot;user-left&quot;, userId, null));</span><br><span class="line">        &#125;</span><br><span class="line">        sessions.remove(userId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void broadcastToRoom(String roomId, String from, SignalingMessage message) &#123;</span><br><span class="line">        sessions.forEach((userId, session) -&gt; &#123;</span><br><span class="line">            if (!userId.equals(from) &amp;&amp; roomId.equals(userRooms.get(userId))) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    session.sendMessage(new TextMessage(message.toJson()));</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void sendRoomUsers(String userId, String roomId) &#123;</span><br><span class="line">        WebSocketSession session = sessions.get(userId);</span><br><span class="line">        if (session != null &amp;&amp; session.isOpen()) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                var users = userRooms.entrySet().stream()</span><br><span class="line">                    .filter(entry -&gt; roomId.equals(entry.getValue()))</span><br><span class="line">                    .map(Map.Entry::getKey)</span><br><span class="line">                    .filter(id -&gt; !id.equals(userId))</span><br><span class="line">                    .toList();</span><br><span class="line">                </span><br><span class="line">                SignalingMessage message = new SignalingMessage(&quot;room-users&quot;, null, Map.of(&quot;users&quot;, users));</span><br><span class="line">                session.sendMessage(new TextMessage(message.toJson()));</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private String getUserId(WebSocketSession session) &#123;</span><br><span class="line">        Map&lt;String, Object&gt; attributes = session.getAttributes();</span><br><span class="line">        return attributes.get(&quot;userId&quot;).toString();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void afterConnectionClosed(WebSocketSession session, CloseStatus status) throws Exception &#123;</span><br><span class="line">        String userId = getUserId(session);</span><br><span class="line">        leaveRoom(userId);</span><br><span class="line">        System.out.println(&quot;WebRTC连接关闭: &quot; + userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-2-信令消息类"><a href="#3-2-信令消息类" class="headerlink" title="3.2 信令消息类"></a>3.2 信令消息类</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.webrtc;</span><br><span class="line"></span><br><span class="line">import com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line">import lombok.Data;</span><br><span class="line"></span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">@Data</span><br><span class="line">public class SignalingMessage &#123;</span><br><span class="line">    private String type;</span><br><span class="line">    private String target;</span><br><span class="line">    private Map&lt;String, Object&gt; data;</span><br><span class="line">    </span><br><span class="line">    public SignalingMessage() &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    public SignalingMessage(String type, String target, Map&lt;String, Object&gt; data) &#123;</span><br><span class="line">        this.type = type;</span><br><span class="line">        this.target = target;</span><br><span class="line">        this.data = data;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public String toJson() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            ObjectMapper mapper = new ObjectMapper();</span><br><span class="line">            return mapper.writeValueAsString(this);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public static SignalingMessage fromJson(String json) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            ObjectMapper mapper = new ObjectMapper();</span><br><span class="line">            return mapper.readValue(json, SignalingMessage.class);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-3-WebRTC配置"><a href="#3-3-WebRTC配置" class="headerlink" title="3.3 WebRTC配置"></a>3.3 WebRTC配置</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.webrtc.config;</span><br><span class="line"></span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.web.socket.config.annotation.EnableWebSocket;</span><br><span class="line">import org.springframework.web.socket.config.annotation.WebSocketConfigurer;</span><br><span class="line">import org.springframework.web.socket.config.annotation.WebSocketHandlerRegistry;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">@EnableWebSocket</span><br><span class="line">public class WebRTCConfig implements WebSocketConfigurer &#123;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void registerWebSocketHandlers(WebSocketHandlerRegistry registry) &#123;</span><br><span class="line">        registry.addHandler(new WebRTCSignalingHandler(), &quot;/ws/webrtc&quot;)</span><br><span class="line">                .setAllowedOriginPatterns(&quot;*&quot;)</span><br><span class="line">                .addInterceptors(new WebRTCAuthInterceptor());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-前端视频通话实现"><a href="#4-前端视频通话实现" class="headerlink" title="4. 前端视频通话实现"></a>4. 前端视频通话实现</h2><h3 id="4-1-WebRTC前端组件"><a href="#4-1-WebRTC前端组件" class="headerlink" title="4.1 WebRTC前端组件"></a>4.1 WebRTC前端组件</h3><p>javascript</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br></pre></td><td class="code"><pre><span class="line">// webrtc.js</span><br><span class="line">class WebRTCManager &#123;</span><br><span class="line">    constructor() &#123;</span><br><span class="line">        this.localStream = null;</span><br><span class="line">        this.peerConnections = &#123;&#125;;</span><br><span class="line">        this.dataChannels = &#123;&#125;;</span><br><span class="line">        this.socket = null;</span><br><span class="line">        this.userId = null;</span><br><span class="line">        this.roomId = null;</span><br><span class="line">        this.configuration = &#123;</span><br><span class="line">            iceServers: [</span><br><span class="line">                &#123; urls: &#x27;stun:stun.l.google.com:19302&#x27; &#125;,</span><br><span class="line">                &#123; urls: &#x27;stun:stun1.l.google.com:19302&#x27; &#125;,</span><br><span class="line">                &#123; urls: &#x27;stun:stun2.l.google.com:19302&#x27; &#125;,</span><br><span class="line">                &#123; urls: &#x27;stun:stun3.l.google.com:19302&#x27; &#125;,</span><br><span class="line">                &#123; urls: &#x27;stun:stun4.l.google.com:19302&#x27; &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        this.init();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    init() &#123;</span><br><span class="line">        this.setupMediaDevices();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    async setupMediaDevices() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // 检查媒体设备权限</span><br><span class="line">            const devices = await navigator.mediaDevices.enumerateDevices();</span><br><span class="line">            console.log(&#x27;可用设备:&#x27;, devices);</span><br><span class="line">        &#125; catch (error) &#123;</span><br><span class="line">            console.error(&#x27;设备枚举失败:&#x27;, error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    async connectToSignaling(token) &#123;</span><br><span class="line">        return new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">            this.socket = new WebSocket(`ws://$&#123;window.location.host&#125;/ws/webrtc?token=$&#123;token&#125;`);</span><br><span class="line">            </span><br><span class="line">            this.socket.onopen = () =&gt; &#123;</span><br><span class="line">                console.log(&#x27;WebRTC信令连接已建立&#x27;);</span><br><span class="line">                resolve();</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            this.socket.onmessage = (event) =&gt; &#123;</span><br><span class="line">                this.handleSignalingMessage(JSON.parse(event.data));</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            this.socket.onerror = (error) =&gt; &#123;</span><br><span class="line">                console.error(&#x27;WebRTC信令错误:&#x27;, error);</span><br><span class="line">                reject(error);</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            this.socket.onclose = () =&gt; &#123;</span><br><span class="line">                console.log(&#x27;WebRTC信令连接已关闭&#x27;);</span><br><span class="line">                this.cleanup();</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    async joinRoom(roomId, userId) &#123;</span><br><span class="line">        this.roomId = roomId;</span><br><span class="line">        this.userId = userId;</span><br><span class="line">        </span><br><span class="line">        await this.connectToSignaling(localStorage.getItem(&#x27;chat_token&#x27;));</span><br><span class="line">        </span><br><span class="line">        // 发送加入房间消息</span><br><span class="line">        this.sendSignalingMessage(&#123;</span><br><span class="line">            type: &#x27;join-room&#x27;,</span><br><span class="line">            roomId: roomId,</span><br><span class="line">            target: null,</span><br><span class="line">            data: &#123; userId: userId &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    async startVideoCall(options = &#123;&#125;) &#123;</span><br><span class="line">        const constraints = &#123;</span><br><span class="line">            video: options.video !== false ? &#123;</span><br><span class="line">                width: &#123; ideal: 1280 &#125;,</span><br><span class="line">                height: &#123; ideal: 720 &#125;,</span><br><span class="line">                frameRate: &#123; ideal: 30 &#125;</span><br><span class="line">            &#125; : false,</span><br><span class="line">            audio: options.audio !== false</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            this.localStream = await navigator.mediaDevices.getUserMedia(constraints);</span><br><span class="line">            this.onLocalStream(this.localStream);</span><br><span class="line">            </span><br><span class="line">            // 获取房间内其他用户</span><br><span class="line">            this.sendSignalingMessage(&#123;</span><br><span class="line">                type: &#x27;get-users&#x27;,</span><br><span class="line">                roomId: this.roomId,</span><br><span class="line">                target: null,</span><br><span class="line">                data: &#123;&#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            return true;</span><br><span class="line">        &#125; catch (error) &#123;</span><br><span class="line">            console.error(&#x27;获取媒体流失败:&#x27;, error);</span><br><span class="line">            throw error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    async startScreenShare() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            const stream = await navigator.mediaDevices.getDisplayMedia(&#123;</span><br><span class="line">                video: &#123;</span><br><span class="line">                    displaySurface: &#x27;monitor&#x27;,</span><br><span class="line">                    frameRate: &#123; ideal: 30 &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                audio: false</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            // 替换视频轨道</span><br><span class="line">            const videoTrack = stream.getVideoTracks()[0];</span><br><span class="line">            if (videoTrack) &#123;</span><br><span class="line">                this.replaceVideoTrack(videoTrack);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 监听停止共享</span><br><span class="line">            videoTrack.onended = () =&gt; &#123;</span><br><span class="line">                this.restoreCameraVideo();</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            return stream;</span><br><span class="line">        &#125; catch (error) &#123;</span><br><span class="line">            console.error(&#x27;屏幕共享失败:&#x27;, error);</span><br><span class="line">            throw error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    async createPeerConnection(targetUserId) &#123;</span><br><span class="line">        const pc = new RTCPeerConnection(this.configuration);</span><br><span class="line">        </span><br><span class="line">        // 添加本地流</span><br><span class="line">        if (this.localStream) &#123;</span><br><span class="line">            this.localStream.getTracks().forEach(track =&gt; &#123;</span><br><span class="line">                pc.addTrack(track, this.localStream);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 创建数据通道</span><br><span class="line">        const dataChannel = pc.createDataChannel(&#x27;chat&#x27;, &#123;</span><br><span class="line">            ordered: true,</span><br><span class="line">            maxRetransmits: 3</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        this.setupDataChannel(dataChannel, targetUserId);</span><br><span class="line">        </span><br><span class="line">        // ICE Candidate处理</span><br><span class="line">        pc.onicecandidate = (event) =&gt; &#123;</span><br><span class="line">            if (event.candidate) &#123;</span><br><span class="line">                this.sendSignalingMessage(&#123;</span><br><span class="line">                    type: &#x27;candidate&#x27;,</span><br><span class="line">                    target: targetUserId,</span><br><span class="line">                    data: &#123;</span><br><span class="line">                        candidate: event.candidate,</span><br><span class="line">                        sdpMid: event.candidate.sdpMid,</span><br><span class="line">                        sdpMLineIndex: event.candidate.sdpMLineIndex</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        // 连接状态变化</span><br><span class="line">        pc.onconnectionstatechange = () =&gt; &#123;</span><br><span class="line">            console.log(`与 $&#123;targetUserId&#125; 的连接状态:`, pc.connectionState);</span><br><span class="line">            </span><br><span class="line">            if (pc.connectionState === &#x27;connected&#x27;) &#123;</span><br><span class="line">                this.onPeerConnected(targetUserId);</span><br><span class="line">            &#125; else if (pc.connectionState === &#x27;disconnected&#x27; || </span><br><span class="line">                       pc.connectionState === &#x27;failed&#x27; || </span><br><span class="line">                       pc.connectionState === &#x27;closed&#x27;) &#123;</span><br><span class="line">                this.cleanupPeerConnection(targetUserId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        // 远程流到达</span><br><span class="line">        pc.ontrack = (event) =&gt; &#123;</span><br><span class="line">            this.onRemoteStream(targetUserId, event.streams[0]);</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        this.peerConnections[targetUserId] = pc;</span><br><span class="line">        return pc;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    async createOffer(targetUserId) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            const pc = await this.createPeerConnection(targetUserId);</span><br><span class="line">            const offer = await pc.createOffer(&#123;</span><br><span class="line">                offerToReceiveAudio: true,</span><br><span class="line">                offerToReceiveVideo: true</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            await pc.setLocalDescription(offer);</span><br><span class="line">            </span><br><span class="line">            this.sendSignalingMessage(&#123;</span><br><span class="line">                type: &#x27;offer&#x27;,</span><br><span class="line">                target: targetUserId,</span><br><span class="line">                data: &#123; sdp: offer &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; catch (error) &#123;</span><br><span class="line">            console.error(&#x27;创建Offer失败:&#x27;, error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    async handleOffer(fromUserId, sdp) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            const pc = await this.createPeerConnection(fromUserId);</span><br><span class="line">            await pc.setRemoteDescription(new RTCSessionDescription(sdp));</span><br><span class="line">            </span><br><span class="line">            const answer = await pc.createAnswer();</span><br><span class="line">            await pc.setLocalDescription(answer);</span><br><span class="line">            </span><br><span class="line">            this.sendSignalingMessage(&#123;</span><br><span class="line">                type: &#x27;answer&#x27;,</span><br><span class="line">                target: fromUserId,</span><br><span class="line">                data: &#123; sdp: answer &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; catch (error) &#123;</span><br><span class="line">            console.error(&#x27;处理Offer失败:&#x27;, error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    async handleAnswer(fromUserId, sdp) &#123;</span><br><span class="line">        const pc = this.peerConnections[fromUserId];</span><br><span class="line">        if (pc) &#123;</span><br><span class="line">            await pc.setRemoteDescription(new RTCSessionDescription(sdp));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    async handleCandidate(fromUserId, candidate) &#123;</span><br><span class="line">        const pc = this.peerConnections[fromUserId];</span><br><span class="line">        if (pc &amp;&amp; pc.remoteDescription) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                await pc.addIceCandidate(new RTCIceCandidate(candidate));</span><br><span class="line">            &#125; catch (error) &#123;</span><br><span class="line">                console.error(&#x27;添加ICE Candidate失败:&#x27;, error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    setupDataChannel(dataChannel, targetUserId) &#123;</span><br><span class="line">        dataChannel.onopen = () =&gt; &#123;</span><br><span class="line">            console.log(`与 $&#123;targetUserId&#125; 的数据通道已打开`);</span><br><span class="line">            this.onDataChannelOpen(targetUserId, dataChannel);</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        dataChannel.onmessage = (event) =&gt; &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                const message = JSON.parse(event.data);</span><br><span class="line">                this.onDataChannelMessage(targetUserId, message);</span><br><span class="line">            &#125; catch (error) &#123;</span><br><span class="line">                console.error(&#x27;解析数据通道消息失败:&#x27;, error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        dataChannel.onclose = () =&gt; &#123;</span><br><span class="line">            console.log(`与 $&#123;targetUserId&#125; 的数据通道已关闭`);</span><br><span class="line">            this.onDataChannelClose(targetUserId);</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        this.dataChannels[targetUserId] = dataChannel;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    sendDataMessage(targetUserId, message) &#123;</span><br><span class="line">        const dataChannel = this.dataChannels[targetUserId];</span><br><span class="line">        if (dataChannel &amp;&amp; dataChannel.readyState === &#x27;open&#x27;) &#123;</span><br><span class="line">            dataChannel.send(JSON.stringify(message));</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    broadcastDataMessage(message, excludeUserId = null) &#123;</span><br><span class="line">        Object.entries(this.dataChannels).forEach(([userId, dataChannel]) =&gt; &#123;</span><br><span class="line">            if (userId !== excludeUserId &amp;&amp; dataChannel.readyState === &#x27;open&#x27;) &#123;</span><br><span class="line">                dataChannel.send(JSON.stringify(message));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    replaceVideoTrack(newTrack) &#123;</span><br><span class="line">        Object.values(this.peerConnections).forEach(pc =&gt; &#123;</span><br><span class="line">            const senders = pc.getSenders();</span><br><span class="line">            const videoSender = senders.find(sender =&gt; </span><br><span class="line">                sender.track &amp;&amp; sender.track.kind === &#x27;video&#x27;</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            if (videoSender) &#123;</span><br><span class="line">                videoSender.replaceTrack(newTrack);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    restoreCameraVideo() &#123;</span><br><span class="line">        if (this.localStream) &#123;</span><br><span class="line">            const videoTrack = this.localStream.getVideoTracks()[0];</span><br><span class="line">            if (videoTrack) &#123;</span><br><span class="line">                this.replaceVideoTrack(videoTrack);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    async toggleVideo(enabled) &#123;</span><br><span class="line">        if (this.localStream) &#123;</span><br><span class="line">            const videoTrack = this.localStream.getVideoTracks()[0];</span><br><span class="line">            if (videoTrack) &#123;</span><br><span class="line">                videoTrack.enabled = enabled;</span><br><span class="line">                </span><br><span class="line">                // 通知其他用户</span><br><span class="line">                this.broadcastDataMessage(&#123;</span><br><span class="line">                    type: &#x27;video-toggle&#x27;,</span><br><span class="line">                    enabled: enabled</span><br><span class="line">                &#125;, this.userId);</span><br><span class="line">                </span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    async toggleAudio(enabled) &#123;</span><br><span class="line">        if (this.localStream) &#123;</span><br><span class="line">            const audioTrack = this.localStream.getAudioTracks()[0];</span><br><span class="line">            if (audioTrack) &#123;</span><br><span class="line">                audioTrack.enabled = enabled;</span><br><span class="line">                </span><br><span class="line">                // 通知其他用户</span><br><span class="line">                this.broadcastDataMessage(&#123;</span><br><span class="line">                    type: &#x27;audio-toggle&#x27;,</span><br><span class="line">                    enabled: enabled</span><br><span class="line">                &#125;, this.userId);</span><br><span class="line">                </span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    handleSignalingMessage(message) &#123;</span><br><span class="line">        switch (message.type) &#123;</span><br><span class="line">            case &#x27;offer&#x27;:</span><br><span class="line">                this.handleOffer(message.sender, message.data.sdp);</span><br><span class="line">                break;</span><br><span class="line">                </span><br><span class="line">            case &#x27;answer&#x27;:</span><br><span class="line">                this.handleAnswer(message.sender, message.data.sdp);</span><br><span class="line">                break;</span><br><span class="line">                </span><br><span class="line">            case &#x27;candidate&#x27;:</span><br><span class="line">                this.handleCandidate(message.sender, message.data.candidate);</span><br><span class="line">                break;</span><br><span class="line">                </span><br><span class="line">            case &#x27;user-joined&#x27;:</span><br><span class="line">                this.onUserJoined(message.sender);</span><br><span class="line">                break;</span><br><span class="line">                </span><br><span class="line">            case &#x27;user-left&#x27;:</span><br><span class="line">                this.onUserLeft(message.sender);</span><br><span class="line">                break;</span><br><span class="line">                </span><br><span class="line">            case &#x27;room-users&#x27;:</span><br><span class="line">                this.onRoomUsers(message.data.users);</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    sendSignalingMessage(message) &#123;</span><br><span class="line">        if (this.socket &amp;&amp; this.socket.readyState === WebSocket.OPEN) &#123;</span><br><span class="line">            this.socket.send(JSON.stringify(&#123;</span><br><span class="line">                ...message,</span><br><span class="line">                sender: this.userId</span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    cleanupPeerConnection(userId) &#123;</span><br><span class="line">        const pc = this.peerConnections[userId];</span><br><span class="line">        if (pc) &#123;</span><br><span class="line">            pc.close();</span><br><span class="line">            delete this.peerConnections[userId];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        delete this.dataChannels[userId];</span><br><span class="line">        this.onPeerDisconnected(userId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    cleanup() &#123;</span><br><span class="line">        // 关闭所有Peer连接</span><br><span class="line">        Object.keys(this.peerConnections).forEach(userId =&gt; &#123;</span><br><span class="line">            this.cleanupPeerConnection(userId);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        // 停止本地流</span><br><span class="line">        if (this.localStream) &#123;</span><br><span class="line">            this.localStream.getTracks().forEach(track =&gt; track.stop());</span><br><span class="line">            this.localStream = null;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 关闭WebSocket</span><br><span class="line">        if (this.socket) &#123;</span><br><span class="line">            this.socket.close();</span><br><span class="line">            this.socket = null;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 离开房间</span><br><span class="line">        if (this.roomId &amp;&amp; this.userId) &#123;</span><br><span class="line">            this.sendSignalingMessage(&#123;</span><br><span class="line">                type: &#x27;leave-room&#x27;,</span><br><span class="line">                roomId: this.roomId,</span><br><span class="line">                target: null,</span><br><span class="line">                data: &#123;&#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        this.onCleanup();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 事件回调函数（需要被子类覆盖）</span><br><span class="line">    onLocalStream(stream) &#123;&#125;</span><br><span class="line">    onRemoteStream(userId, stream) &#123;&#125;</span><br><span class="line">    onPeerConnected(userId) &#123;&#125;</span><br><span class="line">    onPeerDisconnected(userId) &#123;&#125;</span><br><span class="line">    onUserJoined(userId) &#123;&#125;</span><br><span class="line">    onUserLeft(userId) &#123;&#125;</span><br><span class="line">    onRoomUsers(users) &#123;&#125;</span><br><span class="line">    onDataChannelOpen(userId, channel) &#123;&#125;</span><br><span class="line">    onDataChannelMessage(userId, message) &#123;&#125;</span><br><span class="line">    onDataChannelClose(userId) &#123;&#125;</span><br><span class="line">    onCleanup() &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-2-视频通话UI组件"><a href="#4-2-视频通话UI组件" class="headerlink" title="4.2 视频通话UI组件"></a>4.2 视频通话UI组件</h3><p>html</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- video-call.html --&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;zh-CN&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br><span class="line">    &lt;title&gt;视频通话&lt;/title&gt;</span><br><span class="line">    &lt;link rel=&quot;stylesheet&quot; href=&quot;css/video-call.css&quot;&gt;</span><br><span class="line">    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css&quot;&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;div class=&quot;video-call-container&quot;&gt;</span><br><span class="line">        &lt;!-- 本地视频 --&gt;</span><br><span class="line">        &lt;div class=&quot;local-video-container&quot;&gt;</span><br><span class="line">            &lt;video id=&quot;localVideo&quot; autoplay muted playsinline&gt;&lt;/video&gt;</span><br><span class="line">            &lt;div class=&quot;local-video-info&quot;&gt;</span><br><span class="line">                &lt;div class=&quot;user-info&quot;&gt;</span><br><span class="line">                    &lt;div class=&quot;user-avatar&quot; id=&quot;localAvatar&quot;&gt;&lt;/div&gt;</span><br><span class="line">                    &lt;div class=&quot;user-name&quot; id=&quot;localUsername&quot;&gt;我&lt;/div&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;video-stats&quot;&gt;</span><br><span class="line">                    &lt;span class=&quot;stat-item&quot;&gt;</span><br><span class="line">                        &lt;i class=&quot;fas fa-microphone&quot;&gt;&lt;/i&gt;</span><br><span class="line">                        &lt;span id=&quot;audioStatus&quot;&gt;开启&lt;/span&gt;</span><br><span class="line">                    &lt;/span&gt;</span><br><span class="line">                    &lt;span class=&quot;stat-item&quot;&gt;</span><br><span class="line">                        &lt;i class=&quot;fas fa-video&quot;&gt;&lt;/i&gt;</span><br><span class="line">                        &lt;span id=&quot;videoStatus&quot;&gt;开启&lt;/span&gt;</span><br><span class="line">                    &lt;/span&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- 远程视频网格 --&gt;</span><br><span class="line">        &lt;div class=&quot;remote-videos-grid&quot; id=&quot;remoteVideosGrid&quot;&gt;</span><br><span class="line">            &lt;!-- 远程视频将通过JS动态添加 --&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- 控制栏 --&gt;</span><br><span class="line">        &lt;div class=&quot;control-bar&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;control-left&quot;&gt;</span><br><span class="line">                &lt;button class=&quot;control-btn&quot; id=&quot;toggleAudioBtn&quot; title=&quot;静音/取消静音&quot;&gt;</span><br><span class="line">                    &lt;i class=&quot;fas fa-microphone&quot;&gt;&lt;/i&gt;</span><br><span class="line">                &lt;/button&gt;</span><br><span class="line">                &lt;button class=&quot;control-btn&quot; id=&quot;toggleVideoBtn&quot; title=&quot;开启/关闭视频&quot;&gt;</span><br><span class="line">                    &lt;i class=&quot;fas fa-video&quot;&gt;&lt;/i&gt;</span><br><span class="line">                &lt;/button&gt;</span><br><span class="line">                &lt;button class=&quot;control-btn&quot; id=&quot;screenShareBtn&quot; title=&quot;共享屏幕&quot;&gt;</span><br><span class="line">                    &lt;i class=&quot;fas fa-desktop&quot;&gt;&lt;/i&gt;</span><br><span class="line">                &lt;/button&gt;</span><br><span class="line">                &lt;button class=&quot;control-btn&quot; id=&quot;toggleChatBtn&quot; title=&quot;显示/隐藏聊天&quot;&gt;</span><br><span class="line">                    &lt;i class=&quot;fas fa-comment&quot;&gt;&lt;/i&gt;</span><br><span class="line">                &lt;/button&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            </span><br><span class="line">            &lt;div class=&quot;control-center&quot;&gt;</span><br><span class="line">                &lt;button class=&quot;control-btn record-btn&quot; id=&quot;recordBtn&quot; title=&quot;开始录制&quot;&gt;</span><br><span class="line">                    &lt;i class=&quot;fas fa-circle&quot;&gt;&lt;/i&gt;</span><br><span class="line">                &lt;/button&gt;</span><br><span class="line">                &lt;button class=&quot;control-btn end-call-btn&quot; id=&quot;endCallBtn&quot; title=&quot;结束通话&quot;&gt;</span><br><span class="line">                    &lt;i class=&quot;fas fa-phone-slash&quot;&gt;&lt;/i&gt;</span><br><span class="line">                &lt;/button&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            </span><br><span class="line">            &lt;div class=&quot;control-right&quot;&gt;</span><br><span class="line">                &lt;button class=&quot;control-btn&quot; id=&quot;settingsBtn&quot; title=&quot;设置&quot;&gt;</span><br><span class="line">                    &lt;i class=&quot;fas fa-cog&quot;&gt;&lt;/i&gt;</span><br><span class="line">                &lt;/button&gt;</span><br><span class="line">                &lt;button class=&quot;control-btn&quot; id=&quot;toggleFullscreenBtn&quot; title=&quot;全屏&quot;&gt;</span><br><span class="line">                    &lt;i class=&quot;fas fa-expand&quot;&gt;&lt;/i&gt;</span><br><span class="line">                &lt;/button&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- 聊天侧边栏 --&gt;</span><br><span class="line">        &lt;div class=&quot;chat-sidebar&quot; id=&quot;chatSidebar&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;chat-header&quot;&gt;</span><br><span class="line">                &lt;h3&gt;&lt;i class=&quot;fas fa-comments&quot;&gt;&lt;/i&gt; 通话聊天&lt;/h3&gt;</span><br><span class="line">                &lt;button class=&quot;close-chat&quot;&gt;</span><br><span class="line">                    &lt;i class=&quot;fas fa-times&quot;&gt;&lt;/i&gt;</span><br><span class="line">                &lt;/button&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;chat-messages&quot; id=&quot;callChatMessages&quot;&gt;</span><br><span class="line">                &lt;!-- 聊天消息 --&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;chat-input&quot;&gt;</span><br><span class="line">                &lt;input type=&quot;text&quot; id=&quot;callChatInput&quot; placeholder=&quot;输入消息...&quot;&gt;</span><br><span class="line">                &lt;button id=&quot;sendCallMessageBtn&quot;&gt;</span><br><span class="line">                    &lt;i class=&quot;fas fa-paper-plane&quot;&gt;&lt;/i&gt;</span><br><span class="line">                &lt;/button&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- 通话信息面板 --&gt;</span><br><span class="line">        &lt;div class=&quot;call-info-panel&quot; id=&quot;callInfoPanel&quot;&gt;</span><br><span class="line">            &lt;h4&gt;&lt;i class=&quot;fas fa-info-circle&quot;&gt;&lt;/i&gt; 通话信息&lt;/h4&gt;</span><br><span class="line">            &lt;div class=&quot;info-content&quot;&gt;</span><br><span class="line">                &lt;div class=&quot;info-item&quot;&gt;</span><br><span class="line">                    &lt;span class=&quot;info-label&quot;&gt;房间ID:&lt;/span&gt;</span><br><span class="line">                    &lt;span class=&quot;info-value&quot; id=&quot;callRoomId&quot;&gt;-&lt;/span&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;info-item&quot;&gt;</span><br><span class="line">                    &lt;span class=&quot;info-label&quot;&gt;参与人数:&lt;/span&gt;</span><br><span class="line">                    &lt;span class=&quot;info-value&quot; id=&quot;callParticipants&quot;&gt;1&lt;/span&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;info-item&quot;&gt;</span><br><span class="line">                    &lt;span class=&quot;info-label&quot;&gt;通话时长:&lt;/span&gt;</span><br><span class="line">                    &lt;span class=&quot;info-value&quot; id=&quot;callDuration&quot;&gt;00:00&lt;/span&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;info-item&quot;&gt;</span><br><span class="line">                    &lt;span class=&quot;info-label&quot;&gt;网络状态:&lt;/span&gt;</span><br><span class="line">                    &lt;span class=&quot;info-value&quot; id=&quot;networkStatus&quot;&gt;良好&lt;/span&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!-- 通话邀请模态框 --&gt;</span><br><span class="line">        &lt;div class=&quot;modal-overlay&quot; id=&quot;inviteModal&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;modal&quot;&gt;</span><br><span class="line">                &lt;div class=&quot;modal-header&quot;&gt;</span><br><span class="line">                    &lt;h3&gt;&lt;i class=&quot;fas fa-user-plus&quot;&gt;&lt;/i&gt; 邀请加入通话&lt;/h3&gt;</span><br><span class="line">                    &lt;button class=&quot;close-modal&quot;&gt;&amp;times;&lt;/button&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;modal-body&quot;&gt;</span><br><span class="line">                    &lt;div class=&quot;user-search&quot;&gt;</span><br><span class="line">                        &lt;input type=&quot;text&quot; id=&quot;inviteUserSearch&quot; placeholder=&quot;搜索用户...&quot;&gt;</span><br><span class="line">                        &lt;i class=&quot;fas fa-search&quot;&gt;&lt;/i&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                    &lt;div class=&quot;user-list&quot; id=&quot;inviteUserList&quot;&gt;</span><br><span class="line">                        &lt;!-- 用户列表 --&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                    &lt;div class=&quot;invite-link&quot;&gt;</span><br><span class="line">                        &lt;p&gt;或分享链接:&lt;/p&gt;</span><br><span class="line">                        &lt;div class=&quot;link-container&quot;&gt;</span><br><span class="line">                            &lt;input type=&quot;text&quot; id=&quot;inviteLink&quot; readonly&gt;</span><br><span class="line">                            &lt;button class=&quot;copy-link-btn&quot;&gt;</span><br><span class="line">                                &lt;i class=&quot;fas fa-copy&quot;&gt;&lt;/i&gt;</span><br><span class="line">                            &lt;/button&gt;</span><br><span class="line">                        &lt;/div&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;script src=&quot;js/webrtc.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=&quot;js/video-call.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>



<h3 id="4-3-视频通话CSS"><a href="#4-3-视频通话CSS" class="headerlink" title="4.3 视频通话CSS"></a>4.3 视频通话CSS</h3><p>css</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br></pre></td><td class="code"><pre><span class="line">/* video-call.css */</span><br><span class="line">:root &#123;</span><br><span class="line">    --primary-color: #4361ee;</span><br><span class="line">    --danger-color: #ef476f;</span><br><span class="line">    --success-color: #06d6a0;</span><br><span class="line">    --warning-color: #ffd166;</span><br><span class="line">    --dark-color: #2b2d42;</span><br><span class="line">    --light-color: #f8f9fa;</span><br><span class="line">    --video-bg: #000000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">* &#123;</span><br><span class="line">    margin: 0;</span><br><span class="line">    padding: 0;</span><br><span class="line">    box-sizing: border-box;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body &#123;</span><br><span class="line">    font-family: &#x27;Poppins&#x27;, sans-serif;</span><br><span class="line">    background: var(--dark-color);</span><br><span class="line">    color: white;</span><br><span class="line">    height: 100vh;</span><br><span class="line">    overflow: hidden;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.video-call-container &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    flex-direction: column;</span><br><span class="line">    height: 100vh;</span><br><span class="line">    position: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 本地视频 */</span><br><span class="line">.local-video-container &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    top: 20px;</span><br><span class="line">    right: 20px;</span><br><span class="line">    width: 300px;</span><br><span class="line">    height: 200px;</span><br><span class="line">    border-radius: 10px;</span><br><span class="line">    overflow: hidden;</span><br><span class="line">    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);</span><br><span class="line">    z-index: 10;</span><br><span class="line">    background: var(--video-bg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#localVideo &#123;</span><br><span class="line">    width: 100%;</span><br><span class="line">    height: 100%;</span><br><span class="line">    object-fit: cover;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.local-video-info &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    bottom: 0;</span><br><span class="line">    left: 0;</span><br><span class="line">    right: 0;</span><br><span class="line">    background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);</span><br><span class="line">    padding: 10px;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    align-items: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-info &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    gap: 10px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-avatar &#123;</span><br><span class="line">    width: 30px;</span><br><span class="line">    height: 30px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    background: var(--primary-color);</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    font-weight: bold;</span><br><span class="line">    color: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-name &#123;</span><br><span class="line">    font-size: 0.9rem;</span><br><span class="line">    font-weight: 500;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.video-stats &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    gap: 15px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.stat-item &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    gap: 5px;</span><br><span class="line">    font-size: 0.8rem;</span><br><span class="line">    color: rgba(255, 255, 255, 0.8);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 远程视频网格 */</span><br><span class="line">.remote-videos-grid &#123;</span><br><span class="line">    flex: 1;</span><br><span class="line">    display: grid;</span><br><span class="line">    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));</span><br><span class="line">    gap: 20px;</span><br><span class="line">    padding: 20px;</span><br><span class="line">    overflow-y: auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.remote-video-item &#123;</span><br><span class="line">    position: relative;</span><br><span class="line">    border-radius: 10px;</span><br><span class="line">    overflow: hidden;</span><br><span class="line">    background: var(--video-bg);</span><br><span class="line">    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);</span><br><span class="line">    transition: transform 0.3s ease;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.remote-video-item:hover &#123;</span><br><span class="line">    transform: translateY(-5px);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.remote-video-item video &#123;</span><br><span class="line">    width: 100%;</span><br><span class="line">    height: 100%;</span><br><span class="line">    object-fit: cover;</span><br><span class="line">    min-height: 200px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.remote-video-info &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    bottom: 0;</span><br><span class="line">    left: 0;</span><br><span class="line">    right: 0;</span><br><span class="line">    background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);</span><br><span class="line">    padding: 10px;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    align-items: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.remote-user-info &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    gap: 10px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.remote-user-avatar &#123;</span><br><span class="line">    width: 30px;</span><br><span class="line">    height: 30px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    font-weight: bold;</span><br><span class="line">    color: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.remote-user-name &#123;</span><br><span class="line">    font-size: 0.9rem;</span><br><span class="line">    font-weight: 500;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.remote-user-status &#123;</span><br><span class="line">    width: 8px;</span><br><span class="line">    height: 8px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    background: var(--success-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.remote-user-status.muted &#123;</span><br><span class="line">    background: var(--danger-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 控制栏 */</span><br><span class="line">.control-bar &#123;</span><br><span class="line">    background: rgba(0, 0, 0, 0.8);</span><br><span class="line">    padding: 15px 20px;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    align-items: center;</span><br><span class="line">    backdrop-filter: blur(10px);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.control-left,</span><br><span class="line">.control-center,</span><br><span class="line">.control-right &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    gap: 15px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.control-btn &#123;</span><br><span class="line">    width: 50px;</span><br><span class="line">    height: 50px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    border: none;</span><br><span class="line">    background: rgba(255, 255, 255, 0.1);</span><br><span class="line">    color: white;</span><br><span class="line">    font-size: 1.2rem;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    transition: all 0.3s ease;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.control-btn:hover &#123;</span><br><span class="line">    background: rgba(255, 255, 255, 0.2);</span><br><span class="line">    transform: scale(1.1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.control-btn.active &#123;</span><br><span class="line">    background: var(--primary-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.control-btn:disabled &#123;</span><br><span class="line">    opacity: 0.5;</span><br><span class="line">    cursor: not-allowed;</span><br><span class="line">    transform: none !important;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.end-call-btn &#123;</span><br><span class="line">    background: var(--danger-color);</span><br><span class="line">    width: 60px;</span><br><span class="line">    height: 60px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.end-call-btn:hover &#123;</span><br><span class="line">    background: #d8355f;</span><br><span class="line">    transform: scale(1.1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.record-btn &#123;</span><br><span class="line">    background: var(--danger-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.record-btn.recording &#123;</span><br><span class="line">    animation: pulse 1.5s infinite;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@keyframes pulse &#123;</span><br><span class="line">    0% &#123; box-shadow: 0 0 0 0 rgba(239, 71, 111, 0.7); &#125;</span><br><span class="line">    70% &#123; box-shadow: 0 0 0 10px rgba(239, 71, 111, 0); &#125;</span><br><span class="line">    100% &#123; box-shadow: 0 0 0 0 rgba(239, 71, 111, 0); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 聊天侧边栏 */</span><br><span class="line">.chat-sidebar &#123;</span><br><span class="line">    position: fixed;</span><br><span class="line">    top: 0;</span><br><span class="line">    right: 0;</span><br><span class="line">    width: 350px;</span><br><span class="line">    height: 100%;</span><br><span class="line">    background: rgba(43, 45, 66, 0.95);</span><br><span class="line">    backdrop-filter: blur(10px);</span><br><span class="line">    border-left: 1px solid rgba(255, 255, 255, 0.1);</span><br><span class="line">    transform: translateX(100%);</span><br><span class="line">    transition: transform 0.3s ease;</span><br><span class="line">    display: flex;</span><br><span class="line">    flex-direction: column;</span><br><span class="line">    z-index: 100;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.chat-sidebar.show &#123;</span><br><span class="line">    transform: translateX(0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.chat-header &#123;</span><br><span class="line">    padding: 20px;</span><br><span class="line">    border-bottom: 1px solid rgba(255, 255, 255, 0.1);</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    align-items: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.chat-header h3 &#123;</span><br><span class="line">    font-size: 1.2rem;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    gap: 10px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.close-chat &#123;</span><br><span class="line">    background: none;</span><br><span class="line">    border: none;</span><br><span class="line">    color: white;</span><br><span class="line">    font-size: 1.2rem;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.chat-messages &#123;</span><br><span class="line">    flex: 1;</span><br><span class="line">    padding: 20px;</span><br><span class="line">    overflow-y: auto;</span><br><span class="line">    display: flex;</span><br><span class="line">    flex-direction: column;</span><br><span class="line">    gap: 15px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.call-message &#123;</span><br><span class="line">    padding: 10px 15px;</span><br><span class="line">    background: rgba(255, 255, 255, 0.1);</span><br><span class="line">    border-radius: 10px;</span><br><span class="line">    max-width: 80%;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.call-message.sent &#123;</span><br><span class="line">    align-self: flex-end;</span><br><span class="line">    background: var(--primary-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.call-message.received &#123;</span><br><span class="line">    align-self: flex-start;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.message-sender &#123;</span><br><span class="line">    font-weight: 500;</span><br><span class="line">    margin-bottom: 5px;</span><br><span class="line">    font-size: 0.9rem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.message-content &#123;</span><br><span class="line">    word-break: break-word;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.message-time &#123;</span><br><span class="line">    font-size: 0.8rem;</span><br><span class="line">    opacity: 0.7;</span><br><span class="line">    margin-top: 5px;</span><br><span class="line">    text-align: right;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.chat-input &#123;</span><br><span class="line">    padding: 15px 20px;</span><br><span class="line">    border-top: 1px solid rgba(255, 255, 255, 0.1);</span><br><span class="line">    display: flex;</span><br><span class="line">    gap: 10px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.chat-input input &#123;</span><br><span class="line">    flex: 1;</span><br><span class="line">    padding: 10px 15px;</span><br><span class="line">    border: 1px solid rgba(255, 255, 255, 0.2);</span><br><span class="line">    border-radius: 20px;</span><br><span class="line">    background: rgba(255, 255, 255, 0.1);</span><br><span class="line">    color: white;</span><br><span class="line">    font-size: 0.9rem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.chat-input input:focus &#123;</span><br><span class="line">    outline: none;</span><br><span class="line">    border-color: var(--primary-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.chat-input button &#123;</span><br><span class="line">    width: 40px;</span><br><span class="line">    height: 40px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    border: none;</span><br><span class="line">    background: var(--primary-color);</span><br><span class="line">    color: white;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 通话信息面板 */</span><br><span class="line">.call-info-panel &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    top: 20px;</span><br><span class="line">    left: 20px;</span><br><span class="line">    width: 300px;</span><br><span class="line">    background: rgba(0, 0, 0, 0.8);</span><br><span class="line">    border-radius: 10px;</span><br><span class="line">    padding: 20px;</span><br><span class="line">    backdrop-filter: blur(10px);</span><br><span class="line">    z-index: 10;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.call-info-panel h4 &#123;</span><br><span class="line">    margin-bottom: 15px;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    gap: 10px;</span><br><span class="line">    font-size: 1rem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.info-content &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    flex-direction: column;</span><br><span class="line">    gap: 10px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.info-item &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    align-items: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.info-label &#123;</span><br><span class="line">    font-size: 0.9rem;</span><br><span class="line">    opacity: 0.8;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.info-value &#123;</span><br><span class="line">    font-weight: 500;</span><br><span class="line">    color: var(--success-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 邀请模态框 */</span><br><span class="line">.modal-overlay &#123;</span><br><span class="line">    position: fixed;</span><br><span class="line">    top: 0;</span><br><span class="line">    left: 0;</span><br><span class="line">    width: 100%;</span><br><span class="line">    height: 100%;</span><br><span class="line">    background: rgba(0, 0, 0, 0.7);</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    align-items: center;</span><br><span class="line">    z-index: 1000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.modal &#123;</span><br><span class="line">    background: var(--dark-color);</span><br><span class="line">    border-radius: 10px;</span><br><span class="line">    width: 90%;</span><br><span class="line">    max-width: 500px;</span><br><span class="line">    max-height: 80vh;</span><br><span class="line">    overflow: hidden;</span><br><span class="line">    display: flex;</span><br><span class="line">    flex-direction: column;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.modal-header &#123;</span><br><span class="line">    padding: 20px;</span><br><span class="line">    border-bottom: 1px solid rgba(255, 255, 255, 0.1);</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    align-items: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.modal-body &#123;</span><br><span class="line">    flex: 1;</span><br><span class="line">    padding: 20px;</span><br><span class="line">    overflow-y: auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-search &#123;</span><br><span class="line">    position: relative;</span><br><span class="line">    margin-bottom: 20px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-search input &#123;</span><br><span class="line">    width: 100%;</span><br><span class="line">    padding: 10px 15px 10px 40px;</span><br><span class="line">    border: 1px solid rgba(255, 255, 255, 0.2);</span><br><span class="line">    border-radius: 20px;</span><br><span class="line">    background: rgba(255, 255, 255, 0.1);</span><br><span class="line">    color: white;</span><br><span class="line">    font-size: 0.9rem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-search i &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    left: 15px;</span><br><span class="line">    top: 50%;</span><br><span class="line">    transform: translateY(-50%);</span><br><span class="line">    color: rgba(255, 255, 255, 0.5);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-list &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    flex-direction: column;</span><br><span class="line">    gap: 10px;</span><br><span class="line">    margin-bottom: 20px;</span><br><span class="line">    max-height: 200px;</span><br><span class="line">    overflow-y: auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-list-item &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    gap: 15px;</span><br><span class="line">    padding: 10px 15px;</span><br><span class="line">    border-radius: 8px;</span><br><span class="line">    background: rgba(255, 255, 255, 0.05);</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    transition: background 0.3s ease;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-list-item:hover &#123;</span><br><span class="line">    background: rgba(255, 255, 255, 0.1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.user-list-item.selected &#123;</span><br><span class="line">    background: rgba(67, 97, 238, 0.2);</span><br><span class="line">    border: 1px solid var(--primary-color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.invite-link p &#123;</span><br><span class="line">    margin-bottom: 10px;</span><br><span class="line">    opacity: 0.8;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.link-container &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    gap: 10px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.link-container input &#123;</span><br><span class="line">    flex: 1;</span><br><span class="line">    padding: 10px 15px;</span><br><span class="line">    border: 1px solid rgba(255, 255, 255, 0.2);</span><br><span class="line">    border-radius: 8px;</span><br><span class="line">    background: rgba(255, 255, 255, 0.1);</span><br><span class="line">    color: white;</span><br><span class="line">    font-size: 0.9rem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.copy-link-btn &#123;</span><br><span class="line">    padding: 10px 20px;</span><br><span class="line">    border: none;</span><br><span class="line">    border-radius: 8px;</span><br><span class="line">    background: var(--primary-color);</span><br><span class="line">    color: white;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    gap: 5px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 全屏样式 */</span><br><span class="line">body.fullscreen &#123;</span><br><span class="line">    padding: 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body.fullscreen .local-video-container &#123;</span><br><span class="line">    width: 200px;</span><br><span class="line">    height: 150px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body.fullscreen .call-info-panel &#123;</span><br><span class="line">    display: none;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 响应式设计 */</span><br><span class="line">@media (max-width: 1024px) &#123;</span><br><span class="line">    .remote-videos-grid &#123;</span><br><span class="line">        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    .local-video-container &#123;</span><br><span class="line">        width: 250px;</span><br><span class="line">        height: 150px;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@media (max-width: 768px) &#123;</span><br><span class="line">    .remote-videos-grid &#123;</span><br><span class="line">        grid-template-columns: 1fr;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    .local-video-container &#123;</span><br><span class="line">        width: 150px;</span><br><span class="line">        height: 100px;</span><br><span class="line">        top: 10px;</span><br><span class="line">        right: 10px;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    .call-info-panel &#123;</span><br><span class="line">        width: 250px;</span><br><span class="line">        padding: 15px;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    .control-bar &#123;</span><br><span class="line">        padding: 10px;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    .control-btn &#123;</span><br><span class="line">        width: 40px;</span><br><span class="line">        height: 40px;</span><br><span class="line">        font-size: 1rem;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    .end-call-btn &#123;</span><br><span class="line">        width: 50px;</span><br><span class="line">        height: 50px;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    .chat-sidebar &#123;</span><br><span class="line">        width: 100%;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-消息队列集成"><a href="#5-消息队列集成" class="headerlink" title="5. 消息队列集成"></a>5. 消息队列集成</h2><h3 id="5-1-Kafka配置"><a href="#5-1-Kafka配置" class="headerlink" title="5.1 Kafka配置"></a>5.1 Kafka配置</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.mq.config;</span><br><span class="line"></span><br><span class="line">import org.apache.kafka.clients.admin.NewTopic;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.kafka.config.TopicBuilder;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">public class KafkaConfig &#123;</span><br><span class="line">    </span><br><span class="line">    @Bean</span><br><span class="line">    public NewTopic chatMessagesTopic() &#123;</span><br><span class="line">        return TopicBuilder.name(&quot;chat.messages&quot;)</span><br><span class="line">                .partitions(3)</span><br><span class="line">                .replicas(2)</span><br><span class="line">                .config(&quot;retention.ms&quot;, &quot;604800000&quot;) // 7天</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Bean</span><br><span class="line">    public NewTopic chatNotificationsTopic() &#123;</span><br><span class="line">        return TopicBuilder.name(&quot;chat.notifications&quot;)</span><br><span class="line">                .partitions(2)</span><br><span class="line">                .replicas(2)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Bean</span><br><span class="line">    public NewTopic chatEventsTopic() &#123;</span><br><span class="line">        return TopicBuilder.name(&quot;chat.events&quot;)</span><br><span class="line">                .partitions(5)</span><br><span class="line">                .replicas(2)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Bean</span><br><span class="line">    public NewTopic chatPresenceTopic() &#123;</span><br><span class="line">        return TopicBuilder.name(&quot;chat.presence&quot;)</span><br><span class="line">                .partitions(2)</span><br><span class="line">                .replicas(2)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-2-Kafka生产者"><a href="#5-2-Kafka生产者" class="headerlink" title="5.2 Kafka生产者"></a>5.2 Kafka生产者</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.mq.producer;</span><br><span class="line"></span><br><span class="line">import com.chatroom.dto.ChatMessageDTO;</span><br><span class="line">import com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line">import com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.kafka.core.KafkaTemplate;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">public class ChatMessageProducer &#123;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private KafkaTemplate&lt;String, String&gt; kafkaTemplate;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private ObjectMapper objectMapper;</span><br><span class="line">    </span><br><span class="line">    public void sendMessage(ChatMessageDTO message) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            String payload = objectMapper.writeValueAsString(message);</span><br><span class="line">            kafkaTemplate.send(&quot;chat.messages&quot;, message.getRoomId(), payload);</span><br><span class="line">            </span><br><span class="line">            // 发送事件</span><br><span class="line">            sendEvent(&quot;message.sent&quot;, Map.of(</span><br><span class="line">                &quot;messageId&quot;, message.getId(),</span><br><span class="line">                &quot;sender&quot;, message.getSender(),</span><br><span class="line">                &quot;roomId&quot;, message.getRoomId(),</span><br><span class="line">                &quot;timestamp&quot;, message.getTimestamp()</span><br><span class="line">            ));</span><br><span class="line">        &#125; catch (JsonProcessingException e) &#123;</span><br><span class="line">            throw new RuntimeException(&quot;Failed to serialize message&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void sendNotification(String userId, String type, Object data) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Map&lt;String, Object&gt; notification = Map.of(</span><br><span class="line">                &quot;userId&quot;, userId,</span><br><span class="line">                &quot;type&quot;, type,</span><br><span class="line">                &quot;data&quot;, data,</span><br><span class="line">                &quot;timestamp&quot;, System.currentTimeMillis()</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            String payload = objectMapper.writeValueAsString(notification);</span><br><span class="line">            kafkaTemplate.send(&quot;chat.notifications&quot;, userId, payload);</span><br><span class="line">        &#125; catch (JsonProcessingException e) &#123;</span><br><span class="line">            throw new RuntimeException(&quot;Failed to serialize notification&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void sendEvent(String eventType, Map&lt;String, Object&gt; data) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Map&lt;String, Object&gt; event = Map.of(</span><br><span class="line">                &quot;type&quot;, eventType,</span><br><span class="line">                &quot;data&quot;, data,</span><br><span class="line">                &quot;timestamp&quot;, System.currentTimeMillis(),</span><br><span class="line">                &quot;service&quot;, &quot;chat-service&quot;</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            String payload = objectMapper.writeValueAsString(event);</span><br><span class="line">            kafkaTemplate.send(&quot;chat.events&quot;, eventType, payload);</span><br><span class="line">        &#125; catch (JsonProcessingException e) &#123;</span><br><span class="line">            throw new RuntimeException(&quot;Failed to serialize event&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void updatePresence(String userId, String status) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Map&lt;String, Object&gt; presence = Map.of(</span><br><span class="line">                &quot;userId&quot;, userId,</span><br><span class="line">                &quot;status&quot;, status,</span><br><span class="line">                &quot;timestamp&quot;, System.currentTimeMillis()</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            String payload = objectMapper.writeValueAsString(presence);</span><br><span class="line">            kafkaTemplate.send(&quot;chat.presence&quot;, userId, payload);</span><br><span class="line">        &#125; catch (JsonProcessingException e) &#123;</span><br><span class="line">            throw new RuntimeException(&quot;Failed to serialize presence&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-3-Kafka消费者"><a href="#5-3-Kafka消费者" class="headerlink" title="5.3 Kafka消费者"></a>5.3 Kafka消费者</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.mq.consumer;</span><br><span class="line"></span><br><span class="line">import com.chatroom.service.MessageService;</span><br><span class="line">import com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.kafka.annotation.KafkaListener;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">public class ChatMessageConsumer &#123;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private MessageService messageService;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private ObjectMapper objectMapper;</span><br><span class="line">    </span><br><span class="line">    @KafkaListener(topics = &quot;chat.messages&quot;, groupId = &quot;chat-service&quot;)</span><br><span class="line">    public void consumeMessage(String payload) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Map&lt;String, Object&gt; message = objectMapper.readValue(payload, Map.class);</span><br><span class="line">            // 处理消息逻辑</span><br><span class="line">            processIncomingMessage(message);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            System.err.println(&quot;Failed to process message: &quot; + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @KafkaListener(topics = &quot;chat.notifications&quot;, groupId = &quot;notification-service&quot;)</span><br><span class="line">    public void consumeNotification(String payload) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Map&lt;String, Object&gt; notification = objectMapper.readValue(payload, Map.class);</span><br><span class="line">            // 处理通知逻辑</span><br><span class="line">            processNotification(notification);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            System.err.println(&quot;Failed to process notification: &quot; + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void processIncomingMessage(Map&lt;String, Object&gt; message) &#123;</span><br><span class="line">        // 消息处理逻辑</span><br><span class="line">        System.out.println(&quot;Processing message: &quot; + message);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void processNotification(Map&lt;String, Object&gt; notification) &#123;</span><br><span class="line">        // 通知处理逻辑</span><br><span class="line">        System.out.println(&quot;Processing notification: &quot; + notification);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="6-实时协作白板"><a href="#6-实时协作白板" class="headerlink" title="6. 实时协作白板"></a>6. 实时协作白板</h2><h3 id="6-1-白板后端"><a href="#6-1-白板后端" class="headerlink" title="6.1 白板后端"></a>6.1 白板后端</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line">package com.chatroom.whiteboard;</span><br><span class="line"></span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line">import org.springframework.web.socket.*;</span><br><span class="line">import org.springframework.web.socket.handler.TextWebSocketHandler;</span><br><span class="line"></span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">public class WhiteboardHandler extends TextWebSocketHandler &#123;</span><br><span class="line">    </span><br><span class="line">    private final Map&lt;String, WhiteboardSession&gt; sessions = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    private final Map&lt;String, WhiteboardRoom&gt; rooms = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void afterConnectionEstablished(WebSocketSession session) throws Exception &#123;</span><br><span class="line">        String whiteboardId = getWhiteboardId(session);</span><br><span class="line">        String userId = getUserId(session);</span><br><span class="line">        </span><br><span class="line">        WhiteboardSession ws = new WhiteboardSession(session, userId);</span><br><span class="line">        sessions.put(whiteboardId, ws);</span><br><span class="line">        </span><br><span class="line">        System.out.println(&quot;白板连接建立: &quot; + whiteboardId + &quot;, 用户: &quot; + userId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    protected void handleTextMessage(WebSocketSession session, TextMessage message) throws Exception &#123;</span><br><span class="line">        String whiteboardId = getWhiteboardId(session);</span><br><span class="line">        String userId = getUserId(session);</span><br><span class="line">        </span><br><span class="line">        WhiteboardMessage wbMessage = WhiteboardMessage.fromJson(message.getPayload());</span><br><span class="line">        </span><br><span class="line">        switch (wbMessage.getType()) &#123;</span><br><span class="line">            case &quot;join&quot;:</span><br><span class="line">                joinWhiteboard(whiteboardId, userId, wbMessage);</span><br><span class="line">                break;</span><br><span class="line">                </span><br><span class="line">            case &quot;draw&quot;:</span><br><span class="line">            case &quot;erase&quot;:</span><br><span class="line">            case &quot;clear&quot;:</span><br><span class="line">            case &quot;undo&quot;:</span><br><span class="line">            case &quot;redo&quot;:</span><br><span class="line">                broadcastToWhiteboard(whiteboardId, userId, wbMessage);</span><br><span class="line">                break;</span><br><span class="line">                </span><br><span class="line">            case &quot;cursor&quot;:</span><br><span class="line">                broadcastCursor(whiteboardId, userId, wbMessage);</span><br><span class="line">                break;</span><br><span class="line">                </span><br><span class="line">            case &quot;sync&quot;:</span><br><span class="line">                syncWhiteboard(whiteboardId, userId);</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void joinWhiteboard(String whiteboardId, String userId, WhiteboardMessage message) &#123;</span><br><span class="line">        WhiteboardRoom room = rooms.computeIfAbsent(whiteboardId, id -&gt; new WhiteboardRoom(id));</span><br><span class="line">        room.addUser(userId);</span><br><span class="line">        </span><br><span class="line">        // 发送历史数据</span><br><span class="line">        WhiteboardSession session = sessions.get(whiteboardId);</span><br><span class="line">        if (session != null) &#123;</span><br><span class="line">            WhiteboardMessage syncMessage = new WhiteboardMessage();</span><br><span class="line">            syncMessage.setType(&quot;sync-response&quot;);</span><br><span class="line">            syncMessage.setData(Map.of(&quot;history&quot;, room.getHistory()));</span><br><span class="line">            </span><br><span class="line">            try &#123;</span><br><span class="line">                session.getWebSocketSession().sendMessage(</span><br><span class="line">                    new TextMessage(syncMessage.toJson())</span><br><span class="line">                );</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 通知其他用户</span><br><span class="line">        WhiteboardMessage joinMessage = new WhiteboardMessage();</span><br><span class="line">        joinMessage.setType(&quot;user-joined&quot;);</span><br><span class="line">        joinMessage.setData(Map.of(&quot;userId&quot;, userId));</span><br><span class="line">        </span><br><span class="line">        broadcastToWhiteboard(whiteboardId, userId, joinMessage);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void broadcastToWhiteboard(String whiteboardId, String senderId, WhiteboardMessage message) &#123;</span><br><span class="line">        WhiteboardRoom room = rooms.get(whiteboardId);</span><br><span class="line">        if (room != null) &#123;</span><br><span class="line">            // 保存到历史</span><br><span class="line">            if (shouldSaveToHistory(message.getType())) &#123;</span><br><span class="line">                room.addToHistory(message);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 广播给其他用户</span><br><span class="line">            room.getUsers().forEach(userId -&gt; &#123;</span><br><span class="line">                if (!userId.equals(senderId)) &#123;</span><br><span class="line">                    WhiteboardSession session = sessions.values().stream()</span><br><span class="line">                        .filter(s -&gt; userId.equals(s.getUserId()))</span><br><span class="line">                        .findFirst()</span><br><span class="line">                        .orElse(null);</span><br><span class="line">                    </span><br><span class="line">                    if (session != null &amp;&amp; session.getWebSocketSession().isOpen()) &#123;</span><br><span class="line">                        try &#123;</span><br><span class="line">                            session.getWebSocketSession().sendMessage(</span><br><span class="line">                                new TextMessage(message.toJson())</span><br><span class="line">                            );</span><br><span class="line">                        &#125; catch (Exception e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void broadcastCursor(String whiteboardId, String userId, WhiteboardMessage message) &#123;</span><br><span class="line">        WhiteboardRoom room = rooms.get(whiteboardId);</span><br><span class="line">        if (room != null) &#123;</span><br><span class="line">            WhiteboardMessage cursorMessage = new WhiteboardMessage();</span><br><span class="line">            cursorMessage.setType(&quot;cursor-update&quot;);</span><br><span class="line">            cursorMessage.setData(Map.of(</span><br><span class="line">                &quot;userId&quot;, userId,</span><br><span class="line">                &quot;position&quot;, message.getData().get(&quot;position&quot;)</span><br><span class="line">            ));</span><br><span class="line">            </span><br><span class="line">            broadcastToWhiteboard(whiteboardId, userId, cursorMessage);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void syncWhiteboard(String whiteboardId, String userId) &#123;</span><br><span class="line">        WhiteboardRoom room = rooms.get(whiteboardId);</span><br><span class="line">        if (room != null) &#123;</span><br><span class="line">            WhiteboardSession session = sessions.values().stream()</span><br><span class="line">                .filter(s -&gt; userId.equals(s.getUserId()))</span><br><span class="line">                .findFirst()</span><br><span class="line">                .orElse(null);</span><br><span class="line">            </span><br><span class="line">            if (session != null) &#123;</span><br><span class="line">                WhiteboardMessage syncMessage = new WhiteboardMessage();</span><br><span class="line">                syncMessage.setType(&quot;sync-response&quot;);</span><br><span class="line">                syncMessage.setData(Map.of(&quot;history&quot;, room.getHistory()));</span><br><span class="line">                </span><br><span class="line">                try &#123;</span><br><span class="line">                    session.getWebSocketSession().sendMessage(</span><br><span class="line">                        new TextMessage(syncMessage.toJson())</span><br><span class="line">                    );</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private boolean shouldSaveToHistory(String type) &#123;</span><br><span class="line">        return !type.equals(&quot;cursor&quot;) &amp;&amp; !type.equals(&quot;cursor-update&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private String getWhiteboardId(WebSocketSession session) &#123;</span><br><span class="line">        Map&lt;String, Object&gt; attributes = session.getAttributes();</span><br><span class="line">        return attributes.get(&quot;whiteboardId&quot;).toString();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private String getUserId(WebSocketSession session) &#123;</span><br><span class="line">        Map&lt;String, Object&gt; attributes = session.getAttributes();</span><br><span class="line">        return attributes.get(&quot;userId&quot;).toString();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void afterConnectionClosed(WebSocketSession session, CloseStatus status) throws Exception &#123;</span><br><span class="line">        String whiteboardId = getWhiteboardId(session);</span><br><span class="line">        String userId = getUserId(session);</span><br><span class="line">        </span><br><span class="line">        sessions.remove(whiteboardId);</span><br><span class="line">        </span><br><span class="line">        WhiteboardRoom room = rooms.get(whiteboardId);</span><br><span class="line">        if (room != null) &#123;</span><br><span class="line">            room.removeUser(userId);</span><br><span class="line">            </span><br><span class="line">            // 通知其他用户</span><br><span class="line">            WhiteboardMessage leaveMessage = new WhiteboardMessage();</span><br><span class="line">            leaveMessage.setType(&quot;user-left&quot;);</span><br><span class="line">            leaveMessage.setData(Map.of(&quot;userId&quot;, userId));</span><br><span class="line">            </span><br><span class="line">            broadcastToWhiteboard(whiteboardId, userId, leaveMessage);</span><br><span class="line">            </span><br><span class="line">            // 如果没有用户，清理房间</span><br><span class="line">            if (room.getUsers().isEmpty()) &#123;</span><br><span class="line">                rooms.remove(whiteboardId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        System.out.println(&quot;白板连接关闭: &quot; + whiteboardId + &quot;, 用户: &quot; + userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="7-Kubernetes部署配置"><a href="#7-Kubernetes部署配置" class="headerlink" title="7. Kubernetes部署配置"></a>7. Kubernetes部署配置</h2><h3 id="7-1-Kubernetes部署文件"><a href="#7-1-Kubernetes部署文件" class="headerlink" title="7.1 Kubernetes部署文件"></a>7.1 Kubernetes部署文件</h3><p>yaml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br></pre></td><td class="code"><pre><span class="line"># k8s/namespace.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: chat-system</span><br><span class="line">---</span><br><span class="line"># k8s/config-map.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: chat-config</span><br><span class="line">  namespace: chat-system</span><br><span class="line">data:</span><br><span class="line">  application.yml: |</span><br><span class="line">    spring:</span><br><span class="line">      application:</span><br><span class="line">        name: chat-service</span><br><span class="line">      datasource:</span><br><span class="line">        url: jdbc:mysql://mysql-chat:3306/chat_room</span><br><span class="line">        username: $&#123;DB_USERNAME&#125;</span><br><span class="line">        password: $&#123;DB_PASSWORD&#125;</span><br><span class="line">      redis:</span><br><span class="line">        host: redis-chat</span><br><span class="line">        port: 6379</span><br><span class="line">      kafka:</span><br><span class="line">        bootstrap-servers: kafka-chat:9092</span><br><span class="line">    app:</span><br><span class="line">      jwt:</span><br><span class="line">        secret: $&#123;JWT_SECRET&#125;</span><br><span class="line">      file:</span><br><span class="line">        upload-dir: /app/uploads</span><br><span class="line">---</span><br><span class="line"># k8s/secret.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: chat-secrets</span><br><span class="line">  namespace: chat-system</span><br><span class="line">type: Opaque</span><br><span class="line">data:</span><br><span class="line">  db-username: Y2hhdF91c2Vy</span><br><span class="line">  db-password: Y2hhdDEyMzQ1</span><br><span class="line">  jwt-secret: eW91ci1zdXBlci1zZWNyZXQta2V5LWNoYW5nZS10aGlzLWluLXByb2R1Y3Rpb24=</span><br><span class="line">---</span><br><span class="line"># k8s/mysql.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-chat</span><br><span class="line">  namespace: chat-system</span><br><span class="line">spec:</span><br><span class="line">  serviceName: mysql-chat</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: mysql-chat</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: mysql-chat</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: mysql</span><br><span class="line">        image: mysql:8.0</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 3306</span><br><span class="line">        env:</span><br><span class="line">        - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">          valueFrom:</span><br><span class="line">            secretKeyRef:</span><br><span class="line">              name: chat-secrets</span><br><span class="line">              key: db-password</span><br><span class="line">        - name: MYSQL_DATABASE</span><br><span class="line">          value: &quot;chat_room&quot;</span><br><span class="line">        - name: MYSQL_USER</span><br><span class="line">          valueFrom:</span><br><span class="line">            secretKeyRef:</span><br><span class="line">              name: chat-secrets</span><br><span class="line">              key: db-username</span><br><span class="line">        - name: MYSQL_PASSWORD</span><br><span class="line">          valueFrom:</span><br><span class="line">            secretKeyRef:</span><br><span class="line">              name: chat-secrets</span><br><span class="line">              key: db-password</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: mysql-data</span><br><span class="line">          mountPath: /var/lib/mysql</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: &quot;512Mi&quot;</span><br><span class="line">            cpu: &quot;250m&quot;</span><br><span class="line">          limits:</span><br><span class="line">            memory: &quot;1Gi&quot;</span><br><span class="line">            cpu: &quot;500m&quot;</span><br><span class="line">        livenessProbe:</span><br><span class="line">          exec:</span><br><span class="line">            command: [&quot;mysqladmin&quot;, &quot;ping&quot;, &quot;-h&quot;, &quot;localhost&quot;]</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        readinessProbe:</span><br><span class="line">          exec:</span><br><span class="line">            command: [&quot;mysql&quot;, &quot;-h&quot;, &quot;localhost&quot;, &quot;-u&quot;, &quot;root&quot;, &quot;-p$&#123;MYSQL_ROOT_PASSWORD&#125;&quot;, &quot;-e&quot;, &quot;SELECT 1&quot;]</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          periodSeconds: 2</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">      volumes:</span><br><span class="line">      - name: mysql-data</span><br><span class="line">        persistentVolumeClaim:</span><br><span class="line">          claimName: mysql-pvc</span><br><span class="line">---</span><br><span class="line"># k8s/redis.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: redis-chat</span><br><span class="line">  namespace: chat-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: redis-chat</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: redis-chat</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: redis</span><br><span class="line">        image: redis:7-alpine</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 6379</span><br><span class="line">        command: [&quot;redis-server&quot;, &quot;--appendonly&quot;, &quot;yes&quot;]</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: &quot;256Mi&quot;</span><br><span class="line">            cpu: &quot;100m&quot;</span><br><span class="line">          limits:</span><br><span class="line">            memory: &quot;512Mi&quot;</span><br><span class="line">            cpu: &quot;200m&quot;</span><br><span class="line">        livenessProbe:</span><br><span class="line">          exec:</span><br><span class="line">            command: [&quot;redis-cli&quot;, &quot;ping&quot;]</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">        readinessProbe:</span><br><span class="line">          exec:</span><br><span class="line">            command: [&quot;redis-cli&quot;, &quot;ping&quot;]</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          periodSeconds: 2</span><br><span class="line">---</span><br><span class="line"># k8s/kafka.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: kafka-chat</span><br><span class="line">  namespace: chat-system</span><br><span class="line">spec:</span><br><span class="line">  serviceName: kafka-chat</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: kafka-chat</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: kafka-chat</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kafka</span><br><span class="line">        image: confluentinc/cp-kafka:latest</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9092</span><br><span class="line">        env:</span><br><span class="line">        - name: KAFKA_BROKER_ID</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.name</span><br><span class="line">        - name: KAFKA_ZOOKEEPER_CONNECT</span><br><span class="line">          value: &quot;zookeeper-chat:2181&quot;</span><br><span class="line">        - name: KAFKA_ADVERTISED_LISTENERS</span><br><span class="line">          value: &quot;PLAINTEXT://$(POD_NAME).kafka-chat.chat-system.svc.cluster.local:9092&quot;</span><br><span class="line">        - name: KAFKA_LISTENER_SECURITY_PROTOCOL_MAP</span><br><span class="line">          value: &quot;PLAINTEXT:PLAINTEXT&quot;</span><br><span class="line">        - name: KAFKA_INTER_BROKER_LISTENER_NAME</span><br><span class="line">          value: &quot;PLAINTEXT&quot;</span><br><span class="line">        - name: KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR</span><br><span class="line">          value: &quot;3&quot;</span><br><span class="line">        - name: POD_NAME</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.name</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: &quot;512Mi&quot;</span><br><span class="line">            cpu: &quot;250m&quot;</span><br><span class="line">          limits:</span><br><span class="line">            memory: &quot;1Gi&quot;</span><br><span class="line">            cpu: &quot;500m&quot;</span><br><span class="line">        livenessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 9092</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">---</span><br><span class="line"># k8s/gateway.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: gateway</span><br><span class="line">  namespace: chat-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: gateway</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: gateway</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: gateway</span><br><span class="line">        image: chat/gateway:latest</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">        env:</span><br><span class="line">        - name: SPRING_PROFILES_ACTIVE</span><br><span class="line">          value: &quot;kubernetes&quot;</span><br><span class="line">        - name: JWT_SECRET</span><br><span class="line">          valueFrom:</span><br><span class="line">            secretKeyRef:</span><br><span class="line">              name: chat-secrets</span><br><span class="line">              key: jwt-secret</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: &quot;256Mi&quot;</span><br><span class="line">            cpu: &quot;100m&quot;</span><br><span class="line">          limits:</span><br><span class="line">            memory: &quot;512Mi&quot;</span><br><span class="line">            cpu: &quot;200m&quot;</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /actuator/health</span><br><span class="line">            port: 8080</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /actuator/health/readiness</span><br><span class="line">            port: 8080</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          periodSeconds: 5</span><br><span class="line">---</span><br><span class="line"># k8s/service.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: gateway-service</span><br><span class="line">  namespace: chat-system</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: gateway</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  type: LoadBalancer</span><br><span class="line">---</span><br><span class="line"># k8s/hpa.yaml</span><br><span class="line">apiVersion: autoscaling/v2</span><br><span class="line">kind: HorizontalPodAutoscaler</span><br><span class="line">metadata:</span><br><span class="line">  name: gateway-hpa</span><br><span class="line">  namespace: chat-system</span><br><span class="line">spec:</span><br><span class="line">  scaleTargetRef:</span><br><span class="line">    apiVersion: apps/v1</span><br><span class="line">    kind: Deployment</span><br><span class="line">    name: gateway</span><br><span class="line">  minReplicas: 2</span><br><span class="line">  maxReplicas: 10</span><br><span class="line">  metrics:</span><br><span class="line">  - type: Resource</span><br><span class="line">    resource:</span><br><span class="line">      name: cpu</span><br><span class="line">      target:</span><br><span class="line">        type: Utilization</span><br><span class="line">        averageUtilization: 70</span><br><span class="line">  - type: Resource</span><br><span class="line">    resource:</span><br><span class="line">      name: memory</span><br><span class="line">      target:</span><br><span class="line">        type: Utilization</span><br><span class="line">        averageUtilization: 80</span><br></pre></td></tr></table></figure>



<h3 id="7-2-Helm-Chart"><a href="#7-2-Helm-Chart" class="headerlink" title="7.2 Helm Chart"></a>7.2 Helm Chart</h3><p>yaml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"># helm/chat-room/Chart.yaml</span><br><span class="line">apiVersion: v2</span><br><span class="line">name: chat-room</span><br><span class="line">description: A Helm chart for deploying Chat Room microservices</span><br><span class="line">type: application</span><br><span class="line">version: 1.0.0</span><br><span class="line">appVersion: &quot;1.0.0&quot;</span><br><span class="line"></span><br><span class="line"># helm/chat-room/values.yaml</span><br><span class="line">replicaCount: 2</span><br><span class="line"></span><br><span class="line">image:</span><br><span class="line">  repository: chat</span><br><span class="line">  pullPolicy: IfNotPresent</span><br><span class="line">  tag: &quot;latest&quot;</span><br><span class="line"></span><br><span class="line">imagePullSecrets: []</span><br><span class="line">nameOverride: &quot;&quot;</span><br><span class="line">fullnameOverride: &quot;&quot;</span><br><span class="line"></span><br><span class="line">service:</span><br><span class="line">  type: LoadBalancer</span><br><span class="line">  port: 80</span><br><span class="line"></span><br><span class="line">ingress:</span><br><span class="line">  enabled: true</span><br><span class="line">  className: &quot;nginx&quot;</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: nginx</span><br><span class="line">    cert-manager.io/cluster-issuer: &quot;letsencrypt-prod&quot;</span><br><span class="line">  hosts:</span><br><span class="line">    - host: chat.example.com</span><br><span class="line">      paths:</span><br><span class="line">        - path: /</span><br><span class="line">          pathType: Prefix</span><br><span class="line">  tls:</span><br><span class="line">   - secretName: chat-tls</span><br><span class="line">     hosts:</span><br><span class="line">       - chat.example.com</span><br><span class="line"></span><br><span class="line">resources:</span><br><span class="line">  limits:</span><br><span class="line">    cpu: 200m</span><br><span class="line">    memory: 512Mi</span><br><span class="line">  requests:</span><br><span class="line">    cpu: 100m</span><br><span class="line">    memory: 256Mi</span><br><span class="line"></span><br><span class="line">autoscaling:</span><br><span class="line">  enabled: true</span><br><span class="line">  minReplicas: 2</span><br><span class="line">  maxReplicas: 10</span><br><span class="line">  targetCPUUtilizationPercentage: 70</span><br><span class="line">  targetMemoryUtilizationPercentage: 80</span><br><span class="line"></span><br><span class="line">nodeSelector: &#123;&#125;</span><br><span class="line"></span><br><span class="line">tolerations: []</span><br><span class="line"></span><br><span class="line">affinity: &#123;&#125;</span><br><span class="line"></span><br><span class="line">config:</span><br><span class="line">  mysql:</span><br><span class="line">    host: mysql-chat</span><br><span class="line">    port: 3306</span><br><span class="line">    database: chat_room</span><br><span class="line">    username: chat_user</span><br><span class="line">    password: chat123</span><br><span class="line">  redis:</span><br><span class="line">    host: redis-chat</span><br><span class="line">    port: 6379</span><br><span class="line">  kafka:</span><br><span class="line">    bootstrapServers: kafka-chat:9092</span><br><span class="line">  jwt:</span><br><span class="line">    secret: your-super-secret-jwt-key</span><br><span class="line">    expiration: 86400000</span><br></pre></td></tr></table></figure>



<h2 id="8-监控和告警"><a href="#8-监控和告警" class="headerlink" title="8. 监控和告警"></a>8. 监控和告警</h2><h3 id="8-1-Prometheus配置"><a href="#8-1-Prometheus配置" class="headerlink" title="8.1 Prometheus配置"></a>8.1 Prometheus配置</h3><p>yaml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># monitoring/prometheus.yml</span><br><span class="line">global:</span><br><span class="line">  scrape_interval: 15s</span><br><span class="line">  evaluation_interval: 15s</span><br><span class="line"></span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">    - static_configs:</span><br><span class="line">        - targets: [&#x27;alertmanager:9093&#x27;]</span><br><span class="line"></span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;rules/*.yml&quot;</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &#x27;kubernetes-pods&#x27;</span><br><span class="line">    kubernetes_sd_configs:</span><br><span class="line">      - role: pod</span><br><span class="line">    relabel_configs:</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">        action: keep</span><br><span class="line">        regex: true</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: __metrics_path__</span><br><span class="line">        regex: (.+)</span><br><span class="line">      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><br><span class="line">        action: replace</span><br><span class="line">        regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">        replacement: $1:$2</span><br><span class="line">        target_label: __address__</span><br><span class="line">      - action: labelmap</span><br><span class="line">        regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">      - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_namespace</span><br><span class="line">      - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">        action: replace</span><br><span class="line">        target_label: kubernetes_pod_name</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;chat-services&#x27;</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - &#x27;gateway-service.chat-system:8080&#x27;</span><br><span class="line">        - &#x27;auth-service.chat-system:8080&#x27;</span><br><span class="line">        - &#x27;chat-service.chat-system:8080&#x27;</span><br><span class="line">        - &#x27;user-service.chat-system:8080&#x27;</span><br><span class="line">        - &#x27;file-service.chat-system:8080&#x27;</span><br><span class="line">        - &#x27;notification-service.chat-system:8080&#x27;</span><br></pre></td></tr></table></figure>



<h3 id="8-2-Grafana仪表板"><a href="#8-2-Grafana仪表板" class="headerlink" title="8.2 Grafana仪表板"></a>8.2 Grafana仪表板</h3><p>json</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;dashboard&quot;: &#123;</span><br><span class="line">    &quot;title&quot;: &quot;Chat Room Dashboard&quot;,</span><br><span class="line">    &quot;panels&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;title&quot;: &quot;API请求率&quot;,</span><br><span class="line">        &quot;targets&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;expr&quot;: &quot;rate(http_server_requests_seconds_count[5m])&quot;,</span><br><span class="line">            &quot;legendFormat&quot;: &quot;&#123;&#123;method&#125;&#125; &#123;&#123;uri&#125;&#125; &#123;&#123;status&#125;&#125;&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;type&quot;: &quot;graph&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;title&quot;: &quot;JVM内存使用&quot;,</span><br><span class="line">        &quot;targets&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;expr&quot;: &quot;jvm_memory_used_bytes&#123;area=\&quot;heap\&quot;&#125;&quot;,</span><br><span class="line">            &quot;legendFormat&quot;: &quot;&#123;&#123;instance&#125;&#125; &#123;&#123;area&#125;&#125;&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;type&quot;: &quot;graph&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;title&quot;: &quot;在线用户数&quot;,</span><br><span class="line">        &quot;targets&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;expr&quot;: &quot;chat_users_online_total&quot;,</span><br><span class="line">            &quot;legendFormat&quot;: &quot;在线用户&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;type&quot;: &quot;stat&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;title&quot;: &quot;消息处理延迟&quot;,</span><br><span class="line">        &quot;targets&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;expr&quot;: &quot;histogram_quantile(0.95, rate(chat_message_processing_duration_seconds_bucket[5m]))&quot;,</span><br><span class="line">            &quot;legendFormat&quot;: &quot;P95延迟&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;type&quot;: &quot;graph&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;title&quot;: &quot;WebSocket连接数&quot;,</span><br><span class="line">        &quot;targets&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;expr&quot;: &quot;chat_websocket_connections&quot;,</span><br><span class="line">            &quot;legendFormat&quot;: &quot;活跃连接&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;type&quot;: &quot;graph&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;title&quot;: &quot;数据库连接池&quot;,</span><br><span class="line">        &quot;targets&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;expr&quot;: &quot;hikaricp_connections_active&quot;,</span><br><span class="line">            &quot;legendFormat&quot;: &quot;活跃连接&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;expr&quot;: &quot;hikaricp_connections_idle&quot;,</span><br><span class="line">            &quot;legendFormat&quot;: &quot;空闲连接&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;type&quot;: &quot;graph&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="9-CI-CD流水线"><a href="#9-CI-CD流水线" class="headerlink" title="9. CI&#x2F;CD流水线"></a>9. CI&#x2F;CD流水线</h2><h3 id="9-1-GitLab-CI配置"><a href="#9-1-GitLab-CI配置" class="headerlink" title="9.1 GitLab CI配置"></a>9.1 GitLab CI配置</h3><p>yaml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"># .gitlab-ci.yml</span><br><span class="line">stages:</span><br><span class="line">  - build</span><br><span class="line">  - test</span><br><span class="line">  - scan</span><br><span class="line">  - package</span><br><span class="line">  - deploy</span><br><span class="line"></span><br><span class="line">variables:</span><br><span class="line">  MAVEN_OPTS: &quot;-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository&quot;</span><br><span class="line">  DOCKER_DRIVER: overlay2</span><br><span class="line">  DOCKER_TLS_CERTDIR: &quot;&quot;</span><br><span class="line"></span><br><span class="line">cache:</span><br><span class="line">  paths:</span><br><span class="line">    - .m2/repository</span><br><span class="line">    - target</span><br><span class="line"></span><br><span class="line">build:</span><br><span class="line">  stage: build</span><br><span class="line">  image: maven:3.8.4-openjdk-11</span><br><span class="line">  script:</span><br><span class="line">    - mvn clean compile -DskipTests</span><br><span class="line">  artifacts:</span><br><span class="line">    paths:</span><br><span class="line">      - target/classes</span><br><span class="line">    expire_in: 1 hour</span><br><span class="line"></span><br><span class="line">unit-test:</span><br><span class="line">  stage: test</span><br><span class="line">  image: maven:3.8.4-openjdk-11</span><br><span class="line">  script:</span><br><span class="line">    - mvn test</span><br><span class="line">  artifacts:</span><br><span class="line">    reports:</span><br><span class="line">      junit:</span><br><span class="line">        - target/surefire-reports/TEST-*.xml</span><br><span class="line">    paths:</span><br><span class="line">      - target/surefire-reports/</span><br><span class="line">    expire_in: 1 week</span><br><span class="line"></span><br><span class="line">integration-test:</span><br><span class="line">  stage: test</span><br><span class="line">  image: maven:3.8.4-openjdk-11</span><br><span class="line">  services:</span><br><span class="line">    - mysql:8.0</span><br><span class="line">    - redis:7-alpine</span><br><span class="line">  variables:</span><br><span class="line">    MYSQL_ROOT_PASSWORD: &quot;test123&quot;</span><br><span class="line">    MYSQL_DATABASE: &quot;chat_test&quot;</span><br><span class="line">  script:</span><br><span class="line">    - mvn verify -Dit.test=*IT</span><br><span class="line">  artifacts:</span><br><span class="line">    reports:</span><br><span class="line">      junit:</span><br><span class="line">        - target/failsafe-reports/TEST-*.xml</span><br><span class="line">    paths:</span><br><span class="line">      - target/failsafe-reports/</span><br><span class="line">    expire_in: 1 week</span><br><span class="line"></span><br><span class="line">sonar-scan:</span><br><span class="line">  stage: scan</span><br><span class="line">  image: maven:3.8.4-openjdk-11</span><br><span class="line">  variables:</span><br><span class="line">    SONAR_USER_HOME: &quot;$&#123;CI_PROJECT_DIR&#125;/.sonar&quot;</span><br><span class="line">    GIT_DEPTH: &quot;0&quot;</span><br><span class="line">  cache:</span><br><span class="line">    key: &quot;$&#123;CI_JOB_NAME&#125;&quot;</span><br><span class="line">    paths:</span><br><span class="line">      - .sonar/cache</span><br><span class="line">  script:</span><br><span class="line">    - mvn sonar:sonar</span><br><span class="line">  only:</span><br><span class="line">    - master</span><br><span class="line">    - merge_requests</span><br><span class="line"></span><br><span class="line">security-scan:</span><br><span class="line">  stage: scan</span><br><span class="line">  image: aquasec/trivy:latest</span><br><span class="line">  script:</span><br><span class="line">    - trivy filesystem --exit-code 1 --no-progress /</span><br><span class="line">  allow_failure: true</span><br><span class="line"></span><br><span class="line">build-image:</span><br><span class="line">  stage: package</span><br><span class="line">  image: docker:20.10.16</span><br><span class="line">  services:</span><br><span class="line">    - docker:20.10.16-dind</span><br><span class="line">  variables:</span><br><span class="line">    DOCKER_HOST: tcp://docker:2375</span><br><span class="line">    DOCKER_TLS_CERTDIR: &quot;&quot;</span><br><span class="line">  script:</span><br><span class="line">    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA .</span><br><span class="line">    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA</span><br><span class="line">  only:</span><br><span class="line">    - master</span><br><span class="line"></span><br><span class="line">deploy-staging:</span><br><span class="line">  stage: deploy</span><br><span class="line">  image: bitnami/kubectl:latest</span><br><span class="line">  script:</span><br><span class="line">    - kubectl config use-context staging</span><br><span class="line">    - kubectl set image deployment/chat-app chat-app=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA -n chat-staging</span><br><span class="line">    - kubectl rollout status deployment/chat-app -n chat-staging</span><br><span class="line">  environment:</span><br><span class="line">    name: staging</span><br><span class="line">    url: https://staging.chat.example.com</span><br><span class="line">  only:</span><br><span class="line">    - master</span><br><span class="line"></span><br><span class="line">deploy-production:</span><br><span class="line">  stage: deploy</span><br><span class="line">  image: bitnami/kubectl:latest</span><br><span class="line">  script:</span><br><span class="line">    - kubectl config use-context production</span><br><span class="line">    - kubectl set image deployment/chat-app chat-app=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA -n chat-production</span><br><span class="line">    - kubectl rollout status deployment/chat-app -n chat-production</span><br><span class="line">  environment:</span><br><span class="line">    name: production</span><br><span class="line">    url: https://chat.example.com</span><br><span class="line">  when: manual</span><br><span class="line">  only:</span><br><span class="line">    - master</span><br></pre></td></tr></table></figure>



<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>这个企业级聊天室扩展方案包含了：</p>
<ol>
<li><strong>微服务架构</strong> - 服务拆分、API网关、服务发现</li>
<li><strong>AI集成</strong> - 智能聊天、翻译、内容审核</li>
<li><strong>实时通信</strong> - 视频通话、屏幕共享、白板协作</li>
<li><strong>消息队列</strong> - Kafka分布式消息处理</li>
<li><strong>容器化部署</strong> - Docker、Kubernetes、Helm</li>
<li><strong>监控告警</strong> - Prometheus、Grafana、告警规则</li>
<li><strong>CI&#x2F;CD</strong> - 完整的持续集成&#x2F;持续部署流水线</li>
<li><strong>安全增强</strong> - 安全扫描、漏洞检测</li>
<li><strong>性能优化</strong> - 水平扩展、自动伸缩、缓存策略</li>
<li><strong>高可用</strong> - 多副本部署、负载均衡、故障转移</li>
</ol>
<p>这个方案可以支持大规模用户并发，具备企业级应用的可靠性、可扩展性和可维护性。您可以根据具体需求选择实现其中的部分或全部功能。</p>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">
    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/e745341b.html" rel="prev" title="Java实践:多人在线地下城">
                  <i class="fa fa-angle-left"></i> Java实践:多人在线地下城
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/5dd55120.html" rel="next" title="Java实践:代办清单">
                  Java实践:代办清单 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa-regular fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder"></span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Word count total">407k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">24:41</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>

  <script class="next-config" data-name="wavedrom" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/wavedrom.min.js","integrity":"sha256-INLAoJc6quTNfiMWkGZniYO2cxE8mHpddnLow1m6RFs="}}</script>
  <script class="next-config" data-name="wavedrom_skin" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/skins/default.js","integrity":"sha256-fduc/Zszk5ezWws2uInY/ALWVmIrmV6VTgXbsYSReFI="}}</script>
  <script src="/js/third-party/tags/wavedrom.js"></script>




  





</body>
</html>
