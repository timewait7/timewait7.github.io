<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"timewait7.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="王国保卫战 - 跨语言实现项目项目概述本游戏是一个跨语言实现的塔防游戏，使用多种编程语言构建不同模块，展示各语言在游戏开发中的适用场景。 技术栈 前端: JavaScript&#x2F;HTML5&#x2F;CSS3 (Canvas绘制) 游戏逻辑服务: Java (Spring Boot) AI与数据分析: Python (Flask&#x2F;Pygame) 高性能计算模块: C (SDL&amp;#">
<meta property="og:type" content="article">
<meta property="og:title" content="多语言王国保卫战设计与实现">
<meta property="og:url" content="http://timewait7.github.io/post/9aaf297a.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="王国保卫战 - 跨语言实现项目项目概述本游戏是一个跨语言实现的塔防游戏，使用多种编程语言构建不同模块，展示各语言在游戏开发中的适用场景。 技术栈 前端: JavaScript&#x2F;HTML5&#x2F;CSS3 (Canvas绘制) 游戏逻辑服务: Java (Spring Boot) AI与数据分析: Python (Flask&#x2F;Pygame) 高性能计算模块: C (SDL&amp;#">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-12-19T10:43:17.000Z">
<meta property="article:modified_time" content="2025-12-19T11:43:07.215Z">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://timewait7.github.io/post/9aaf297a.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://timewait7.github.io/post/9aaf297a.html","path":"post/9aaf297a.html","title":"多语言王国保卫战设计与实现"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>多语言王国保卫战设计与实现 | Hexo</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-archives"><a href="/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="Searching..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%8E%8B%E5%9B%BD%E4%BF%9D%E5%8D%AB%E6%88%98-%E8%B7%A8%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0%E9%A1%B9%E7%9B%AE"><span class="nav-number">1.</span> <span class="nav-text">王国保卫战 - 跨语言实现项目</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E6%A6%82%E8%BF%B0"><span class="nav-number">1.1.</span> <span class="nav-text">项目概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E6%9C%AF%E6%A0%88"><span class="nav-number">1.1.1.</span> <span class="nav-text">技术栈</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="nav-number">1.2.</span> <span class="nav-text">目录结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3"><span class="nav-number">1.3.</span> <span class="nav-text">设计文档</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.3.1.</span> <span class="nav-text">1. 游戏设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-%E6%A0%B8%E5%BF%83%E7%8E%A9%E6%B3%95"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">1.1 核心玩法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-%E6%B8%B8%E6%88%8F%E5%85%83%E7%B4%A0"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">1.2 游戏元素</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%A8%A1%E5%9D%97%E8%AF%A6%E7%BB%86%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.3.2.</span> <span class="nav-text">2. 模块详细设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-%E5%89%8D%E7%AB%AF%E6%A8%A1%E5%9D%97-JavaScript-HTML5"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">2.1 前端模块 (JavaScript&#x2F;HTML5)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1-Java-Spring-Boot"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">2.2 后端服务 (Java&#x2F;Spring Boot)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-AI%E5%BC%95%E6%93%8E-Python"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">2.3 AI引擎 (Python)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-%E6%A0%B8%E5%BF%83%E5%BC%95%E6%93%8E-C"><span class="nav-number">1.3.2.4.</span> <span class="nav-text">2.4 核心引擎 (C)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-Shell%E8%84%9A%E6%9C%AC"><span class="nav-number">1.3.2.5.</span> <span class="nav-text">2.5 Shell脚本</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%90%E6%AD%A5%E5%AE%9E%E7%8E%B0%E6%8C%87%E5%8D%97"><span class="nav-number">1.4.</span> <span class="nav-text">逐步实现指南</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5%EF%BC%9A%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84%E6%90%AD%E5%BB%BA%EF%BC%88%E7%AC%AC1%E5%91%A8%EF%BC%89"><span class="nav-number">1.4.1.</span> <span class="nav-text">第一阶段：基础架构搭建（第1周）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A41%EF%BC%9A%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">步骤1：创建项目结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A42%EF%BC%9AHTML5%E5%89%8D%E7%AB%AF%E5%9F%BA%E7%A1%80"><span class="nav-number">1.4.1.2.</span> <span class="nav-text">步骤2：HTML5前端基础</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A43%EF%BC%9A%E5%9F%BA%E7%A1%80CSS"><span class="nav-number">1.4.1.3.</span> <span class="nav-text">步骤3：基础CSS</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5%EF%BC%9AJavaScript%E6%B8%B8%E6%88%8F%E6%A0%B8%E5%BF%83%EF%BC%88%E7%AC%AC2-3%E5%91%A8%EF%BC%89"><span class="nav-number">1.4.2.</span> <span class="nav-text">第二阶段：JavaScript游戏核心（第2-3周）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A44%EF%BC%9A%E6%B8%B8%E6%88%8F%E7%AE%A1%E7%90%86%E5%99%A8"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">步骤4：游戏管理器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A45%EF%BC%9A%E5%AE%9E%E4%BD%93%E7%B1%BB%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">步骤5：实体类实现</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%EF%BC%9AJava%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1%EF%BC%88%E7%AC%AC4%E5%91%A8%EF%BC%89"><span class="nav-number">1.4.3.</span> <span class="nav-text">第三阶段：Java后端服务（第4周）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A46%EF%BC%9ASpring-Boot%E5%BA%94%E7%94%A8"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">步骤6：Spring Boot应用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E9%98%B6%E6%AE%B5%EF%BC%9APython-AI%E6%A8%A1%E5%9D%97%EF%BC%88%E7%AC%AC5%E5%91%A8%EF%BC%89"><span class="nav-number">1.4.4.</span> <span class="nav-text">第四阶段：Python AI模块（第5周）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A47%EF%BC%9AAI%E5%BC%95%E6%93%8E"><span class="nav-number">1.4.4.1.</span> <span class="nav-text">步骤7：AI引擎</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%BA%94%E9%98%B6%E6%AE%B5%EF%BC%9AC%E6%A0%B8%E5%BF%83%E5%BC%95%E6%93%8E%EF%BC%88%E7%AC%AC6%E5%91%A8%EF%BC%89"><span class="nav-number">1.4.5.</span> <span class="nav-text">第五阶段：C核心引擎（第6周）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A48%EF%BC%9A%E9%AB%98%E6%80%A7%E8%83%BD%E8%B7%AF%E5%BE%84%E6%9F%A5%E6%89%BE"><span class="nav-number">1.4.5.1.</span> <span class="nav-text">步骤8：高性能路径查找</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E5%85%AD%E9%98%B6%E6%AE%B5%EF%BC%9AShell%E8%87%AA%E5%8A%A8%E5%8C%96%E8%84%9A%E6%9C%AC%EF%BC%88%E7%AC%AC7%E5%91%A8%EF%BC%89"><span class="nav-number">1.4.6.</span> <span class="nav-text">第六阶段：Shell自动化脚本（第7周）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A49%EF%BC%9A%E6%9E%84%E5%BB%BA%E5%92%8C%E9%83%A8%E7%BD%B2%E8%84%9A%E6%9C%AC"><span class="nav-number">1.4.6.1.</span> <span class="nav-text">步骤9：构建和部署脚本</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E"><span class="nav-number">1.5.</span> <span class="nav-text">配置说明</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E7%8E%AF%E5%A2%83%E8%A6%81%E6%B1%82"><span class="nav-number">1.5.1.</span> <span class="nav-text">1. 环境要求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4"><span class="nav-number">1.5.2.</span> <span class="nav-text">2. 安装步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F%E5%90%AF%E5%8A%A8"><span class="nav-number">1.5.3.</span> <span class="nav-text">3. 开发模式启动</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.6.</span> <span class="nav-text">扩展建议</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%B8%B8%E6%88%8F%E5%8A%9F%E8%83%BD%E6%89%A9%E5%B1%95"><span class="nav-number">1.6.1.</span> <span class="nav-text">1. 游戏功能扩展</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%8A%80%E6%9C%AF%E4%BC%98%E5%8C%96"><span class="nav-number">1.6.2.</span> <span class="nav-text">2. 技术优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E9%83%A8%E7%BD%B2%E4%BC%98%E5%8C%96"><span class="nav-number">1.6.3.</span> <span class="nav-text">3. 部署优化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%83%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%89%A9%E5%B1%95%E5%89%8D%E7%AB%AF%E5%8A%9F%E8%83%BD%EF%BC%88%E7%AC%AC8%E5%91%A8%EF%BC%89"><span class="nav-number">1.7.</span> <span class="nav-text">第七阶段：扩展前端功能（第8周）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A410%EF%BC%9A%E5%AE%8C%E5%96%84%E6%B8%B8%E6%88%8F%E5%8A%9F%E8%83%BD"><span class="nav-number">1.7.1.</span> <span class="nav-text">步骤10：完善游戏功能</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#10-1-%E6%B7%BB%E5%8A%A0%E6%9B%B4%E5%A4%9A%E5%A1%94%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.7.1.1.</span> <span class="nav-text">10.1 添加更多塔类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-2-%E6%B7%BB%E5%8A%A0%E5%A3%AB%E5%85%B5%E7%B1%BB%EF%BC%88%E7%94%A8%E4%BA%8E%E5%85%B5%E8%90%A5%EF%BC%89"><span class="nav-number">1.7.1.2.</span> <span class="nav-text">10.2 添加士兵类（用于兵营）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-3-%E6%89%A9%E5%B1%95%E6%95%8C%E4%BA%BA%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.7.1.3.</span> <span class="nav-text">10.3 扩展敌人类型</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%85%AB%E9%98%B6%E6%AE%B5%EF%BC%9A%E5%AE%8C%E5%96%84Java%E5%90%8E%E7%AB%AF%EF%BC%88%E7%AC%AC9%E5%91%A8%EF%BC%89"><span class="nav-number">1.8.</span> <span class="nav-text">第八阶段：完善Java后端（第9周）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A411%EF%BC%9A%E6%89%A9%E5%B1%95%E5%90%8E%E7%AB%AF%E5%8A%9F%E8%83%BD"><span class="nav-number">1.8.1.</span> <span class="nav-text">步骤11：扩展后端功能</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#11-1-%E6%B7%BB%E5%8A%A0%E6%B8%B8%E6%88%8F%E7%8A%B6%E6%80%81%E4%BF%9D%E5%AD%98%E5%92%8C%E5%8A%A0%E8%BD%BD"><span class="nav-number">1.8.1.1.</span> <span class="nav-text">11.1 添加游戏状态保存和加载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-2-%E6%B7%BB%E5%8A%A0%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1%E5%92%8C%E5%88%86%E6%9E%90"><span class="nav-number">1.8.1.2.</span> <span class="nav-text">11.2 添加数据统计和分析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B9%9D%E9%98%B6%E6%AE%B5%EF%BC%9A%E5%AE%8C%E5%96%84Python-AI%E5%BC%95%E6%93%8E%EF%BC%88%E7%AC%AC10%E5%91%A8%EF%BC%89"><span class="nav-number">1.9.</span> <span class="nav-text">第九阶段：完善Python AI引擎（第10周）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A412%EF%BC%9A%E6%89%A9%E5%B1%95AI%E5%8A%9F%E8%83%BD"><span class="nav-number">1.9.1.</span> <span class="nav-text">步骤12：扩展AI功能</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#12-1-%E6%B7%BB%E5%8A%A0%E9%81%97%E4%BC%A0%E7%AE%97%E6%B3%95%E4%BC%98%E5%8C%96%E5%A1%94%E9%98%B2%E5%B8%83%E5%B1%80"><span class="nav-number">1.9.1.1.</span> <span class="nav-text">12.1 添加遗传算法优化塔防布局</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%8D%81%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%89%A9%E5%B1%95C%E6%A0%B8%E5%BF%83%E5%BC%95%E6%93%8E%EF%BC%88%E7%AC%AC11%E5%91%A8%EF%BC%89"><span class="nav-number">1.10.</span> <span class="nav-text">第十阶段：扩展C核心引擎（第11周）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A413%EF%BC%9A%E4%BC%98%E5%8C%96%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B%E5%92%8C%E7%89%A9%E7%90%86%E5%BC%95%E6%93%8E"><span class="nav-number">1.10.1.</span> <span class="nav-text">步骤13：优化碰撞检测和物理引擎</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.11.</span> <span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E7%AB%AF%E6%89%A9%E5%B1%95%EF%BC%9A"><span class="nav-number">1.11.1.</span> <span class="nav-text">前端扩展：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8E%E7%AB%AF%E6%89%A9%E5%B1%95%EF%BC%9A"><span class="nav-number">1.11.2.</span> <span class="nav-text">后端扩展：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AI%E5%BC%95%E6%93%8E%E6%89%A9%E5%B1%95%EF%BC%9A"><span class="nav-number">1.11.3.</span> <span class="nav-text">AI引擎扩展：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#C%E6%A0%B8%E5%BF%83%E5%BC%95%E6%93%8E%E6%89%A9%E5%B1%95%EF%BC%9A"><span class="nav-number">1.11.4.</span> <span class="nav-text">C核心引擎扩展：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%8E%8B%E5%9B%BD%E4%BF%9D%E5%8D%AB%E6%88%98-%E5%AE%8C%E6%95%B4%E6%89%A9%E5%B1%95%E4%B8%8E%E4%BC%98%E5%8C%96"><span class="nav-number">2.</span> <span class="nav-text">王国保卫战 - 完整扩展与优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%8D%81%E4%B8%80%E9%98%B6%E6%AE%B5%EF%BC%9A%E5%89%8D%E7%AB%AFUI%E7%B3%BB%E7%BB%9F%E4%B8%8E%E7%89%B9%E6%95%88%E4%BC%98%E5%8C%96%EF%BC%88%E7%AC%AC8%E5%91%A8%EF%BC%89"><span class="nav-number">2.1.</span> <span class="nav-text">第十一阶段：前端UI系统与特效优化（第8周）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A410%EF%BC%9A%E6%89%A9%E5%B1%95UI%E7%B3%BB%E7%BB%9F%E5%92%8C%E7%B2%92%E5%AD%90%E7%89%B9%E6%95%88"><span class="nav-number">2.1.1.</span> <span class="nav-text">步骤10：扩展UI系统和粒子特效</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#10-1-%E5%88%9B%E5%BB%BA%E5%A2%9E%E5%BC%BA%E7%9A%84UI%E7%AE%A1%E7%90%86%E5%99%A8"><span class="nav-number">2.1.1.1.</span> <span class="nav-text">10.1 创建增强的UI管理器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-2-%E6%B7%BB%E5%8A%A0%E7%B2%92%E5%AD%90%E7%B3%BB%E7%BB%9F"><span class="nav-number">2.1.1.2.</span> <span class="nav-text">10.2 添加粒子系统</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-3-%E6%B7%BB%E5%8A%A0CSS%E6%A0%B7%E5%BC%8F"><span class="nav-number">2.1.1.3.</span> <span class="nav-text">10.3 添加CSS样式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%8D%81%E4%BA%8C%E9%98%B6%E6%AE%B5%EF%BC%9AJava%E5%90%8E%E7%AB%AF%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD%EF%BC%88%E7%AC%AC9%E5%91%A8%EF%BC%89"><span class="nav-number">2.2.</span> <span class="nav-text">第十二阶段：Java后端高级功能（第9周）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A411%EF%BC%9A%E5%AE%9E%E7%8E%B0%E5%A4%9A%E4%BA%BA%E6%B8%B8%E6%88%8F%E5%92%8C%E5%AE%9E%E6%97%B6%E9%80%9A%E4%BF%A1"><span class="nav-number">2.2.1.</span> <span class="nav-text">步骤11：实现多人游戏和实时通信</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#11-1-%E6%B7%BB%E5%8A%A0WebSocket%E6%94%AF%E6%8C%81"><span class="nav-number">2.2.1.1.</span> <span class="nav-text">11.1 添加WebSocket支持</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-2-%E5%88%9B%E5%BB%BA%E5%A4%9A%E4%BA%BA%E6%B8%B8%E6%88%8F%E6%9C%8D%E5%8A%A1"><span class="nav-number">2.2.1.2.</span> <span class="nav-text">11.2 创建多人游戏服务</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%8D%81%E4%B8%89%E9%98%B6%E6%AE%B5%EF%BC%9APython-AI%E5%BC%95%E6%93%8E%E5%A2%9E%E5%BC%BA%EF%BC%88%E7%AC%AC10%E5%91%A8%EF%BC%89"><span class="nav-number">2.3.</span> <span class="nav-text">第十三阶段：Python AI引擎增强（第10周）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A412%EF%BC%9A%E5%AE%9E%E7%8E%B0%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E6%95%8C%E4%BA%BAAI%E5%92%8C%E6%B8%B8%E6%88%8F%E5%B9%B3%E8%A1%A1"><span class="nav-number">2.3.1.</span> <span class="nav-text">步骤12：实现深度学习敌人AI和游戏平衡</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#12-1-%E4%BD%BF%E7%94%A8%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E9%A2%84%E6%B5%8B%E7%8E%A9%E5%AE%B6%E8%A1%8C%E4%B8%BA"><span class="nav-number">2.3.1.1.</span> <span class="nav-text">12.1 使用深度学习预测玩家行为</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-2-%E6%B8%B8%E6%88%8F%E5%B9%B3%E8%A1%A1%E5%88%86%E6%9E%90%E7%B3%BB%E7%BB%9F"><span class="nav-number">2.3.1.2.</span> <span class="nav-text">12.2 游戏平衡分析系统</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%8D%81%E5%9B%9B%E9%98%B6%E6%AE%B5%EF%BC%9AC%E5%BC%95%E6%93%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%EF%BC%88%E7%AC%AC11%E5%91%A8%EF%BC%89"><span class="nav-number">2.4.</span> <span class="nav-text">第十四阶段：C引擎性能优化（第11周）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A413%EF%BC%9A%E5%AE%9E%E7%8E%B0%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%92%8CSIMD%E4%BC%98%E5%8C%96"><span class="nav-number">2.4.1.</span> <span class="nav-text">步骤13：实现多线程和SIMD优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#13-1-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E8%B7%AF%E5%BE%84%E6%9F%A5%E6%89%BE%E4%BC%98%E5%8C%96"><span class="nav-number">2.4.1.1.</span> <span class="nav-text">13.1 多线程路径查找优化</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-1"><span class="nav-number">2.5.</span> <span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E7%AB%AF%E5%A2%9E%E5%BC%BA%EF%BC%9A"><span class="nav-number">2.5.1.</span> <span class="nav-text">前端增强：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8E%E7%AB%AF%E5%A2%9E%E5%BC%BA%EF%BC%9A"><span class="nav-number">2.5.2.</span> <span class="nav-text">后端增强：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AI%E5%BC%95%E6%93%8E%E5%A2%9E%E5%BC%BA%EF%BC%9A"><span class="nav-number">2.5.3.</span> <span class="nav-text">AI引擎增强：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#C%E5%BC%95%E6%93%8E%E5%A2%9E%E5%BC%BA%EF%BC%9A"><span class="nav-number">2.5.4.</span> <span class="nav-text">C引擎增强：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E5%BB%BA%E8%AE%AE%EF%BC%9A"><span class="nav-number">2.5.5.</span> <span class="nav-text">部署建议：</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/">
          <span class="site-state-item-count">58</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>

    
        <div class="sidebar-inner sidebar-post-related">
          <div class="animated">
              <div class="links-of-blogroll-title"><i class="fa fa-signs-post fa-fw"></i>
    Related Posts
  </div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/post/2c7fedc6.html" rel="bookmark">
        <time class="popular-posts-time">2025-12-17</time>
        <br>
      Python实践-多线程下载管理器
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/post/1aa6cbcd.html" rel="bookmark">
        <time class="popular-posts-time">2025-10-04</time>
        <br>
      命令速查表
      </a>
    </li>
  </ul>

          </div>
        </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://timewait7.github.io/post/9aaf297a.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="多语言王国保卫战设计与实现 | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          多语言王国保卫战设计与实现
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-12-19 18:43:17" itemprop="dateCreated datePublished" datetime="2025-12-19T18:43:17+08:00">2025-12-19</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>22k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1:21</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="王国保卫战-跨语言实现项目"><a href="#王国保卫战-跨语言实现项目" class="headerlink" title="王国保卫战 - 跨语言实现项目"></a>王国保卫战 - 跨语言实现项目</h1><h2 id="项目概述"><a href="#项目概述" class="headerlink" title="项目概述"></a>项目概述</h2><p>本游戏是一个跨语言实现的塔防游戏，使用多种编程语言构建不同模块，展示各语言在游戏开发中的适用场景。</p>
<h3 id="技术栈"><a href="#技术栈" class="headerlink" title="技术栈"></a>技术栈</h3><ul>
<li><strong>前端</strong>: JavaScript&#x2F;HTML5&#x2F;CSS3 (Canvas绘制)</li>
<li><strong>游戏逻辑服务</strong>: Java (Spring Boot)</li>
<li><strong>AI与数据分析</strong>: Python (Flask&#x2F;Pygame)</li>
<li><strong>高性能计算模块</strong>: C (SDL&#x2F;路径算法)</li>
<li><strong>构建与部署</strong>: Shell脚本</li>
</ul>
<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><p>text</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">kingdom-defense/</span><br><span class="line">├── frontend/                    # HTML5前端</span><br><span class="line">│   ├── index.html</span><br><span class="line">│   ├── css/</span><br><span class="line">│   │   ├── style.css</span><br><span class="line">│   │   └── game.css</span><br><span class="line">│   ├── js/</span><br><span class="line">│   │   ├── game.js</span><br><span class="line">│   │   ├── renderer.js</span><br><span class="line">│   │   ├── entities/</span><br><span class="line">│   │   │   ├── tower.js</span><br><span class="line">│   │   │   ├── enemy.js</span><br><span class="line">│   │   │   ├── bullet.js</span><br><span class="line">│   │   │   └── particle.js</span><br><span class="line">│   │   ├── managers/</span><br><span class="line">│   │   │   ├── gameManager.js</span><br><span class="line">│   │   │   ├── levelManager.js</span><br><span class="line">│   │   │   └── resourceManager.js</span><br><span class="line">│   │   ├── utils/</span><br><span class="line">│   │   │   ├── pathfinding.js</span><br><span class="line">│   │   │   ├── collision.js</span><br><span class="line">│   │   │   └── math.js</span><br><span class="line">│   │   └── ui/</span><br><span class="line">│   │       ├── uiManager.js</span><br><span class="line">│   │       ├── menu.js</span><br><span class="line">│   │       └── hud.js</span><br><span class="line">│   └── assets/</span><br><span class="line">│       ├── images/</span><br><span class="line">│       ├── sounds/</span><br><span class="line">│       └── fonts/</span><br><span class="line">├── backend/                     # Java后端服务</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   ├── src/main/java/</span><br><span class="line">│   │   └── com/kingdomdefense/</span><br><span class="line">│   │       ├── KingdomDefenseApplication.java</span><br><span class="line">│   │       ├── config/</span><br><span class="line">│   │       ├── controller/</span><br><span class="line">│   │       │   ├── GameController.java</span><br><span class="line">│   │       │   ├── UserController.java</span><br><span class="line">│   │       │   └── ScoreController.java</span><br><span class="line">│   │       ├── service/</span><br><span class="line">│   │       │   ├── GameService.java</span><br><span class="line">│   │       │   ├── UserService.java</span><br><span class="line">│   │       │   └── ScoreService.java</span><br><span class="line">│   │       ├── repository/</span><br><span class="line">│   │       │   ├── UserRepository.java</span><br><span class="line">│   │       │   └── ScoreRepository.java</span><br><span class="line">│   │       ├── model/</span><br><span class="line">│   │       │   ├── User.java</span><br><span class="line">│   │       │   ├── GameState.java</span><br><span class="line">│   │       │   ├── Tower.java</span><br><span class="line">│   │       │   └── Enemy.java</span><br><span class="line">│   │       ├── dto/</span><br><span class="line">│   │       └── exception/</span><br><span class="line">│   ├── src/main/resources/</span><br><span class="line">│   │   ├── application.properties</span><br><span class="line">│   │   └── data.sql</span><br><span class="line">│   └── Dockerfile</span><br><span class="line">├── ai-engine/                   # Python AI模块</span><br><span class="line">│   ├── requirements.txt</span><br><span class="line">│   ├── app.py</span><br><span class="line">│   ├── game_ai/</span><br><span class="line">│   │   ├── __init__.py</span><br><span class="line">│   │   ├── enemy_ai.py</span><br><span class="line">│   │   ├── tower_placement_ai.py</span><br><span class="line">│   │   └── genetic_algorithm.py</span><br><span class="line">│   ├── analysis/</span><br><span class="line">│   │   ├── data_analyzer.py</span><br><span class="line">│   │   └── visualization.py</span><br><span class="line">│   ├── simulations/</span><br><span class="line">│   │   └── test_simulation.py</span><br><span class="line">│   └── models/</span><br><span class="line">│       └── saved_models/</span><br><span class="line">├── engine-core/                 # C核心引擎</span><br><span class="line">│   ├── Makefile</span><br><span class="line">│   ├── src/</span><br><span class="line">│   │   ├── main.c</span><br><span class="line">│   │   ├── game_engine.c</span><br><span class="line">│   │   ├── pathfinding/</span><br><span class="line">│   │   │   ├── a_star.c</span><br><span class="line">│   │   │   └── collision.c</span><br><span class="line">│   │   ├── physics/</span><br><span class="line">│   │   │   ├── collision_detection.c</span><br><span class="line">│   │   │   └── projectile_physics.c</span><br><span class="line">│   │   └── utils/</span><br><span class="line">│   │       ├── math_utils.c</span><br><span class="line">│   │       └── memory_pool.c</span><br><span class="line">│   ├── include/</span><br><span class="line">│   └── tests/</span><br><span class="line">├── scripts/                     # Shell脚本</span><br><span class="line">│   ├── build_all.sh</span><br><span class="line">│   ├── deploy.sh</span><br><span class="line">│   ├── start_services.sh</span><br><span class="line">│   └── generate_assets.sh</span><br><span class="line">├── docker-compose.yml</span><br><span class="line">├── README.md</span><br><span class="line">└── design-document.md</span><br></pre></td></tr></table></figure>



<h2 id="设计文档"><a href="#设计文档" class="headerlink" title="设计文档"></a>设计文档</h2><h3 id="1-游戏设计"><a href="#1-游戏设计" class="headerlink" title="1. 游戏设计"></a>1. 游戏设计</h3><h4 id="1-1-核心玩法"><a href="#1-1-核心玩法" class="headerlink" title="1.1 核心玩法"></a>1.1 核心玩法</h4><ul>
<li>塔防游戏，玩家在地图上建造防御塔阻止敌人到达终点</li>
<li>多种敌人类型（步兵、骑兵、飞行单位等）</li>
<li>多种防御塔类型（弓箭塔、魔法塔、炮塔等）</li>
<li>技能系统（英雄技能、全局技能）</li>
<li>升级系统（塔升级、科技升级）</li>
</ul>
<h4 id="1-2-游戏元素"><a href="#1-2-游戏元素" class="headerlink" title="1.2 游戏元素"></a>1.2 游戏元素</h4><ol>
<li><strong>防御塔</strong><ul>
<li>弓箭塔：快速攻击，对轻甲有效</li>
<li>魔法塔：魔法攻击，对魔抗低的敌人有效</li>
<li>炮塔：范围攻击，攻速慢但伤害高</li>
<li>兵营：生产士兵阻挡敌人</li>
</ul>
</li>
<li><strong>敌人类型</strong><ul>
<li>普通步兵：基础敌人</li>
<li>重甲士兵：高防御，移动慢</li>
<li>骑兵：移动快，血量中等</li>
<li>飞行单位：无视地形，只能被特定塔攻击</li>
<li>BOSS：高血量，特殊能力</li>
</ul>
</li>
<li><strong>英雄系统</strong><ul>
<li>可操控英雄单位</li>
<li>特殊技能</li>
<li>等级成长</li>
</ul>
</li>
</ol>
<h3 id="2-模块详细设计"><a href="#2-模块详细设计" class="headerlink" title="2. 模块详细设计"></a>2. 模块详细设计</h3><h4 id="2-1-前端模块-JavaScript-HTML5"><a href="#2-1-前端模块-JavaScript-HTML5" class="headerlink" title="2.1 前端模块 (JavaScript&#x2F;HTML5)"></a>2.1 前端模块 (JavaScript&#x2F;HTML5)</h4><p><strong>架构</strong>: MVC模式</p>
<ul>
<li><strong>Model</strong>: 游戏数据模型</li>
<li><strong>View</strong>: Canvas渲染器</li>
<li><strong>Controller</strong>: 游戏逻辑控制器</li>
</ul>
<p><strong>关键技术</strong>:</p>
<ul>
<li>HTML5 Canvas 2D渲染</li>
<li>Web Audio API 音效</li>
<li>localStorage 本地存储</li>
<li>WebSocket 实时通信</li>
</ul>
<h4 id="2-2-后端服务-Java-Spring-Boot"><a href="#2-2-后端服务-Java-Spring-Boot" class="headerlink" title="2.2 后端服务 (Java&#x2F;Spring Boot)"></a>2.2 后端服务 (Java&#x2F;Spring Boot)</h4><p><strong>功能</strong>:</p>
<ul>
<li>用户管理（注册&#x2F;登录）</li>
<li>游戏存档</li>
<li>排行榜</li>
<li>数据统计</li>
</ul>
<p><strong>API设计</strong>:</p>
<p>text</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET    /api/users/&#123;id&#125;</span><br><span class="line">POST   /api/users</span><br><span class="line">PUT    /api/users/&#123;id&#125;</span><br><span class="line">POST   /api/scores</span><br><span class="line">GET    /api/leaderboard</span><br><span class="line">POST   /api/game/save</span><br><span class="line">GET    /api/game/load/&#123;id&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-3-AI引擎-Python"><a href="#2-3-AI引擎-Python" class="headerlink" title="2.3 AI引擎 (Python)"></a>2.3 AI引擎 (Python)</h4><p><strong>功能</strong>:</p>
<ul>
<li>敌人AI行为</li>
<li>自动塔防布局建议</li>
<li>游戏数据分析</li>
<li>难度自适应调整</li>
</ul>
<p><strong>技术栈</strong>:</p>
<ul>
<li>Flask REST API</li>
<li>NumPy&#x2F;Pandas 数据分析</li>
<li>Scikit-learn 机器学习</li>
<li>Pygame 模拟测试</li>
</ul>
<h4 id="2-4-核心引擎-C"><a href="#2-4-核心引擎-C" class="headerlink" title="2.4 核心引擎 (C)"></a>2.4 核心引擎 (C)</h4><p><strong>功能</strong>:</p>
<ul>
<li>高性能路径查找(A*算法)</li>
<li>碰撞检测</li>
<li>粒子系统</li>
<li>内存管理</li>
</ul>
<p><strong>优化目标</strong>:</p>
<ul>
<li>支持数千单位同时计算</li>
<li>60FPS稳定运行</li>
<li>低内存占用</li>
</ul>
<h4 id="2-5-Shell脚本"><a href="#2-5-Shell脚本" class="headerlink" title="2.5 Shell脚本"></a>2.5 Shell脚本</h4><p><strong>功能</strong>:</p>
<ul>
<li>自动化构建</li>
<li>服务部署</li>
<li>资源处理</li>
<li>环境配置</li>
</ul>
<h2 id="逐步实现指南"><a href="#逐步实现指南" class="headerlink" title="逐步实现指南"></a>逐步实现指南</h2><h3 id="第一阶段：基础架构搭建（第1周）"><a href="#第一阶段：基础架构搭建（第1周）" class="headerlink" title="第一阶段：基础架构搭建（第1周）"></a>第一阶段：基础架构搭建（第1周）</h3><h4 id="步骤1：创建项目结构"><a href="#步骤1：创建项目结构" class="headerlink" title="步骤1：创建项目结构"></a>步骤1：创建项目结构</h4><p>bash</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 创建基础目录</span><br><span class="line">mkdir -p kingdom-defense/&#123;frontend,backend,ai-engine,engine-core,scripts&#125;</span><br><span class="line"></span><br><span class="line"># 创建前端目录</span><br><span class="line">mkdir -p frontend/&#123;css,js/&#123;entities,managers,utils,ui&#125;,assets/&#123;images,sounds,fonts&#125;&#125;</span><br><span class="line"></span><br><span class="line"># 创建Java后端目录</span><br><span class="line">mkdir -p backend/src/main/java/com/kingdomdefense/&#123;config,controller,service,repository,model,dto,exception&#125;</span><br><span class="line"></span><br><span class="line"># 创建Python AI目录</span><br><span class="line">mkdir -p ai-engine/&#123;game_ai,analysis,simulations,models/saved_models&#125;</span><br><span class="line"></span><br><span class="line"># 创建C引擎目录</span><br><span class="line">mkdir -p engine-core/&#123;src/&#123;pathfinding,physics,utils&#125;,include,tests&#125;</span><br></pre></td></tr></table></figure>



<h4 id="步骤2：HTML5前端基础"><a href="#步骤2：HTML5前端基础" class="headerlink" title="步骤2：HTML5前端基础"></a>步骤2：HTML5前端基础</h4><p>创建 <code>frontend/index.html</code>:</p>
<p>html</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br><span class="line">    &lt;title&gt;Kingdom Defense&lt;/title&gt;</span><br><span class="line">    &lt;link rel=&quot;stylesheet&quot; href=&quot;css/style.css&quot;&gt;</span><br><span class="line">    &lt;link rel=&quot;stylesheet&quot; href=&quot;css/game.css&quot;&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;div id=&quot;game-container&quot;&gt;</span><br><span class="line">        &lt;canvas id=&quot;game-canvas&quot; width=&quot;1024&quot; height=&quot;768&quot;&gt;&lt;/canvas&gt;</span><br><span class="line">        &lt;div id=&quot;ui-overlay&quot;&gt;</span><br><span class="line">            &lt;div id=&quot;hud&quot;&gt;</span><br><span class="line">                &lt;div class=&quot;resources&quot;&gt;</span><br><span class="line">                    &lt;span id=&quot;gold&quot;&gt;100&lt;/span&gt;</span><br><span class="line">                    &lt;span id=&quot;lives&quot;&gt;20&lt;/span&gt;</span><br><span class="line">                    &lt;span id=&quot;wave&quot;&gt;1/10&lt;/span&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div id=&quot;tower-selection&quot;&gt;&lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div id=&quot;menu&quot; class=&quot;hidden&quot;&gt;</span><br><span class="line">                &lt;button id=&quot;resume-btn&quot;&gt;Resume&lt;/button&gt;</span><br><span class="line">                &lt;button id=&quot;restart-btn&quot;&gt;Restart&lt;/button&gt;</span><br><span class="line">                &lt;button id=&quot;quit-btn&quot;&gt;Quit&lt;/button&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;script src=&quot;js/utils/math.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=&quot;js/utils/collision.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=&quot;js/utils/pathfinding.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=&quot;js/entities/tower.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=&quot;js/entities/enemy.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=&quot;js/entities/bullet.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=&quot;js/managers/gameManager.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=&quot;js/managers/levelManager.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=&quot;js/ui/uiManager.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=&quot;js/renderer.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=&quot;js/game.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>



<h4 id="步骤3：基础CSS"><a href="#步骤3：基础CSS" class="headerlink" title="步骤3：基础CSS"></a>步骤3：基础CSS</h4><p>创建 <code>frontend/css/style.css</code>:</p>
<p>css</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">* &#123;</span><br><span class="line">    margin: 0;</span><br><span class="line">    padding: 0;</span><br><span class="line">    box-sizing: border-box;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body &#123;</span><br><span class="line">    font-family: &#x27;Arial&#x27;, sans-serif;</span><br><span class="line">    background: #1a1a2e;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    align-items: center;</span><br><span class="line">    min-height: 100vh;</span><br><span class="line">    overflow: hidden;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#game-container &#123;</span><br><span class="line">    position: relative;</span><br><span class="line">    border: 3px solid #0f3460;</span><br><span class="line">    border-radius: 10px;</span><br><span class="line">    overflow: hidden;</span><br><span class="line">    box-shadow: 0 0 30px rgba(79, 195, 247, 0.3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#game-canvas &#123;</span><br><span class="line">    display: block;</span><br><span class="line">    background: #162447;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#ui-overlay &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    top: 0;</span><br><span class="line">    left: 0;</span><br><span class="line">    width: 100%;</span><br><span class="line">    height: 100%;</span><br><span class="line">    pointer-events: none;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#hud &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    top: 10px;</span><br><span class="line">    left: 10px;</span><br><span class="line">    right: 10px;</span><br><span class="line">    background: rgba(15, 52, 96, 0.8);</span><br><span class="line">    border-radius: 8px;</span><br><span class="line">    padding: 15px;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    align-items: center;</span><br><span class="line">    pointer-events: all;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.resources &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    gap: 20px;</span><br><span class="line">    color: #e94560;</span><br><span class="line">    font-size: 20px;</span><br><span class="line">    font-weight: bold;</span><br><span class="line">    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.resources span &#123;</span><br><span class="line">    padding: 5px 15px;</span><br><span class="line">    background: rgba(233, 69, 96, 0.2);</span><br><span class="line">    border-radius: 5px;</span><br><span class="line">    border: 1px solid #e94560;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#menu &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    top: 50%;</span><br><span class="line">    left: 50%;</span><br><span class="line">    transform: translate(-50%, -50%);</span><br><span class="line">    background: rgba(15, 52, 96, 0.95);</span><br><span class="line">    padding: 40px;</span><br><span class="line">    border-radius: 15px;</span><br><span class="line">    border: 2px solid #4fc3f7;</span><br><span class="line">    display: flex;</span><br><span class="line">    flex-direction: column;</span><br><span class="line">    gap: 20px;</span><br><span class="line">    pointer-events: all;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#menu.hidden &#123;</span><br><span class="line">    display: none;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#menu button &#123;</span><br><span class="line">    padding: 15px 30px;</span><br><span class="line">    font-size: 18px;</span><br><span class="line">    background: linear-gradient(45deg, #e94560, #ff6b95);</span><br><span class="line">    color: white;</span><br><span class="line">    border: none;</span><br><span class="line">    border-radius: 8px;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    transition: all 0.3s ease;</span><br><span class="line">    text-transform: uppercase;</span><br><span class="line">    letter-spacing: 1px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#menu button:hover &#123;</span><br><span class="line">    transform: translateY(-2px);</span><br><span class="line">    box-shadow: 0 5px 15px rgba(233, 69, 96, 0.4);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#menu button:active &#123;</span><br><span class="line">    transform: translateY(1px);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="第二阶段：JavaScript游戏核心（第2-3周）"><a href="#第二阶段：JavaScript游戏核心（第2-3周）" class="headerlink" title="第二阶段：JavaScript游戏核心（第2-3周）"></a>第二阶段：JavaScript游戏核心（第2-3周）</h3><h4 id="步骤4：游戏管理器"><a href="#步骤4：游戏管理器" class="headerlink" title="步骤4：游戏管理器"></a>步骤4：游戏管理器</h4><p>创建 <code>frontend/js/managers/gameManager.js</code>:</p>
<p>javascript</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br></pre></td><td class="code"><pre><span class="line">class GameManager &#123;</span><br><span class="line">    constructor(canvas) &#123;</span><br><span class="line">        this.canvas = canvas;</span><br><span class="line">        this.ctx = canvas.getContext(&#x27;2d&#x27;);</span><br><span class="line">        this.gameState = &#123;</span><br><span class="line">            gold: 100,</span><br><span class="line">            lives: 20,</span><br><span class="line">            wave: 1,</span><br><span class="line">            score: 0,</span><br><span class="line">            paused: false,</span><br><span class="line">            gameOver: false</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        this.towers = [];</span><br><span class="line">        this.enemies = [];</span><br><span class="line">        this.bullets = [];</span><br><span class="line">        this.particles = [];</span><br><span class="line">        </span><br><span class="line">        this.path = this.generatePath();</span><br><span class="line">        this.lastTime = 0;</span><br><span class="line">        this.deltaTime = 0;</span><br><span class="line">        </span><br><span class="line">        this.keys = &#123;&#125;;</span><br><span class="line">        this.mouse = &#123; x: 0, y: 0, down: false &#125;;</span><br><span class="line">        </span><br><span class="line">        this.setupEventListeners();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    generatePath() &#123;</span><br><span class="line">        // 生成敌人路径点</span><br><span class="line">        return [</span><br><span class="line">            &#123; x: -50, y: 200 &#125;,</span><br><span class="line">            &#123; x: 300, y: 200 &#125;,</span><br><span class="line">            &#123; x: 300, y: 400 &#125;,</span><br><span class="line">            &#123; x: 600, y: 400 &#125;,</span><br><span class="line">            &#123; x: 600, y: 100 &#125;,</span><br><span class="line">            &#123; x: 900, y: 100 &#125;,</span><br><span class="line">            &#123; x: 900, y: 700 &#125;,</span><br><span class="line">            &#123; x: 1100, y: 700 &#125; // 终点</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    setupEventListeners() &#123;</span><br><span class="line">        // 键盘事件</span><br><span class="line">        window.addEventListener(&#x27;keydown&#x27;, (e) =&gt; &#123;</span><br><span class="line">            this.keys[e.key] = true;</span><br><span class="line">            if (e.key === &#x27;Escape&#x27;) this.togglePause();</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        window.addEventListener(&#x27;keyup&#x27;, (e) =&gt; &#123;</span><br><span class="line">            this.keys[e.key] = false;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        // 鼠标事件</span><br><span class="line">        this.canvas.addEventListener(&#x27;mousemove&#x27;, (e) =&gt; &#123;</span><br><span class="line">            const rect = this.canvas.getBoundingClientRect();</span><br><span class="line">            this.mouse.x = e.clientX - rect.left;</span><br><span class="line">            this.mouse.y = e.clientY - rect.top;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        this.canvas.addEventListener(&#x27;mousedown&#x27;, (e) =&gt; &#123;</span><br><span class="line">            this.mouse.down = true;</span><br><span class="line">            this.handleClick(e);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        this.canvas.addEventListener(&#x27;mouseup&#x27;, () =&gt; &#123;</span><br><span class="line">            this.mouse.down = false;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    handleClick(e) &#123;</span><br><span class="line">        if (this.gameState.paused || this.gameState.gameOver) return;</span><br><span class="line">        </span><br><span class="line">        // 检查是否点击了塔位置</span><br><span class="line">        const rect = this.canvas.getBoundingClientRect();</span><br><span class="line">        const x = e.clientX - rect.left;</span><br><span class="line">        const y = e.clientY - rect.top;</span><br><span class="line">        </span><br><span class="line">        // 简单示例：点击位置建造塔</span><br><span class="line">        if (this.gameState.gold &gt;= 50) &#123;</span><br><span class="line">            this.addTower(x, y);</span><br><span class="line">            this.gameState.gold -= 50;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    addTower(x, y) &#123;</span><br><span class="line">        // 检查是否可以建造（不在路径上）</span><br><span class="line">        if (this.isBuildable(x, y)) &#123;</span><br><span class="line">            const tower = new Tower(x, y, &#x27;arrow&#x27;);</span><br><span class="line">            this.towers.push(tower);</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    isBuildable(x, y) &#123;</span><br><span class="line">        // 简单检查：确保不在路径附近</span><br><span class="line">        const minDistance = 80;</span><br><span class="line">        for (const point of this.path) &#123;</span><br><span class="line">            const dx = point.x - x;</span><br><span class="line">            const dy = point.y - y;</span><br><span class="line">            if (Math.sqrt(dx * dx + dy * dy) &lt; minDistance) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    spawnEnemy() &#123;</span><br><span class="line">        const enemyTypes = [&#x27;infantry&#x27;, &#x27;cavalry&#x27;, &#x27;armored&#x27;];</span><br><span class="line">        const type = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];</span><br><span class="line">        const enemy = new Enemy(this.path[0].x, this.path[0].y, type);</span><br><span class="line">        enemy.setPath(this.path);</span><br><span class="line">        this.enemies.push(enemy);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    update(deltaTime) &#123;</span><br><span class="line">        if (this.gameState.paused || this.gameState.gameOver) return;</span><br><span class="line">        </span><br><span class="line">        // 更新敌人</span><br><span class="line">        for (let i = this.enemies.length - 1; i &gt;= 0; i--) &#123;</span><br><span class="line">            this.enemies[i].update(deltaTime);</span><br><span class="line">            </span><br><span class="line">            // 检查敌人是否到达终点</span><br><span class="line">            if (this.enemies[i].reachedEnd) &#123;</span><br><span class="line">                this.enemies.splice(i, 1);</span><br><span class="line">                this.gameState.lives--;</span><br><span class="line">                if (this.gameState.lives &lt;= 0) &#123;</span><br><span class="line">                    this.gameOver();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 更新塔</span><br><span class="line">        this.towers.forEach(tower =&gt; &#123;</span><br><span class="line">            tower.update(deltaTime, this.enemies, this.bullets);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        // 更新子弹</span><br><span class="line">        for (let i = this.bullets.length - 1; i &gt;= 0; i--) &#123;</span><br><span class="line">            this.bullets[i].update(deltaTime);</span><br><span class="line">            </span><br><span class="line">            // 检查子弹是否击中敌人</span><br><span class="line">            let hit = false;</span><br><span class="line">            for (let j = this.enemies.length - 1; j &gt;= 0; j--) &#123;</span><br><span class="line">                if (this.bullets[i].checkCollision(this.enemies[j])) &#123;</span><br><span class="line">                    this.enemies[j].takeDamage(this.bullets[i].damage);</span><br><span class="line">                    </span><br><span class="line">                    // 如果敌人死亡</span><br><span class="line">                    if (this.enemies[j].health &lt;= 0) &#123;</span><br><span class="line">                        this.gameState.gold += this.enemies[j].reward;</span><br><span class="line">                        this.gameState.score += this.enemies[j].reward * 10;</span><br><span class="line">                        this.enemies.splice(j, 1);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    this.bullets.splice(i, 1);</span><br><span class="line">                    hit = true;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 移除出界的子弹</span><br><span class="line">            if (!hit &amp;&amp; (this.bullets[i].x &lt; 0 || this.bullets[i].x &gt; this.canvas.width || </span><br><span class="line">                         this.bullets[i].y &lt; 0 || this.bullets[i].y &gt; this.canvas.height)) &#123;</span><br><span class="line">                this.bullets.splice(i, 1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 简单的波次管理</span><br><span class="line">        if (this.enemies.length === 0) &#123;</span><br><span class="line">            this.spawnWave();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    spawnWave() &#123;</span><br><span class="line">        const waveSize = 5 + this.gameState.wave * 2;</span><br><span class="line">        for (let i = 0; i &lt; waveSize; i++) &#123;</span><br><span class="line">            setTimeout(() =&gt; &#123;</span><br><span class="line">                this.spawnEnemy();</span><br><span class="line">            &#125;, i * 1000);</span><br><span class="line">        &#125;</span><br><span class="line">        this.gameState.wave++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    togglePause() &#123;</span><br><span class="line">        this.gameState.paused = !this.gameState.paused;</span><br><span class="line">        const menu = document.getElementById(&#x27;menu&#x27;);</span><br><span class="line">        if (this.gameState.paused) &#123;</span><br><span class="line">            menu.classList.remove(&#x27;hidden&#x27;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            menu.classList.add(&#x27;hidden&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    gameOver() &#123;</span><br><span class="line">        this.gameState.gameOver = true;</span><br><span class="line">        alert(`Game Over! Final Score: $&#123;this.gameState.score&#125;`);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    draw(ctx) &#123;</span><br><span class="line">        // 清空画布</span><br><span class="line">        ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);</span><br><span class="line">        </span><br><span class="line">        // 绘制路径</span><br><span class="line">        this.drawPath(ctx);</span><br><span class="line">        </span><br><span class="line">        // 绘制塔</span><br><span class="line">        this.towers.forEach(tower =&gt; tower.draw(ctx));</span><br><span class="line">        </span><br><span class="line">        // 绘制敌人</span><br><span class="line">        this.enemies.forEach(enemy =&gt; enemy.draw(ctx));</span><br><span class="line">        </span><br><span class="line">        // 绘制子弹</span><br><span class="line">        this.bullets.forEach(bullet =&gt; bullet.draw(ctx));</span><br><span class="line">        </span><br><span class="line">        // 绘制UI</span><br><span class="line">        this.drawUI(ctx);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    drawPath(ctx) &#123;</span><br><span class="line">        ctx.strokeStyle = &#x27;#4fc3f7&#x27;;</span><br><span class="line">        ctx.lineWidth = 40;</span><br><span class="line">        ctx.lineCap = &#x27;round&#x27;;</span><br><span class="line">        ctx.lineJoin = &#x27;round&#x27;;</span><br><span class="line">        </span><br><span class="line">        ctx.beginPath();</span><br><span class="line">        ctx.moveTo(this.path[0].x, this.path[0].y);</span><br><span class="line">        </span><br><span class="line">        for (let i = 1; i &lt; this.path.length; i++) &#123;</span><br><span class="line">            ctx.lineTo(this.path[i].x, this.path[i].y);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ctx.stroke();</span><br><span class="line">        </span><br><span class="line">        // 绘制路径点</span><br><span class="line">        ctx.fillStyle = &#x27;#e94560&#x27;;</span><br><span class="line">        this.path.forEach(point =&gt; &#123;</span><br><span class="line">            ctx.beginPath();</span><br><span class="line">            ctx.arc(point.x, point.y, 10, 0, Math.PI * 2);</span><br><span class="line">            ctx.fill();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    drawUI(ctx) &#123;</span><br><span class="line">        // 游戏状态信息</span><br><span class="line">        ctx.fillStyle = &#x27;white&#x27;;</span><br><span class="line">        ctx.font = &#x27;20px Arial&#x27;;</span><br><span class="line">        ctx.fillText(`Gold: $&#123;this.gameState.gold&#125;`, 20, 40);</span><br><span class="line">        ctx.fillText(`Lives: $&#123;this.gameState.lives&#125;`, 20, 70);</span><br><span class="line">        ctx.fillText(`Wave: $&#123;this.gameState.wave&#125;`, 20, 100);</span><br><span class="line">        ctx.fillText(`Score: $&#123;this.gameState.score&#125;`, 20, 130);</span><br><span class="line">        </span><br><span class="line">        // 游戏状态提示</span><br><span class="line">        if (this.gameState.paused) &#123;</span><br><span class="line">            ctx.fillStyle = &#x27;rgba(0, 0, 0, 0.7)&#x27;;</span><br><span class="line">            ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);</span><br><span class="line">            </span><br><span class="line">            ctx.fillStyle = &#x27;white&#x27;;</span><br><span class="line">            ctx.font = &#x27;48px Arial&#x27;;</span><br><span class="line">            ctx.textAlign = &#x27;center&#x27;;</span><br><span class="line">            ctx.fillText(&#x27;PAUSED&#x27;, this.canvas.width / 2, this.canvas.height / 2);</span><br><span class="line">            ctx.textAlign = &#x27;left&#x27;;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (this.gameState.gameOver) &#123;</span><br><span class="line">            ctx.fillStyle = &#x27;rgba(0, 0, 0, 0.8)&#x27;;</span><br><span class="line">            ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);</span><br><span class="line">            </span><br><span class="line">            ctx.fillStyle = &#x27;#e94560&#x27;;</span><br><span class="line">            ctx.font = &#x27;64px Arial&#x27;;</span><br><span class="line">            ctx.textAlign = &#x27;center&#x27;;</span><br><span class="line">            ctx.fillText(&#x27;GAME OVER&#x27;, this.canvas.width / 2, this.canvas.height / 2 - 50);</span><br><span class="line">            </span><br><span class="line">            ctx.fillStyle = &#x27;white&#x27;;</span><br><span class="line">            ctx.font = &#x27;32px Arial&#x27;;</span><br><span class="line">            ctx.fillText(`Final Score: $&#123;this.gameState.score&#125;`, this.canvas.width / 2, this.canvas.height / 2 + 50);</span><br><span class="line">            ctx.textAlign = &#x27;left&#x27;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    gameLoop(currentTime) &#123;</span><br><span class="line">        this.deltaTime = (currentTime - this.lastTime) / 1000;</span><br><span class="line">        this.lastTime = currentTime;</span><br><span class="line">        </span><br><span class="line">        this.update(this.deltaTime);</span><br><span class="line">        this.draw(this.ctx);</span><br><span class="line">        </span><br><span class="line">        requestAnimationFrame((time) =&gt; this.gameLoop(time));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    start() &#123;</span><br><span class="line">        this.lastTime = performance.now();</span><br><span class="line">        this.gameLoop(this.lastTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="步骤5：实体类实现"><a href="#步骤5：实体类实现" class="headerlink" title="步骤5：实体类实现"></a>步骤5：实体类实现</h4><p>创建 <code>frontend/js/entities/tower.js</code>:</p>
<p>javascript</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">class Tower &#123;</span><br><span class="line">    constructor(x, y, type) &#123;</span><br><span class="line">        this.x = x;</span><br><span class="line">        this.y = y;</span><br><span class="line">        this.type = type;</span><br><span class="line">        this.range = 200;</span><br><span class="line">        this.damage = 10;</span><br><span class="line">        this.attackSpeed = 1; // 攻击次数/秒</span><br><span class="line">        this.cooldown = 0;</span><br><span class="line">        this.level = 1;</span><br><span class="line">        this.color = this.getColorByType();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    getColorByType() &#123;</span><br><span class="line">        switch(this.type) &#123;</span><br><span class="line">            case &#x27;arrow&#x27;: return &#x27;#4CAF50&#x27;;</span><br><span class="line">            case &#x27;cannon&#x27;: return &#x27;#FF5722&#x27;;</span><br><span class="line">            case &#x27;magic&#x27;: return &#x27;#9C27B0&#x27;;</span><br><span class="line">            default: return &#x27;#607D8B&#x27;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    update(deltaTime, enemies, bullets) &#123;</span><br><span class="line">        this.cooldown -= deltaTime;</span><br><span class="line">        </span><br><span class="line">        if (this.cooldown &lt;= 0) &#123;</span><br><span class="line">            const target = this.findTarget(enemies);</span><br><span class="line">            if (target) &#123;</span><br><span class="line">                this.attack(target, bullets);</span><br><span class="line">                this.cooldown = 1 / this.attackSpeed;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    findTarget(enemies) &#123;</span><br><span class="line">        let closest = null;</span><br><span class="line">        let closestDistance = this.range;</span><br><span class="line">        </span><br><span class="line">        for (const enemy of enemies) &#123;</span><br><span class="line">            const dx = enemy.x - this.x;</span><br><span class="line">            const dy = enemy.y - this.y;</span><br><span class="line">            const distance = Math.sqrt(dx * dx + dy * dy);</span><br><span class="line">            </span><br><span class="line">            if (distance &lt; closestDistance) &#123;</span><br><span class="line">                closest = enemy;</span><br><span class="line">                closestDistance = distance;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return closest;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    attack(target, bullets) &#123;</span><br><span class="line">        const bullet = new Bullet(</span><br><span class="line">            this.x,</span><br><span class="line">            this.y,</span><br><span class="line">            target,</span><br><span class="line">            this.damage,</span><br><span class="line">            this.type</span><br><span class="line">        );</span><br><span class="line">        bullets.push(bullet);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    draw(ctx) &#123;</span><br><span class="line">        // 塔底座</span><br><span class="line">        ctx.fillStyle = &#x27;#37474F&#x27;;</span><br><span class="line">        ctx.beginPath();</span><br><span class="line">        ctx.arc(this.x, this.y, 30, 0, Math.PI * 2);</span><br><span class="line">        ctx.fill();</span><br><span class="line">        </span><br><span class="line">        // 塔身</span><br><span class="line">        ctx.fillStyle = this.color;</span><br><span class="line">        ctx.beginPath();</span><br><span class="line">        ctx.arc(this.x, this.y, 20, 0, Math.PI * 2);</span><br><span class="line">        ctx.fill();</span><br><span class="line">        </span><br><span class="line">        // 塔顶装饰</span><br><span class="line">        ctx.fillStyle = &#x27;#FFD700&#x27;;</span><br><span class="line">        ctx.beginPath();</span><br><span class="line">        ctx.arc(this.x, this.y, 8, 0, Math.PI * 2);</span><br><span class="line">        ctx.fill();</span><br><span class="line">        </span><br><span class="line">        // 显示攻击范围（调试用）</span><br><span class="line">        if (this.isMouseOver()) &#123;</span><br><span class="line">            ctx.strokeStyle = &#x27;rgba(255, 255, 255, 0.3)&#x27;;</span><br><span class="line">            ctx.lineWidth = 2;</span><br><span class="line">            ctx.beginPath();</span><br><span class="line">            ctx.arc(this.x, this.y, this.range, 0, Math.PI * 2);</span><br><span class="line">            ctx.stroke();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    isMouseOver() &#123;</span><br><span class="line">        const gameManager = window.gameManager;</span><br><span class="line">        if (!gameManager) return false;</span><br><span class="line">        </span><br><span class="line">        const dx = gameManager.mouse.x - this.x;</span><br><span class="line">        const dy = gameManager.mouse.y - this.y;</span><br><span class="line">        return Math.sqrt(dx * dx + dy * dy) &lt; 30;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>创建 <code>frontend/js/entities/enemy.js</code>:</p>
<p>javascript</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">class Enemy &#123;</span><br><span class="line">    constructor(x, y, type) &#123;</span><br><span class="line">        this.x = x;</span><br><span class="line">        this.y = y;</span><br><span class="line">        this.type = type;</span><br><span class="line">        </span><br><span class="line">        // 根据类型设置属性</span><br><span class="line">        switch(type) &#123;</span><br><span class="line">            case &#x27;infantry&#x27;:</span><br><span class="line">                this.health = 50;</span><br><span class="line">                this.maxHealth = 50;</span><br><span class="line">                this.speed = 100;</span><br><span class="line">                this.reward = 10;</span><br><span class="line">                this.color = &#x27;#2196F3&#x27;;</span><br><span class="line">                break;</span><br><span class="line">            case &#x27;cavalry&#x27;:</span><br><span class="line">                this.health = 75;</span><br><span class="line">                this.maxHealth = 75;</span><br><span class="line">                this.speed = 150;</span><br><span class="line">                this.reward = 15;</span><br><span class="line">                this.color = &#x27;#4CAF50&#x27;;</span><br><span class="line">                break;</span><br><span class="line">            case &#x27;armored&#x27;:</span><br><span class="line">                this.health = 150;</span><br><span class="line">                this.maxHealth = 150;</span><br><span class="line">                this.speed = 60;</span><br><span class="line">                this.reward = 25;</span><br><span class="line">                this.color = &#x27;#FF9800&#x27;;</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        this.path = [];</span><br><span class="line">        this.currentPathIndex = 0;</span><br><span class="line">        this.reachedEnd = false;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    setPath(path) &#123;</span><br><span class="line">        this.path = path;</span><br><span class="line">        this.currentPathIndex = 0;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    update(deltaTime) &#123;</span><br><span class="line">        if (this.reachedEnd || this.path.length === 0) return;</span><br><span class="line">        </span><br><span class="line">        const target = this.path[this.currentPathIndex];</span><br><span class="line">        const dx = target.x - this.x;</span><br><span class="line">        const dy = target.y - this.y;</span><br><span class="line">        const distance = Math.sqrt(dx * dx + dy * dy);</span><br><span class="line">        </span><br><span class="line">        if (distance &lt; 5) &#123;</span><br><span class="line">            this.currentPathIndex++;</span><br><span class="line">            if (this.currentPathIndex &gt;= this.path.length) &#123;</span><br><span class="line">                this.reachedEnd = true;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            const moveDistance = this.speed * deltaTime;</span><br><span class="line">            const moveX = (dx / distance) * moveDistance;</span><br><span class="line">            const moveY = (dy / distance) * moveDistance;</span><br><span class="line">            </span><br><span class="line">            this.x += moveX;</span><br><span class="line">            this.y += moveY;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    takeDamage(damage) &#123;</span><br><span class="line">        this.health -= damage;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    draw(ctx) &#123;</span><br><span class="line">        // 敌人身体</span><br><span class="line">        ctx.fillStyle = this.color;</span><br><span class="line">        ctx.beginPath();</span><br><span class="line">        ctx.arc(this.x, this.y, 15, 0, Math.PI * 2);</span><br><span class="line">        ctx.fill();</span><br><span class="line">        </span><br><span class="line">        // 敌人边框</span><br><span class="line">        ctx.strokeStyle = &#x27;#000&#x27;;</span><br><span class="line">        ctx.lineWidth = 2;</span><br><span class="line">        ctx.beginPath();</span><br><span class="line">        ctx.arc(this.x, this.y, 15, 0, Math.PI * 2);</span><br><span class="line">        ctx.stroke();</span><br><span class="line">        </span><br><span class="line">        // 生命条</span><br><span class="line">        const healthPercent = this.health / this.maxHealth;</span><br><span class="line">        const barWidth = 30;</span><br><span class="line">        const barHeight = 5;</span><br><span class="line">        </span><br><span class="line">        ctx.fillStyle = &#x27;#F44336&#x27;;</span><br><span class="line">        ctx.fillRect(</span><br><span class="line">            this.x - barWidth / 2,</span><br><span class="line">            this.y - 25,</span><br><span class="line">            barWidth,</span><br><span class="line">            barHeight</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        ctx.fillStyle = &#x27;#4CAF50&#x27;;</span><br><span class="line">        ctx.fillRect(</span><br><span class="line">            this.x - barWidth / 2,</span><br><span class="line">            this.y - 25,</span><br><span class="line">            barWidth * healthPercent,</span><br><span class="line">            barHeight</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        // 生命条边框</span><br><span class="line">        ctx.strokeStyle = &#x27;#000&#x27;;</span><br><span class="line">        ctx.lineWidth = 1;</span><br><span class="line">        ctx.strokeRect(</span><br><span class="line">            this.x - barWidth / 2,</span><br><span class="line">            this.y - 25,</span><br><span class="line">            barWidth,</span><br><span class="line">            barHeight</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>创建 <code>frontend/js/entities/bullet.js</code>:</p>
<p>javascript</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">class Bullet &#123;</span><br><span class="line">    constructor(x, y, target, damage, type) &#123;</span><br><span class="line">        this.x = x;</span><br><span class="line">        this.y = y;</span><br><span class="line">        this.target = target;</span><br><span class="line">        this.damage = damage;</span><br><span class="line">        this.type = type;</span><br><span class="line">        this.speed = 400;</span><br><span class="line">        this.color = this.getColorByType();</span><br><span class="line">        this.size = 5;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    getColorByType() &#123;</span><br><span class="line">        switch(this.type) &#123;</span><br><span class="line">            case &#x27;arrow&#x27;: return &#x27;#FFEB3B&#x27;;</span><br><span class="line">            case &#x27;cannon&#x27;: return &#x27;#FF5722&#x27;;</span><br><span class="line">            case &#x27;magic&#x27;: return &#x27;#E91E63&#x27;;</span><br><span class="line">            default: return &#x27;#FFFFFF&#x27;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    update(deltaTime) &#123;</span><br><span class="line">        if (!this.target || this.target.health &lt;= 0) return true;</span><br><span class="line">        </span><br><span class="line">        const dx = this.target.x - this.x;</span><br><span class="line">        const dy = this.target.y - this.y;</span><br><span class="line">        const distance = Math.sqrt(dx * dx + dy * dy);</span><br><span class="line">        </span><br><span class="line">        if (distance &lt; 10) &#123;</span><br><span class="line">            return true; // 击中目标</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        const moveDistance = this.speed * deltaTime;</span><br><span class="line">        const moveX = (dx / distance) * moveDistance;</span><br><span class="line">        const moveY = (dy / distance) * moveDistance;</span><br><span class="line">        </span><br><span class="line">        this.x += moveX;</span><br><span class="line">        this.y += moveY;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    checkCollision(enemy) &#123;</span><br><span class="line">        const dx = enemy.x - this.x;</span><br><span class="line">        const dy = enemy.y - this.y;</span><br><span class="line">        const distance = Math.sqrt(dx * dx + dy * dy);</span><br><span class="line">        return distance &lt; (enemy.size || 15) + this.size;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    draw(ctx) &#123;</span><br><span class="line">        // 子弹主体</span><br><span class="line">        ctx.fillStyle = this.color;</span><br><span class="line">        ctx.beginPath();</span><br><span class="line">        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);</span><br><span class="line">        ctx.fill();</span><br><span class="line">        </span><br><span class="line">        // 子弹光晕</span><br><span class="line">        ctx.strokeStyle = this.color;</span><br><span class="line">        ctx.lineWidth = 2;</span><br><span class="line">        ctx.beginPath();</span><br><span class="line">        ctx.arc(this.x, this.y, this.size + 2, 0, Math.PI * 2);</span><br><span class="line">        ctx.stroke();</span><br><span class="line">        </span><br><span class="line">        // 子弹轨迹（仅对魔法和炮塔子弹）</span><br><span class="line">        if (this.type === &#x27;magic&#x27; || this.type === &#x27;cannon&#x27;) &#123;</span><br><span class="line">            ctx.strokeStyle = this.color + &#x27;80&#x27;;</span><br><span class="line">            ctx.lineWidth = 3;</span><br><span class="line">            ctx.beginPath();</span><br><span class="line">            ctx.moveTo(this.x, this.y);</span><br><span class="line">            const backX = this.x - (this.target.x - this.x) * 0.1;</span><br><span class="line">            const backY = this.y - (this.target.y - this.y) * 0.1;</span><br><span class="line">            ctx.lineTo(backX, backY);</span><br><span class="line">            ctx.stroke();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="第三阶段：Java后端服务（第4周）"><a href="#第三阶段：Java后端服务（第4周）" class="headerlink" title="第三阶段：Java后端服务（第4周）"></a>第三阶段：Java后端服务（第4周）</h3><h4 id="步骤6：Spring-Boot应用"><a href="#步骤6：Spring-Boot应用" class="headerlink" title="步骤6：Spring Boot应用"></a>步骤6：Spring Boot应用</h4><p>创建 <code>backend/pom.xml</code>:</p>
<p>xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 </span><br><span class="line">         http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.7.0&lt;/version&gt;</span><br><span class="line">        &lt;relativePath/&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;groupId&gt;com.kingdomdefense&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;kingdom-defense-backend&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0.0&lt;/version&gt;</span><br><span class="line">    &lt;name&gt;Kingdom Defense Backend&lt;/name&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;java.version&gt;11&lt;/java.version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.h2database&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;h2&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;io.springfox&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;springfox-boot-starter&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.0.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>



<p>创建 <code>backend/src/main/java/com/kingdomdefense/KingdomDefenseApplication.java</code>:</p>
<p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">package com.kingdomdefense;</span><br><span class="line"></span><br><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line">import org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line">@SpringBootApplication</span><br><span class="line">@RestController</span><br><span class="line">public class KingdomDefenseApplication &#123;</span><br><span class="line">    </span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(KingdomDefenseApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/&quot;)</span><br><span class="line">    public String home() &#123;</span><br><span class="line">        return &quot;Kingdom Defense Backend Service is running!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/health&quot;)</span><br><span class="line">    public String health() &#123;</span><br><span class="line">        return &quot;OK&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>创建 <code>backend/src/main/java/com/kingdomdefense/model/User.java</code>:</p>
<p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">package com.kingdomdefense.model;</span><br><span class="line"></span><br><span class="line">import javax.persistence.*;</span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">@Entity</span><br><span class="line">@Table(name = &quot;users&quot;)</span><br><span class="line">public class User &#123;</span><br><span class="line">    @Id</span><br><span class="line">    @GeneratedValue(strategy = GenerationType.IDENTITY)</span><br><span class="line">    private Long id;</span><br><span class="line">    </span><br><span class="line">    @Column(unique = true, nullable = false)</span><br><span class="line">    private String username;</span><br><span class="line">    </span><br><span class="line">    @Column(nullable = false)</span><br><span class="line">    private String password;</span><br><span class="line">    </span><br><span class="line">    @Column(unique = true)</span><br><span class="line">    private String email;</span><br><span class="line">    </span><br><span class="line">    private int highScore;</span><br><span class="line">    </span><br><span class="line">    private int totalGamesPlayed;</span><br><span class="line">    </span><br><span class="line">    private LocalDateTime createdAt;</span><br><span class="line">    </span><br><span class="line">    @OneToMany(mappedBy = &quot;user&quot;, cascade = CascadeType.ALL)</span><br><span class="line">    private List&lt;GameScore&gt; scores;</span><br><span class="line">    </span><br><span class="line">    @PrePersist</span><br><span class="line">    protected void onCreate() &#123;</span><br><span class="line">        createdAt = LocalDateTime.now();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Getters and Setters</span><br><span class="line">    public Long getId() &#123; return id; &#125;</span><br><span class="line">    public void setId(Long id) &#123; this.id = id; &#125;</span><br><span class="line">    </span><br><span class="line">    public String getUsername() &#123; return username; &#125;</span><br><span class="line">    public void setUsername(String username) &#123; this.username = username; &#125;</span><br><span class="line">    </span><br><span class="line">    public String getPassword() &#123; return password; &#125;</span><br><span class="line">    public void setPassword(String password) &#123; this.password = password; &#125;</span><br><span class="line">    </span><br><span class="line">    public String getEmail() &#123; return email; &#125;</span><br><span class="line">    public void setEmail(String email) &#123; this.email = email; &#125;</span><br><span class="line">    </span><br><span class="line">    public int getHighScore() &#123; return highScore; &#125;</span><br><span class="line">    public void setHighScore(int highScore) &#123; this.highScore = highScore; &#125;</span><br><span class="line">    </span><br><span class="line">    public int getTotalGamesPlayed() &#123; return totalGamesPlayed; &#125;</span><br><span class="line">    public void setTotalGamesPlayed(int totalGamesPlayed) &#123; this.totalGamesPlayed = totalGamesPlayed; &#125;</span><br><span class="line">    </span><br><span class="line">    public LocalDateTime getCreatedAt() &#123; return createdAt; &#125;</span><br><span class="line">    public void setCreatedAt(LocalDateTime createdAt) &#123; this.createdAt = createdAt; &#125;</span><br><span class="line">    </span><br><span class="line">    public List&lt;GameScore&gt; getScores() &#123; return scores; &#125;</span><br><span class="line">    public void setScores(List&lt;GameScore&gt; scores) &#123; this.scores = scores; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>创建 <code>backend/src/main/java/com/kingdomdefense/model/GameScore.java</code>:</p>
<p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">package com.kingdomdefense.model;</span><br><span class="line"></span><br><span class="line">import javax.persistence.*;</span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line">@Entity</span><br><span class="line">@Table(name = &quot;game_scores&quot;)</span><br><span class="line">public class GameScore &#123;</span><br><span class="line">    @Id</span><br><span class="line">    @GeneratedValue(strategy = GenerationType.IDENTITY)</span><br><span class="line">    private Long id;</span><br><span class="line">    </span><br><span class="line">    @ManyToOne</span><br><span class="line">    @JoinColumn(name = &quot;user_id&quot;, nullable = false)</span><br><span class="line">    private User user;</span><br><span class="line">    </span><br><span class="line">    private int score;</span><br><span class="line">    </span><br><span class="line">    private int waveReached;</span><br><span class="line">    </span><br><span class="line">    private int enemiesDefeated;</span><br><span class="line">    </span><br><span class="line">    private int towersBuilt;</span><br><span class="line">    </span><br><span class="line">    private LocalDateTime gameDate;</span><br><span class="line">    </span><br><span class="line">    @PrePersist</span><br><span class="line">    protected void onCreate() &#123;</span><br><span class="line">        gameDate = LocalDateTime.now();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Getters and Setters</span><br><span class="line">    public Long getId() &#123; return id; &#125;</span><br><span class="line">    public void setId(Long id) &#123; this.id = id; &#125;</span><br><span class="line">    </span><br><span class="line">    public User getUser() &#123; return user; &#125;</span><br><span class="line">    public void setUser(User user) &#123; this.user = user; &#125;</span><br><span class="line">    </span><br><span class="line">    public int getScore() &#123; return score; &#125;</span><br><span class="line">    public void setScore(int score) &#123; this.score = score; &#125;</span><br><span class="line">    </span><br><span class="line">    public int getWaveReached() &#123; return waveReached; &#125;</span><br><span class="line">    public void setWaveReached(int waveReached) &#123; this.waveReached = waveReached; &#125;</span><br><span class="line">    </span><br><span class="line">    public int getEnemiesDefeated() &#123; return enemiesDefeated; &#125;</span><br><span class="line">    public void setEnemiesDefeated(int enemiesDefeated) &#123; this.enemiesDefeated = enemiesDefeated; &#125;</span><br><span class="line">    </span><br><span class="line">    public int getTowersBuilt() &#123; return towersBuilt; &#125;</span><br><span class="line">    public void setTowersBuilt(int towersBuilt) &#123; this.towersBuilt = towersBuilt; &#125;</span><br><span class="line">    </span><br><span class="line">    public LocalDateTime getGameDate() &#123; return gameDate; &#125;</span><br><span class="line">    public void setGameDate(LocalDateTime gameDate) &#123; this.gameDate = gameDate; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>创建 <code>backend/src/main/java/com/kingdomdefense/controller/ScoreController.java</code>:</p>
<p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">package com.kingdomdefense.controller;</span><br><span class="line"></span><br><span class="line">import com.kingdomdefense.model.GameScore;</span><br><span class="line">import com.kingdomdefense.service.ScoreService;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.http.ResponseEntity;</span><br><span class="line">import org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/api/scores&quot;)</span><br><span class="line">@CrossOrigin(origins = &quot;*&quot;)</span><br><span class="line">public class ScoreController &#123;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private ScoreService scoreService;</span><br><span class="line">    </span><br><span class="line">    @PostMapping</span><br><span class="line">    public ResponseEntity&lt;GameScore&gt; saveScore(@RequestBody GameScore score) &#123;</span><br><span class="line">        GameScore savedScore = scoreService.saveScore(score);</span><br><span class="line">        return ResponseEntity.ok(savedScore);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/leaderboard&quot;)</span><br><span class="line">    public ResponseEntity&lt;List&lt;Map&lt;String, Object&gt;&gt;&gt; getLeaderboard(</span><br><span class="line">            @RequestParam(defaultValue = &quot;10&quot;) int limit) &#123;</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; leaderboard = scoreService.getLeaderboard(limit);</span><br><span class="line">        return ResponseEntity.ok(leaderboard);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/user/&#123;userId&#125;&quot;)</span><br><span class="line">    public ResponseEntity&lt;List&lt;GameScore&gt;&gt; getUserScores(@PathVariable Long userId) &#123;</span><br><span class="line">        List&lt;GameScore&gt; scores = scoreService.getUserScores(userId);</span><br><span class="line">        return ResponseEntity.ok(scores);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="第四阶段：Python-AI模块（第5周）"><a href="#第四阶段：Python-AI模块（第5周）" class="headerlink" title="第四阶段：Python AI模块（第5周）"></a>第四阶段：Python AI模块（第5周）</h3><h4 id="步骤7：AI引擎"><a href="#步骤7：AI引擎" class="headerlink" title="步骤7：AI引擎"></a>步骤7：AI引擎</h4><p>创建 <code>ai-engine/requirements.txt</code>:</p>
<p>text</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">flask==2.3.2</span><br><span class="line">flask-cors==4.0.0</span><br><span class="line">numpy==1.24.3</span><br><span class="line">pandas==2.0.2</span><br><span class="line">scikit-learn==1.2.2</span><br><span class="line">matplotlib==3.7.1</span><br><span class="line">pygame==2.5.0</span><br></pre></td></tr></table></figure>



<p>创建 <code>ai-engine/app.py</code>:</p>
<p>python</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask, request, jsonify</span><br><span class="line">from flask_cors import CORS</span><br><span class="line">import numpy as np</span><br><span class="line">import json</span><br><span class="line">from game_ai.enemy_ai import EnemyAI</span><br><span class="line">from game_ai.tower_placement_ai import TowerPlacementAI</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">CORS(app)</span><br><span class="line"></span><br><span class="line"># 初始化AI系统</span><br><span class="line">enemy_ai = EnemyAI()</span><br><span class="line">tower_ai = TowerPlacementAI()</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/api/ai/enemy/move&#x27;, methods=[&#x27;POST&#x27;])</span><br><span class="line">def get_enemy_move():</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    计算敌人的下一步移动决策</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    data = request.json</span><br><span class="line">    enemy_data = data.get(&#x27;enemy&#x27;)</span><br><span class="line">    game_state = data.get(&#x27;gameState&#x27;)</span><br><span class="line">    towers = data.get(&#x27;towers&#x27;, [])</span><br><span class="line">    </span><br><span class="line">    # 获取AI建议的移动方向</span><br><span class="line">    move = enemy_ai.calculate_move(enemy_data, game_state, towers)</span><br><span class="line">    </span><br><span class="line">    return jsonify(&#123;</span><br><span class="line">        &#x27;success&#x27;: True,</span><br><span class="line">        &#x27;move&#x27;: move</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/api/ai/tower/placement&#x27;, methods=[&#x27;POST&#x27;])</span><br><span class="line">def get_tower_placement():</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    获取最佳的塔放置位置</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    data = request.json</span><br><span class="line">    map_layout = data.get(&#x27;map&#x27;)</span><br><span class="line">    enemy_path = data.get(&#x27;enemyPath&#x27;)</span><br><span class="line">    existing_towers = data.get(&#x27;towers&#x27;, [])</span><br><span class="line">    tower_type = data.get(&#x27;towerType&#x27;)</span><br><span class="line">    </span><br><span class="line">    # 获取AI建议的最佳位置</span><br><span class="line">    positions = tower_ai.get_best_positions(</span><br><span class="line">        map_layout, </span><br><span class="line">        enemy_path, </span><br><span class="line">        existing_towers, </span><br><span class="line">        tower_type</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    return jsonify(&#123;</span><br><span class="line">        &#x27;success&#x27;: True,</span><br><span class="line">        &#x27;positions&#x27;: positions[:5]  # 返回前5个最佳位置</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/api/ai/difficulty/adjust&#x27;, methods=[&#x27;POST&#x27;])</span><br><span class="line">def adjust_difficulty():</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    根据玩家表现调整游戏难度</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    data = request.json</span><br><span class="line">    player_performance = data.get(&#x27;performance&#x27;)</span><br><span class="line">    current_difficulty = data.get(&#x27;difficulty&#x27;, 1)</span><br><span class="line">    </span><br><span class="line">    # 计算新的难度</span><br><span class="line">    new_difficulty = enemy_ai.adjust_difficulty(</span><br><span class="line">        player_performance, </span><br><span class="line">        current_difficulty</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    return jsonify(&#123;</span><br><span class="line">        &#x27;success&#x27;: True,</span><br><span class="line">        &#x27;difficulty&#x27;: new_difficulty</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/api/ai/simulate/wave&#x27;, methods=[&#x27;POST&#x27;])</span><br><span class="line">def simulate_wave():</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    模拟一波敌人的行为，用于预测和平衡</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    data = request.json</span><br><span class="line">    wave_composition = data.get(&#x27;wave&#x27;)</span><br><span class="line">    player_towers = data.get(&#x27;towers&#x27;)</span><br><span class="line">    map_layout = data.get(&#x27;map&#x27;)</span><br><span class="line">    </span><br><span class="line">    # 运行模拟</span><br><span class="line">    simulation_result = enemy_ai.simulate_wave(</span><br><span class="line">        wave_composition,</span><br><span class="line">        player_towers,</span><br><span class="line">        map_layout</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    return jsonify(&#123;</span><br><span class="line">        &#x27;success&#x27;: True,</span><br><span class="line">        &#x27;simulation&#x27;: simulation_result</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/health&#x27;, methods=[&#x27;GET&#x27;])</span><br><span class="line">def health_check():</span><br><span class="line">    return jsonify(&#123;&#x27;status&#x27;: &#x27;healthy&#x27;, &#x27;service&#x27;: &#x27;AI Engine&#x27;&#125;)</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    print(&quot;Starting Kingdom Defense AI Engine...&quot;)</span><br><span class="line">    app.run(host=&#x27;0.0.0.0&#x27;, port=5001, debug=True)</span><br></pre></td></tr></table></figure>



<p>创建 <code>ai-engine/game_ai/enemy_ai.py</code>:</p>
<p>python</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line">import numpy as np</span><br><span class="line">import random</span><br><span class="line">from typing import Dict, List, Tuple, Any</span><br><span class="line">import math</span><br><span class="line"></span><br><span class="line">class EnemyAI:</span><br><span class="line">    def __init__(self):</span><br><span class="line">        self.learning_rate = 0.1</span><br><span class="line">        self.discount_factor = 0.9</span><br><span class="line">        self.epsilon = 0.1  # 探索率</span><br><span class="line">        self.q_table = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">    def calculate_move(self, enemy: Dict, game_state: Dict, towers: List) -&gt; Dict:</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        计算敌人的移动决策</span><br><span class="line">        返回: &#123;&#x27;dx&#x27;: float, &#x27;dy&#x27;: float, &#x27;action&#x27;: str&#125;</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        enemy_type = enemy.get(&#x27;type&#x27;, &#x27;infantry&#x27;)</span><br><span class="line">        enemy_x = enemy.get(&#x27;x&#x27;, 0)</span><br><span class="line">        enemy_y = enemy.get(&#x27;y&#x27;, 0)</span><br><span class="line">        enemy_health = enemy.get(&#x27;health&#x27;, 100)</span><br><span class="line">        </span><br><span class="line">        # 获取当前状态</span><br><span class="line">        state = self._get_state(enemy, game_state, towers)</span><br><span class="line">        state_key = self._state_to_key(state)</span><br><span class="line">        </span><br><span class="line">        # ε-贪婪策略选择动作</span><br><span class="line">        if random.random() &lt; self.epsilon:</span><br><span class="line">            action = self._get_random_action()</span><br><span class="line">        else:</span><br><span class="line">            action = self._get_best_action(state_key)</span><br><span class="line">        </span><br><span class="line">        # 执行动作</span><br><span class="line">        move = self._execute_action(action, enemy, towers)</span><br><span class="line">        </span><br><span class="line">        return move</span><br><span class="line">    </span><br><span class="line">    def _get_state(self, enemy: Dict, game_state: Dict, towers: List) -&gt; Tuple:</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        将游戏状态转换为AI可以理解的状态</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        enemy_x = enemy.get(&#x27;x&#x27;, 0)</span><br><span class="line">        enemy_y = enemy.get(&#x27;y&#x27;, 0)</span><br><span class="line">        enemy_health = enemy.get(&#x27;health&#x27;, 100)</span><br><span class="line">        </span><br><span class="line">        # 计算最近的塔</span><br><span class="line">        closest_tower = None</span><br><span class="line">        min_distance = float(&#x27;inf&#x27;)</span><br><span class="line">        </span><br><span class="line">        for tower in towers:</span><br><span class="line">            tower_x = tower.get(&#x27;x&#x27;, 0)</span><br><span class="line">            tower_y = tower.get(&#x27;y&#x27;, 0)</span><br><span class="line">            distance = math.sqrt((tower_x - enemy_x)**2 + (tower_y - enemy_y)**2)</span><br><span class="line">            </span><br><span class="line">            if distance &lt; min_distance:</span><br><span class="line">                min_distance = distance</span><br><span class="line">                closest_tower = tower</span><br><span class="line">        </span><br><span class="line">        # 简化状态表示</span><br><span class="line">        health_state = 0 if enemy_health &gt; 50 else 1</span><br><span class="line">        distance_state = 0 if min_distance &gt; 200 else 1</span><br><span class="line">        tower_threat = 0</span><br><span class="line">        </span><br><span class="line">        if closest_tower:</span><br><span class="line">            tower_type = closest_tower.get(&#x27;type&#x27;, &#x27;arrow&#x27;)</span><br><span class="line">            if tower_type == &#x27;cannon&#x27;:</span><br><span class="line">                tower_threat = 2</span><br><span class="line">            elif tower_type == &#x27;magic&#x27;:</span><br><span class="line">                tower_threat = 1</span><br><span class="line">            else:</span><br><span class="line">                tower_threat = 0</span><br><span class="line">        </span><br><span class="line">        return (health_state, distance_state, tower_threat)</span><br><span class="line">    </span><br><span class="line">    def _state_to_key(self, state: Tuple) -&gt; str:</span><br><span class="line">        &quot;&quot;&quot;将状态元组转换为字符串键&quot;&quot;&quot;</span><br><span class="line">        return str(state)</span><br><span class="line">    </span><br><span class="line">    def _get_random_action(self) -&gt; str:</span><br><span class="line">        &quot;&quot;&quot;随机选择一个动作&quot;&quot;&quot;</span><br><span class="line">        actions = [&#x27;move_forward&#x27;, &#x27;move_left&#x27;, &#x27;move_right&#x27;, &#x27;retreat&#x27;, &#x27;attack&#x27;]</span><br><span class="line">        return random.choice(actions)</span><br><span class="line">    </span><br><span class="line">    def _get_best_action(self, state_key: str) -&gt; str:</span><br><span class="line">        &quot;&quot;&quot;从Q表获取最佳动作&quot;&quot;&quot;</span><br><span class="line">        if state_key not in self.q_table:</span><br><span class="line">            return self._get_random_action()</span><br><span class="line">        </span><br><span class="line">        # 返回Q值最高的动作</span><br><span class="line">        actions = self.q_table[state_key]</span><br><span class="line">        best_action = max(actions, key=actions.get)</span><br><span class="line">        return best_action</span><br><span class="line">    </span><br><span class="line">    def _execute_action(self, action: str, enemy: Dict, towers: List) -&gt; Dict:</span><br><span class="line">        &quot;&quot;&quot;执行选择的动作&quot;&quot;&quot;</span><br><span class="line">        enemy_type = enemy.get(&#x27;type&#x27;, &#x27;infantry&#x27;)</span><br><span class="line">        base_speed = self._get_base_speed(enemy_type)</span><br><span class="line">        </span><br><span class="line">        if action == &#x27;move_forward&#x27;:</span><br><span class="line">            return &#123;&#x27;dx&#x27;: base_speed, &#x27;dy&#x27;: 0, &#x27;action&#x27;: &#x27;move&#x27;&#125;</span><br><span class="line">        elif action == &#x27;move_left&#x27;:</span><br><span class="line">            return &#123;&#x27;dx&#x27;: 0, &#x27;dy&#x27;: -base_speed, &#x27;action&#x27;: &#x27;move&#x27;&#125;</span><br><span class="line">        elif action == &#x27;move_right&#x27;:</span><br><span class="line">            return &#123;&#x27;dx&#x27;: 0, &#x27;dy&#x27;: base_speed, &#x27;action&#x27;: &#x27;move&#x27;&#125;</span><br><span class="line">        elif action == &#x27;retreat&#x27;:</span><br><span class="line">            # 向反方向移动</span><br><span class="line">            return &#123;&#x27;dx&#x27;: -base_speed/2, &#x27;dy&#x27;: 0, &#x27;action&#x27;: &#x27;retreat&#x27;&#125;</span><br><span class="line">        elif action == &#x27;attack&#x27;:</span><br><span class="line">            # 如果有塔在范围内，尝试攻击</span><br><span class="line">            closest_tower = self._find_closest_tower(enemy, towers)</span><br><span class="line">            if closest_tower:</span><br><span class="line">                return &#123;&#x27;dx&#x27;: 0, &#x27;dy&#x27;: 0, &#x27;action&#x27;: &#x27;attack&#x27;, &#x27;target&#x27;: closest_tower&#125;</span><br><span class="line">            else:</span><br><span class="line">                return &#123;&#x27;dx&#x27;: base_speed, &#x27;dy&#x27;: 0, &#x27;action&#x27;: &#x27;move&#x27;&#125;</span><br><span class="line">        else:</span><br><span class="line">            return &#123;&#x27;dx&#x27;: base_speed, &#x27;dy&#x27;: 0, &#x27;action&#x27;: &#x27;move&#x27;&#125;</span><br><span class="line">    </span><br><span class="line">    def _get_base_speed(self, enemy_type: str) -&gt; float:</span><br><span class="line">        &quot;&quot;&quot;根据敌人类型返回基础速度&quot;&quot;&quot;</span><br><span class="line">        speeds = &#123;</span><br><span class="line">            &#x27;infantry&#x27;: 1.0,</span><br><span class="line">            &#x27;cavalry&#x27;: 2.0,</span><br><span class="line">            &#x27;armored&#x27;: 0.5,</span><br><span class="line">            &#x27;flying&#x27;: 1.5</span><br><span class="line">        &#125;</span><br><span class="line">        return speeds.get(enemy_type, 1.0)</span><br><span class="line">    </span><br><span class="line">    def _find_closest_tower(self, enemy: Dict, towers: List) -&gt; Dict:</span><br><span class="line">        &quot;&quot;&quot;找到最近的塔&quot;&quot;&quot;</span><br><span class="line">        enemy_x = enemy.get(&#x27;x&#x27;, 0)</span><br><span class="line">        enemy_y = enemy.get(&#x27;y&#x27;, 0)</span><br><span class="line">        </span><br><span class="line">        closest_tower = None</span><br><span class="line">        min_distance = float(&#x27;inf&#x27;)</span><br><span class="line">        </span><br><span class="line">        for tower in towers:</span><br><span class="line">            tower_x = tower.get(&#x27;x&#x27;, 0)</span><br><span class="line">            tower_y = tower.get(&#x27;y&#x27;, 0)</span><br><span class="line">            distance = math.sqrt((tower_x - enemy_x)**2 + (tower_y - enemy_y)**2)</span><br><span class="line">            </span><br><span class="line">            if distance &lt; min_distance:</span><br><span class="line">                min_distance = distance</span><br><span class="line">                closest_tower = tower</span><br><span class="line">        </span><br><span class="line">        return closest_tower if min_distance &lt; 50 else None</span><br><span class="line">    </span><br><span class="line">    def adjust_difficulty(self, player_performance: Dict, current_difficulty: float) -&gt; float:</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        根据玩家表现调整游戏难度</span><br><span class="line">        player_performance: &#123;&#x27;win_rate&#x27;: float, &#x27;avg_score&#x27;: float, &#x27;avg_wave&#x27;: float&#125;</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        win_rate = player_performance.get(&#x27;win_rate&#x27;, 0.5)</span><br><span class="line">        avg_score = player_performance.get(&#x27;avg_score&#x27;, 0)</span><br><span class="line">        </span><br><span class="line">        # 简单的难度调整算法</span><br><span class="line">        if win_rate &gt; 0.7:</span><br><span class="line">            # 玩家表现太好，增加难度</span><br><span class="line">            new_difficulty = current_difficulty * 1.2</span><br><span class="line">        elif win_rate &lt; 0.3:</span><br><span class="line">            # 玩家表现太差，降低难度</span><br><span class="line">            new_difficulty = current_difficulty * 0.8</span><br><span class="line">        else:</span><br><span class="line">            # 保持当前难度</span><br><span class="line">            new_difficulty = current_difficulty</span><br><span class="line">        </span><br><span class="line">        # 限制难度范围</span><br><span class="line">        new_difficulty = max(0.5, min(new_difficulty, 3.0))</span><br><span class="line">        </span><br><span class="line">        return new_difficulty</span><br><span class="line">    </span><br><span class="line">    def simulate_wave(self, wave_composition: List, player_towers: List, map_layout: Dict) -&gt; Dict:</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        模拟一波敌人的行为</span><br><span class="line">        返回模拟结果</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        # 简化模拟：计算生存概率</span><br><span class="line">        total_enemies = len(wave_composition)</span><br><span class="line">        enemy_strength = sum(self._get_enemy_power(enemy) for enemy in wave_composition)</span><br><span class="line">        tower_strength = sum(self._get_tower_power(tower) for tower in player_towers)</span><br><span class="line">        </span><br><span class="line">        # 简单预测模型</span><br><span class="line">        survival_rate = enemy_strength / (tower_strength + 0.1)</span><br><span class="line">        survival_rate = min(survival_rate, 1.0)</span><br><span class="line">        </span><br><span class="line">        predicted_survivors = int(total_enemies * survival_rate)</span><br><span class="line">        </span><br><span class="line">        return &#123;</span><br><span class="line">            &#x27;total_enemies&#x27;: total_enemies,</span><br><span class="line">            &#x27;predicted_survivors&#x27;: predicted_survivors,</span><br><span class="line">            &#x27;survival_rate&#x27;: survival_rate,</span><br><span class="line">            &#x27;expected_damage&#x27;: predicted_survivors * 10  # 每个幸存者造成10点伤害</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    def _get_enemy_power(self, enemy: Dict) -&gt; float:</span><br><span class="line">        &quot;&quot;&quot;计算敌人的战斗力&quot;&quot;&quot;</span><br><span class="line">        enemy_type = enemy.get(&#x27;type&#x27;, &#x27;infantry&#x27;)</span><br><span class="line">        health = enemy.get(&#x27;health&#x27;, 100)</span><br><span class="line">        speed = enemy.get(&#x27;speed&#x27;, 1.0)</span><br><span class="line">        </span><br><span class="line">        type_multiplier = &#123;</span><br><span class="line">            &#x27;infantry&#x27;: 1.0,</span><br><span class="line">            &#x27;cavalry&#x27;: 1.5,</span><br><span class="line">            &#x27;armored&#x27;: 2.0,</span><br><span class="line">            &#x27;flying&#x27;: 1.2</span><br><span class="line">        &#125;.get(enemy_type, 1.0)</span><br><span class="line">        </span><br><span class="line">        return health * speed * type_multiplier / 100</span><br><span class="line">    </span><br><span class="line">    def _get_tower_power(self, tower: Dict) -&gt; float:</span><br><span class="line">        &quot;&quot;&quot;计算塔的战斗力&quot;&quot;&quot;</span><br><span class="line">        tower_type = tower.get(&#x27;type&#x27;, &#x27;arrow&#x27;)</span><br><span class="line">        damage = tower.get(&#x27;damage&#x27;, 10)</span><br><span class="line">        range_ = tower.get(&#x27;range&#x27;, 200)</span><br><span class="line">        attack_speed = tower.get(&#x27;attackSpeed&#x27;, 1.0)</span><br><span class="line">        </span><br><span class="line">        type_multiplier = &#123;</span><br><span class="line">            &#x27;arrow&#x27;: 1.0,</span><br><span class="line">            &#x27;cannon&#x27;: 1.8,</span><br><span class="line">            &#x27;magic&#x27;: 1.5</span><br><span class="line">        &#125;.get(tower_type, 1.0)</span><br><span class="line">        </span><br><span class="line">        return damage * range_ * attack_speed * type_multiplier / 10000</span><br></pre></td></tr></table></figure>



<h3 id="第五阶段：C核心引擎（第6周）"><a href="#第五阶段：C核心引擎（第6周）" class="headerlink" title="第五阶段：C核心引擎（第6周）"></a>第五阶段：C核心引擎（第6周）</h3><h4 id="步骤8：高性能路径查找"><a href="#步骤8：高性能路径查找" class="headerlink" title="步骤8：高性能路径查找"></a>步骤8：高性能路径查找</h4><p>创建 <code>engine-core/src/pathfinding/a_star.c</code>:</p>
<p>c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;math.h&gt;</span><br><span class="line">#include &lt;limits.h&gt;</span><br><span class="line">#include &quot;a_star.h&quot;</span><br><span class="line"></span><br><span class="line">// 节点结构</span><br><span class="line">typedef struct Node &#123;</span><br><span class="line">    int x, y;</span><br><span class="line">    int g, h, f;</span><br><span class="line">    struct Node* parent;</span><br><span class="line">    int is_obstacle;</span><br><span class="line">&#125; Node;</span><br><span class="line"></span><br><span class="line">// 网格结构</span><br><span class="line">typedef struct Grid &#123;</span><br><span class="line">    int width, height;</span><br><span class="line">    Node** nodes;</span><br><span class="line">&#125; Grid;</span><br><span class="line"></span><br><span class="line">// 创建网格</span><br><span class="line">Grid* create_grid(int width, int height) &#123;</span><br><span class="line">    Grid* grid = (Grid*)malloc(sizeof(Grid));</span><br><span class="line">    grid-&gt;width = width;</span><br><span class="line">    grid-&gt;height = height;</span><br><span class="line">    </span><br><span class="line">    grid-&gt;nodes = (Node**)malloc(height * sizeof(Node*));</span><br><span class="line">    for (int y = 0; y &lt; height; y++) &#123;</span><br><span class="line">        grid-&gt;nodes[y] = (Node*)malloc(width * sizeof(Node));</span><br><span class="line">        for (int x = 0; x &lt; width; x++) &#123;</span><br><span class="line">            grid-&gt;nodes[y][x].x = x;</span><br><span class="line">            grid-&gt;nodes[y][x].y = y;</span><br><span class="line">            grid-&gt;nodes[y][x].g = 0;</span><br><span class="line">            grid-&gt;nodes[y][x].h = 0;</span><br><span class="line">            grid-&gt;nodes[y][x].f = 0;</span><br><span class="line">            grid-&gt;nodes[y][x].parent = NULL;</span><br><span class="line">            grid-&gt;nodes[y][x].is_obstacle = 0;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return grid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 释放网格内存</span><br><span class="line">void free_grid(Grid* grid) &#123;</span><br><span class="line">    for (int y = 0; y &lt; grid-&gt;height; y++) &#123;</span><br><span class="line">        free(grid-&gt;nodes[y]);</span><br><span class="line">    &#125;</span><br><span class="line">    free(grid-&gt;nodes);</span><br><span class="line">    free(grid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 计算启发式函数（曼哈顿距离）</span><br><span class="line">int heuristic(Node* a, Node* b) &#123;</span><br><span class="line">    return abs(a-&gt;x - b-&gt;x) + abs(a-&gt;y - b-&gt;y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 检查节点是否在列表中</span><br><span class="line">int is_in_list(Node* node, Node** list, int list_size) &#123;</span><br><span class="line">    for (int i = 0; i &lt; list_size; i++) &#123;</span><br><span class="line">        if (list[i]-&gt;x == node-&gt;x &amp;&amp; list[i]-&gt;y == node-&gt;y) &#123;</span><br><span class="line">            return 1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// A*路径查找算法</span><br><span class="line">Path* find_path(Grid* grid, int start_x, int start_y, int end_x, int end_y) &#123;</span><br><span class="line">    if (start_x &lt; 0 || start_x &gt;= grid-&gt;width || start_y &lt; 0 || start_y &gt;= grid-&gt;height ||</span><br><span class="line">        end_x &lt; 0 || end_x &gt;= grid-&gt;width || end_y &lt; 0 || end_y &gt;= grid-&gt;height) &#123;</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Node* start = &amp;grid-&gt;nodes[start_y][start_x];</span><br><span class="line">    Node* end = &amp;grid-&gt;nodes[end_y][end_x];</span><br><span class="line">    </span><br><span class="line">    if (start-&gt;is_obstacle || end-&gt;is_obstacle) &#123;</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 初始化开放列表和关闭列表</span><br><span class="line">    Node** open_list = (Node**)malloc(grid-&gt;width * grid-&gt;height * sizeof(Node*));</span><br><span class="line">    Node** closed_list = (Node**)malloc(grid-&gt;width * grid-&gt;height * sizeof(Node*));</span><br><span class="line">    int open_size = 0;</span><br><span class="line">    int closed_size = 0;</span><br><span class="line">    </span><br><span class="line">    // 添加起点到开放列表</span><br><span class="line">    open_list[open_size++] = start;</span><br><span class="line">    </span><br><span class="line">    while (open_size &gt; 0) &#123;</span><br><span class="line">        // 找到开放列表中f值最小的节点</span><br><span class="line">        int current_index = 0;</span><br><span class="line">        Node* current = open_list[0];</span><br><span class="line">        </span><br><span class="line">        for (int i = 1; i &lt; open_size; i++) &#123;</span><br><span class="line">            if (open_list[i]-&gt;f &lt; current-&gt;f) &#123;</span><br><span class="line">                current = open_list[i];</span><br><span class="line">                current_index = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 如果当前节点是终点，重建路径</span><br><span class="line">        if (current-&gt;x == end-&gt;x &amp;&amp; current-&gt;y == end-&gt;y) &#123;</span><br><span class="line">            Path* path = (Path*)malloc(sizeof(Path));</span><br><span class="line">            path-&gt;points = (Point*)malloc(100 * sizeof(Point)); // 预分配空间</span><br><span class="line">            path-&gt;length = 0;</span><br><span class="line">            </span><br><span class="line">            // 重建路径</span><br><span class="line">            Node* node = current;</span><br><span class="line">            while (node != NULL) &#123;</span><br><span class="line">                if (path-&gt;length &lt; 100) &#123;</span><br><span class="line">                    path-&gt;points[path-&gt;length].x = node-&gt;x;</span><br><span class="line">                    path-&gt;points[path-&gt;length].y = node-&gt;y;</span><br><span class="line">                    path-&gt;length++;</span><br><span class="line">                &#125;</span><br><span class="line">                node = node-&gt;parent;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 反转路径（从起点到终点）</span><br><span class="line">            for (int i = 0; i &lt; path-&gt;length / 2; i++) &#123;</span><br><span class="line">                Point temp = path-&gt;points[i];</span><br><span class="line">                path-&gt;points[i] = path-&gt;points[path-&gt;length - 1 - i];</span><br><span class="line">                path-&gt;points[path-&gt;length - 1 - i] = temp;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            free(open_list);</span><br><span class="line">            free(closed_list);</span><br><span class="line">            </span><br><span class="line">            return path;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 将当前节点从开放列表移到关闭列表</span><br><span class="line">        for (int i = current_index; i &lt; open_size - 1; i++) &#123;</span><br><span class="line">            open_list[i] = open_list[i + 1];</span><br><span class="line">        &#125;</span><br><span class="line">        open_size--;</span><br><span class="line">        closed_list[closed_size++] = current;</span><br><span class="line">        </span><br><span class="line">        // 检查邻居节点</span><br><span class="line">        int dx[] = &#123;0, 1, 0, -1&#125;;</span><br><span class="line">        int dy[] = &#123;-1, 0, 1, 0&#125;;</span><br><span class="line">        </span><br><span class="line">        for (int i = 0; i &lt; 4; i++) &#123;</span><br><span class="line">            int new_x = current-&gt;x + dx[i];</span><br><span class="line">            int new_y = current-&gt;y + dy[i];</span><br><span class="line">            </span><br><span class="line">            // 检查边界</span><br><span class="line">            if (new_x &lt; 0 || new_x &gt;= grid-&gt;width || new_y &lt; 0 || new_y &gt;= grid-&gt;height) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            Node* neighbor = &amp;grid-&gt;nodes[new_y][new_x];</span><br><span class="line">            </span><br><span class="line">            // 跳过障碍物和关闭列表中的节点</span><br><span class="line">            if (neighbor-&gt;is_obstacle || is_in_list(neighbor, closed_list, closed_size)) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 计算新的g值</span><br><span class="line">            int new_g = current-&gt;g + 1;</span><br><span class="line">            </span><br><span class="line">            // 如果邻居不在开放列表中，或者新的g值更小</span><br><span class="line">            if (!is_in_list(neighbor, open_list, open_size) || new_g &lt; neighbor-&gt;g) &#123;</span><br><span class="line">                neighbor-&gt;g = new_g;</span><br><span class="line">                neighbor-&gt;h = heuristic(neighbor, end);</span><br><span class="line">                neighbor-&gt;f = neighbor-&gt;g + neighbor-&gt;h;</span><br><span class="line">                neighbor-&gt;parent = current;</span><br><span class="line">                </span><br><span class="line">                if (!is_in_list(neighbor, open_list, open_size)) &#123;</span><br><span class="line">                    open_list[open_size++] = neighbor;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 没有找到路径</span><br><span class="line">    free(open_list);</span><br><span class="line">    free(closed_list);</span><br><span class="line">    return NULL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 释放路径内存</span><br><span class="line">void free_path(Path* path) &#123;</span><br><span class="line">    if (path) &#123;</span><br><span class="line">        free(path-&gt;points);</span><br><span class="line">        free(path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 简单测试函数</span><br><span class="line">void test_a_star() &#123;</span><br><span class="line">    printf(&quot;Testing A* pathfinding...\n&quot;);</span><br><span class="line">    </span><br><span class="line">    // 创建10x10网格</span><br><span class="line">    Grid* grid = create_grid(10, 10);</span><br><span class="line">    </span><br><span class="line">    // 设置一些障碍物</span><br><span class="line">    for (int i = 3; i &lt; 7; i++) &#123;</span><br><span class="line">        grid-&gt;nodes[5][i].is_obstacle = 1;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 查找从(0,0)到(9,9)的路径</span><br><span class="line">    Path* path = find_path(grid, 0, 0, 9, 9);</span><br><span class="line">    </span><br><span class="line">    if (path) &#123;</span><br><span class="line">        printf(&quot;Path found with %d points:\n&quot;, path-&gt;length);</span><br><span class="line">        for (int i = 0; i &lt; path-&gt;length; i++) &#123;</span><br><span class="line">            printf(&quot;(%d, %d) &quot;, path-&gt;points[i].x, path-&gt;points[i].y);</span><br><span class="line">        &#125;</span><br><span class="line">        printf(&quot;\n&quot;);</span><br><span class="line">        </span><br><span class="line">        free_path(path);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        printf(&quot;No path found!\n&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    free_grid(grid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>创建 <code>engine-core/src/main.c</code>:</p>
<p>c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &quot;pathfinding/a_star.h&quot;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">    printf(&quot;Kingdom Defense Core Engine\n&quot;);</span><br><span class="line">    printf(&quot;============================\n\n&quot;);</span><br><span class="line">    </span><br><span class="line">    // 测试A*路径查找</span><br><span class="line">    test_a_star();</span><br><span class="line">    </span><br><span class="line">    // 这里可以添加更多测试</span><br><span class="line">    printf(&quot;\nCore engine tests completed.\n&quot;);</span><br><span class="line">    </span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="第六阶段：Shell自动化脚本（第7周）"><a href="#第六阶段：Shell自动化脚本（第7周）" class="headerlink" title="第六阶段：Shell自动化脚本（第7周）"></a>第六阶段：Shell自动化脚本（第7周）</h3><h4 id="步骤9：构建和部署脚本"><a href="#步骤9：构建和部署脚本" class="headerlink" title="步骤9：构建和部署脚本"></a>步骤9：构建和部署脚本</h4><p>创建 <code>scripts/build_all.sh</code>:</p>
<p>bash</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># Kingdom Defense - 构建脚本</span><br><span class="line"># 构建所有组件：前端、后端、AI引擎、C核心</span><br><span class="line"></span><br><span class="line">set -e  # 遇到错误时退出</span><br><span class="line"></span><br><span class="line">echo &quot;=========================================&quot;</span><br><span class="line">echo &quot;    Kingdom Defense - 构建系统&quot;</span><br><span class="line">echo &quot;=========================================&quot;</span><br><span class="line"></span><br><span class="line"># 颜色定义</span><br><span class="line">RED=&#x27;\033[0;31m&#x27;</span><br><span class="line">GREEN=&#x27;\033[0;32m&#x27;</span><br><span class="line">YELLOW=&#x27;\033[1;33m&#x27;</span><br><span class="line">NC=&#x27;\033[0m&#x27; # No Color</span><br><span class="line"></span><br><span class="line"># 函数：打印带颜色的消息</span><br><span class="line">print_message() &#123;</span><br><span class="line">    echo -e &quot;$&#123;GREEN&#125;[INFO]$&#123;NC&#125; $1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">print_warning() &#123;</span><br><span class="line">    echo -e &quot;$&#123;YELLOW&#125;[WARN]$&#123;NC&#125; $1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">print_error() &#123;</span><br><span class="line">    echo -e &quot;$&#123;RED&#125;[ERROR]$&#123;NC&#125; $1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 检查必要工具</span><br><span class="line">check_dependencies() &#123;</span><br><span class="line">    print_message &quot;检查系统依赖...&quot;</span><br><span class="line">    </span><br><span class="line">    # 检查Node.js</span><br><span class="line">    if ! command -v node &amp;&gt; /dev/null; then</span><br><span class="line">        print_error &quot;Node.js 未安装&quot;</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line">    print_message &quot;Node.js 版本: $(node --version)&quot;</span><br><span class="line">    </span><br><span class="line">    # 检查Java</span><br><span class="line">    if ! command -v java &amp;&gt; /dev/null; then</span><br><span class="line">        print_error &quot;Java 未安装&quot;</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line">    print_message &quot;Java 版本: $(java -version 2&gt;&amp;1 | head -n 1)&quot;</span><br><span class="line">    </span><br><span class="line">    # 检查Python</span><br><span class="line">    if ! command -v python3 &amp;&gt; /dev/null; then</span><br><span class="line">        print_error &quot;Python3 未安装&quot;</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line">    print_message &quot;Python 版本: $(python3 --version)&quot;</span><br><span class="line">    </span><br><span class="line">    # 检查GCC</span><br><span class="line">    if ! command -v gcc &amp;&gt; /dev/null; then</span><br><span class="line">        print_error &quot;GCC 未安装&quot;</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line">    print_message &quot;GCC 版本: $(gcc --version | head -n 1)&quot;</span><br><span class="line">    </span><br><span class="line">    print_message &quot;所有依赖检查通过 ✓&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 构建前端</span><br><span class="line">build_frontend() &#123;</span><br><span class="line">    print_message &quot;开始构建前端...&quot;</span><br><span class="line">    cd frontend</span><br><span class="line">    </span><br><span class="line">    # 检查是否安装了必要的npm包</span><br><span class="line">    if [ ! -d &quot;node_modules&quot; ]; then</span><br><span class="line">        print_message &quot;安装前端依赖...&quot;</span><br><span class="line">        npm install</span><br><span class="line">    fi</span><br><span class="line">    </span><br><span class="line">    # 创建生产版本</span><br><span class="line">    print_message &quot;创建生产构建...&quot;</span><br><span class="line">    # 这里可以添加具体的构建命令，如使用webpack等</span><br><span class="line">    # 简化版本：直接复制文件</span><br><span class="line">    mkdir -p ../dist/frontend</span><br><span class="line">    cp -r . ../dist/frontend/</span><br><span class="line">    </span><br><span class="line">    cd ..</span><br><span class="line">    print_message &quot;前端构建完成 ✓&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 构建Java后端</span><br><span class="line">build_backend() &#123;</span><br><span class="line">    print_message &quot;开始构建Java后端...&quot;</span><br><span class="line">    cd backend</span><br><span class="line">    </span><br><span class="line">    # 检查Maven</span><br><span class="line">    if command -v mvn &amp;&gt; /dev/null; then</span><br><span class="line">        print_message &quot;使用Maven构建...&quot;</span><br><span class="line">        mvn clean package -DskipTests</span><br><span class="line">        mkdir -p ../dist/backend</span><br><span class="line">        cp target/*.jar ../dist/backend/</span><br><span class="line">    else</span><br><span class="line">        print_warning &quot;Maven未找到，跳过Java构建&quot;</span><br><span class="line">    fi</span><br><span class="line">    </span><br><span class="line">    cd ..</span><br><span class="line">    print_message &quot;Java后端构建完成 ✓&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 构建Python AI引擎</span><br><span class="line">build_ai_engine() &#123;</span><br><span class="line">    print_message &quot;开始构建Python AI引擎...&quot;</span><br><span class="line">    cd ai-engine</span><br><span class="line">    </span><br><span class="line">    # 创建虚拟环境（如果不存在）</span><br><span class="line">    if [ ! -d &quot;venv&quot; ]; then</span><br><span class="line">        print_message &quot;创建Python虚拟环境...&quot;</span><br><span class="line">        python3 -m venv venv</span><br><span class="line">        source venv/bin/activate</span><br><span class="line">        pip install --upgrade pip</span><br><span class="line">        pip install -r requirements.txt</span><br><span class="line">    else</span><br><span class="line">        source venv/bin/activate</span><br><span class="line">    fi</span><br><span class="line">    </span><br><span class="line">    # 复制文件到dist</span><br><span class="line">    mkdir -p ../dist/ai-engine</span><br><span class="line">    cp -r . ../dist/ai-engine/</span><br><span class="line">    </span><br><span class="line">    deactivate</span><br><span class="line">    cd ..</span><br><span class="line">    print_message &quot;Python AI引擎构建完成 ✓&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 构建C核心引擎</span><br><span class="line">build_c_engine() &#123;</span><br><span class="line">    print_message &quot;开始构建C核心引擎...&quot;</span><br><span class="line">    cd engine-core</span><br><span class="line">    </span><br><span class="line">    # 检查Makefile是否存在</span><br><span class="line">    if [ -f &quot;Makefile&quot; ]; then</span><br><span class="line">        make clean</span><br><span class="line">        make all</span><br><span class="line">        mkdir -p ../dist/engine-core</span><br><span class="line">        cp -r bin/* ../dist/engine-core/ 2&gt;/dev/null || true</span><br><span class="line">    else</span><br><span class="line">        print_message &quot;创建并运行Makefile...&quot;</span><br><span class="line">        </span><br><span class="line">        # 简单的Makefile内容</span><br><span class="line">        cat &gt; Makefile &lt;&lt; &#x27;EOF&#x27;</span><br><span class="line">CC = gcc</span><br><span class="line">CFLAGS = -Wall -Wextra -O2 -I./include</span><br><span class="line">TARGET = kingdom_defense_engine</span><br><span class="line">SOURCES = src/main.c src/pathfinding/a_star.c src/physics/collision_detection.c</span><br><span class="line">OBJECTS = $(SOURCES:.c=.o)</span><br><span class="line"></span><br><span class="line">all: $(TARGET)</span><br><span class="line"></span><br><span class="line">$(TARGET): $(OBJECTS)</span><br><span class="line">	$(CC) $(CFLAGS) -o $(TARGET) $(OBJECTS) -lm</span><br><span class="line"></span><br><span class="line">%.o: %.c</span><br><span class="line">	$(CC) $(CFLAGS) -c $&lt; -o $@</span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line">	rm -f $(OBJECTS) $(TARGET)</span><br><span class="line"></span><br><span class="line">test: all</span><br><span class="line">	./$(TARGET)</span><br><span class="line"></span><br><span class="line">.PHONY: all clean test</span><br><span class="line">EOF</span><br><span class="line">        </span><br><span class="line">        make all</span><br><span class="line">        mkdir -p bin</span><br><span class="line">        mv kingdom_defense_engine bin/</span><br><span class="line">        mkdir -p ../dist/engine-core</span><br><span class="line">        cp -r bin/* ../dist/engine-core/</span><br><span class="line">    fi</span><br><span class="line">    </span><br><span class="line">    cd ..</span><br><span class="line">    print_message &quot;C核心引擎构建完成 ✓&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 创建Docker配置</span><br><span class="line">create_docker_config() &#123;</span><br><span class="line">    print_message &quot;创建Docker配置...&quot;</span><br><span class="line">    </span><br><span class="line">    # Docker Compose配置</span><br><span class="line">    cat &gt; docker-compose.prod.yml &lt;&lt; &#x27;EOF&#x27;</span><br><span class="line">version: &#x27;3.8&#x27;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  frontend:</span><br><span class="line">    build:</span><br><span class="line">      context: ./frontend</span><br><span class="line">      dockerfile: Dockerfile</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;80:80&quot;</span><br><span class="line">    depends_on:</span><br><span class="line">      - backend</span><br><span class="line">      - ai-engine</span><br><span class="line">    networks:</span><br><span class="line">      - kingdom-network</span><br><span class="line"></span><br><span class="line">  backend:</span><br><span class="line">    build:</span><br><span class="line">      context: ./backend</span><br><span class="line">      dockerfile: Dockerfile</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;8080:8080&quot;</span><br><span class="line">    environment:</span><br><span class="line">      - SPRING_PROFILES_ACTIVE=prod</span><br><span class="line">      - DB_URL=jdbc:h2:file:/data/kingdom-defense-db</span><br><span class="line">    volumes:</span><br><span class="line">      - backend-data:/data</span><br><span class="line">    networks:</span><br><span class="line">      - kingdom-network</span><br><span class="line"></span><br><span class="line">  ai-engine:</span><br><span class="line">    build:</span><br><span class="line">      context: ./ai-engine</span><br><span class="line">      dockerfile: Dockerfile</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;5001:5001&quot;</span><br><span class="line">    networks:</span><br><span class="line">      - kingdom-network</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  kingdom-network:</span><br><span class="line">    driver: bridge</span><br><span class="line"></span><br><span class="line">volumes:</span><br><span class="line">  backend-data:</span><br><span class="line">EOF</span><br><span class="line">    </span><br><span class="line">    print_message &quot;Docker配置创建完成 ✓&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 主构建流程</span><br><span class="line">main() &#123;</span><br><span class="line">    echo &quot;&quot;</span><br><span class="line">    print_message &quot;开始Kingdom Defense完整构建流程&quot;</span><br><span class="line">    echo &quot;&quot;</span><br><span class="line">    </span><br><span class="line">    # 检查依赖</span><br><span class="line">    check_dependencies</span><br><span class="line">    </span><br><span class="line">    # 创建dist目录</span><br><span class="line">    mkdir -p dist</span><br><span class="line">    </span><br><span class="line">    # 构建各组件</span><br><span class="line">    build_frontend</span><br><span class="line">    build_backend</span><br><span class="line">    build_ai_engine</span><br><span class="line">    build_c_engine</span><br><span class="line">    </span><br><span class="line">    # 创建Docker配置</span><br><span class="line">    create_docker_config</span><br><span class="line">    </span><br><span class="line">    echo &quot;&quot;</span><br><span class="line">    print_message &quot;=========================================&quot;</span><br><span class="line">    print_message &quot;      构建完成！&quot;</span><br><span class="line">    print_message &quot;=========================================&quot;</span><br><span class="line">    echo &quot;&quot;</span><br><span class="line">    print_message &quot;构建输出位于: dist/&quot;</span><br><span class="line">    print_message &quot;&quot;</span><br><span class="line">    print_message &quot;可用组件:&quot;</span><br><span class="line">    print_message &quot;  - 前端: dist/frontend/&quot;</span><br><span class="line">    print_message &quot;  - 后端: dist/backend/&quot;</span><br><span class="line">    print_message &quot;  - AI引擎: dist/ai-engine/&quot;</span><br><span class="line">    print_message &quot;  - C核心: dist/engine-core/&quot;</span><br><span class="line">    echo &quot;&quot;</span><br><span class="line">    print_message &quot;使用以下命令启动所有服务:&quot;</span><br><span class="line">    print_message &quot;  docker-compose -f docker-compose.prod.yml up -d&quot;</span><br><span class="line">    echo &quot;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 执行主函数</span><br><span class="line">main</span><br></pre></td></tr></table></figure>



<p>创建 <code>scripts/start_services.sh</code>:</p>
<p>bash</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># Kingdom Defense - 服务启动脚本</span><br><span class="line"></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">echo &quot;=========================================&quot;</span><br><span class="line">echo &quot;    Kingdom Defense - 服务启动&quot;</span><br><span class="line">echo &quot;=========================================&quot;</span><br><span class="line"></span><br><span class="line"># 颜色定义</span><br><span class="line">GREEN=&#x27;\033[0;32m&#x27;</span><br><span class="line">NC=&#x27;\033[0m&#x27; # No Color</span><br><span class="line"></span><br><span class="line">print_message() &#123;</span><br><span class="line">    echo -e &quot;$&#123;GREEN&#125;[INFO]$&#123;NC&#125; $1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 检查Docker是否安装</span><br><span class="line">if ! command -v docker &amp;&gt; /dev/null; then</span><br><span class="line">    echo &quot;错误: Docker未安装。请先安装Docker。&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 检查Docker Compose是否安装</span><br><span class="line">if ! command -v docker-compose &amp;&gt; /dev/null; then</span><br><span class="line">    echo &quot;错误: Docker Compose未安装。请先安装Docker Compose。&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">print_message &quot;启动Kingdom Defense服务...&quot;</span><br><span class="line"></span><br><span class="line"># 检查是否在项目根目录</span><br><span class="line">if [ ! -f &quot;docker-compose.yml&quot; ] &amp;&amp; [ ! -f &quot;docker-compose.prod.yml&quot; ]; then</span><br><span class="line">    print_message &quot;未找到Docker Compose配置，使用开发模式启动...&quot;</span><br><span class="line">    </span><br><span class="line">    # 启动前端开发服务器（在后台）</span><br><span class="line">    print_message &quot;启动前端开发服务器...&quot;</span><br><span class="line">    cd frontend</span><br><span class="line">    python3 -m http.server 8000 &amp;</span><br><span class="line">    FRONTEND_PID=$!</span><br><span class="line">    cd ..</span><br><span class="line">    </span><br><span class="line">    # 启动Java后端</span><br><span class="line">    print_message &quot;启动Java后端...&quot;</span><br><span class="line">    cd backend</span><br><span class="line">    if [ -f &quot;target/*.jar&quot; ]; then</span><br><span class="line">        java -jar target/*.jar &amp;</span><br><span class="line">        BACKEND_PID=$!</span><br><span class="line">    fi</span><br><span class="line">    cd ..</span><br><span class="line">    </span><br><span class="line">    # 启动Python AI引擎</span><br><span class="line">    print_message &quot;启动Python AI引擎...&quot;</span><br><span class="line">    cd ai-engine</span><br><span class="line">    source venv/bin/activate</span><br><span class="line">    python app.py &amp;</span><br><span class="line">    AI_PID=$!</span><br><span class="line">    deactivate</span><br><span class="line">    cd ..</span><br><span class="line">    </span><br><span class="line">    print_message &quot;所有服务已启动！&quot;</span><br><span class="line">    echo &quot;&quot;</span><br><span class="line">    echo &quot;访问以下地址：&quot;</span><br><span class="line">    echo &quot;  前端: http://localhost:8000&quot;</span><br><span class="line">    echo &quot;  后端: http://localhost:8080&quot;</span><br><span class="line">    echo &quot;  AI引擎: http://localhost:5001&quot;</span><br><span class="line">    echo &quot;&quot;</span><br><span class="line">    echo &quot;按Ctrl+C停止所有服务&quot;</span><br><span class="line">    </span><br><span class="line">    # 等待Ctrl+C</span><br><span class="line">    trap &quot;kill $FRONTEND_PID $BACKEND_PID $AI_PID 2&gt;/dev/null; exit&quot; INT</span><br><span class="line">    wait</span><br><span class="line">    </span><br><span class="line">else</span><br><span class="line">    # 使用Docker Compose启动</span><br><span class="line">    if [ -f &quot;docker-compose.prod.yml&quot; ]; then</span><br><span class="line">        print_message &quot;使用生产Docker Compose配置启动...&quot;</span><br><span class="line">        docker-compose -f docker-compose.prod.yml up -d</span><br><span class="line">    else</span><br><span class="line">        print_message &quot;使用开发Docker Compose配置启动...&quot;</span><br><span class="line">        docker-compose up -d</span><br><span class="line">    fi</span><br><span class="line">    </span><br><span class="line">    print_message &quot;服务启动完成！&quot;</span><br><span class="line">    echo &quot;&quot;</span><br><span class="line">    docker-compose ps</span><br><span class="line">    echo &quot;&quot;</span><br><span class="line">    print_message &quot;使用以下命令查看日志：&quot;</span><br><span class="line">    print_message &quot;  docker-compose logs -f&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>



<h2 id="配置说明"><a href="#配置说明" class="headerlink" title="配置说明"></a>配置说明</h2><h3 id="1-环境要求"><a href="#1-环境要求" class="headerlink" title="1. 环境要求"></a>1. 环境要求</h3><ul>
<li><strong>Node.js</strong> v14+ (前端开发)</li>
<li><strong>Java</strong> 11+ (后端服务)</li>
<li><strong>Python</strong> 3.8+ (AI引擎)</li>
<li><strong>GCC</strong> 9.0+ (C核心引擎)</li>
<li><strong>Docker</strong> 20.0+ (容器化部署)</li>
</ul>
<h3 id="2-安装步骤"><a href="#2-安装步骤" class="headerlink" title="2. 安装步骤"></a>2. 安装步骤</h3><p>bash</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 1. 克隆项目</span><br><span class="line">git clone &lt;repository-url&gt;</span><br><span class="line">cd kingdom-defense</span><br><span class="line"></span><br><span class="line"># 2. 授予脚本执行权限</span><br><span class="line">chmod +x scripts/*.sh</span><br><span class="line"></span><br><span class="line"># 3. 构建所有组件</span><br><span class="line">./scripts/build_all.sh</span><br><span class="line"></span><br><span class="line"># 4. 启动服务</span><br><span class="line">./scripts/start_services.sh</span><br></pre></td></tr></table></figure>



<h3 id="3-开发模式启动"><a href="#3-开发模式启动" class="headerlink" title="3. 开发模式启动"></a>3. 开发模式启动</h3><p>bash</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 分别启动各服务</span><br><span class="line"></span><br><span class="line"># 前端开发服务器</span><br><span class="line">cd frontend</span><br><span class="line">python3 -m http.server 8000</span><br><span class="line"></span><br><span class="line"># Java后端（另一个终端）</span><br><span class="line">cd backend</span><br><span class="line">mvn spring-boot:run</span><br><span class="line"></span><br><span class="line"># Python AI引擎（另一个终端）</span><br><span class="line">cd ai-engine</span><br><span class="line">source venv/bin/activate</span><br><span class="line">python app.py</span><br><span class="line"></span><br><span class="line"># 编译C核心</span><br><span class="line">cd engine-core</span><br><span class="line">make all</span><br><span class="line">./bin/kingdom_defense_engine</span><br></pre></td></tr></table></figure>



<h2 id="扩展建议"><a href="#扩展建议" class="headerlink" title="扩展建议"></a>扩展建议</h2><h3 id="1-游戏功能扩展"><a href="#1-游戏功能扩展" class="headerlink" title="1. 游戏功能扩展"></a>1. 游戏功能扩展</h3><ul>
<li>添加更多塔类型（冰冻塔、毒塔、召唤塔等）</li>
<li>实现英雄系统</li>
<li>添加天气系统影响游戏</li>
<li>实现多人在线合作模式</li>
<li>添加成就系统</li>
</ul>
<h3 id="2-技术优化"><a href="#2-技术优化" class="headerlink" title="2. 技术优化"></a>2. 技术优化</h3><ul>
<li>使用WebGL替代Canvas 2D提升性能</li>
<li>实现WebSocket实时多人对战</li>
<li>添加Service Worker实现离线游戏</li>
<li>使用WebAssembly优化计算密集型任务</li>
<li>实现A&#x2F;B测试和数据分析系统</li>
</ul>
<h3 id="3-部署优化"><a href="#3-部署优化" class="headerlink" title="3. 部署优化"></a>3. 部署优化</h3><ul>
<li>配置CI&#x2F;CD流水线</li>
<li>添加监控和日志系统</li>
<li>实现自动扩缩容</li>
<li>配置CDN加速资源加载</li>
<li>实现蓝绿部署</li>
</ul>
<p>这个项目展示了如何使用不同编程语言构建一个完整的游戏系统，每种语言都发挥了其优势：JavaScript用于交互式前端，Java用于稳定的后端服务，Python用于AI和数据分析，C用于高性能计算，Shell用于自动化。您可以根据需要选择实现全部或部分模块。</p>
<p>请继续扩展完善</p>
<p>我们继续扩展和完善这个项目。由于项目已经很大，我们将分别对各个模块进行扩展。</p>
<h2 id="第七阶段：扩展前端功能（第8周）"><a href="#第七阶段：扩展前端功能（第8周）" class="headerlink" title="第七阶段：扩展前端功能（第8周）"></a>第七阶段：扩展前端功能（第8周）</h2><h3 id="步骤10：完善游戏功能"><a href="#步骤10：完善游戏功能" class="headerlink" title="步骤10：完善游戏功能"></a>步骤10：完善游戏功能</h3><h4 id="10-1-添加更多塔类型"><a href="#10-1-添加更多塔类型" class="headerlink" title="10.1 添加更多塔类型"></a>10.1 添加更多塔类型</h4><p>在<code>frontend/js/entities/tower.js</code>中，我们扩展塔的类型和功能：</p>
<p>javascript</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line">class Tower &#123;</span><br><span class="line">    constructor(x, y, type) &#123;</span><br><span class="line">        this.x = x;</span><br><span class="line">        this.y = y;</span><br><span class="line">        this.type = type;</span><br><span class="line">        this.level = 1;</span><br><span class="line">        this.upgradeCost = 100;</span><br><span class="line">        this.sellValue = 50;</span><br><span class="line">        this.experience = 0;</span><br><span class="line">        this.maxExperience = 100;</span><br><span class="line">        </span><br><span class="line">        // 根据类型初始化属性</span><br><span class="line">        this.initTowerStats();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    initTowerStats() &#123;</span><br><span class="line">        switch(this.type) &#123;</span><br><span class="line">            case &#x27;arrow&#x27;:</span><br><span class="line">                this.range = 200;</span><br><span class="line">                this.damage = 10;</span><br><span class="line">                this.attackSpeed = 1.5;</span><br><span class="line">                this.projectileSpeed = 400;</span><br><span class="line">                this.color = &#x27;#4CAF50&#x27;;</span><br><span class="line">                this.cost = 50;</span><br><span class="line">                break;</span><br><span class="line">            case &#x27;cannon&#x27;:</span><br><span class="line">                this.range = 180;</span><br><span class="line">                this.damage = 30;</span><br><span class="line">                this.attackSpeed = 0.8;</span><br><span class="line">                this.projectileSpeed = 300;</span><br><span class="line">                this.splashRadius = 40;</span><br><span class="line">                this.color = &#x27;#FF5722&#x27;;</span><br><span class="line">                this.cost = 100;</span><br><span class="line">                break;</span><br><span class="line">            case &#x27;magic&#x27;:</span><br><span class="line">                this.range = 220;</span><br><span class="line">                this.damage = 15;</span><br><span class="line">                this.attackSpeed = 1.2;</span><br><span class="line">                this.projectileSpeed = 350;</span><br><span class="line">                this.slowEffect = 0.5; // 减速效果</span><br><span class="line">                this.color = &#x27;#9C27B0&#x27;;</span><br><span class="line">                this.cost = 80;</span><br><span class="line">                break;</span><br><span class="line">            case &#x27;barracks&#x27;:</span><br><span class="line">                this.range = 0; // 兵营不攻击</span><br><span class="line">                this.spawnRate = 3; // 每3秒生成一个士兵</span><br><span class="line">                this.maxSoldiers = 3;</span><br><span class="line">                this.soldiers = [];</span><br><span class="line">                this.color = &#x27;#795548&#x27;;</span><br><span class="line">                this.cost = 120;</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        this.cooldown = 0;</span><br><span class="line">        this.target = null;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    update(deltaTime, enemies, bullets, gameManager) &#123;</span><br><span class="line">        this.cooldown -= deltaTime;</span><br><span class="line">        </span><br><span class="line">        if (this.type === &#x27;barracks&#x27;) &#123;</span><br><span class="line">            this.updateBarracks(deltaTime, enemies, gameManager);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            if (this.cooldown &lt;= 0) &#123;</span><br><span class="line">                this.target = this.findTarget(enemies);</span><br><span class="line">                if (this.target) &#123;</span><br><span class="line">                    this.attack(this.target, bullets);</span><br><span class="line">                    this.cooldown = 1 / this.attackSpeed;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 更新经验</span><br><span class="line">        if (this.experience &gt;= this.maxExperience &amp;&amp; this.level &lt; 3) &#123;</span><br><span class="line">            this.levelUp();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    updateBarracks(deltaTime, enemies, gameManager) &#123;</span><br><span class="line">        // 生成士兵</span><br><span class="line">        this.cooldown -= deltaTime;</span><br><span class="line">        if (this.cooldown &lt;= 0 &amp;&amp; this.soldiers.length &lt; this.maxSoldiers) &#123;</span><br><span class="line">            this.spawnSoldier(gameManager);</span><br><span class="line">            this.cooldown = this.spawnRate;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 更新士兵</span><br><span class="line">        for (let i = this.soldiers.length - 1; i &gt;= 0; i--) &#123;</span><br><span class="line">            this.soldiers[i].update(deltaTime, enemies);</span><br><span class="line">            </span><br><span class="line">            // 如果士兵死亡，移除</span><br><span class="line">            if (this.soldiers[i].health &lt;= 0) &#123;</span><br><span class="line">                this.soldiers.splice(i, 1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    spawnSoldier(gameManager) &#123;</span><br><span class="line">        const soldier = new Soldier(this.x, this.y, this);</span><br><span class="line">        this.soldiers.push(soldier);</span><br><span class="line">        gameManager.entities.push(soldier); // 假设gameManager有一个entities数组</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    findTarget(enemies) &#123;</span><br><span class="line">        let closest = null;</span><br><span class="line">        let closestDistance = this.range;</span><br><span class="line">        </span><br><span class="line">        for (const enemy of enemies) &#123;</span><br><span class="line">            // 对于魔法塔，优先攻击魔法抗性低的敌人</span><br><span class="line">            if (this.type === &#x27;magic&#x27; &amp;&amp; enemy.magicResist &gt; 0.8) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            const dx = enemy.x - this.x;</span><br><span class="line">            const dy = enemy.y - this.y;</span><br><span class="line">            const distance = Math.sqrt(dx * dx + dy * dy);</span><br><span class="line">            </span><br><span class="line">            if (distance &lt; closestDistance) &#123;</span><br><span class="line">                closest = enemy;</span><br><span class="line">                closestDistance = distance;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return closest;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    attack(target, bullets) &#123;</span><br><span class="line">        const bullet = new Bullet(</span><br><span class="line">            this.x,</span><br><span class="line">            this.y,</span><br><span class="line">            target,</span><br><span class="line">            this.damage,</span><br><span class="line">            this.type,</span><br><span class="line">            this.projectileSpeed</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        // 添加特殊效果</span><br><span class="line">        if (this.type === &#x27;cannon&#x27;) &#123;</span><br><span class="line">            bullet.splashRadius = this.splashRadius;</span><br><span class="line">        &#125; else if (this.type === &#x27;magic&#x27;) &#123;</span><br><span class="line">            bullet.slowEffect = this.slowEffect;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        bullets.push(bullet);</span><br><span class="line">        </span><br><span class="line">        // 增加经验</span><br><span class="line">        this.gainExperience(5);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    gainExperience(amount) &#123;</span><br><span class="line">        this.experience += amount;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    levelUp() &#123;</span><br><span class="line">        this.level++;</span><br><span class="line">        this.experience = 0;</span><br><span class="line">        this.maxExperience = this.level * 100;</span><br><span class="line">        </span><br><span class="line">        // 提升属性</span><br><span class="line">        this.damage *= 1.5;</span><br><span class="line">        this.range *= 1.1;</span><br><span class="line">        this.attackSpeed *= 1.2;</span><br><span class="line">        </span><br><span class="line">        if (this.type === &#x27;cannon&#x27;) &#123;</span><br><span class="line">            this.splashRadius *= 1.2;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        this.upgradeCost = Math.floor(this.upgradeCost * 1.5);</span><br><span class="line">        this.sellValue = Math.floor(this.sellValue * 1.3);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    sell() &#123;</span><br><span class="line">        return this.sellValue;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    getUpgradeInfo() &#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            level: this.level,</span><br><span class="line">            damage: this.damage,</span><br><span class="line">            range: this.range,</span><br><span class="line">            attackSpeed: this.attackSpeed,</span><br><span class="line">            upgradeCost: this.upgradeCost,</span><br><span class="line">            sellValue: this.sellValue,</span><br><span class="line">            experience: this.experience,</span><br><span class="line">            maxExperience: this.maxExperience</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    draw(ctx) &#123;</span><br><span class="line">        // 绘制塔底座</span><br><span class="line">        ctx.fillStyle = &#x27;#37474F&#x27;;</span><br><span class="line">        ctx.beginPath();</span><br><span class="line">        ctx.arc(this.x, this.y, 30, 0, Math.PI * 2);</span><br><span class="line">        ctx.fill();</span><br><span class="line">        </span><br><span class="line">        // 绘制塔身</span><br><span class="line">        ctx.fillStyle = this.color;</span><br><span class="line">        ctx.beginPath();</span><br><span class="line">        ctx.arc(this.x, this.y, 20, 0, Math.PI * 2);</span><br><span class="line">        ctx.fill();</span><br><span class="line">        </span><br><span class="line">        // 绘制等级标志</span><br><span class="line">        ctx.fillStyle = &#x27;#FFD700&#x27;;</span><br><span class="line">        ctx.font = &#x27;14px Arial&#x27;;</span><br><span class="line">        ctx.textAlign = &#x27;center&#x27;;</span><br><span class="line">        ctx.textBaseline = &#x27;middle&#x27;;</span><br><span class="line">        ctx.fillText(this.level.toString(), this.x, this.y);</span><br><span class="line">        </span><br><span class="line">        // 绘制经验条</span><br><span class="line">        if (this.level &lt; 3) &#123;</span><br><span class="line">            const expPercent = this.experience / this.maxExperience;</span><br><span class="line">            const barWidth = 40;</span><br><span class="line">            const barHeight = 5;</span><br><span class="line">            </span><br><span class="line">            ctx.fillStyle = &#x27;#555&#x27;;</span><br><span class="line">            ctx.fillRect(</span><br><span class="line">                this.x - barWidth / 2,</span><br><span class="line">                this.y + 30,</span><br><span class="line">                barWidth,</span><br><span class="line">                barHeight</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            ctx.fillStyle = &#x27;#4CAF50&#x27;;</span><br><span class="line">            ctx.fillRect(</span><br><span class="line">                this.x - barWidth / 2,</span><br><span class="line">                this.y + 30,</span><br><span class="line">                barWidth * expPercent,</span><br><span class="line">                barHeight</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 如果鼠标悬停，显示范围</span><br><span class="line">        if (this.isMouseOver()) &#123;</span><br><span class="line">            ctx.strokeStyle = &#x27;rgba(255, 255, 255, 0.3)&#x27;;</span><br><span class="line">            ctx.lineWidth = 2;</span><br><span class="line">            ctx.beginPath();</span><br><span class="line">            ctx.arc(this.x, this.y, this.range, 0, Math.PI * 2);</span><br><span class="line">            ctx.stroke();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 绘制士兵（如果是兵营）</span><br><span class="line">        if (this.type === &#x27;barracks&#x27;) &#123;</span><br><span class="line">            this.soldiers.forEach(soldier =&gt; soldier.draw(ctx));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    isMouseOver() &#123;</span><br><span class="line">        const gameManager = window.gameManager;</span><br><span class="line">        if (!gameManager) return false;</span><br><span class="line">        </span><br><span class="line">        const dx = gameManager.mouse.x - this.x;</span><br><span class="line">        const dy = gameManager.mouse.y - this.y;</span><br><span class="line">        return Math.sqrt(dx * dx + dy * dy) &lt; 30;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="10-2-添加士兵类（用于兵营）"><a href="#10-2-添加士兵类（用于兵营）" class="headerlink" title="10.2 添加士兵类（用于兵营）"></a>10.2 添加士兵类（用于兵营）</h4><p>创建 <code>frontend/js/entities/soldier.js</code>:</p>
<p>javascript</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">class Soldier &#123;</span><br><span class="line">    constructor(x, y, barracks) &#123;</span><br><span class="line">        this.x = x;</span><br><span class="line">        this.y = y;</span><br><span class="line">        this.barracks = barracks;</span><br><span class="line">        this.health = 100;</span><br><span class="line">        this.maxHealth = 100;</span><br><span class="line">        this.damage = 5;</span><br><span class="line">        this.attackRange = 30;</span><br><span class="line">        this.attackSpeed = 1;</span><br><span class="line">        this.cooldown = 0;</span><br><span class="line">        this.speed = 50;</span><br><span class="line">        this.target = null;</span><br><span class="line">        this.color = &#x27;#8B4513&#x27;;</span><br><span class="line">        this.size = 10;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    update(deltaTime, enemies) &#123;</span><br><span class="line">        this.cooldown -= deltaTime;</span><br><span class="line">        </span><br><span class="line">        // 寻找目标</span><br><span class="line">        if (!this.target || this.target.health &lt;= 0) &#123;</span><br><span class="line">            this.target = this.findTarget(enemies);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (this.target) &#123;</span><br><span class="line">            const dx = this.target.x - this.x;</span><br><span class="line">            const dy = this.target.y - this.y;</span><br><span class="line">            const distance = Math.sqrt(dx * dx + dy * dy);</span><br><span class="line">            </span><br><span class="line">            if (distance &lt;= this.attackRange) &#123;</span><br><span class="line">                // 攻击目标</span><br><span class="line">                if (this.cooldown &lt;= 0) &#123;</span><br><span class="line">                    this.target.takeDamage(this.damage);</span><br><span class="line">                    this.cooldown = 1 / this.attackSpeed;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // 向目标移动</span><br><span class="line">                const moveX = (dx / distance) * this.speed * deltaTime;</span><br><span class="line">                const moveY = (dy / distance) * this.speed * deltaTime;</span><br><span class="line">                </span><br><span class="line">                this.x += moveX;</span><br><span class="line">                this.y += moveY;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 如果离兵营太远，返回</span><br><span class="line">        const dx = this.barracks.x - this.x;</span><br><span class="line">        const dy = this.barracks.y - this.y;</span><br><span class="line">        const distanceToBarracks = Math.sqrt(dx * dx + dy * dy);</span><br><span class="line">        </span><br><span class="line">        if (distanceToBarracks &gt; this.barracks.range) &#123;</span><br><span class="line">            // 返回兵营</span><br><span class="line">            const moveX = (dx / distanceToBarracks) * this.speed * deltaTime;</span><br><span class="line">            const moveY = (dy / distanceToBarracks) * this.speed * deltaTime;</span><br><span class="line">            </span><br><span class="line">            this.x += moveX;</span><br><span class="line">            this.y += moveY;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    findTarget(enemies) &#123;</span><br><span class="line">        let closest = null;</span><br><span class="line">        let closestDistance = 150; // 士兵的视野范围</span><br><span class="line">        </span><br><span class="line">        for (const enemy of enemies) &#123;</span><br><span class="line">            const dx = enemy.x - this.x;</span><br><span class="line">            const dy = enemy.y - this.y;</span><br><span class="line">            const distance = Math.sqrt(dx * dx + dy * dy);</span><br><span class="line">            </span><br><span class="line">            if (distance &lt; closestDistance) &#123;</span><br><span class="line">                closest = enemy;</span><br><span class="line">                closestDistance = distance;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return closest;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    takeDamage(amount) &#123;</span><br><span class="line">        this.health -= amount;</span><br><span class="line">        return this.health &lt;= 0;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    draw(ctx) &#123;</span><br><span class="line">        // 绘制士兵身体</span><br><span class="line">        ctx.fillStyle = this.color;</span><br><span class="line">        ctx.beginPath();</span><br><span class="line">        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);</span><br><span class="line">        ctx.fill();</span><br><span class="line">        </span><br><span class="line">        // 绘制士兵盾牌</span><br><span class="line">        ctx.fillStyle = &#x27;#696969&#x27;;</span><br><span class="line">        ctx.fillRect(this.x - 12, this.y - 5, 8, 10);</span><br><span class="line">        </span><br><span class="line">        // 绘制生命条</span><br><span class="line">        const healthPercent = this.health / this.maxHealth;</span><br><span class="line">        const barWidth = 20;</span><br><span class="line">        const barHeight = 3;</span><br><span class="line">        </span><br><span class="line">        ctx.fillStyle = &#x27;#F44336&#x27;;</span><br><span class="line">        ctx.fillRect(</span><br><span class="line">            this.x - barWidth / 2,</span><br><span class="line">            this.y - this.size - 10,</span><br><span class="line">            barWidth,</span><br><span class="line">            barHeight</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        ctx.fillStyle = &#x27;#4CAF50&#x27;;</span><br><span class="line">        ctx.fillRect(</span><br><span class="line">            this.x - barWidth / 2,</span><br><span class="line">            this.y - this.size - 10,</span><br><span class="line">            barWidth * healthPercent,</span><br><span class="line">            barHeight</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="10-3-扩展敌人类型"><a href="#10-3-扩展敌人类型" class="headerlink" title="10.3 扩展敌人类型"></a>10.3 扩展敌人类型</h4><p>在<code>frontend/js/entities/enemy.js</code>中，我们添加更多敌人类型和属性：</p>
<p>javascript</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br></pre></td><td class="code"><pre><span class="line">class Enemy &#123;</span><br><span class="line">    constructor(x, y, type) &#123;</span><br><span class="line">        this.x = x;</span><br><span class="line">        this.y = y;</span><br><span class="line">        this.type = type;</span><br><span class="line">        </span><br><span class="line">        // 初始化敌人属性</span><br><span class="line">        this.initEnemyStats();</span><br><span class="line">        </span><br><span class="line">        this.path = [];</span><br><span class="line">        this.currentPathIndex = 0;</span><br><span class="line">        this.reachedEnd = false;</span><br><span class="line">        this.slowEffects = []; // 存储减速效果</span><br><span class="line">        this.dotEffects = []; // 存储持续伤害效果</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    initEnemyStats() &#123;</span><br><span class="line">        switch(this.type) &#123;</span><br><span class="line">            case &#x27;infantry&#x27;:</span><br><span class="line">                this.health = 50;</span><br><span class="line">                this.maxHealth = 50;</span><br><span class="line">                this.speed = 100;</span><br><span class="line">                this.reward = 10;</span><br><span class="line">                this.armor = 0.1; // 减少10%物理伤害</span><br><span class="line">                this.magicResist = 0.2; // 减少20%魔法伤害</span><br><span class="line">                this.color = &#x27;#2196F3&#x27;;</span><br><span class="line">                this.size = 15;</span><br><span class="line">                break;</span><br><span class="line">            case &#x27;cavalry&#x27;:</span><br><span class="line">                this.health = 75;</span><br><span class="line">                this.maxHealth = 75;</span><br><span class="line">                this.speed = 150;</span><br><span class="line">                this.reward = 15;</span><br><span class="line">                this.armor = 0.2;</span><br><span class="line">                this.magicResist = 0.1;</span><br><span class="line">                this.color = &#x27;#4CAF50&#x27;;</span><br><span class="line">                this.size = 18;</span><br><span class="line">                break;</span><br><span class="line">            case &#x27;armored&#x27;:</span><br><span class="line">                this.health = 150;</span><br><span class="line">                this.maxHealth = 150;</span><br><span class="line">                this.speed = 60;</span><br><span class="line">                this.reward = 25;</span><br><span class="line">                this.armor = 0.5;</span><br><span class="line">                this.magicResist = 0.3;</span><br><span class="line">                this.color = &#x27;#FF9800&#x27;;</span><br><span class="line">                this.size = 20;</span><br><span class="line">                break;</span><br><span class="line">            case &#x27;flying&#x27;:</span><br><span class="line">                this.health = 40;</span><br><span class="line">                this.maxHealth = 40;</span><br><span class="line">                this.speed = 120;</span><br><span class="line">                this.reward = 20;</span><br><span class="line">                this.armor = 0;</span><br><span class="line">                this.magicResist = 0.5;</span><br><span class="line">                this.color = &#x27;#9C27B0&#x27;;</span><br><span class="line">                this.size = 12;</span><br><span class="line">                this.isFlying = true;</span><br><span class="line">                break;</span><br><span class="line">            case &#x27;boss&#x27;:</span><br><span class="line">                this.health = 500;</span><br><span class="line">                this.maxHealth = 500;</span><br><span class="line">                this.speed = 40;</span><br><span class="line">                this.reward = 100;</span><br><span class="line">                this.armor = 0.7;</span><br><span class="line">                this.magicResist = 0.6;</span><br><span class="line">                this.color = &#x27;#F44336&#x27;;</span><br><span class="line">                this.size = 30;</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    update(deltaTime) &#123;</span><br><span class="line">        if (this.reachedEnd) return;</span><br><span class="line">        </span><br><span class="line">        // 更新状态效果</span><br><span class="line">        this.updateEffects(deltaTime);</span><br><span class="line">        </span><br><span class="line">        // 计算实际速度（考虑减速效果）</span><br><span class="line">        let actualSpeed = this.speed;</span><br><span class="line">        for (const effect of this.slowEffects) &#123;</span><br><span class="line">            actualSpeed *= (1 - effect.amount);</span><br><span class="line">        &#125;</span><br><span class="line">        actualSpeed = Math.max(actualSpeed, this.speed * 0.1); // 最低速度为10%</span><br><span class="line">        </span><br><span class="line">        // 沿路径移动</span><br><span class="line">        if (this.path.length &gt; 0) &#123;</span><br><span class="line">            const target = this.path[this.currentPathIndex];</span><br><span class="line">            const dx = target.x - this.x;</span><br><span class="line">            const dy = target.y - this.y;</span><br><span class="line">            const distance = Math.sqrt(dx * dx + dy * dy);</span><br><span class="line">            </span><br><span class="line">            if (distance &lt; 5) &#123;</span><br><span class="line">                this.currentPathIndex++;</span><br><span class="line">                if (this.currentPathIndex &gt;= this.path.length) &#123;</span><br><span class="line">                    this.reachedEnd = true;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                const moveDistance = actualSpeed * deltaTime;</span><br><span class="line">                const moveX = (dx / distance) * moveDistance;</span><br><span class="line">                const moveY = (dy / distance) * moveDistance;</span><br><span class="line">                </span><br><span class="line">                this.x += moveX;</span><br><span class="line">                this.y += moveY;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    updateEffects(deltaTime) &#123;</span><br><span class="line">        // 更新减速效果</span><br><span class="line">        for (let i = this.slowEffects.length - 1; i &gt;= 0; i--) &#123;</span><br><span class="line">            this.slowEffects[i].duration -= deltaTime;</span><br><span class="line">            if (this.slowEffects[i].duration &lt;= 0) &#123;</span><br><span class="line">                this.slowEffects.splice(i, 1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 更新持续伤害效果</span><br><span class="line">        for (let i = this.dotEffects.length - 1; i &gt;= 0; i--) &#123;</span><br><span class="line">            this.dotEffects[i].timer -= deltaTime;</span><br><span class="line">            if (this.dotEffects[i].timer &lt;= 0) &#123;</span><br><span class="line">                this.takeDamage(this.dotEffects[i].damage, this.dotEffects[i].type);</span><br><span class="line">                this.dotEffects[i].duration -= 1;</span><br><span class="line">                this.dotEffects[i].timer = this.dotEffects[i].interval;</span><br><span class="line">                </span><br><span class="line">                if (this.dotEffects[i].duration &lt;= 0) &#123;</span><br><span class="line">                    this.dotEffects.splice(i, 1);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    takeDamage(damage, damageType = &#x27;physical&#x27;) &#123;</span><br><span class="line">        let actualDamage = damage;</span><br><span class="line">        </span><br><span class="line">        // 根据伤害类型应用抗性</span><br><span class="line">        if (damageType === &#x27;physical&#x27;) &#123;</span><br><span class="line">            actualDamage *= (1 - this.armor);</span><br><span class="line">        &#125; else if (damageType === &#x27;magic&#x27;) &#123;</span><br><span class="line">            actualDamage *= (1 - this.magicResist);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        this.health -= actualDamage;</span><br><span class="line">        </span><br><span class="line">        // 返回是否死亡</span><br><span class="line">        return this.health &lt;= 0;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    addSlowEffect(amount, duration) &#123;</span><br><span class="line">        this.slowEffects.push(&#123;</span><br><span class="line">            amount: amount,</span><br><span class="line">            duration: duration</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    addDotEffect(damage, interval, duration, type = &#x27;physical&#x27;) &#123;</span><br><span class="line">        this.dotEffects.push(&#123;</span><br><span class="line">            damage: damage,</span><br><span class="line">            interval: interval,</span><br><span class="line">            duration: duration,</span><br><span class="line">            timer: interval,</span><br><span class="line">            type: type</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    draw(ctx) &#123;</span><br><span class="line">        // 绘制敌人身体</span><br><span class="line">        ctx.fillStyle = this.color;</span><br><span class="line">        ctx.beginPath();</span><br><span class="line">        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);</span><br><span class="line">        ctx.fill();</span><br><span class="line">        </span><br><span class="line">        // 绘制敌人边框</span><br><span class="line">        ctx.strokeStyle = &#x27;#000&#x27;;</span><br><span class="line">        ctx.lineWidth = 2;</span><br><span class="line">        ctx.beginPath();</span><br><span class="line">        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);</span><br><span class="line">        ctx.stroke();</span><br><span class="line">        </span><br><span class="line">        // 绘制生命条</span><br><span class="line">        this.drawHealthBar(ctx);</span><br><span class="line">        </span><br><span class="line">        // 绘制状态效果图标</span><br><span class="line">        this.drawStatusEffects(ctx);</span><br><span class="line">        </span><br><span class="line">        // 如果是飞行单位，绘制翅膀</span><br><span class="line">        if (this.type === &#x27;flying&#x27;) &#123;</span><br><span class="line">            ctx.fillStyle = &#x27;#E1BEE7&#x27;;</span><br><span class="line">            ctx.beginPath();</span><br><span class="line">            ctx.ellipse(this.x - 15, this.y, 10, 5, 0, 0, Math.PI * 2);</span><br><span class="line">            ctx.ellipse(this.x + 15, this.y, 10, 5, 0, 0, Math.PI * 2);</span><br><span class="line">            ctx.fill();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 如果是BOSS，绘制特殊标志</span><br><span class="line">        if (this.type === &#x27;boss&#x27;) &#123;</span><br><span class="line">            ctx.fillStyle = &#x27;#FFD700&#x27;;</span><br><span class="line">            ctx.font = &#x27;bold 16px Arial&#x27;;</span><br><span class="line">            ctx.textAlign = &#x27;center&#x27;;</span><br><span class="line">            ctx.textBaseline = &#x27;middle&#x27;;</span><br><span class="line">            ctx.fillText(&#x27;BOSS&#x27;, this.x, this.y - this.size - 20);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    drawHealthBar(ctx) &#123;</span><br><span class="line">        const healthPercent = this.health / this.maxHealth;</span><br><span class="line">        const barWidth = this.size * 2;</span><br><span class="line">        const barHeight = 5;</span><br><span class="line">        </span><br><span class="line">        // 背景</span><br><span class="line">        ctx.fillStyle = &#x27;#F44336&#x27;;</span><br><span class="line">        ctx.fillRect(</span><br><span class="line">            this.x - barWidth / 2,</span><br><span class="line">            this.y - this.size - 15,</span><br><span class="line">            barWidth,</span><br><span class="line">            barHeight</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        // 当前生命值</span><br><span class="line">        ctx.fillStyle = &#x27;#4CAF50&#x27;;</span><br><span class="line">        ctx.fillRect(</span><br><span class="line">            this.x - barWidth / 2,</span><br><span class="line">            this.y - this.size - 15,</span><br><span class="line">            barWidth * healthPercent,</span><br><span class="line">            barHeight</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        // 边框</span><br><span class="line">        ctx.strokeStyle = &#x27;#000&#x27;;</span><br><span class="line">        ctx.lineWidth = 1;</span><br><span class="line">        ctx.strokeRect(</span><br><span class="line">            this.x - barWidth / 2,</span><br><span class="line">            this.y - this.size - 15,</span><br><span class="line">            barWidth,</span><br><span class="line">            barHeight</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        // 显示生命值数字（仅对BOSS）</span><br><span class="line">        if (this.type === &#x27;boss&#x27;) &#123;</span><br><span class="line">            ctx.fillStyle = &#x27;#FFF&#x27;;</span><br><span class="line">            ctx.font = &#x27;10px Arial&#x27;;</span><br><span class="line">            ctx.textAlign = &#x27;center&#x27;;</span><br><span class="line">            ctx.fillText(</span><br><span class="line">                `$&#123;Math.ceil(this.health)&#125;/$&#123;this.maxHealth&#125;`,</span><br><span class="line">                this.x,</span><br><span class="line">                this.y - this.size - 13</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    drawStatusEffects(ctx) &#123;</span><br><span class="line">        const iconSize = 12;</span><br><span class="line">        let iconX = this.x - iconSize * 1.5;</span><br><span class="line">        const iconY = this.y + this.size + 10;</span><br><span class="line">        </span><br><span class="line">        // 绘制减速图标</span><br><span class="line">        if (this.slowEffects.length &gt; 0) &#123;</span><br><span class="line">            ctx.fillStyle = &#x27;#2196F3&#x27;;</span><br><span class="line">            ctx.beginPath();</span><br><span class="line">            ctx.arc(iconX, iconY, iconSize / 2, 0, Math.PI * 2);</span><br><span class="line">            ctx.fill();</span><br><span class="line">            </span><br><span class="line">            ctx.fillStyle = &#x27;#FFF&#x27;;</span><br><span class="line">            ctx.font = &#x27;10px Arial&#x27;;</span><br><span class="line">            ctx.textAlign = &#x27;center&#x27;;</span><br><span class="line">            ctx.textBaseline = &#x27;middle&#x27;;</span><br><span class="line">            ctx.fillText(&#x27;S&#x27;, iconX, iconY);</span><br><span class="line">            </span><br><span class="line">            iconX += iconSize * 1.5;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 绘制持续伤害图标</span><br><span class="line">        if (this.dotEffects.length &gt; 0) &#123;</span><br><span class="line">            ctx.fillStyle = &#x27;#F44336&#x27;;</span><br><span class="line">            ctx.beginPath();</span><br><span class="line">            ctx.arc(iconX, iconY, iconSize / 2, 0, Math.PI * 2);</span><br><span class="line">            ctx.fill();</span><br><span class="line">            </span><br><span class="line">            ctx.fillStyle = &#x27;#FFF&#x27;;</span><br><span class="line">            ctx.font = &#x27;10px Arial&#x27;;</span><br><span class="line">            ctx.textAlign = &#x27;center&#x27;;</span><br><span class="line">            ctx.textBaseline = &#x27;middle&#x27;;</span><br><span class="line">            ctx.fillText(&#x27;D&#x27;, iconX, iconY);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="第八阶段：完善Java后端（第9周）"><a href="#第八阶段：完善Java后端（第9周）" class="headerlink" title="第八阶段：完善Java后端（第9周）"></a>第八阶段：完善Java后端（第9周）</h2><h3 id="步骤11：扩展后端功能"><a href="#步骤11：扩展后端功能" class="headerlink" title="步骤11：扩展后端功能"></a>步骤11：扩展后端功能</h3><h4 id="11-1-添加游戏状态保存和加载"><a href="#11-1-添加游戏状态保存和加载" class="headerlink" title="11.1 添加游戏状态保存和加载"></a>11.1 添加游戏状态保存和加载</h4><p>创建 <code>backend/src/main/java/com/kingdomdefense/service/GameStateService.java</code>:</p>
<p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">package com.kingdomdefense.service;</span><br><span class="line"></span><br><span class="line">import com.kingdomdefense.model.GameState;</span><br><span class="line">import com.kingdomdefense.model.User;</span><br><span class="line">import com.kingdomdefense.repository.GameStateRepository;</span><br><span class="line">import com.kingdomdefense.repository.UserRepository;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Optional;</span><br><span class="line"></span><br><span class="line">@Service</span><br><span class="line">public class GameStateService &#123;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private GameStateRepository gameStateRepository;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private UserRepository userRepository;</span><br><span class="line">    </span><br><span class="line">    public GameState saveGameState(GameState gameState) &#123;</span><br><span class="line">        // 设置保存时间</span><br><span class="line">        gameState.setSavedAt(LocalDateTime.now());</span><br><span class="line">        </span><br><span class="line">        // 如果是新游戏，设置创建时间</span><br><span class="line">        if (gameState.getId() == null) &#123;</span><br><span class="line">            gameState.setCreatedAt(LocalDateTime.now());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return gameStateRepository.save(gameState);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public Optional&lt;GameState&gt; loadGameState(Long id) &#123;</span><br><span class="line">        return gameStateRepository.findById(id);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public List&lt;GameState&gt; getUserGameStates(Long userId) &#123;</span><br><span class="line">        return gameStateRepository.findByUserIdOrderBySavedAtDesc(userId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public boolean deleteGameState(Long id, Long userId) &#123;</span><br><span class="line">        Optional&lt;GameState&gt; gameStateOpt = gameStateRepository.findById(id);</span><br><span class="line">        </span><br><span class="line">        if (gameStateOpt.isPresent() &amp;&amp; </span><br><span class="line">            gameStateOpt.get().getUser().getId().equals(userId)) &#123;</span><br><span class="line">            gameStateRepository.deleteById(id);</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public GameState createNewGame(Long userId, String gameName) &#123;</span><br><span class="line">        Optional&lt;User&gt; userOpt = userRepository.findById(userId);</span><br><span class="line">        </span><br><span class="line">        if (userOpt.isPresent()) &#123;</span><br><span class="line">            GameState gameState = new GameState();</span><br><span class="line">            gameState.setUser(userOpt.get());</span><br><span class="line">            gameState.setGameName(gameName);</span><br><span class="line">            gameState.setCreatedAt(LocalDateTime.now());</span><br><span class="line">            gameState.setSavedAt(LocalDateTime.now());</span><br><span class="line">            </span><br><span class="line">            // 初始化游戏状态</span><br><span class="line">            gameState.setGold(100);</span><br><span class="line">            gameState.setLives(20);</span><br><span class="line">            gameState.setWave(1);</span><br><span class="line">            gameState.setScore(0);</span><br><span class="line">            gameState.setMapData(&quot;&#123;&#125;&quot;); // 空的JSON数据</span><br><span class="line">            </span><br><span class="line">            return gameStateRepository.save(gameState);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>创建 <code>backend/src/main/java/com/kingdomdefense/controller/GameStateController.java</code>:</p>
<p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">package com.kingdomdefense.controller;</span><br><span class="line"></span><br><span class="line">import com.kingdomdefense.model.GameState;</span><br><span class="line">import com.kingdomdefense.service.GameStateService;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.http.ResponseEntity;</span><br><span class="line">import org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/api/game&quot;)</span><br><span class="line">@CrossOrigin(origins = &quot;*&quot;)</span><br><span class="line">public class GameStateController &#123;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private GameStateService gameStateService;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/save&quot;)</span><br><span class="line">    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; saveGame(@RequestBody GameState gameState) &#123;</span><br><span class="line">        GameState savedState = gameStateService.saveGameState(gameState);</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span><br><span class="line">        response.put(&quot;success&quot;, true);</span><br><span class="line">        response.put(&quot;gameState&quot;, savedState);</span><br><span class="line">        response.put(&quot;message&quot;, &quot;Game saved successfully&quot;);</span><br><span class="line">        </span><br><span class="line">        return ResponseEntity.ok(response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/load/&#123;id&#125;&quot;)</span><br><span class="line">    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; loadGame(@PathVariable Long id) &#123;</span><br><span class="line">        return gameStateService.loadGameState(id)</span><br><span class="line">                .map(gameState -&gt; &#123;</span><br><span class="line">                    Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span><br><span class="line">                    response.put(&quot;success&quot;, true);</span><br><span class="line">                    response.put(&quot;gameState&quot;, gameState);</span><br><span class="line">                    return ResponseEntity.ok(response);</span><br><span class="line">                &#125;)</span><br><span class="line">                .orElse(ResponseEntity.notFound().build());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @GetMapping(&quot;/user/&#123;userId&#125;/saves&quot;)</span><br><span class="line">    public ResponseEntity&lt;List&lt;GameState&gt;&gt; getUserSaves(@PathVariable Long userId) &#123;</span><br><span class="line">        List&lt;GameState&gt; gameStates = gameStateService.getUserGameStates(userId);</span><br><span class="line">        return ResponseEntity.ok(gameStates);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/new&quot;)</span><br><span class="line">    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; createNewGame(</span><br><span class="line">            @RequestParam Long userId,</span><br><span class="line">            @RequestParam String gameName) &#123;</span><br><span class="line">        </span><br><span class="line">        GameState newGame = gameStateService.createNewGame(userId, gameName);</span><br><span class="line">        </span><br><span class="line">        if (newGame != null) &#123;</span><br><span class="line">            Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span><br><span class="line">            response.put(&quot;success&quot;, true);</span><br><span class="line">            response.put(&quot;gameState&quot;, newGame);</span><br><span class="line">            response.put(&quot;message&quot;, &quot;New game created&quot;);</span><br><span class="line">            return ResponseEntity.ok(response);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span><br><span class="line">            response.put(&quot;success&quot;, false);</span><br><span class="line">            response.put(&quot;message&quot;, &quot;User not found&quot;);</span><br><span class="line">            return ResponseEntity.badRequest().body(response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @DeleteMapping(&quot;/delete/&#123;id&#125;&quot;)</span><br><span class="line">    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; deleteGame(</span><br><span class="line">            @PathVariable Long id,</span><br><span class="line">            @RequestParam Long userId) &#123;</span><br><span class="line">        </span><br><span class="line">        boolean deleted = gameStateService.deleteGameState(id, userId);</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span><br><span class="line">        if (deleted) &#123;</span><br><span class="line">            response.put(&quot;success&quot;, true);</span><br><span class="line">            response.put(&quot;message&quot;, &quot;Game deleted successfully&quot;);</span><br><span class="line">            return ResponseEntity.ok(response);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            response.put(&quot;success&quot;, false);</span><br><span class="line">            response.put(&quot;message&quot;, &quot;Game not found or access denied&quot;);</span><br><span class="line">            return ResponseEntity.badRequest().body(response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="11-2-添加数据统计和分析"><a href="#11-2-添加数据统计和分析" class="headerlink" title="11.2 添加数据统计和分析"></a>11.2 添加数据统计和分析</h4><p>创建 <code>backend/src/main/java/com/kingdomdefense/service/AnalyticsService.java</code>:</p>
<p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line">package com.kingdomdefense.service;</span><br><span class="line"></span><br><span class="line">import com.kingdomdefense.model.GameScore;</span><br><span class="line">import com.kingdomdefense.repository.GameScoreRepository;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">import java.time.LocalDate;</span><br><span class="line">import java.util.*;</span><br><span class="line">import java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line">@Service</span><br><span class="line">public class AnalyticsService &#123;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private GameScoreRepository gameScoreRepository;</span><br><span class="line">    </span><br><span class="line">    public Map&lt;String, Object&gt; getGameAnalytics(LocalDate startDate, LocalDate endDate) &#123;</span><br><span class="line">        List&lt;GameScore&gt; scores = gameScoreRepository.findByGameDateBetween(</span><br><span class="line">                startDate.atStartOfDay(),</span><br><span class="line">                endDate.atTime(23, 59, 59)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, Object&gt; analytics = new HashMap&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        // 基本统计</span><br><span class="line">        analytics.put(&quot;totalGames&quot;, scores.size());</span><br><span class="line">        analytics.put(&quot;uniquePlayers&quot;, scores.stream()</span><br><span class="line">                .map(score -&gt; score.getUser().getId())</span><br><span class="line">                .distinct()</span><br><span class="line">                .count());</span><br><span class="line">        </span><br><span class="line">        // 分数统计</span><br><span class="line">        if (!scores.isEmpty()) &#123;</span><br><span class="line">            analytics.put(&quot;averageScore&quot;, scores.stream()</span><br><span class="line">                    .mapToInt(GameScore::getScore)</span><br><span class="line">                    .average()</span><br><span class="line">                    .orElse(0));</span><br><span class="line">            </span><br><span class="line">            analytics.put(&quot;maxScore&quot;, scores.stream()</span><br><span class="line">                    .mapToInt(GameScore::getScore)</span><br><span class="line">                    .max()</span><br><span class="line">                    .orElse(0));</span><br><span class="line">            </span><br><span class="line">            analytics.put(&quot;minScore&quot;, scores.stream()</span><br><span class="line">                    .mapToInt(GameScore::getScore)</span><br><span class="line">                    .min()</span><br><span class="line">                    .orElse(0));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 波次统计</span><br><span class="line">        analytics.put(&quot;averageWave&quot;, scores.stream()</span><br><span class="line">                .mapToInt(GameScore::getWaveReached)</span><br><span class="line">                .average()</span><br><span class="line">                .orElse(0));</span><br><span class="line">        </span><br><span class="line">        // 塔建造统计</span><br><span class="line">        analytics.put(&quot;averageTowers&quot;, scores.stream()</span><br><span class="line">                .mapToInt(GameScore::getTowersBuilt)</span><br><span class="line">                .average()</span><br><span class="line">                .orElse(0));</span><br><span class="line">        </span><br><span class="line">        // 每日活跃度</span><br><span class="line">        Map&lt;LocalDate, Long&gt; dailyActivity = scores.stream()</span><br><span class="line">                .collect(Collectors.groupingBy(</span><br><span class="line">                        score -&gt; score.getGameDate().toLocalDate(),</span><br><span class="line">                        Collectors.counting()</span><br><span class="line">                ));</span><br><span class="line">        analytics.put(&quot;dailyActivity&quot;, dailyActivity);</span><br><span class="line">        </span><br><span class="line">        // 玩家排行榜</span><br><span class="line">        Map&lt;String, Integer&gt; playerScores = scores.stream()</span><br><span class="line">                .collect(Collectors.groupingBy(</span><br><span class="line">                        score -&gt; score.getUser().getUsername(),</span><br><span class="line">                        Collectors.summingInt(GameScore::getScore)</span><br><span class="line">                ));</span><br><span class="line">        </span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; playerRanking = playerScores.entrySet().stream()</span><br><span class="line">                .sorted(Map.Entry.&lt;String, Integer&gt;comparingByValue().reversed())</span><br><span class="line">                .limit(10)</span><br><span class="line">                .map(entry -&gt; &#123;</span><br><span class="line">                    Map&lt;String, Object&gt; player = new HashMap&lt;&gt;();</span><br><span class="line">                    player.put(&quot;username&quot;, entry.getKey());</span><br><span class="line">                    player.put(&quot;totalScore&quot;, entry.getValue());</span><br><span class="line">                    return player;</span><br><span class="line">                &#125;)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        </span><br><span class="line">        analytics.put(&quot;playerRanking&quot;, playerRanking);</span><br><span class="line">        </span><br><span class="line">        return analytics;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public Map&lt;String, Object&gt; getPlayerAnalytics(Long userId) &#123;</span><br><span class="line">        List&lt;GameScore&gt; playerScores = gameScoreRepository.findByUserId(userId);</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, Object&gt; analytics = new HashMap&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        if (!playerScores.isEmpty()) &#123;</span><br><span class="line">            // 玩家统计</span><br><span class="line">            analytics.put(&quot;totalGames&quot;, playerScores.size());</span><br><span class="line">            analytics.put(&quot;totalScore&quot;, playerScores.stream()</span><br><span class="line">                    .mapToInt(GameScore::getScore)</span><br><span class="line">                    .sum());</span><br><span class="line">            </span><br><span class="line">            analytics.put(&quot;averageScore&quot;, playerScores.stream()</span><br><span class="line">                    .mapToInt(GameScore::getScore)</span><br><span class="line">                    .average()</span><br><span class="line">                    .orElse(0));</span><br><span class="line">            </span><br><span class="line">            analytics.put(&quot;highScore&quot;, playerScores.stream()</span><br><span class="line">                    .mapToInt(GameScore::getScore)</span><br><span class="line">                    .max()</span><br><span class="line">                    .orElse(0));</span><br><span class="line">            </span><br><span class="line">            analytics.put(&quot;averageWave&quot;, playerScores.stream()</span><br><span class="line">                    .mapToInt(GameScore::getWaveReached)</span><br><span class="line">                    .average()</span><br><span class="line">                    .orElse(0));</span><br><span class="line">            </span><br><span class="line">            analytics.put(&quot;bestWave&quot;, playerScores.stream()</span><br><span class="line">                    .mapToInt(GameScore::getWaveReached)</span><br><span class="line">                    .max()</span><br><span class="line">                    .orElse(0));</span><br><span class="line">            </span><br><span class="line">            // 进步趋势</span><br><span class="line">            List&lt;Map&lt;String, Object&gt;&gt; progress = playerScores.stream()</span><br><span class="line">                    .sorted(Comparator.comparing(GameScore::getGameDate))</span><br><span class="line">                    .map(score -&gt; &#123;</span><br><span class="line">                        Map&lt;String, Object&gt; game = new HashMap&lt;&gt;();</span><br><span class="line">                        game.put(&quot;date&quot;, score.getGameDate());</span><br><span class="line">                        game.put(&quot;score&quot;, score.getScore());</span><br><span class="line">                        game.put(&quot;wave&quot;, score.getWaveReached());</span><br><span class="line">                        return game;</span><br><span class="line">                    &#125;)</span><br><span class="line">                    .collect(Collectors.toList());</span><br><span class="line">            </span><br><span class="line">            analytics.put(&quot;progress&quot;, progress);</span><br><span class="line">            </span><br><span class="line">            // 游戏风格分析</span><br><span class="line">            analytics.put(&quot;averageTowers&quot;, playerScores.stream()</span><br><span class="line">                    .mapToInt(GameScore::getTowersBuilt)</span><br><span class="line">                    .average()</span><br><span class="line">                    .orElse(0));</span><br><span class="line">            </span><br><span class="line">            analytics.put(&quot;averageEnemiesDefeated&quot;, playerScores.stream()</span><br><span class="line">                    .mapToInt(GameScore::getEnemiesDefeated)</span><br><span class="line">                    .average()</span><br><span class="line">                    .orElse(0));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return analytics;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="第九阶段：完善Python-AI引擎（第10周）"><a href="#第九阶段：完善Python-AI引擎（第10周）" class="headerlink" title="第九阶段：完善Python AI引擎（第10周）"></a>第九阶段：完善Python AI引擎（第10周）</h2><h3 id="步骤12：扩展AI功能"><a href="#步骤12：扩展AI功能" class="headerlink" title="步骤12：扩展AI功能"></a>步骤12：扩展AI功能</h3><h4 id="12-1-添加遗传算法优化塔防布局"><a href="#12-1-添加遗传算法优化塔防布局" class="headerlink" title="12.1 添加遗传算法优化塔防布局"></a>12.1 添加遗传算法优化塔防布局</h4><p>创建 <code>ai-engine/game_ai/genetic_algorithm.py</code>:</p>
<p>python</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br></pre></td><td class="code"><pre><span class="line">import random</span><br><span class="line">import numpy as np</span><br><span class="line">from typing import List, Dict, Tuple</span><br><span class="line">import copy</span><br><span class="line"></span><br><span class="line">class GeneticAlgorithm:</span><br><span class="line">    def __init__(self, population_size=50, generations=100, mutation_rate=0.1):</span><br><span class="line">        self.population_size = population_size</span><br><span class="line">        self.generations = generations</span><br><span class="line">        self.mutation_rate = mutation_rate</span><br><span class="line">        self.population = []</span><br><span class="line">        self.fitness_scores = []</span><br><span class="line">        </span><br><span class="line">    def optimize_tower_layout(self, map_layout: Dict, budget: int, </span><br><span class="line">                              tower_types: List[str], enemy_path: List[Tuple]) -&gt; List[Dict]:</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        使用遗传算法优化塔防布局</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        # 初始化种群</span><br><span class="line">        self._initialize_population(map_layout, budget, tower_types)</span><br><span class="line">        </span><br><span class="line">        # 进化</span><br><span class="line">        for generation in range(self.generations):</span><br><span class="line">            # 评估适应度</span><br><span class="line">            self.fitness_scores = self._evaluate_population(map_layout, enemy_path)</span><br><span class="line">            </span><br><span class="line">            # 选择</span><br><span class="line">            selected = self._selection()</span><br><span class="line">            </span><br><span class="line">            # 交叉</span><br><span class="line">            children = self._crossover(selected, budget, tower_types)</span><br><span class="line">            </span><br><span class="line">            # 变异</span><br><span class="line">            self._mutate(children, map_layout, tower_types)</span><br><span class="line">            </span><br><span class="line">            # 更新种群</span><br><span class="line">            self.population = children</span><br><span class="line">            </span><br><span class="line">            # 打印进度</span><br><span class="line">            if generation % 10 == 0:</span><br><span class="line">                best_fitness = max(self.fitness_scores)</span><br><span class="line">                print(f&quot;Generation &#123;generation&#125;: Best fitness = &#123;best_fitness:.2f&#125;&quot;)</span><br><span class="line">        </span><br><span class="line">        # 返回最佳布局</span><br><span class="line">        best_index = np.argmax(self.fitness_scores)</span><br><span class="line">        return self.population[best_index]</span><br><span class="line">    </span><br><span class="line">    def _initialize_population(self, map_layout: Dict, budget: int, tower_types: List[str]):</span><br><span class="line">        &quot;&quot;&quot;初始化种群&quot;&quot;&quot;</span><br><span class="line">        self.population = []</span><br><span class="line">        </span><br><span class="line">        for _ in range(self.population_size):</span><br><span class="line">            layout = []</span><br><span class="line">            remaining_budget = budget</span><br><span class="line">            </span><br><span class="line">            # 随机放置塔直到预算用完</span><br><span class="line">            while remaining_budget &gt; 0:</span><br><span class="line">                # 随机选择塔类型</span><br><span class="line">                tower_type = random.choice(tower_types)</span><br><span class="line">                tower_cost = self._get_tower_cost(tower_type)</span><br><span class="line">                </span><br><span class="line">                if tower_cost &lt;= remaining_budget:</span><br><span class="line">                    # 随机选择位置</span><br><span class="line">                    x = random.randint(0, map_layout[&#x27;width&#x27;])</span><br><span class="line">                    y = random.randint(0, map_layout[&#x27;height&#x27;])</span><br><span class="line">                    </span><br><span class="line">                    # 检查位置是否有效（不在路径上）</span><br><span class="line">                    if self._is_valid_position(x, y, map_layout, layout):</span><br><span class="line">                        layout.append(&#123;</span><br><span class="line">                            &#x27;type&#x27;: tower_type,</span><br><span class="line">                            &#x27;x&#x27;: x,</span><br><span class="line">                            &#x27;y&#x27;: y,</span><br><span class="line">                            &#x27;level&#x27;: 1</span><br><span class="line">                        &#125;)</span><br><span class="line">                        remaining_budget -= tower_cost</span><br><span class="line">                    else:</span><br><span class="line">                        # 如果位置无效，尝试有限次数后放弃</span><br><span class="line">                        attempts = 0</span><br><span class="line">                        while attempts &lt; 10 and not self._is_valid_position(x, y, map_layout, layout):</span><br><span class="line">                            x = random.randint(0, map_layout[&#x27;width&#x27;])</span><br><span class="line">                            y = random.randint(0, map_layout[&#x27;height&#x27;])</span><br><span class="line">                            attempts += 1</span><br><span class="line">                        </span><br><span class="line">                        if attempts &lt; 10:</span><br><span class="line">                            layout.append(&#123;</span><br><span class="line">                                &#x27;type&#x27;: tower_type,</span><br><span class="line">                                &#x27;x&#x27;: x,</span><br><span class="line">                                &#x27;y&#x27;: y,</span><br><span class="line">                                &#x27;level&#x27;: 1</span><br><span class="line">                            &#125;)</span><br><span class="line">                            remaining_budget -= tower_cost</span><br><span class="line">                else:</span><br><span class="line">                    break</span><br><span class="line">            </span><br><span class="line">            self.population.append(layout)</span><br><span class="line">    </span><br><span class="line">    def _get_tower_cost(self, tower_type: str) -&gt; int:</span><br><span class="line">        &quot;&quot;&quot;获取塔的成本&quot;&quot;&quot;</span><br><span class="line">        costs = &#123;</span><br><span class="line">            &#x27;arrow&#x27;: 50,</span><br><span class="line">            &#x27;cannon&#x27;: 100,</span><br><span class="line">            &#x27;magic&#x27;: 80,</span><br><span class="line">            &#x27;barracks&#x27;: 120</span><br><span class="line">        &#125;</span><br><span class="line">        return costs.get(tower_type, 50)</span><br><span class="line">    </span><br><span class="line">    def _is_valid_position(self, x: int, y: int, map_layout: Dict, existing_towers: List[Dict]) -&gt; bool:</span><br><span class="line">        &quot;&quot;&quot;检查位置是否有效&quot;&quot;&quot;</span><br><span class="line">        # 检查是否在边界内</span><br><span class="line">        if x &lt; 0 or x &gt; map_layout[&#x27;width&#x27;] or y &lt; 0 or y &gt; map_layout[&#x27;height&#x27;]:</span><br><span class="line">            return False</span><br><span class="line">        </span><br><span class="line">        # 检查是否在路径上（简化检查）</span><br><span class="line">        path_points = map_layout.get(&#x27;path&#x27;, [])</span><br><span class="line">        for point in path_points:</span><br><span class="line">            distance = np.sqrt((point[&#x27;x&#x27;] - x)**2 + (point[&#x27;y&#x27;] - y)**2)</span><br><span class="line">            if distance &lt; 50:  # 最小距离</span><br><span class="line">                return False</span><br><span class="line">        </span><br><span class="line">        # 检查是否与其他塔太近</span><br><span class="line">        for tower in existing_towers:</span><br><span class="line">            distance = np.sqrt((tower[&#x27;x&#x27;] - x)**2 + (tower[&#x27;y&#x27;] - y)**2)</span><br><span class="line">            if distance &lt; 40:  # 塔之间的最小距离</span><br><span class="line">                return False</span><br><span class="line">        </span><br><span class="line">        return True</span><br><span class="line">    </span><br><span class="line">    def _evaluate_population(self, map_layout: Dict, enemy_path: List[Tuple]) -&gt; List[float]:</span><br><span class="line">        &quot;&quot;&quot;评估种群的适应度&quot;&quot;&quot;</span><br><span class="line">        fitness_scores = []</span><br><span class="line">        </span><br><span class="line">        for layout in self.population:</span><br><span class="line">            # 模拟布局效果</span><br><span class="line">            score = self._simulate_layout(layout, map_layout, enemy_path)</span><br><span class="line">            fitness_scores.append(score)</span><br><span class="line">        </span><br><span class="line">        return fitness_scores</span><br><span class="line">    </span><br><span class="line">    def _simulate_layout(self, layout: List[Dict], map_layout: Dict, enemy_path: List[Tuple]) -&gt; float:</span><br><span class="line">        &quot;&quot;&quot;模拟塔防布局的效果&quot;&quot;&quot;</span><br><span class="line">        if not layout:</span><br><span class="line">            return 0.0</span><br><span class="line">        </span><br><span class="line">        total_score = 0.0</span><br><span class="line">        </span><br><span class="line">        # 评估覆盖范围</span><br><span class="line">        coverage_score = self._calculate_coverage(layout, enemy_path)</span><br><span class="line">        total_score += coverage_score * 0.4</span><br><span class="line">        </span><br><span class="line">        # 评估多样性</span><br><span class="line">        diversity_score = self._calculate_diversity(layout)</span><br><span class="line">        total_score += diversity_score * 0.2</span><br><span class="line">        </span><br><span class="line">        # 评估协同作用</span><br><span class="line">        synergy_score = self._calculate_synergy(layout)</span><br><span class="line">        total_score += synergy_score * 0.3</span><br><span class="line">        </span><br><span class="line">        # 评估资源效率</span><br><span class="line">        efficiency_score = self._calculate_efficiency(layout)</span><br><span class="line">        total_score += efficiency_score * 0.1</span><br><span class="line">        </span><br><span class="line">        return total_score</span><br><span class="line">    </span><br><span class="line">    def _calculate_coverage(self, layout: List[Dict], enemy_path: List[Tuple]) -&gt; float:</span><br><span class="line">        &quot;&quot;&quot;计算塔对路径的覆盖范围&quot;&quot;&quot;</span><br><span class="line">        if not enemy_path:</span><br><span class="line">            return 0.0</span><br><span class="line">        </span><br><span class="line">        covered_points = 0</span><br><span class="line">        total_points = len(enemy_path)</span><br><span class="line">        </span><br><span class="line">        for point in enemy_path:</span><br><span class="line">            for tower in layout:</span><br><span class="line">                distance = np.sqrt((tower[&#x27;x&#x27;] - point[0])**2 + (tower[&#x27;y&#x27;] - point[1])**2)</span><br><span class="line">                tower_range = self._get_tower_range(tower[&#x27;type&#x27;])</span><br><span class="line">                </span><br><span class="line">                if distance &lt;= tower_range:</span><br><span class="line">                    covered_points += 1</span><br><span class="line">                    break</span><br><span class="line">        </span><br><span class="line">        return covered_points / total_points</span><br><span class="line">    </span><br><span class="line">    def _get_tower_range(self, tower_type: str) -&gt; float:</span><br><span class="line">        &quot;&quot;&quot;获取塔的攻击范围&quot;&quot;&quot;</span><br><span class="line">        ranges = &#123;</span><br><span class="line">            &#x27;arrow&#x27;: 200,</span><br><span class="line">            &#x27;cannon&#x27;: 180,</span><br><span class="line">            &#x27;magic&#x27;: 220,</span><br><span class="line">            &#x27;barracks&#x27;: 0</span><br><span class="line">        &#125;</span><br><span class="line">        return ranges.get(tower_type, 150)</span><br><span class="line">    </span><br><span class="line">    def _calculate_diversity(self, layout: List[Dict]) -&gt; float:</span><br><span class="line">        &quot;&quot;&quot;计算塔类型的多样性&quot;&quot;&quot;</span><br><span class="line">        if not layout:</span><br><span class="line">            return 0.0</span><br><span class="line">        </span><br><span class="line">        type_counts = &#123;&#125;</span><br><span class="line">        for tower in layout:</span><br><span class="line">            tower_type = tower[&#x27;type&#x27;]</span><br><span class="line">            type_counts[tower_type] = type_counts.get(tower_type, 0) + 1</span><br><span class="line">        </span><br><span class="line">        # 计算香农多样性指数</span><br><span class="line">        total_towers = len(layout)</span><br><span class="line">        diversity = 0.0</span><br><span class="line">        </span><br><span class="line">        for count in type_counts.values():</span><br><span class="line">            proportion = count / total_towers</span><br><span class="line">            if proportion &gt; 0:</span><br><span class="line">                diversity -= proportion * np.log(proportion)</span><br><span class="line">        </span><br><span class="line">        # 归一化到0-1范围</span><br><span class="line">        max_diversity = np.log(len(type_counts)) if type_counts else 1</span><br><span class="line">        return diversity / max_diversity if max_diversity &gt; 0 else 0</span><br><span class="line">    </span><br><span class="line">    def _calculate_synergy(self, layout: List[Dict]) -&gt; float:</span><br><span class="line">        &quot;&quot;&quot;计算塔之间的协同作用&quot;&quot;&quot;</span><br><span class="line">        if len(layout) &lt; 2:</span><br><span class="line">            return 0.0</span><br><span class="line">        </span><br><span class="line">        synergy_score = 0.0</span><br><span class="line">        pairs = 0</span><br><span class="line">        </span><br><span class="line">        for i in range(len(layout)):</span><br><span class="line">            for j in range(i + 1, len(layout)):</span><br><span class="line">                tower1 = layout[i]</span><br><span class="line">                tower2 = layout[j]</span><br><span class="line">                </span><br><span class="line">                # 计算距离</span><br><span class="line">                distance = np.sqrt((tower1[&#x27;x&#x27;] - tower2[&#x27;x&#x27;])**2 + </span><br><span class="line">                                  (tower1[&#x27;y&#x27;] - tower2[&#x27;y&#x27;])**2)</span><br><span class="line">                </span><br><span class="line">                # 理想的距离是攻击范围的一半到三分之二</span><br><span class="line">                ideal_distance = (self._get_tower_range(tower1[&#x27;type&#x27;]) + </span><br><span class="line">                                 self._get_tower_range(tower2[&#x27;type&#x27;])) / 4</span><br><span class="line">                </span><br><span class="line">                # 距离越接近理想值，协同作用越好</span><br><span class="line">                distance_score = 1.0 / (1.0 + abs(distance - ideal_distance) / 50)</span><br><span class="line">                </span><br><span class="line">                # 类型协同</span><br><span class="line">                type_synergy = self._get_type_synergy(tower1[&#x27;type&#x27;], tower2[&#x27;type&#x27;])</span><br><span class="line">                </span><br><span class="line">                synergy_score += distance_score * type_synergy</span><br><span class="line">                pairs += 1</span><br><span class="line">        </span><br><span class="line">        return synergy_score / pairs if pairs &gt; 0 else 0</span><br><span class="line">    </span><br><span class="line">    def _get_type_synergy(self, type1: str, type2: str) -&gt; float:</span><br><span class="line">        &quot;&quot;&quot;获取两种塔类型之间的协同系数&quot;&quot;&quot;</span><br><span class="line">        synergy_matrix = &#123;</span><br><span class="line">            (&#x27;arrow&#x27;, &#x27;arrow&#x27;): 0.8,</span><br><span class="line">            (&#x27;arrow&#x27;, &#x27;cannon&#x27;): 1.2,</span><br><span class="line">            (&#x27;arrow&#x27;, &#x27;magic&#x27;): 1.5,</span><br><span class="line">            (&#x27;arrow&#x27;, &#x27;barracks&#x27;): 1.3,</span><br><span class="line">            (&#x27;cannon&#x27;, &#x27;cannon&#x27;): 0.7,</span><br><span class="line">            (&#x27;cannon&#x27;, &#x27;magic&#x27;): 1.1,</span><br><span class="line">            (&#x27;cannon&#x27;, &#x27;barracks&#x27;): 1.4,</span><br><span class="line">            (&#x27;magic&#x27;, &#x27;magic&#x27;): 0.9,</span><br><span class="line">            (&#x27;magic&#x27;, &#x27;barracks&#x27;): 1.6,</span><br><span class="line">            (&#x27;barracks&#x27;, &#x27;barracks&#x27;): 0.6</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        key = tuple(sorted([type1, type2]))</span><br><span class="line">        return synergy_matrix.get(key, 1.0)</span><br><span class="line">    </span><br><span class="line">    def _calculate_efficiency(self, layout: List[Dict]) -&gt; float:</span><br><span class="line">        &quot;&quot;&quot;计算资源使用效率&quot;&quot;&quot;</span><br><span class="line">        total_cost = sum(self._get_tower_cost(tower[&#x27;type&#x27;]) for tower in layout)</span><br><span class="line">        total_towers = len(layout)</span><br><span class="line">        </span><br><span class="line">        # 理想情况是每个塔的平均成本适中</span><br><span class="line">        avg_cost = total_cost / total_towers if total_towers &gt; 0 else 0</span><br><span class="line">        ideal_avg_cost = 80  # 理想平均成本</span><br><span class="line">        </span><br><span class="line">        efficiency = 1.0 / (1.0 + abs(avg_cost - ideal_avg_cost) / 20)</span><br><span class="line">        return efficiency</span><br><span class="line">    </span><br><span class="line">    def _selection(self) -&gt; List[List[Dict]]:</span><br><span class="line">        &quot;&quot;&quot;选择操作（轮盘赌选择）&quot;&quot;&quot;</span><br><span class="line">        total_fitness = sum(self.fitness_scores)</span><br><span class="line">        if total_fitness == 0:</span><br><span class="line">            return random.sample(self.population, len(self.population) // 2)</span><br><span class="line">        </span><br><span class="line">        probabilities = [score / total_fitness for score in self.fitness_scores]</span><br><span class="line">        selected_indices = np.random.choice(</span><br><span class="line">            len(self.population),</span><br><span class="line">            size=len(self.population) // 2,</span><br><span class="line">            p=probabilities,</span><br><span class="line">            replace=True</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        return [self.population[i] for i in selected_indices]</span><br><span class="line">    </span><br><span class="line">    def _crossover(self, selected: List[List[Dict]], budget: int, tower_types: List[str]) -&gt; List[List[Dict]]:</span><br><span class="line">        &quot;&quot;&quot;交叉操作&quot;&quot;&quot;</span><br><span class="line">        children = []</span><br><span class="line">        </span><br><span class="line">        while len(children) &lt; self.population_size:</span><br><span class="line">            if len(selected) &lt; 2:</span><br><span class="line">                parents = random.sample(self.population, 2)</span><br><span class="line">            else:</span><br><span class="line">                parents = random.sample(selected, 2)</span><br><span class="line">            </span><br><span class="line">            # 单点交叉</span><br><span class="line">            crossover_point = random.randint(1, min(len(parents[0]), len(parents[1])) - 1)</span><br><span class="line">            </span><br><span class="line">            child1 = parents[0][:crossover_point] + parents[1][crossover_point:]</span><br><span class="line">            child2 = parents[1][:crossover_point] + parents[0][crossover_point:]</span><br><span class="line">            </span><br><span class="line">            # 修复预算约束</span><br><span class="line">            child1 = self._repair_layout(child1, budget, tower_types)</span><br><span class="line">            child2 = self._repair_layout(child2, budget, tower_types)</span><br><span class="line">            </span><br><span class="line">            children.append(child1)</span><br><span class="line">            children.append(child2)</span><br><span class="line">        </span><br><span class="line">        return children[:self.population_size]</span><br><span class="line">    </span><br><span class="line">    def _repair_layout(self, layout: List[Dict], budget: int, tower_types: List[str]) -&gt; List[Dict]:</span><br><span class="line">        &quot;&quot;&quot;修复布局以满足预算约束&quot;&quot;&quot;</span><br><span class="line">        total_cost = sum(self._get_tower_cost(tower[&#x27;type&#x27;]) for tower in layout)</span><br><span class="line">        </span><br><span class="line">        # 如果超出预算，移除最贵的塔</span><br><span class="line">        while total_cost &gt; budget and layout:</span><br><span class="line">            # 找到最贵的塔</span><br><span class="line">            most_expensive_index = max(</span><br><span class="line">                range(len(layout)),</span><br><span class="line">                key=lambda i: self._get_tower_cost(layout[i][&#x27;type&#x27;])</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            total_cost -= self._get_tower_cost(layout[most_expensive_index][&#x27;type&#x27;])</span><br><span class="line">            layout.pop(most_expensive_index)</span><br><span class="line">        </span><br><span class="line">        return layout</span><br><span class="line">    </span><br><span class="line">    def _mutate(self, population: List[List[Dict]], map_layout: Dict, tower_types: List[str]):</span><br><span class="line">        &quot;&quot;&quot;变异操作&quot;&quot;&quot;</span><br><span class="line">        for i in range(len(population)):</span><br><span class="line">            if random.random() &lt; self.mutation_rate:</span><br><span class="line">                layout = population[i]</span><br><span class="line">                </span><br><span class="line">                if layout:</span><br><span class="line">                    # 随机选择一个塔进行变异</span><br><span class="line">                    mutate_index = random.randint(0, len(layout) - 1)</span><br><span class="line">                    tower = layout[mutate_index]</span><br><span class="line">                    </span><br><span class="line">                    mutation_type = random.choice([&#x27;position&#x27;, &#x27;type&#x27;, &#x27;add&#x27;, &#x27;remove&#x27;])</span><br><span class="line">                    </span><br><span class="line">                    if mutation_type == &#x27;position&#x27;:</span><br><span class="line">                        # 改变位置</span><br><span class="line">                        new_x = tower[&#x27;x&#x27;] + random.randint(-20, 20)</span><br><span class="line">                        new_y = tower[&#x27;y&#x27;] + random.randint(-20, 20)</span><br><span class="line">                        </span><br><span class="line">                        if self._is_valid_position(new_x, new_y, map_layout, </span><br><span class="line">                                                  layout[:mutate_index] + layout[mutate_index+1:]):</span><br><span class="line">                            tower[&#x27;x&#x27;] = new_x</span><br><span class="line">                            tower[&#x27;y&#x27;] = new_y</span><br><span class="line">                    </span><br><span class="line">                    elif mutation_type == &#x27;type&#x27;:</span><br><span class="line">                        # 改变类型</span><br><span class="line">                        new_type = random.choice(tower_types)</span><br><span class="line">                        if new_type != tower[&#x27;type&#x27;]:</span><br><span class="line">                            tower[&#x27;type&#x27;] = new_type</span><br><span class="line">                    </span><br><span class="line">                    elif mutation_type == &#x27;add&#x27; and len(layout) &lt; 10:</span><br><span class="line">                        # 添加新塔</span><br><span class="line">                        new_tower_type = random.choice(tower_types)</span><br><span class="line">                        new_x = random.randint(0, map_layout[&#x27;width&#x27;])</span><br><span class="line">                        new_y = random.randint(0, map_layout[&#x27;height&#x27;])</span><br><span class="line">                        </span><br><span class="line">                        if self._is_valid_position(new_x, new_y, map_layout, layout):</span><br><span class="line">                            layout.append(&#123;</span><br><span class="line">                                &#x27;type&#x27;: new_tower_type,</span><br><span class="line">                                &#x27;x&#x27;: new_x,</span><br><span class="line">                                &#x27;y&#x27;: new_y,</span><br><span class="line">                                &#x27;level&#x27;: 1</span><br><span class="line">                            &#125;)</span><br><span class="line">                    </span><br><span class="line">                    elif mutation_type == &#x27;remove&#x27; and len(layout) &gt; 1:</span><br><span class="line">                        # 移除塔</span><br><span class="line">                        layout.pop(mutate_index)</span><br></pre></td></tr></table></figure>



<h2 id="第十阶段：扩展C核心引擎（第11周）"><a href="#第十阶段：扩展C核心引擎（第11周）" class="headerlink" title="第十阶段：扩展C核心引擎（第11周）"></a>第十阶段：扩展C核心引擎（第11周）</h2><h3 id="步骤13：优化碰撞检测和物理引擎"><a href="#步骤13：优化碰撞检测和物理引擎" class="headerlink" title="步骤13：优化碰撞检测和物理引擎"></a>步骤13：优化碰撞检测和物理引擎</h3><p>创建 <code>engine-core/src/physics/collision_detection.c</code>:</p>
<p>c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;math.h&gt;</span><br><span class="line">#include &quot;collision_detection.h&quot;</span><br><span class="line"></span><br><span class="line">// 圆形碰撞检测</span><br><span class="line">int circle_collision(float x1, float y1, float r1, </span><br><span class="line">                     float x2, float y2, float r2) &#123;</span><br><span class="line">    float dx = x1 - x2;</span><br><span class="line">    float dy = y1 - y2;</span><br><span class="line">    float distance = sqrtf(dx * dx + dy * dy);</span><br><span class="line">    </span><br><span class="line">    return distance &lt;= (r1 + r2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 矩形碰撞检测</span><br><span class="line">int rect_collision(float x1, float y1, float w1, float h1,</span><br><span class="line">                   float x2, float y2, float w2, float h2) &#123;</span><br><span class="line">    return (x1 &lt; x2 + w2 &amp;&amp;</span><br><span class="line">            x1 + w1 &gt; x2 &amp;&amp;</span><br><span class="line">            y1 &lt; y2 + h2 &amp;&amp;</span><br><span class="line">            y1 + h1 &gt; y2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 圆形与矩形碰撞检测</span><br><span class="line">int circle_rect_collision(float cx, float cy, float radius,</span><br><span class="line">                          float rx, float ry, float rw, float rh) &#123;</span><br><span class="line">    // 找到矩形上距离圆心最近的点</span><br><span class="line">    float closestX = fmaxf(rx, fminf(cx, rx + rw));</span><br><span class="line">    float closestY = fmaxf(ry, fminf(cy, ry + rh));</span><br><span class="line">    </span><br><span class="line">    // 计算圆心到这个点的距离</span><br><span class="line">    float distanceX = cx - closestX;</span><br><span class="line">    float distanceY = cy - closestY;</span><br><span class="line">    </span><br><span class="line">    // 如果距离小于半径，则发生碰撞</span><br><span class="line">    return (distanceX * distanceX + distanceY * distanceY) &lt;= (radius * radius);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 点与多边形碰撞检测（使用射线法）</span><br><span class="line">int point_polygon_collision(float px, float py, float* vertices, int vertexCount) &#123;</span><br><span class="line">    if (vertexCount &lt; 3) return 0;</span><br><span class="line">    </span><br><span class="line">    int inside = 0;</span><br><span class="line">    </span><br><span class="line">    for (int i = 0, j = vertexCount - 1; i &lt; vertexCount; j = i++) &#123;</span><br><span class="line">        float vi_x = vertices[i * 2];</span><br><span class="line">        float vi_y = vertices[i * 2 + 1];</span><br><span class="line">        float vj_x = vertices[j * 2];</span><br><span class="line">        float vj_y = vertices[j * 2 + 1];</span><br><span class="line">        </span><br><span class="line">        if (((vi_y &gt; py) != (vj_y &gt; py)) &amp;&amp;</span><br><span class="line">            (px &lt; (vj_x - vi_x) * (py - vi_y) / (vj_y - vi_y) + vi_x)) &#123;</span><br><span class="line">            inside = !inside;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return inside;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 计算两个圆形的碰撞响应</span><br><span class="line">void circle_collision_response(float* x1, float* y1, float* vx1, float* vy1, float m1, float r1,</span><br><span class="line">                               float* x2, float* y2, float* vx2, float* vy2, float m2, float r2,</span><br><span class="line">                               float elasticity) &#123;</span><br><span class="line">    // 计算碰撞法向量</span><br><span class="line">    float dx = *x2 - *x1;</span><br><span class="line">    float dy = *y2 - *y1;</span><br><span class="line">    float distance = sqrtf(dx * dx + dy * dy);</span><br><span class="line">    </span><br><span class="line">    if (distance == 0) return;</span><br><span class="line">    </span><br><span class="line">    float nx = dx / distance;</span><br><span class="line">    float ny = dy / distance;</span><br><span class="line">    </span><br><span class="line">    // 计算相对速度</span><br><span class="line">    float dvx = *vx2 - *vx1;</span><br><span class="line">    float dvy = *vy2 - *vy1;</span><br><span class="line">    </span><br><span class="line">    // 计算法向速度</span><br><span class="line">    float dvn = dvx * nx + dvy * ny;</span><br><span class="line">    </span><br><span class="line">    // 如果物体正在分离，不做处理</span><br><span class="line">    if (dvn &gt; 0) return;</span><br><span class="line">    </span><br><span class="line">    // 计算冲量</span><br><span class="line">    float impulse = -(1 + elasticity) * dvn;</span><br><span class="line">    impulse /= (1/m1 + 1/m2);</span><br><span class="line">    </span><br><span class="line">    // 应用冲量</span><br><span class="line">    *vx1 -= impulse * nx / m1;</span><br><span class="line">    *vy1 -= impulse * ny / m1;</span><br><span class="line">    *vx2 += impulse * nx / m2;</span><br><span class="line">    *vy2 += impulse * ny / m2;</span><br><span class="line">    </span><br><span class="line">    // 分离物体防止穿透</span><br><span class="line">    float overlap = r1 + r2 - distance;</span><br><span class="line">    if (overlap &gt; 0) &#123;</span><br><span class="line">        float totalMass = m1 + m2;</span><br><span class="line">        *x1 -= overlap * nx * (m2 / totalMass);</span><br><span class="line">        *y1 -= overlap * ny * (m2 / totalMass);</span><br><span class="line">        *x2 += overlap * nx * (m1 / totalMass);</span><br><span class="line">        *y2 += overlap * ny * (m1 / totalMass);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 空间划分网格（用于优化碰撞检测）</span><br><span class="line">typedef struct SpatialGrid &#123;</span><br><span class="line">    int cellSize;</span><br><span class="line">    int width, height;</span><br><span class="line">    int rows, cols;</span><br><span class="line">    int*** cells; // 三维数组：cell[row][col][object_index]</span><br><span class="line">    int* cellCounts; // 每个单元格中的对象数量</span><br><span class="line">&#125; SpatialGrid;</span><br><span class="line"></span><br><span class="line">SpatialGrid* create_spatial_grid(int width, int height, int cellSize) &#123;</span><br><span class="line">    SpatialGrid* grid = (SpatialGrid*)malloc(sizeof(SpatialGrid));</span><br><span class="line">    grid-&gt;cellSize = cellSize;</span><br><span class="line">    grid-&gt;width = width;</span><br><span class="line">    grid-&gt;height = height;</span><br><span class="line">    grid-&gt;cols = (width + cellSize - 1) / cellSize;</span><br><span class="line">    grid-&gt;rows = (height + cellSize - 1) / cellSize;</span><br><span class="line">    </span><br><span class="line">    // 分配单元格数组</span><br><span class="line">    grid-&gt;cells = (int***)malloc(grid-&gt;rows * sizeof(int**));</span><br><span class="line">    grid-&gt;cellCounts = (int*)calloc(grid-&gt;rows * grid-&gt;cols, sizeof(int));</span><br><span class="line">    </span><br><span class="line">    for (int r = 0; r &lt; grid-&gt;rows; r++) &#123;</span><br><span class="line">        grid-&gt;cells[r] = (int**)malloc(grid-&gt;cols * sizeof(int*));</span><br><span class="line">        for (int c = 0; c &lt; grid-&gt;cols; c++) &#123;</span><br><span class="line">            grid-&gt;cells[r][c] = (int*)malloc(100 * sizeof(int)); // 每个单元格最多100个对象</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return grid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void free_spatial_grid(SpatialGrid* grid) &#123;</span><br><span class="line">    for (int r = 0; r &lt; grid-&gt;rows; r++) &#123;</span><br><span class="line">        for (int c = 0; c &lt; grid-&gt;cols; c++) &#123;</span><br><span class="line">            free(grid-&gt;cells[r][c]);</span><br><span class="line">        &#125;</span><br><span class="line">        free(grid-&gt;cells[r]);</span><br><span class="line">    &#125;</span><br><span class="line">    free(grid-&gt;cells);</span><br><span class="line">    free(grid-&gt;cellCounts);</span><br><span class="line">    free(grid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void spatial_grid_clear(SpatialGrid* grid) &#123;</span><br><span class="line">    for (int r = 0; r &lt; grid-&gt;rows; r++) &#123;</span><br><span class="line">        for (int c = 0; c &lt; grid-&gt;cols; c++) &#123;</span><br><span class="line">            grid-&gt;cellCounts[r * grid-&gt;cols + c] = 0;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void spatial_grid_add(SpatialGrid* grid, int id, float x, float y, float radius) &#123;</span><br><span class="line">    // 计算对象覆盖的单元格范围</span><br><span class="line">    int minCol = fmax(0, (int)((x - radius) / grid-&gt;cellSize));</span><br><span class="line">    int maxCol = fmin(grid-&gt;cols - 1, (int)((x + radius) / grid-&gt;cellSize));</span><br><span class="line">    int minRow = fmax(0, (int)((y - radius) / grid-&gt;cellSize));</span><br><span class="line">    int maxRow = fmin(grid-&gt;rows - 1, (int)((y + radius) / grid-&gt;cellSize));</span><br><span class="line">    </span><br><span class="line">    // 将对象添加到所有覆盖的单元格</span><br><span class="line">    for (int r = minRow; r &lt;= maxRow; r++) &#123;</span><br><span class="line">        for (int c = minCol; c &lt;= maxCol; c++) &#123;</span><br><span class="line">            int index = r * grid-&gt;cols + c;</span><br><span class="line">            int count = grid-&gt;cellCounts[index];</span><br><span class="line">            </span><br><span class="line">            if (count &lt; 100) &#123;</span><br><span class="line">                grid-&gt;cells[r][c][count] = id;</span><br><span class="line">                grid-&gt;cellCounts[index] = count + 1;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 使用空间网格优化碰撞检测</span><br><span class="line">int spatial_grid_check_collisions(SpatialGrid* grid, float* positions, float* radii, int objectCount,</span><br><span class="line">                                  int* collisions, int maxCollisions) &#123;</span><br><span class="line">    int collisionCount = 0;</span><br><span class="line">    </span><br><span class="line">    for (int r = 0; r &lt; grid-&gt;rows; r++) &#123;</span><br><span class="line">        for (int c = 0; c &lt; grid-&gt;cols; c++) &#123;</span><br><span class="line">            int cellIndex = r * grid-&gt;cols + c;</span><br><span class="line">            int count = grid-&gt;cellCounts[cellIndex];</span><br><span class="line">            </span><br><span class="line">            // 检查当前单元格内的所有对象对</span><br><span class="line">            for (int i = 0; i &lt; count &amp;&amp; collisionCount &lt; maxCollisions; i++) &#123;</span><br><span class="line">                int id1 = grid-&gt;cells[r][c][i];</span><br><span class="line">                </span><br><span class="line">                for (int j = i + 1; j &lt; count &amp;&amp; collisionCount &lt; maxCollisions; j++) &#123;</span><br><span class="line">                    int id2 = grid-&gt;cells[r][c][j];</span><br><span class="line">                    </span><br><span class="line">                    // 检查碰撞</span><br><span class="line">                    float x1 = positions[id1 * 2];</span><br><span class="line">                    float y1 = positions[id1 * 2 + 1];</span><br><span class="line">                    float r1 = radii[id1];</span><br><span class="line">                    </span><br><span class="line">                    float x2 = positions[id2 * 2];</span><br><span class="line">                    float y2 = positions[id2 * 2 + 1];</span><br><span class="line">                    float r2 = radii[id2];</span><br><span class="line">                    </span><br><span class="line">                    if (circle_collision(x1, y1, r1, x2, y2, r2)) &#123;</span><br><span class="line">                        collisions[collisionCount * 2] = id1;</span><br><span class="line">                        collisions[collisionCount * 2 + 1] = id2;</span><br><span class="line">                        collisionCount++;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return collisionCount;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 测试函数</span><br><span class="line">void test_collision_detection() &#123;</span><br><span class="line">    printf(&quot;Testing collision detection...\n&quot;);</span><br><span class="line">    </span><br><span class="line">    // 测试圆形碰撞</span><br><span class="line">    int circleCollision = circle_collision(0, 0, 5, 8, 0, 5);</span><br><span class="line">    printf(&quot;Circle collision: %s\n&quot;, circleCollision ? &quot;YES&quot; : &quot;NO&quot;);</span><br><span class="line">    </span><br><span class="line">    // 测试矩形碰撞</span><br><span class="line">    int rectCollision = rect_collision(0, 0, 10, 10, 5, 5, 10, 10);</span><br><span class="line">    printf(&quot;Rectangle collision: %s\n&quot;, rectCollision ? &quot;YES&quot; : &quot;NO&quot;);</span><br><span class="line">    </span><br><span class="line">    // 测试圆形与矩形碰撞</span><br><span class="line">    int circleRectCollision = circle_rect_collision(5, 5, 5, 10, 10, 10, 10);</span><br><span class="line">    printf(&quot;Circle-Rectangle collision: %s\n&quot;, circleRectCollision ? &quot;YES&quot; : &quot;NO&quot;);</span><br><span class="line">    </span><br><span class="line">    // 测试空间网格</span><br><span class="line">    SpatialGrid* grid = create_spatial_grid(100, 100, 20);</span><br><span class="line">    </span><br><span class="line">    // 添加一些测试对象</span><br><span class="line">    float positions[] = &#123;10, 10, 30, 30, 15, 15&#125;;</span><br><span class="line">    float radii[] = &#123;5, 5, 8&#125;;</span><br><span class="line">    </span><br><span class="line">    spatial_grid_clear(grid);</span><br><span class="line">    for (int i = 0; i &lt; 3; i++) &#123;</span><br><span class="line">        spatial_grid_add(grid, i, positions[i*2], positions[i*2+1], radii[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    int collisions[100];</span><br><span class="line">    int collisionCount = spatial_grid_check_collisions(grid, positions, radii, 3, collisions, 100);</span><br><span class="line">    </span><br><span class="line">    printf(&quot;Found %d collisions using spatial grid\n&quot;, collisionCount);</span><br><span class="line">    </span><br><span class="line">    free_spatial_grid(grid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这个扩展版本添加了以下重要功能：</p>
<h3 id="前端扩展："><a href="#前端扩展：" class="headerlink" title="前端扩展："></a>前端扩展：</h3><ol>
<li><strong>更多塔类型</strong>：添加了兵营、魔法塔等</li>
<li><strong>士兵系统</strong>：兵营可以生成士兵阻挡敌人</li>
<li><strong>状态效果</strong>：减速、持续伤害等</li>
<li><strong>经验系统</strong>：塔可以通过战斗升级</li>
<li><strong>更多敌人类型</strong>：飞行单位、BOSS等</li>
<li><strong>视觉反馈</strong>：状态效果图标、生命条等</li>
</ol>
<h3 id="后端扩展："><a href="#后端扩展：" class="headerlink" title="后端扩展："></a>后端扩展：</h3><ol>
<li><strong>游戏状态管理</strong>：保存、加载、删除游戏</li>
<li><strong>数据分析</strong>：玩家统计、游戏分析、进度跟踪</li>
<li><strong>REST API扩展</strong>：更多端点支持</li>
</ol>
<h3 id="AI引擎扩展："><a href="#AI引擎扩展：" class="headerlink" title="AI引擎扩展："></a>AI引擎扩展：</h3><ol>
<li><strong>遗传算法</strong>：优化塔防布局</li>
<li><strong>布局评估</strong>：覆盖范围、多样性、协同作用等</li>
<li><strong>进化算法</strong>：选择、交叉、变异操作</li>
</ol>
<h3 id="C核心引擎扩展："><a href="#C核心引擎扩展：" class="headerlink" title="C核心引擎扩展："></a>C核心引擎扩展：</h3><ol>
<li><strong>高效碰撞检测</strong>：支持多种形状</li>
<li><strong>物理响应</strong>：碰撞后的速度变化</li>
<li><strong>空间划分</strong>：使用网格优化碰撞检测</li>
<li><strong>内存管理</strong>：高效的对象存储和检索</li>
</ol>
<p>这些扩展使得游戏更加完整和有趣，同时保持了良好的性能。您可以根据需要继续扩展各个模块，添加更多功能和优化。</p>
<h1 id="王国保卫战-完整扩展与优化"><a href="#王国保卫战-完整扩展与优化" class="headerlink" title="王国保卫战 - 完整扩展与优化"></a>王国保卫战 - 完整扩展与优化</h1><h2 id="第十一阶段：前端UI系统与特效优化（第8周）"><a href="#第十一阶段：前端UI系统与特效优化（第8周）" class="headerlink" title="第十一阶段：前端UI系统与特效优化（第8周）"></a>第十一阶段：前端UI系统与特效优化（第8周）</h2><h3 id="步骤10：扩展UI系统和粒子特效"><a href="#步骤10：扩展UI系统和粒子特效" class="headerlink" title="步骤10：扩展UI系统和粒子特效"></a>步骤10：扩展UI系统和粒子特效</h3><h4 id="10-1-创建增强的UI管理器"><a href="#10-1-创建增强的UI管理器" class="headerlink" title="10.1 创建增强的UI管理器"></a>10.1 创建增强的UI管理器</h4><p>创建 <code>frontend/js/ui/uiManager.js</code>:</p>
<p>javascript</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br></pre></td><td class="code"><pre><span class="line">class UIManager &#123;</span><br><span class="line">    constructor(gameManager) &#123;</span><br><span class="line">        this.gameManager = gameManager;</span><br><span class="line">        this.uiElements = new Map();</span><br><span class="line">        this.activeTooltip = null;</span><br><span class="line">        this.selectedTower = null;</span><br><span class="line">        this.notifications = [];</span><br><span class="line">        this.initUI();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    initUI() &#123;</span><br><span class="line">        // 创建塔选择面板</span><br><span class="line">        this.createTowerSelectionPanel();</span><br><span class="line">        </span><br><span class="line">        // 创建技能面板</span><br><span class="line">        this.createSkillsPanel();</span><br><span class="line">        </span><br><span class="line">        // 创建游戏状态显示</span><br><span class="line">        this.createGameStatusDisplay();</span><br><span class="line">        </span><br><span class="line">        // 创建通知系统</span><br><span class="line">        this.createNotificationSystem();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    createTowerSelectionPanel() &#123;</span><br><span class="line">        const towerTypes = [</span><br><span class="line">            &#123; id: &#x27;arrow&#x27;, name: &#x27;弓箭塔&#x27;, cost: 50, color: &#x27;#4CAF50&#x27;, description: &#x27;快速攻击，对轻甲有效&#x27; &#125;,</span><br><span class="line">            &#123; id: &#x27;cannon&#x27;, name: &#x27;炮塔&#x27;, cost: 100, color: &#x27;#FF5722&#x27;, description: &#x27;范围伤害，攻速慢但威力大&#x27; &#125;,</span><br><span class="line">            &#123; id: &#x27;magic&#x27;, name: &#x27;魔法塔&#x27;, cost: 80, color: &#x27;#9C27B0&#x27;, description: &#x27;魔法攻击，对魔抗低的敌人有效&#x27; &#125;,</span><br><span class="line">            &#123; id: &#x27;barracks&#x27;, name: &#x27;兵营&#x27;, cost: 120, color: &#x27;#795548&#x27;, description: &#x27;生产士兵阻挡敌人&#x27; &#125;,</span><br><span class="line">            &#123; id: &#x27;frost&#x27;, name: &#x27;冰霜塔&#x27;, cost: 90, color: &#x27;#00BCD4&#x27;, description: &#x27;减速敌人，控制效果&#x27; &#125;</span><br><span class="line">        ];</span><br><span class="line">        </span><br><span class="line">        const panel = document.createElement(&#x27;div&#x27;);</span><br><span class="line">        panel.id = &#x27;tower-selection&#x27;;</span><br><span class="line">        panel.className = &#x27;tower-selection-panel&#x27;;</span><br><span class="line">        </span><br><span class="line">        towerTypes.forEach(tower =&gt; &#123;</span><br><span class="line">            const button = document.createElement(&#x27;button&#x27;);</span><br><span class="line">            button.className = &#x27;tower-button&#x27;;</span><br><span class="line">            button.dataset.type = tower.id;</span><br><span class="line">            button.innerHTML = `</span><br><span class="line">                &lt;div class=&quot;tower-icon&quot; style=&quot;background: $&#123;tower.color&#125;&quot;&gt;&lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;tower-info&quot;&gt;</span><br><span class="line">                    &lt;span class=&quot;tower-name&quot;&gt;$&#123;tower.name&#125;&lt;/span&gt;</span><br><span class="line">                    &lt;span class=&quot;tower-cost&quot;&gt;$&#123;tower.cost&#125;G&lt;/span&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            `;</span><br><span class="line">            </span><br><span class="line">            button.addEventListener(&#x27;click&#x27;, () =&gt; &#123;</span><br><span class="line">                if (this.gameManager.gameState.gold &gt;= tower.cost) &#123;</span><br><span class="line">                    this.gameManager.selectedTowerType = tower.id;</span><br><span class="line">                    this.highlightSelectedTower(button);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    this.showNotification(&#x27;金币不足！&#x27;, &#x27;error&#x27;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            // 添加鼠标悬停提示</span><br><span class="line">            button.addEventListener(&#x27;mouseenter&#x27;, (e) =&gt; &#123;</span><br><span class="line">                this.showTooltip(e.target, tower);</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            button.addEventListener(&#x27;mouseleave&#x27;, () =&gt; &#123;</span><br><span class="line">                this.hideTooltip();</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            panel.appendChild(button);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        document.getElementById(&#x27;ui-overlay&#x27;).appendChild(panel);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    createSkillsPanel() &#123;</span><br><span class="line">        const skills = [</span><br><span class="line">            &#123; id: &#x27;lightning&#x27;, name: &#x27;闪电链&#x27;, cost: 40, cooldown: 10, color: &#x27;#FFEB3B&#x27;, description: &#x27;对多个敌人造成连锁闪电伤害&#x27; &#125;,</span><br><span class="line">            &#123; id: &#x27;heal&#x27;, name: &#x27;治疗&#x27;, cost: 30, cooldown: 8, color: &#x27;#4CAF50&#x27;, description: &#x27;恢复所有塔的生命值&#x27; &#125;,</span><br><span class="line">            &#123; id: &#x27;meteor&#x27;, name: &#x27;陨石术&#x27;, cost: 60, cooldown: 15, color: &#x27;#FF5722&#x27;, description: &#x27;对指定区域造成巨大伤害&#x27; &#125;,</span><br><span class="line">            &#123; id: &#x27;freeze&#x27;, name: &#x27;冰冻&#x27;, cost: 50, cooldown: 12, color: &#x27;#2196F3&#x27;, description: &#x27;冻结区域内的所有敌人&#x27; &#125;</span><br><span class="line">        ];</span><br><span class="line">        </span><br><span class="line">        const panel = document.createElement(&#x27;div&#x27;);</span><br><span class="line">        panel.id = &#x27;skills-panel&#x27;;</span><br><span class="line">        panel.className = &#x27;skills-panel&#x27;;</span><br><span class="line">        </span><br><span class="line">        skills.forEach(skill =&gt; &#123;</span><br><span class="line">            const button = document.createElement(&#x27;button&#x27;);</span><br><span class="line">            button.className = &#x27;skill-button&#x27;;</span><br><span class="line">            button.dataset.skill = skill.id;</span><br><span class="line">            button.innerHTML = `</span><br><span class="line">                &lt;div class=&quot;skill-icon&quot; style=&quot;background: $&#123;skill.color&#125;&quot;&gt;&lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;skill-cost&quot;&gt;$&#123;skill.cost&#125;G&lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;skill-cooldown&quot;&gt;&lt;/div&gt;</span><br><span class="line">            `;</span><br><span class="line">            </span><br><span class="line">            button.addEventListener(&#x27;click&#x27;, () =&gt; &#123;</span><br><span class="line">                if (this.gameManager.gameState.gold &gt;= skill.cost) &#123;</span><br><span class="line">                    this.activateSkill(skill.id);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    this.showNotification(&#x27;金币不足！&#x27;, &#x27;error&#x27;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            panel.appendChild(button);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        document.getElementById(&#x27;ui-overlay&#x27;).appendChild(panel);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    createGameStatusDisplay() &#123;</span><br><span class="line">        const statusPanel = document.createElement(&#x27;div&#x27;);</span><br><span class="line">        statusPanel.id = &#x27;game-status&#x27;;</span><br><span class="line">        statusPanel.className = &#x27;game-status-panel&#x27;;</span><br><span class="line">        </span><br><span class="line">        statusPanel.innerHTML = `</span><br><span class="line">            &lt;div class=&quot;status-item&quot;&gt;</span><br><span class="line">                &lt;span class=&quot;status-label&quot;&gt;波次:&lt;/span&gt;</span><br><span class="line">                &lt;span id=&quot;wave-display&quot; class=&quot;status-value&quot;&gt;1/10&lt;/span&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;status-item&quot;&gt;</span><br><span class="line">                &lt;span class=&quot;status-label&quot;&gt;敌人剩余:&lt;/span&gt;</span><br><span class="line">                &lt;span id=&quot;enemies-remaining&quot; class=&quot;status-value&quot;&gt;10&lt;/span&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;status-item&quot;&gt;</span><br><span class="line">                &lt;span class=&quot;status-label&quot;&gt;时间:&lt;/span&gt;</span><br><span class="line">                &lt;span id=&quot;game-time&quot; class=&quot;status-value&quot;&gt;00:00&lt;/span&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;status-item&quot;&gt;</span><br><span class="line">                &lt;span class=&quot;status-label&quot;&gt;击杀:&lt;/span&gt;</span><br><span class="line">                &lt;span id=&quot;kills-count&quot; class=&quot;status-value&quot;&gt;0&lt;/span&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        `;</span><br><span class="line">        </span><br><span class="line">        document.getElementById(&#x27;ui-overlay&#x27;).appendChild(statusPanel);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    createNotificationSystem() &#123;</span><br><span class="line">        const container = document.createElement(&#x27;div&#x27;);</span><br><span class="line">        container.id = &#x27;notification-container&#x27;;</span><br><span class="line">        container.className = &#x27;notification-container&#x27;;</span><br><span class="line">        document.getElementById(&#x27;ui-overlay&#x27;).appendChild(container);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    showTooltip(element, data) &#123;</span><br><span class="line">        if (this.activeTooltip) &#123;</span><br><span class="line">            this.activeTooltip.remove();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        const tooltip = document.createElement(&#x27;div&#x27;);</span><br><span class="line">        tooltip.className = &#x27;tooltip&#x27;;</span><br><span class="line">        tooltip.style.position = &#x27;absolute&#x27;;</span><br><span class="line">        tooltip.style.left = (element.offsetLeft + element.offsetWidth + 10) + &#x27;px&#x27;;</span><br><span class="line">        tooltip.style.top = element.offsetTop + &#x27;px&#x27;;</span><br><span class="line">        </span><br><span class="line">        tooltip.innerHTML = `</span><br><span class="line">            &lt;h3&gt;$&#123;data.name&#125;&lt;/h3&gt;</span><br><span class="line">            &lt;p&gt;$&#123;data.description&#125;&lt;/p&gt;</span><br><span class="line">            &lt;div class=&quot;tooltip-stats&quot;&gt;</span><br><span class="line">                &lt;div&gt;成本: $&#123;data.cost&#125; 金币&lt;/div&gt;</span><br><span class="line">                $&#123;data.damage ? `&lt;div&gt;伤害: $&#123;data.damage&#125;&lt;/div&gt;` : &#x27;&#x27;&#125;</span><br><span class="line">                $&#123;data.range ? `&lt;div&gt;范围: $&#123;data.range&#125;&lt;/div&gt;` : &#x27;&#x27;&#125;</span><br><span class="line">                $&#123;data.speed ? `&lt;div&gt;攻速: $&#123;data.speed&#125;/秒&lt;/div&gt;` : &#x27;&#x27;&#125;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        `;</span><br><span class="line">        </span><br><span class="line">        document.getElementById(&#x27;ui-overlay&#x27;).appendChild(tooltip);</span><br><span class="line">        this.activeTooltip = tooltip;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    hideTooltip() &#123;</span><br><span class="line">        if (this.activeTooltip) &#123;</span><br><span class="line">            this.activeTooltip.remove();</span><br><span class="line">            this.activeTooltip = null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    highlightSelectedTower(button) &#123;</span><br><span class="line">        // 移除所有高亮</span><br><span class="line">        document.querySelectorAll(&#x27;.tower-button&#x27;).forEach(btn =&gt; &#123;</span><br><span class="line">            btn.classList.remove(&#x27;selected&#x27;);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        // 添加当前高亮</span><br><span class="line">        button.classList.add(&#x27;selected&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    showNotification(message, type = &#x27;info&#x27;) &#123;</span><br><span class="line">        const notification = document.createElement(&#x27;div&#x27;);</span><br><span class="line">        notification.className = `notification notification-$&#123;type&#125;`;</span><br><span class="line">        notification.textContent = message;</span><br><span class="line">        </span><br><span class="line">        const container = document.getElementById(&#x27;notification-container&#x27;);</span><br><span class="line">        container.appendChild(notification);</span><br><span class="line">        </span><br><span class="line">        // 自动移除</span><br><span class="line">        setTimeout(() =&gt; &#123;</span><br><span class="line">            notification.classList.add(&#x27;fade-out&#x27;);</span><br><span class="line">            setTimeout(() =&gt; notification.remove(), 500);</span><br><span class="line">        &#125;, 3000);</span><br><span class="line">        </span><br><span class="line">        this.notifications.push(notification);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    activateSkill(skillId) &#123;</span><br><span class="line">        const game = this.gameManager;</span><br><span class="line">        </span><br><span class="line">        switch(skillId) &#123;</span><br><span class="line">            case &#x27;lightning&#x27;:</span><br><span class="line">                this.castLightningSkill();</span><br><span class="line">                break;</span><br><span class="line">            case &#x27;heal&#x27;:</span><br><span class="line">                this.castHealSkill();</span><br><span class="line">                break;</span><br><span class="line">            case &#x27;meteor&#x27;:</span><br><span class="line">                // 进入选择目标模式</span><br><span class="line">                game.selectingMeteorTarget = true;</span><br><span class="line">                this.showNotification(&#x27;点击地图选择陨石落点&#x27;);</span><br><span class="line">                break;</span><br><span class="line">            case &#x27;freeze&#x27;:</span><br><span class="line">                this.castFreezeSkill();</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 扣除金币</span><br><span class="line">        const skillCost = 40; // 从技能数据获取</span><br><span class="line">        game.gameState.gold -= skillCost;</span><br><span class="line">        </span><br><span class="line">        // 触发冷却</span><br><span class="line">        this.startSkillCooldown(skillId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    castLightningSkill() &#123;</span><br><span class="line">        const game = this.gameManager;</span><br><span class="line">        if (game.enemies.length === 0) return;</span><br><span class="line">        </span><br><span class="line">        // 找到第一个敌人作为起点</span><br><span class="line">        const firstEnemy = game.enemies[0];</span><br><span class="line">        const targets = [firstEnemy];</span><br><span class="line">        </span><br><span class="line">        // 寻找最多5个额外目标</span><br><span class="line">        for (let i = 0; i &lt; Math.min(5, game.enemies.length - 1); i++) &#123;</span><br><span class="line">            const randomEnemy = game.enemies[Math.floor(Math.random() * game.enemies.length)];</span><br><span class="line">            if (!targets.includes(randomEnemy)) &#123;</span><br><span class="line">                targets.push(randomEnemy);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 对每个目标造成伤害</span><br><span class="line">        targets.forEach((enemy, index) =&gt; &#123;</span><br><span class="line">            setTimeout(() =&gt; &#123;</span><br><span class="line">                enemy.takeDamage(25);</span><br><span class="line">                </span><br><span class="line">                // 创建闪电特效</span><br><span class="line">                this.createLightningEffect(</span><br><span class="line">                    index === 0 ? &#123;x: 0, y: 100&#125; : targets[index-1],</span><br><span class="line">                    enemy</span><br><span class="line">                );</span><br><span class="line">            &#125;, index * 100);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        this.showNotification(&#x27;闪电链击中 &#x27; + targets.length + &#x27; 个敌人！&#x27;, &#x27;success&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    castHealSkill() &#123;</span><br><span class="line">        const game = this.gameManager;</span><br><span class="line">        let healedTowers = 0;</span><br><span class="line">        </span><br><span class="line">        game.towers.forEach(tower =&gt; &#123;</span><br><span class="line">            if (tower.health &lt; tower.maxHealth) &#123;</span><br><span class="line">                tower.health = Math.min(tower.maxHealth, tower.health + 50);</span><br><span class="line">                healedTowers++;</span><br><span class="line">                </span><br><span class="line">                // 创建治疗特效</span><br><span class="line">                this.createHealEffect(tower);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        if (healedTowers &gt; 0) &#123;</span><br><span class="line">            this.showNotification(`治疗了 $&#123;healedTowers&#125; 座防御塔`, &#x27;success&#x27;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            this.showNotification(&#x27;所有防御塔都是满生命值&#x27;, &#x27;info&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    castFreezeSkill() &#123;</span><br><span class="line">        const game = this.gameManager;</span><br><span class="line">        const centerX = game.canvas.width / 2;</span><br><span class="line">        const centerY = game.canvas.height / 2;</span><br><span class="line">        const freezeRadius = 150;</span><br><span class="line">        </span><br><span class="line">        game.enemies.forEach(enemy =&gt; &#123;</span><br><span class="line">            const dx = enemy.x - centerX;</span><br><span class="line">            const dy = enemy.y - centerY;</span><br><span class="line">            const distance = Math.sqrt(dx * dx + dy * dy);</span><br><span class="line">            </span><br><span class="line">            if (distance &lt; freezeRadius) &#123;</span><br><span class="line">                // 应用冰冻效果</span><br><span class="line">                enemy.addSlowEffect(0.7, 3); // 减速70%，持续3秒</span><br><span class="line">                enemy.color = &#x27;#00BCD4&#x27;; // 变成蓝色</span><br><span class="line">                </span><br><span class="line">                // 3秒后恢复颜色</span><br><span class="line">                setTimeout(() =&gt; &#123;</span><br><span class="line">                    if (enemy.health &gt; 0) &#123;</span><br><span class="line">                        enemy.color = enemy.originalColor || &#x27;#2196F3&#x27;;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, 3000);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        // 创建冰冻特效</span><br><span class="line">        this.createFreezeEffect(centerX, centerY, freezeRadius);</span><br><span class="line">        this.showNotification(&#x27;冻结了区域内的敌人！&#x27;, &#x27;success&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    createLightningEffect(from, to) &#123;</span><br><span class="line">        const particles = [];</span><br><span class="line">        const steps = 20;</span><br><span class="line">        </span><br><span class="line">        for (let i = 0; i &lt; steps; i++) &#123;</span><br><span class="line">            const progress = i / steps;</span><br><span class="line">            const x = from.x + (to.x - from.x) * progress;</span><br><span class="line">            const y = from.y + (to.y - from.y) * progress;</span><br><span class="line">            </span><br><span class="line">            // 添加随机偏移</span><br><span class="line">            const offsetX = (Math.random() - 0.5) * 30;</span><br><span class="line">            const offsetY = (Math.random() - 0.5) * 30;</span><br><span class="line">            </span><br><span class="line">            particles.push(&#123;</span><br><span class="line">                x: x + offsetX,</span><br><span class="line">                y: y + offsetY,</span><br><span class="line">                life: 1.0,</span><br><span class="line">                maxLife: 0.2,</span><br><span class="line">                color: &#x27;#FFEB3B&#x27;,</span><br><span class="line">                size: Math.random() * 5 + 2</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 将粒子添加到游戏管理器</span><br><span class="line">        this.gameManager.particles.push(...particles);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    createHealEffect(tower) &#123;</span><br><span class="line">        for (let i = 0; i &lt; 20; i++) &#123;</span><br><span class="line">            const angle = Math.random() * Math.PI * 2;</span><br><span class="line">            const distance = Math.random() * 40;</span><br><span class="line">            const speed = Math.random() * 100 + 50;</span><br><span class="line">            </span><br><span class="line">            this.gameManager.particles.push(&#123;</span><br><span class="line">                x: tower.x + Math.cos(angle) * distance,</span><br><span class="line">                y: tower.y + Math.sin(angle) * distance,</span><br><span class="line">                vx: Math.cos(angle) * speed,</span><br><span class="line">                vy: Math.sin(angle) * speed,</span><br><span class="line">                life: 1.0,</span><br><span class="line">                maxLife: 1.0,</span><br><span class="line">                color: &#x27;#4CAF50&#x27;,</span><br><span class="line">                size: Math.random() * 4 + 2</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    createFreezeEffect(x, y, radius) &#123;</span><br><span class="line">        // 创建冰冻区域粒子</span><br><span class="line">        for (let i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">            const angle = Math.random() * Math.PI * 2;</span><br><span class="line">            const distance = Math.random() * radius;</span><br><span class="line">            </span><br><span class="line">            this.gameManager.particles.push(&#123;</span><br><span class="line">                x: x + Math.cos(angle) * distance,</span><br><span class="line">                y: y + Math.sin(angle) * distance,</span><br><span class="line">                vx: 0,</span><br><span class="line">                vy: -Math.random() * 50,</span><br><span class="line">                life: 1.0,</span><br><span class="line">                maxLife: 2.0,</span><br><span class="line">                color: &#x27;#2196F3&#x27;,</span><br><span class="line">                size: Math.random() * 8 + 4</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    startSkillCooldown(skillId) &#123;</span><br><span class="line">        const button = document.querySelector(`[data-skill=&quot;$&#123;skillId&#125;&quot;]`);</span><br><span class="line">        if (!button) return;</span><br><span class="line">        </span><br><span class="line">        button.classList.add(&#x27;cooldown&#x27;);</span><br><span class="line">        const cooldownElement = button.querySelector(&#x27;.skill-cooldown&#x27;);</span><br><span class="line">        </span><br><span class="line">        // 获取冷却时间（从技能数据中）</span><br><span class="line">        const cooldownTime = 10; // 秒</span><br><span class="line">        </span><br><span class="line">        let remaining = cooldownTime;</span><br><span class="line">        cooldownElement.textContent = remaining;</span><br><span class="line">        </span><br><span class="line">        const interval = setInterval(() =&gt; &#123;</span><br><span class="line">            remaining--;</span><br><span class="line">            cooldownElement.textContent = remaining;</span><br><span class="line">            </span><br><span class="line">            if (remaining &lt;= 0) &#123;</span><br><span class="line">                clearInterval(interval);</span><br><span class="line">                button.classList.remove(&#x27;cooldown&#x27;);</span><br><span class="line">                cooldownElement.textContent = &#x27;&#x27;;</span><br><span class="line">                this.showNotification(`$&#123;button.dataset.skill&#125; 技能已就绪`, &#x27;info&#x27;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, 1000);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    update(gameState) &#123;</span><br><span class="line">        // 更新UI显示</span><br><span class="line">        document.getElementById(&#x27;gold&#x27;).textContent = gameState.gold;</span><br><span class="line">        document.getElementById(&#x27;lives&#x27;).textContent = gameState.lives;</span><br><span class="line">        document.getElementById(&#x27;wave&#x27;).textContent = `$&#123;gameState.wave&#125;/10`;</span><br><span class="line">        </span><br><span class="line">        // 更新游戏状态显示</span><br><span class="line">        const enemiesRemaining = this.gameManager.enemies.length;</span><br><span class="line">        document.getElementById(&#x27;enemies-remaining&#x27;).textContent = enemiesRemaining;</span><br><span class="line">        document.getElementById(&#x27;kills-count&#x27;).textContent = gameState.kills || 0;</span><br><span class="line">        </span><br><span class="line">        // 更新时间显示</span><br><span class="line">        const timeInSeconds = Math.floor(gameState.gameTime || 0);</span><br><span class="line">        const minutes = Math.floor(timeInSeconds / 60).toString().padStart(2, &#x27;0&#x27;);</span><br><span class="line">        const seconds = (timeInSeconds % 60).toString().padStart(2, &#x27;0&#x27;);</span><br><span class="line">        document.getElementById(&#x27;game-time&#x27;).textContent = `$&#123;minutes&#125;:$&#123;seconds&#125;`;</span><br><span class="line">        </span><br><span class="line">        // 更新技能按钮状态</span><br><span class="line">        this.updateSkillButtons();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    updateSkillButtons() &#123;</span><br><span class="line">        const buttons = document.querySelectorAll(&#x27;.skill-button&#x27;);</span><br><span class="line">        buttons.forEach(button =&gt; &#123;</span><br><span class="line">            const skillCost = 40; // 从技能数据获取</span><br><span class="line">            if (this.gameManager.gameState.gold &lt; skillCost) &#123;</span><br><span class="line">                button.classList.add(&#x27;disabled&#x27;);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                button.classList.remove(&#x27;disabled&#x27;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="10-2-添加粒子系统"><a href="#10-2-添加粒子系统" class="headerlink" title="10.2 添加粒子系统"></a>10.2 添加粒子系统</h4><p>创建 <code>frontend/js/entities/particle.js</code>:</p>
<p>javascript</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br></pre></td><td class="code"><pre><span class="line">class ParticleSystem &#123;</span><br><span class="line">    constructor(gameManager) &#123;</span><br><span class="line">        this.gameManager = gameManager;</span><br><span class="line">        this.particles = [];</span><br><span class="line">        this.emitters = [];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    createExplosion(x, y, color = &#x27;#FF5722&#x27;, count = 30) &#123;</span><br><span class="line">        for (let i = 0; i &lt; count; i++) &#123;</span><br><span class="line">            const angle = Math.random() * Math.PI * 2;</span><br><span class="line">            const speed = Math.random() * 200 + 100;</span><br><span class="line">            </span><br><span class="line">            this.particles.push(&#123;</span><br><span class="line">                x, y,</span><br><span class="line">                vx: Math.cos(angle) * speed,</span><br><span class="line">                vy: Math.sin(angle) * speed,</span><br><span class="line">                life: 1.0,</span><br><span class="line">                maxLife: 1.0,</span><br><span class="line">                color: color,</span><br><span class="line">                size: Math.random() * 8 + 4,</span><br><span class="line">                gravity: 400,</span><br><span class="line">                friction: 0.95</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    createBloodEffect(x, y) &#123;</span><br><span class="line">        for (let i = 0; i &lt; 15; i++) &#123;</span><br><span class="line">            const angle = Math.random() * Math.PI * 2;</span><br><span class="line">            const speed = Math.random() * 150 + 50;</span><br><span class="line">            </span><br><span class="line">            this.particles.push(&#123;</span><br><span class="line">                x, y,</span><br><span class="line">                vx: Math.cos(angle) * speed,</span><br><span class="line">                vy: Math.sin(angle) * speed,</span><br><span class="line">                life: 1.0,</span><br><span class="line">                maxLife: 1.5,</span><br><span class="line">                color: &#x27;#C62828&#x27;,</span><br><span class="line">                size: Math.random() * 6 + 3,</span><br><span class="line">                gravity: 500,</span><br><span class="line">                friction: 0.9</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    createMagicEffect(x, y, targetX, targetY) &#123;</span><br><span class="line">        const steps = 20;</span><br><span class="line">        const particles = [];</span><br><span class="line">        </span><br><span class="line">        for (let i = 0; i &lt; steps; i++) &#123;</span><br><span class="line">            const progress = i / steps;</span><br><span class="line">            const xPos = x + (targetX - x) * progress;</span><br><span class="line">            const yPos = y + (targetY - y) * progress;</span><br><span class="line">            </span><br><span class="line">            particles.push(&#123;</span><br><span class="line">                x: xPos,</span><br><span class="line">                y: yPos,</span><br><span class="line">                vx: 0,</span><br><span class="line">                vy: 0,</span><br><span class="line">                life: 0.5,</span><br><span class="line">                maxLife: 0.5,</span><br><span class="line">                color: &#x27;#9C27B0&#x27;,</span><br><span class="line">                size: Math.random() * 6 + 4,</span><br><span class="line">                trail: true</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        this.particles.push(...particles);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    createTowerBuildEffect(x, y) &#123;</span><br><span class="line">        for (let i = 0; i &lt; 50; i++) &#123;</span><br><span class="line">            const angle = Math.random() * Math.PI * 2;</span><br><span class="line">            const distance = Math.random() * 40;</span><br><span class="line">            </span><br><span class="line">            this.particles.push(&#123;</span><br><span class="line">                x: x + Math.cos(angle) * distance,</span><br><span class="line">                y: y + Math.sin(angle) * distance,</span><br><span class="line">                vx: Math.cos(angle) * 50,</span><br><span class="line">                vy: Math.sin(angle) * 50,</span><br><span class="line">                life: 1.0,</span><br><span class="line">                maxLife: 1.0,</span><br><span class="line">                color: &#x27;#FFD700&#x27;,</span><br><span class="line">                size: Math.random() * 5 + 3,</span><br><span class="line">                gravity: -100, // 向上飘</span><br><span class="line">                friction: 0.8</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    createUpgradeEffect(x, y) &#123;</span><br><span class="line">        // 创建升级光环</span><br><span class="line">        for (let i = 0; i &lt; 3; i++) &#123;</span><br><span class="line">            this.particles.push(&#123;</span><br><span class="line">                x, y,</span><br><span class="line">                vx: 0,</span><br><span class="line">                vy: 0,</span><br><span class="line">                life: 1.0,</span><br><span class="line">                maxLife: 1.0,</span><br><span class="line">                color: &#x27;#4CAF50&#x27;,</span><br><span class="line">                size: 40 + i * 20,</span><br><span class="line">                type: &#x27;ring&#x27;,</span><br><span class="line">                growth: 100</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 创建星光粒子</span><br><span class="line">        for (let i = 0; i &lt; 20; i++) &#123;</span><br><span class="line">            const angle = Math.random() * Math.PI * 2;</span><br><span class="line">            const speed = Math.random() * 100 + 50;</span><br><span class="line">            </span><br><span class="line">            this.particles.push(&#123;</span><br><span class="line">                x, y,</span><br><span class="line">                vx: Math.cos(angle) * speed,</span><br><span class="line">                vy: Math.sin(angle) * speed,</span><br><span class="line">                life: 1.0,</span><br><span class="line">                maxLife: 1.5,</span><br><span class="line">                color: &#x27;#FFD700&#x27;,</span><br><span class="line">                size: Math.random() * 4 + 2,</span><br><span class="line">                gravity: 0,</span><br><span class="line">                friction: 0.85</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    update(deltaTime) &#123;</span><br><span class="line">        // 更新发射器</span><br><span class="line">        for (let i = this.emitters.length - 1; i &gt;= 0; i--) &#123;</span><br><span class="line">            const emitter = this.emitters[i];</span><br><span class="line">            emitter.timer -= deltaTime;</span><br><span class="line">            </span><br><span class="line">            if (emitter.timer &lt;= 0) &#123;</span><br><span class="line">                this.emitters.splice(i, 1);</span><br><span class="line">            &#125; else if (emitter.interval &gt; 0) &#123;</span><br><span class="line">                emitter.nextEmit -= deltaTime;</span><br><span class="line">                if (emitter.nextEmit &lt;= 0) &#123;</span><br><span class="line">                    this.emitParticles(emitter);</span><br><span class="line">                    emitter.nextEmit = emitter.interval;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 更新粒子</span><br><span class="line">        for (let i = this.particles.length - 1; i &gt;= 0; i--) &#123;</span><br><span class="line">            const particle = this.particles[i];</span><br><span class="line">            </span><br><span class="line">            // 更新位置</span><br><span class="line">            particle.x += particle.vx * deltaTime;</span><br><span class="line">            particle.y += particle.vy * deltaTime;</span><br><span class="line">            </span><br><span class="line">            // 应用重力</span><br><span class="line">            if (particle.gravity) &#123;</span><br><span class="line">                particle.vy += particle.gravity * deltaTime;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 应用摩擦力</span><br><span class="line">            if (particle.friction) &#123;</span><br><span class="line">                particle.vx *= Math.pow(particle.friction, deltaTime);</span><br><span class="line">                particle.vy *= Math.pow(particle.friction, deltaTime);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 增长效果</span><br><span class="line">            if (particle.growth) &#123;</span><br><span class="line">                particle.size += particle.growth * deltaTime;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 更新生命周期</span><br><span class="line">            particle.life -= deltaTime / particle.maxLife;</span><br><span class="line">            </span><br><span class="line">            // 移除死亡的粒子</span><br><span class="line">            if (particle.life &lt;= 0) &#123;</span><br><span class="line">                this.particles.splice(i, 1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    draw(ctx) &#123;</span><br><span class="line">        ctx.save();</span><br><span class="line">        </span><br><span class="line">        this.particles.forEach(particle =&gt; &#123;</span><br><span class="line">            const alpha = particle.life;</span><br><span class="line">            </span><br><span class="line">            if (particle.type === &#x27;ring&#x27;) &#123;</span><br><span class="line">                // 绘制光环</span><br><span class="line">                ctx.strokeStyle = particle.color;</span><br><span class="line">                ctx.globalAlpha = alpha * 0.5;</span><br><span class="line">                ctx.lineWidth = 2;</span><br><span class="line">                ctx.beginPath();</span><br><span class="line">                ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);</span><br><span class="line">                ctx.stroke();</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // 绘制圆形粒子</span><br><span class="line">                ctx.fillStyle = particle.color;</span><br><span class="line">                ctx.globalAlpha = alpha;</span><br><span class="line">                ctx.beginPath();</span><br><span class="line">                ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);</span><br><span class="line">                ctx.fill();</span><br><span class="line">                </span><br><span class="line">                // 绘制光晕</span><br><span class="line">                if (particle.glow) &#123;</span><br><span class="line">                    ctx.strokeStyle = particle.color;</span><br><span class="line">                    ctx.globalAlpha = alpha * 0.3;</span><br><span class="line">                    ctx.lineWidth = 2;</span><br><span class="line">                    ctx.beginPath();</span><br><span class="line">                    ctx.arc(particle.x, particle.y, particle.size * 1.5, 0, Math.PI * 2);</span><br><span class="line">                    ctx.stroke();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        ctx.restore();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    addEmitter(config) &#123;</span><br><span class="line">        this.emitters.push(&#123;</span><br><span class="line">            ...config,</span><br><span class="line">            timer: config.duration || 1,</span><br><span class="line">            nextEmit: 0</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    emitParticles(emitter) &#123;</span><br><span class="line">        const count = emitter.count || 10;</span><br><span class="line">        </span><br><span class="line">        for (let i = 0; i &lt; count; i++) &#123;</span><br><span class="line">            const angle = emitter.angle + (Math.random() - 0.5) * emitter.spread;</span><br><span class="line">            const speed = emitter.speed * (0.8 + Math.random() * 0.4);</span><br><span class="line">            </span><br><span class="line">            this.particles.push(&#123;</span><br><span class="line">                x: emitter.x,</span><br><span class="line">                y: emitter.y,</span><br><span class="line">                vx: Math.cos(angle) * speed,</span><br><span class="line">                vy: Math.sin(angle) * speed,</span><br><span class="line">                life: 1.0,</span><br><span class="line">                maxLife: emitter.particleLife || 1.0,</span><br><span class="line">                color: emitter.color || &#x27;#FFFFFF&#x27;,</span><br><span class="line">                size: emitter.size || 4,</span><br><span class="line">                gravity: emitter.gravity || 0,</span><br><span class="line">                friction: emitter.friction || 0.95</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    clear() &#123;</span><br><span class="line">        this.particles = [];</span><br><span class="line">        this.emitters = [];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="10-3-添加CSS样式"><a href="#10-3-添加CSS样式" class="headerlink" title="10.3 添加CSS样式"></a>10.3 添加CSS样式</h4><p>创建 <code>frontend/css/game.css</code>:</p>
<p>css</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br></pre></td><td class="code"><pre><span class="line">/* 塔选择面板 */</span><br><span class="line">.tower-selection-panel &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    bottom: 20px;</span><br><span class="line">    left: 50%;</span><br><span class="line">    transform: translateX(-50%);</span><br><span class="line">    background: rgba(15, 52, 96, 0.9);</span><br><span class="line">    border-radius: 15px;</span><br><span class="line">    padding: 15px;</span><br><span class="line">    display: flex;</span><br><span class="line">    gap: 10px;</span><br><span class="line">    backdrop-filter: blur(10px);</span><br><span class="line">    border: 2px solid #4fc3f7;</span><br><span class="line">    box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.tower-button &#123;</span><br><span class="line">    background: rgba(31, 58, 147, 0.8);</span><br><span class="line">    border: 2px solid transparent;</span><br><span class="line">    border-radius: 10px;</span><br><span class="line">    padding: 10px;</span><br><span class="line">    display: flex;</span><br><span class="line">    flex-direction: column;</span><br><span class="line">    align-items: center;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    transition: all 0.3s ease;</span><br><span class="line">    min-width: 80px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.tower-button:hover &#123;</span><br><span class="line">    background: rgba(41, 68, 157, 1);</span><br><span class="line">    border-color: #4fc3f7;</span><br><span class="line">    transform: translateY(-5px);</span><br><span class="line">    box-shadow: 0 5px 15px rgba(79, 195, 247, 0.4);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.tower-button.selected &#123;</span><br><span class="line">    border-color: #FFD700;</span><br><span class="line">    background: rgba(41, 68, 157, 1);</span><br><span class="line">    box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.tower-icon &#123;</span><br><span class="line">    width: 40px;</span><br><span class="line">    height: 40px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    margin-bottom: 8px;</span><br><span class="line">    border: 2px solid rgba(255, 255, 255, 0.3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.tower-info &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    flex-direction: column;</span><br><span class="line">    align-items: center;</span><br><span class="line">    color: white;</span><br><span class="line">    font-size: 12px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.tower-name &#123;</span><br><span class="line">    font-weight: bold;</span><br><span class="line">    margin-bottom: 4px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.tower-cost &#123;</span><br><span class="line">    color: #FFD700;</span><br><span class="line">    font-weight: bold;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 技能面板 */</span><br><span class="line">.skills-panel &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    top: 20px;</span><br><span class="line">    right: 20px;</span><br><span class="line">    background: rgba(15, 52, 96, 0.9);</span><br><span class="line">    border-radius: 15px;</span><br><span class="line">    padding: 15px;</span><br><span class="line">    display: flex;</span><br><span class="line">    flex-direction: column;</span><br><span class="line">    gap: 10px;</span><br><span class="line">    backdrop-filter: blur(10px);</span><br><span class="line">    border: 2px solid #e94560;</span><br><span class="line">    box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.skill-button &#123;</span><br><span class="line">    position: relative;</span><br><span class="line">    width: 60px;</span><br><span class="line">    height: 60px;</span><br><span class="line">    background: rgba(31, 58, 147, 0.8);</span><br><span class="line">    border: 2px solid transparent;</span><br><span class="line">    border-radius: 10px;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    transition: all 0.3s ease;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.skill-button:hover:not(.cooldown):not(.disabled) &#123;</span><br><span class="line">    background: rgba(41, 68, 157, 1);</span><br><span class="line">    border-color: #e94560;</span><br><span class="line">    transform: scale(1.1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.skill-button.disabled &#123;</span><br><span class="line">    opacity: 0.5;</span><br><span class="line">    cursor: not-allowed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.skill-button.cooldown &#123;</span><br><span class="line">    opacity: 0.5;</span><br><span class="line">    cursor: not-allowed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.skill-icon &#123;</span><br><span class="line">    width: 40px;</span><br><span class="line">    height: 40px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    border: 2px solid rgba(255, 255, 255, 0.3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.skill-cost &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    top: -5px;</span><br><span class="line">    right: -5px;</span><br><span class="line">    background: #e94560;</span><br><span class="line">    color: white;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    width: 25px;</span><br><span class="line">    height: 25px;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    font-size: 12px;</span><br><span class="line">    font-weight: bold;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.skill-cooldown &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    top: 0;</span><br><span class="line">    left: 0;</span><br><span class="line">    right: 0;</span><br><span class="line">    bottom: 0;</span><br><span class="line">    background: rgba(0, 0, 0, 0.7);</span><br><span class="line">    border-radius: 8px;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    font-size: 24px;</span><br><span class="line">    font-weight: bold;</span><br><span class="line">    color: white;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 游戏状态面板 */</span><br><span class="line">.game-status-panel &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    top: 100px;</span><br><span class="line">    right: 20px;</span><br><span class="line">    background: rgba(15, 52, 96, 0.9);</span><br><span class="line">    border-radius: 15px;</span><br><span class="line">    padding: 15px;</span><br><span class="line">    backdrop-filter: blur(10px);</span><br><span class="line">    border: 2px solid #4fc3f7;</span><br><span class="line">    box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);</span><br><span class="line">    min-width: 150px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.status-item &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    margin-bottom: 10px;</span><br><span class="line">    color: white;</span><br><span class="line">    font-size: 14px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.status-item:last-child &#123;</span><br><span class="line">    margin-bottom: 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.status-label &#123;</span><br><span class="line">    color: #4fc3f7;</span><br><span class="line">    font-weight: bold;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.status-value &#123;</span><br><span class="line">    color: #FFD700;</span><br><span class="line">    font-weight: bold;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 提示框 */</span><br><span class="line">.tooltip &#123;</span><br><span class="line">    background: rgba(15, 52, 96, 0.95);</span><br><span class="line">    border: 2px solid #4fc3f7;</span><br><span class="line">    border-radius: 10px;</span><br><span class="line">    padding: 15px;</span><br><span class="line">    color: white;</span><br><span class="line">    max-width: 250px;</span><br><span class="line">    z-index: 1000;</span><br><span class="line">    box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);</span><br><span class="line">    backdrop-filter: blur(10px);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.tooltip h3 &#123;</span><br><span class="line">    color: #4fc3f7;</span><br><span class="line">    margin-top: 0;</span><br><span class="line">    margin-bottom: 10px;</span><br><span class="line">    font-size: 16px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.tooltip p &#123;</span><br><span class="line">    margin-bottom: 15px;</span><br><span class="line">    font-size: 14px;</span><br><span class="line">    line-height: 1.4;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.tooltip-stats &#123;</span><br><span class="line">    display: grid;</span><br><span class="line">    grid-template-columns: 1fr 1fr;</span><br><span class="line">    gap: 8px;</span><br><span class="line">    font-size: 12px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.tooltip-stats div &#123;</span><br><span class="line">    background: rgba(31, 58, 147, 0.5);</span><br><span class="line">    padding: 5px;</span><br><span class="line">    border-radius: 5px;</span><br><span class="line">    text-align: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 通知系统 */</span><br><span class="line">.notification-container &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    top: 20px;</span><br><span class="line">    left: 50%;</span><br><span class="line">    transform: translateX(-50%);</span><br><span class="line">    display: flex;</span><br><span class="line">    flex-direction: column;</span><br><span class="line">    align-items: center;</span><br><span class="line">    gap: 10px;</span><br><span class="line">    z-index: 1000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.notification &#123;</span><br><span class="line">    background: rgba(15, 52, 96, 0.95);</span><br><span class="line">    border-radius: 10px;</span><br><span class="line">    padding: 15px 30px;</span><br><span class="line">    color: white;</span><br><span class="line">    font-weight: bold;</span><br><span class="line">    text-align: center;</span><br><span class="line">    min-width: 300px;</span><br><span class="line">    backdrop-filter: blur(10px);</span><br><span class="line">    animation: slideDown 0.3s ease;</span><br><span class="line">    border: 2px solid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.notification-info &#123;</span><br><span class="line">    border-color: #4fc3f7;</span><br><span class="line">    background: rgba(15, 52, 96, 0.95);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.notification-success &#123;</span><br><span class="line">    border-color: #4CAF50;</span><br><span class="line">    background: rgba(76, 175, 80, 0.2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.notification-error &#123;</span><br><span class="line">    border-color: #e94560;</span><br><span class="line">    background: rgba(233, 69, 96, 0.2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.notification-warning &#123;</span><br><span class="line">    border-color: #FF9800;</span><br><span class="line">    background: rgba(255, 152, 0, 0.2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@keyframes slideDown &#123;</span><br><span class="line">    from &#123;</span><br><span class="line">        transform: translateY(-50px);</span><br><span class="line">        opacity: 0;</span><br><span class="line">    &#125;</span><br><span class="line">    to &#123;</span><br><span class="line">        transform: translateY(0);</span><br><span class="line">        opacity: 1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.fade-out &#123;</span><br><span class="line">    animation: fadeOut 0.5s ease forwards;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@keyframes fadeOut &#123;</span><br><span class="line">    from &#123;</span><br><span class="line">        opacity: 1;</span><br><span class="line">        transform: translateY(0);</span><br><span class="line">    &#125;</span><br><span class="line">    to &#123;</span><br><span class="line">        opacity: 0;</span><br><span class="line">        transform: translateY(-20px);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 升级面板 */</span><br><span class="line">.upgrade-panel &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    background: rgba(15, 52, 96, 0.95);</span><br><span class="line">    border: 2px solid #FFD700;</span><br><span class="line">    border-radius: 15px;</span><br><span class="line">    padding: 20px;</span><br><span class="line">    color: white;</span><br><span class="line">    min-width: 200px;</span><br><span class="line">    z-index: 1000;</span><br><span class="line">    backdrop-filter: blur(10px);</span><br><span class="line">    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.upgrade-header &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    align-items: center;</span><br><span class="line">    margin-bottom: 20px;</span><br><span class="line">    border-bottom: 1px solid rgba(255, 215, 0, 0.3);</span><br><span class="line">    padding-bottom: 10px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.upgrade-header h3 &#123;</span><br><span class="line">    margin: 0;</span><br><span class="line">    color: #FFD700;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.close-upgrade &#123;</span><br><span class="line">    background: none;</span><br><span class="line">    border: none;</span><br><span class="line">    color: white;</span><br><span class="line">    font-size: 20px;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    width: 30px;</span><br><span class="line">    height: 30px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    transition: background 0.3s ease;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.close-upgrade:hover &#123;</span><br><span class="line">    background: rgba(233, 69, 96, 0.3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.upgrade-stats &#123;</span><br><span class="line">    margin-bottom: 20px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.stat-row &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    margin-bottom: 8px;</span><br><span class="line">    font-size: 14px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.stat-label &#123;</span><br><span class="line">    color: #4fc3f7;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.stat-value &#123;</span><br><span class="line">    color: #FFD700;</span><br><span class="line">    font-weight: bold;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.upgrade-actions &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    gap: 10px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.upgrade-button, .sell-button &#123;</span><br><span class="line">    flex: 1;</span><br><span class="line">    padding: 12px;</span><br><span class="line">    border: none;</span><br><span class="line">    border-radius: 8px;</span><br><span class="line">    color: white;</span><br><span class="line">    font-weight: bold;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    transition: all 0.3s ease;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.upgrade-button &#123;</span><br><span class="line">    background: linear-gradient(45deg, #4CAF50, #8BC34A);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.upgrade-button:hover:not(:disabled) &#123;</span><br><span class="line">    transform: translateY(-2px);</span><br><span class="line">    box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.upgrade-button:disabled &#123;</span><br><span class="line">    opacity: 0.5;</span><br><span class="line">    cursor: not-allowed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.sell-button &#123;</span><br><span class="line">    background: linear-gradient(45deg, #e94560, #ff6b95);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.sell-button:hover &#123;</span><br><span class="line">    transform: translateY(-2px);</span><br><span class="line">    box-shadow: 0 5px 15px rgba(233, 69, 96, 0.4);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 波次显示 */</span><br><span class="line">.wave-display &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    top: 50%;</span><br><span class="line">    left: 50%;</span><br><span class="line">    transform: translate(-50%, -50%);</span><br><span class="line">    background: rgba(15, 52, 96, 0.95);</span><br><span class="line">    border: 3px solid #e94560;</span><br><span class="line">    border-radius: 15px;</span><br><span class="line">    padding: 30px 60px;</span><br><span class="line">    color: white;</span><br><span class="line">    font-size: 48px;</span><br><span class="line">    font-weight: bold;</span><br><span class="line">    text-align: center;</span><br><span class="line">    backdrop-filter: blur(10px);</span><br><span class="line">    box-shadow: 0 10px 40px rgba(233, 69, 96, 0.3);</span><br><span class="line">    animation: waveAnnounce 2s ease;</span><br><span class="line">    z-index: 1000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@keyframes waveAnnounce &#123;</span><br><span class="line">    0% &#123;</span><br><span class="line">        opacity: 0;</span><br><span class="line">        transform: translate(-50%, -50%) scale(0.5);</span><br><span class="line">    &#125;</span><br><span class="line">    20% &#123;</span><br><span class="line">        opacity: 1;</span><br><span class="line">        transform: translate(-50%, -50%) scale(1.1);</span><br><span class="line">    &#125;</span><br><span class="line">    30% &#123;</span><br><span class="line">        transform: translate(-50%, -50%) scale(1);</span><br><span class="line">    &#125;</span><br><span class="line">    80% &#123;</span><br><span class="line">        opacity: 1;</span><br><span class="line">    &#125;</span><br><span class="line">    100% &#123;</span><br><span class="line">        opacity: 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 游戏结束界面 */</span><br><span class="line">.game-over-screen &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    top: 0;</span><br><span class="line">    left: 0;</span><br><span class="line">    right: 0;</span><br><span class="line">    bottom: 0;</span><br><span class="line">    background: rgba(0, 0, 0, 0.8);</span><br><span class="line">    display: flex;</span><br><span class="line">    flex-direction: column;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    z-index: 2000;</span><br><span class="line">    backdrop-filter: blur(10px);</span><br><span class="line">    animation: fadeIn 0.5s ease;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@keyframes fadeIn &#123;</span><br><span class="line">    from &#123; opacity: 0; &#125;</span><br><span class="line">    to &#123; opacity: 1; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.game-over-content &#123;</span><br><span class="line">    background: rgba(15, 52, 96, 0.95);</span><br><span class="line">    border: 3px solid #e94560;</span><br><span class="line">    border-radius: 20px;</span><br><span class="line">    padding: 40px;</span><br><span class="line">    max-width: 500px;</span><br><span class="line">    text-align: center;</span><br><span class="line">    animation: slideUp 0.5s ease;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@keyframes slideUp &#123;</span><br><span class="line">    from &#123;</span><br><span class="line">        transform: translateY(50px);</span><br><span class="line">        opacity: 0;</span><br><span class="line">    &#125;</span><br><span class="line">    to &#123;</span><br><span class="line">        transform: translateY(0);</span><br><span class="line">        opacity: 1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.game-over-title &#123;</span><br><span class="line">    color: #e94560;</span><br><span class="line">    font-size: 48px;</span><br><span class="line">    margin-bottom: 20px;</span><br><span class="line">    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.game-over-stats &#123;</span><br><span class="line">    display: grid;</span><br><span class="line">    grid-template-columns: repeat(2, 1fr);</span><br><span class="line">    gap: 20px;</span><br><span class="line">    margin-bottom: 30px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.stat-box &#123;</span><br><span class="line">    background: rgba(31, 58, 147, 0.5);</span><br><span class="line">    padding: 15px;</span><br><span class="line">    border-radius: 10px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.stat-label &#123;</span><br><span class="line">    display: block;</span><br><span class="line">    color: #4fc3f7;</span><br><span class="line">    font-size: 14px;</span><br><span class="line">    margin-bottom: 5px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.stat-value &#123;</span><br><span class="line">    display: block;</span><br><span class="line">    color: #FFD700;</span><br><span class="line">    font-size: 24px;</span><br><span class="line">    font-weight: bold;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.game-over-actions &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    gap: 20px;</span><br><span class="line">    justify-content: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 加载屏幕 */</span><br><span class="line">.loading-screen &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    top: 0;</span><br><span class="line">    left: 0;</span><br><span class="line">    right: 0;</span><br><span class="line">    bottom: 0;</span><br><span class="line">    background: #1a1a2e;</span><br><span class="line">    display: flex;</span><br><span class="line">    flex-direction: column;</span><br><span class="line">    align-items: center;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    z-index: 3000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.loading-title &#123;</span><br><span class="line">    color: #4fc3f7;</span><br><span class="line">    font-size: 36px;</span><br><span class="line">    margin-bottom: 30px;</span><br><span class="line">    text-shadow: 0 0 10px rgba(79, 195, 247, 0.5);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.loading-bar &#123;</span><br><span class="line">    width: 300px;</span><br><span class="line">    height: 20px;</span><br><span class="line">    background: rgba(15, 52, 96, 0.5);</span><br><span class="line">    border-radius: 10px;</span><br><span class="line">    overflow: hidden;</span><br><span class="line">    margin-bottom: 20px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.loading-progress &#123;</span><br><span class="line">    height: 100%;</span><br><span class="line">    background: linear-gradient(90deg, #4fc3f7, #e94560);</span><br><span class="line">    border-radius: 10px;</span><br><span class="line">    width: 0%;</span><br><span class="line">    transition: width 0.3s ease;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.loading-text &#123;</span><br><span class="line">    color: white;</span><br><span class="line">    font-size: 14px;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="第十二阶段：Java后端高级功能（第9周）"><a href="#第十二阶段：Java后端高级功能（第9周）" class="headerlink" title="第十二阶段：Java后端高级功能（第9周）"></a>第十二阶段：Java后端高级功能（第9周）</h2><h3 id="步骤11：实现多人游戏和实时通信"><a href="#步骤11：实现多人游戏和实时通信" class="headerlink" title="步骤11：实现多人游戏和实时通信"></a>步骤11：实现多人游戏和实时通信</h3><h4 id="11-1-添加WebSocket支持"><a href="#11-1-添加WebSocket支持" class="headerlink" title="11.1 添加WebSocket支持"></a>11.1 添加WebSocket支持</h4><p>更新 <code>backend/pom.xml</code>:</p>
<p>xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-websocket&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>



<p>创建 <code>backend/src/main/java/com/kingdomdefense/config/WebSocketConfig.java</code>:</p>
<p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">package com.kingdomdefense.config;</span><br><span class="line"></span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.messaging.simp.config.MessageBrokerRegistry;</span><br><span class="line">import org.springframework.web.socket.config.annotation.EnableWebSocketMessageBroker;</span><br><span class="line">import org.springframework.web.socket.config.annotation.StompEndpointRegistry;</span><br><span class="line">import org.springframework.web.socket.config.annotation.WebSocketMessageBrokerConfigurer;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">@EnableWebSocketMessageBroker</span><br><span class="line">public class WebSocketConfig implements WebSocketMessageBrokerConfigurer &#123;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void configureMessageBroker(MessageBrokerRegistry config) &#123;</span><br><span class="line">        config.enableSimpleBroker(&quot;/topic&quot;, &quot;/queue&quot;);</span><br><span class="line">        config.setApplicationDestinationPrefixes(&quot;/app&quot;);</span><br><span class="line">        config.setUserDestinationPrefix(&quot;/user&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void registerStompEndpoints(StompEndpointRegistry registry) &#123;</span><br><span class="line">        registry.addEndpoint(&quot;/ws&quot;)</span><br><span class="line">                .setAllowedOriginPatterns(&quot;*&quot;)</span><br><span class="line">                .withSockJS();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>创建 <code>backend/src/main/java/com/kingdomdefense/config/WebSocketSecurityConfig.java</code>:</p>
<p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">package com.kingdomdefense.config;</span><br><span class="line"></span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.security.config.annotation.web.messaging.MessageSecurityMetadataSourceRegistry;</span><br><span class="line">import org.springframework.security.config.annotation.web.socket.AbstractSecurityWebSocketMessageBrokerConfigurer;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">public class WebSocketSecurityConfig extends AbstractSecurityWebSocketMessageBrokerConfigurer &#123;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    protected void configureInbound(MessageSecurityMetadataSourceRegistry messages) &#123;</span><br><span class="line">        messages</span><br><span class="line">            .simpDestMatchers(&quot;/app/**&quot;).authenticated()</span><br><span class="line">            .simpSubscribeDestMatchers(&quot;/topic/**&quot;, &quot;/queue/**&quot;).authenticated()</span><br><span class="line">            .anyMessage().authenticated();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    protected boolean sameOriginDisabled() &#123;</span><br><span class="line">        return true; // 禁用同源策略（生产环境应配置CORS）</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="11-2-创建多人游戏服务"><a href="#11-2-创建多人游戏服务" class="headerlink" title="11.2 创建多人游戏服务"></a>11.2 创建多人游戏服务</h4><p>创建 <code>backend/src/main/java/com/kingdomdefense/service/MultiplayerService.java</code>:</p>
<p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br></pre></td><td class="code"><pre><span class="line">package com.kingdomdefense.service;</span><br><span class="line"></span><br><span class="line">import com.kingdomdefense.model.*;</span><br><span class="line">import com.kingdomdefense.repository.*;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.messaging.simp.SimpMessagingTemplate;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">import java.time.LocalDateTime;</span><br><span class="line">import java.util.*;</span><br><span class="line">import java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line">@Service</span><br><span class="line">public class MultiplayerService &#123;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private SimpMessagingTemplate messagingTemplate;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private UserRepository userRepository;</span><br><span class="line">    </span><br><span class="line">    @Autowired</span><br><span class="line">    private GameSessionRepository gameSessionRepository;</span><br><span class="line">    </span><br><span class="line">    private final Map&lt;String, GameSession&gt; activeSessions = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    private final Map&lt;Long, String&gt; userSessionMap = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    public GameSession createSession(String sessionName, Long hostId, int maxPlayers) &#123;</span><br><span class="line">        Optional&lt;User&gt; hostOpt = userRepository.findById(hostId);</span><br><span class="line">        </span><br><span class="line">        if (hostOpt.isPresent()) &#123;</span><br><span class="line">            GameSession session = new GameSession();</span><br><span class="line">            session.setSessionId(UUID.randomUUID().toString());</span><br><span class="line">            session.setSessionName(sessionName);</span><br><span class="line">            session.setHost(hostOpt.get());</span><br><span class="line">            session.setMaxPlayers(maxPlayers);</span><br><span class="line">            session.setStatus(GameSessionStatus.WAITING);</span><br><span class="line">            session.setCreatedAt(LocalDateTime.now());</span><br><span class="line">            </span><br><span class="line">            // 添加主机到玩家列表</span><br><span class="line">            session.getPlayers().add(hostOpt.get());</span><br><span class="line">            </span><br><span class="line">            // 保存到数据库</span><br><span class="line">            gameSessionRepository.save(session);</span><br><span class="line">            </span><br><span class="line">            // 添加到活动会话</span><br><span class="line">            activeSessions.put(session.getSessionId(), session);</span><br><span class="line">            userSessionMap.put(hostId, session.getSessionId());</span><br><span class="line">            </span><br><span class="line">            // 广播新会话创建</span><br><span class="line">            broadcastSessionList();</span><br><span class="line">            </span><br><span class="line">            return session;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public boolean joinSession(String sessionId, Long userId) &#123;</span><br><span class="line">        GameSession session = activeSessions.get(sessionId);</span><br><span class="line">        Optional&lt;User&gt; userOpt = userRepository.findById(userId);</span><br><span class="line">        </span><br><span class="line">        if (session != null &amp;&amp; userOpt.isPresent() &amp;&amp; </span><br><span class="line">            session.getPlayers().size() &lt; session.getMaxPlayers() &amp;&amp;</span><br><span class="line">            session.getStatus() == GameSessionStatus.WAITING) &#123;</span><br><span class="line">            </span><br><span class="line">            User user = userOpt.get();</span><br><span class="line">            </span><br><span class="line">            // 检查是否已经加入</span><br><span class="line">            if (!session.getPlayers().contains(user)) &#123;</span><br><span class="line">                session.getPlayers().add(user);</span><br><span class="line">                userSessionMap.put(userId, sessionId);</span><br><span class="line">                </span><br><span class="line">                // 广播玩家加入</span><br><span class="line">                sendToSession(sessionId, &quot;/topic/session/update&quot;, session);</span><br><span class="line">                broadcastSessionList();</span><br><span class="line">                </span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public boolean leaveSession(Long userId) &#123;</span><br><span class="line">        String sessionId = userSessionMap.get(userId);</span><br><span class="line">        </span><br><span class="line">        if (sessionId != null) &#123;</span><br><span class="line">            GameSession session = activeSessions.get(sessionId);</span><br><span class="line">            </span><br><span class="line">            if (session != null) &#123;</span><br><span class="line">                Optional&lt;User&gt; userOpt = userRepository.findById(userId);</span><br><span class="line">                </span><br><span class="line">                if (userOpt.isPresent()) &#123;</span><br><span class="line">                    session.getPlayers().remove(userOpt.get());</span><br><span class="line">                    userSessionMap.remove(userId);</span><br><span class="line">                    </span><br><span class="line">                    // 如果会话为空，删除会话</span><br><span class="line">                    if (session.getPlayers().isEmpty()) &#123;</span><br><span class="line">                        activeSessions.remove(sessionId);</span><br><span class="line">                        gameSessionRepository.delete(session);</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        // 如果主机离开，转移主机</span><br><span class="line">                        if (session.getHost().getId().equals(userId) &amp;&amp; !session.getPlayers().isEmpty()) &#123;</span><br><span class="line">                            session.setHost(session.getPlayers().get(0));</span><br><span class="line">                        &#125;</span><br><span class="line">                        </span><br><span class="line">                        // 更新会话</span><br><span class="line">                        sendToSession(sessionId, &quot;/topic/session/update&quot;, session);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    broadcastSessionList();</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public boolean startSession(String sessionId, Long userId) &#123;</span><br><span class="line">        GameSession session = activeSessions.get(sessionId);</span><br><span class="line">        </span><br><span class="line">        if (session != null &amp;&amp; session.getHost().getId().equals(userId)) &#123;</span><br><span class="line">            session.setStatus(GameSessionStatus.PLAYING);</span><br><span class="line">            session.setStartedAt(LocalDateTime.now());</span><br><span class="line">            </span><br><span class="line">            // 初始化游戏状态</span><br><span class="line">            initMultiplayerGame(session);</span><br><span class="line">            </span><br><span class="line">            // 广播游戏开始</span><br><span class="line">            sendToSession(sessionId, &quot;/topic/game/start&quot;, session);</span><br><span class="line">            </span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void initMultiplayerGame(GameSession session) &#123;</span><br><span class="line">        // 初始化游戏地图和玩家位置</span><br><span class="line">        Map&lt;String, Object&gt; gameState = new HashMap&lt;&gt;();</span><br><span class="line">        gameState.put(&quot;map&quot;, generateMap());</span><br><span class="line">        gameState.put(&quot;players&quot;, assignPlayerPositions(session.getPlayers()));</span><br><span class="line">        gameState.put(&quot;wave&quot;, 1);</span><br><span class="line">        </span><br><span class="line">        session.setGameState(gameState);</span><br><span class="line">        gameSessionRepository.save(session);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private Map&lt;String, Object&gt; generateMap() &#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();</span><br><span class="line">        map.put(&quot;width&quot;, 1024);</span><br><span class="line">        map.put(&quot;height&quot;, 768);</span><br><span class="line">        map.put(&quot;paths&quot;, generatePaths());</span><br><span class="line">        map.put(&quot;buildableAreas&quot;, generateBuildableAreas());</span><br><span class="line">        return map;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private List&lt;Map&lt;String, Integer&gt;&gt; generatePaths() &#123;</span><br><span class="line">        List&lt;Map&lt;String, Integer&gt;&gt; paths = new ArrayList&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        // 生成多个路径（多人游戏）</span><br><span class="line">        for (int i = 0; i &lt; 4; i++) &#123;</span><br><span class="line">            List&lt;Map&lt;String, Integer&gt;&gt; path = new ArrayList&lt;&gt;();</span><br><span class="line">            int startX = -50;</span><br><span class="line">            int startY = 100 + i * 150;</span><br><span class="line">            </span><br><span class="line">            for (int j = 0; j &lt; 5; j++) &#123;</span><br><span class="line">                Map&lt;String, Integer&gt; point = new HashMap&lt;&gt;();</span><br><span class="line">                point.put(&quot;x&quot;, startX + j * 200);</span><br><span class="line">                point.put(&quot;y&quot;, startY + (j % 2 == 0 ? 0 : 100));</span><br><span class="line">                path.add(point);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            paths.addAll(path);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return paths;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private List&lt;Map&lt;String, Integer&gt;&gt; generateBuildableAreas() &#123;</span><br><span class="line">        List&lt;Map&lt;String, Integer&gt;&gt; areas = new ArrayList&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        // 生成可建造区域</span><br><span class="line">        for (int x = 50; x &lt; 1000; x += 150) &#123;</span><br><span class="line">            for (int y = 50; y &lt; 700; y += 150) &#123;</span><br><span class="line">                Map&lt;String, Integer&gt; area = new HashMap&lt;&gt;();</span><br><span class="line">                area.put(&quot;x&quot;, x);</span><br><span class="line">                area.put(&quot;y&quot;, y);</span><br><span class="line">                area.put(&quot;width&quot;, 100);</span><br><span class="line">                area.put(&quot;height&quot;, 100);</span><br><span class="line">                areas.add(area);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return areas;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private Map&lt;Long, Map&lt;String, Object&gt;&gt; assignPlayerPositions(List&lt;User&gt; players) &#123;</span><br><span class="line">        Map&lt;Long, Map&lt;String, Object&gt;&gt; positions = new HashMap&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        int startX = 100;</span><br><span class="line">        int startY = 100;</span><br><span class="line">        </span><br><span class="line">        for (int i = 0; i &lt; players.size(); i++) &#123;</span><br><span class="line">            User player = players.get(i);</span><br><span class="line">            Map&lt;String, Object&gt; position = new HashMap&lt;&gt;();</span><br><span class="line">            </span><br><span class="line">            position.put(&quot;x&quot;, startX + i * 250);</span><br><span class="line">            position.put(&quot;y&quot;, startY);</span><br><span class="line">            position.put(&quot;baseHealth&quot;, 1000);</span><br><span class="line">            position.put(&quot;resources&quot;, 500);</span><br><span class="line">            position.put(&quot;color&quot;, getPlayerColor(i));</span><br><span class="line">            </span><br><span class="line">            positions.put(player.getId(), position);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return positions;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private String getPlayerColor(int index) &#123;</span><br><span class="line">        String[] colors = &#123;&quot;#FF5252&quot;, &quot;#4CAF50&quot;, &quot;#2196F3&quot;, &quot;#FF9800&quot;&#125;;</span><br><span class="line">        return colors[index % colors.length];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void sendGameUpdate(String sessionId, GameUpdate update) &#123;</span><br><span class="line">        GameSession session = activeSessions.get(sessionId);</span><br><span class="line">        </span><br><span class="line">        if (session != null) &#123;</span><br><span class="line">            // 更新游戏状态</span><br><span class="line">            @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">            Map&lt;String, Object&gt; gameState = (Map&lt;String, Object&gt;) session.getGameState();</span><br><span class="line">            </span><br><span class="line">            if (gameState != null) &#123;</span><br><span class="line">                // 处理不同类型的更新</span><br><span class="line">                switch (update.getType()) &#123;</span><br><span class="line">                    case TOWER_BUILT:</span><br><span class="line">                        handleTowerBuilt(gameState, update);</span><br><span class="line">                        break;</span><br><span class="line">                    case ENEMY_SPAWNED:</span><br><span class="line">                        handleEnemySpawned(gameState, update);</span><br><span class="line">                        break;</span><br><span class="line">                    case ENEMY_DEFEATED:</span><br><span class="line">                        handleEnemyDefeated(gameState, update);</span><br><span class="line">                        break;</span><br><span class="line">                    case PLAYER_DAMAGED:</span><br><span class="line">                        handlePlayerDamaged(gameState, update);</span><br><span class="line">                        break;</span><br><span class="line">                    case WAVE_COMPLETE:</span><br><span class="line">                        handleWaveComplete(gameState, update);</span><br><span class="line">                        break;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                session.setGameState(gameState);</span><br><span class="line">                gameSessionRepository.save(session);</span><br><span class="line">                </span><br><span class="line">                // 广播更新给所有玩家</span><br><span class="line">                sendToSession(sessionId, &quot;/topic/game/update&quot;, update);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void handleTowerBuilt(Map&lt;String, Object&gt; gameState, GameUpdate update) &#123;</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; towers = (List&lt;Map&lt;String, Object&gt;&gt;) </span><br><span class="line">            gameState.getOrDefault(&quot;towers&quot;, new ArrayList&lt;&gt;());</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, Object&gt; towerData = (Map&lt;String, Object&gt;) update.getData().get(&quot;tower&quot;);</span><br><span class="line">        towers.add(towerData);</span><br><span class="line">        </span><br><span class="line">        gameState.put(&quot;towers&quot;, towers);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void handleEnemySpawned(Map&lt;String, Object&gt; gameState, GameUpdate update) &#123;</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; enemies = (List&lt;Map&lt;String, Object&gt;&gt;) </span><br><span class="line">            gameState.getOrDefault(&quot;enemies&quot;, new ArrayList&lt;&gt;());</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, Object&gt; enemyData = (Map&lt;String, Object&gt;) update.getData().get(&quot;enemy&quot;);</span><br><span class="line">        enemies.add(enemyData);</span><br><span class="line">        </span><br><span class="line">        gameState.put(&quot;enemies&quot;, enemies);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void handleEnemyDefeated(Map&lt;String, Object&gt; gameState, GameUpdate update) &#123;</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; enemies = (List&lt;Map&lt;String, Object&gt;&gt;) </span><br><span class="line">            gameState.getOrDefault(&quot;enemies&quot;, new ArrayList&lt;&gt;());</span><br><span class="line">        </span><br><span class="line">        Long enemyId = (Long) update.getData().get(&quot;enemyId&quot;);</span><br><span class="line">        enemies.removeIf(enemy -&gt; enemyId.equals(enemy.get(&quot;id&quot;)));</span><br><span class="line">        </span><br><span class="line">        gameState.put(&quot;enemies&quot;, enemies);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void handlePlayerDamaged(Map&lt;String, Object&gt; gameState, GameUpdate update) &#123;</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">        Map&lt;String, Object&gt; players = (Map&lt;String, Object&gt;) </span><br><span class="line">            gameState.get(&quot;players&quot;);</span><br><span class="line">        </span><br><span class="line">        Long playerId = (Long) update.getData().get(&quot;playerId&quot;);</span><br><span class="line">        int damage = (int) update.getData().get(&quot;damage&quot;);</span><br><span class="line">        </span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">        Map&lt;String, Object&gt; playerState = (Map&lt;String, Object&gt;) players.get(playerId.toString());</span><br><span class="line">        </span><br><span class="line">        if (playerState != null) &#123;</span><br><span class="line">            int currentHealth = (int) playerState.getOrDefault(&quot;baseHealth&quot;, 1000);</span><br><span class="line">            playerState.put(&quot;baseHealth&quot;, Math.max(0, currentHealth - damage));</span><br><span class="line">            </span><br><span class="line">            // 检查游戏结束</span><br><span class="line">            if (currentHealth - damage &lt;= 0) &#123;</span><br><span class="line">                handlePlayerDefeated(gameState, playerId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void handlePlayerDefeated(Map&lt;String, Object&gt; gameState, Long playerId) &#123;</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">        Map&lt;String, Object&gt; players = (Map&lt;String, Object&gt;) gameState.get(&quot;players&quot;);</span><br><span class="line">        players.remove(playerId.toString());</span><br><span class="line">        </span><br><span class="line">        // 检查游戏是否结束（只剩一个玩家或没有玩家）</span><br><span class="line">        if (players.size() &lt;= 1) &#123;</span><br><span class="line">            endGameSession((String) gameState.get(&quot;sessionId&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void handleWaveComplete(Map&lt;String, Object&gt; gameState, GameUpdate update) &#123;</span><br><span class="line">        int currentWave = (int) gameState.getOrDefault(&quot;wave&quot;, 1);</span><br><span class="line">        gameState.put(&quot;wave&quot;, currentWave + 1);</span><br><span class="line">        </span><br><span class="line">        // 给予奖励</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">        Map&lt;String, Object&gt; players = (Map&lt;String, Object&gt;) gameState.get(&quot;players&quot;);</span><br><span class="line">        </span><br><span class="line">        for (Object playerObj : players.values()) &#123;</span><br><span class="line">            @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">            Map&lt;String, Object&gt; player = (Map&lt;String, Object&gt;) playerObj;</span><br><span class="line">            int resources = (int) player.getOrDefault(&quot;resources&quot;, 0);</span><br><span class="line">            player.put(&quot;resources&quot;, resources + 100 * currentWave);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void endGameSession(String sessionId) &#123;</span><br><span class="line">        GameSession session = activeSessions.get(sessionId);</span><br><span class="line">        </span><br><span class="line">        if (session != null) &#123;</span><br><span class="line">            session.setStatus(GameSessionStatus.FINISHED);</span><br><span class="line">            session.setFinishedAt(LocalDateTime.now());</span><br><span class="line">            </span><br><span class="line">            // 计算分数和奖励</span><br><span class="line">            calculateScores(session);</span><br><span class="line">            </span><br><span class="line">            // 广播游戏结束</span><br><span class="line">            sendToSession(sessionId, &quot;/topic/game/end&quot;, session);</span><br><span class="line">            </span><br><span class="line">            // 清理会话</span><br><span class="line">            for (User player : session.getPlayers()) &#123;</span><br><span class="line">                userSessionMap.remove(player.getId());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            activeSessions.remove(sessionId);</span><br><span class="line">            gameSessionRepository.save(session);</span><br><span class="line">            </span><br><span class="line">            broadcastSessionList();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void calculateScores(GameSession session) &#123;</span><br><span class="line">        // 根据游戏表现计算分数</span><br><span class="line">        // 这里简化处理，实际应该根据杀敌数、生存时间等计算</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">        Map&lt;String, Object&gt; gameState = (Map&lt;String, Object&gt;) session.getGameState();</span><br><span class="line">        </span><br><span class="line">        if (gameState != null) &#123;</span><br><span class="line">            @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">            Map&lt;String, Object&gt; players = (Map&lt;String, Object&gt;) gameState.get(&quot;players&quot;);</span><br><span class="line">            </span><br><span class="line">            for (User player : session.getPlayers()) &#123;</span><br><span class="line">                int score = 1000; // 基础分数</span><br><span class="line">                </span><br><span class="line">                // 根据杀敌数增加分数</span><br><span class="line">                int kills = (int) gameState.getOrDefault(player.getId() + &quot;_kills&quot;, 0);</span><br><span class="line">                score += kills * 100;</span><br><span class="line">                </span><br><span class="line">                // 根据生存波次增加分数</span><br><span class="line">                int wave = (int) gameState.getOrDefault(&quot;wave&quot;, 1);</span><br><span class="line">                score += (wave - 1) * 500;</span><br><span class="line">                </span><br><span class="line">                // 保存分数</span><br><span class="line">                savePlayerScore(player, score, session);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void savePlayerScore(User player, int score, GameSession session) &#123;</span><br><span class="line">        GameScore gameScore = new GameScore();</span><br><span class="line">        gameScore.setUser(player);</span><br><span class="line">        gameScore.setScore(score);</span><br><span class="line">        gameScore.setWaveReached((Integer) session.getGameState().getOrDefault(&quot;wave&quot;, 1));</span><br><span class="line">        gameScore.setGameDate(LocalDateTime.now());</span><br><span class="line">        </span><br><span class="line">        // 这里应该调用ScoreService保存分数</span><br><span class="line">        // 为了简化，直接更新用户最高分</span><br><span class="line">        if (score &gt; player.getHighScore()) &#123;</span><br><span class="line">            player.setHighScore(score);</span><br><span class="line">            userRepository.save(player);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public List&lt;GameSession&gt; getAvailableSessions() &#123;</span><br><span class="line">        return new ArrayList&lt;&gt;(activeSessions.values());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void sendToSession(String sessionId, String destination, Object payload) &#123;</span><br><span class="line">        messagingTemplate.convertAndSend(destination + &quot;/&quot; + sessionId, payload);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void broadcastSessionList() &#123;</span><br><span class="line">        messagingTemplate.convertAndSend(&quot;/topic/sessions/list&quot;, getAvailableSessions());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 游戏会话实体</span><br><span class="line">@Entity</span><br><span class="line">@Table(name = &quot;game_sessions&quot;)</span><br><span class="line">class GameSession &#123;</span><br><span class="line">    @Id</span><br><span class="line">    private String sessionId;</span><br><span class="line">    </span><br><span class="line">    private String sessionName;</span><br><span class="line">    </span><br><span class="line">    @ManyToOne</span><br><span class="line">    @JoinColumn(name = &quot;host_id&quot;)</span><br><span class="line">    private User host;</span><br><span class="line">    </span><br><span class="line">    @ManyToMany</span><br><span class="line">    @JoinTable(</span><br><span class="line">        name = &quot;session_players&quot;,</span><br><span class="line">        joinColumns = @JoinColumn(name = &quot;session_id&quot;),</span><br><span class="line">        inverseJoinColumns = @JoinColumn(name = &quot;user_id&quot;)</span><br><span class="line">    )</span><br><span class="line">    private List&lt;User&gt; players = new ArrayList&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    private int maxPlayers;</span><br><span class="line">    </span><br><span class="line">    @Enumerated(EnumType.STRING)</span><br><span class="line">    private GameSessionStatus status;</span><br><span class="line">    </span><br><span class="line">    @Column(columnDefinition = &quot;JSON&quot;)</span><br><span class="line">    private Map&lt;String, Object&gt; gameState;</span><br><span class="line">    </span><br><span class="line">    private LocalDateTime createdAt;</span><br><span class="line">    private LocalDateTime startedAt;</span><br><span class="line">    private LocalDateTime finishedAt;</span><br><span class="line">    </span><br><span class="line">    // Getters and Setters</span><br><span class="line">    // ... 省略getter和setter方法</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">enum GameSessionStatus &#123;</span><br><span class="line">    WAITING, PLAYING, FINISHED</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 游戏更新消息</span><br><span class="line">class GameUpdate &#123;</span><br><span class="line">    private GameUpdateType type;</span><br><span class="line">    private Map&lt;String, Object&gt; data;</span><br><span class="line">    private Long senderId;</span><br><span class="line">    private LocalDateTime timestamp;</span><br><span class="line">    </span><br><span class="line">    public enum GameUpdateType &#123;</span><br><span class="line">        TOWER_BUILT,</span><br><span class="line">        ENEMY_SPAWNED,</span><br><span class="line">        ENEMY_DEFEATED,</span><br><span class="line">        PLAYER_DAMAGED,</span><br><span class="line">        WAVE_COMPLETE,</span><br><span class="line">        PLAYER_JOINED,</span><br><span class="line">        PLAYER_LEFT</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Getters and Setters</span><br><span class="line">    // ... 省略getter和setter方法</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="第十三阶段：Python-AI引擎增强（第10周）"><a href="#第十三阶段：Python-AI引擎增强（第10周）" class="headerlink" title="第十三阶段：Python AI引擎增强（第10周）"></a>第十三阶段：Python AI引擎增强（第10周）</h2><h3 id="步骤12：实现深度学习敌人AI和游戏平衡"><a href="#步骤12：实现深度学习敌人AI和游戏平衡" class="headerlink" title="步骤12：实现深度学习敌人AI和游戏平衡"></a>步骤12：实现深度学习敌人AI和游戏平衡</h3><h4 id="12-1-使用深度学习预测玩家行为"><a href="#12-1-使用深度学习预测玩家行为" class="headerlink" title="12.1 使用深度学习预测玩家行为"></a>12.1 使用深度学习预测玩家行为</h4><p>创建 <code>ai-engine/game_ai/deep_learning_ai.py</code>:</p>
<p>python</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br></pre></td><td class="code"><pre><span class="line">import numpy as np</span><br><span class="line">import tensorflow as tf</span><br><span class="line">from tensorflow import keras</span><br><span class="line">from tensorflow.keras import layers</span><br><span class="line">from collections import deque</span><br><span class="line">import random</span><br><span class="line">import json</span><br><span class="line">import pickle</span><br><span class="line"></span><br><span class="line">class DeepLearningAI:</span><br><span class="line">    def __init__(self, state_size=24, action_size=8, model_path=None):</span><br><span class="line">        self.state_size = state_size</span><br><span class="line">        self.action_size = action_size</span><br><span class="line">        self.memory = deque(maxlen=2000)</span><br><span class="line">        self.gamma = 0.95  # 折扣因子</span><br><span class="line">        self.epsilon = 1.0  # 探索率</span><br><span class="line">        self.epsilon_min = 0.01</span><br><span class="line">        self.epsilon_decay = 0.995</span><br><span class="line">        self.learning_rate = 0.001</span><br><span class="line">        </span><br><span class="line">        # 创建模型</span><br><span class="line">        if model_path and os.path.exists(model_path):</span><br><span class="line">            self.model = self.load_model(model_path)</span><br><span class="line">        else:</span><br><span class="line">            self.model = self.build_model()</span><br><span class="line">            </span><br><span class="line">        self.target_model = self.build_model()</span><br><span class="line">        self.update_target_model()</span><br><span class="line">        </span><br><span class="line">    def build_model(self):</span><br><span class="line">        &quot;&quot;&quot;构建深度Q网络模型&quot;&quot;&quot;</span><br><span class="line">        model = keras.Sequential([</span><br><span class="line">            layers.Dense(128, input_dim=self.state_size, activation=&#x27;relu&#x27;),</span><br><span class="line">            layers.BatchNormalization(),</span><br><span class="line">            layers.Dropout(0.3),</span><br><span class="line">            </span><br><span class="line">            layers.Dense(128, activation=&#x27;relu&#x27;),</span><br><span class="line">            layers.BatchNormalization(),</span><br><span class="line">            layers.Dropout(0.3),</span><br><span class="line">            </span><br><span class="line">            layers.Dense(64, activation=&#x27;relu&#x27;),</span><br><span class="line">            layers.BatchNormalization(),</span><br><span class="line">            layers.Dropout(0.3),</span><br><span class="line">            </span><br><span class="line">            layers.Dense(self.action_size, activation=&#x27;linear&#x27;)</span><br><span class="line">        ])</span><br><span class="line">        </span><br><span class="line">        model.compile(</span><br><span class="line">            loss=&#x27;mse&#x27;,</span><br><span class="line">            optimizer=keras.optimizers.Adam(learning_rate=self.learning_rate),</span><br><span class="line">            metrics=[&#x27;accuracy&#x27;]</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        return model</span><br><span class="line">    </span><br><span class="line">    def update_target_model(self):</span><br><span class="line">        &quot;&quot;&quot;更新目标网络&quot;&quot;&quot;</span><br><span class="line">        self.target_model.set_weights(self.model.get_weights())</span><br><span class="line">    </span><br><span class="line">    def remember(self, state, action, reward, next_state, done):</span><br><span class="line">        &quot;&quot;&quot;存储经验到记忆库&quot;&quot;&quot;</span><br><span class="line">        self.memory.append((state, action, reward, next_state, done))</span><br><span class="line">    </span><br><span class="line">    def act(self, state, training=True):</span><br><span class="line">        &quot;&quot;&quot;根据当前状态选择动作&quot;&quot;&quot;</span><br><span class="line">        if training and np.random.rand() &lt;= self.epsilon:</span><br><span class="line">            # 探索：随机选择动作</span><br><span class="line">            return random.randrange(self.action_size)</span><br><span class="line">        </span><br><span class="line">        # 利用：使用模型预测最佳动作</span><br><span class="line">        state = np.array(state).reshape(1, -1)</span><br><span class="line">        act_values = self.model.predict(state, verbose=0)</span><br><span class="line">        return np.argmax(act_values[0])</span><br><span class="line">    </span><br><span class="line">    def replay(self, batch_size=32):</span><br><span class="line">        &quot;&quot;&quot;从记忆库中学习&quot;&quot;&quot;</span><br><span class="line">        if len(self.memory) &lt; batch_size:</span><br><span class="line">            return</span><br><span class="line">        </span><br><span class="line">        # 随机采样一批经验</span><br><span class="line">        minibatch = random.sample(self.memory, batch_size)</span><br><span class="line">        </span><br><span class="line">        states = np.array([experience[0] for experience in minibatch])</span><br><span class="line">        actions = np.array([experience[1] for experience in minibatch])</span><br><span class="line">        rewards = np.array([experience[2] for experience in minibatch])</span><br><span class="line">        next_states = np.array([experience[3] for experience in minibatch])</span><br><span class="line">        dones = np.array([experience[4] for experience in minibatch])</span><br><span class="line">        </span><br><span class="line">        # 计算目标Q值</span><br><span class="line">        targets = self.model.predict(states, verbose=0)</span><br><span class="line">        next_q_values = self.target_model.predict(next_states, verbose=0)</span><br><span class="line">        </span><br><span class="line">        for i in range(batch_size):</span><br><span class="line">            if dones[i]:</span><br><span class="line">                targets[i][actions[i]] = rewards[i]</span><br><span class="line">            else:</span><br><span class="line">                targets[i][actions[i]] = rewards[i] + self.gamma * np.max(next_q_values[i])</span><br><span class="line">        </span><br><span class="line">        # 训练模型</span><br><span class="line">        self.model.fit(states, targets, epochs=1, verbose=0)</span><br><span class="line">        </span><br><span class="line">        # 衰减探索率</span><br><span class="line">        if self.epsilon &gt; self.epsilon_min:</span><br><span class="line">            self.epsilon *= self.epsilon_decay</span><br><span class="line">    </span><br><span class="line">    def get_state(self, game_data):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        从游戏数据中提取状态向量</span><br><span class="line">        game_data包含：玩家位置、塔信息、敌人信息、资源等</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        state = []</span><br><span class="line">        </span><br><span class="line">        # 玩家特征（4维）</span><br><span class="line">        state.extend([</span><br><span class="line">            game_data.get(&#x27;player_x&#x27;, 0) / 1024,  # 归一化x坐标</span><br><span class="line">            game_data.get(&#x27;player_y&#x27;, 0) / 768,   # 归一化y坐标</span><br><span class="line">            game_data.get(&#x27;player_health&#x27;, 100) / 1000,  # 归一化生命值</span><br><span class="line">            game_data.get(&#x27;player_resources&#x27;, 0) / 1000  # 归一化资源</span><br><span class="line">        ])</span><br><span class="line">        </span><br><span class="line">        # 塔特征（8维）</span><br><span class="line">        towers = game_data.get(&#x27;towers&#x27;, [])</span><br><span class="line">        tower_features = [0] * 8</span><br><span class="line">        </span><br><span class="line">        for i, tower in enumerate(towers[:4]):  # 只考虑最近的4座塔</span><br><span class="line">            tower_features[i*2] = tower.get(&#x27;x&#x27;, 0) / 1024</span><br><span class="line">            tower_features[i*2+1] = tower.get(&#x27;y&#x27;, 0) / 768</span><br><span class="line">        </span><br><span class="line">        state.extend(tower_features)</span><br><span class="line">        </span><br><span class="line">        # 敌人特征（8维）</span><br><span class="line">        enemies = game_data.get(&#x27;enemies&#x27;, [])</span><br><span class="line">        enemy_features = [0] * 8</span><br><span class="line">        </span><br><span class="line">        for i, enemy in enumerate(enemies[:4]):  # 只考虑最近的4个敌人</span><br><span class="line">            enemy_features[i*2] = enemy.get(&#x27;x&#x27;, 0) / 1024</span><br><span class="line">            enemy_features[i*2+1] = enemy.get(&#x27;health&#x27;, 100) / 500</span><br><span class="line">        </span><br><span class="line">        state.extend(enemy_features)</span><br><span class="line">        </span><br><span class="line">        # 游戏状态特征（4维）</span><br><span class="line">        state.extend([</span><br><span class="line">            game_data.get(&#x27;wave&#x27;, 1) / 20,  # 归一化波次</span><br><span class="line">            len(towers) / 20,  # 塔的数量</span><br><span class="line">            len(enemies) / 50,  # 敌人的数量</span><br><span class="line">            game_data.get(&#x27;time_elapsed&#x27;, 0) / 600  # 归一化时间（10分钟）</span><br><span class="line">        ])</span><br><span class="line">        </span><br><span class="line">        # 确保状态向量长度正确</span><br><span class="line">        if len(state) &lt; self.state_size:</span><br><span class="line">            state.extend([0] * (self.state_size - len(state)))</span><br><span class="line">        </span><br><span class="line">        return np.array(state[:self.state_size])</span><br><span class="line">    </span><br><span class="line">    def get_reward(self, old_state, new_state, action, done):</span><br><span class="line">        &quot;&quot;&quot;计算奖励值&quot;&quot;&quot;</span><br><span class="line">        reward = 0</span><br><span class="line">        </span><br><span class="line">        if done:</span><br><span class="line">            # 游戏结束的奖励/惩罚</span><br><span class="line">            if new_state[2] &lt;= 0:  # 玩家生命值耗尽</span><br><span class="line">                reward = -100</span><br><span class="line">            else:</span><br><span class="line">                reward = 100  # 生存到最后</span><br><span class="line">        else:</span><br><span class="line">            # 生存奖励</span><br><span class="line">            reward = 1</span><br><span class="line">            </span><br><span class="line">            # 杀敌奖励</span><br><span class="line">            old_enemy_health = sum(old_state[16:20])  # 敌人生命值特征</span><br><span class="line">            new_enemy_health = sum(new_state[16:20])</span><br><span class="line">            if new_enemy_health &lt; old_enemy_health:</span><br><span class="line">                reward += (old_enemy_health - new_enemy_health) * 10</span><br><span class="line">            </span><br><span class="line">            # 资源奖励</span><br><span class="line">            resource_change = new_state[3] - old_state[3]</span><br><span class="line">            if resource_change &gt; 0:</span><br><span class="line">                reward += resource_change * 5</span><br><span class="line">            </span><br><span class="line">            # 塔保护奖励</span><br><span class="line">            tower_count_change = new_state[20] - old_state[20]</span><br><span class="line">            if tower_count_change &gt; 0:</span><br><span class="line">                reward += tower_count_change * 20</span><br><span class="line">            elif tower_count_change &lt; 0:</span><br><span class="line">                reward += tower_count_change * 30  # 塔被摧毁的惩罚</span><br><span class="line">        </span><br><span class="line">        return reward</span><br><span class="line">    </span><br><span class="line">    def map_action_to_game(self, action):</span><br><span class="line">        &quot;&quot;&quot;将动作索引映射到游戏中的具体行为&quot;&quot;&quot;</span><br><span class="line">        actions = [</span><br><span class="line">            &#123;&#x27;type&#x27;: &#x27;move&#x27;, &#x27;dx&#x27;: 1, &#x27;dy&#x27;: 0&#125;,    # 向右移动</span><br><span class="line">            &#123;&#x27;type&#x27;: &#x27;move&#x27;, &#x27;dx&#x27;: -1, &#x27;dy&#x27;: 0&#125;,   # 向左移动</span><br><span class="line">            &#123;&#x27;type&#x27;: &#x27;move&#x27;, &#x27;dx&#x27;: 0, &#x27;dy&#x27;: 1&#125;,    # 向下移动</span><br><span class="line">            &#123;&#x27;type&#x27;: &#x27;move&#x27;, &#x27;dx&#x27;: 0, &#x27;dy&#x27;: -1&#125;,   # 向上移动</span><br><span class="line">            &#123;&#x27;type&#x27;: &#x27;build&#x27;, &#x27;tower_type&#x27;: &#x27;arrow&#x27;&#125;,    # 建造弓箭塔</span><br><span class="line">            &#123;&#x27;type&#x27;: &#x27;build&#x27;, &#x27;tower_type&#x27;: &#x27;cannon&#x27;&#125;,   # 建造炮塔</span><br><span class="line">            &#123;&#x27;type&#x27;: &#x27;upgrade&#x27;, &#x27;target&#x27;: &#x27;nearest&#x27;&#125;,    # 升级最近塔</span><br><span class="line">            &#123;&#x27;type&#x27;: &#x27;skill&#x27;, &#x27;skill_type&#x27;: &#x27;lightning&#x27;&#125; # 使用闪电技能</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        return actions[action % len(actions)]</span><br><span class="line">    </span><br><span class="line">    def train(self, game_data_generator, episodes=1000):</span><br><span class="line">        &quot;&quot;&quot;训练AI&quot;&quot;&quot;</span><br><span class="line">        for episode in range(episodes):</span><br><span class="line">            # 重置游戏环境</span><br><span class="line">            game_data = game_data_generator.reset()</span><br><span class="line">            state = self.get_state(game_data)</span><br><span class="line">            </span><br><span class="line">            total_reward = 0</span><br><span class="line">            done = False</span><br><span class="line">            step = 0</span><br><span class="line">            </span><br><span class="line">            while not done and step &lt; 1000:  # 最大步数限制</span><br><span class="line">                # 选择动作</span><br><span class="line">                action = self.act(state)</span><br><span class="line">                </span><br><span class="line">                # 执行动作并获取新状态</span><br><span class="line">                game_action = self.map_action_to_game(action)</span><br><span class="line">                new_game_data = game_data_generator.step(game_action)</span><br><span class="line">                next_state = self.get_state(new_game_data)</span><br><span class="line">                </span><br><span class="line">                # 检查是否结束</span><br><span class="line">                done = new_game_data.get(&#x27;game_over&#x27;, False)</span><br><span class="line">                </span><br><span class="line">                # 计算奖励</span><br><span class="line">                reward = self.get_reward(state, next_state, action, done)</span><br><span class="line">                total_reward += reward</span><br><span class="line">                </span><br><span class="line">                # 记住经验</span><br><span class="line">                self.remember(state, action, reward, next_state, done)</span><br><span class="line">                </span><br><span class="line">                # 更新状态</span><br><span class="line">                state = next_state</span><br><span class="line">                game_data = new_game_data</span><br><span class="line">                </span><br><span class="line">                # 经验回放</span><br><span class="line">                self.replay()</span><br><span class="line">                </span><br><span class="line">                step += 1</span><br><span class="line">            </span><br><span class="line">            # 每10轮更新一次目标网络</span><br><span class="line">            if episode % 10 == 0:</span><br><span class="line">                self.update_target_model()</span><br><span class="line">            </span><br><span class="line">            # 每100轮保存一次模型</span><br><span class="line">            if episode % 100 == 0:</span><br><span class="line">                self.save_model(f&#x27;models/ai_model_episode_&#123;episode&#125;.h5&#x27;)</span><br><span class="line">            </span><br><span class="line">            print(f&quot;Episode: &#123;episode&#125;/&#123;episodes&#125;, Total Reward: &#123;total_reward:.2f&#125;, Epsilon: &#123;self.epsilon:.4f&#125;&quot;)</span><br><span class="line">    </span><br><span class="line">    def save_model(self, path):</span><br><span class="line">        &quot;&quot;&quot;保存模型&quot;&quot;&quot;</span><br><span class="line">        self.model.save(path)</span><br><span class="line">        </span><br><span class="line">        # 保存训练参数</span><br><span class="line">        params = &#123;</span><br><span class="line">            &#x27;epsilon&#x27;: self.epsilon,</span><br><span class="line">            &#x27;memory&#x27;: list(self.memory)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        with open(path.replace(&#x27;.h5&#x27;, &#x27;_params.pkl&#x27;), &#x27;wb&#x27;) as f:</span><br><span class="line">            pickle.dump(params, f)</span><br><span class="line">    </span><br><span class="line">    def load_model(self, path):</span><br><span class="line">        &quot;&quot;&quot;加载模型&quot;&quot;&quot;</span><br><span class="line">        model = keras.models.load_model(path)</span><br><span class="line">        </span><br><span class="line">        # 加载训练参数</span><br><span class="line">        params_path = path.replace(&#x27;.h5&#x27;, &#x27;_params.pkl&#x27;)</span><br><span class="line">        if os.path.exists(params_path):</span><br><span class="line">            with open(params_path, &#x27;rb&#x27;) as f:</span><br><span class="line">                params = pickle.load(f)</span><br><span class="line">                self.epsilon = params.get(&#x27;epsilon&#x27;, self.epsilon)</span><br><span class="line">                self.memory = deque(params.get(&#x27;memory&#x27;, []), maxlen=2000)</span><br><span class="line">        </span><br><span class="line">        return model</span><br><span class="line">    </span><br><span class="line">    def predict_player_strategy(self, game_history, current_state):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        预测玩家策略</span><br><span class="line">        game_history: 玩家历史游戏数据列表</span><br><span class="line">        current_state: 当前游戏状态</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        # 使用LSTM分析玩家行为模式</span><br><span class="line">        if len(game_history) &lt; 10:</span><br><span class="line">            return &quot;aggressive&quot;  # 默认策略</span><br><span class="line">        </span><br><span class="line">        # 提取特征序列</span><br><span class="line">        sequences = []</span><br><span class="line">        for game_data in game_history[-10:]:</span><br><span class="line">            sequences.append(self.get_state(game_data))</span><br><span class="line">        </span><br><span class="line">        sequences = np.array(sequences).reshape(1, 10, self.state_size)</span><br><span class="line">        </span><br><span class="line">        # 使用预训练的LSTM模型（这里简化处理）</span><br><span class="line">        # 实际应该训练一个专门的策略预测模型</span><br><span class="line">        strategies = [&quot;aggressive&quot;, &quot;defensive&quot;, &quot;economic&quot;, &quot;balanced&quot;]</span><br><span class="line">        </span><br><span class="line">        # 简单分析：根据塔数量和资源消耗判断策略</span><br><span class="line">        tower_count = current_state[20] * 20  # 反归一化</span><br><span class="line">        resource_usage = current_state[3] * 1000  # 反归一化</span><br><span class="line">        </span><br><span class="line">        if tower_count &gt; 15:</span><br><span class="line">            return &quot;defensive&quot;</span><br><span class="line">        elif resource_usage &lt; 200:</span><br><span class="line">            return &quot;economic&quot;</span><br><span class="line">        elif tower_count &lt; 5:</span><br><span class="line">            return &quot;aggressive&quot;</span><br><span class="line">        else:</span><br><span class="line">            return &quot;balanced&quot;</span><br><span class="line">    </span><br><span class="line">    def adapt_difficulty(self, player_strategy, current_difficulty):</span><br><span class="line">        &quot;&quot;&quot;根据玩家策略调整难度&quot;&quot;&quot;</span><br><span class="line">        strategy_multipliers = &#123;</span><br><span class="line">            &quot;aggressive&quot;: 1.2,    # 激进玩家，增加难度</span><br><span class="line">            &quot;defensive&quot;: 0.9,     # 防御玩家，降低难度</span><br><span class="line">            &quot;economic&quot;: 1.1,      # 经济型玩家，中等难度</span><br><span class="line">            &quot;balanced&quot;: 1.0       # 平衡型玩家，标准难度</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        multiplier = strategy_multipliers.get(player_strategy, 1.0)</span><br><span class="line">        new_difficulty = current_difficulty * multiplier</span><br><span class="line">        </span><br><span class="line">        # 限制难度范围</span><br><span class="line">        return max(0.5, min(new_difficulty, 3.0))</span><br></pre></td></tr></table></figure>



<h4 id="12-2-游戏平衡分析系统"><a href="#12-2-游戏平衡分析系统" class="headerlink" title="12.2 游戏平衡分析系统"></a>12.2 游戏平衡分析系统</h4><p>创建 <code>ai-engine/analysis/game_balance_analyzer.py</code>:</p>
<p>python</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br></pre></td><td class="code"><pre><span class="line">import numpy as np</span><br><span class="line">import pandas as pd</span><br><span class="line">from sklearn.ensemble import RandomForestRegressor</span><br><span class="line">from sklearn.model_selection import train_test_split</span><br><span class="line">import matplotlib.pyplot as plt</span><br><span class="line">import seaborn as sns</span><br><span class="line">from scipy import stats</span><br><span class="line"></span><br><span class="line">class GameBalanceAnalyzer:</span><br><span class="line">    def __init__(self):</span><br><span class="line">        self.game_data = []</span><br><span class="line">        self.metrics = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">    def collect_game_data(self, game_result):</span><br><span class="line">        &quot;&quot;&quot;收集游戏结果数据&quot;&quot;&quot;</span><br><span class="line">        self.game_data.append(game_result)</span><br><span class="line">        </span><br><span class="line">    def analyze_balance(self):</span><br><span class="line">        &quot;&quot;&quot;分析游戏平衡性&quot;&quot;&quot;</span><br><span class="line">        if len(self.game_data) &lt; 50:</span><br><span class="line">            print(&quot;需要更多游戏数据进行分析（至少50场）&quot;)</span><br><span class="line">            return None</span><br><span class="line">        </span><br><span class="line">        df = pd.DataFrame(self.game_data)</span><br><span class="line">        </span><br><span class="line">        # 计算各项指标</span><br><span class="line">        metrics = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        # 1. 胜率分析</span><br><span class="line">        win_rate = df[&#x27;won&#x27;].mean()</span><br><span class="line">        metrics[&#x27;win_rate&#x27;] = win_rate</span><br><span class="line">        </span><br><span class="line">        # 2. 游戏时长分析</span><br><span class="line">        avg_game_time = df[&#x27;game_time&#x27;].mean()</span><br><span class="line">        metrics[&#x27;avg_game_time&#x27;] = avg_game_time</span><br><span class="line">        </span><br><span class="line">        # 3. 资源效率分析</span><br><span class="line">        avg_resource_efficiency = df[&#x27;final_score&#x27;] / df[&#x27;resources_spent&#x27;].mean()</span><br><span class="line">        metrics[&#x27;avg_resource_efficiency&#x27;] = avg_resource_efficiency</span><br><span class="line">        </span><br><span class="line">        # 4. 塔使用率分析</span><br><span class="line">        tower_usage = &#123;&#125;</span><br><span class="line">        for tower_type in [&#x27;arrow&#x27;, &#x27;cannon&#x27;, &#x27;magic&#x27;, &#x27;barracks&#x27;]:</span><br><span class="line">            tower_usage[tower_type] = df[f&#x27;&#123;tower_type&#125;_count&#x27;].mean()</span><br><span class="line">        metrics[&#x27;tower_usage&#x27;] = tower_usage</span><br><span class="line">        </span><br><span class="line">        # 5. 敌人击杀分布</span><br><span class="line">        enemy_kills = &#123;&#125;</span><br><span class="line">        for enemy_type in [&#x27;infantry&#x27;, &#x27;cavalry&#x27;, &#x27;armored&#x27;, &#x27;flying&#x27;, &#x27;boss&#x27;]:</span><br><span class="line">            enemy_kills[enemy_type] = df[f&#x27;&#123;enemy_type&#125;_kills&#x27;].mean()</span><br><span class="line">        metrics[&#x27;enemy_kills&#x27;] = enemy_kills</span><br><span class="line">        </span><br><span class="line">        # 6. 波次进度分析</span><br><span class="line">        avg_wave = df[&#x27;max_wave&#x27;].mean()</span><br><span class="line">        metrics[&#x27;avg_wave&#x27;] = avg_wave</span><br><span class="line">        </span><br><span class="line">        # 7. 技能使用效果</span><br><span class="line">        skill_efficiency = &#123;&#125;</span><br><span class="line">        for skill in [&#x27;lightning&#x27;, &#x27;heal&#x27;, &#x27;meteor&#x27;, &#x27;freeze&#x27;]:</span><br><span class="line">            skill_efficiency[skill] = df[f&#x27;&#123;skill&#125;_damage&#x27;].mean() / df[f&#x27;&#123;skill&#125;_uses&#x27;].mean()</span><br><span class="line">        metrics[&#x27;skill_efficiency&#x27;] = skill_efficiency</span><br><span class="line">        </span><br><span class="line">        self.metrics = metrics</span><br><span class="line">        return metrics</span><br><span class="line">    </span><br><span class="line">    def identify_balance_issues(self):</span><br><span class="line">        &quot;&quot;&quot;识别游戏平衡问题&quot;&quot;&quot;</span><br><span class="line">        issues = []</span><br><span class="line">        </span><br><span class="line">        # 检查胜率是否平衡</span><br><span class="line">        if self.metrics.get(&#x27;win_rate&#x27;, 0.5) &lt; 0.4 or self.metrics.get(&#x27;win_rate&#x27;, 0.5) &gt; 0.6:</span><br><span class="line">            issues.append(&#123;</span><br><span class="line">                &#x27;type&#x27;: &#x27;win_rate&#x27;,</span><br><span class="line">                &#x27;severity&#x27;: &#x27;high&#x27;,</span><br><span class="line">                &#x27;description&#x27;: f&#x27;玩家胜率不平衡: &#123;self.metrics[&quot;win_rate&quot;]:.2%&#125;&#x27;,</span><br><span class="line">                &#x27;suggestion&#x27;: &#x27;调整敌人强度或玩家初始资源&#x27;</span><br><span class="line">            &#125;)</span><br><span class="line">        </span><br><span class="line">        # 检查塔使用率是否平衡</span><br><span class="line">        tower_usage = self.metrics.get(&#x27;tower_usage&#x27;, &#123;&#125;)</span><br><span class="line">        if tower_usage:</span><br><span class="line">            max_usage = max(tower_usage.values())</span><br><span class="line">            min_usage = min(tower_usage.values())</span><br><span class="line">            </span><br><span class="line">            if max_usage / min_usage &gt; 3:</span><br><span class="line">                underused = [k for k, v in tower_usage.items() if v == min_usage][0]</span><br><span class="line">                overused = [k for k, v in tower_usage.items() if v == max_usage][0]</span><br><span class="line">                </span><br><span class="line">                issues.append(&#123;</span><br><span class="line">                    &#x27;type&#x27;: &#x27;tower_balance&#x27;,</span><br><span class="line">                    &#x27;severity&#x27;: &#x27;medium&#x27;,</span><br><span class="line">                    &#x27;description&#x27;: f&#x27;塔使用不平衡: &#123;overused&#125;使用率是&#123;underused&#125;的&#123;max_usage/min_usage:.1f&#125;倍&#x27;,</span><br><span class="line">                    &#x27;suggestion&#x27;: f&#x27;调整&#123;underused&#125;塔的性价比或加强其特殊能力&#x27;</span><br><span class="line">                &#125;)</span><br><span class="line">        </span><br><span class="line">        # 检查敌人击杀分布</span><br><span class="line">        enemy_kills = self.metrics.get(&#x27;enemy_kills&#x27;, &#123;&#125;)</span><br><span class="line">        if enemy_kills:</span><br><span class="line">            # 计算变异系数</span><br><span class="line">            kills_values = list(enemy_kills.values())</span><br><span class="line">            cv = np.std(kills_values) / np.mean(kills_values)</span><br><span class="line">            </span><br><span class="line">            if cv &gt; 0.5:</span><br><span class="line">                issues.append(&#123;</span><br><span class="line">                    &#x27;type&#x27;: &#x27;enemy_balance&#x27;,</span><br><span class="line">                    &#x27;severity&#x27;: &#x27;medium&#x27;,</span><br><span class="line">                    &#x27;description&#x27;: &#x27;不同类型敌人的击杀数差异过大&#x27;,</span><br><span class="line">                    &#x27;suggestion&#x27;: &#x27;重新平衡敌人的生命值、速度和奖励&#x27;</span><br><span class="line">                &#125;)</span><br><span class="line">        </span><br><span class="line">        # 检查游戏时长</span><br><span class="line">        avg_time = self.metrics.get(&#x27;avg_game_time&#x27;, 0)</span><br><span class="line">        if avg_time &lt; 300:  # 少于5分钟</span><br><span class="line">            issues.append(&#123;</span><br><span class="line">                &#x27;type&#x27;: &#x27;game_duration&#x27;,</span><br><span class="line">                &#x27;severity&#x27;: &#x27;low&#x27;,</span><br><span class="line">                &#x27;description&#x27;: f&#x27;平均游戏时间过短: &#123;avg_time/60:.1f&#125;分钟&#x27;,</span><br><span class="line">                &#x27;suggestion&#x27;: &#x27;增加早期波次的难度或减少初始资源&#x27;</span><br><span class="line">            &#125;)</span><br><span class="line">        elif avg_time &gt; 1800:  # 超过30分钟</span><br><span class="line">            issues.append(&#123;</span><br><span class="line">                &#x27;type&#x27;: &#x27;game_duration&#x27;,</span><br><span class="line">                &#x27;severity&#x27;: &#x27;low&#x27;,</span><br><span class="line">                &#x27;description&#x27;: f&#x27;平均游戏时间过长: &#123;avg_time/60:.1f&#125;分钟&#x27;,</span><br><span class="line">                &#x27;suggestion&#x27;: &#x27;增加波次强度或限制最大波次&#x27;</span><br><span class="line">            &#125;)</span><br><span class="line">        </span><br><span class="line">        return issues</span><br><span class="line">    </span><br><span class="line">    def suggest_balance_adjustments(self):</span><br><span class="line">        &quot;&quot;&quot;提供平衡性调整建议&quot;&quot;&quot;</span><br><span class="line">        suggestions = []</span><br><span class="line">        </span><br><span class="line">        # 基于分析结果的调整建议</span><br><span class="line">        metrics = self.metrics</span><br><span class="line">        </span><br><span class="line">        # 1. 塔调整建议</span><br><span class="line">        tower_usage = metrics.get(&#x27;tower_usage&#x27;, &#123;&#125;)</span><br><span class="line">        if tower_usage:</span><br><span class="line">            avg_usage = np.mean(list(tower_usage.values()))</span><br><span class="line">            </span><br><span class="line">            for tower_type, usage in tower_usage.items():</span><br><span class="line">                if usage &lt; avg_usage * 0.7:  # 使用率低于平均水平30%</span><br><span class="line">                    suggestions.append(&#123;</span><br><span class="line">                        &#x27;target&#x27;: tower_type,</span><br><span class="line">                        &#x27;action&#x27;: &#x27;buff&#x27;,</span><br><span class="line">                        &#x27;adjustments&#x27;: &#123;</span><br><span class="line">                            &#x27;cost_reduction&#x27;: 0.1,</span><br><span class="line">                            &#x27;damage_increase&#x27;: 0.15,</span><br><span class="line">                            &#x27;range_increase&#x27;: 0.1</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;)</span><br><span class="line">                elif usage &gt; avg_usage * 1.3:  # 使用率高于平均水平30%</span><br><span class="line">                    suggestions.append(&#123;</span><br><span class="line">                        &#x27;target&#x27;: tower_type,</span><br><span class="line">                        &#x27;action&#x27;: &#x27;nerf&#x27;,</span><br><span class="line">                        &#x27;adjustments&#x27;: &#123;</span><br><span class="line">                            &#x27;cost_increase&#x27;: 0.1,</span><br><span class="line">                            &#x27;attack_speed_reduction&#x27;: 0.1</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;)</span><br><span class="line">        </span><br><span class="line">        # 2. 敌人调整建议</span><br><span class="line">        enemy_kills = metrics.get(&#x27;enemy_kills&#x27;, &#123;&#125;)</span><br><span class="line">        if enemy_kills:</span><br><span class="line">            total_kills = sum(enemy_kills.values())</span><br><span class="line">            </span><br><span class="line">            for enemy_type, kills in enemy_kills.items():</span><br><span class="line">                kill_rate = kills / total_kills</span><br><span class="line">                </span><br><span class="line">                if kill_rate &lt; 0.15:  # 击杀率低于15%</span><br><span class="line">                    suggestions.append(&#123;</span><br><span class="line">                        &#x27;target&#x27;: enemy_type,</span><br><span class="line">                        &#x27;action&#x27;: &#x27;buff&#x27;,</span><br><span class="line">                        &#x27;adjustments&#x27;: &#123;</span><br><span class="line">                            &#x27;health_reduction&#x27;: 0.1,</span><br><span class="line">                            &#x27;reward_increase&#x27;: 0.2,</span><br><span class="line">                            &#x27;speed_increase&#x27;: 0.05</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;)</span><br><span class="line">                elif kill_rate &gt; 0.35:  # 击杀率高于35%</span><br><span class="line">                    suggestions.append(&#123;</span><br><span class="line">                        &#x27;target&#x27;: enemy_type,</span><br><span class="line">                        &#x27;action&#x27;: &#x27;nerf&#x27;,</span><br><span class="line">                        &#x27;adjustments&#x27;: &#123;</span><br><span class="line">                            &#x27;health_increase&#x27;: 0.15,</span><br><span class="line">                            &#x27;reward_reduction&#x27;: 0.1,</span><br><span class="line">                            &#x27;speed_reduction&#x27;: 0.1</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;)</span><br><span class="line">        </span><br><span class="line">        # 3. 整体难度调整</span><br><span class="line">        win_rate = metrics.get(&#x27;win_rate&#x27;, 0.5)</span><br><span class="line">        if win_rate &lt; 0.45:</span><br><span class="line">            suggestions.append(&#123;</span><br><span class="line">                &#x27;target&#x27;: &#x27;global&#x27;,</span><br><span class="line">                &#x27;action&#x27;: &#x27;reduce_difficulty&#x27;,</span><br><span class="line">                &#x27;adjustments&#x27;: &#123;</span><br><span class="line">                    &#x27;starting_resources_increase&#x27;: 0.2,</span><br><span class="line">                    &#x27;enemy_wave_size_reduction&#x27;: 0.1,</span><br><span class="line">                    &#x27;tower_damage_increase&#x27;: 0.05</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        elif win_rate &gt; 0.55:</span><br><span class="line">            suggestions.append(&#123;</span><br><span class="line">                &#x27;target&#x27;: &#x27;global&#x27;,</span><br><span class="line">                &#x27;action&#x27;: &#x27;increase_difficulty&#x27;,</span><br><span class="line">                &#x27;adjustments&#x27;: &#123;</span><br><span class="line">                    &#x27;starting_resources_reduction&#x27;: 0.1,</span><br><span class="line">                    &#x27;enemy_wave_size_increase&#x27;: 0.15,</span><br><span class="line">                    &#x27;boss_health_increase&#x27;: 0.2</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        </span><br><span class="line">        return suggestions</span><br><span class="line">    </span><br><span class="line">    def create_visualization(self, save_path=&#x27;analysis_results&#x27;):</span><br><span class="line">        &quot;&quot;&quot;创建可视化分析报告&quot;&quot;&quot;</span><br><span class="line">        if not self.metrics:</span><br><span class="line">            return</span><br><span class="line">        </span><br><span class="line">        # 设置样式</span><br><span class="line">        plt.style.use(&#x27;seaborn-darkgrid&#x27;)</span><br><span class="line">        sns.set_palette(&quot;husl&quot;)</span><br><span class="line">        </span><br><span class="line">        fig = plt.figure(figsize=(15, 10))</span><br><span class="line">        </span><br><span class="line">        # 1. 塔使用率饼图</span><br><span class="line">        ax1 = plt.subplot(2, 3, 1)</span><br><span class="line">        tower_usage = self.metrics.get(&#x27;tower_usage&#x27;, &#123;&#125;)</span><br><span class="line">        if tower_usage:</span><br><span class="line">            labels = [k.capitalize() for k in tower_usage.keys()]</span><br><span class="line">            sizes = list(tower_usage.values())</span><br><span class="line">            ax1.pie(sizes, labels=labels, autopct=&#x27;%1.1f%%&#x27;, startangle=90)</span><br><span class="line">            ax1.set_title(&#x27;Tower Usage Distribution&#x27;)</span><br><span class="line">        </span><br><span class="line">        # 2. 敌人击杀数柱状图</span><br><span class="line">        ax2 = plt.subplot(2, 3, 2)</span><br><span class="line">        enemy_kills = self.metrics.get(&#x27;enemy_kills&#x27;, &#123;&#125;)</span><br><span class="line">        if enemy_kills:</span><br><span class="line">            labels = [k.capitalize() for k in enemy_kills.keys()]</span><br><span class="line">            values = list(enemy_kills.values())</span><br><span class="line">            bars = ax2.bar(range(len(values)), values)</span><br><span class="line">            ax2.set_xticks(range(len(values)))</span><br><span class="line">            ax2.set_xticklabels(labels, rotation=45)</span><br><span class="line">            ax2.set_title(&#x27;Average Enemy Kills&#x27;)</span><br><span class="line">            ax2.set_ylabel(&#x27;Kills&#x27;)</span><br><span class="line">            </span><br><span class="line">            # 添加数值标签</span><br><span class="line">            for bar in bars:</span><br><span class="line">                height = bar.get_height()</span><br><span class="line">                ax2.text(bar.get_x() + bar.get_width()/2., height,</span><br><span class="line">                        f&#x27;&#123;height:.1f&#125;&#x27;, ha=&#x27;center&#x27;, va=&#x27;bottom&#x27;)</span><br><span class="line">        </span><br><span class="line">        # 3. 技能效率散点图</span><br><span class="line">        ax3 = plt.subplot(2, 3, 3)</span><br><span class="line">        skill_efficiency = self.metrics.get(&#x27;skill_efficiency&#x27;, &#123;&#125;)</span><br><span class="line">        if skill_efficiency:</span><br><span class="line">            labels = list(skill_efficiency.keys())</span><br><span class="line">            values = list(skill_efficiency.values())</span><br><span class="line">            ax3.scatter(range(len(values)), values, s=100)</span><br><span class="line">            ax3.set_xticks(range(len(values)))</span><br><span class="line">            ax3.set_xticklabels(labels, rotation=45)</span><br><span class="line">            ax3.set_title(&#x27;Skill Efficiency&#x27;)</span><br><span class="line">            ax3.set_ylabel(&#x27;Damage per Use&#x27;)</span><br><span class="line">        </span><br><span class="line">        # 4. 游戏时长分布直方图</span><br><span class="line">        ax4 = plt.subplot(2, 3, 4)</span><br><span class="line">        if hasattr(self, &#x27;game_data&#x27;) and self.game_data:</span><br><span class="line">            game_times = [data.get(&#x27;game_time&#x27;, 0) for data in self.game_data]</span><br><span class="line">            ax4.hist(game_times, bins=20, edgecolor=&#x27;black&#x27;)</span><br><span class="line">            ax4.set_title(&#x27;Game Duration Distribution&#x27;)</span><br><span class="line">            ax4.set_xlabel(&#x27;Time (seconds)&#x27;)</span><br><span class="line">            ax4.set_ylabel(&#x27;Frequency&#x27;)</span><br><span class="line">        </span><br><span class="line">        # 5. 波次进度箱线图</span><br><span class="line">        ax5 = plt.subplot(2, 3, 5)</span><br><span class="line">        if hasattr(self, &#x27;game_data&#x27;) and self.game_data:</span><br><span class="line">            max_waves = [data.get(&#x27;max_wave&#x27;, 1) for data in self.game_data]</span><br><span class="line">            ax5.boxplot(max_waves)</span><br><span class="line">            ax5.set_title(&#x27;Wave Progress Distribution&#x27;)</span><br><span class="line">            ax5.set_ylabel(&#x27;Max Wave Reached&#x27;)</span><br><span class="line">        </span><br><span class="line">        # 6. 资源效率散点图</span><br><span class="line">        ax6 = plt.subplot(2, 3, 6)</span><br><span class="line">        if hasattr(self, &#x27;game_data&#x27;) and self.game_data:</span><br><span class="line">            scores = [data.get(&#x27;final_score&#x27;, 0) for data in self.game_data]</span><br><span class="line">            resources = [data.get(&#x27;resources_spent&#x27;, 1) for data in self.game_data]</span><br><span class="line">            efficiencies = [s/r if r &gt; 0 else 0 for s, r in zip(scores, resources)]</span><br><span class="line">            ax6.scatter(resources, scores, alpha=0.5)</span><br><span class="line">            ax6.set_title(&#x27;Resource Efficiency&#x27;)</span><br><span class="line">            ax6.set_xlabel(&#x27;Resources Spent&#x27;)</span><br><span class="line">            ax6.set_ylabel(&#x27;Final Score&#x27;)</span><br><span class="line">            </span><br><span class="line">            # 添加趋势线</span><br><span class="line">            z = np.polyfit(resources, scores, 1)</span><br><span class="line">            p = np.poly1d(z)</span><br><span class="line">            ax6.plot(resources, p(resources), &quot;r--&quot;, alpha=0.8)</span><br><span class="line">        </span><br><span class="line">        plt.tight_layout()</span><br><span class="line">        plt.savefig(f&#x27;&#123;save_path&#125;/game_balance_analysis.png&#x27;, dpi=300, bbox_inches=&#x27;tight&#x27;)</span><br><span class="line">        plt.show()</span><br><span class="line">        </span><br><span class="line">        # 保存详细报告</span><br><span class="line">        self.save_analysis_report(save_path)</span><br><span class="line">    </span><br><span class="line">    def save_analysis_report(self, path):</span><br><span class="line">        &quot;&quot;&quot;保存详细分析报告&quot;&quot;&quot;</span><br><span class="line">        report = &#123;</span><br><span class="line">            &#x27;summary_metrics&#x27;: self.metrics,</span><br><span class="line">            &#x27;balance_issues&#x27;: self.identify_balance_issues(),</span><br><span class="line">            &#x27;adjustment_suggestions&#x27;: self.suggest_balance_adjustments(),</span><br><span class="line">            &#x27;data_summary&#x27;: &#123;</span><br><span class="line">                &#x27;total_games_analyzed&#x27;: len(self.game_data),</span><br><span class="line">                &#x27;data_collection_period&#x27;: &#x27;ongoing&#x27;,</span><br><span class="line">                &#x27;analysis_timestamp&#x27;: pd.Timestamp.now().isoformat()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        with open(f&#x27;&#123;path&#125;/analysis_report.json&#x27;, &#x27;w&#x27;) as f:</span><br><span class="line">            json.dump(report, f, indent=2, default=str)</span><br><span class="line">        </span><br><span class="line">        # 同时保存为CSV用于进一步分析</span><br><span class="line">        df = pd.DataFrame(self.game_data)</span><br><span class="line">        df.to_csv(f&#x27;&#123;path&#125;/game_data.csv&#x27;, index=False)</span><br><span class="line">    </span><br><span class="line">    def predict_optimal_strategy(self, player_profile):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        预测给定玩家档案的最优策略</span><br><span class="line">        player_profile: 包含玩家技能水平、偏好等信息</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        if len(self.game_data) &lt; 100:</span><br><span class="line">            return &quot;balanced&quot;  # 数据不足时返回平衡策略</span><br><span class="line">        </span><br><span class="line">        # 创建特征矩阵</span><br><span class="line">        features = []</span><br><span class="line">        labels = []</span><br><span class="line">        </span><br><span class="line">        for game in self.game_data:</span><br><span class="line">            # 提取特征</span><br><span class="line">            feat = [</span><br><span class="line">                game.get(&#x27;player_skill_level&#x27;, 1),</span><br><span class="line">                game.get(&#x27;preference_aggressive&#x27;, 0.5),</span><br><span class="line">                game.get(&#x27;preference_defensive&#x27;, 0.5),</span><br><span class="line">                game.get(&#x27;resource_management_skill&#x27;, 0.5),</span><br><span class="line">                game.get(&#x27;reaction_time&#x27;, 0.5)</span><br><span class="line">            ]</span><br><span class="line">            </span><br><span class="line">            # 确定最佳策略标签</span><br><span class="line">            strategies = [&#x27;aggressive&#x27;, &#x27;defensive&#x27;, &#x27;economic&#x27;, &#x27;balanced&#x27;]</span><br><span class="line">            strategy_scores = [</span><br><span class="line">                game.get(&#x27;aggressive_score&#x27;, 0),</span><br><span class="line">                game.get(&#x27;defensive_score&#x27;, 0),</span><br><span class="line">                game.get(&#x27;economic_score&#x27;, 0),</span><br><span class="line">                game.get(&#x27;balanced_score&#x27;, 0)</span><br><span class="line">            ]</span><br><span class="line">            </span><br><span class="line">            best_strategy = strategies[np.argmax(strategy_scores)]</span><br><span class="line">            strategy_index = strategies.index(best_strategy)</span><br><span class="line">            </span><br><span class="line">            features.append(feat)</span><br><span class="line">            labels.append(strategy_index)</span><br><span class="line">        </span><br><span class="line">        # 训练分类器</span><br><span class="line">        X_train, X_test, y_train, y_test = train_test_split(</span><br><span class="line">            features, labels, test_size=0.2, random_state=42</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        clf = RandomForestRegressor(n_estimators=100, random_state=42)</span><br><span class="line">        clf.fit(X_train, y_train)</span><br><span class="line">        </span><br><span class="line">        # 预测最优策略</span><br><span class="line">        player_features = [</span><br><span class="line">            player_profile.get(&#x27;skill_level&#x27;, 1),</span><br><span class="line">            player_profile.get(&#x27;preference_aggressive&#x27;, 0.5),</span><br><span class="line">            player_profile.get(&#x27;preference_defensive&#x27;, 0.5),</span><br><span class="line">            player_profile.get(&#x27;resource_management&#x27;, 0.5),</span><br><span class="line">            player_profile.get(&#x27;reaction_time&#x27;, 0.5)</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        prediction = clf.predict([player_features])[0]</span><br><span class="line">        strategies = [&#x27;aggressive&#x27;, &#x27;defensive&#x27;, &#x27;economic&#x27;, &#x27;balanced&#x27;]</span><br><span class="line">        </span><br><span class="line">        return strategies[int(round(prediction))]</span><br></pre></td></tr></table></figure>



<h2 id="第十四阶段：C引擎性能优化（第11周）"><a href="#第十四阶段：C引擎性能优化（第11周）" class="headerlink" title="第十四阶段：C引擎性能优化（第11周）"></a>第十四阶段：C引擎性能优化（第11周）</h2><h3 id="步骤13：实现多线程和SIMD优化"><a href="#步骤13：实现多线程和SIMD优化" class="headerlink" title="步骤13：实现多线程和SIMD优化"></a>步骤13：实现多线程和SIMD优化</h3><h4 id="13-1-多线程路径查找优化"><a href="#13-1-多线程路径查找优化" class="headerlink" title="13.1 多线程路径查找优化"></a>13.1 多线程路径查找优化</h4><p>创建 <code>engine-core/src/pathfinding/parallel_a_star.c</code>:</p>
<p>c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;math.h&gt;</span><br><span class="line">#include &lt;pthread.h&gt;</span><br><span class="line">#include &lt;immintrin.h&gt;  // SIMD指令集</span><br><span class="line">#include &quot;parallel_a_star.h&quot;</span><br><span class="line"></span><br><span class="line">#define THREAD_POOL_SIZE 4</span><br><span class="line">#define SIMD_WIDTH 8  // AVX2支持8个单精度浮点数</span><br><span class="line"></span><br><span class="line">typedef struct &#123;</span><br><span class="line">    int start_x, start_y;</span><br><span class="line">    int end_x, end_y;</span><br><span class="line">    Grid* grid;</span><br><span class="line">    Path* result;</span><br><span class="line">    pthread_mutex_t* mutex;</span><br><span class="line">    int thread_id;</span><br><span class="line">&#125; PathfindingTask;</span><br><span class="line"></span><br><span class="line">typedef struct &#123;</span><br><span class="line">    pthread_t threads[THREAD_POOL_SIZE];</span><br><span class="line">    PathfindingTask tasks[THREAD_POOL_SIZE];</span><br><span class="line">    pthread_mutex_t task_mutex;</span><br><span class="line">    pthread_cond_t task_cond;</span><br><span class="line">    int task_count;</span><br><span class="line">    int shutdown;</span><br><span class="line">&#125; ThreadPool;</span><br><span class="line"></span><br><span class="line">// 线程池实例</span><br><span class="line">static ThreadPool thread_pool;</span><br><span class="line"></span><br><span class="line">// SIMD优化的向量类型</span><br><span class="line">typedef float v8sf __attribute__((vector_size(32)));  // 8个float</span><br><span class="line"></span><br><span class="line">// 线程工作函数</span><br><span class="line">void* worker_thread(void* arg) &#123;</span><br><span class="line">    int thread_id = *(int*)arg;</span><br><span class="line">    </span><br><span class="line">    while (1) &#123;</span><br><span class="line">        pthread_mutex_lock(&amp;thread_pool.task_mutex);</span><br><span class="line">        </span><br><span class="line">        // 等待任务</span><br><span class="line">        while (thread_pool.task_count == 0 &amp;&amp; !thread_pool.shutdown) &#123;</span><br><span class="line">            pthread_cond_wait(&amp;thread_pool.task_cond, &amp;thread_pool.task_mutex);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (thread_pool.shutdown) &#123;</span><br><span class="line">            pthread_mutex_unlock(&amp;thread_pool.task_mutex);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 获取任务</span><br><span class="line">        PathfindingTask* task = NULL;</span><br><span class="line">        for (int i = 0; i &lt; THREAD_POOL_SIZE; i++) &#123;</span><br><span class="line">            if (thread_pool.tasks[i].thread_id == -1) &#123;</span><br><span class="line">                thread_pool.tasks[i].thread_id = thread_id;</span><br><span class="line">                task = &amp;thread_pool.tasks[i];</span><br><span class="line">                thread_pool.task_count--;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        pthread_mutex_unlock(&amp;thread_pool.task_mutex);</span><br><span class="line">        </span><br><span class="line">        if (task) &#123;</span><br><span class="line">            // 执行路径查找</span><br><span class="line">            Path* path = find_path_parallel(task-&gt;grid, </span><br><span class="line">                                           task-&gt;start_x, task-&gt;start_y,</span><br><span class="line">                                           task-&gt;end_x, task-&gt;end_y,</span><br><span class="line">                                           task-&gt;thread_id);</span><br><span class="line">            </span><br><span class="line">            // 存储结果</span><br><span class="line">            pthread_mutex_lock(task-&gt;mutex);</span><br><span class="line">            task-&gt;result = path;</span><br><span class="line">            pthread_mutex_unlock(task-&gt;mutex);</span><br><span class="line">            </span><br><span class="line">            // 标记任务完成</span><br><span class="line">            task-&gt;thread_id = -1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return NULL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 初始化线程池</span><br><span class="line">void init_thread_pool() &#123;</span><br><span class="line">    pthread_mutex_init(&amp;thread_pool.task_mutex, NULL);</span><br><span class="line">    pthread_cond_init(&amp;thread_pool.task_cond, NULL);</span><br><span class="line">    thread_pool.task_count = 0;</span><br><span class="line">    thread_pool.shutdown = 0;</span><br><span class="line">    </span><br><span class="line">    // 初始化任务</span><br><span class="line">    for (int i = 0; i &lt; THREAD_POOL_SIZE; i++) &#123;</span><br><span class="line">        thread_pool.tasks[i].thread_id = -1;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 创建工作线程</span><br><span class="line">    int thread_ids[THREAD_POOL_SIZE];</span><br><span class="line">    for (int i = 0; i &lt; THREAD_POOL_SIZE; i++) &#123;</span><br><span class="line">        thread_ids[i] = i;</span><br><span class="line">        pthread_create(&amp;thread_pool.threads[i], NULL, worker_thread, &amp;thread_ids[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 关闭线程池</span><br><span class="line">void shutdown_thread_pool() &#123;</span><br><span class="line">    pthread_mutex_lock(&amp;thread_pool.task_mutex);</span><br><span class="line">    thread_pool.shutdown = 1;</span><br><span class="line">    pthread_cond_broadcast(&amp;thread_pool.task_cond);</span><br><span class="line">    pthread_mutex_unlock(&amp;thread_pool.task_mutex);</span><br><span class="line">    </span><br><span class="line">    for (int i = 0; i &lt; THREAD_POOL_SIZE; i++) &#123;</span><br><span class="line">        pthread_join(thread_pool.threads[i], NULL);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pthread_mutex_destroy(&amp;thread_pool.task_mutex);</span><br><span class="line">    pthread_cond_destroy(&amp;thread_pool.task_cond);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 提交路径查找任务</span><br><span class="line">int submit_pathfinding_task(Grid* grid, int start_x, int start_y, </span><br><span class="line">                           int end_x, int end_y, Path** result) &#123;</span><br><span class="line">    pthread_mutex_lock(&amp;thread_pool.task_mutex);</span><br><span class="line">    </span><br><span class="line">    // 查找空闲任务槽</span><br><span class="line">    int task_index = -1;</span><br><span class="line">    for (int i = 0; i &lt; THREAD_POOL_SIZE; i++) &#123;</span><br><span class="line">        if (thread_pool.tasks[i].thread_id == -1) &#123;</span><br><span class="line">            task_index = i;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (task_index == -1) &#123;</span><br><span class="line">        pthread_mutex_unlock(&amp;thread_pool.task_mutex);</span><br><span class="line">        return -1;  // 无可用任务槽</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 设置任务</span><br><span class="line">    pthread_mutex_t* mutex = malloc(sizeof(pthread_mutex_t));</span><br><span class="line">    pthread_mutex_init(mutex, NULL);</span><br><span class="line">    </span><br><span class="line">    thread_pool.tasks[task_index].grid = grid;</span><br><span class="line">    thread_pool.tasks[task_index].start_x = start_x;</span><br><span class="line">    thread_pool.tasks[task_index].start_y = start_y;</span><br><span class="line">    thread_pool.tasks[task_index].end_x = end_x;</span><br><span class="line">    thread_pool.tasks[task_index].end_y = end_y;</span><br><span class="line">    thread_pool.tasks[task_index].mutex = mutex;</span><br><span class="line">    thread_pool.tasks[task_index].result = NULL;</span><br><span class="line">    thread_pool.tasks[task_index].thread_id = -2;  // 待处理状态</span><br><span class="line">    </span><br><span class="line">    *result = &amp;thread_pool.tasks[task_index].result;</span><br><span class="line">    </span><br><span class="line">    thread_pool.task_count++;</span><br><span class="line">    pthread_cond_signal(&amp;thread_pool.task_cond);</span><br><span class="line">    pthread_mutex_unlock(&amp;thread_pool.task_mutex);</span><br><span class="line">    </span><br><span class="line">    return task_index;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 并行A*算法实现</span><br><span class="line">Path* find_path_parallel(Grid* grid, int start_x, int start_y, </span><br><span class="line">                        int end_x, int end_y, int thread_id) &#123;</span><br><span class="line">    if (start_x &lt; 0 || start_x &gt;= grid-&gt;width || start_y &lt; 0 || start_y &gt;= grid-&gt;height ||</span><br><span class="line">        end_x &lt; 0 || end_x &gt;= grid-&gt;width || end_y &lt; 0 || end_y &gt;= grid-&gt;height) &#123;</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Node* start = &amp;grid-&gt;nodes[start_y][start_x];</span><br><span class="line">    Node* end = &amp;grid-&gt;nodes[end_y][end_x];</span><br><span class="line">    </span><br><span class="line">    if (start-&gt;is_obstacle || end-&gt;is_obstacle) &#123;</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 线程局部数据</span><br><span class="line">    Node** open_list = malloc(grid-&gt;width * grid-&gt;height * sizeof(Node*));</span><br><span class="line">    Node** closed_list = malloc(grid-&gt;width * grid-&gt;height * sizeof(Node*));</span><br><span class="line">    int open_size = 0;</span><br><span class="line">    int closed_size = 0;</span><br><span class="line">    </span><br><span class="line">    // 添加起点</span><br><span class="line">    open_list[open_size++] = start;</span><br><span class="line">    </span><br><span class="line">    while (open_size &gt; 0) &#123;</span><br><span class="line">        // 使用SIMD优化寻找最小f值节点</span><br><span class="line">        Node* current = find_min_f_node_simd(open_list, open_size);</span><br><span class="line">        </span><br><span class="line">        if (current-&gt;x == end-&gt;x &amp;&amp; current-&gt;y == end-&gt;y) &#123;</span><br><span class="line">            Path* path = reconstruct_path(current);</span><br><span class="line">            </span><br><span class="line">            free(open_list);</span><br><span class="line">            free(closed_list);</span><br><span class="line">            </span><br><span class="line">            return path;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 移动到关闭列表</span><br><span class="line">        remove_from_open_list(open_list, &amp;open_size, current);</span><br><span class="line">        closed_list[closed_size++] = current;</span><br><span class="line">        </span><br><span class="line">        // 并行处理邻居节点</span><br><span class="line">        process_neighbors_parallel(current, grid, open_list, &amp;open_size, </span><br><span class="line">                                  closed_list, &amp;closed_size, end, thread_id);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    free(open_list);</span><br><span class="line">    free(closed_list);</span><br><span class="line">    </span><br><span class="line">    return NULL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// SIMD优化的最小f值查找</span><br><span class="line">Node* find_min_f_node_simd(Node** nodes, int count) &#123;</span><br><span class="line">    if (count == 0) return NULL;</span><br><span class="line">    </span><br><span class="line">    // 如果节点数少于SIMD宽度，使用普通算法</span><br><span class="line">    if (count &lt; SIMD_WIDTH) &#123;</span><br><span class="line">        Node* min_node = nodes[0];</span><br><span class="line">        for (int i = 1; i &lt; count; i++) &#123;</span><br><span class="line">            if (nodes[i]-&gt;f &lt; min_node-&gt;f) &#123;</span><br><span class="line">                min_node = nodes[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return min_node;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // SIMD优化版本</span><br><span class="line">    float min_f = INFINITY;</span><br><span class="line">    Node* min_node = nodes[0];</span><br><span class="line">    </span><br><span class="line">    // 处理对齐部分</span><br><span class="line">    int i = 0;</span><br><span class="line">    for (; i &lt;= count - SIMD_WIDTH; i += SIMD_WIDTH) &#123;</span><br><span class="line">        // 加载f值到SIMD寄存器</span><br><span class="line">        v8sf f_values = &#123;0&#125;;</span><br><span class="line">        for (int j = 0; j &lt; SIMD_WIDTH; j++) &#123;</span><br><span class="line">            f_values[j] = nodes[i + j]-&gt;f;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 查找最小值</span><br><span class="line">        float min_batch = f_values[0];</span><br><span class="line">        int min_index = 0;</span><br><span class="line">        </span><br><span class="line">        for (int j = 1; j &lt; SIMD_WIDTH; j++) &#123;</span><br><span class="line">            if (f_values[j] &lt; min_batch) &#123;</span><br><span class="line">                min_batch = f_values[j];</span><br><span class="line">                min_index = j;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (min_batch &lt; min_f) &#123;</span><br><span class="line">            min_f = min_batch;</span><br><span class="line">            min_node = nodes[i + min_index];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 处理剩余部分</span><br><span class="line">    for (; i &lt; count; i++) &#123;</span><br><span class="line">        if (nodes[i]-&gt;f &lt; min_f) &#123;</span><br><span class="line">            min_f = nodes[i]-&gt;f;</span><br><span class="line">            min_node = nodes[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return min_node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 并行处理邻居节点</span><br><span class="line">void process_neighbors_parallel(Node* current, Grid* grid, </span><br><span class="line">                              Node** open_list, int* open_size,</span><br><span class="line">                              Node** closed_list, int* closed_size,</span><br><span class="line">                              Node* end, int thread_id) &#123;</span><br><span class="line">    // 邻居方向</span><br><span class="line">    int dx[] = &#123;0, 1, 0, -1&#125;;</span><br><span class="line">    int dy[] = &#123;-1, 0, 1, 0&#125;;</span><br><span class="line">    </span><br><span class="line">    // 批量处理邻居节点</span><br><span class="line">    for (int i = 0; i &lt; 4; i++) &#123;</span><br><span class="line">        int new_x = current-&gt;x + dx[i];</span><br><span class="line">        int new_y = current-&gt;y + dy[i];</span><br><span class="line">        </span><br><span class="line">        // 边界检查</span><br><span class="line">        if (new_x &lt; 0 || new_x &gt;= grid-&gt;width || </span><br><span class="line">            new_y &lt; 0 || new_y &gt;= grid-&gt;height) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        Node* neighbor = &amp;grid-&gt;nodes[new_y][new_x];</span><br><span class="line">        </span><br><span class="line">        // 跳过障碍物和关闭列表中的节点</span><br><span class="line">        if (neighbor-&gt;is_obstacle || is_in_list(neighbor, closed_list, *closed_size)) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 计算新的g值</span><br><span class="line">        int new_g = current-&gt;g + 1;</span><br><span class="line">        </span><br><span class="line">        // 检查是否在开放列表中</span><br><span class="line">        int in_open_list = is_in_list(neighbor, open_list, *open_size);</span><br><span class="line">        </span><br><span class="line">        if (!in_open_list || new_g &lt; neighbor-&gt;g) &#123;</span><br><span class="line">            neighbor-&gt;g = new_g;</span><br><span class="line">            neighbor-&gt;h = heuristic_parallel(neighbor, end);</span><br><span class="line">            neighbor-&gt;f = neighbor-&gt;g + neighbor-&gt;h;</span><br><span class="line">            neighbor-&gt;parent = current;</span><br><span class="line">            </span><br><span class="line">            if (!in_open_list) &#123;</span><br><span class="line">                open_list[(*open_size)++] = neighbor;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 并行化启发式函数</span><br><span class="line">int heuristic_parallel(Node* a, Node* b) &#123;</span><br><span class="line">    // 曼哈顿距离，适合SIMD优化</span><br><span class="line">    return abs(a-&gt;x - b-&gt;x) + abs(a-&gt;y - b-&gt;y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 批量路径查找（用于多个敌人同时查找）</span><br><span class="line">Path** find_paths_batch(Grid* grid, Point* starts, Point* ends, int count) &#123;</span><br><span class="line">    if (count == 0) return NULL;</span><br><span class="line">    </span><br><span class="line">    Path** results = malloc(count * sizeof(Path*));</span><br><span class="line">    int* task_ids = malloc(count * sizeof(int));</span><br><span class="line">    </span><br><span class="line">    // 提交所有任务</span><br><span class="line">    for (int i = 0; i &lt; count; i++) &#123;</span><br><span class="line">        task_ids[i] = submit_pathfinding_task(grid, </span><br><span class="line">            starts[i].x, starts[i].y,</span><br><span class="line">            ends[i].x, ends[i].y,</span><br><span class="line">            &amp;results[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 等待所有任务完成</span><br><span class="line">    int completed = 0;</span><br><span class="line">    while (completed &lt; count) &#123;</span><br><span class="line">        completed = 0;</span><br><span class="line">        for (int i = 0; i &lt; count; i++) &#123;</span><br><span class="line">            if (task_ids[i] &gt;= 0) &#123;</span><br><span class="line">                pthread_mutex_t* mutex = thread_pool.tasks[task_ids[i]].mutex;</span><br><span class="line">                pthread_mutex_lock(mutex);</span><br><span class="line">                if (thread_pool.tasks[task_ids[i]].result != NULL) &#123;</span><br><span class="line">                    results[i] = thread_pool.tasks[task_ids[i]].result;</span><br><span class="line">                    pthread_mutex_unlock(mutex);</span><br><span class="line">                    pthread_mutex_destroy(mutex);</span><br><span class="line">                    free(mutex);</span><br><span class="line">                    task_ids[i] = -1;</span><br><span class="line">                    completed++;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    pthread_mutex_unlock(mutex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else if (task_ids[i] == -1) &#123;</span><br><span class="line">                completed++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 避免忙等待</span><br><span class="line">        if (completed &lt; count) &#123;</span><br><span class="line">            usleep(1000);  // 睡眠1毫秒</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    free(task_ids);</span><br><span class="line">    return results;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// SIMD优化的碰撞检测</span><br><span class="line">int batch_collision_detection_simd(float* positions_x, float* positions_y, </span><br><span class="line">                                  float* radii, int count, float* results) &#123;</span><br><span class="line">    if (count &lt; SIMD_WIDTH) &#123;</span><br><span class="line">        // 回退到标量版本</span><br><span class="line">        int collisions = 0;</span><br><span class="line">        for (int i = 0; i &lt; count; i++) &#123;</span><br><span class="line">            for (int j = i + 1; j &lt; count; j++) &#123;</span><br><span class="line">                float dx = positions_x[i] - positions_x[j];</span><br><span class="line">                float dy = positions_y[i] - positions_y[j];</span><br><span class="line">                float distance_sq = dx * dx + dy * dy;</span><br><span class="line">                float radius_sum = radii[i] + radii[j];</span><br><span class="line">                </span><br><span class="line">                if (distance_sq &lt;= radius_sum * radius_sum) &#123;</span><br><span class="line">                    results[collisions * 2] = i;</span><br><span class="line">                    results[collisions * 2 + 1] = j;</span><br><span class="line">                    collisions++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return collisions;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    int collisions = 0;</span><br><span class="line">    </span><br><span class="line">    // 使用SIMD进行批量碰撞检测</span><br><span class="line">    for (int i = 0; i &lt; count; i++) &#123;</span><br><span class="line">        // 加载当前对象数据</span><br><span class="line">        float current_x = positions_x[i];</span><br><span class="line">        float current_y = positions_y[i];</span><br><span class="line">        float current_radius = radii[i];</span><br><span class="line">        </span><br><span class="line">        // 创建SIMD向量</span><br><span class="line">        v8sf current_x_vec = _mm256_set1_ps(current_x);</span><br><span class="line">        v8sf current_y_vec = _mm256_set1_ps(current_y);</span><br><span class="line">        v8sf current_radius_vec = _mm256_set1_ps(current_radius);</span><br><span class="line">        v8sf radius_sum_vec = _mm256_add_ps(current_radius_vec, </span><br><span class="line">                                          _mm256_loadu_ps(&amp;radii[i+1]));</span><br><span class="line">        </span><br><span class="line">        // 处理批量比较</span><br><span class="line">        for (int j = i + 1; j &lt;= count - SIMD_WIDTH; j += SIMD_WIDTH) &#123;</span><br><span class="line">            // 加载批量数据</span><br><span class="line">            v8sf other_x_vec = _mm256_loadu_ps(&amp;positions_x[j]);</span><br><span class="line">            v8sf other_y_vec = _mm256_loadu_ps(&amp;positions_y[j]);</span><br><span class="line">            </span><br><span class="line">            // 计算距离平方</span><br><span class="line">            v8sf dx_vec = _mm256_sub_ps(current_x_vec, other_x_vec);</span><br><span class="line">            v8sf dy_vec = _mm256_sub_ps(current_y_vec, other_y_vec);</span><br><span class="line">            v8sf distance_sq_vec = _mm256_add_ps(_mm256_mul_ps(dx_vec, dx_vec),</span><br><span class="line">                                               _mm256_mul_ps(dy_vec, dy_vec));</span><br><span class="line">            </span><br><span class="line">            // 计算半径和平方</span><br><span class="line">            v8sf radius_sum_batch = _mm256_add_ps(current_radius_vec,</span><br><span class="line">                                                _mm256_loadu_ps(&amp;radii[j]));</span><br><span class="line">            v8sf radius_sum_sq_vec = _mm256_mul_ps(radius_sum_batch, radius_sum_batch);</span><br><span class="line">            </span><br><span class="line">            // 比较碰撞</span><br><span class="line">            __m256i mask = _mm256_castps_si256(_mm256_cmp_ps(distance_sq_vec,</span><br><span class="line">                                                           radius_sum_sq_vec,</span><br><span class="line">                                                           _CMP_LE_OQ));</span><br><span class="line">            </span><br><span class="line">            // 处理碰撞结果</span><br><span class="line">            int mask_bits = _mm256_movemask_ps(_mm256_castsi256_ps(mask));</span><br><span class="line">            </span><br><span class="line">            for (int k = 0; k &lt; SIMD_WIDTH; k++) &#123;</span><br><span class="line">                if (mask_bits &amp; (1 &lt;&lt; k)) &#123;</span><br><span class="line">                    int other_idx = j + k;</span><br><span class="line">                    if (other_idx &lt; count) &#123;</span><br><span class="line">                        results[collisions * 2] = i;</span><br><span class="line">                        results[collisions * 2 + 1] = other_idx;</span><br><span class="line">                        collisions++;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 处理剩余部分</span><br><span class="line">        for (int j = (count / SIMD_WIDTH) * SIMD_WIDTH; j &lt; count; j++) &#123;</span><br><span class="line">            if (j &gt; i) &#123;</span><br><span class="line">                float dx = current_x - positions_x[j];</span><br><span class="line">                float dy = current_y - positions_y[j];</span><br><span class="line">                float distance_sq = dx * dx + dy * dy;</span><br><span class="line">                float radius_sum = current_radius + radii[j];</span><br><span class="line">                </span><br><span class="line">                if (distance_sq &lt;= radius_sum * radius_sum) &#123;</span><br><span class="line">                    results[collisions * 2] = i;</span><br><span class="line">                    results[collisions * 2 + 1] = j;</span><br><span class="line">                    collisions++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return collisions;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 性能测试函数</span><br><span class="line">void benchmark_pathfinding() &#123;</span><br><span class="line">    printf(&quot;Benchmarking parallel pathfinding...\n&quot;);</span><br><span class="line">    </span><br><span class="line">    // 创建测试网格</span><br><span class="line">    Grid* grid = create_grid(100, 100);</span><br><span class="line">    </span><br><span class="line">    // 设置随机障碍物</span><br><span class="line">    srand(time(NULL));</span><br><span class="line">    for (int i = 0; i &lt; 500; i++) &#123;</span><br><span class="line">        int x = rand() % 100;</span><br><span class="line">        int y = rand() % 100;</span><br><span class="line">        grid-&gt;nodes[y][x].is_obstacle = 1;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 创建测试点</span><br><span class="line">    int test_count = 1000;</span><br><span class="line">    Point* starts = malloc(test_count * sizeof(Point));</span><br><span class="line">    Point* ends = malloc(test_count * sizeof(Point));</span><br><span class="line">    </span><br><span class="line">    for (int i = 0; i &lt; test_count; i++) &#123;</span><br><span class="line">        starts[i].x = rand() % 100;</span><br><span class="line">        starts[i].y = rand() % 100;</span><br><span class="line">        ends[i].x = rand() % 100;</span><br><span class="line">        ends[i].y = rand() % 100;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 测试串行版本</span><br><span class="line">    clock_t start = clock();</span><br><span class="line">    for (int i = 0; i &lt; test_count; i++) &#123;</span><br><span class="line">        Path* path = find_path(grid, starts[i].x, starts[i].y,</span><br><span class="line">                              ends[i].x, ends[i].y);</span><br><span class="line">        if (path) free_path(path);</span><br><span class="line">    &#125;</span><br><span class="line">    clock_t end = clock();</span><br><span class="line">    double serial_time = (double)(end - start) / CLOCKS_PER_SEC;</span><br><span class="line">    printf(&quot;Serial: %.3f seconds\n&quot;, serial_time);</span><br><span class="line">    </span><br><span class="line">    // 测试并行版本</span><br><span class="line">    init_thread_pool();</span><br><span class="line">    </span><br><span class="line">    start = clock();</span><br><span class="line">    Path** results = find_paths_batch(grid, starts, ends, test_count);</span><br><span class="line">    end = clock();</span><br><span class="line">    double parallel_time = (double)(end - start) / CLOCKS_PER_SEC;</span><br><span class="line">    printf(&quot;Parallel: %.3f seconds\n&quot;, parallel_time);</span><br><span class="line">    printf(&quot;Speedup: %.2fx\n&quot;, serial_time / parallel_time);</span><br><span class="line">    </span><br><span class="line">    // 清理</span><br><span class="line">    for (int i = 0; i &lt; test_count; i++) &#123;</span><br><span class="line">        if (results[i]) free_path(results[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    free(results);</span><br><span class="line">    free(starts);</span><br><span class="line">    free(ends);</span><br><span class="line">    free_grid(grid);</span><br><span class="line">    shutdown_thread_pool();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>这个扩展版本增加了以下高级功能：</p>
<h3 id="前端增强："><a href="#前端增强：" class="headerlink" title="前端增强："></a>前端增强：</h3><ol>
<li><strong>完整的UI系统</strong>：塔选择、技能面板、状态显示</li>
<li><strong>粒子特效系统</strong>：爆炸、治疗、冰冻等视觉效果</li>
<li><strong>技能系统</strong>：闪电链、治疗术、陨石术、冰冻术</li>
<li><strong>通知系统</strong>：游戏事件实时反馈</li>
<li><strong>升级系统</strong>：塔升级界面和效果</li>
</ol>
<h3 id="后端增强："><a href="#后端增强：" class="headerlink" title="后端增强："></a>后端增强：</h3><ol>
<li><strong>WebSocket实时通信</strong>：支持多人游戏</li>
<li><strong>游戏会话管理</strong>：创建、加入、离开游戏房间</li>
<li><strong>多人游戏同步</strong>：玩家动作、游戏状态实时同步</li>
<li><strong>游戏结果计算</strong>：多人游戏分数和奖励系统</li>
</ol>
<h3 id="AI引擎增强："><a href="#AI引擎增强：" class="headerlink" title="AI引擎增强："></a>AI引擎增强：</h3><ol>
<li><strong>深度强化学习AI</strong>：使用DQN训练敌人AI</li>
<li><strong>策略预测</strong>：预测玩家行为模式</li>
<li><strong>动态难度调整</strong>：根据玩家表现调整游戏难度</li>
<li><strong>游戏平衡分析</strong>：自动分析并建议平衡性调整</li>
<li><strong>可视化报告</strong>：生成游戏数据分析图表</li>
</ol>
<h3 id="C引擎增强："><a href="#C引擎增强：" class="headerlink" title="C引擎增强："></a>C引擎增强：</h3><ol>
<li><strong>多线程优化</strong>：并行路径查找</li>
<li><strong>SIMD指令优化</strong>：使用AVX2加速碰撞检测</li>
<li><strong>线程池管理</strong>：高效的任务调度</li>
<li><strong>批量操作</strong>：同时处理多个路径查找请求</li>
<li><strong>性能基准测试</strong>：评估优化效果</li>
</ol>
<h3 id="部署建议："><a href="#部署建议：" class="headerlink" title="部署建议："></a>部署建议：</h3><ol>
<li><strong>使用Docker Compose</strong>管理所有服务</li>
<li><strong>配置负载均衡</strong>应对高并发</li>
<li><strong>实现水平扩展</strong>支持更多玩家</li>
<li><strong>添加监控系统</strong>追踪性能指标</li>
<li><strong>配置自动伸缩</strong>根据负载调整资源</li>
</ol>
<p>这个完整系统展示了如何构建一个专业级的跨语言游戏项目。每种语言都发挥了其优势：JavaScript处理交互和渲染，Java提供稳定的后端服务，Python实现智能AI，C语言保证核心性能，Shell脚本自动化整个流程。您可以根据具体需求选择实现全部或部分功能。</p>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">
    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/c7cb16e3.html" rel="prev" title="多语言塔防游戏设计与实现">
                  <i class="fa fa-angle-left"></i> 多语言塔防游戏设计与实现
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/b78e21cf.html" rel="next" title="多语言文明6设计与实现">
                  多语言文明6设计与实现 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa-regular fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder"></span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Word count total">424k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">25:42</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>

  <script class="next-config" data-name="wavedrom" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/wavedrom.min.js","integrity":"sha256-INLAoJc6quTNfiMWkGZniYO2cxE8mHpddnLow1m6RFs="}}</script>
  <script class="next-config" data-name="wavedrom_skin" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/skins/default.js","integrity":"sha256-fduc/Zszk5ezWws2uInY/ALWVmIrmV6VTgXbsYSReFI="}}</script>
  <script src="/js/third-party/tags/wavedrom.js"></script>




  





</body>
</html>
