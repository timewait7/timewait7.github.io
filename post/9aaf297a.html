<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"timewait7.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="项目概述本游戏是一个跨语言实现的塔防游戏，使用多种编程语言构建不同模块，展示各语言在游戏开发中的适用场景。 技术栈 前端: JavaScript&#x2F;HTML5&#x2F;CSS3 (Canvas绘制) 游戏逻辑服务: Java (Spring Boot) AI与数据分析: Python (Flask&#x2F;Pygame) 高性能计算模块: C (SDL&#x2F;路径算法) 构建与部署">
<meta property="og:type" content="article">
<meta property="og:title" content="多语言实践:王国保卫战">
<meta property="og:url" content="http://timewait7.github.io/post/9aaf297a.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="项目概述本游戏是一个跨语言实现的塔防游戏，使用多种编程语言构建不同模块，展示各语言在游戏开发中的适用场景。 技术栈 前端: JavaScript&#x2F;HTML5&#x2F;CSS3 (Canvas绘制) 游戏逻辑服务: Java (Spring Boot) AI与数据分析: Python (Flask&#x2F;Pygame) 高性能计算模块: C (SDL&#x2F;路径算法) 构建与部署">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-12-19T10:43:17.000Z">
<meta property="article:modified_time" content="2025-12-19T17:13:33.813Z">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://timewait7.github.io/post/9aaf297a.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://timewait7.github.io/post/9aaf297a.html","path":"post/9aaf297a.html","title":"多语言实践:王国保卫战"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>多语言实践:王国保卫战 | Hexo</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-archives"><a href="/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="Searching..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">项目概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E6%9C%AF%E6%A0%88"><span class="nav-number">1.1.</span> <span class="nav-text">技术栈</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="nav-number">1.2.</span> <span class="nav-text">目录结构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3"><span class="nav-number">2.</span> <span class="nav-text">设计文档</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1"><span class="nav-number">2.1.</span> <span class="nav-text">1. 游戏设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-%E6%A0%B8%E5%BF%83%E7%8E%A9%E6%B3%95"><span class="nav-number">2.1.1.</span> <span class="nav-text">1.1 核心玩法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-%E6%B8%B8%E6%88%8F%E5%85%83%E7%B4%A0"><span class="nav-number">2.1.2.</span> <span class="nav-text">1.2 游戏元素</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%A8%A1%E5%9D%97%E8%AF%A6%E7%BB%86%E8%AE%BE%E8%AE%A1"><span class="nav-number">2.2.</span> <span class="nav-text">2. 模块详细设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-%E5%89%8D%E7%AB%AF%E6%A8%A1%E5%9D%97-JavaScript-HTML5"><span class="nav-number">2.2.1.</span> <span class="nav-text">2.1 前端模块 (JavaScript&#x2F;HTML5)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1-Java-Spring-Boot"><span class="nav-number">2.2.2.</span> <span class="nav-text">2.2 后端服务 (Java&#x2F;Spring Boot)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-AI%E5%BC%95%E6%93%8E-Python"><span class="nav-number">2.2.3.</span> <span class="nav-text">2.3 AI引擎 (Python)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-%E6%A0%B8%E5%BF%83%E5%BC%95%E6%93%8E-C"><span class="nav-number">2.2.4.</span> <span class="nav-text">2.4 核心引擎 (C)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-Shell%E8%84%9A%E6%9C%AC"><span class="nav-number">2.2.5.</span> <span class="nav-text">2.5 Shell脚本</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.</span> <span class="nav-text">基础实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5%EF%BC%9A%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84%E6%90%AD%E5%BB%BA%EF%BC%88%E7%AC%AC1%E5%91%A8%EF%BC%89"><span class="nav-number">3.1.</span> <span class="nav-text">第一阶段：基础架构搭建（第1周）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A41%EF%BC%9A%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-number">3.1.1.</span> <span class="nav-text">步骤1：创建项目结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A42%EF%BC%9AHTML5%E5%89%8D%E7%AB%AF%E5%9F%BA%E7%A1%80"><span class="nav-number">3.1.2.</span> <span class="nav-text">步骤2：HTML5前端基础</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A43%EF%BC%9A%E5%9F%BA%E7%A1%80CSS"><span class="nav-number">3.1.3.</span> <span class="nav-text">步骤3：基础CSS</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5%EF%BC%9AJavaScript%E6%B8%B8%E6%88%8F%E6%A0%B8%E5%BF%83%EF%BC%88%E7%AC%AC2-3%E5%91%A8%EF%BC%89"><span class="nav-number">3.2.</span> <span class="nav-text">第二阶段：JavaScript游戏核心（第2-3周）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A44%EF%BC%9A%E6%B8%B8%E6%88%8F%E7%AE%A1%E7%90%86%E5%99%A8"><span class="nav-number">3.2.1.</span> <span class="nav-text">步骤4：游戏管理器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A45%EF%BC%9A%E5%AE%9E%E4%BD%93%E7%B1%BB%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.2.2.</span> <span class="nav-text">步骤5：实体类实现</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%EF%BC%9AJava%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1%EF%BC%88%E7%AC%AC4%E5%91%A8%EF%BC%89"><span class="nav-number">3.3.</span> <span class="nav-text">第三阶段：Java后端服务（第4周）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A46%EF%BC%9ASpring-Boot%E5%BA%94%E7%94%A8"><span class="nav-number">3.3.1.</span> <span class="nav-text">步骤6：Spring Boot应用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E9%98%B6%E6%AE%B5%EF%BC%9APython-AI%E6%A8%A1%E5%9D%97%EF%BC%88%E7%AC%AC5%E5%91%A8%EF%BC%89"><span class="nav-number">3.4.</span> <span class="nav-text">第四阶段：Python AI模块（第5周）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A47%EF%BC%9AAI%E5%BC%95%E6%93%8E"><span class="nav-number">3.4.1.</span> <span class="nav-text">步骤7：AI引擎</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%BA%94%E9%98%B6%E6%AE%B5%EF%BC%9AC%E6%A0%B8%E5%BF%83%E5%BC%95%E6%93%8E%EF%BC%88%E7%AC%AC6%E5%91%A8%EF%BC%89"><span class="nav-number">3.5.</span> <span class="nav-text">第五阶段：C核心引擎（第6周）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A48%EF%BC%9A%E9%AB%98%E6%80%A7%E8%83%BD%E8%B7%AF%E5%BE%84%E6%9F%A5%E6%89%BE"><span class="nav-number">3.5.1.</span> <span class="nav-text">步骤8：高性能路径查找</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E5%85%AD%E9%98%B6%E6%AE%B5%EF%BC%9AShell%E8%87%AA%E5%8A%A8%E5%8C%96%E8%84%9A%E6%9C%AC%EF%BC%88%E7%AC%AC7%E5%91%A8%EF%BC%89"><span class="nav-number">3.6.</span> <span class="nav-text">第六阶段：Shell自动化脚本（第7周）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A49%EF%BC%9A%E6%9E%84%E5%BB%BA%E5%92%8C%E9%83%A8%E7%BD%B2%E8%84%9A%E6%9C%AC"><span class="nav-number">3.6.1.</span> <span class="nav-text">步骤9：构建和部署脚本</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E"><span class="nav-number">3.7.</span> <span class="nav-text">配置说明</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E7%8E%AF%E5%A2%83%E8%A6%81%E6%B1%82"><span class="nav-number">3.7.1.</span> <span class="nav-text">1. 环境要求</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4"><span class="nav-number">3.7.2.</span> <span class="nav-text">2. 安装步骤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F%E5%90%AF%E5%8A%A8"><span class="nav-number">3.7.3.</span> <span class="nav-text">3. 开发模式启动</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E5%BB%BA%E8%AE%AE"><span class="nav-number">3.8.</span> <span class="nav-text">扩展建议</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E6%B8%B8%E6%88%8F%E5%8A%9F%E8%83%BD%E6%89%A9%E5%B1%95"><span class="nav-number">3.8.1.</span> <span class="nav-text">1. 游戏功能扩展</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%8A%80%E6%9C%AF%E4%BC%98%E5%8C%96"><span class="nav-number">3.8.2.</span> <span class="nav-text">2. 技术优化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E9%83%A8%E7%BD%B2%E4%BC%98%E5%8C%96"><span class="nav-number">3.8.3.</span> <span class="nav-text">3. 部署优化</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.</span> <span class="nav-text">扩展实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%83%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%89%A9%E5%B1%95%E5%89%8D%E7%AB%AF%E5%8A%9F%E8%83%BD%EF%BC%88%E7%AC%AC8%E5%91%A8%EF%BC%89"><span class="nav-number">4.1.</span> <span class="nav-text">第七阶段：扩展前端功能（第8周）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A410%EF%BC%9A%E5%AE%8C%E5%96%84%E6%B8%B8%E6%88%8F%E5%8A%9F%E8%83%BD"><span class="nav-number">4.1.1.</span> <span class="nav-text">步骤10：完善游戏功能</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#10-1-%E6%B7%BB%E5%8A%A0%E6%9B%B4%E5%A4%9A%E5%A1%94%E7%B1%BB%E5%9E%8B"><span class="nav-number">4.1.1.1.</span> <span class="nav-text">10.1 添加更多塔类型</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-2-%E6%B7%BB%E5%8A%A0%E5%A3%AB%E5%85%B5%E7%B1%BB%EF%BC%88%E7%94%A8%E4%BA%8E%E5%85%B5%E8%90%A5%EF%BC%89"><span class="nav-number">4.1.1.2.</span> <span class="nav-text">10.2 添加士兵类（用于兵营）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-3-%E6%89%A9%E5%B1%95%E6%95%8C%E4%BA%BA%E7%B1%BB%E5%9E%8B"><span class="nav-number">4.1.1.3.</span> <span class="nav-text">10.3 扩展敌人类型</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E5%85%AB%E9%98%B6%E6%AE%B5%EF%BC%9A%E5%AE%8C%E5%96%84Java%E5%90%8E%E7%AB%AF%EF%BC%88%E7%AC%AC9%E5%91%A8%EF%BC%89"><span class="nav-number">4.2.</span> <span class="nav-text">第八阶段：完善Java后端（第9周）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A411%EF%BC%9A%E6%89%A9%E5%B1%95%E5%90%8E%E7%AB%AF%E5%8A%9F%E8%83%BD"><span class="nav-number">4.2.1.</span> <span class="nav-text">步骤11：扩展后端功能</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#11-1-%E6%B7%BB%E5%8A%A0%E6%B8%B8%E6%88%8F%E7%8A%B6%E6%80%81%E4%BF%9D%E5%AD%98%E5%92%8C%E5%8A%A0%E8%BD%BD"><span class="nav-number">4.2.1.1.</span> <span class="nav-text">11.1 添加游戏状态保存和加载</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#11-2-%E6%B7%BB%E5%8A%A0%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1%E5%92%8C%E5%88%86%E6%9E%90"><span class="nav-number">4.2.1.2.</span> <span class="nav-text">11.2 添加数据统计和分析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B9%9D%E9%98%B6%E6%AE%B5%EF%BC%9A%E5%AE%8C%E5%96%84Python-AI%E5%BC%95%E6%93%8E%EF%BC%88%E7%AC%AC10%E5%91%A8%EF%BC%89"><span class="nav-number">4.3.</span> <span class="nav-text">第九阶段：完善Python AI引擎（第10周）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A412%EF%BC%9A%E6%89%A9%E5%B1%95AI%E5%8A%9F%E8%83%BD"><span class="nav-number">4.3.1.</span> <span class="nav-text">步骤12：扩展AI功能</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#12-1-%E6%B7%BB%E5%8A%A0%E9%81%97%E4%BC%A0%E7%AE%97%E6%B3%95%E4%BC%98%E5%8C%96%E5%A1%94%E9%98%B2%E5%B8%83%E5%B1%80"><span class="nav-number">4.3.1.1.</span> <span class="nav-text">12.1 添加遗传算法优化塔防布局</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E5%8D%81%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%89%A9%E5%B1%95C%E6%A0%B8%E5%BF%83%E5%BC%95%E6%93%8E%EF%BC%88%E7%AC%AC11%E5%91%A8%EF%BC%89"><span class="nav-number">4.4.</span> <span class="nav-text">第十阶段：扩展C核心引擎（第11周）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A413%EF%BC%9A%E4%BC%98%E5%8C%96%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B%E5%92%8C%E7%89%A9%E7%90%86%E5%BC%95%E6%93%8E"><span class="nav-number">4.4.1.</span> <span class="nav-text">步骤13：优化碰撞检测和物理引擎</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">4.5.</span> <span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%89%8D%E7%AB%AF%E6%89%A9%E5%B1%95%EF%BC%9A"><span class="nav-number">4.5.1.</span> <span class="nav-text">前端扩展：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%8E%E7%AB%AF%E6%89%A9%E5%B1%95%EF%BC%9A"><span class="nav-number">4.5.2.</span> <span class="nav-text">后端扩展：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AI%E5%BC%95%E6%93%8E%E6%89%A9%E5%B1%95%EF%BC%9A"><span class="nav-number">4.5.3.</span> <span class="nav-text">AI引擎扩展：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C%E6%A0%B8%E5%BF%83%E5%BC%95%E6%93%8E%E6%89%A9%E5%B1%95%EF%BC%9A"><span class="nav-number">4.5.4.</span> <span class="nav-text">C核心引擎扩展：</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/">
          <span class="site-state-item-count">52</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>

    
        <div class="sidebar-inner sidebar-post-related">
          <div class="animated">
              <div class="links-of-blogroll-title"><i class="fa fa-signs-post fa-fw"></i>
    Related Posts
  </div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/post/1aa6cbcd.html" rel="bookmark">
        <time class="popular-posts-time">2025-10-04</time>
        <br>
      命令速查表
      </a>
    </li>
  </ul>

          </div>
        </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://timewait7.github.io/post/9aaf297a.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="多语言实践:王国保卫战 | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          多语言实践:王国保卫战
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-12-19 18:43:17" itemprop="dateCreated datePublished" datetime="2025-12-19T18:43:17+08:00">2025-12-19</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>12k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>45 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="项目概述"><a href="#项目概述" class="headerlink" title="项目概述"></a>项目概述</h2><p>本游戏是一个跨语言实现的塔防游戏，使用多种编程语言构建不同模块，展示各语言在游戏开发中的适用场景。</p>
<h3 id="技术栈"><a href="#技术栈" class="headerlink" title="技术栈"></a>技术栈</h3><ul>
<li><strong>前端</strong>: JavaScript&#x2F;HTML5&#x2F;CSS3 (Canvas绘制)</li>
<li><strong>游戏逻辑服务</strong>: Java (Spring Boot)</li>
<li><strong>AI与数据分析</strong>: Python (Flask&#x2F;Pygame)</li>
<li><strong>高性能计算模块</strong>: C (SDL&#x2F;路径算法)</li>
<li><strong>构建与部署</strong>: Shell脚本</li>
</ul>
<h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">kingdom-defense/</span><br><span class="line">├── frontend/                    # HTML5前端</span><br><span class="line">│   ├── index.html</span><br><span class="line">│   ├── css/</span><br><span class="line">│   │   ├── style.css</span><br><span class="line">│   │   └── game.css</span><br><span class="line">│   ├── js/</span><br><span class="line">│   │   ├── game.js</span><br><span class="line">│   │   ├── renderer.js</span><br><span class="line">│   │   ├── entities/</span><br><span class="line">│   │   │   ├── tower.js</span><br><span class="line">│   │   │   ├── enemy.js</span><br><span class="line">│   │   │   ├── bullet.js</span><br><span class="line">│   │   │   └── particle.js</span><br><span class="line">│   │   ├── managers/</span><br><span class="line">│   │   │   ├── gameManager.js</span><br><span class="line">│   │   │   ├── levelManager.js</span><br><span class="line">│   │   │   └── resourceManager.js</span><br><span class="line">│   │   ├── utils/</span><br><span class="line">│   │   │   ├── pathfinding.js</span><br><span class="line">│   │   │   ├── collision.js</span><br><span class="line">│   │   │   └── math.js</span><br><span class="line">│   │   └── ui/</span><br><span class="line">│   │       ├── uiManager.js</span><br><span class="line">│   │       ├── menu.js</span><br><span class="line">│   │       └── hud.js</span><br><span class="line">│   └── assets/</span><br><span class="line">│       ├── images/</span><br><span class="line">│       ├── sounds/</span><br><span class="line">│       └── fonts/</span><br><span class="line">├── backend/                     # Java后端服务</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   ├── src/main/java/</span><br><span class="line">│   │   └── com/kingdomdefense/</span><br><span class="line">│   │       ├── KingdomDefenseApplication.java</span><br><span class="line">│   │       ├── config/</span><br><span class="line">│   │       ├── controller/</span><br><span class="line">│   │       │   ├── GameController.java</span><br><span class="line">│   │       │   ├── UserController.java</span><br><span class="line">│   │       │   └── ScoreController.java</span><br><span class="line">│   │       ├── service/</span><br><span class="line">│   │       │   ├── GameService.java</span><br><span class="line">│   │       │   ├── UserService.java</span><br><span class="line">│   │       │   └── ScoreService.java</span><br><span class="line">│   │       ├── repository/</span><br><span class="line">│   │       │   ├── UserRepository.java</span><br><span class="line">│   │       │   └── ScoreRepository.java</span><br><span class="line">│   │       ├── model/</span><br><span class="line">│   │       │   ├── User.java</span><br><span class="line">│   │       │   ├── GameState.java</span><br><span class="line">│   │       │   ├── Tower.java</span><br><span class="line">│   │       │   └── Enemy.java</span><br><span class="line">│   │       ├── dto/</span><br><span class="line">│   │       └── exception/</span><br><span class="line">│   ├── src/main/resources/</span><br><span class="line">│   │   ├── application.properties</span><br><span class="line">│   │   └── data.sql</span><br><span class="line">│   └── Dockerfile</span><br><span class="line">├── ai-engine/                   # Python AI模块</span><br><span class="line">│   ├── requirements.txt</span><br><span class="line">│   ├── app.py</span><br><span class="line">│   ├── game_ai/</span><br><span class="line">│   │   ├── __init__.py</span><br><span class="line">│   │   ├── enemy_ai.py</span><br><span class="line">│   │   ├── tower_placement_ai.py</span><br><span class="line">│   │   └── genetic_algorithm.py</span><br><span class="line">│   ├── analysis/</span><br><span class="line">│   │   ├── data_analyzer.py</span><br><span class="line">│   │   └── visualization.py</span><br><span class="line">│   ├── simulations/</span><br><span class="line">│   │   └── test_simulation.py</span><br><span class="line">│   └── models/</span><br><span class="line">│       └── saved_models/</span><br><span class="line">├── engine-core/                 # C核心引擎</span><br><span class="line">│   ├── Makefile</span><br><span class="line">│   ├── src/</span><br><span class="line">│   │   ├── main.c</span><br><span class="line">│   │   ├── game_engine.c</span><br><span class="line">│   │   ├── pathfinding/</span><br><span class="line">│   │   │   ├── a_star.c</span><br><span class="line">│   │   │   └── collision.c</span><br><span class="line">│   │   ├── physics/</span><br><span class="line">│   │   │   ├── collision_detection.c</span><br><span class="line">│   │   │   └── projectile_physics.c</span><br><span class="line">│   │   └── utils/</span><br><span class="line">│   │       ├── math_utils.c</span><br><span class="line">│   │       └── memory_pool.c</span><br><span class="line">│   ├── include/</span><br><span class="line">│   └── tests/</span><br><span class="line">├── scripts/                     # Shell脚本</span><br><span class="line">│   ├── build_all.sh</span><br><span class="line">│   ├── deploy.sh</span><br><span class="line">│   ├── start_services.sh</span><br><span class="line">│   └── generate_assets.sh</span><br><span class="line">├── docker-compose.yml</span><br><span class="line">├── README.md</span><br><span class="line">└── design-document.md</span><br></pre></td></tr></table></figure>



<h2 id="设计文档"><a href="#设计文档" class="headerlink" title="设计文档"></a>设计文档</h2><h3 id="1-游戏设计"><a href="#1-游戏设计" class="headerlink" title="1. 游戏设计"></a>1. 游戏设计</h3><h4 id="1-1-核心玩法"><a href="#1-1-核心玩法" class="headerlink" title="1.1 核心玩法"></a>1.1 核心玩法</h4><ul>
<li>塔防游戏，玩家在地图上建造防御塔阻止敌人到达终点</li>
<li>多种敌人类型（步兵、骑兵、飞行单位等）</li>
<li>多种防御塔类型（弓箭塔、魔法塔、炮塔等）</li>
<li>技能系统（英雄技能、全局技能）</li>
<li>升级系统（塔升级、科技升级）</li>
</ul>
<h4 id="1-2-游戏元素"><a href="#1-2-游戏元素" class="headerlink" title="1.2 游戏元素"></a>1.2 游戏元素</h4><ol>
<li><strong>防御塔</strong><ul>
<li>弓箭塔：快速攻击，对轻甲有效</li>
<li>魔法塔：魔法攻击，对魔抗低的敌人有效</li>
<li>炮塔：范围攻击，攻速慢但伤害高</li>
<li>兵营：生产士兵阻挡敌人</li>
</ul>
</li>
<li><strong>敌人类型</strong><ul>
<li>普通步兵：基础敌人</li>
<li>重甲士兵：高防御，移动慢</li>
<li>骑兵：移动快，血量中等</li>
<li>飞行单位：无视地形，只能被特定塔攻击</li>
<li>BOSS：高血量，特殊能力</li>
</ul>
</li>
<li><strong>英雄系统</strong><ul>
<li>可操控英雄单位</li>
<li>特殊技能</li>
<li>等级成长</li>
</ul>
</li>
</ol>
<h3 id="2-模块详细设计"><a href="#2-模块详细设计" class="headerlink" title="2. 模块详细设计"></a>2. 模块详细设计</h3><h4 id="2-1-前端模块-JavaScript-HTML5"><a href="#2-1-前端模块-JavaScript-HTML5" class="headerlink" title="2.1 前端模块 (JavaScript&#x2F;HTML5)"></a>2.1 前端模块 (JavaScript&#x2F;HTML5)</h4><p><strong>架构</strong>: MVC模式</p>
<ul>
<li><strong>Model</strong>: 游戏数据模型</li>
<li><strong>View</strong>: Canvas渲染器</li>
<li><strong>Controller</strong>: 游戏逻辑控制器</li>
</ul>
<p><strong>关键技术</strong>:</p>
<ul>
<li>HTML5 Canvas 2D渲染</li>
<li>Web Audio API 音效</li>
<li>localStorage 本地存储</li>
<li>WebSocket 实时通信</li>
</ul>
<h4 id="2-2-后端服务-Java-Spring-Boot"><a href="#2-2-后端服务-Java-Spring-Boot" class="headerlink" title="2.2 后端服务 (Java&#x2F;Spring Boot)"></a>2.2 后端服务 (Java&#x2F;Spring Boot)</h4><p><strong>功能</strong>:</p>
<ul>
<li>用户管理（注册&#x2F;登录）</li>
<li>游戏存档</li>
<li>排行榜</li>
<li>数据统计</li>
</ul>
<p><strong>API设计</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET    /api/users/&#123;id&#125;</span><br><span class="line">POST   /api/users</span><br><span class="line">PUT    /api/users/&#123;id&#125;</span><br><span class="line">POST   /api/scores</span><br><span class="line">GET    /api/leaderboard</span><br><span class="line">POST   /api/game/save</span><br><span class="line">GET    /api/game/load/&#123;id&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-AI引擎-Python"><a href="#2-3-AI引擎-Python" class="headerlink" title="2.3 AI引擎 (Python)"></a>2.3 AI引擎 (Python)</h4><p><strong>功能</strong>:</p>
<ul>
<li>敌人AI行为</li>
<li>自动塔防布局建议</li>
<li>游戏数据分析</li>
<li>难度自适应调整</li>
</ul>
<p><strong>技术栈</strong>:</p>
<ul>
<li>Flask REST API</li>
<li>NumPy&#x2F;Pandas 数据分析</li>
<li>Scikit-learn 机器学习</li>
<li>Pygame 模拟测试</li>
</ul>
<h4 id="2-4-核心引擎-C"><a href="#2-4-核心引擎-C" class="headerlink" title="2.4 核心引擎 (C)"></a>2.4 核心引擎 (C)</h4><p><strong>功能</strong>:</p>
<ul>
<li>高性能路径查找(A*算法)</li>
<li>碰撞检测</li>
<li>粒子系统</li>
<li>内存管理</li>
</ul>
<p><strong>优化目标</strong>:</p>
<ul>
<li>支持数千单位同时计算</li>
<li>60FPS稳定运行</li>
<li>低内存占用</li>
</ul>
<h4 id="2-5-Shell脚本"><a href="#2-5-Shell脚本" class="headerlink" title="2.5 Shell脚本"></a>2.5 Shell脚本</h4><p><strong>功能</strong>:</p>
<ul>
<li>自动化构建</li>
<li>服务部署</li>
<li>资源处理</li>
<li>环境配置</li>
</ul>
<h2 id="基础实现"><a href="#基础实现" class="headerlink" title="基础实现"></a>基础实现</h2><h3 id="第一阶段：基础架构搭建（第1周）"><a href="#第一阶段：基础架构搭建（第1周）" class="headerlink" title="第一阶段：基础架构搭建（第1周）"></a>第一阶段：基础架构搭建（第1周）</h3><h4 id="步骤1：创建项目结构"><a href="#步骤1：创建项目结构" class="headerlink" title="步骤1：创建项目结构"></a>步骤1：创建项目结构</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建基础目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p kingdom-defense/&#123;frontend,backend,ai-engine,engine-core,scripts&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建前端目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p frontend/&#123;css,js/&#123;entities,managers,utils,ui&#125;,assets/&#123;images,sounds,fonts&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建Java后端目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p backend/src/main/java/com/kingdomdefense/&#123;config,controller,service,repository,model,dto,exception&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建Python AI目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p ai-engine/&#123;game_ai,analysis,simulations,models/saved_models&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建C引擎目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p engine-core/&#123;src/&#123;pathfinding,physics,utils&#125;,include,tests&#125;</span><br></pre></td></tr></table></figure>



<h4 id="步骤2：HTML5前端基础"><a href="#步骤2：HTML5前端基础" class="headerlink" title="步骤2：HTML5前端基础"></a>步骤2：HTML5前端基础</h4><p>创建 <code>frontend/index.html</code>:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Kingdom Defense<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;css/style.css&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;css/game.css&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;game-container&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">&quot;game-canvas&quot;</span> <span class="attr">width</span>=<span class="string">&quot;1024&quot;</span> <span class="attr">height</span>=<span class="string">&quot;768&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;ui-overlay&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;hud&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;resources&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;gold&quot;</span>&gt;</span>100<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;lives&quot;</span>&gt;</span>20<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;wave&quot;</span>&gt;</span>1/10<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;tower-selection&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;menu&quot;</span> <span class="attr">class</span>=<span class="string">&quot;hidden&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;resume-btn&quot;</span>&gt;</span>Resume<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;restart-btn&quot;</span>&gt;</span>Restart<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;quit-btn&quot;</span>&gt;</span>Quit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;js/utils/math.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;js/utils/collision.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;js/utils/pathfinding.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;js/entities/tower.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;js/entities/enemy.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;js/entities/bullet.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;js/managers/gameManager.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;js/managers/levelManager.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;js/ui/uiManager.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;js/renderer.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;js/game.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="步骤3：基础CSS"><a href="#步骤3：基础CSS" class="headerlink" title="步骤3：基础CSS"></a>步骤3：基础CSS</h4><p>创建 <code>frontend/css/style.css</code>:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">* &#123;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">box-sizing</span>: border-box;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="attribute">font-family</span>: <span class="string">&#x27;Arial&#x27;</span>, sans-serif;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#1a1a2e</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">min-height</span>: <span class="number">100vh</span>;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#game-container</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">3px</span> solid <span class="number">#0f3460</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">30px</span> <span class="built_in">rgba</span>(<span class="number">79</span>, <span class="number">195</span>, <span class="number">247</span>, <span class="number">0.3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#game-canvas</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#162447</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#ui-overlay</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">pointer-events</span>: none;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#hud</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">right</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">15</span>, <span class="number">52</span>, <span class="number">96</span>, <span class="number">0.8</span>);</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-between;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">pointer-events</span>: all;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.resources</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#e94560</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">font-weight</span>: bold;</span><br><span class="line">    <span class="attribute">text-shadow</span>: <span class="number">1px</span> <span class="number">1px</span> <span class="number">2px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.8</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.resources</span> <span class="selector-tag">span</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">5px</span> <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">233</span>, <span class="number">69</span>, <span class="number">96</span>, <span class="number">0.2</span>);</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#e94560</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#menu</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translate</span>(-<span class="number">50%</span>, -<span class="number">50%</span>);</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">15</span>, <span class="number">52</span>, <span class="number">96</span>, <span class="number">0.95</span>);</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">40px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">2px</span> solid <span class="number">#4fc3f7</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">flex-direction</span>: column;</span><br><span class="line">    <span class="attribute">gap</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">pointer-events</span>: all;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#menu</span><span class="selector-class">.hidden</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: none;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#menu</span> <span class="selector-tag">button</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">15px</span> <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">18px</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">45deg</span>, <span class="number">#e94560</span>, <span class="number">#ff6b95</span>);</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">    <span class="attribute">border</span>: none;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">transition</span>: all <span class="number">0.3s</span> ease;</span><br><span class="line">    <span class="attribute">text-transform</span>: uppercase;</span><br><span class="line">    <span class="attribute">letter-spacing</span>: <span class="number">1px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#menu</span> <span class="selector-tag">button</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translateY</span>(-<span class="number">2px</span>);</span><br><span class="line">    <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">5px</span> <span class="number">15px</span> <span class="built_in">rgba</span>(<span class="number">233</span>, <span class="number">69</span>, <span class="number">96</span>, <span class="number">0.4</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#menu</span> <span class="selector-tag">button</span><span class="selector-pseudo">:active</span> &#123;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translateY</span>(<span class="number">1px</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="第二阶段：JavaScript游戏核心（第2-3周）"><a href="#第二阶段：JavaScript游戏核心（第2-3周）" class="headerlink" title="第二阶段：JavaScript游戏核心（第2-3周）"></a>第二阶段：JavaScript游戏核心（第2-3周）</h3><h4 id="步骤4：游戏管理器"><a href="#步骤4：游戏管理器" class="headerlink" title="步骤4：游戏管理器"></a>步骤4：游戏管理器</h4><p>创建 <code>frontend/js/managers/gameManager.js</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GameManager</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">canvas</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvas</span> = canvas;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span> = canvas.<span class="title function_">getContext</span>(<span class="string">&#x27;2d&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">gameState</span> = &#123;</span><br><span class="line">            <span class="attr">gold</span>: <span class="number">100</span>,</span><br><span class="line">            <span class="attr">lives</span>: <span class="number">20</span>,</span><br><span class="line">            <span class="attr">wave</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">score</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">paused</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">gameOver</span>: <span class="literal">false</span></span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">towers</span> = [];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">enemies</span> = [];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">bullets</span> = [];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">particles</span> = [];</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">path</span> = <span class="variable language_">this</span>.<span class="title function_">generatePath</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">lastTime</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">deltaTime</span> = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">keys</span> = &#123;&#125;;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">mouse</span> = &#123; <span class="attr">x</span>: <span class="number">0</span>, <span class="attr">y</span>: <span class="number">0</span>, <span class="attr">down</span>: <span class="literal">false</span> &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setupEventListeners</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">generatePath</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// 生成敌人路径点</span></span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            &#123; <span class="attr">x</span>: -<span class="number">50</span>, <span class="attr">y</span>: <span class="number">200</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">x</span>: <span class="number">300</span>, <span class="attr">y</span>: <span class="number">200</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">x</span>: <span class="number">300</span>, <span class="attr">y</span>: <span class="number">400</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">x</span>: <span class="number">600</span>, <span class="attr">y</span>: <span class="number">400</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">x</span>: <span class="number">600</span>, <span class="attr">y</span>: <span class="number">100</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">x</span>: <span class="number">900</span>, <span class="attr">y</span>: <span class="number">100</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">x</span>: <span class="number">900</span>, <span class="attr">y</span>: <span class="number">700</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">x</span>: <span class="number">1100</span>, <span class="attr">y</span>: <span class="number">700</span> &#125; <span class="comment">// 终点</span></span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">setupEventListeners</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// 键盘事件</span></span><br><span class="line">        <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;keydown&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">keys</span>[e.<span class="property">key</span>] = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;Escape&#x27;</span>) <span class="variable language_">this</span>.<span class="title function_">togglePause</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;keyup&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">keys</span>[e.<span class="property">key</span>] = <span class="literal">false</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 鼠标事件</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;mousemove&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> rect = <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="title function_">getBoundingClientRect</span>();</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">mouse</span>.<span class="property">x</span> = e.<span class="property">clientX</span> - rect.<span class="property">left</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">mouse</span>.<span class="property">y</span> = e.<span class="property">clientY</span> - rect.<span class="property">top</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;mousedown&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">mouse</span>.<span class="property">down</span> = <span class="literal">true</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">handleClick</span>(e);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;mouseup&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">mouse</span>.<span class="property">down</span> = <span class="literal">false</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">handleClick</span>(<span class="params">e</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">gameState</span>.<span class="property">paused</span> || <span class="variable language_">this</span>.<span class="property">gameState</span>.<span class="property">gameOver</span>) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查是否点击了塔位置</span></span><br><span class="line">        <span class="keyword">const</span> rect = <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="title function_">getBoundingClientRect</span>();</span><br><span class="line">        <span class="keyword">const</span> x = e.<span class="property">clientX</span> - rect.<span class="property">left</span>;</span><br><span class="line">        <span class="keyword">const</span> y = e.<span class="property">clientY</span> - rect.<span class="property">top</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 简单示例：点击位置建造塔</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">gameState</span>.<span class="property">gold</span> &gt;= <span class="number">50</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">addTower</span>(x, y);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">gameState</span>.<span class="property">gold</span> -= <span class="number">50</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">addTower</span>(<span class="params">x, y</span>) &#123;</span><br><span class="line">        <span class="comment">// 检查是否可以建造（不在路径上）</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">isBuildable</span>(x, y)) &#123;</span><br><span class="line">            <span class="keyword">const</span> tower = <span class="keyword">new</span> <span class="title class_">Tower</span>(x, y, <span class="string">&#x27;arrow&#x27;</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">towers</span>.<span class="title function_">push</span>(tower);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">isBuildable</span>(<span class="params">x, y</span>) &#123;</span><br><span class="line">        <span class="comment">// 简单检查：确保不在路径附近</span></span><br><span class="line">        <span class="keyword">const</span> minDistance = <span class="number">80</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> point <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">path</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> dx = point.<span class="property">x</span> - x;</span><br><span class="line">            <span class="keyword">const</span> dy = point.<span class="property">y</span> - y;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title class_">Math</span>.<span class="title function_">sqrt</span>(dx * dx + dy * dy) &lt; minDistance) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">spawnEnemy</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> enemyTypes = [<span class="string">&#x27;infantry&#x27;</span>, <span class="string">&#x27;cavalry&#x27;</span>, <span class="string">&#x27;armored&#x27;</span>];</span><br><span class="line">        <span class="keyword">const</span> type = enemyTypes[<span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * enemyTypes.<span class="property">length</span>)];</span><br><span class="line">        <span class="keyword">const</span> enemy = <span class="keyword">new</span> <span class="title class_">Enemy</span>(<span class="variable language_">this</span>.<span class="property">path</span>[<span class="number">0</span>].<span class="property">x</span>, <span class="variable language_">this</span>.<span class="property">path</span>[<span class="number">0</span>].<span class="property">y</span>, type);</span><br><span class="line">        enemy.<span class="title function_">setPath</span>(<span class="variable language_">this</span>.<span class="property">path</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">enemies</span>.<span class="title function_">push</span>(enemy);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">update</span>(<span class="params">deltaTime</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">gameState</span>.<span class="property">paused</span> || <span class="variable language_">this</span>.<span class="property">gameState</span>.<span class="property">gameOver</span>) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新敌人</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="variable language_">this</span>.<span class="property">enemies</span>.<span class="property">length</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">enemies</span>[i].<span class="title function_">update</span>(deltaTime);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 检查敌人是否到达终点</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">enemies</span>[i].<span class="property">reachedEnd</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">enemies</span>.<span class="title function_">splice</span>(i, <span class="number">1</span>);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">gameState</span>.<span class="property">lives</span>--;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">gameState</span>.<span class="property">lives</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">gameOver</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新塔</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">towers</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">tower</span> =&gt;</span> &#123;</span><br><span class="line">            tower.<span class="title function_">update</span>(deltaTime, <span class="variable language_">this</span>.<span class="property">enemies</span>, <span class="variable language_">this</span>.<span class="property">bullets</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新子弹</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="variable language_">this</span>.<span class="property">bullets</span>.<span class="property">length</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">bullets</span>[i].<span class="title function_">update</span>(deltaTime);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 检查子弹是否击中敌人</span></span><br><span class="line">            <span class="keyword">let</span> hit = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="variable language_">this</span>.<span class="property">enemies</span>.<span class="property">length</span> - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">bullets</span>[i].<span class="title function_">checkCollision</span>(<span class="variable language_">this</span>.<span class="property">enemies</span>[j])) &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">enemies</span>[j].<span class="title function_">takeDamage</span>(<span class="variable language_">this</span>.<span class="property">bullets</span>[i].<span class="property">damage</span>);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 如果敌人死亡</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">enemies</span>[j].<span class="property">health</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">gameState</span>.<span class="property">gold</span> += <span class="variable language_">this</span>.<span class="property">enemies</span>[j].<span class="property">reward</span>;</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">gameState</span>.<span class="property">score</span> += <span class="variable language_">this</span>.<span class="property">enemies</span>[j].<span class="property">reward</span> * <span class="number">10</span>;</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">enemies</span>.<span class="title function_">splice</span>(j, <span class="number">1</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">bullets</span>.<span class="title function_">splice</span>(i, <span class="number">1</span>);</span><br><span class="line">                    hit = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 移除出界的子弹</span></span><br><span class="line">            <span class="keyword">if</span> (!hit &amp;&amp; (<span class="variable language_">this</span>.<span class="property">bullets</span>[i].<span class="property">x</span> &lt; <span class="number">0</span> || <span class="variable language_">this</span>.<span class="property">bullets</span>[i].<span class="property">x</span> &gt; <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">width</span> || </span><br><span class="line">                         <span class="variable language_">this</span>.<span class="property">bullets</span>[i].<span class="property">y</span> &lt; <span class="number">0</span> || <span class="variable language_">this</span>.<span class="property">bullets</span>[i].<span class="property">y</span> &gt; <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">height</span>)) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">bullets</span>.<span class="title function_">splice</span>(i, <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 简单的波次管理</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">enemies</span>.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">spawnWave</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">spawnWave</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> waveSize = <span class="number">5</span> + <span class="variable language_">this</span>.<span class="property">gameState</span>.<span class="property">wave</span> * <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; waveSize; i++) &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">spawnEnemy</span>();</span><br><span class="line">            &#125;, i * <span class="number">1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">gameState</span>.<span class="property">wave</span>++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">togglePause</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">gameState</span>.<span class="property">paused</span> = !<span class="variable language_">this</span>.<span class="property">gameState</span>.<span class="property">paused</span>;</span><br><span class="line">        <span class="keyword">const</span> menu = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;menu&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">gameState</span>.<span class="property">paused</span>) &#123;</span><br><span class="line">            menu.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;hidden&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            menu.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;hidden&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">gameOver</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">gameState</span>.<span class="property">gameOver</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">`Game Over! Final Score: <span class="subst">$&#123;<span class="variable language_">this</span>.gameState.score&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">draw</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">        <span class="comment">// 清空画布</span></span><br><span class="line">        ctx.<span class="title function_">clearRect</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">width</span>, <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">height</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 绘制路径</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">drawPath</span>(ctx);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 绘制塔</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">towers</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">tower</span> =&gt;</span> tower.<span class="title function_">draw</span>(ctx));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 绘制敌人</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">enemies</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">enemy</span> =&gt;</span> enemy.<span class="title function_">draw</span>(ctx));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 绘制子弹</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">bullets</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">bullet</span> =&gt;</span> bullet.<span class="title function_">draw</span>(ctx));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 绘制UI</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">drawUI</span>(ctx);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">drawPath</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">        ctx.<span class="property">strokeStyle</span> = <span class="string">&#x27;#4fc3f7&#x27;</span>;</span><br><span class="line">        ctx.<span class="property">lineWidth</span> = <span class="number">40</span>;</span><br><span class="line">        ctx.<span class="property">lineCap</span> = <span class="string">&#x27;round&#x27;</span>;</span><br><span class="line">        ctx.<span class="property">lineJoin</span> = <span class="string">&#x27;round&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">        ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">        ctx.<span class="title function_">moveTo</span>(<span class="variable language_">this</span>.<span class="property">path</span>[<span class="number">0</span>].<span class="property">x</span>, <span class="variable language_">this</span>.<span class="property">path</span>[<span class="number">0</span>].<span class="property">y</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; <span class="variable language_">this</span>.<span class="property">path</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            ctx.<span class="title function_">lineTo</span>(<span class="variable language_">this</span>.<span class="property">path</span>[i].<span class="property">x</span>, <span class="variable language_">this</span>.<span class="property">path</span>[i].<span class="property">y</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ctx.<span class="title function_">stroke</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 绘制路径点</span></span><br><span class="line">        ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;#e94560&#x27;</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">path</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">point</span> =&gt;</span> &#123;</span><br><span class="line">            ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">            ctx.<span class="title function_">arc</span>(point.<span class="property">x</span>, point.<span class="property">y</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>);</span><br><span class="line">            ctx.<span class="title function_">fill</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">drawUI</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">        <span class="comment">// 游戏状态信息</span></span><br><span class="line">        ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;white&#x27;</span>;</span><br><span class="line">        ctx.<span class="property">font</span> = <span class="string">&#x27;20px Arial&#x27;</span>;</span><br><span class="line">        ctx.<span class="title function_">fillText</span>(<span class="string">`Gold: <span class="subst">$&#123;<span class="variable language_">this</span>.gameState.gold&#125;</span>`</span>, <span class="number">20</span>, <span class="number">40</span>);</span><br><span class="line">        ctx.<span class="title function_">fillText</span>(<span class="string">`Lives: <span class="subst">$&#123;<span class="variable language_">this</span>.gameState.lives&#125;</span>`</span>, <span class="number">20</span>, <span class="number">70</span>);</span><br><span class="line">        ctx.<span class="title function_">fillText</span>(<span class="string">`Wave: <span class="subst">$&#123;<span class="variable language_">this</span>.gameState.wave&#125;</span>`</span>, <span class="number">20</span>, <span class="number">100</span>);</span><br><span class="line">        ctx.<span class="title function_">fillText</span>(<span class="string">`Score: <span class="subst">$&#123;<span class="variable language_">this</span>.gameState.score&#125;</span>`</span>, <span class="number">20</span>, <span class="number">130</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 游戏状态提示</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">gameState</span>.<span class="property">paused</span>) &#123;</span><br><span class="line">            ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;rgba(0, 0, 0, 0.7)&#x27;</span>;</span><br><span class="line">            ctx.<span class="title function_">fillRect</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">width</span>, <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">height</span>);</span><br><span class="line">            </span><br><span class="line">            ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;white&#x27;</span>;</span><br><span class="line">            ctx.<span class="property">font</span> = <span class="string">&#x27;48px Arial&#x27;</span>;</span><br><span class="line">            ctx.<span class="property">textAlign</span> = <span class="string">&#x27;center&#x27;</span>;</span><br><span class="line">            ctx.<span class="title function_">fillText</span>(<span class="string">&#x27;PAUSED&#x27;</span>, <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">width</span> / <span class="number">2</span>, <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">height</span> / <span class="number">2</span>);</span><br><span class="line">            ctx.<span class="property">textAlign</span> = <span class="string">&#x27;left&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">gameState</span>.<span class="property">gameOver</span>) &#123;</span><br><span class="line">            ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;rgba(0, 0, 0, 0.8)&#x27;</span>;</span><br><span class="line">            ctx.<span class="title function_">fillRect</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">width</span>, <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">height</span>);</span><br><span class="line">            </span><br><span class="line">            ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;#e94560&#x27;</span>;</span><br><span class="line">            ctx.<span class="property">font</span> = <span class="string">&#x27;64px Arial&#x27;</span>;</span><br><span class="line">            ctx.<span class="property">textAlign</span> = <span class="string">&#x27;center&#x27;</span>;</span><br><span class="line">            ctx.<span class="title function_">fillText</span>(<span class="string">&#x27;GAME OVER&#x27;</span>, <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">width</span> / <span class="number">2</span>, <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">height</span> / <span class="number">2</span> - <span class="number">50</span>);</span><br><span class="line">            </span><br><span class="line">            ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;white&#x27;</span>;</span><br><span class="line">            ctx.<span class="property">font</span> = <span class="string">&#x27;32px Arial&#x27;</span>;</span><br><span class="line">            ctx.<span class="title function_">fillText</span>(<span class="string">`Final Score: <span class="subst">$&#123;<span class="variable language_">this</span>.gameState.score&#125;</span>`</span>, <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">width</span> / <span class="number">2</span>, <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">height</span> / <span class="number">2</span> + <span class="number">50</span>);</span><br><span class="line">            ctx.<span class="property">textAlign</span> = <span class="string">&#x27;left&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">gameLoop</span>(<span class="params">currentTime</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">deltaTime</span> = (currentTime - <span class="variable language_">this</span>.<span class="property">lastTime</span>) / <span class="number">1000</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">lastTime</span> = currentTime;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">update</span>(<span class="variable language_">this</span>.<span class="property">deltaTime</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">draw</span>(<span class="variable language_">this</span>.<span class="property">ctx</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="title function_">requestAnimationFrame</span>(<span class="function">(<span class="params">time</span>) =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">gameLoop</span>(time));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">lastTime</span> = performance.<span class="title function_">now</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">gameLoop</span>(<span class="variable language_">this</span>.<span class="property">lastTime</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="步骤5：实体类实现"><a href="#步骤5：实体类实现" class="headerlink" title="步骤5：实体类实现"></a>步骤5：实体类实现</h4><p>创建 <code>frontend/js/entities/tower.js</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Tower</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">x, y, type</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">x</span> = x;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">y</span> = y;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">type</span> = type;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">range</span> = <span class="number">200</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">damage</span> = <span class="number">10</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">attackSpeed</span> = <span class="number">1</span>; <span class="comment">// 攻击次数/秒</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cooldown</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">level</span> = <span class="number">1</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">color</span> = <span class="variable language_">this</span>.<span class="title function_">getColorByType</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">getColorByType</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span>(<span class="variable language_">this</span>.<span class="property">type</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;arrow&#x27;</span>: <span class="keyword">return</span> <span class="string">&#x27;#4CAF50&#x27;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;cannon&#x27;</span>: <span class="keyword">return</span> <span class="string">&#x27;#FF5722&#x27;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;magic&#x27;</span>: <span class="keyword">return</span> <span class="string">&#x27;#9C27B0&#x27;</span>;</span><br><span class="line">            <span class="attr">default</span>: <span class="keyword">return</span> <span class="string">&#x27;#607D8B&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">update</span>(<span class="params">deltaTime, enemies, bullets</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cooldown</span> -= deltaTime;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">cooldown</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> target = <span class="variable language_">this</span>.<span class="title function_">findTarget</span>(enemies);</span><br><span class="line">            <span class="keyword">if</span> (target) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">attack</span>(target, bullets);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">cooldown</span> = <span class="number">1</span> / <span class="variable language_">this</span>.<span class="property">attackSpeed</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">findTarget</span>(<span class="params">enemies</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> closest = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">let</span> closestDistance = <span class="variable language_">this</span>.<span class="property">range</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> enemy <span class="keyword">of</span> enemies) &#123;</span><br><span class="line">            <span class="keyword">const</span> dx = enemy.<span class="property">x</span> - <span class="variable language_">this</span>.<span class="property">x</span>;</span><br><span class="line">            <span class="keyword">const</span> dy = enemy.<span class="property">y</span> - <span class="variable language_">this</span>.<span class="property">y</span>;</span><br><span class="line">            <span class="keyword">const</span> distance = <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(dx * dx + dy * dy);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (distance &lt; closestDistance) &#123;</span><br><span class="line">                closest = enemy;</span><br><span class="line">                closestDistance = distance;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> closest;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">attack</span>(<span class="params">target, bullets</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> bullet = <span class="keyword">new</span> <span class="title class_">Bullet</span>(</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">x</span>,</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">y</span>,</span><br><span class="line">            target,</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">damage</span>,</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">type</span></span><br><span class="line">        );</span><br><span class="line">        bullets.<span class="title function_">push</span>(bullet);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">draw</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">        <span class="comment">// 塔底座</span></span><br><span class="line">        ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;#37474F&#x27;</span>;</span><br><span class="line">        ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">        ctx.<span class="title function_">arc</span>(<span class="variable language_">this</span>.<span class="property">x</span>, <span class="variable language_">this</span>.<span class="property">y</span>, <span class="number">30</span>, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>);</span><br><span class="line">        ctx.<span class="title function_">fill</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 塔身</span></span><br><span class="line">        ctx.<span class="property">fillStyle</span> = <span class="variable language_">this</span>.<span class="property">color</span>;</span><br><span class="line">        ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">        ctx.<span class="title function_">arc</span>(<span class="variable language_">this</span>.<span class="property">x</span>, <span class="variable language_">this</span>.<span class="property">y</span>, <span class="number">20</span>, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>);</span><br><span class="line">        ctx.<span class="title function_">fill</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 塔顶装饰</span></span><br><span class="line">        ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;#FFD700&#x27;</span>;</span><br><span class="line">        ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">        ctx.<span class="title function_">arc</span>(<span class="variable language_">this</span>.<span class="property">x</span>, <span class="variable language_">this</span>.<span class="property">y</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>);</span><br><span class="line">        ctx.<span class="title function_">fill</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 显示攻击范围（调试用）</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">isMouseOver</span>()) &#123;</span><br><span class="line">            ctx.<span class="property">strokeStyle</span> = <span class="string">&#x27;rgba(255, 255, 255, 0.3)&#x27;</span>;</span><br><span class="line">            ctx.<span class="property">lineWidth</span> = <span class="number">2</span>;</span><br><span class="line">            ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">            ctx.<span class="title function_">arc</span>(<span class="variable language_">this</span>.<span class="property">x</span>, <span class="variable language_">this</span>.<span class="property">y</span>, <span class="variable language_">this</span>.<span class="property">range</span>, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>);</span><br><span class="line">            ctx.<span class="title function_">stroke</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">isMouseOver</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> gameManager = <span class="variable language_">window</span>.<span class="property">gameManager</span>;</span><br><span class="line">        <span class="keyword">if</span> (!gameManager) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> dx = gameManager.<span class="property">mouse</span>.<span class="property">x</span> - <span class="variable language_">this</span>.<span class="property">x</span>;</span><br><span class="line">        <span class="keyword">const</span> dy = gameManager.<span class="property">mouse</span>.<span class="property">y</span> - <span class="variable language_">this</span>.<span class="property">y</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(dx * dx + dy * dy) &lt; <span class="number">30</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>创建 <code>frontend/js/entities/enemy.js</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Enemy</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">x, y, type</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">x</span> = x;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">y</span> = y;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">type</span> = type;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 根据类型设置属性</span></span><br><span class="line">        <span class="keyword">switch</span>(type) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;infantry&#x27;</span>:</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">health</span> = <span class="number">50</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">maxHealth</span> = <span class="number">50</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">speed</span> = <span class="number">100</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">reward</span> = <span class="number">10</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">color</span> = <span class="string">&#x27;#2196F3&#x27;</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;cavalry&#x27;</span>:</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">health</span> = <span class="number">75</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">maxHealth</span> = <span class="number">75</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">speed</span> = <span class="number">150</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">reward</span> = <span class="number">15</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">color</span> = <span class="string">&#x27;#4CAF50&#x27;</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;armored&#x27;</span>:</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">health</span> = <span class="number">150</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">maxHealth</span> = <span class="number">150</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">speed</span> = <span class="number">60</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">reward</span> = <span class="number">25</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">color</span> = <span class="string">&#x27;#FF9800&#x27;</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">path</span> = [];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentPathIndex</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">reachedEnd</span> = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">setPath</span>(<span class="params">path</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">path</span> = path;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentPathIndex</span> = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">update</span>(<span class="params">deltaTime</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">reachedEnd</span> || <span class="variable language_">this</span>.<span class="property">path</span>.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> target = <span class="variable language_">this</span>.<span class="property">path</span>[<span class="variable language_">this</span>.<span class="property">currentPathIndex</span>];</span><br><span class="line">        <span class="keyword">const</span> dx = target.<span class="property">x</span> - <span class="variable language_">this</span>.<span class="property">x</span>;</span><br><span class="line">        <span class="keyword">const</span> dy = target.<span class="property">y</span> - <span class="variable language_">this</span>.<span class="property">y</span>;</span><br><span class="line">        <span class="keyword">const</span> distance = <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(dx * dx + dy * dy);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (distance &lt; <span class="number">5</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">currentPathIndex</span>++;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">currentPathIndex</span> &gt;= <span class="variable language_">this</span>.<span class="property">path</span>.<span class="property">length</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">reachedEnd</span> = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> moveDistance = <span class="variable language_">this</span>.<span class="property">speed</span> * deltaTime;</span><br><span class="line">            <span class="keyword">const</span> moveX = (dx / distance) * moveDistance;</span><br><span class="line">            <span class="keyword">const</span> moveY = (dy / distance) * moveDistance;</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">x</span> += moveX;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">y</span> += moveY;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">takeDamage</span>(<span class="params">damage</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">health</span> -= damage;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">draw</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">        <span class="comment">// 敌人身体</span></span><br><span class="line">        ctx.<span class="property">fillStyle</span> = <span class="variable language_">this</span>.<span class="property">color</span>;</span><br><span class="line">        ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">        ctx.<span class="title function_">arc</span>(<span class="variable language_">this</span>.<span class="property">x</span>, <span class="variable language_">this</span>.<span class="property">y</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>);</span><br><span class="line">        ctx.<span class="title function_">fill</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 敌人边框</span></span><br><span class="line">        ctx.<span class="property">strokeStyle</span> = <span class="string">&#x27;#000&#x27;</span>;</span><br><span class="line">        ctx.<span class="property">lineWidth</span> = <span class="number">2</span>;</span><br><span class="line">        ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">        ctx.<span class="title function_">arc</span>(<span class="variable language_">this</span>.<span class="property">x</span>, <span class="variable language_">this</span>.<span class="property">y</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>);</span><br><span class="line">        ctx.<span class="title function_">stroke</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 生命条</span></span><br><span class="line">        <span class="keyword">const</span> healthPercent = <span class="variable language_">this</span>.<span class="property">health</span> / <span class="variable language_">this</span>.<span class="property">maxHealth</span>;</span><br><span class="line">        <span class="keyword">const</span> barWidth = <span class="number">30</span>;</span><br><span class="line">        <span class="keyword">const</span> barHeight = <span class="number">5</span>;</span><br><span class="line">        </span><br><span class="line">        ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;#F44336&#x27;</span>;</span><br><span class="line">        ctx.<span class="title function_">fillRect</span>(</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">x</span> - barWidth / <span class="number">2</span>,</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">y</span> - <span class="number">25</span>,</span><br><span class="line">            barWidth,</span><br><span class="line">            barHeight</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;#4CAF50&#x27;</span>;</span><br><span class="line">        ctx.<span class="title function_">fillRect</span>(</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">x</span> - barWidth / <span class="number">2</span>,</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">y</span> - <span class="number">25</span>,</span><br><span class="line">            barWidth * healthPercent,</span><br><span class="line">            barHeight</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 生命条边框</span></span><br><span class="line">        ctx.<span class="property">strokeStyle</span> = <span class="string">&#x27;#000&#x27;</span>;</span><br><span class="line">        ctx.<span class="property">lineWidth</span> = <span class="number">1</span>;</span><br><span class="line">        ctx.<span class="title function_">strokeRect</span>(</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">x</span> - barWidth / <span class="number">2</span>,</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">y</span> - <span class="number">25</span>,</span><br><span class="line">            barWidth,</span><br><span class="line">            barHeight</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>创建 <code>frontend/js/entities/bullet.js</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Bullet</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">x, y, target, damage, type</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">x</span> = x;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">y</span> = y;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">target</span> = target;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">damage</span> = damage;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">type</span> = type;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">speed</span> = <span class="number">400</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">color</span> = <span class="variable language_">this</span>.<span class="title function_">getColorByType</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">size</span> = <span class="number">5</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">getColorByType</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span>(<span class="variable language_">this</span>.<span class="property">type</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;arrow&#x27;</span>: <span class="keyword">return</span> <span class="string">&#x27;#FFEB3B&#x27;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;cannon&#x27;</span>: <span class="keyword">return</span> <span class="string">&#x27;#FF5722&#x27;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;magic&#x27;</span>: <span class="keyword">return</span> <span class="string">&#x27;#E91E63&#x27;</span>;</span><br><span class="line">            <span class="attr">default</span>: <span class="keyword">return</span> <span class="string">&#x27;#FFFFFF&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">update</span>(<span class="params">deltaTime</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">target</span> || <span class="variable language_">this</span>.<span class="property">target</span>.<span class="property">health</span> &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> dx = <span class="variable language_">this</span>.<span class="property">target</span>.<span class="property">x</span> - <span class="variable language_">this</span>.<span class="property">x</span>;</span><br><span class="line">        <span class="keyword">const</span> dy = <span class="variable language_">this</span>.<span class="property">target</span>.<span class="property">y</span> - <span class="variable language_">this</span>.<span class="property">y</span>;</span><br><span class="line">        <span class="keyword">const</span> distance = <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(dx * dx + dy * dy);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (distance &lt; <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// 击中目标</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> moveDistance = <span class="variable language_">this</span>.<span class="property">speed</span> * deltaTime;</span><br><span class="line">        <span class="keyword">const</span> moveX = (dx / distance) * moveDistance;</span><br><span class="line">        <span class="keyword">const</span> moveY = (dy / distance) * moveDistance;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">x</span> += moveX;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">y</span> += moveY;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">checkCollision</span>(<span class="params">enemy</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> dx = enemy.<span class="property">x</span> - <span class="variable language_">this</span>.<span class="property">x</span>;</span><br><span class="line">        <span class="keyword">const</span> dy = enemy.<span class="property">y</span> - <span class="variable language_">this</span>.<span class="property">y</span>;</span><br><span class="line">        <span class="keyword">const</span> distance = <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(dx * dx + dy * dy);</span><br><span class="line">        <span class="keyword">return</span> distance &lt; (enemy.<span class="property">size</span> || <span class="number">15</span>) + <span class="variable language_">this</span>.<span class="property">size</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">draw</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">        <span class="comment">// 子弹主体</span></span><br><span class="line">        ctx.<span class="property">fillStyle</span> = <span class="variable language_">this</span>.<span class="property">color</span>;</span><br><span class="line">        ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">        ctx.<span class="title function_">arc</span>(<span class="variable language_">this</span>.<span class="property">x</span>, <span class="variable language_">this</span>.<span class="property">y</span>, <span class="variable language_">this</span>.<span class="property">size</span>, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>);</span><br><span class="line">        ctx.<span class="title function_">fill</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 子弹光晕</span></span><br><span class="line">        ctx.<span class="property">strokeStyle</span> = <span class="variable language_">this</span>.<span class="property">color</span>;</span><br><span class="line">        ctx.<span class="property">lineWidth</span> = <span class="number">2</span>;</span><br><span class="line">        ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">        ctx.<span class="title function_">arc</span>(<span class="variable language_">this</span>.<span class="property">x</span>, <span class="variable language_">this</span>.<span class="property">y</span>, <span class="variable language_">this</span>.<span class="property">size</span> + <span class="number">2</span>, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>);</span><br><span class="line">        ctx.<span class="title function_">stroke</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 子弹轨迹（仅对魔法和炮塔子弹）</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">type</span> === <span class="string">&#x27;magic&#x27;</span> || <span class="variable language_">this</span>.<span class="property">type</span> === <span class="string">&#x27;cannon&#x27;</span>) &#123;</span><br><span class="line">            ctx.<span class="property">strokeStyle</span> = <span class="variable language_">this</span>.<span class="property">color</span> + <span class="string">&#x27;80&#x27;</span>;</span><br><span class="line">            ctx.<span class="property">lineWidth</span> = <span class="number">3</span>;</span><br><span class="line">            ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">            ctx.<span class="title function_">moveTo</span>(<span class="variable language_">this</span>.<span class="property">x</span>, <span class="variable language_">this</span>.<span class="property">y</span>);</span><br><span class="line">            <span class="keyword">const</span> backX = <span class="variable language_">this</span>.<span class="property">x</span> - (<span class="variable language_">this</span>.<span class="property">target</span>.<span class="property">x</span> - <span class="variable language_">this</span>.<span class="property">x</span>) * <span class="number">0.1</span>;</span><br><span class="line">            <span class="keyword">const</span> backY = <span class="variable language_">this</span>.<span class="property">y</span> - (<span class="variable language_">this</span>.<span class="property">target</span>.<span class="property">y</span> - <span class="variable language_">this</span>.<span class="property">y</span>) * <span class="number">0.1</span>;</span><br><span class="line">            ctx.<span class="title function_">lineTo</span>(backX, backY);</span><br><span class="line">            ctx.<span class="title function_">stroke</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="第三阶段：Java后端服务（第4周）"><a href="#第三阶段：Java后端服务（第4周）" class="headerlink" title="第三阶段：Java后端服务（第4周）"></a>第三阶段：Java后端服务（第4周）</h3><h4 id="步骤6：Spring-Boot应用"><a href="#步骤6：Spring-Boot应用" class="headerlink" title="步骤6：Spring Boot应用"></a>步骤6：Spring Boot应用</h4><p>创建 <code>backend/pom.xml</code>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 </span></span></span><br><span class="line"><span class="string"><span class="tag">         http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.kingdomdefense<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kingdom-defense-backend<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Kingdom Defense Backend<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>11<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.h2database<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>h2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>创建 <code>backend/src/main/java/com/kingdomdefense/KingdomDefenseApplication.java</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kingdomdefense;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KingdomDefenseApplication</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(KingdomDefenseApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">home</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Kingdom Defense Backend Service is running!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/health&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">health</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;OK&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>创建 <code>backend/src/main/java/com/kingdomdefense/model/User.java</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kingdomdefense.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;users&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(unique = true, nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(unique = true)</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> highScore;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> totalGamesPlayed;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createdAt;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@OneToMany(mappedBy = &quot;user&quot;, cascade = CascadeType.ALL)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;GameScore&gt; scores;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PrePersist</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123;</span><br><span class="line">        createdAt = LocalDateTime.now();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Getters and Setters</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getId</span><span class="params">()</span> &#123; <span class="keyword">return</span> id; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Long id)</span> &#123; <span class="built_in">this</span>.id = id; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123; <span class="keyword">return</span> username; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUsername</span><span class="params">(String username)</span> &#123; <span class="built_in">this</span>.username = username; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123; <span class="keyword">return</span> password; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPassword</span><span class="params">(String password)</span> &#123; <span class="built_in">this</span>.password = password; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getEmail</span><span class="params">()</span> &#123; <span class="keyword">return</span> email; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEmail</span><span class="params">(String email)</span> &#123; <span class="built_in">this</span>.email = email; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getHighScore</span><span class="params">()</span> &#123; <span class="keyword">return</span> highScore; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setHighScore</span><span class="params">(<span class="type">int</span> highScore)</span> &#123; <span class="built_in">this</span>.highScore = highScore; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getTotalGamesPlayed</span><span class="params">()</span> &#123; <span class="keyword">return</span> totalGamesPlayed; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTotalGamesPlayed</span><span class="params">(<span class="type">int</span> totalGamesPlayed)</span> &#123; <span class="built_in">this</span>.totalGamesPlayed = totalGamesPlayed; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> LocalDateTime <span class="title function_">getCreatedAt</span><span class="params">()</span> &#123; <span class="keyword">return</span> createdAt; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCreatedAt</span><span class="params">(LocalDateTime createdAt)</span> &#123; <span class="built_in">this</span>.createdAt = createdAt; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;GameScore&gt; <span class="title function_">getScores</span><span class="params">()</span> &#123; <span class="keyword">return</span> scores; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setScores</span><span class="params">(List&lt;GameScore&gt; scores)</span> &#123; <span class="built_in">this</span>.scores = scores; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>创建 <code>backend/src/main/java/com/kingdomdefense/model/GameScore.java</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kingdomdefense.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;game_scores&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GameScore</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ManyToOne</span></span><br><span class="line">    <span class="meta">@JoinColumn(name = &quot;user_id&quot;, nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> score;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> waveReached;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> enemiesDefeated;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> towersBuilt;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> LocalDateTime gameDate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PrePersist</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123;</span><br><span class="line">        gameDate = LocalDateTime.now();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Getters and Setters</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getId</span><span class="params">()</span> &#123; <span class="keyword">return</span> id; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Long id)</span> &#123; <span class="built_in">this</span>.id = id; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUser</span><span class="params">()</span> &#123; <span class="keyword">return</span> user; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUser</span><span class="params">(User user)</span> &#123; <span class="built_in">this</span>.user = user; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getScore</span><span class="params">()</span> &#123; <span class="keyword">return</span> score; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setScore</span><span class="params">(<span class="type">int</span> score)</span> &#123; <span class="built_in">this</span>.score = score; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getWaveReached</span><span class="params">()</span> &#123; <span class="keyword">return</span> waveReached; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setWaveReached</span><span class="params">(<span class="type">int</span> waveReached)</span> &#123; <span class="built_in">this</span>.waveReached = waveReached; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getEnemiesDefeated</span><span class="params">()</span> &#123; <span class="keyword">return</span> enemiesDefeated; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnemiesDefeated</span><span class="params">(<span class="type">int</span> enemiesDefeated)</span> &#123; <span class="built_in">this</span>.enemiesDefeated = enemiesDefeated; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getTowersBuilt</span><span class="params">()</span> &#123; <span class="keyword">return</span> towersBuilt; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTowersBuilt</span><span class="params">(<span class="type">int</span> towersBuilt)</span> &#123; <span class="built_in">this</span>.towersBuilt = towersBuilt; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> LocalDateTime <span class="title function_">getGameDate</span><span class="params">()</span> &#123; <span class="keyword">return</span> gameDate; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setGameDate</span><span class="params">(LocalDateTime gameDate)</span> &#123; <span class="built_in">this</span>.gameDate = gameDate; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>创建 <code>backend/src/main/java/com/kingdomdefense/controller/ScoreController.java</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kingdomdefense.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kingdomdefense.model.GameScore;</span><br><span class="line"><span class="keyword">import</span> com.kingdomdefense.service.ScoreService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/scores&quot;)</span></span><br><span class="line"><span class="meta">@CrossOrigin(origins = &quot;*&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScoreController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ScoreService scoreService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;GameScore&gt; <span class="title function_">saveScore</span><span class="params">(<span class="meta">@RequestBody</span> GameScore score)</span> &#123;</span><br><span class="line">        <span class="type">GameScore</span> <span class="variable">savedScore</span> <span class="operator">=</span> scoreService.saveScore(score);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(savedScore);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/leaderboard&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;List&lt;Map&lt;String, Object&gt;&gt;&gt; <span class="title function_">getLeaderboard</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(defaultValue = &quot;10&quot;)</span> <span class="type">int</span> limit)</span> &#123;</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; leaderboard = scoreService.getLeaderboard(limit);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(leaderboard);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/&#123;userId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;List&lt;GameScore&gt;&gt; <span class="title function_">getUserScores</span><span class="params">(<span class="meta">@PathVariable</span> Long userId)</span> &#123;</span><br><span class="line">        List&lt;GameScore&gt; scores = scoreService.getUserScores(userId);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(scores);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="第四阶段：Python-AI模块（第5周）"><a href="#第四阶段：Python-AI模块（第5周）" class="headerlink" title="第四阶段：Python AI模块（第5周）"></a>第四阶段：Python AI模块（第5周）</h3><h4 id="步骤7：AI引擎"><a href="#步骤7：AI引擎" class="headerlink" title="步骤7：AI引擎"></a>步骤7：AI引擎</h4><p>创建 <code>ai-engine/requirements.txt</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">flask==2.3.2</span><br><span class="line">flask-cors==4.0.0</span><br><span class="line">numpy==1.24.3</span><br><span class="line">pandas==2.0.2</span><br><span class="line">scikit-learn==1.2.2</span><br><span class="line">matplotlib==3.7.1</span><br><span class="line">pygame==2.5.0</span><br></pre></td></tr></table></figure>



<p>创建 <code>ai-engine/app.py</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify</span><br><span class="line"><span class="keyword">from</span> flask_cors <span class="keyword">import</span> CORS</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> game_ai.enemy_ai <span class="keyword">import</span> EnemyAI</span><br><span class="line"><span class="keyword">from</span> game_ai.tower_placement_ai <span class="keyword">import</span> TowerPlacementAI</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">CORS(app)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化AI系统</span></span><br><span class="line">enemy_ai = EnemyAI()</span><br><span class="line">tower_ai = TowerPlacementAI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/ai/enemy/move&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_enemy_move</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    计算敌人的下一步移动决策</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    data = request.json</span><br><span class="line">    enemy_data = data.get(<span class="string">&#x27;enemy&#x27;</span>)</span><br><span class="line">    game_state = data.get(<span class="string">&#x27;gameState&#x27;</span>)</span><br><span class="line">    towers = data.get(<span class="string">&#x27;towers&#x27;</span>, [])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 获取AI建议的移动方向</span></span><br><span class="line">    move = enemy_ai.calculate_move(enemy_data, game_state, towers)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">        <span class="string">&#x27;success&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&#x27;move&#x27;</span>: move</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/ai/tower/placement&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_tower_placement</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    获取最佳的塔放置位置</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    data = request.json</span><br><span class="line">    map_layout = data.get(<span class="string">&#x27;map&#x27;</span>)</span><br><span class="line">    enemy_path = data.get(<span class="string">&#x27;enemyPath&#x27;</span>)</span><br><span class="line">    existing_towers = data.get(<span class="string">&#x27;towers&#x27;</span>, [])</span><br><span class="line">    tower_type = data.get(<span class="string">&#x27;towerType&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 获取AI建议的最佳位置</span></span><br><span class="line">    positions = tower_ai.get_best_positions(</span><br><span class="line">        map_layout, </span><br><span class="line">        enemy_path, </span><br><span class="line">        existing_towers, </span><br><span class="line">        tower_type</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">        <span class="string">&#x27;success&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&#x27;positions&#x27;</span>: positions[:<span class="number">5</span>]  <span class="comment"># 返回前5个最佳位置</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/ai/difficulty/adjust&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">adjust_difficulty</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    根据玩家表现调整游戏难度</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    data = request.json</span><br><span class="line">    player_performance = data.get(<span class="string">&#x27;performance&#x27;</span>)</span><br><span class="line">    current_difficulty = data.get(<span class="string">&#x27;difficulty&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 计算新的难度</span></span><br><span class="line">    new_difficulty = enemy_ai.adjust_difficulty(</span><br><span class="line">        player_performance, </span><br><span class="line">        current_difficulty</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">        <span class="string">&#x27;success&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&#x27;difficulty&#x27;</span>: new_difficulty</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/ai/simulate/wave&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">simulate_wave</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    模拟一波敌人的行为，用于预测和平衡</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    data = request.json</span><br><span class="line">    wave_composition = data.get(<span class="string">&#x27;wave&#x27;</span>)</span><br><span class="line">    player_towers = data.get(<span class="string">&#x27;towers&#x27;</span>)</span><br><span class="line">    map_layout = data.get(<span class="string">&#x27;map&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 运行模拟</span></span><br><span class="line">    simulation_result = enemy_ai.simulate_wave(</span><br><span class="line">        wave_composition,</span><br><span class="line">        player_towers,</span><br><span class="line">        map_layout</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">        <span class="string">&#x27;success&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&#x27;simulation&#x27;</span>: simulation_result</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/health&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">health_check</span>():</span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;status&#x27;</span>: <span class="string">&#x27;healthy&#x27;</span>, <span class="string">&#x27;service&#x27;</span>: <span class="string">&#x27;AI Engine&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Starting Kingdom Defense AI Engine...&quot;</span>)</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">5001</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>



<p>创建 <code>ai-engine/game_ai/enemy_ai.py</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Tuple</span>, <span class="type">Any</span></span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EnemyAI</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.learning_rate = <span class="number">0.1</span></span><br><span class="line">        self.discount_factor = <span class="number">0.9</span></span><br><span class="line">        self.epsilon = <span class="number">0.1</span>  <span class="comment"># 探索率</span></span><br><span class="line">        self.q_table = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">calculate_move</span>(<span class="params">self, enemy: <span class="type">Dict</span>, game_state: <span class="type">Dict</span>, towers: <span class="type">List</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        计算敌人的移动决策</span></span><br><span class="line"><span class="string">        返回: &#123;&#x27;dx&#x27;: float, &#x27;dy&#x27;: float, &#x27;action&#x27;: str&#125;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        enemy_type = enemy.get(<span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;infantry&#x27;</span>)</span><br><span class="line">        enemy_x = enemy.get(<span class="string">&#x27;x&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">        enemy_y = enemy.get(<span class="string">&#x27;y&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">        enemy_health = enemy.get(<span class="string">&#x27;health&#x27;</span>, <span class="number">100</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取当前状态</span></span><br><span class="line">        state = self._get_state(enemy, game_state, towers)</span><br><span class="line">        state_key = self._state_to_key(state)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ε-贪婪策略选择动作</span></span><br><span class="line">        <span class="keyword">if</span> random.random() &lt; self.epsilon:</span><br><span class="line">            action = self._get_random_action()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            action = self._get_best_action(state_key)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 执行动作</span></span><br><span class="line">        move = self._execute_action(action, enemy, towers)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> move</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_state</span>(<span class="params">self, enemy: <span class="type">Dict</span>, game_state: <span class="type">Dict</span>, towers: <span class="type">List</span></span>) -&gt; <span class="type">Tuple</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        将游戏状态转换为AI可以理解的状态</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        enemy_x = enemy.get(<span class="string">&#x27;x&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">        enemy_y = enemy.get(<span class="string">&#x27;y&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">        enemy_health = enemy.get(<span class="string">&#x27;health&#x27;</span>, <span class="number">100</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算最近的塔</span></span><br><span class="line">        closest_tower = <span class="literal">None</span></span><br><span class="line">        min_distance = <span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> tower <span class="keyword">in</span> towers:</span><br><span class="line">            tower_x = tower.get(<span class="string">&#x27;x&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">            tower_y = tower.get(<span class="string">&#x27;y&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">            distance = math.sqrt((tower_x - enemy_x)**<span class="number">2</span> + (tower_y - enemy_y)**<span class="number">2</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> distance &lt; min_distance:</span><br><span class="line">                min_distance = distance</span><br><span class="line">                closest_tower = tower</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 简化状态表示</span></span><br><span class="line">        health_state = <span class="number">0</span> <span class="keyword">if</span> enemy_health &gt; <span class="number">50</span> <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line">        distance_state = <span class="number">0</span> <span class="keyword">if</span> min_distance &gt; <span class="number">200</span> <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line">        tower_threat = <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> closest_tower:</span><br><span class="line">            tower_type = closest_tower.get(<span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;arrow&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> tower_type == <span class="string">&#x27;cannon&#x27;</span>:</span><br><span class="line">                tower_threat = <span class="number">2</span></span><br><span class="line">            <span class="keyword">elif</span> tower_type == <span class="string">&#x27;magic&#x27;</span>:</span><br><span class="line">                tower_threat = <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                tower_threat = <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> (health_state, distance_state, tower_threat)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_state_to_key</span>(<span class="params">self, state: <span class="type">Tuple</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;将状态元组转换为字符串键&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(state)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_random_action</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;随机选择一个动作&quot;&quot;&quot;</span></span><br><span class="line">        actions = [<span class="string">&#x27;move_forward&#x27;</span>, <span class="string">&#x27;move_left&#x27;</span>, <span class="string">&#x27;move_right&#x27;</span>, <span class="string">&#x27;retreat&#x27;</span>, <span class="string">&#x27;attack&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> random.choice(actions)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_best_action</span>(<span class="params">self, state_key: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;从Q表获取最佳动作&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> state_key <span class="keyword">not</span> <span class="keyword">in</span> self.q_table:</span><br><span class="line">            <span class="keyword">return</span> self._get_random_action()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 返回Q值最高的动作</span></span><br><span class="line">        actions = self.q_table[state_key]</span><br><span class="line">        best_action = <span class="built_in">max</span>(actions, key=actions.get)</span><br><span class="line">        <span class="keyword">return</span> best_action</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_execute_action</span>(<span class="params">self, action: <span class="built_in">str</span>, enemy: <span class="type">Dict</span>, towers: <span class="type">List</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;执行选择的动作&quot;&quot;&quot;</span></span><br><span class="line">        enemy_type = enemy.get(<span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;infantry&#x27;</span>)</span><br><span class="line">        base_speed = self._get_base_speed(enemy_type)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> action == <span class="string">&#x27;move_forward&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&#x27;dx&#x27;</span>: base_speed, <span class="string">&#x27;dy&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;action&#x27;</span>: <span class="string">&#x27;move&#x27;</span>&#125;</span><br><span class="line">        <span class="keyword">elif</span> action == <span class="string">&#x27;move_left&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&#x27;dx&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;dy&#x27;</span>: -base_speed, <span class="string">&#x27;action&#x27;</span>: <span class="string">&#x27;move&#x27;</span>&#125;</span><br><span class="line">        <span class="keyword">elif</span> action == <span class="string">&#x27;move_right&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&#x27;dx&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;dy&#x27;</span>: base_speed, <span class="string">&#x27;action&#x27;</span>: <span class="string">&#x27;move&#x27;</span>&#125;</span><br><span class="line">        <span class="keyword">elif</span> action == <span class="string">&#x27;retreat&#x27;</span>:</span><br><span class="line">            <span class="comment"># 向反方向移动</span></span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&#x27;dx&#x27;</span>: -base_speed/<span class="number">2</span>, <span class="string">&#x27;dy&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;action&#x27;</span>: <span class="string">&#x27;retreat&#x27;</span>&#125;</span><br><span class="line">        <span class="keyword">elif</span> action == <span class="string">&#x27;attack&#x27;</span>:</span><br><span class="line">            <span class="comment"># 如果有塔在范围内，尝试攻击</span></span><br><span class="line">            closest_tower = self._find_closest_tower(enemy, towers)</span><br><span class="line">            <span class="keyword">if</span> closest_tower:</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">&#x27;dx&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;dy&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;action&#x27;</span>: <span class="string">&#x27;attack&#x27;</span>, <span class="string">&#x27;target&#x27;</span>: closest_tower&#125;</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">&#x27;dx&#x27;</span>: base_speed, <span class="string">&#x27;dy&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;action&#x27;</span>: <span class="string">&#x27;move&#x27;</span>&#125;</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&#x27;dx&#x27;</span>: base_speed, <span class="string">&#x27;dy&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;action&#x27;</span>: <span class="string">&#x27;move&#x27;</span>&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_base_speed</span>(<span class="params">self, enemy_type: <span class="built_in">str</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;根据敌人类型返回基础速度&quot;&quot;&quot;</span></span><br><span class="line">        speeds = &#123;</span><br><span class="line">            <span class="string">&#x27;infantry&#x27;</span>: <span class="number">1.0</span>,</span><br><span class="line">            <span class="string">&#x27;cavalry&#x27;</span>: <span class="number">2.0</span>,</span><br><span class="line">            <span class="string">&#x27;armored&#x27;</span>: <span class="number">0.5</span>,</span><br><span class="line">            <span class="string">&#x27;flying&#x27;</span>: <span class="number">1.5</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> speeds.get(enemy_type, <span class="number">1.0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_find_closest_tower</span>(<span class="params">self, enemy: <span class="type">Dict</span>, towers: <span class="type">List</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;找到最近的塔&quot;&quot;&quot;</span></span><br><span class="line">        enemy_x = enemy.get(<span class="string">&#x27;x&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">        enemy_y = enemy.get(<span class="string">&#x27;y&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        closest_tower = <span class="literal">None</span></span><br><span class="line">        min_distance = <span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> tower <span class="keyword">in</span> towers:</span><br><span class="line">            tower_x = tower.get(<span class="string">&#x27;x&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">            tower_y = tower.get(<span class="string">&#x27;y&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">            distance = math.sqrt((tower_x - enemy_x)**<span class="number">2</span> + (tower_y - enemy_y)**<span class="number">2</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> distance &lt; min_distance:</span><br><span class="line">                min_distance = distance</span><br><span class="line">                closest_tower = tower</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> closest_tower <span class="keyword">if</span> min_distance &lt; <span class="number">50</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">adjust_difficulty</span>(<span class="params">self, player_performance: <span class="type">Dict</span>, current_difficulty: <span class="built_in">float</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        根据玩家表现调整游戏难度</span></span><br><span class="line"><span class="string">        player_performance: &#123;&#x27;win_rate&#x27;: float, &#x27;avg_score&#x27;: float, &#x27;avg_wave&#x27;: float&#125;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        win_rate = player_performance.get(<span class="string">&#x27;win_rate&#x27;</span>, <span class="number">0.5</span>)</span><br><span class="line">        avg_score = player_performance.get(<span class="string">&#x27;avg_score&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 简单的难度调整算法</span></span><br><span class="line">        <span class="keyword">if</span> win_rate &gt; <span class="number">0.7</span>:</span><br><span class="line">            <span class="comment"># 玩家表现太好，增加难度</span></span><br><span class="line">            new_difficulty = current_difficulty * <span class="number">1.2</span></span><br><span class="line">        <span class="keyword">elif</span> win_rate &lt; <span class="number">0.3</span>:</span><br><span class="line">            <span class="comment"># 玩家表现太差，降低难度</span></span><br><span class="line">            new_difficulty = current_difficulty * <span class="number">0.8</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 保持当前难度</span></span><br><span class="line">            new_difficulty = current_difficulty</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 限制难度范围</span></span><br><span class="line">        new_difficulty = <span class="built_in">max</span>(<span class="number">0.5</span>, <span class="built_in">min</span>(new_difficulty, <span class="number">3.0</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> new_difficulty</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">simulate_wave</span>(<span class="params">self, wave_composition: <span class="type">List</span>, player_towers: <span class="type">List</span>, map_layout: <span class="type">Dict</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        模拟一波敌人的行为</span></span><br><span class="line"><span class="string">        返回模拟结果</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 简化模拟：计算生存概率</span></span><br><span class="line">        total_enemies = <span class="built_in">len</span>(wave_composition)</span><br><span class="line">        enemy_strength = <span class="built_in">sum</span>(self._get_enemy_power(enemy) <span class="keyword">for</span> enemy <span class="keyword">in</span> wave_composition)</span><br><span class="line">        tower_strength = <span class="built_in">sum</span>(self._get_tower_power(tower) <span class="keyword">for</span> tower <span class="keyword">in</span> player_towers)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 简单预测模型</span></span><br><span class="line">        survival_rate = enemy_strength / (tower_strength + <span class="number">0.1</span>)</span><br><span class="line">        survival_rate = <span class="built_in">min</span>(survival_rate, <span class="number">1.0</span>)</span><br><span class="line">        </span><br><span class="line">        predicted_survivors = <span class="built_in">int</span>(total_enemies * survival_rate)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;total_enemies&#x27;</span>: total_enemies,</span><br><span class="line">            <span class="string">&#x27;predicted_survivors&#x27;</span>: predicted_survivors,</span><br><span class="line">            <span class="string">&#x27;survival_rate&#x27;</span>: survival_rate,</span><br><span class="line">            <span class="string">&#x27;expected_damage&#x27;</span>: predicted_survivors * <span class="number">10</span>  <span class="comment"># 每个幸存者造成10点伤害</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_enemy_power</span>(<span class="params">self, enemy: <span class="type">Dict</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算敌人的战斗力&quot;&quot;&quot;</span></span><br><span class="line">        enemy_type = enemy.get(<span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;infantry&#x27;</span>)</span><br><span class="line">        health = enemy.get(<span class="string">&#x27;health&#x27;</span>, <span class="number">100</span>)</span><br><span class="line">        speed = enemy.get(<span class="string">&#x27;speed&#x27;</span>, <span class="number">1.0</span>)</span><br><span class="line">        </span><br><span class="line">        type_multiplier = &#123;</span><br><span class="line">            <span class="string">&#x27;infantry&#x27;</span>: <span class="number">1.0</span>,</span><br><span class="line">            <span class="string">&#x27;cavalry&#x27;</span>: <span class="number">1.5</span>,</span><br><span class="line">            <span class="string">&#x27;armored&#x27;</span>: <span class="number">2.0</span>,</span><br><span class="line">            <span class="string">&#x27;flying&#x27;</span>: <span class="number">1.2</span></span><br><span class="line">        &#125;.get(enemy_type, <span class="number">1.0</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> health * speed * type_multiplier / <span class="number">100</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_tower_power</span>(<span class="params">self, tower: <span class="type">Dict</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算塔的战斗力&quot;&quot;&quot;</span></span><br><span class="line">        tower_type = tower.get(<span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;arrow&#x27;</span>)</span><br><span class="line">        damage = tower.get(<span class="string">&#x27;damage&#x27;</span>, <span class="number">10</span>)</span><br><span class="line">        range_ = tower.get(<span class="string">&#x27;range&#x27;</span>, <span class="number">200</span>)</span><br><span class="line">        attack_speed = tower.get(<span class="string">&#x27;attackSpeed&#x27;</span>, <span class="number">1.0</span>)</span><br><span class="line">        </span><br><span class="line">        type_multiplier = &#123;</span><br><span class="line">            <span class="string">&#x27;arrow&#x27;</span>: <span class="number">1.0</span>,</span><br><span class="line">            <span class="string">&#x27;cannon&#x27;</span>: <span class="number">1.8</span>,</span><br><span class="line">            <span class="string">&#x27;magic&#x27;</span>: <span class="number">1.5</span></span><br><span class="line">        &#125;.get(tower_type, <span class="number">1.0</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> damage * range_ * attack_speed * type_multiplier / <span class="number">10000</span></span><br></pre></td></tr></table></figure>



<h3 id="第五阶段：C核心引擎（第6周）"><a href="#第五阶段：C核心引擎（第6周）" class="headerlink" title="第五阶段：C核心引擎（第6周）"></a>第五阶段：C核心引擎（第6周）</h3><h4 id="步骤8：高性能路径查找"><a href="#步骤8：高性能路径查找" class="headerlink" title="步骤8：高性能路径查找"></a>步骤8：高性能路径查找</h4><p>创建 <code>engine-core/src/pathfinding/a_star.c</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;limits.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;a_star.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 节点结构</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> x, y;</span><br><span class="line">    <span class="type">int</span> g, h, f;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span>* <span class="title">parent</span>;</span></span><br><span class="line">    <span class="type">int</span> is_obstacle;</span><br><span class="line">&#125; Node;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 网格结构</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Grid</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> width, height;</span><br><span class="line">    Node** nodes;</span><br><span class="line">&#125; Grid;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建网格</span></span><br><span class="line">Grid* <span class="title function_">create_grid</span><span class="params">(<span class="type">int</span> width, <span class="type">int</span> height)</span> &#123;</span><br><span class="line">    Grid* grid = (Grid*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Grid));</span><br><span class="line">    grid-&gt;width = width;</span><br><span class="line">    grid-&gt;height = height;</span><br><span class="line">    </span><br><span class="line">    grid-&gt;nodes = (Node**)<span class="built_in">malloc</span>(height * <span class="keyword">sizeof</span>(Node*));</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> y = <span class="number">0</span>; y &lt; height; y++) &#123;</span><br><span class="line">        grid-&gt;nodes[y] = (Node*)<span class="built_in">malloc</span>(width * <span class="keyword">sizeof</span>(Node));</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; width; x++) &#123;</span><br><span class="line">            grid-&gt;nodes[y][x].x = x;</span><br><span class="line">            grid-&gt;nodes[y][x].y = y;</span><br><span class="line">            grid-&gt;nodes[y][x].g = <span class="number">0</span>;</span><br><span class="line">            grid-&gt;nodes[y][x].h = <span class="number">0</span>;</span><br><span class="line">            grid-&gt;nodes[y][x].f = <span class="number">0</span>;</span><br><span class="line">            grid-&gt;nodes[y][x].parent = <span class="literal">NULL</span>;</span><br><span class="line">            grid-&gt;nodes[y][x].is_obstacle = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> grid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放网格内存</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">free_grid</span><span class="params">(Grid* grid)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> y = <span class="number">0</span>; y &lt; grid-&gt;height; y++) &#123;</span><br><span class="line">        <span class="built_in">free</span>(grid-&gt;nodes[y]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(grid-&gt;nodes);</span><br><span class="line">    <span class="built_in">free</span>(grid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算启发式函数（曼哈顿距离）</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">heuristic</span><span class="params">(Node* a, Node* b)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">abs</span>(a-&gt;x - b-&gt;x) + <span class="built_in">abs</span>(a-&gt;y - b-&gt;y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查节点是否在列表中</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">is_in_list</span><span class="params">(Node* node, Node** <span class="built_in">list</span>, <span class="type">int</span> list_size)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; list_size; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">list</span>[i]-&gt;x == node-&gt;x &amp;&amp; <span class="built_in">list</span>[i]-&gt;y == node-&gt;y) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A*路径查找算法</span></span><br><span class="line">Path* <span class="title function_">find_path</span><span class="params">(Grid* grid, <span class="type">int</span> start_x, <span class="type">int</span> start_y, <span class="type">int</span> end_x, <span class="type">int</span> end_y)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (start_x &lt; <span class="number">0</span> || start_x &gt;= grid-&gt;width || start_y &lt; <span class="number">0</span> || start_y &gt;= grid-&gt;height ||</span><br><span class="line">        end_x &lt; <span class="number">0</span> || end_x &gt;= grid-&gt;width || end_y &lt; <span class="number">0</span> || end_y &gt;= grid-&gt;height) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Node* start = &amp;grid-&gt;nodes[start_y][start_x];</span><br><span class="line">    Node* end = &amp;grid-&gt;nodes[end_y][end_x];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (start-&gt;is_obstacle || end-&gt;is_obstacle) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化开放列表和关闭列表</span></span><br><span class="line">    Node** open_list = (Node**)<span class="built_in">malloc</span>(grid-&gt;width * grid-&gt;height * <span class="keyword">sizeof</span>(Node*));</span><br><span class="line">    Node** closed_list = (Node**)<span class="built_in">malloc</span>(grid-&gt;width * grid-&gt;height * <span class="keyword">sizeof</span>(Node*));</span><br><span class="line">    <span class="type">int</span> open_size = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> closed_size = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加起点到开放列表</span></span><br><span class="line">    open_list[open_size++] = start;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (open_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 找到开放列表中f值最小的节点</span></span><br><span class="line">        <span class="type">int</span> current_index = <span class="number">0</span>;</span><br><span class="line">        Node* current = open_list[<span class="number">0</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; open_size; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (open_list[i]-&gt;f &lt; current-&gt;f) &#123;</span><br><span class="line">                current = open_list[i];</span><br><span class="line">                current_index = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果当前节点是终点，重建路径</span></span><br><span class="line">        <span class="keyword">if</span> (current-&gt;x == end-&gt;x &amp;&amp; current-&gt;y == end-&gt;y) &#123;</span><br><span class="line">            Path* path = (Path*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Path));</span><br><span class="line">            path-&gt;points = (Point*)<span class="built_in">malloc</span>(<span class="number">100</span> * <span class="keyword">sizeof</span>(Point)); <span class="comment">// 预分配空间</span></span><br><span class="line">            path-&gt;length = <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 重建路径</span></span><br><span class="line">            Node* node = current;</span><br><span class="line">            <span class="keyword">while</span> (node != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (path-&gt;length &lt; <span class="number">100</span>) &#123;</span><br><span class="line">                    path-&gt;points[path-&gt;length].x = node-&gt;x;</span><br><span class="line">                    path-&gt;points[path-&gt;length].y = node-&gt;y;</span><br><span class="line">                    path-&gt;length++;</span><br><span class="line">                &#125;</span><br><span class="line">                node = node-&gt;parent;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 反转路径（从起点到终点）</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; path-&gt;length / <span class="number">2</span>; i++) &#123;</span><br><span class="line">                Point temp = path-&gt;points[i];</span><br><span class="line">                path-&gt;points[i] = path-&gt;points[path-&gt;length - <span class="number">1</span> - i];</span><br><span class="line">                path-&gt;points[path-&gt;length - <span class="number">1</span> - i] = temp;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">free</span>(open_list);</span><br><span class="line">            <span class="built_in">free</span>(closed_list);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> path;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将当前节点从开放列表移到关闭列表</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = current_index; i &lt; open_size - <span class="number">1</span>; i++) &#123;</span><br><span class="line">            open_list[i] = open_list[i + <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        open_size--;</span><br><span class="line">        closed_list[closed_size++] = current;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查邻居节点</span></span><br><span class="line">        <span class="type">int</span> dx[] = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">-1</span>&#125;;</span><br><span class="line">        <span class="type">int</span> dy[] = &#123;<span class="number">-1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>&#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> new_x = current-&gt;x + dx[i];</span><br><span class="line">            <span class="type">int</span> new_y = current-&gt;y + dy[i];</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 检查边界</span></span><br><span class="line">            <span class="keyword">if</span> (new_x &lt; <span class="number">0</span> || new_x &gt;= grid-&gt;width || new_y &lt; <span class="number">0</span> || new_y &gt;= grid-&gt;height) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            Node* neighbor = &amp;grid-&gt;nodes[new_y][new_x];</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 跳过障碍物和关闭列表中的节点</span></span><br><span class="line">            <span class="keyword">if</span> (neighbor-&gt;is_obstacle || is_in_list(neighbor, closed_list, closed_size)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 计算新的g值</span></span><br><span class="line">            <span class="type">int</span> new_g = current-&gt;g + <span class="number">1</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果邻居不在开放列表中，或者新的g值更小</span></span><br><span class="line">            <span class="keyword">if</span> (!is_in_list(neighbor, open_list, open_size) || new_g &lt; neighbor-&gt;g) &#123;</span><br><span class="line">                neighbor-&gt;g = new_g;</span><br><span class="line">                neighbor-&gt;h = heuristic(neighbor, end);</span><br><span class="line">                neighbor-&gt;f = neighbor-&gt;g + neighbor-&gt;h;</span><br><span class="line">                neighbor-&gt;parent = current;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (!is_in_list(neighbor, open_list, open_size)) &#123;</span><br><span class="line">                    open_list[open_size++] = neighbor;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 没有找到路径</span></span><br><span class="line">    <span class="built_in">free</span>(open_list);</span><br><span class="line">    <span class="built_in">free</span>(closed_list);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放路径内存</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">free_path</span><span class="params">(Path* path)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (path) &#123;</span><br><span class="line">        <span class="built_in">free</span>(path-&gt;points);</span><br><span class="line">        <span class="built_in">free</span>(path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简单测试函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">test_a_star</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Testing A* pathfinding...\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建10x10网格</span></span><br><span class="line">    Grid* grid = create_grid(<span class="number">10</span>, <span class="number">10</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置一些障碍物</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">3</span>; i &lt; <span class="number">7</span>; i++) &#123;</span><br><span class="line">        grid-&gt;nodes[<span class="number">5</span>][i].is_obstacle = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 查找从(0,0)到(9,9)的路径</span></span><br><span class="line">    Path* path = find_path(grid, <span class="number">0</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">9</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (path) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Path found with %d points:\n&quot;</span>, path-&gt;length);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; path-&gt;length; i++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;(%d, %d) &quot;</span>, path-&gt;points[i].x, path-&gt;points[i].y);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        free_path(path);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;No path found!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    free_grid(grid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>创建 <code>engine-core/src/main.c</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pathfinding/a_star.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Kingdom Defense Core Engine\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;============================\n\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 测试A*路径查找</span></span><br><span class="line">    test_a_star();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这里可以添加更多测试</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nCore engine tests completed.\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="第六阶段：Shell自动化脚本（第7周）"><a href="#第六阶段：Shell自动化脚本（第7周）" class="headerlink" title="第六阶段：Shell自动化脚本（第7周）"></a>第六阶段：Shell自动化脚本（第7周）</h3><h4 id="步骤9：构建和部署脚本"><a href="#步骤9：构建和部署脚本" class="headerlink" title="步骤9：构建和部署脚本"></a>步骤9：构建和部署脚本</h4><p>创建 <code>scripts/build_all.sh</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Kingdom Defense - 构建脚本</span></span><br><span class="line"><span class="comment"># 构建所有组件：前端、后端、AI引擎、C核心</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e  <span class="comment"># 遇到错误时退出</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=========================================&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;    Kingdom Defense - 构建系统&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=========================================&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 颜色定义</span></span><br><span class="line">RED=<span class="string">&#x27;\033[0;31m&#x27;</span></span><br><span class="line">GREEN=<span class="string">&#x27;\033[0;32m&#x27;</span></span><br><span class="line">YELLOW=<span class="string">&#x27;\033[1;33m&#x27;</span></span><br><span class="line">NC=<span class="string">&#x27;\033[0m&#x27;</span> <span class="comment"># No Color</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 函数：打印带颜色的消息</span></span><br><span class="line"><span class="function"><span class="title">print_message</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>[INFO]<span class="variable">$&#123;NC&#125;</span> <span class="variable">$1</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">print_warning</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>[WARN]<span class="variable">$&#123;NC&#125;</span> <span class="variable">$1</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">print_error</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>[ERROR]<span class="variable">$&#123;NC&#125;</span> <span class="variable">$1</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查必要工具</span></span><br><span class="line"><span class="function"><span class="title">check_dependencies</span></span>() &#123;</span><br><span class="line">    print_message <span class="string">&quot;检查系统依赖...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查Node.js</span></span><br><span class="line">    <span class="keyword">if</span> ! <span class="built_in">command</span> -v node &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">        print_error <span class="string">&quot;Node.js 未安装&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    print_message <span class="string">&quot;Node.js 版本: <span class="subst">$(node --version)</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查Java</span></span><br><span class="line">    <span class="keyword">if</span> ! <span class="built_in">command</span> -v java &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">        print_error <span class="string">&quot;Java 未安装&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    print_message <span class="string">&quot;Java 版本: <span class="subst">$(java -version 2&gt;&amp;1 | head -n 1)</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查Python</span></span><br><span class="line">    <span class="keyword">if</span> ! <span class="built_in">command</span> -v python3 &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">        print_error <span class="string">&quot;Python3 未安装&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    print_message <span class="string">&quot;Python 版本: <span class="subst">$(python3 --version)</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查GCC</span></span><br><span class="line">    <span class="keyword">if</span> ! <span class="built_in">command</span> -v gcc &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">        print_error <span class="string">&quot;GCC 未安装&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    print_message <span class="string">&quot;GCC 版本: <span class="subst">$(gcc --version | head -n 1)</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    print_message <span class="string">&quot;所有依赖检查通过 ✓&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建前端</span></span><br><span class="line"><span class="function"><span class="title">build_frontend</span></span>() &#123;</span><br><span class="line">    print_message <span class="string">&quot;开始构建前端...&quot;</span></span><br><span class="line">    <span class="built_in">cd</span> frontend</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查是否安装了必要的npm包</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -d <span class="string">&quot;node_modules&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        print_message <span class="string">&quot;安装前端依赖...&quot;</span></span><br><span class="line">        npm install</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建生产版本</span></span><br><span class="line">    print_message <span class="string">&quot;创建生产构建...&quot;</span></span><br><span class="line">    <span class="comment"># 这里可以添加具体的构建命令，如使用webpack等</span></span><br><span class="line">    <span class="comment"># 简化版本：直接复制文件</span></span><br><span class="line">    <span class="built_in">mkdir</span> -p ../dist/frontend</span><br><span class="line">    <span class="built_in">cp</span> -r . ../dist/frontend/</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cd</span> ..</span><br><span class="line">    print_message <span class="string">&quot;前端构建完成 ✓&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建Java后端</span></span><br><span class="line"><span class="function"><span class="title">build_backend</span></span>() &#123;</span><br><span class="line">    print_message <span class="string">&quot;开始构建Java后端...&quot;</span></span><br><span class="line">    <span class="built_in">cd</span> backend</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查Maven</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">command</span> -v mvn &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">        print_message <span class="string">&quot;使用Maven构建...&quot;</span></span><br><span class="line">        mvn clean package -DskipTests</span><br><span class="line">        <span class="built_in">mkdir</span> -p ../dist/backend</span><br><span class="line">        <span class="built_in">cp</span> target/*.jar ../dist/backend/</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        print_warning <span class="string">&quot;Maven未找到，跳过Java构建&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cd</span> ..</span><br><span class="line">    print_message <span class="string">&quot;Java后端构建完成 ✓&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建Python AI引擎</span></span><br><span class="line"><span class="function"><span class="title">build_ai_engine</span></span>() &#123;</span><br><span class="line">    print_message <span class="string">&quot;开始构建Python AI引擎...&quot;</span></span><br><span class="line">    <span class="built_in">cd</span> ai-engine</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建虚拟环境（如果不存在）</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -d <span class="string">&quot;venv&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        print_message <span class="string">&quot;创建Python虚拟环境...&quot;</span></span><br><span class="line">        python3 -m venv venv</span><br><span class="line">        <span class="built_in">source</span> venv/bin/activate</span><br><span class="line">        pip install --upgrade pip</span><br><span class="line">        pip install -r requirements.txt</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">source</span> venv/bin/activate</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 复制文件到dist</span></span><br><span class="line">    <span class="built_in">mkdir</span> -p ../dist/ai-engine</span><br><span class="line">    <span class="built_in">cp</span> -r . ../dist/ai-engine/</span><br><span class="line">    </span><br><span class="line">    deactivate</span><br><span class="line">    <span class="built_in">cd</span> ..</span><br><span class="line">    print_message <span class="string">&quot;Python AI引擎构建完成 ✓&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建C核心引擎</span></span><br><span class="line"><span class="function"><span class="title">build_c_engine</span></span>() &#123;</span><br><span class="line">    print_message <span class="string">&quot;开始构建C核心引擎...&quot;</span></span><br><span class="line">    <span class="built_in">cd</span> engine-core</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查Makefile是否存在</span></span><br><span class="line">    <span class="keyword">if</span> [ -f <span class="string">&quot;Makefile&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        make clean</span><br><span class="line">        make all</span><br><span class="line">        <span class="built_in">mkdir</span> -p ../dist/engine-core</span><br><span class="line">        <span class="built_in">cp</span> -r bin/* ../dist/engine-core/ 2&gt;/dev/null || <span class="literal">true</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        print_message <span class="string">&quot;创建并运行Makefile...&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 简单的Makefile内容</span></span><br><span class="line">        <span class="built_in">cat</span> &gt; Makefile &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">CC = gcc</span><br><span class="line">CFLAGS = -Wall -Wextra -O2 -I./include</span><br><span class="line">TARGET = kingdom_defense_engine</span><br><span class="line">SOURCES = src/main.c src/pathfinding/a_star.c src/physics/collision_detection.c</span><br><span class="line">OBJECTS = $(SOURCES:.c=.o)</span><br><span class="line"></span><br><span class="line">all: $(TARGET)</span><br><span class="line"></span><br><span class="line">$(TARGET): $(OBJECTS)</span><br><span class="line">	$(CC) $(CFLAGS) -o $(TARGET) $(OBJECTS) -lm</span><br><span class="line"></span><br><span class="line">%.o: %.c</span><br><span class="line">	$(CC) $(CFLAGS) -c $&lt; -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line">	<span class="built_in">rm</span> -f $(OBJECTS) $(TARGET)</span><br><span class="line"></span><br><span class="line"><span class="built_in">test</span>: all</span><br><span class="line">	./$(TARGET)</span><br><span class="line"></span><br><span class="line">.PHONY: all clean <span class="built_in">test</span></span><br><span class="line">EOF</span><br><span class="line">        </span><br><span class="line">        make all</span><br><span class="line">        <span class="built_in">mkdir</span> -p bin</span><br><span class="line">        <span class="built_in">mv</span> kingdom_defense_engine bin/</span><br><span class="line">        <span class="built_in">mkdir</span> -p ../dist/engine-core</span><br><span class="line">        <span class="built_in">cp</span> -r bin/* ../dist/engine-core/</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cd</span> ..</span><br><span class="line">    print_message <span class="string">&quot;C核心引擎构建完成 ✓&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建Docker配置</span></span><br><span class="line"><span class="function"><span class="title">create_docker_config</span></span>() &#123;</span><br><span class="line">    print_message <span class="string">&quot;创建Docker配置...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Docker Compose配置</span></span><br><span class="line">    <span class="built_in">cat</span> &gt; docker-compose.prod.yml &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">version: <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  frontend:</span><br><span class="line">    build:</span><br><span class="line">      context: ./frontend</span><br><span class="line">      dockerfile: Dockerfile</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;80:80&quot;</span></span><br><span class="line">    depends_on:</span><br><span class="line">      - backend</span><br><span class="line">      - ai-engine</span><br><span class="line">    networks:</span><br><span class="line">      - kingdom-network</span><br><span class="line"></span><br><span class="line">  backend:</span><br><span class="line">    build:</span><br><span class="line">      context: ./backend</span><br><span class="line">      dockerfile: Dockerfile</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    environment:</span><br><span class="line">      - SPRING_PROFILES_ACTIVE=prod</span><br><span class="line">      - DB_URL=jdbc:h2:file:/data/kingdom-defense-db</span><br><span class="line">    volumes:</span><br><span class="line">      - backend-data:/data</span><br><span class="line">    networks:</span><br><span class="line">      - kingdom-network</span><br><span class="line"></span><br><span class="line">  ai-engine:</span><br><span class="line">    build:</span><br><span class="line">      context: ./ai-engine</span><br><span class="line">      dockerfile: Dockerfile</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;5001:5001&quot;</span></span><br><span class="line">    networks:</span><br><span class="line">      - kingdom-network</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  kingdom-network:</span><br><span class="line">    driver: bridge</span><br><span class="line"></span><br><span class="line">volumes:</span><br><span class="line">  backend-data:</span><br><span class="line">EOF</span><br><span class="line">    </span><br><span class="line">    print_message <span class="string">&quot;Docker配置创建完成 ✓&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主构建流程</span></span><br><span class="line"><span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    print_message <span class="string">&quot;开始Kingdom Defense完整构建流程&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查依赖</span></span><br><span class="line">    check_dependencies</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建dist目录</span></span><br><span class="line">    <span class="built_in">mkdir</span> -p dist</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 构建各组件</span></span><br><span class="line">    build_frontend</span><br><span class="line">    build_backend</span><br><span class="line">    build_ai_engine</span><br><span class="line">    build_c_engine</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建Docker配置</span></span><br><span class="line">    create_docker_config</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    print_message <span class="string">&quot;=========================================&quot;</span></span><br><span class="line">    print_message <span class="string">&quot;      构建完成！&quot;</span></span><br><span class="line">    print_message <span class="string">&quot;=========================================&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    print_message <span class="string">&quot;构建输出位于: dist/&quot;</span></span><br><span class="line">    print_message <span class="string">&quot;&quot;</span></span><br><span class="line">    print_message <span class="string">&quot;可用组件:&quot;</span></span><br><span class="line">    print_message <span class="string">&quot;  - 前端: dist/frontend/&quot;</span></span><br><span class="line">    print_message <span class="string">&quot;  - 后端: dist/backend/&quot;</span></span><br><span class="line">    print_message <span class="string">&quot;  - AI引擎: dist/ai-engine/&quot;</span></span><br><span class="line">    print_message <span class="string">&quot;  - C核心: dist/engine-core/&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    print_message <span class="string">&quot;使用以下命令启动所有服务:&quot;</span></span><br><span class="line">    print_message <span class="string">&quot;  docker-compose -f docker-compose.prod.yml up -d&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行主函数</span></span><br><span class="line">main</span><br></pre></td></tr></table></figure>



<p>创建 <code>scripts/start_services.sh</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Kingdom Defense - 服务启动脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=========================================&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;    Kingdom Defense - 服务启动&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=========================================&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 颜色定义</span></span><br><span class="line">GREEN=<span class="string">&#x27;\033[0;32m&#x27;</span></span><br><span class="line">NC=<span class="string">&#x27;\033[0m&#x27;</span> <span class="comment"># No Color</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">print_message</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>[INFO]<span class="variable">$&#123;NC&#125;</span> <span class="variable">$1</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查Docker是否安装</span></span><br><span class="line"><span class="keyword">if</span> ! <span class="built_in">command</span> -v docker &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;错误: Docker未安装。请先安装Docker。&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查Docker Compose是否安装</span></span><br><span class="line"><span class="keyword">if</span> ! <span class="built_in">command</span> -v docker-compose &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;错误: Docker Compose未安装。请先安装Docker Compose。&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">print_message <span class="string">&quot;启动Kingdom Defense服务...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查是否在项目根目录</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">&quot;docker-compose.yml&quot;</span> ] &amp;&amp; [ ! -f <span class="string">&quot;docker-compose.prod.yml&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    print_message <span class="string">&quot;未找到Docker Compose配置，使用开发模式启动...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 启动前端开发服务器（在后台）</span></span><br><span class="line">    print_message <span class="string">&quot;启动前端开发服务器...&quot;</span></span><br><span class="line">    <span class="built_in">cd</span> frontend</span><br><span class="line">    python3 -m http.server 8000 &amp;</span><br><span class="line">    FRONTEND_PID=$!</span><br><span class="line">    <span class="built_in">cd</span> ..</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 启动Java后端</span></span><br><span class="line">    print_message <span class="string">&quot;启动Java后端...&quot;</span></span><br><span class="line">    <span class="built_in">cd</span> backend</span><br><span class="line">    <span class="keyword">if</span> [ -f <span class="string">&quot;target/*.jar&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        java -jar target/*.jar &amp;</span><br><span class="line">        BACKEND_PID=$!</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">cd</span> ..</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 启动Python AI引擎</span></span><br><span class="line">    print_message <span class="string">&quot;启动Python AI引擎...&quot;</span></span><br><span class="line">    <span class="built_in">cd</span> ai-engine</span><br><span class="line">    <span class="built_in">source</span> venv/bin/activate</span><br><span class="line">    python app.py &amp;</span><br><span class="line">    AI_PID=$!</span><br><span class="line">    deactivate</span><br><span class="line">    <span class="built_in">cd</span> ..</span><br><span class="line">    </span><br><span class="line">    print_message <span class="string">&quot;所有服务已启动！&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;访问以下地址：&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  前端: http://localhost:8000&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  后端: http://localhost:8080&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  AI引擎: http://localhost:5001&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;按Ctrl+C停止所有服务&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 等待Ctrl+C</span></span><br><span class="line">    <span class="built_in">trap</span> <span class="string">&quot;kill <span class="variable">$FRONTEND_PID</span> <span class="variable">$BACKEND_PID</span> <span class="variable">$AI_PID</span> 2&gt;/dev/null; exit&quot;</span> INT</span><br><span class="line">    <span class="built_in">wait</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment"># 使用Docker Compose启动</span></span><br><span class="line">    <span class="keyword">if</span> [ -f <span class="string">&quot;docker-compose.prod.yml&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        print_message <span class="string">&quot;使用生产Docker Compose配置启动...&quot;</span></span><br><span class="line">        docker-compose -f docker-compose.prod.yml up -d</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        print_message <span class="string">&quot;使用开发Docker Compose配置启动...&quot;</span></span><br><span class="line">        docker-compose up -d</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    print_message <span class="string">&quot;服务启动完成！&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    docker-compose ps</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    print_message <span class="string">&quot;使用以下命令查看日志：&quot;</span></span><br><span class="line">    print_message <span class="string">&quot;  docker-compose logs -f&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>



<h3 id="配置说明"><a href="#配置说明" class="headerlink" title="配置说明"></a>配置说明</h3><h4 id="1-环境要求"><a href="#1-环境要求" class="headerlink" title="1. 环境要求"></a>1. 环境要求</h4><ul>
<li><strong>Node.js</strong> v14+ (前端开发)</li>
<li><strong>Java</strong> 11+ (后端服务)</li>
<li><strong>Python</strong> 3.8+ (AI引擎)</li>
<li><strong>GCC</strong> 9.0+ (C核心引擎)</li>
<li><strong>Docker</strong> 20.0+ (容器化部署)</li>
</ul>
<h4 id="2-安装步骤"><a href="#2-安装步骤" class="headerlink" title="2. 安装步骤"></a>2. 安装步骤</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 克隆项目</span></span><br><span class="line">git <span class="built_in">clone</span> &lt;repository-url&gt;</span><br><span class="line"><span class="built_in">cd</span> kingdom-defense</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 授予脚本执行权限</span></span><br><span class="line"><span class="built_in">chmod</span> +x scripts/*.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 构建所有组件</span></span><br><span class="line">./scripts/build_all.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 启动服务</span></span><br><span class="line">./scripts/start_services.sh</span><br></pre></td></tr></table></figure>

<h4 id="3-开发模式启动"><a href="#3-开发模式启动" class="headerlink" title="3. 开发模式启动"></a>3. 开发模式启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分别启动各服务</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 前端开发服务器</span></span><br><span class="line"><span class="built_in">cd</span> frontend</span><br><span class="line">python3 -m http.server 8000</span><br><span class="line"></span><br><span class="line"><span class="comment"># Java后端（另一个终端）</span></span><br><span class="line"><span class="built_in">cd</span> backend</span><br><span class="line">mvn spring-boot:run</span><br><span class="line"></span><br><span class="line"><span class="comment"># Python AI引擎（另一个终端）</span></span><br><span class="line"><span class="built_in">cd</span> ai-engine</span><br><span class="line"><span class="built_in">source</span> venv/bin/activate</span><br><span class="line">python app.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译C核心</span></span><br><span class="line"><span class="built_in">cd</span> engine-core</span><br><span class="line">make all</span><br><span class="line">./bin/kingdom_defense_engine</span><br></pre></td></tr></table></figure>

<h3 id="扩展建议"><a href="#扩展建议" class="headerlink" title="扩展建议"></a>扩展建议</h3><h4 id="1-游戏功能扩展"><a href="#1-游戏功能扩展" class="headerlink" title="1. 游戏功能扩展"></a>1. 游戏功能扩展</h4><ul>
<li>添加更多塔类型（冰冻塔、毒塔、召唤塔等）</li>
<li>实现英雄系统</li>
<li>添加天气系统影响游戏</li>
<li>实现多人在线合作模式</li>
<li>添加成就系统</li>
</ul>
<h4 id="2-技术优化"><a href="#2-技术优化" class="headerlink" title="2. 技术优化"></a>2. 技术优化</h4><ul>
<li>使用WebGL替代Canvas 2D提升性能</li>
<li>实现WebSocket实时多人对战</li>
<li>添加Service Worker实现离线游戏</li>
<li>使用WebAssembly优化计算密集型任务</li>
<li>实现A&#x2F;B测试和数据分析系统</li>
</ul>
<h4 id="3-部署优化"><a href="#3-部署优化" class="headerlink" title="3. 部署优化"></a>3. 部署优化</h4><ul>
<li>配置CI&#x2F;CD流水线</li>
<li>添加监控和日志系统</li>
<li>实现自动扩缩容</li>
<li>配置CDN加速资源加载</li>
<li>实现蓝绿部署</li>
</ul>
<p>这个项目展示了如何使用不同编程语言构建一个完整的游戏系统，每种语言都发挥了其优势：JavaScript用于交互式前端，Java用于稳定的后端服务，Python用于AI和数据分析，C用于高性能计算，Shell用于自动化。您可以根据需要选择实现全部或部分模块。</p>
<h2 id="扩展实现"><a href="#扩展实现" class="headerlink" title="扩展实现"></a>扩展实现</h2><h3 id="第七阶段：扩展前端功能（第8周）"><a href="#第七阶段：扩展前端功能（第8周）" class="headerlink" title="第七阶段：扩展前端功能（第8周）"></a>第七阶段：扩展前端功能（第8周）</h3><h4 id="步骤10：完善游戏功能"><a href="#步骤10：完善游戏功能" class="headerlink" title="步骤10：完善游戏功能"></a>步骤10：完善游戏功能</h4><h5 id="10-1-添加更多塔类型"><a href="#10-1-添加更多塔类型" class="headerlink" title="10.1 添加更多塔类型"></a>10.1 添加更多塔类型</h5><p>在<code>frontend/js/entities/tower.js</code>中，我们扩展塔的类型和功能：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Tower</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">x, y, type</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">x</span> = x;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">y</span> = y;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">type</span> = type;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">level</span> = <span class="number">1</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">upgradeCost</span> = <span class="number">100</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">sellValue</span> = <span class="number">50</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">experience</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">maxExperience</span> = <span class="number">100</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 根据类型初始化属性</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">initTowerStats</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">initTowerStats</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span>(<span class="variable language_">this</span>.<span class="property">type</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;arrow&#x27;</span>:</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">range</span> = <span class="number">200</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">damage</span> = <span class="number">10</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">attackSpeed</span> = <span class="number">1.5</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">projectileSpeed</span> = <span class="number">400</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">color</span> = <span class="string">&#x27;#4CAF50&#x27;</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">cost</span> = <span class="number">50</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;cannon&#x27;</span>:</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">range</span> = <span class="number">180</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">damage</span> = <span class="number">30</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">attackSpeed</span> = <span class="number">0.8</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">projectileSpeed</span> = <span class="number">300</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">splashRadius</span> = <span class="number">40</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">color</span> = <span class="string">&#x27;#FF5722&#x27;</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">cost</span> = <span class="number">100</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;magic&#x27;</span>:</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">range</span> = <span class="number">220</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">damage</span> = <span class="number">15</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">attackSpeed</span> = <span class="number">1.2</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">projectileSpeed</span> = <span class="number">350</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">slowEffect</span> = <span class="number">0.5</span>; <span class="comment">// 减速效果</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">color</span> = <span class="string">&#x27;#9C27B0&#x27;</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">cost</span> = <span class="number">80</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;barracks&#x27;</span>:</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">range</span> = <span class="number">0</span>; <span class="comment">// 兵营不攻击</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">spawnRate</span> = <span class="number">3</span>; <span class="comment">// 每3秒生成一个士兵</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">maxSoldiers</span> = <span class="number">3</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">soldiers</span> = [];</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">color</span> = <span class="string">&#x27;#795548&#x27;</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">cost</span> = <span class="number">120</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cooldown</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">target</span> = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">update</span>(<span class="params">deltaTime, enemies, bullets, gameManager</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cooldown</span> -= deltaTime;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">type</span> === <span class="string">&#x27;barracks&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">updateBarracks</span>(deltaTime, enemies, gameManager);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">cooldown</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">target</span> = <span class="variable language_">this</span>.<span class="title function_">findTarget</span>(enemies);</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">target</span>) &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">attack</span>(<span class="variable language_">this</span>.<span class="property">target</span>, bullets);</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">cooldown</span> = <span class="number">1</span> / <span class="variable language_">this</span>.<span class="property">attackSpeed</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新经验</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">experience</span> &gt;= <span class="variable language_">this</span>.<span class="property">maxExperience</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">level</span> &lt; <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">levelUp</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">updateBarracks</span>(<span class="params">deltaTime, enemies, gameManager</span>) &#123;</span><br><span class="line">        <span class="comment">// 生成士兵</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cooldown</span> -= deltaTime;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">cooldown</span> &lt;= <span class="number">0</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">soldiers</span>.<span class="property">length</span> &lt; <span class="variable language_">this</span>.<span class="property">maxSoldiers</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">spawnSoldier</span>(gameManager);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">cooldown</span> = <span class="variable language_">this</span>.<span class="property">spawnRate</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新士兵</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="variable language_">this</span>.<span class="property">soldiers</span>.<span class="property">length</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">soldiers</span>[i].<span class="title function_">update</span>(deltaTime, enemies);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果士兵死亡，移除</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">soldiers</span>[i].<span class="property">health</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">soldiers</span>.<span class="title function_">splice</span>(i, <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">spawnSoldier</span>(<span class="params">gameManager</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> soldier = <span class="keyword">new</span> <span class="title class_">Soldier</span>(<span class="variable language_">this</span>.<span class="property">x</span>, <span class="variable language_">this</span>.<span class="property">y</span>, <span class="variable language_">this</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">soldiers</span>.<span class="title function_">push</span>(soldier);</span><br><span class="line">        gameManager.<span class="property">entities</span>.<span class="title function_">push</span>(soldier); <span class="comment">// 假设gameManager有一个entities数组</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">findTarget</span>(<span class="params">enemies</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> closest = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">let</span> closestDistance = <span class="variable language_">this</span>.<span class="property">range</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> enemy <span class="keyword">of</span> enemies) &#123;</span><br><span class="line">            <span class="comment">// 对于魔法塔，优先攻击魔法抗性低的敌人</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">type</span> === <span class="string">&#x27;magic&#x27;</span> &amp;&amp; enemy.<span class="property">magicResist</span> &gt; <span class="number">0.8</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">const</span> dx = enemy.<span class="property">x</span> - <span class="variable language_">this</span>.<span class="property">x</span>;</span><br><span class="line">            <span class="keyword">const</span> dy = enemy.<span class="property">y</span> - <span class="variable language_">this</span>.<span class="property">y</span>;</span><br><span class="line">            <span class="keyword">const</span> distance = <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(dx * dx + dy * dy);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (distance &lt; closestDistance) &#123;</span><br><span class="line">                closest = enemy;</span><br><span class="line">                closestDistance = distance;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> closest;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">attack</span>(<span class="params">target, bullets</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> bullet = <span class="keyword">new</span> <span class="title class_">Bullet</span>(</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">x</span>,</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">y</span>,</span><br><span class="line">            target,</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">damage</span>,</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">type</span>,</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">projectileSpeed</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 添加特殊效果</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">type</span> === <span class="string">&#x27;cannon&#x27;</span>) &#123;</span><br><span class="line">            bullet.<span class="property">splashRadius</span> = <span class="variable language_">this</span>.<span class="property">splashRadius</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">type</span> === <span class="string">&#x27;magic&#x27;</span>) &#123;</span><br><span class="line">            bullet.<span class="property">slowEffect</span> = <span class="variable language_">this</span>.<span class="property">slowEffect</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        bullets.<span class="title function_">push</span>(bullet);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 增加经验</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">gainExperience</span>(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">gainExperience</span>(<span class="params">amount</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">experience</span> += amount;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">levelUp</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">level</span>++;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">experience</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">maxExperience</span> = <span class="variable language_">this</span>.<span class="property">level</span> * <span class="number">100</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 提升属性</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">damage</span> *= <span class="number">1.5</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">range</span> *= <span class="number">1.1</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">attackSpeed</span> *= <span class="number">1.2</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">type</span> === <span class="string">&#x27;cannon&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">splashRadius</span> *= <span class="number">1.2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">upgradeCost</span> = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="variable language_">this</span>.<span class="property">upgradeCost</span> * <span class="number">1.5</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">sellValue</span> = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="variable language_">this</span>.<span class="property">sellValue</span> * <span class="number">1.3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">sell</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">sellValue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">getUpgradeInfo</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">level</span>: <span class="variable language_">this</span>.<span class="property">level</span>,</span><br><span class="line">            <span class="attr">damage</span>: <span class="variable language_">this</span>.<span class="property">damage</span>,</span><br><span class="line">            <span class="attr">range</span>: <span class="variable language_">this</span>.<span class="property">range</span>,</span><br><span class="line">            <span class="attr">attackSpeed</span>: <span class="variable language_">this</span>.<span class="property">attackSpeed</span>,</span><br><span class="line">            <span class="attr">upgradeCost</span>: <span class="variable language_">this</span>.<span class="property">upgradeCost</span>,</span><br><span class="line">            <span class="attr">sellValue</span>: <span class="variable language_">this</span>.<span class="property">sellValue</span>,</span><br><span class="line">            <span class="attr">experience</span>: <span class="variable language_">this</span>.<span class="property">experience</span>,</span><br><span class="line">            <span class="attr">maxExperience</span>: <span class="variable language_">this</span>.<span class="property">maxExperience</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">draw</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">        <span class="comment">// 绘制塔底座</span></span><br><span class="line">        ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;#37474F&#x27;</span>;</span><br><span class="line">        ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">        ctx.<span class="title function_">arc</span>(<span class="variable language_">this</span>.<span class="property">x</span>, <span class="variable language_">this</span>.<span class="property">y</span>, <span class="number">30</span>, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>);</span><br><span class="line">        ctx.<span class="title function_">fill</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 绘制塔身</span></span><br><span class="line">        ctx.<span class="property">fillStyle</span> = <span class="variable language_">this</span>.<span class="property">color</span>;</span><br><span class="line">        ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">        ctx.<span class="title function_">arc</span>(<span class="variable language_">this</span>.<span class="property">x</span>, <span class="variable language_">this</span>.<span class="property">y</span>, <span class="number">20</span>, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>);</span><br><span class="line">        ctx.<span class="title function_">fill</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 绘制等级标志</span></span><br><span class="line">        ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;#FFD700&#x27;</span>;</span><br><span class="line">        ctx.<span class="property">font</span> = <span class="string">&#x27;14px Arial&#x27;</span>;</span><br><span class="line">        ctx.<span class="property">textAlign</span> = <span class="string">&#x27;center&#x27;</span>;</span><br><span class="line">        ctx.<span class="property">textBaseline</span> = <span class="string">&#x27;middle&#x27;</span>;</span><br><span class="line">        ctx.<span class="title function_">fillText</span>(<span class="variable language_">this</span>.<span class="property">level</span>.<span class="title function_">toString</span>(), <span class="variable language_">this</span>.<span class="property">x</span>, <span class="variable language_">this</span>.<span class="property">y</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 绘制经验条</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">level</span> &lt; <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> expPercent = <span class="variable language_">this</span>.<span class="property">experience</span> / <span class="variable language_">this</span>.<span class="property">maxExperience</span>;</span><br><span class="line">            <span class="keyword">const</span> barWidth = <span class="number">40</span>;</span><br><span class="line">            <span class="keyword">const</span> barHeight = <span class="number">5</span>;</span><br><span class="line">            </span><br><span class="line">            ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;#555&#x27;</span>;</span><br><span class="line">            ctx.<span class="title function_">fillRect</span>(</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">x</span> - barWidth / <span class="number">2</span>,</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">y</span> + <span class="number">30</span>,</span><br><span class="line">                barWidth,</span><br><span class="line">                barHeight</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;#4CAF50&#x27;</span>;</span><br><span class="line">            ctx.<span class="title function_">fillRect</span>(</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">x</span> - barWidth / <span class="number">2</span>,</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">y</span> + <span class="number">30</span>,</span><br><span class="line">                barWidth * expPercent,</span><br><span class="line">                barHeight</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果鼠标悬停，显示范围</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">isMouseOver</span>()) &#123;</span><br><span class="line">            ctx.<span class="property">strokeStyle</span> = <span class="string">&#x27;rgba(255, 255, 255, 0.3)&#x27;</span>;</span><br><span class="line">            ctx.<span class="property">lineWidth</span> = <span class="number">2</span>;</span><br><span class="line">            ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">            ctx.<span class="title function_">arc</span>(<span class="variable language_">this</span>.<span class="property">x</span>, <span class="variable language_">this</span>.<span class="property">y</span>, <span class="variable language_">this</span>.<span class="property">range</span>, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>);</span><br><span class="line">            ctx.<span class="title function_">stroke</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 绘制士兵（如果是兵营）</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">type</span> === <span class="string">&#x27;barracks&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">soldiers</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">soldier</span> =&gt;</span> soldier.<span class="title function_">draw</span>(ctx));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">isMouseOver</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> gameManager = <span class="variable language_">window</span>.<span class="property">gameManager</span>;</span><br><span class="line">        <span class="keyword">if</span> (!gameManager) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> dx = gameManager.<span class="property">mouse</span>.<span class="property">x</span> - <span class="variable language_">this</span>.<span class="property">x</span>;</span><br><span class="line">        <span class="keyword">const</span> dy = gameManager.<span class="property">mouse</span>.<span class="property">y</span> - <span class="variable language_">this</span>.<span class="property">y</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(dx * dx + dy * dy) &lt; <span class="number">30</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="10-2-添加士兵类（用于兵营）"><a href="#10-2-添加士兵类（用于兵营）" class="headerlink" title="10.2 添加士兵类（用于兵营）"></a>10.2 添加士兵类（用于兵营）</h5><p>创建 <code>frontend/js/entities/soldier.js</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Soldier</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">x, y, barracks</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">x</span> = x;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">y</span> = y;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">barracks</span> = barracks;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">health</span> = <span class="number">100</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">maxHealth</span> = <span class="number">100</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">damage</span> = <span class="number">5</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">attackRange</span> = <span class="number">30</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">attackSpeed</span> = <span class="number">1</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cooldown</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">speed</span> = <span class="number">50</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">target</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">color</span> = <span class="string">&#x27;#8B4513&#x27;</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">size</span> = <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">update</span>(<span class="params">deltaTime, enemies</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cooldown</span> -= deltaTime;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 寻找目标</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">target</span> || <span class="variable language_">this</span>.<span class="property">target</span>.<span class="property">health</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">target</span> = <span class="variable language_">this</span>.<span class="title function_">findTarget</span>(enemies);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">target</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> dx = <span class="variable language_">this</span>.<span class="property">target</span>.<span class="property">x</span> - <span class="variable language_">this</span>.<span class="property">x</span>;</span><br><span class="line">            <span class="keyword">const</span> dy = <span class="variable language_">this</span>.<span class="property">target</span>.<span class="property">y</span> - <span class="variable language_">this</span>.<span class="property">y</span>;</span><br><span class="line">            <span class="keyword">const</span> distance = <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(dx * dx + dy * dy);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (distance &lt;= <span class="variable language_">this</span>.<span class="property">attackRange</span>) &#123;</span><br><span class="line">                <span class="comment">// 攻击目标</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">cooldown</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">target</span>.<span class="title function_">takeDamage</span>(<span class="variable language_">this</span>.<span class="property">damage</span>);</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">cooldown</span> = <span class="number">1</span> / <span class="variable language_">this</span>.<span class="property">attackSpeed</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 向目标移动</span></span><br><span class="line">                <span class="keyword">const</span> moveX = (dx / distance) * <span class="variable language_">this</span>.<span class="property">speed</span> * deltaTime;</span><br><span class="line">                <span class="keyword">const</span> moveY = (dy / distance) * <span class="variable language_">this</span>.<span class="property">speed</span> * deltaTime;</span><br><span class="line">                </span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">x</span> += moveX;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">y</span> += moveY;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果离兵营太远，返回</span></span><br><span class="line">        <span class="keyword">const</span> dx = <span class="variable language_">this</span>.<span class="property">barracks</span>.<span class="property">x</span> - <span class="variable language_">this</span>.<span class="property">x</span>;</span><br><span class="line">        <span class="keyword">const</span> dy = <span class="variable language_">this</span>.<span class="property">barracks</span>.<span class="property">y</span> - <span class="variable language_">this</span>.<span class="property">y</span>;</span><br><span class="line">        <span class="keyword">const</span> distanceToBarracks = <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(dx * dx + dy * dy);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (distanceToBarracks &gt; <span class="variable language_">this</span>.<span class="property">barracks</span>.<span class="property">range</span>) &#123;</span><br><span class="line">            <span class="comment">// 返回兵营</span></span><br><span class="line">            <span class="keyword">const</span> moveX = (dx / distanceToBarracks) * <span class="variable language_">this</span>.<span class="property">speed</span> * deltaTime;</span><br><span class="line">            <span class="keyword">const</span> moveY = (dy / distanceToBarracks) * <span class="variable language_">this</span>.<span class="property">speed</span> * deltaTime;</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">x</span> += moveX;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">y</span> += moveY;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">findTarget</span>(<span class="params">enemies</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> closest = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">let</span> closestDistance = <span class="number">150</span>; <span class="comment">// 士兵的视野范围</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> enemy <span class="keyword">of</span> enemies) &#123;</span><br><span class="line">            <span class="keyword">const</span> dx = enemy.<span class="property">x</span> - <span class="variable language_">this</span>.<span class="property">x</span>;</span><br><span class="line">            <span class="keyword">const</span> dy = enemy.<span class="property">y</span> - <span class="variable language_">this</span>.<span class="property">y</span>;</span><br><span class="line">            <span class="keyword">const</span> distance = <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(dx * dx + dy * dy);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (distance &lt; closestDistance) &#123;</span><br><span class="line">                closest = enemy;</span><br><span class="line">                closestDistance = distance;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> closest;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">takeDamage</span>(<span class="params">amount</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">health</span> -= amount;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">health</span> &lt;= <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">draw</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">        <span class="comment">// 绘制士兵身体</span></span><br><span class="line">        ctx.<span class="property">fillStyle</span> = <span class="variable language_">this</span>.<span class="property">color</span>;</span><br><span class="line">        ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">        ctx.<span class="title function_">arc</span>(<span class="variable language_">this</span>.<span class="property">x</span>, <span class="variable language_">this</span>.<span class="property">y</span>, <span class="variable language_">this</span>.<span class="property">size</span>, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>);</span><br><span class="line">        ctx.<span class="title function_">fill</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 绘制士兵盾牌</span></span><br><span class="line">        ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;#696969&#x27;</span>;</span><br><span class="line">        ctx.<span class="title function_">fillRect</span>(<span class="variable language_">this</span>.<span class="property">x</span> - <span class="number">12</span>, <span class="variable language_">this</span>.<span class="property">y</span> - <span class="number">5</span>, <span class="number">8</span>, <span class="number">10</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 绘制生命条</span></span><br><span class="line">        <span class="keyword">const</span> healthPercent = <span class="variable language_">this</span>.<span class="property">health</span> / <span class="variable language_">this</span>.<span class="property">maxHealth</span>;</span><br><span class="line">        <span class="keyword">const</span> barWidth = <span class="number">20</span>;</span><br><span class="line">        <span class="keyword">const</span> barHeight = <span class="number">3</span>;</span><br><span class="line">        </span><br><span class="line">        ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;#F44336&#x27;</span>;</span><br><span class="line">        ctx.<span class="title function_">fillRect</span>(</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">x</span> - barWidth / <span class="number">2</span>,</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">y</span> - <span class="variable language_">this</span>.<span class="property">size</span> - <span class="number">10</span>,</span><br><span class="line">            barWidth,</span><br><span class="line">            barHeight</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;#4CAF50&#x27;</span>;</span><br><span class="line">        ctx.<span class="title function_">fillRect</span>(</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">x</span> - barWidth / <span class="number">2</span>,</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">y</span> - <span class="variable language_">this</span>.<span class="property">size</span> - <span class="number">10</span>,</span><br><span class="line">            barWidth * healthPercent,</span><br><span class="line">            barHeight</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="10-3-扩展敌人类型"><a href="#10-3-扩展敌人类型" class="headerlink" title="10.3 扩展敌人类型"></a>10.3 扩展敌人类型</h5><p>在<code>frontend/js/entities/enemy.js</code>中，我们添加更多敌人类型和属性：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Enemy</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">x, y, type</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">x</span> = x;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">y</span> = y;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">type</span> = type;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 初始化敌人属性</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">initEnemyStats</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">path</span> = [];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentPathIndex</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">reachedEnd</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">slowEffects</span> = []; <span class="comment">// 存储减速效果</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">dotEffects</span> = []; <span class="comment">// 存储持续伤害效果</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">initEnemyStats</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span>(<span class="variable language_">this</span>.<span class="property">type</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;infantry&#x27;</span>:</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">health</span> = <span class="number">50</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">maxHealth</span> = <span class="number">50</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">speed</span> = <span class="number">100</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">reward</span> = <span class="number">10</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">armor</span> = <span class="number">0.1</span>; <span class="comment">// 减少10%物理伤害</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">magicResist</span> = <span class="number">0.2</span>; <span class="comment">// 减少20%魔法伤害</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">color</span> = <span class="string">&#x27;#2196F3&#x27;</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">size</span> = <span class="number">15</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;cavalry&#x27;</span>:</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">health</span> = <span class="number">75</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">maxHealth</span> = <span class="number">75</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">speed</span> = <span class="number">150</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">reward</span> = <span class="number">15</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">armor</span> = <span class="number">0.2</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">magicResist</span> = <span class="number">0.1</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">color</span> = <span class="string">&#x27;#4CAF50&#x27;</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">size</span> = <span class="number">18</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;armored&#x27;</span>:</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">health</span> = <span class="number">150</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">maxHealth</span> = <span class="number">150</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">speed</span> = <span class="number">60</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">reward</span> = <span class="number">25</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">armor</span> = <span class="number">0.5</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">magicResist</span> = <span class="number">0.3</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">color</span> = <span class="string">&#x27;#FF9800&#x27;</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">size</span> = <span class="number">20</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;flying&#x27;</span>:</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">health</span> = <span class="number">40</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">maxHealth</span> = <span class="number">40</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">speed</span> = <span class="number">120</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">reward</span> = <span class="number">20</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">armor</span> = <span class="number">0</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">magicResist</span> = <span class="number">0.5</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">color</span> = <span class="string">&#x27;#9C27B0&#x27;</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">size</span> = <span class="number">12</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">isFlying</span> = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;boss&#x27;</span>:</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">health</span> = <span class="number">500</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">maxHealth</span> = <span class="number">500</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">speed</span> = <span class="number">40</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">reward</span> = <span class="number">100</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">armor</span> = <span class="number">0.7</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">magicResist</span> = <span class="number">0.6</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">color</span> = <span class="string">&#x27;#F44336&#x27;</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">size</span> = <span class="number">30</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">update</span>(<span class="params">deltaTime</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">reachedEnd</span>) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新状态效果</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">updateEffects</span>(deltaTime);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 计算实际速度（考虑减速效果）</span></span><br><span class="line">        <span class="keyword">let</span> actualSpeed = <span class="variable language_">this</span>.<span class="property">speed</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> effect <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">slowEffects</span>) &#123;</span><br><span class="line">            actualSpeed *= (<span class="number">1</span> - effect.<span class="property">amount</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        actualSpeed = <span class="title class_">Math</span>.<span class="title function_">max</span>(actualSpeed, <span class="variable language_">this</span>.<span class="property">speed</span> * <span class="number">0.1</span>); <span class="comment">// 最低速度为10%</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 沿路径移动</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">path</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> target = <span class="variable language_">this</span>.<span class="property">path</span>[<span class="variable language_">this</span>.<span class="property">currentPathIndex</span>];</span><br><span class="line">            <span class="keyword">const</span> dx = target.<span class="property">x</span> - <span class="variable language_">this</span>.<span class="property">x</span>;</span><br><span class="line">            <span class="keyword">const</span> dy = target.<span class="property">y</span> - <span class="variable language_">this</span>.<span class="property">y</span>;</span><br><span class="line">            <span class="keyword">const</span> distance = <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(dx * dx + dy * dy);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (distance &lt; <span class="number">5</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">currentPathIndex</span>++;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">currentPathIndex</span> &gt;= <span class="variable language_">this</span>.<span class="property">path</span>.<span class="property">length</span>) &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">reachedEnd</span> = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> moveDistance = actualSpeed * deltaTime;</span><br><span class="line">                <span class="keyword">const</span> moveX = (dx / distance) * moveDistance;</span><br><span class="line">                <span class="keyword">const</span> moveY = (dy / distance) * moveDistance;</span><br><span class="line">                </span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">x</span> += moveX;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">y</span> += moveY;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">updateEffects</span>(<span class="params">deltaTime</span>) &#123;</span><br><span class="line">        <span class="comment">// 更新减速效果</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="variable language_">this</span>.<span class="property">slowEffects</span>.<span class="property">length</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">slowEffects</span>[i].<span class="property">duration</span> -= deltaTime;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">slowEffects</span>[i].<span class="property">duration</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">slowEffects</span>.<span class="title function_">splice</span>(i, <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新持续伤害效果</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="variable language_">this</span>.<span class="property">dotEffects</span>.<span class="property">length</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">dotEffects</span>[i].<span class="property">timer</span> -= deltaTime;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">dotEffects</span>[i].<span class="property">timer</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">takeDamage</span>(<span class="variable language_">this</span>.<span class="property">dotEffects</span>[i].<span class="property">damage</span>, <span class="variable language_">this</span>.<span class="property">dotEffects</span>[i].<span class="property">type</span>);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">dotEffects</span>[i].<span class="property">duration</span> -= <span class="number">1</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">dotEffects</span>[i].<span class="property">timer</span> = <span class="variable language_">this</span>.<span class="property">dotEffects</span>[i].<span class="property">interval</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">dotEffects</span>[i].<span class="property">duration</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">dotEffects</span>.<span class="title function_">splice</span>(i, <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">takeDamage</span>(<span class="params">damage, damageType = <span class="string">&#x27;physical&#x27;</span></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> actualDamage = damage;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 根据伤害类型应用抗性</span></span><br><span class="line">        <span class="keyword">if</span> (damageType === <span class="string">&#x27;physical&#x27;</span>) &#123;</span><br><span class="line">            actualDamage *= (<span class="number">1</span> - <span class="variable language_">this</span>.<span class="property">armor</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (damageType === <span class="string">&#x27;magic&#x27;</span>) &#123;</span><br><span class="line">            actualDamage *= (<span class="number">1</span> - <span class="variable language_">this</span>.<span class="property">magicResist</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">health</span> -= actualDamage;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 返回是否死亡</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">health</span> &lt;= <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">addSlowEffect</span>(<span class="params">amount, duration</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">slowEffects</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">            <span class="attr">amount</span>: amount,</span><br><span class="line">            <span class="attr">duration</span>: duration</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">addDotEffect</span>(<span class="params">damage, interval, duration, type = <span class="string">&#x27;physical&#x27;</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">dotEffects</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">            <span class="attr">damage</span>: damage,</span><br><span class="line">            <span class="attr">interval</span>: interval,</span><br><span class="line">            <span class="attr">duration</span>: duration,</span><br><span class="line">            <span class="attr">timer</span>: interval,</span><br><span class="line">            <span class="attr">type</span>: type</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">draw</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">        <span class="comment">// 绘制敌人身体</span></span><br><span class="line">        ctx.<span class="property">fillStyle</span> = <span class="variable language_">this</span>.<span class="property">color</span>;</span><br><span class="line">        ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">        ctx.<span class="title function_">arc</span>(<span class="variable language_">this</span>.<span class="property">x</span>, <span class="variable language_">this</span>.<span class="property">y</span>, <span class="variable language_">this</span>.<span class="property">size</span>, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>);</span><br><span class="line">        ctx.<span class="title function_">fill</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 绘制敌人边框</span></span><br><span class="line">        ctx.<span class="property">strokeStyle</span> = <span class="string">&#x27;#000&#x27;</span>;</span><br><span class="line">        ctx.<span class="property">lineWidth</span> = <span class="number">2</span>;</span><br><span class="line">        ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">        ctx.<span class="title function_">arc</span>(<span class="variable language_">this</span>.<span class="property">x</span>, <span class="variable language_">this</span>.<span class="property">y</span>, <span class="variable language_">this</span>.<span class="property">size</span>, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>);</span><br><span class="line">        ctx.<span class="title function_">stroke</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 绘制生命条</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">drawHealthBar</span>(ctx);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 绘制状态效果图标</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">drawStatusEffects</span>(ctx);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果是飞行单位，绘制翅膀</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">type</span> === <span class="string">&#x27;flying&#x27;</span>) &#123;</span><br><span class="line">            ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;#E1BEE7&#x27;</span>;</span><br><span class="line">            ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">            ctx.<span class="title function_">ellipse</span>(<span class="variable language_">this</span>.<span class="property">x</span> - <span class="number">15</span>, <span class="variable language_">this</span>.<span class="property">y</span>, <span class="number">10</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>);</span><br><span class="line">            ctx.<span class="title function_">ellipse</span>(<span class="variable language_">this</span>.<span class="property">x</span> + <span class="number">15</span>, <span class="variable language_">this</span>.<span class="property">y</span>, <span class="number">10</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>);</span><br><span class="line">            ctx.<span class="title function_">fill</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果是BOSS，绘制特殊标志</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">type</span> === <span class="string">&#x27;boss&#x27;</span>) &#123;</span><br><span class="line">            ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;#FFD700&#x27;</span>;</span><br><span class="line">            ctx.<span class="property">font</span> = <span class="string">&#x27;bold 16px Arial&#x27;</span>;</span><br><span class="line">            ctx.<span class="property">textAlign</span> = <span class="string">&#x27;center&#x27;</span>;</span><br><span class="line">            ctx.<span class="property">textBaseline</span> = <span class="string">&#x27;middle&#x27;</span>;</span><br><span class="line">            ctx.<span class="title function_">fillText</span>(<span class="string">&#x27;BOSS&#x27;</span>, <span class="variable language_">this</span>.<span class="property">x</span>, <span class="variable language_">this</span>.<span class="property">y</span> - <span class="variable language_">this</span>.<span class="property">size</span> - <span class="number">20</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">drawHealthBar</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> healthPercent = <span class="variable language_">this</span>.<span class="property">health</span> / <span class="variable language_">this</span>.<span class="property">maxHealth</span>;</span><br><span class="line">        <span class="keyword">const</span> barWidth = <span class="variable language_">this</span>.<span class="property">size</span> * <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">const</span> barHeight = <span class="number">5</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 背景</span></span><br><span class="line">        ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;#F44336&#x27;</span>;</span><br><span class="line">        ctx.<span class="title function_">fillRect</span>(</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">x</span> - barWidth / <span class="number">2</span>,</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">y</span> - <span class="variable language_">this</span>.<span class="property">size</span> - <span class="number">15</span>,</span><br><span class="line">            barWidth,</span><br><span class="line">            barHeight</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 当前生命值</span></span><br><span class="line">        ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;#4CAF50&#x27;</span>;</span><br><span class="line">        ctx.<span class="title function_">fillRect</span>(</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">x</span> - barWidth / <span class="number">2</span>,</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">y</span> - <span class="variable language_">this</span>.<span class="property">size</span> - <span class="number">15</span>,</span><br><span class="line">            barWidth * healthPercent,</span><br><span class="line">            barHeight</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 边框</span></span><br><span class="line">        ctx.<span class="property">strokeStyle</span> = <span class="string">&#x27;#000&#x27;</span>;</span><br><span class="line">        ctx.<span class="property">lineWidth</span> = <span class="number">1</span>;</span><br><span class="line">        ctx.<span class="title function_">strokeRect</span>(</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">x</span> - barWidth / <span class="number">2</span>,</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">y</span> - <span class="variable language_">this</span>.<span class="property">size</span> - <span class="number">15</span>,</span><br><span class="line">            barWidth,</span><br><span class="line">            barHeight</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 显示生命值数字（仅对BOSS）</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">type</span> === <span class="string">&#x27;boss&#x27;</span>) &#123;</span><br><span class="line">            ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;#FFF&#x27;</span>;</span><br><span class="line">            ctx.<span class="property">font</span> = <span class="string">&#x27;10px Arial&#x27;</span>;</span><br><span class="line">            ctx.<span class="property">textAlign</span> = <span class="string">&#x27;center&#x27;</span>;</span><br><span class="line">            ctx.<span class="title function_">fillText</span>(</span><br><span class="line">                <span class="string">`<span class="subst">$&#123;<span class="built_in">Math</span>.ceil(<span class="variable language_">this</span>.health)&#125;</span>/<span class="subst">$&#123;<span class="variable language_">this</span>.maxHealth&#125;</span>`</span>,</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">x</span>,</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">y</span> - <span class="variable language_">this</span>.<span class="property">size</span> - <span class="number">13</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">drawStatusEffects</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> iconSize = <span class="number">12</span>;</span><br><span class="line">        <span class="keyword">let</span> iconX = <span class="variable language_">this</span>.<span class="property">x</span> - iconSize * <span class="number">1.5</span>;</span><br><span class="line">        <span class="keyword">const</span> iconY = <span class="variable language_">this</span>.<span class="property">y</span> + <span class="variable language_">this</span>.<span class="property">size</span> + <span class="number">10</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 绘制减速图标</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">slowEffects</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;#2196F3&#x27;</span>;</span><br><span class="line">            ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">            ctx.<span class="title function_">arc</span>(iconX, iconY, iconSize / <span class="number">2</span>, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>);</span><br><span class="line">            ctx.<span class="title function_">fill</span>();</span><br><span class="line">            </span><br><span class="line">            ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;#FFF&#x27;</span>;</span><br><span class="line">            ctx.<span class="property">font</span> = <span class="string">&#x27;10px Arial&#x27;</span>;</span><br><span class="line">            ctx.<span class="property">textAlign</span> = <span class="string">&#x27;center&#x27;</span>;</span><br><span class="line">            ctx.<span class="property">textBaseline</span> = <span class="string">&#x27;middle&#x27;</span>;</span><br><span class="line">            ctx.<span class="title function_">fillText</span>(<span class="string">&#x27;S&#x27;</span>, iconX, iconY);</span><br><span class="line">            </span><br><span class="line">            iconX += iconSize * <span class="number">1.5</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 绘制持续伤害图标</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">dotEffects</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;#F44336&#x27;</span>;</span><br><span class="line">            ctx.<span class="title function_">beginPath</span>();</span><br><span class="line">            ctx.<span class="title function_">arc</span>(iconX, iconY, iconSize / <span class="number">2</span>, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>);</span><br><span class="line">            ctx.<span class="title function_">fill</span>();</span><br><span class="line">            </span><br><span class="line">            ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;#FFF&#x27;</span>;</span><br><span class="line">            ctx.<span class="property">font</span> = <span class="string">&#x27;10px Arial&#x27;</span>;</span><br><span class="line">            ctx.<span class="property">textAlign</span> = <span class="string">&#x27;center&#x27;</span>;</span><br><span class="line">            ctx.<span class="property">textBaseline</span> = <span class="string">&#x27;middle&#x27;</span>;</span><br><span class="line">            ctx.<span class="title function_">fillText</span>(<span class="string">&#x27;D&#x27;</span>, iconX, iconY);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="第八阶段：完善Java后端（第9周）"><a href="#第八阶段：完善Java后端（第9周）" class="headerlink" title="第八阶段：完善Java后端（第9周）"></a>第八阶段：完善Java后端（第9周）</h3><h4 id="步骤11：扩展后端功能"><a href="#步骤11：扩展后端功能" class="headerlink" title="步骤11：扩展后端功能"></a>步骤11：扩展后端功能</h4><h5 id="11-1-添加游戏状态保存和加载"><a href="#11-1-添加游戏状态保存和加载" class="headerlink" title="11.1 添加游戏状态保存和加载"></a>11.1 添加游戏状态保存和加载</h5><p>创建 <code>backend/src/main/java/com/kingdomdefense/service/GameStateService.java</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kingdomdefense.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kingdomdefense.model.GameState;</span><br><span class="line"><span class="keyword">import</span> com.kingdomdefense.model.User;</span><br><span class="line"><span class="keyword">import</span> com.kingdomdefense.repository.GameStateRepository;</span><br><span class="line"><span class="keyword">import</span> com.kingdomdefense.repository.UserRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GameStateService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GameStateRepository gameStateRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> GameState <span class="title function_">saveGameState</span><span class="params">(GameState gameState)</span> &#123;</span><br><span class="line">        <span class="comment">// 设置保存时间</span></span><br><span class="line">        gameState.setSavedAt(LocalDateTime.now());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果是新游戏，设置创建时间</span></span><br><span class="line">        <span class="keyword">if</span> (gameState.getId() == <span class="literal">null</span>) &#123;</span><br><span class="line">            gameState.setCreatedAt(LocalDateTime.now());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> gameStateRepository.save(gameState);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Optional&lt;GameState&gt; <span class="title function_">loadGameState</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> gameStateRepository.findById(id);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;GameState&gt; <span class="title function_">getUserGameStates</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> gameStateRepository.findByUserIdOrderBySavedAtDesc(userId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteGameState</span><span class="params">(Long id, Long userId)</span> &#123;</span><br><span class="line">        Optional&lt;GameState&gt; gameStateOpt = gameStateRepository.findById(id);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (gameStateOpt.isPresent() &amp;&amp; </span><br><span class="line">            gameStateOpt.get().getUser().getId().equals(userId)) &#123;</span><br><span class="line">            gameStateRepository.deleteById(id);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> GameState <span class="title function_">createNewGame</span><span class="params">(Long userId, String gameName)</span> &#123;</span><br><span class="line">        Optional&lt;User&gt; userOpt = userRepository.findById(userId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (userOpt.isPresent()) &#123;</span><br><span class="line">            <span class="type">GameState</span> <span class="variable">gameState</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GameState</span>();</span><br><span class="line">            gameState.setUser(userOpt.get());</span><br><span class="line">            gameState.setGameName(gameName);</span><br><span class="line">            gameState.setCreatedAt(LocalDateTime.now());</span><br><span class="line">            gameState.setSavedAt(LocalDateTime.now());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 初始化游戏状态</span></span><br><span class="line">            gameState.setGold(<span class="number">100</span>);</span><br><span class="line">            gameState.setLives(<span class="number">20</span>);</span><br><span class="line">            gameState.setWave(<span class="number">1</span>);</span><br><span class="line">            gameState.setScore(<span class="number">0</span>);</span><br><span class="line">            gameState.setMapData(<span class="string">&quot;&#123;&#125;&quot;</span>); <span class="comment">// 空的JSON数据</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> gameStateRepository.save(gameState);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>创建 <code>backend/src/main/java/com/kingdomdefense/controller/GameStateController.java</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kingdomdefense.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kingdomdefense.model.GameState;</span><br><span class="line"><span class="keyword">import</span> com.kingdomdefense.service.GameStateService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/game&quot;)</span></span><br><span class="line"><span class="meta">@CrossOrigin(origins = &quot;*&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GameStateController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GameStateService gameStateService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">saveGame</span><span class="params">(<span class="meta">@RequestBody</span> GameState gameState)</span> &#123;</span><br><span class="line">        <span class="type">GameState</span> <span class="variable">savedState</span> <span class="operator">=</span> gameStateService.saveGameState(gameState);</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, Object&gt; response = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        response.put(<span class="string">&quot;success&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        response.put(<span class="string">&quot;gameState&quot;</span>, savedState);</span><br><span class="line">        response.put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;Game saved successfully&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/load/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">loadGame</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> gameStateService.loadGameState(id)</span><br><span class="line">                .map(gameState -&gt; &#123;</span><br><span class="line">                    Map&lt;String, Object&gt; response = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                    response.put(<span class="string">&quot;success&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">                    response.put(<span class="string">&quot;gameState&quot;</span>, gameState);</span><br><span class="line">                    <span class="keyword">return</span> ResponseEntity.ok(response);</span><br><span class="line">                &#125;)</span><br><span class="line">                .orElse(ResponseEntity.notFound().build());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/&#123;userId&#125;/saves&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;List&lt;GameState&gt;&gt; <span class="title function_">getUserSaves</span><span class="params">(<span class="meta">@PathVariable</span> Long userId)</span> &#123;</span><br><span class="line">        List&lt;GameState&gt; gameStates = gameStateService.getUserGameStates(userId);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(gameStates);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/new&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">createNewGame</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam</span> Long userId,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam</span> String gameName)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">GameState</span> <span class="variable">newGame</span> <span class="operator">=</span> gameStateService.createNewGame(userId, gameName);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (newGame != <span class="literal">null</span>) &#123;</span><br><span class="line">            Map&lt;String, Object&gt; response = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            response.put(<span class="string">&quot;success&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            response.put(<span class="string">&quot;gameState&quot;</span>, newGame);</span><br><span class="line">            response.put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;New game created&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.ok(response);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Map&lt;String, Object&gt; response = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            response.put(<span class="string">&quot;success&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            response.put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;User not found&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.badRequest().body(response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/delete/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">deleteGame</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> Long id,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam</span> Long userId)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">boolean</span> <span class="variable">deleted</span> <span class="operator">=</span> gameStateService.deleteGameState(id, userId);</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, Object&gt; response = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (deleted) &#123;</span><br><span class="line">            response.put(<span class="string">&quot;success&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            response.put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;Game deleted successfully&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.ok(response);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            response.put(<span class="string">&quot;success&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            response.put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;Game not found or access denied&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.badRequest().body(response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="11-2-添加数据统计和分析"><a href="#11-2-添加数据统计和分析" class="headerlink" title="11.2 添加数据统计和分析"></a>11.2 添加数据统计和分析</h5><p>创建 <code>backend/src/main/java/com/kingdomdefense/service/AnalyticsService.java</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kingdomdefense.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kingdomdefense.model.GameScore;</span><br><span class="line"><span class="keyword">import</span> com.kingdomdefense.repository.GameScoreRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDate;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnalyticsService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GameScoreRepository gameScoreRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getGameAnalytics</span><span class="params">(LocalDate startDate, LocalDate endDate)</span> &#123;</span><br><span class="line">        List&lt;GameScore&gt; scores = gameScoreRepository.findByGameDateBetween(</span><br><span class="line">                startDate.atStartOfDay(),</span><br><span class="line">                endDate.atTime(<span class="number">23</span>, <span class="number">59</span>, <span class="number">59</span>)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, Object&gt; analytics = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 基本统计</span></span><br><span class="line">        analytics.put(<span class="string">&quot;totalGames&quot;</span>, scores.size());</span><br><span class="line">        analytics.put(<span class="string">&quot;uniquePlayers&quot;</span>, scores.stream()</span><br><span class="line">                .map(score -&gt; score.getUser().getId())</span><br><span class="line">                .distinct()</span><br><span class="line">                .count());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 分数统计</span></span><br><span class="line">        <span class="keyword">if</span> (!scores.isEmpty()) &#123;</span><br><span class="line">            analytics.put(<span class="string">&quot;averageScore&quot;</span>, scores.stream()</span><br><span class="line">                    .mapToInt(GameScore::getScore)</span><br><span class="line">                    .average()</span><br><span class="line">                    .orElse(<span class="number">0</span>));</span><br><span class="line">            </span><br><span class="line">            analytics.put(<span class="string">&quot;maxScore&quot;</span>, scores.stream()</span><br><span class="line">                    .mapToInt(GameScore::getScore)</span><br><span class="line">                    .max()</span><br><span class="line">                    .orElse(<span class="number">0</span>));</span><br><span class="line">            </span><br><span class="line">            analytics.put(<span class="string">&quot;minScore&quot;</span>, scores.stream()</span><br><span class="line">                    .mapToInt(GameScore::getScore)</span><br><span class="line">                    .min()</span><br><span class="line">                    .orElse(<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 波次统计</span></span><br><span class="line">        analytics.put(<span class="string">&quot;averageWave&quot;</span>, scores.stream()</span><br><span class="line">                .mapToInt(GameScore::getWaveReached)</span><br><span class="line">                .average()</span><br><span class="line">                .orElse(<span class="number">0</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 塔建造统计</span></span><br><span class="line">        analytics.put(<span class="string">&quot;averageTowers&quot;</span>, scores.stream()</span><br><span class="line">                .mapToInt(GameScore::getTowersBuilt)</span><br><span class="line">                .average()</span><br><span class="line">                .orElse(<span class="number">0</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 每日活跃度</span></span><br><span class="line">        Map&lt;LocalDate, Long&gt; dailyActivity = scores.stream()</span><br><span class="line">                .collect(Collectors.groupingBy(</span><br><span class="line">                        score -&gt; score.getGameDate().toLocalDate(),</span><br><span class="line">                        Collectors.counting()</span><br><span class="line">                ));</span><br><span class="line">        analytics.put(<span class="string">&quot;dailyActivity&quot;</span>, dailyActivity);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 玩家排行榜</span></span><br><span class="line">        Map&lt;String, Integer&gt; playerScores = scores.stream()</span><br><span class="line">                .collect(Collectors.groupingBy(</span><br><span class="line">                        score -&gt; score.getUser().getUsername(),</span><br><span class="line">                        Collectors.summingInt(GameScore::getScore)</span><br><span class="line">                ));</span><br><span class="line">        </span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; playerRanking = playerScores.entrySet().stream()</span><br><span class="line">                .sorted(Map.Entry.&lt;String, Integer&gt;comparingByValue().reversed())</span><br><span class="line">                .limit(<span class="number">10</span>)</span><br><span class="line">                .map(entry -&gt; &#123;</span><br><span class="line">                    Map&lt;String, Object&gt; player = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                    player.put(<span class="string">&quot;username&quot;</span>, entry.getKey());</span><br><span class="line">                    player.put(<span class="string">&quot;totalScore&quot;</span>, entry.getValue());</span><br><span class="line">                    <span class="keyword">return</span> player;</span><br><span class="line">                &#125;)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        </span><br><span class="line">        analytics.put(<span class="string">&quot;playerRanking&quot;</span>, playerRanking);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> analytics;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getPlayerAnalytics</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">        List&lt;GameScore&gt; playerScores = gameScoreRepository.findByUserId(userId);</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, Object&gt; analytics = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!playerScores.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// 玩家统计</span></span><br><span class="line">            analytics.put(<span class="string">&quot;totalGames&quot;</span>, playerScores.size());</span><br><span class="line">            analytics.put(<span class="string">&quot;totalScore&quot;</span>, playerScores.stream()</span><br><span class="line">                    .mapToInt(GameScore::getScore)</span><br><span class="line">                    .sum());</span><br><span class="line">            </span><br><span class="line">            analytics.put(<span class="string">&quot;averageScore&quot;</span>, playerScores.stream()</span><br><span class="line">                    .mapToInt(GameScore::getScore)</span><br><span class="line">                    .average()</span><br><span class="line">                    .orElse(<span class="number">0</span>));</span><br><span class="line">            </span><br><span class="line">            analytics.put(<span class="string">&quot;highScore&quot;</span>, playerScores.stream()</span><br><span class="line">                    .mapToInt(GameScore::getScore)</span><br><span class="line">                    .max()</span><br><span class="line">                    .orElse(<span class="number">0</span>));</span><br><span class="line">            </span><br><span class="line">            analytics.put(<span class="string">&quot;averageWave&quot;</span>, playerScores.stream()</span><br><span class="line">                    .mapToInt(GameScore::getWaveReached)</span><br><span class="line">                    .average()</span><br><span class="line">                    .orElse(<span class="number">0</span>));</span><br><span class="line">            </span><br><span class="line">            analytics.put(<span class="string">&quot;bestWave&quot;</span>, playerScores.stream()</span><br><span class="line">                    .mapToInt(GameScore::getWaveReached)</span><br><span class="line">                    .max()</span><br><span class="line">                    .orElse(<span class="number">0</span>));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 进步趋势</span></span><br><span class="line">            List&lt;Map&lt;String, Object&gt;&gt; progress = playerScores.stream()</span><br><span class="line">                    .sorted(Comparator.comparing(GameScore::getGameDate))</span><br><span class="line">                    .map(score -&gt; &#123;</span><br><span class="line">                        Map&lt;String, Object&gt; game = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                        game.put(<span class="string">&quot;date&quot;</span>, score.getGameDate());</span><br><span class="line">                        game.put(<span class="string">&quot;score&quot;</span>, score.getScore());</span><br><span class="line">                        game.put(<span class="string">&quot;wave&quot;</span>, score.getWaveReached());</span><br><span class="line">                        <span class="keyword">return</span> game;</span><br><span class="line">                    &#125;)</span><br><span class="line">                    .collect(Collectors.toList());</span><br><span class="line">            </span><br><span class="line">            analytics.put(<span class="string">&quot;progress&quot;</span>, progress);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 游戏风格分析</span></span><br><span class="line">            analytics.put(<span class="string">&quot;averageTowers&quot;</span>, playerScores.stream()</span><br><span class="line">                    .mapToInt(GameScore::getTowersBuilt)</span><br><span class="line">                    .average()</span><br><span class="line">                    .orElse(<span class="number">0</span>));</span><br><span class="line">            </span><br><span class="line">            analytics.put(<span class="string">&quot;averageEnemiesDefeated&quot;</span>, playerScores.stream()</span><br><span class="line">                    .mapToInt(GameScore::getEnemiesDefeated)</span><br><span class="line">                    .average()</span><br><span class="line">                    .orElse(<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> analytics;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="第九阶段：完善Python-AI引擎（第10周）"><a href="#第九阶段：完善Python-AI引擎（第10周）" class="headerlink" title="第九阶段：完善Python AI引擎（第10周）"></a>第九阶段：完善Python AI引擎（第10周）</h3><h4 id="步骤12：扩展AI功能"><a href="#步骤12：扩展AI功能" class="headerlink" title="步骤12：扩展AI功能"></a>步骤12：扩展AI功能</h4><h5 id="12-1-添加遗传算法优化塔防布局"><a href="#12-1-添加遗传算法优化塔防布局" class="headerlink" title="12.1 添加遗传算法优化塔防布局"></a>12.1 添加遗传算法优化塔防布局</h5><p>创建 <code>ai-engine/game_ai/genetic_algorithm.py</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span>, <span class="type">Tuple</span></span><br><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GeneticAlgorithm</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, population_size=<span class="number">50</span>, generations=<span class="number">100</span>, mutation_rate=<span class="number">0.1</span></span>):</span><br><span class="line">        self.population_size = population_size</span><br><span class="line">        self.generations = generations</span><br><span class="line">        self.mutation_rate = mutation_rate</span><br><span class="line">        self.population = []</span><br><span class="line">        self.fitness_scores = []</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">optimize_tower_layout</span>(<span class="params">self, map_layout: <span class="type">Dict</span>, budget: <span class="built_in">int</span>, </span></span><br><span class="line"><span class="params">                              tower_types: <span class="type">List</span>[<span class="built_in">str</span>], enemy_path: <span class="type">List</span>[<span class="type">Tuple</span>]</span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        使用遗传算法优化塔防布局</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 初始化种群</span></span><br><span class="line">        self._initialize_population(map_layout, budget, tower_types)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 进化</span></span><br><span class="line">        <span class="keyword">for</span> generation <span class="keyword">in</span> <span class="built_in">range</span>(self.generations):</span><br><span class="line">            <span class="comment"># 评估适应度</span></span><br><span class="line">            self.fitness_scores = self._evaluate_population(map_layout, enemy_path)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 选择</span></span><br><span class="line">            selected = self._selection()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 交叉</span></span><br><span class="line">            children = self._crossover(selected, budget, tower_types)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 变异</span></span><br><span class="line">            self._mutate(children, map_layout, tower_types)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 更新种群</span></span><br><span class="line">            self.population = children</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 打印进度</span></span><br><span class="line">            <span class="keyword">if</span> generation % <span class="number">10</span> == <span class="number">0</span>:</span><br><span class="line">                best_fitness = <span class="built_in">max</span>(self.fitness_scores)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Generation <span class="subst">&#123;generation&#125;</span>: Best fitness = <span class="subst">&#123;best_fitness:<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 返回最佳布局</span></span><br><span class="line">        best_index = np.argmax(self.fitness_scores)</span><br><span class="line">        <span class="keyword">return</span> self.population[best_index]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_initialize_population</span>(<span class="params">self, map_layout: <span class="type">Dict</span>, budget: <span class="built_in">int</span>, tower_types: <span class="type">List</span>[<span class="built_in">str</span>]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;初始化种群&quot;&quot;&quot;</span></span><br><span class="line">        self.population = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(self.population_size):</span><br><span class="line">            layout = []</span><br><span class="line">            remaining_budget = budget</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 随机放置塔直到预算用完</span></span><br><span class="line">            <span class="keyword">while</span> remaining_budget &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># 随机选择塔类型</span></span><br><span class="line">                tower_type = random.choice(tower_types)</span><br><span class="line">                tower_cost = self._get_tower_cost(tower_type)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> tower_cost &lt;= remaining_budget:</span><br><span class="line">                    <span class="comment"># 随机选择位置</span></span><br><span class="line">                    x = random.randint(<span class="number">0</span>, map_layout[<span class="string">&#x27;width&#x27;</span>])</span><br><span class="line">                    y = random.randint(<span class="number">0</span>, map_layout[<span class="string">&#x27;height&#x27;</span>])</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># 检查位置是否有效（不在路径上）</span></span><br><span class="line">                    <span class="keyword">if</span> self._is_valid_position(x, y, map_layout, layout):</span><br><span class="line">                        layout.append(&#123;</span><br><span class="line">                            <span class="string">&#x27;type&#x27;</span>: tower_type,</span><br><span class="line">                            <span class="string">&#x27;x&#x27;</span>: x,</span><br><span class="line">                            <span class="string">&#x27;y&#x27;</span>: y,</span><br><span class="line">                            <span class="string">&#x27;level&#x27;</span>: <span class="number">1</span></span><br><span class="line">                        &#125;)</span><br><span class="line">                        remaining_budget -= tower_cost</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="comment"># 如果位置无效，尝试有限次数后放弃</span></span><br><span class="line">                        attempts = <span class="number">0</span></span><br><span class="line">                        <span class="keyword">while</span> attempts &lt; <span class="number">10</span> <span class="keyword">and</span> <span class="keyword">not</span> self._is_valid_position(x, y, map_layout, layout):</span><br><span class="line">                            x = random.randint(<span class="number">0</span>, map_layout[<span class="string">&#x27;width&#x27;</span>])</span><br><span class="line">                            y = random.randint(<span class="number">0</span>, map_layout[<span class="string">&#x27;height&#x27;</span>])</span><br><span class="line">                            attempts += <span class="number">1</span></span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">if</span> attempts &lt; <span class="number">10</span>:</span><br><span class="line">                            layout.append(&#123;</span><br><span class="line">                                <span class="string">&#x27;type&#x27;</span>: tower_type,</span><br><span class="line">                                <span class="string">&#x27;x&#x27;</span>: x,</span><br><span class="line">                                <span class="string">&#x27;y&#x27;</span>: y,</span><br><span class="line">                                <span class="string">&#x27;level&#x27;</span>: <span class="number">1</span></span><br><span class="line">                            &#125;)</span><br><span class="line">                            remaining_budget -= tower_cost</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line">            self.population.append(layout)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_tower_cost</span>(<span class="params">self, tower_type: <span class="built_in">str</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取塔的成本&quot;&quot;&quot;</span></span><br><span class="line">        costs = &#123;</span><br><span class="line">            <span class="string">&#x27;arrow&#x27;</span>: <span class="number">50</span>,</span><br><span class="line">            <span class="string">&#x27;cannon&#x27;</span>: <span class="number">100</span>,</span><br><span class="line">            <span class="string">&#x27;magic&#x27;</span>: <span class="number">80</span>,</span><br><span class="line">            <span class="string">&#x27;barracks&#x27;</span>: <span class="number">120</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> costs.get(tower_type, <span class="number">50</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_is_valid_position</span>(<span class="params">self, x: <span class="built_in">int</span>, y: <span class="built_in">int</span>, map_layout: <span class="type">Dict</span>, existing_towers: <span class="type">List</span>[<span class="type">Dict</span>]</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查位置是否有效&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 检查是否在边界内</span></span><br><span class="line">        <span class="keyword">if</span> x &lt; <span class="number">0</span> <span class="keyword">or</span> x &gt; map_layout[<span class="string">&#x27;width&#x27;</span>] <span class="keyword">or</span> y &lt; <span class="number">0</span> <span class="keyword">or</span> y &gt; map_layout[<span class="string">&#x27;height&#x27;</span>]:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查是否在路径上（简化检查）</span></span><br><span class="line">        path_points = map_layout.get(<span class="string">&#x27;path&#x27;</span>, [])</span><br><span class="line">        <span class="keyword">for</span> point <span class="keyword">in</span> path_points:</span><br><span class="line">            distance = np.sqrt((point[<span class="string">&#x27;x&#x27;</span>] - x)**<span class="number">2</span> + (point[<span class="string">&#x27;y&#x27;</span>] - y)**<span class="number">2</span>)</span><br><span class="line">            <span class="keyword">if</span> distance &lt; <span class="number">50</span>:  <span class="comment"># 最小距离</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查是否与其他塔太近</span></span><br><span class="line">        <span class="keyword">for</span> tower <span class="keyword">in</span> existing_towers:</span><br><span class="line">            distance = np.sqrt((tower[<span class="string">&#x27;x&#x27;</span>] - x)**<span class="number">2</span> + (tower[<span class="string">&#x27;y&#x27;</span>] - y)**<span class="number">2</span>)</span><br><span class="line">            <span class="keyword">if</span> distance &lt; <span class="number">40</span>:  <span class="comment"># 塔之间的最小距离</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_evaluate_population</span>(<span class="params">self, map_layout: <span class="type">Dict</span>, enemy_path: <span class="type">List</span>[<span class="type">Tuple</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">float</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;评估种群的适应度&quot;&quot;&quot;</span></span><br><span class="line">        fitness_scores = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> layout <span class="keyword">in</span> self.population:</span><br><span class="line">            <span class="comment"># 模拟布局效果</span></span><br><span class="line">            score = self._simulate_layout(layout, map_layout, enemy_path)</span><br><span class="line">            fitness_scores.append(score)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> fitness_scores</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_simulate_layout</span>(<span class="params">self, layout: <span class="type">List</span>[<span class="type">Dict</span>], map_layout: <span class="type">Dict</span>, enemy_path: <span class="type">List</span>[<span class="type">Tuple</span>]</span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;模拟塔防布局的效果&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> layout:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0.0</span></span><br><span class="line">        </span><br><span class="line">        total_score = <span class="number">0.0</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 评估覆盖范围</span></span><br><span class="line">        coverage_score = self._calculate_coverage(layout, enemy_path)</span><br><span class="line">        total_score += coverage_score * <span class="number">0.4</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 评估多样性</span></span><br><span class="line">        diversity_score = self._calculate_diversity(layout)</span><br><span class="line">        total_score += diversity_score * <span class="number">0.2</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 评估协同作用</span></span><br><span class="line">        synergy_score = self._calculate_synergy(layout)</span><br><span class="line">        total_score += synergy_score * <span class="number">0.3</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 评估资源效率</span></span><br><span class="line">        efficiency_score = self._calculate_efficiency(layout)</span><br><span class="line">        total_score += efficiency_score * <span class="number">0.1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> total_score</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_calculate_coverage</span>(<span class="params">self, layout: <span class="type">List</span>[<span class="type">Dict</span>], enemy_path: <span class="type">List</span>[<span class="type">Tuple</span>]</span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算塔对路径的覆盖范围&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> enemy_path:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0.0</span></span><br><span class="line">        </span><br><span class="line">        covered_points = <span class="number">0</span></span><br><span class="line">        total_points = <span class="built_in">len</span>(enemy_path)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> point <span class="keyword">in</span> enemy_path:</span><br><span class="line">            <span class="keyword">for</span> tower <span class="keyword">in</span> layout:</span><br><span class="line">                distance = np.sqrt((tower[<span class="string">&#x27;x&#x27;</span>] - point[<span class="number">0</span>])**<span class="number">2</span> + (tower[<span class="string">&#x27;y&#x27;</span>] - point[<span class="number">1</span>])**<span class="number">2</span>)</span><br><span class="line">                tower_range = self._get_tower_range(tower[<span class="string">&#x27;type&#x27;</span>])</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> distance &lt;= tower_range:</span><br><span class="line">                    covered_points += <span class="number">1</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> covered_points / total_points</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_tower_range</span>(<span class="params">self, tower_type: <span class="built_in">str</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取塔的攻击范围&quot;&quot;&quot;</span></span><br><span class="line">        ranges = &#123;</span><br><span class="line">            <span class="string">&#x27;arrow&#x27;</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="string">&#x27;cannon&#x27;</span>: <span class="number">180</span>,</span><br><span class="line">            <span class="string">&#x27;magic&#x27;</span>: <span class="number">220</span>,</span><br><span class="line">            <span class="string">&#x27;barracks&#x27;</span>: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ranges.get(tower_type, <span class="number">150</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_calculate_diversity</span>(<span class="params">self, layout: <span class="type">List</span>[<span class="type">Dict</span>]</span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算塔类型的多样性&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> layout:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0.0</span></span><br><span class="line">        </span><br><span class="line">        type_counts = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> tower <span class="keyword">in</span> layout:</span><br><span class="line">            tower_type = tower[<span class="string">&#x27;type&#x27;</span>]</span><br><span class="line">            type_counts[tower_type] = type_counts.get(tower_type, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算香农多样性指数</span></span><br><span class="line">        total_towers = <span class="built_in">len</span>(layout)</span><br><span class="line">        diversity = <span class="number">0.0</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> count <span class="keyword">in</span> type_counts.values():</span><br><span class="line">            proportion = count / total_towers</span><br><span class="line">            <span class="keyword">if</span> proportion &gt; <span class="number">0</span>:</span><br><span class="line">                diversity -= proportion * np.log(proportion)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 归一化到0-1范围</span></span><br><span class="line">        max_diversity = np.log(<span class="built_in">len</span>(type_counts)) <span class="keyword">if</span> type_counts <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> diversity / max_diversity <span class="keyword">if</span> max_diversity &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_calculate_synergy</span>(<span class="params">self, layout: <span class="type">List</span>[<span class="type">Dict</span>]</span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算塔之间的协同作用&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(layout) &lt; <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0.0</span></span><br><span class="line">        </span><br><span class="line">        synergy_score = <span class="number">0.0</span></span><br><span class="line">        pairs = <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(layout)):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i + <span class="number">1</span>, <span class="built_in">len</span>(layout)):</span><br><span class="line">                tower1 = layout[i]</span><br><span class="line">                tower2 = layout[j]</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 计算距离</span></span><br><span class="line">                distance = np.sqrt((tower1[<span class="string">&#x27;x&#x27;</span>] - tower2[<span class="string">&#x27;x&#x27;</span>])**<span class="number">2</span> + </span><br><span class="line">                                  (tower1[<span class="string">&#x27;y&#x27;</span>] - tower2[<span class="string">&#x27;y&#x27;</span>])**<span class="number">2</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 理想的距离是攻击范围的一半到三分之二</span></span><br><span class="line">                ideal_distance = (self._get_tower_range(tower1[<span class="string">&#x27;type&#x27;</span>]) + </span><br><span class="line">                                 self._get_tower_range(tower2[<span class="string">&#x27;type&#x27;</span>])) / <span class="number">4</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 距离越接近理想值，协同作用越好</span></span><br><span class="line">                distance_score = <span class="number">1.0</span> / (<span class="number">1.0</span> + <span class="built_in">abs</span>(distance - ideal_distance) / <span class="number">50</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 类型协同</span></span><br><span class="line">                type_synergy = self._get_type_synergy(tower1[<span class="string">&#x27;type&#x27;</span>], tower2[<span class="string">&#x27;type&#x27;</span>])</span><br><span class="line">                </span><br><span class="line">                synergy_score += distance_score * type_synergy</span><br><span class="line">                pairs += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> synergy_score / pairs <span class="keyword">if</span> pairs &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_type_synergy</span>(<span class="params">self, type1: <span class="built_in">str</span>, type2: <span class="built_in">str</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取两种塔类型之间的协同系数&quot;&quot;&quot;</span></span><br><span class="line">        synergy_matrix = &#123;</span><br><span class="line">            (<span class="string">&#x27;arrow&#x27;</span>, <span class="string">&#x27;arrow&#x27;</span>): <span class="number">0.8</span>,</span><br><span class="line">            (<span class="string">&#x27;arrow&#x27;</span>, <span class="string">&#x27;cannon&#x27;</span>): <span class="number">1.2</span>,</span><br><span class="line">            (<span class="string">&#x27;arrow&#x27;</span>, <span class="string">&#x27;magic&#x27;</span>): <span class="number">1.5</span>,</span><br><span class="line">            (<span class="string">&#x27;arrow&#x27;</span>, <span class="string">&#x27;barracks&#x27;</span>): <span class="number">1.3</span>,</span><br><span class="line">            (<span class="string">&#x27;cannon&#x27;</span>, <span class="string">&#x27;cannon&#x27;</span>): <span class="number">0.7</span>,</span><br><span class="line">            (<span class="string">&#x27;cannon&#x27;</span>, <span class="string">&#x27;magic&#x27;</span>): <span class="number">1.1</span>,</span><br><span class="line">            (<span class="string">&#x27;cannon&#x27;</span>, <span class="string">&#x27;barracks&#x27;</span>): <span class="number">1.4</span>,</span><br><span class="line">            (<span class="string">&#x27;magic&#x27;</span>, <span class="string">&#x27;magic&#x27;</span>): <span class="number">0.9</span>,</span><br><span class="line">            (<span class="string">&#x27;magic&#x27;</span>, <span class="string">&#x27;barracks&#x27;</span>): <span class="number">1.6</span>,</span><br><span class="line">            (<span class="string">&#x27;barracks&#x27;</span>, <span class="string">&#x27;barracks&#x27;</span>): <span class="number">0.6</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        key = <span class="built_in">tuple</span>(<span class="built_in">sorted</span>([type1, type2]))</span><br><span class="line">        <span class="keyword">return</span> synergy_matrix.get(key, <span class="number">1.0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_calculate_efficiency</span>(<span class="params">self, layout: <span class="type">List</span>[<span class="type">Dict</span>]</span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算资源使用效率&quot;&quot;&quot;</span></span><br><span class="line">        total_cost = <span class="built_in">sum</span>(self._get_tower_cost(tower[<span class="string">&#x27;type&#x27;</span>]) <span class="keyword">for</span> tower <span class="keyword">in</span> layout)</span><br><span class="line">        total_towers = <span class="built_in">len</span>(layout)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 理想情况是每个塔的平均成本适中</span></span><br><span class="line">        avg_cost = total_cost / total_towers <span class="keyword">if</span> total_towers &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        ideal_avg_cost = <span class="number">80</span>  <span class="comment"># 理想平均成本</span></span><br><span class="line">        </span><br><span class="line">        efficiency = <span class="number">1.0</span> / (<span class="number">1.0</span> + <span class="built_in">abs</span>(avg_cost - ideal_avg_cost) / <span class="number">20</span>)</span><br><span class="line">        <span class="keyword">return</span> efficiency</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_selection</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[<span class="type">List</span>[<span class="type">Dict</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;选择操作（轮盘赌选择）&quot;&quot;&quot;</span></span><br><span class="line">        total_fitness = <span class="built_in">sum</span>(self.fitness_scores)</span><br><span class="line">        <span class="keyword">if</span> total_fitness == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> random.sample(self.population, <span class="built_in">len</span>(self.population) // <span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">        probabilities = [score / total_fitness <span class="keyword">for</span> score <span class="keyword">in</span> self.fitness_scores]</span><br><span class="line">        selected_indices = np.random.choice(</span><br><span class="line">            <span class="built_in">len</span>(self.population),</span><br><span class="line">            size=<span class="built_in">len</span>(self.population) // <span class="number">2</span>,</span><br><span class="line">            p=probabilities,</span><br><span class="line">            replace=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> [self.population[i] <span class="keyword">for</span> i <span class="keyword">in</span> selected_indices]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_crossover</span>(<span class="params">self, selected: <span class="type">List</span>[<span class="type">List</span>[<span class="type">Dict</span>]], budget: <span class="built_in">int</span>, tower_types: <span class="type">List</span>[<span class="built_in">str</span>]</span>) -&gt; <span class="type">List</span>[<span class="type">List</span>[<span class="type">Dict</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;交叉操作&quot;&quot;&quot;</span></span><br><span class="line">        children = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">len</span>(children) &lt; self.population_size:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(selected) &lt; <span class="number">2</span>:</span><br><span class="line">                parents = random.sample(self.population, <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                parents = random.sample(selected, <span class="number">2</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 单点交叉</span></span><br><span class="line">            crossover_point = random.randint(<span class="number">1</span>, <span class="built_in">min</span>(<span class="built_in">len</span>(parents[<span class="number">0</span>]), <span class="built_in">len</span>(parents[<span class="number">1</span>])) - <span class="number">1</span>)</span><br><span class="line">            </span><br><span class="line">            child1 = parents[<span class="number">0</span>][:crossover_point] + parents[<span class="number">1</span>][crossover_point:]</span><br><span class="line">            child2 = parents[<span class="number">1</span>][:crossover_point] + parents[<span class="number">0</span>][crossover_point:]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 修复预算约束</span></span><br><span class="line">            child1 = self._repair_layout(child1, budget, tower_types)</span><br><span class="line">            child2 = self._repair_layout(child2, budget, tower_types)</span><br><span class="line">            </span><br><span class="line">            children.append(child1)</span><br><span class="line">            children.append(child2)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> children[:self.population_size]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_repair_layout</span>(<span class="params">self, layout: <span class="type">List</span>[<span class="type">Dict</span>], budget: <span class="built_in">int</span>, tower_types: <span class="type">List</span>[<span class="built_in">str</span>]</span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;修复布局以满足预算约束&quot;&quot;&quot;</span></span><br><span class="line">        total_cost = <span class="built_in">sum</span>(self._get_tower_cost(tower[<span class="string">&#x27;type&#x27;</span>]) <span class="keyword">for</span> tower <span class="keyword">in</span> layout)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果超出预算，移除最贵的塔</span></span><br><span class="line">        <span class="keyword">while</span> total_cost &gt; budget <span class="keyword">and</span> layout:</span><br><span class="line">            <span class="comment"># 找到最贵的塔</span></span><br><span class="line">            most_expensive_index = <span class="built_in">max</span>(</span><br><span class="line">                <span class="built_in">range</span>(<span class="built_in">len</span>(layout)),</span><br><span class="line">                key=<span class="keyword">lambda</span> i: self._get_tower_cost(layout[i][<span class="string">&#x27;type&#x27;</span>])</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            total_cost -= self._get_tower_cost(layout[most_expensive_index][<span class="string">&#x27;type&#x27;</span>])</span><br><span class="line">            layout.pop(most_expensive_index)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> layout</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_mutate</span>(<span class="params">self, population: <span class="type">List</span>[<span class="type">List</span>[<span class="type">Dict</span>]], map_layout: <span class="type">Dict</span>, tower_types: <span class="type">List</span>[<span class="built_in">str</span>]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;变异操作&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(population)):</span><br><span class="line">            <span class="keyword">if</span> random.random() &lt; self.mutation_rate:</span><br><span class="line">                layout = population[i]</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> layout:</span><br><span class="line">                    <span class="comment"># 随机选择一个塔进行变异</span></span><br><span class="line">                    mutate_index = random.randint(<span class="number">0</span>, <span class="built_in">len</span>(layout) - <span class="number">1</span>)</span><br><span class="line">                    tower = layout[mutate_index]</span><br><span class="line">                    </span><br><span class="line">                    mutation_type = random.choice([<span class="string">&#x27;position&#x27;</span>, <span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;add&#x27;</span>, <span class="string">&#x27;remove&#x27;</span>])</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> mutation_type == <span class="string">&#x27;position&#x27;</span>:</span><br><span class="line">                        <span class="comment"># 改变位置</span></span><br><span class="line">                        new_x = tower[<span class="string">&#x27;x&#x27;</span>] + random.randint(-<span class="number">20</span>, <span class="number">20</span>)</span><br><span class="line">                        new_y = tower[<span class="string">&#x27;y&#x27;</span>] + random.randint(-<span class="number">20</span>, <span class="number">20</span>)</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">if</span> self._is_valid_position(new_x, new_y, map_layout, </span><br><span class="line">                                                  layout[:mutate_index] + layout[mutate_index+<span class="number">1</span>:]):</span><br><span class="line">                            tower[<span class="string">&#x27;x&#x27;</span>] = new_x</span><br><span class="line">                            tower[<span class="string">&#x27;y&#x27;</span>] = new_y</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">elif</span> mutation_type == <span class="string">&#x27;type&#x27;</span>:</span><br><span class="line">                        <span class="comment"># 改变类型</span></span><br><span class="line">                        new_type = random.choice(tower_types)</span><br><span class="line">                        <span class="keyword">if</span> new_type != tower[<span class="string">&#x27;type&#x27;</span>]:</span><br><span class="line">                            tower[<span class="string">&#x27;type&#x27;</span>] = new_type</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">elif</span> mutation_type == <span class="string">&#x27;add&#x27;</span> <span class="keyword">and</span> <span class="built_in">len</span>(layout) &lt; <span class="number">10</span>:</span><br><span class="line">                        <span class="comment"># 添加新塔</span></span><br><span class="line">                        new_tower_type = random.choice(tower_types)</span><br><span class="line">                        new_x = random.randint(<span class="number">0</span>, map_layout[<span class="string">&#x27;width&#x27;</span>])</span><br><span class="line">                        new_y = random.randint(<span class="number">0</span>, map_layout[<span class="string">&#x27;height&#x27;</span>])</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">if</span> self._is_valid_position(new_x, new_y, map_layout, layout):</span><br><span class="line">                            layout.append(&#123;</span><br><span class="line">                                <span class="string">&#x27;type&#x27;</span>: new_tower_type,</span><br><span class="line">                                <span class="string">&#x27;x&#x27;</span>: new_x,</span><br><span class="line">                                <span class="string">&#x27;y&#x27;</span>: new_y,</span><br><span class="line">                                <span class="string">&#x27;level&#x27;</span>: <span class="number">1</span></span><br><span class="line">                            &#125;)</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">elif</span> mutation_type == <span class="string">&#x27;remove&#x27;</span> <span class="keyword">and</span> <span class="built_in">len</span>(layout) &gt; <span class="number">1</span>:</span><br><span class="line">                        <span class="comment"># 移除塔</span></span><br><span class="line">                        layout.pop(mutate_index)</span><br></pre></td></tr></table></figure>



<h3 id="第十阶段：扩展C核心引擎（第11周）"><a href="#第十阶段：扩展C核心引擎（第11周）" class="headerlink" title="第十阶段：扩展C核心引擎（第11周）"></a>第十阶段：扩展C核心引擎（第11周）</h3><h4 id="步骤13：优化碰撞检测和物理引擎"><a href="#步骤13：优化碰撞检测和物理引擎" class="headerlink" title="步骤13：优化碰撞检测和物理引擎"></a>步骤13：优化碰撞检测和物理引擎</h4><p>创建 <code>engine-core/src/physics/collision_detection.c</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;collision_detection.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 圆形碰撞检测</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">circle_collision</span><span class="params">(<span class="type">float</span> x1, <span class="type">float</span> y1, <span class="type">float</span> r1, </span></span><br><span class="line"><span class="params">                     <span class="type">float</span> x2, <span class="type">float</span> y2, <span class="type">float</span> r2)</span> &#123;</span><br><span class="line">    <span class="type">float</span> dx = x1 - x2;</span><br><span class="line">    <span class="type">float</span> dy = y1 - y2;</span><br><span class="line">    <span class="type">float</span> distance = sqrtf(dx * dx + dy * dy);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> distance &lt;= (r1 + r2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 矩形碰撞检测</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">rect_collision</span><span class="params">(<span class="type">float</span> x1, <span class="type">float</span> y1, <span class="type">float</span> w1, <span class="type">float</span> h1,</span></span><br><span class="line"><span class="params">                   <span class="type">float</span> x2, <span class="type">float</span> y2, <span class="type">float</span> w2, <span class="type">float</span> h2)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (x1 &lt; x2 + w2 &amp;&amp;</span><br><span class="line">            x1 + w1 &gt; x2 &amp;&amp;</span><br><span class="line">            y1 &lt; y2 + h2 &amp;&amp;</span><br><span class="line">            y1 + h1 &gt; y2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 圆形与矩形碰撞检测</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">circle_rect_collision</span><span class="params">(<span class="type">float</span> cx, <span class="type">float</span> cy, <span class="type">float</span> radius,</span></span><br><span class="line"><span class="params">                          <span class="type">float</span> rx, <span class="type">float</span> ry, <span class="type">float</span> rw, <span class="type">float</span> rh)</span> &#123;</span><br><span class="line">    <span class="comment">// 找到矩形上距离圆心最近的点</span></span><br><span class="line">    <span class="type">float</span> closestX = fmaxf(rx, fminf(cx, rx + rw));</span><br><span class="line">    <span class="type">float</span> closestY = fmaxf(ry, fminf(cy, ry + rh));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算圆心到这个点的距离</span></span><br><span class="line">    <span class="type">float</span> distanceX = cx - closestX;</span><br><span class="line">    <span class="type">float</span> distanceY = cy - closestY;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果距离小于半径，则发生碰撞</span></span><br><span class="line">    <span class="keyword">return</span> (distanceX * distanceX + distanceY * distanceY) &lt;= (radius * radius);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 点与多边形碰撞检测（使用射线法）</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">point_polygon_collision</span><span class="params">(<span class="type">float</span> px, <span class="type">float</span> py, <span class="type">float</span>* vertices, <span class="type">int</span> vertexCount)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (vertexCount &lt; <span class="number">3</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> inside = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>, j = vertexCount - <span class="number">1</span>; i &lt; vertexCount; j = i++) &#123;</span><br><span class="line">        <span class="type">float</span> vi_x = vertices[i * <span class="number">2</span>];</span><br><span class="line">        <span class="type">float</span> vi_y = vertices[i * <span class="number">2</span> + <span class="number">1</span>];</span><br><span class="line">        <span class="type">float</span> vj_x = vertices[j * <span class="number">2</span>];</span><br><span class="line">        <span class="type">float</span> vj_y = vertices[j * <span class="number">2</span> + <span class="number">1</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (((vi_y &gt; py) != (vj_y &gt; py)) &amp;&amp;</span><br><span class="line">            (px &lt; (vj_x - vi_x) * (py - vi_y) / (vj_y - vi_y) + vi_x)) &#123;</span><br><span class="line">            inside = !inside;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> inside;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算两个圆形的碰撞响应</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">circle_collision_response</span><span class="params">(<span class="type">float</span>* x1, <span class="type">float</span>* y1, <span class="type">float</span>* vx1, <span class="type">float</span>* vy1, <span class="type">float</span> m1, <span class="type">float</span> r1,</span></span><br><span class="line"><span class="params">                               <span class="type">float</span>* x2, <span class="type">float</span>* y2, <span class="type">float</span>* vx2, <span class="type">float</span>* vy2, <span class="type">float</span> m2, <span class="type">float</span> r2,</span></span><br><span class="line"><span class="params">                               <span class="type">float</span> elasticity)</span> &#123;</span><br><span class="line">    <span class="comment">// 计算碰撞法向量</span></span><br><span class="line">    <span class="type">float</span> dx = *x2 - *x1;</span><br><span class="line">    <span class="type">float</span> dy = *y2 - *y1;</span><br><span class="line">    <span class="type">float</span> distance = sqrtf(dx * dx + dy * dy);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (distance == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">float</span> nx = dx / distance;</span><br><span class="line">    <span class="type">float</span> ny = dy / distance;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算相对速度</span></span><br><span class="line">    <span class="type">float</span> dvx = *vx2 - *vx1;</span><br><span class="line">    <span class="type">float</span> dvy = *vy2 - *vy1;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算法向速度</span></span><br><span class="line">    <span class="type">float</span> dvn = dvx * nx + dvy * ny;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果物体正在分离，不做处理</span></span><br><span class="line">    <span class="keyword">if</span> (dvn &gt; <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算冲量</span></span><br><span class="line">    <span class="type">float</span> impulse = -(<span class="number">1</span> + elasticity) * dvn;</span><br><span class="line">    impulse /= (<span class="number">1</span>/m1 + <span class="number">1</span>/m2);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 应用冲量</span></span><br><span class="line">    *vx1 -= impulse * nx / m1;</span><br><span class="line">    *vy1 -= impulse * ny / m1;</span><br><span class="line">    *vx2 += impulse * nx / m2;</span><br><span class="line">    *vy2 += impulse * ny / m2;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 分离物体防止穿透</span></span><br><span class="line">    <span class="type">float</span> overlap = r1 + r2 - distance;</span><br><span class="line">    <span class="keyword">if</span> (overlap &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">float</span> totalMass = m1 + m2;</span><br><span class="line">        *x1 -= overlap * nx * (m2 / totalMass);</span><br><span class="line">        *y1 -= overlap * ny * (m2 / totalMass);</span><br><span class="line">        *x2 += overlap * nx * (m1 / totalMass);</span><br><span class="line">        *y2 += overlap * ny * (m1 / totalMass);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 空间划分网格（用于优化碰撞检测）</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">SpatialGrid</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> cellSize;</span><br><span class="line">    <span class="type">int</span> width, height;</span><br><span class="line">    <span class="type">int</span> rows, cols;</span><br><span class="line">    <span class="type">int</span>*** cells; <span class="comment">// 三维数组：cell[row][col][object_index]</span></span><br><span class="line">    <span class="type">int</span>* cellCounts; <span class="comment">// 每个单元格中的对象数量</span></span><br><span class="line">&#125; SpatialGrid;</span><br><span class="line"></span><br><span class="line">SpatialGrid* <span class="title function_">create_spatial_grid</span><span class="params">(<span class="type">int</span> width, <span class="type">int</span> height, <span class="type">int</span> cellSize)</span> &#123;</span><br><span class="line">    SpatialGrid* grid = (SpatialGrid*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(SpatialGrid));</span><br><span class="line">    grid-&gt;cellSize = cellSize;</span><br><span class="line">    grid-&gt;width = width;</span><br><span class="line">    grid-&gt;height = height;</span><br><span class="line">    grid-&gt;cols = (width + cellSize - <span class="number">1</span>) / cellSize;</span><br><span class="line">    grid-&gt;rows = (height + cellSize - <span class="number">1</span>) / cellSize;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 分配单元格数组</span></span><br><span class="line">    grid-&gt;cells = (<span class="type">int</span>***)<span class="built_in">malloc</span>(grid-&gt;rows * <span class="keyword">sizeof</span>(<span class="type">int</span>**));</span><br><span class="line">    grid-&gt;cellCounts = (<span class="type">int</span>*)<span class="built_in">calloc</span>(grid-&gt;rows * grid-&gt;cols, <span class="keyword">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> r = <span class="number">0</span>; r &lt; grid-&gt;rows; r++) &#123;</span><br><span class="line">        grid-&gt;cells[r] = (<span class="type">int</span>**)<span class="built_in">malloc</span>(grid-&gt;cols * <span class="keyword">sizeof</span>(<span class="type">int</span>*));</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> c = <span class="number">0</span>; c &lt; grid-&gt;cols; c++) &#123;</span><br><span class="line">            grid-&gt;cells[r][c] = (<span class="type">int</span>*)<span class="built_in">malloc</span>(<span class="number">100</span> * <span class="keyword">sizeof</span>(<span class="type">int</span>)); <span class="comment">// 每个单元格最多100个对象</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> grid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">free_spatial_grid</span><span class="params">(SpatialGrid* grid)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> r = <span class="number">0</span>; r &lt; grid-&gt;rows; r++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> c = <span class="number">0</span>; c &lt; grid-&gt;cols; c++) &#123;</span><br><span class="line">            <span class="built_in">free</span>(grid-&gt;cells[r][c]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">free</span>(grid-&gt;cells[r]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(grid-&gt;cells);</span><br><span class="line">    <span class="built_in">free</span>(grid-&gt;cellCounts);</span><br><span class="line">    <span class="built_in">free</span>(grid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">spatial_grid_clear</span><span class="params">(SpatialGrid* grid)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> r = <span class="number">0</span>; r &lt; grid-&gt;rows; r++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> c = <span class="number">0</span>; c &lt; grid-&gt;cols; c++) &#123;</span><br><span class="line">            grid-&gt;cellCounts[r * grid-&gt;cols + c] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">spatial_grid_add</span><span class="params">(SpatialGrid* grid, <span class="type">int</span> id, <span class="type">float</span> x, <span class="type">float</span> y, <span class="type">float</span> radius)</span> &#123;</span><br><span class="line">    <span class="comment">// 计算对象覆盖的单元格范围</span></span><br><span class="line">    <span class="type">int</span> minCol = fmax(<span class="number">0</span>, (<span class="type">int</span>)((x - radius) / grid-&gt;cellSize));</span><br><span class="line">    <span class="type">int</span> maxCol = fmin(grid-&gt;cols - <span class="number">1</span>, (<span class="type">int</span>)((x + radius) / grid-&gt;cellSize));</span><br><span class="line">    <span class="type">int</span> minRow = fmax(<span class="number">0</span>, (<span class="type">int</span>)((y - radius) / grid-&gt;cellSize));</span><br><span class="line">    <span class="type">int</span> maxRow = fmin(grid-&gt;rows - <span class="number">1</span>, (<span class="type">int</span>)((y + radius) / grid-&gt;cellSize));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将对象添加到所有覆盖的单元格</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> r = minRow; r &lt;= maxRow; r++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> c = minCol; c &lt;= maxCol; c++) &#123;</span><br><span class="line">            <span class="type">int</span> index = r * grid-&gt;cols + c;</span><br><span class="line">            <span class="type">int</span> count = grid-&gt;cellCounts[index];</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (count &lt; <span class="number">100</span>) &#123;</span><br><span class="line">                grid-&gt;cells[r][c][count] = id;</span><br><span class="line">                grid-&gt;cellCounts[index] = count + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用空间网格优化碰撞检测</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">spatial_grid_check_collisions</span><span class="params">(SpatialGrid* grid, <span class="type">float</span>* positions, <span class="type">float</span>* radii, <span class="type">int</span> objectCount,</span></span><br><span class="line"><span class="params">                                  <span class="type">int</span>* collisions, <span class="type">int</span> maxCollisions)</span> &#123;</span><br><span class="line">    <span class="type">int</span> collisionCount = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> r = <span class="number">0</span>; r &lt; grid-&gt;rows; r++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> c = <span class="number">0</span>; c &lt; grid-&gt;cols; c++) &#123;</span><br><span class="line">            <span class="type">int</span> cellIndex = r * grid-&gt;cols + c;</span><br><span class="line">            <span class="type">int</span> count = grid-&gt;cellCounts[cellIndex];</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 检查当前单元格内的所有对象对</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count &amp;&amp; collisionCount &lt; maxCollisions; i++) &#123;</span><br><span class="line">                <span class="type">int</span> id1 = grid-&gt;cells[r][c][i];</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> j = i + <span class="number">1</span>; j &lt; count &amp;&amp; collisionCount &lt; maxCollisions; j++) &#123;</span><br><span class="line">                    <span class="type">int</span> id2 = grid-&gt;cells[r][c][j];</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 检查碰撞</span></span><br><span class="line">                    <span class="type">float</span> x1 = positions[id1 * <span class="number">2</span>];</span><br><span class="line">                    <span class="type">float</span> y1 = positions[id1 * <span class="number">2</span> + <span class="number">1</span>];</span><br><span class="line">                    <span class="type">float</span> r1 = radii[id1];</span><br><span class="line">                    </span><br><span class="line">                    <span class="type">float</span> x2 = positions[id2 * <span class="number">2</span>];</span><br><span class="line">                    <span class="type">float</span> y2 = positions[id2 * <span class="number">2</span> + <span class="number">1</span>];</span><br><span class="line">                    <span class="type">float</span> r2 = radii[id2];</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (circle_collision(x1, y1, r1, x2, y2, r2)) &#123;</span><br><span class="line">                        collisions[collisionCount * <span class="number">2</span>] = id1;</span><br><span class="line">                        collisions[collisionCount * <span class="number">2</span> + <span class="number">1</span>] = id2;</span><br><span class="line">                        collisionCount++;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> collisionCount;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">test_collision_detection</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Testing collision detection...\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 测试圆形碰撞</span></span><br><span class="line">    <span class="type">int</span> circleCollision = circle_collision(<span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">5</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Circle collision: %s\n&quot;</span>, circleCollision ? <span class="string">&quot;YES&quot;</span> : <span class="string">&quot;NO&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 测试矩形碰撞</span></span><br><span class="line">    <span class="type">int</span> rectCollision = rect_collision(<span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">10</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Rectangle collision: %s\n&quot;</span>, rectCollision ? <span class="string">&quot;YES&quot;</span> : <span class="string">&quot;NO&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 测试圆形与矩形碰撞</span></span><br><span class="line">    <span class="type">int</span> circleRectCollision = circle_rect_collision(<span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Circle-Rectangle collision: %s\n&quot;</span>, circleRectCollision ? <span class="string">&quot;YES&quot;</span> : <span class="string">&quot;NO&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 测试空间网格</span></span><br><span class="line">    SpatialGrid* grid = create_spatial_grid(<span class="number">100</span>, <span class="number">100</span>, <span class="number">20</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加一些测试对象</span></span><br><span class="line">    <span class="type">float</span> positions[] = &#123;<span class="number">10</span>, <span class="number">10</span>, <span class="number">30</span>, <span class="number">30</span>, <span class="number">15</span>, <span class="number">15</span>&#125;;</span><br><span class="line">    <span class="type">float</span> radii[] = &#123;<span class="number">5</span>, <span class="number">5</span>, <span class="number">8</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    spatial_grid_clear(grid);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">        spatial_grid_add(grid, i, positions[i*<span class="number">2</span>], positions[i*<span class="number">2</span>+<span class="number">1</span>], radii[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> collisions[<span class="number">100</span>];</span><br><span class="line">    <span class="type">int</span> collisionCount = spatial_grid_check_collisions(grid, positions, radii, <span class="number">3</span>, collisions, <span class="number">100</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Found %d collisions using spatial grid\n&quot;</span>, collisionCount);</span><br><span class="line">    </span><br><span class="line">    free_spatial_grid(grid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这个扩展版本添加了以下重要功能：</p>
<h4 id="前端扩展："><a href="#前端扩展：" class="headerlink" title="前端扩展："></a>前端扩展：</h4><ol>
<li><strong>更多塔类型</strong>：添加了兵营、魔法塔等</li>
<li><strong>士兵系统</strong>：兵营可以生成士兵阻挡敌人</li>
<li><strong>状态效果</strong>：减速、持续伤害等</li>
<li><strong>经验系统</strong>：塔可以通过战斗升级</li>
<li><strong>更多敌人类型</strong>：飞行单位、BOSS等</li>
<li><strong>视觉反馈</strong>：状态效果图标、生命条等</li>
</ol>
<h4 id="后端扩展："><a href="#后端扩展：" class="headerlink" title="后端扩展："></a>后端扩展：</h4><ol>
<li><strong>游戏状态管理</strong>：保存、加载、删除游戏</li>
<li><strong>数据分析</strong>：玩家统计、游戏分析、进度跟踪</li>
<li><strong>REST API扩展</strong>：更多端点支持</li>
</ol>
<h4 id="AI引擎扩展："><a href="#AI引擎扩展：" class="headerlink" title="AI引擎扩展："></a>AI引擎扩展：</h4><ol>
<li><strong>遗传算法</strong>：优化塔防布局</li>
<li><strong>布局评估</strong>：覆盖范围、多样性、协同作用等</li>
<li><strong>进化算法</strong>：选择、交叉、变异操作</li>
</ol>
<h4 id="C核心引擎扩展："><a href="#C核心引擎扩展：" class="headerlink" title="C核心引擎扩展："></a>C核心引擎扩展：</h4><ol>
<li><strong>高效碰撞检测</strong>：支持多种形状</li>
<li><strong>物理响应</strong>：碰撞后的速度变化</li>
<li><strong>空间划分</strong>：使用网格优化碰撞检测</li>
<li><strong>内存管理</strong>：高效的对象存储和检索</li>
</ol>
<p>这个完整系统展示了如何构建一个专业级的跨语言游戏项目。每种语言都发挥了其优势：JavaScript处理交互和渲染，Java提供稳定的后端服务，Python实现智能AI，C语言保证核心性能，Shell脚本自动化整个流程。您可以根据具体需求选择实现全部或部分功能。</p>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">
    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/8cf8cd8d.html" rel="prev" title="Shell实践-俄罗斯方块">
                  <i class="fa fa-angle-left"></i> Shell实践-俄罗斯方块
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa-regular fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder"></span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Word count total">393k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">23:48</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>

  <script class="next-config" data-name="wavedrom" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/wavedrom.min.js","integrity":"sha256-INLAoJc6quTNfiMWkGZniYO2cxE8mHpddnLow1m6RFs="}}</script>
  <script class="next-config" data-name="wavedrom_skin" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/skins/default.js","integrity":"sha256-fduc/Zszk5ezWws2uInY/ALWVmIrmV6VTgXbsYSReFI="}}</script>
  <script src="/js/third-party/tags/wavedrom.js"></script>




  





</body>
</html>
