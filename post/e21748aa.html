<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"timewait7.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="我将为您设计一个生产级的消息队列系统，这是一个简化但完整的实现： 一、设计架构图text 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647┌─────────────────────────────────────────────────────────────┐│">
<meta property="og:type" content="article">
<meta property="og:title" content="Java消息队列设计与实现">
<meta property="og:url" content="http://timewait7.github.io/post/e21748aa.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="我将为您设计一个生产级的消息队列系统，这是一个简化但完整的实现： 一、设计架构图text 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647┌─────────────────────────────────────────────────────────────┐│">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-12-17T11:10:39.000Z">
<meta property="article:modified_time" content="2025-12-17T11:11:09.062Z">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://timewait7.github.io/post/e21748aa.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://timewait7.github.io/post/e21748aa.html","path":"post/e21748aa.html","title":"Java消息队列设计与实现"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Java消息队列设计与实现 | Hexo</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-archives"><a href="/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="Searching..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E8%AE%BE%E8%AE%A1%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="nav-number">1.</span> <span class="nav-text">一、设计架构图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3"><span class="nav-number">2.</span> <span class="nav-text">二、核心组件设计文档</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E7%B3%BB%E7%BB%9F%E7%89%B9%E6%80%A7"><span class="nav-number">2.1.</span> <span class="nav-text">1. 系统特性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%B6%88%E6%81%AF%E5%8D%8F%E8%AE%AE%E8%AE%BE%E8%AE%A1"><span class="nav-number">2.2.</span> <span class="nav-text">2. 消息协议设计</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.</span> <span class="nav-text">三、完整代码实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B"><span class="nav-number">3.1.</span> <span class="nav-text">1. 消息模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="nav-number">3.2.</span> <span class="nav-text">2. 存储引擎</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%B6%88%E6%81%AF%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">3.3.</span> <span class="nav-text">3. 消息代理服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%B6%88%E8%B4%B9%E8%80%85%E5%81%8F%E7%A7%BB%E9%87%8F%E7%AE%A1%E7%90%86%E5%99%A8"><span class="nav-number">3.4.</span> <span class="nav-text">4. 消费者偏移量管理器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E7%94%9F%E4%BA%A7%E8%80%85%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">3.5.</span> <span class="nav-text">5. 生产者客户端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E6%B6%88%E8%B4%B9%E8%80%85%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">3.6.</span> <span class="nav-text">6. 消费者客户端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="nav-number">3.7.</span> <span class="nav-text">7. 启动类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E"><span class="nav-number">4.</span> <span class="nav-text">四、使用说明</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E7%BC%96%E8%AF%91%E5%92%8C%E8%BF%90%E8%A1%8C"><span class="nav-number">4.1.</span> <span class="nav-text">1. 编译和运行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Maven%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE"><span class="nav-number">4.2.</span> <span class="nav-text">2. Maven项目配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-API%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="nav-number">4.3.</span> <span class="nav-text">3. API使用示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B"><span class="nav-number">5.</span> <span class="nav-text">五、测试用例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="nav-number">5.1.</span> <span class="nav-text">1. 单元测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="nav-number">5.2.</span> <span class="nav-text">2. 性能测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95"><span class="nav-number">5.3.</span> <span class="nav-text">3. 集成测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E9%83%A8%E7%BD%B2%E5%92%8C%E7%94%9F%E4%BA%A7%E5%BB%BA%E8%AE%AE"><span class="nav-number">6.</span> <span class="nav-text">六、部署和生产建议</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">6.1.</span> <span class="nav-text">1. 配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87"><span class="nav-number">6.2.</span> <span class="nav-text">2. 监控指标</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%89%A9%E5%B1%95%E5%BB%BA%E8%AE%AE"><span class="nav-number">6.3.</span> <span class="nav-text">3. 扩展建议</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/">
          <span class="site-state-item-count">51</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://timewait7.github.io/post/e21748aa.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Java消息队列设计与实现 | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Java消息队列设计与实现
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-12-17 19:10:39" itemprop="dateCreated datePublished" datetime="2025-12-17T19:10:39+08:00">2025-12-17</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>4.4k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>16 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>我将为您设计一个生产级的消息队列系统，这是一个简化但完整的实现：</p>
<h2 id="一、设计架构图"><a href="#一、设计架构图" class="headerlink" title="一、设计架构图"></a>一、设计架构图</h2><p>text</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    Java Message Queue (JMQ)                  │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│                        整体架构                              │</span><br><span class="line">│                                                             │</span><br><span class="line">│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    │</span><br><span class="line">│  │   Producer  │    │   Consumer  │    │ Admin Client│    │</span><br><span class="line">│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    │</span><br><span class="line">│         │                  │                   │           │</span><br><span class="line">│  ┌──────┴──────────────────┴───────────────────┴──────┐    │</span><br><span class="line">│  │                  Network Layer                     │    │</span><br><span class="line">│  │              (TCP长连接 + 协议编解码)                │    │</span><br><span class="line">│  └─────────────────────────┬──────────────────────────┘    │</span><br><span class="line">│                            │                                │</span><br><span class="line">│  ┌─────────────────────────┼──────────────────────────┐    │</span><br><span class="line">│  │         Broker Server  (消息代理服务器)              │    │</span><br><span class="line">│  │  ┌────────────────────────────────────────────┐    │    │</span><br><span class="line">│  │  │              Topic Manager                 │    │    │</span><br><span class="line">│  │  │  ┌────────────┐  ┌────────────┐           │    │    │</span><br><span class="line">│  │  │  │   Topic    │  │   Topic    │  ...      │    │    │</span><br><span class="line">│  │  │  └─────┬──────┘  └─────┬──────┘           │    │    │</span><br><span class="line">│  │  │        │               │                   │    │    │</span><br><span class="line">│  │  │  ┌─────▼──────┐  ┌─────▼──────┐           │    │    │</span><br><span class="line">│  │  │  │  Partition │  │  Partition │           │    │    │</span><br><span class="line">│  │  │  │  + Queue   │  │  + Queue   │           │    │    │</span><br><span class="line">│  │  │  └────────────┘  └────────────┘           │    │    │</span><br><span class="line">│  │  └────────────────────────────────────────────┘    │    │</span><br><span class="line">│  │                                                    │    │</span><br><span class="line">│  │  ┌────────────────────────────────────────────┐    │    │</span><br><span class="line">│  │  │            Storage Engine                  │    │    │</span><br><span class="line">│  │  │   ┌──────────────────────────────┐        │    │    │</span><br><span class="line">│  │  │   │    Write Ahead Log (WAL)     │        │    │    │</span><br><span class="line">│  │  │   │   + 内存映射文件 + 顺序写入     │        │    │    │</span><br><span class="line">│  │  │   └──────────────────────────────┘        │    │    │</span><br><span class="line">│  │  │   ┌──────────────────────────────┐        │    │    │</span><br><span class="line">│  │  │   │      Consumer Offset         │        │    │    │</span><br><span class="line">│  │  │   │       + 消费进度管理          │        │    │    │</span><br><span class="line">│  │  │   └──────────────────────────────┘        │    │    │</span><br><span class="line">│  │  └────────────────────────────────────────────┘    │    │</span><br><span class="line">│  │                                                    │    │</span><br><span class="line">│  │  ┌────────────────────────────────────────────┐    │    │</span><br><span class="line">│  │  │        Connection Manager                  │    │    │</span><br><span class="line">│  │  │    (连接池 + 心跳检测 + 会话管理)           │    │    │</span><br><span class="line">│  │  └────────────────────────────────────────────┘    │    │</span><br><span class="line">│  └─────────────────────────────────────────────────────┘    │</span><br><span class="line">│                                                             │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>



<h2 id="二、核心组件设计文档"><a href="#二、核心组件设计文档" class="headerlink" title="二、核心组件设计文档"></a>二、核心组件设计文档</h2><h3 id="1-系统特性"><a href="#1-系统特性" class="headerlink" title="1. 系统特性"></a>1. 系统特性</h3><ul>
<li>支持发布&#x2F;订阅和点对点模式</li>
<li>消息持久化（WAL + 内存映射文件）</li>
<li>至少一次投递语义</li>
<li>支持消息过滤和延迟消息</li>
<li>消费进度管理</li>
<li>集群支持（基础版）</li>
</ul>
<h3 id="2-消息协议设计"><a href="#2-消息协议设计" class="headerlink" title="2. 消息协议设计"></a>2. 消息协议设计</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 消息格式：</span><br><span class="line"> * +------------+------------+------------+------------+------------+</span><br><span class="line"> * | 总长度(4)  | 版本(1)    | 类型(1)    | 头部长度(2)| 头部数据   |</span><br><span class="line"> * +------------+------------+------------+------------+------------+</span><br><span class="line"> * |                        消息体数据                             |</span><br><span class="line"> * +--------------------------------------------------------------+</span><br><span class="line"> */</span><br></pre></td></tr></table></figure>



<h2 id="三、完整代码实现"><a href="#三、完整代码实现" class="headerlink" title="三、完整代码实现"></a>三、完整代码实现</h2><h3 id="1-消息模型"><a href="#1-消息模型" class="headerlink" title="1. 消息模型"></a>1. 消息模型</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">// Message.java</span><br><span class="line">package com.jmq.core.message;</span><br><span class="line"></span><br><span class="line">import java.io.Serializable;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line">public class Message implements Serializable &#123;</span><br><span class="line">    private static final AtomicLong MESSAGE_ID_GENERATOR = new AtomicLong(0);</span><br><span class="line">    </span><br><span class="line">    private String messageId;</span><br><span class="line">    private String topic;</span><br><span class="line">    private byte[] body;</span><br><span class="line">    private Map&lt;String, String&gt; properties;</span><br><span class="line">    private long bornTimestamp;</span><br><span class="line">    private long storeTimestamp;</span><br><span class="line">    private int delayTime = 0; // 延迟时间，单位：秒</span><br><span class="line">    private int retryCount = 0;</span><br><span class="line">    </span><br><span class="line">    public Message(String topic, byte[] body) &#123;</span><br><span class="line">        this.messageId = generateMessageId();</span><br><span class="line">        this.topic = topic;</span><br><span class="line">        this.body = body;</span><br><span class="line">        this.properties = new HashMap&lt;&gt;();</span><br><span class="line">        this.bornTimestamp = System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private static String generateMessageId() &#123;</span><br><span class="line">        return String.format(&quot;%d-%d&quot;, System.currentTimeMillis(), </span><br><span class="line">                           MESSAGE_ID_GENERATOR.incrementAndGet());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Getters and Setters</span><br><span class="line">    public String getMessageId() &#123; return messageId; &#125;</span><br><span class="line">    public String getTopic() &#123; return topic; &#125;</span><br><span class="line">    public byte[] getBody() &#123; return body; &#125;</span><br><span class="line">    public Map&lt;String, String&gt; getProperties() &#123; return properties; &#125;</span><br><span class="line">    public long getBornTimestamp() &#123; return bornTimestamp; &#125;</span><br><span class="line">    public long getStoreTimestamp() &#123; return storeTimestamp; &#125;</span><br><span class="line">    public void setStoreTimestamp(long storeTimestamp) &#123; </span><br><span class="line">        this.storeTimestamp = storeTimestamp; </span><br><span class="line">    &#125;</span><br><span class="line">    public int getDelayTime() &#123; return delayTime; &#125;</span><br><span class="line">    public void setDelayTime(int delayTime) &#123; this.delayTime = delayTime; &#125;</span><br><span class="line">    public int getRetryCount() &#123; return retryCount; &#125;</span><br><span class="line">    public void setRetryCount(int retryCount) &#123; this.retryCount = retryCount; &#125;</span><br><span class="line">    </span><br><span class="line">    public void putProperty(String key, String value) &#123;</span><br><span class="line">        properties.put(key, value);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public String getProperty(String key) &#123;</span><br><span class="line">        return properties.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-存储引擎"><a href="#2-存储引擎" class="headerlink" title="2. 存储引擎"></a>2. 存储引擎</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br></pre></td><td class="code"><pre><span class="line">// StorageEngine.java</span><br><span class="line">package com.jmq.core.store;</span><br><span class="line"></span><br><span class="line">import com.jmq.core.message.Message;</span><br><span class="line">import java.io.File;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.RandomAccessFile;</span><br><span class="line">import java.nio.ByteBuffer;</span><br><span class="line">import java.nio.MappedByteBuffer;</span><br><span class="line">import java.nio.channels.FileChannel;</span><br><span class="line">import java.nio.charset.StandardCharsets;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.concurrent.ConcurrentHashMap;</span><br><span class="line">import java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line">public class StorageEngine &#123;</span><br><span class="line">    private final String storePath;</span><br><span class="line">    private final ConcurrentHashMap&lt;String, TopicStorage&gt; topicStorages;</span><br><span class="line">    private static final int MAX_FILE_SIZE = 1024 * 1024 * 1024; // 1GB</span><br><span class="line">    </span><br><span class="line">    public StorageEngine(String storePath) &#123;</span><br><span class="line">        this.storePath = storePath;</span><br><span class="line">        this.topicStorages = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">        initializeStoreDirectory();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void initializeStoreDirectory() &#123;</span><br><span class="line">        File dir = new File(storePath);</span><br><span class="line">        if (!dir.exists()) &#123;</span><br><span class="line">            dir.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void putMessage(String topic, Message message) throws IOException &#123;</span><br><span class="line">        TopicStorage storage = topicStorages.computeIfAbsent(topic, </span><br><span class="line">            k -&gt; new TopicStorage(storePath, k));</span><br><span class="line">        storage.append(message);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public List&lt;Message&gt; getMessages(String topic, long offset, int batchSize) </span><br><span class="line">            throws IOException &#123;</span><br><span class="line">        TopicStorage storage = topicStorages.get(topic);</span><br><span class="line">        if (storage == null) &#123;</span><br><span class="line">            return new ArrayList&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        return storage.read(offset, batchSize);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public long getMaxOffset(String topic) &#123;</span><br><span class="line">        TopicStorage storage = topicStorages.get(topic);</span><br><span class="line">        return storage != null ? storage.getMaxOffset() : 0;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 内部存储类</span><br><span class="line">    static class TopicStorage &#123;</span><br><span class="line">        private final String topic;</span><br><span class="line">        private final String dataPath;</span><br><span class="line">        private final String indexPath;</span><br><span class="line">        private RandomAccessFile dataFile;</span><br><span class="line">        private RandomAccessFile indexFile;</span><br><span class="line">        private FileChannel dataChannel;</span><br><span class="line">        private FileChannel indexChannel;</span><br><span class="line">        private MappedByteBuffer dataBuffer;</span><br><span class="line">        private MappedByteBuffer indexBuffer;</span><br><span class="line">        private long currentPosition = 0;</span><br><span class="line">        private final ReentrantLock lock = new ReentrantLock();</span><br><span class="line">        </span><br><span class="line">        public TopicStorage(String basePath, String topic) throws IOException &#123;</span><br><span class="line">            this.topic = topic;</span><br><span class="line">            this.dataPath = basePath + File.separator + topic + &quot;.data&quot;;</span><br><span class="line">            this.indexPath = basePath + File.separator + topic + &quot;.index&quot;;</span><br><span class="line">            </span><br><span class="line">            initializeFiles();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        private void initializeFiles() throws IOException &#123;</span><br><span class="line">            File dataFile = new File(dataPath);</span><br><span class="line">            File indexFile = new File(indexPath);</span><br><span class="line">            </span><br><span class="line">            if (!dataFile.exists()) &#123;</span><br><span class="line">                dataFile.createNewFile();</span><br><span class="line">            &#125;</span><br><span class="line">            if (!indexFile.exists()) &#123;</span><br><span class="line">                indexFile.createNewFile();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            this.dataFile = new RandomAccessFile(dataFile, &quot;rw&quot;);</span><br><span class="line">            this.indexFile = new RandomAccessFile(indexFile, &quot;rw&quot;);</span><br><span class="line">            this.dataChannel = this.dataFile.getChannel();</span><br><span class="line">            this.indexChannel = this.indexFile.getChannel();</span><br><span class="line">            </span><br><span class="line">            // 使用内存映射提高IO性能</span><br><span class="line">            this.dataBuffer = dataChannel.map(</span><br><span class="line">                FileChannel.MapMode.READ_WRITE, 0, MAX_FILE_SIZE);</span><br><span class="line">            this.indexBuffer = indexChannel.map(</span><br><span class="line">                FileChannel.MapMode.READ_WRITE, 0, MAX_FILE_SIZE);</span><br><span class="line">            </span><br><span class="line">            this.currentPosition = dataFile.length();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        public void append(Message message) throws IOException &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            try &#123;</span><br><span class="line">                byte[] messageBytes = serializeMessage(message);</span><br><span class="line">                int messageSize = messageBytes.length;</span><br><span class="line">                </span><br><span class="line">                // 写入数据文件</span><br><span class="line">                dataBuffer.position((int) currentPosition);</span><br><span class="line">                dataBuffer.putInt(messageSize);</span><br><span class="line">                dataBuffer.put(messageBytes);</span><br><span class="line">                </span><br><span class="line">                // 写入索引文件</span><br><span class="line">                indexBuffer.putLong(currentPosition); // 消息位置</span><br><span class="line">                indexBuffer.putInt(messageSize);      // 消息大小</span><br><span class="line">                </span><br><span class="line">                currentPosition += 4 + messageSize; // 4字节长度 + 消息体</span><br><span class="line">                dataBuffer.force();</span><br><span class="line">                indexBuffer.force();</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        public List&lt;Message&gt; read(long offset, int batchSize) throws IOException &#123;</span><br><span class="line">            List&lt;Message&gt; messages = new ArrayList&lt;&gt;();</span><br><span class="line">            lock.lock();</span><br><span class="line">            try &#123;</span><br><span class="line">                if (offset &gt;= currentPosition) &#123;</span><br><span class="line">                    return messages;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                dataBuffer.position((int) offset);</span><br><span class="line">                int count = 0;</span><br><span class="line">                </span><br><span class="line">                while (count &lt; batchSize &amp;&amp; dataBuffer.position() &lt; currentPosition) &#123;</span><br><span class="line">                    int messageSize = dataBuffer.getInt();</span><br><span class="line">                    if (messageSize &lt;= 0 || messageSize &gt; 1024 * 1024) &#123; // 1MB限制</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    byte[] messageBytes = new byte[messageSize];</span><br><span class="line">                    dataBuffer.get(messageBytes);</span><br><span class="line">                    </span><br><span class="line">                    Message message = deserializeMessage(messageBytes);</span><br><span class="line">                    messages.add(message);</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">            return messages;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        public long getMaxOffset() &#123;</span><br><span class="line">            return currentPosition;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        private byte[] serializeMessage(Message message) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                // 简单序列化实现，生产环境可以使用protobuf等</span><br><span class="line">                ByteBuffer buffer = ByteBuffer.allocate(1024 * 1024); // 1MB</span><br><span class="line">                </span><br><span class="line">                // 写入消息ID</span><br><span class="line">                byte[] msgIdBytes = message.getMessageId().getBytes(StandardCharsets.UTF_8);</span><br><span class="line">                buffer.putInt(msgIdBytes.length);</span><br><span class="line">                buffer.put(msgIdBytes);</span><br><span class="line">                </span><br><span class="line">                // 写入消息体</span><br><span class="line">                buffer.putInt(message.getBody().length);</span><br><span class="line">                buffer.put(message.getBody());</span><br><span class="line">                </span><br><span class="line">                // 写入topic</span><br><span class="line">                byte[] topicBytes = message.getTopic().getBytes(StandardCharsets.UTF_8);</span><br><span class="line">                buffer.putInt(topicBytes.length);</span><br><span class="line">                buffer.put(topicBytes);</span><br><span class="line">                </span><br><span class="line">                // 写入属性数量</span><br><span class="line">                buffer.putInt(message.getProperties().size());</span><br><span class="line">                for (Map.Entry&lt;String, String&gt; entry : message.getProperties().entrySet()) &#123;</span><br><span class="line">                    byte[] keyBytes = entry.getKey().getBytes(StandardCharsets.UTF_8);</span><br><span class="line">                    buffer.putInt(keyBytes.length);</span><br><span class="line">                    buffer.put(keyBytes);</span><br><span class="line">                    </span><br><span class="line">                    byte[] valueBytes = entry.getValue().getBytes(StandardCharsets.UTF_8);</span><br><span class="line">                    buffer.putInt(valueBytes.length);</span><br><span class="line">                    buffer.put(valueBytes);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                buffer.flip();</span><br><span class="line">                byte[] result = new byte[buffer.limit()];</span><br><span class="line">                buffer.get(result);</span><br><span class="line">                return result;</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                throw new RuntimeException(&quot;Serialize message failed&quot;, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        private Message deserializeMessage(byte[] bytes) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                ByteBuffer buffer = ByteBuffer.wrap(bytes);</span><br><span class="line">                </span><br><span class="line">                // 读取消息ID</span><br><span class="line">                int msgIdLen = buffer.getInt();</span><br><span class="line">                byte[] msgIdBytes = new byte[msgIdLen];</span><br><span class="line">                buffer.get(msgIdBytes);</span><br><span class="line">                String messageId = new String(msgIdBytes, StandardCharsets.UTF_8);</span><br><span class="line">                </span><br><span class="line">                // 读取消息体</span><br><span class="line">                int bodyLen = buffer.getInt();</span><br><span class="line">                byte[] body = new byte[bodyLen];</span><br><span class="line">                buffer.get(body);</span><br><span class="line">                </span><br><span class="line">                // 读取topic</span><br><span class="line">                int topicLen = buffer.getInt();</span><br><span class="line">                byte[] topicBytes = new byte[topicLen];</span><br><span class="line">                buffer.get(topicBytes);</span><br><span class="line">                String topic = new String(topicBytes, StandardCharsets.UTF_8);</span><br><span class="line">                </span><br><span class="line">                Message message = new Message(topic, body);</span><br><span class="line">                message.setMessageId(messageId);</span><br><span class="line">                </span><br><span class="line">                // 读取属性</span><br><span class="line">                int propCount = buffer.getInt();</span><br><span class="line">                for (int i = 0; i &lt; propCount; i++) &#123;</span><br><span class="line">                    int keyLen = buffer.getInt();</span><br><span class="line">                    byte[] keyBytes = new byte[keyLen];</span><br><span class="line">                    buffer.get(keyBytes);</span><br><span class="line">                    String key = new String(keyBytes, StandardCharsets.UTF_8);</span><br><span class="line">                    </span><br><span class="line">                    int valueLen = buffer.getInt();</span><br><span class="line">                    byte[] valueBytes = new byte[valueLen];</span><br><span class="line">                    buffer.get(valueBytes);</span><br><span class="line">                    String value = new String(valueBytes, StandardCharsets.UTF_8);</span><br><span class="line">                    </span><br><span class="line">                    message.putProperty(key, value);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                return message;</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                throw new RuntimeException(&quot;Deserialize message failed&quot;, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        public void close() throws IOException &#123;</span><br><span class="line">            dataChannel.close();</span><br><span class="line">            indexChannel.close();</span><br><span class="line">            dataFile.close();</span><br><span class="line">            indexFile.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-消息代理服务器"><a href="#3-消息代理服务器" class="headerlink" title="3. 消息代理服务器"></a>3. 消息代理服务器</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br></pre></td><td class="code"><pre><span class="line">// JMQBroker.java</span><br><span class="line">package com.jmq.core.broker;</span><br><span class="line"></span><br><span class="line">import com.jmq.core.message.Message;</span><br><span class="line">import com.jmq.core.store.StorageEngine;</span><br><span class="line">import com.jmq.core.store.ConsumerOffsetManager;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.net.InetSocketAddress;</span><br><span class="line">import java.nio.ByteBuffer;</span><br><span class="line">import java.nio.channels.SelectionKey;</span><br><span class="line">import java.nio.channels.Selector;</span><br><span class="line">import java.nio.channels.ServerSocketChannel;</span><br><span class="line">import java.nio.channels.SocketChannel;</span><br><span class="line">import java.nio.charset.StandardCharsets;</span><br><span class="line">import java.util.*;</span><br><span class="line">import java.util.concurrent.*;</span><br><span class="line">import java.util.concurrent.atomic.AtomicBoolean;</span><br><span class="line"></span><br><span class="line">public class JMQBroker &#123;</span><br><span class="line">    private final int port;</span><br><span class="line">    private final String storePath;</span><br><span class="line">    private ServerSocketChannel serverChannel;</span><br><span class="line">    private Selector selector;</span><br><span class="line">    private final StorageEngine storageEngine;</span><br><span class="line">    private final ConsumerOffsetManager offsetManager;</span><br><span class="line">    private final ExecutorService executorService;</span><br><span class="line">    private final AtomicBoolean running = new AtomicBoolean(false);</span><br><span class="line">    private final Map&lt;SocketChannel, ClientSession&gt; clientSessions = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    // Topic分区管理</span><br><span class="line">    private final Map&lt;String, List&lt;MessageQueue&gt;&gt; topicQueues = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    private static final int DEFAULT_QUEUE_NUM = 4;</span><br><span class="line">    </span><br><span class="line">    public JMQBroker(int port, String storePath) &#123;</span><br><span class="line">        this.port = port;</span><br><span class="line">        this.storePath = storePath;</span><br><span class="line">        this.storageEngine = new StorageEngine(storePath);</span><br><span class="line">        this.offsetManager = new ConsumerOffsetManager(storePath);</span><br><span class="line">        this.executorService = Executors.newFixedThreadPool(</span><br><span class="line">            Runtime.getRuntime().availableProcessors() * 2);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void start() throws IOException &#123;</span><br><span class="line">        if (running.compareAndSet(false, true)) &#123;</span><br><span class="line">            initialize();</span><br><span class="line">            new Thread(this::listen).start();</span><br><span class="line">            System.out.println(&quot;JMQ Broker started on port &quot; + port);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void initialize() throws IOException &#123;</span><br><span class="line">        selector = Selector.open();</span><br><span class="line">        serverChannel = ServerSocketChannel.open();</span><br><span class="line">        serverChannel.configureBlocking(false);</span><br><span class="line">        serverChannel.socket().bind(new InetSocketAddress(port));</span><br><span class="line">        serverChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">        </span><br><span class="line">        // 初始化offset管理器</span><br><span class="line">        offsetManager.load();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void listen() &#123;</span><br><span class="line">        while (running.get()) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                selector.select(1000);</span><br><span class="line">                Set&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys();</span><br><span class="line">                Iterator&lt;SelectionKey&gt; iter = selectedKeys.iterator();</span><br><span class="line">                </span><br><span class="line">                while (iter.hasNext()) &#123;</span><br><span class="line">                    SelectionKey key = iter.next();</span><br><span class="line">                    iter.remove();</span><br><span class="line">                    </span><br><span class="line">                    if (key.isAcceptable()) &#123;</span><br><span class="line">                        handleAccept(key);</span><br><span class="line">                    &#125; else if (key.isReadable()) &#123;</span><br><span class="line">                        handleRead(key);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void handleAccept(SelectionKey key) throws IOException &#123;</span><br><span class="line">        ServerSocketChannel serverChannel = (ServerSocketChannel) key.channel();</span><br><span class="line">        SocketChannel clientChannel = serverChannel.accept();</span><br><span class="line">        clientChannel.configureBlocking(false);</span><br><span class="line">        clientChannel.register(selector, SelectionKey.OP_READ);</span><br><span class="line">        </span><br><span class="line">        ClientSession session = new ClientSession(clientChannel);</span><br><span class="line">        clientSessions.put(clientChannel, session);</span><br><span class="line">        System.out.println(&quot;Client connected: &quot; + clientChannel.getRemoteAddress());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void handleRead(SelectionKey key) &#123;</span><br><span class="line">        SocketChannel clientChannel = (SocketChannel) key.channel();</span><br><span class="line">        ClientSession session = clientSessions.get(clientChannel);</span><br><span class="line">        </span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                ByteBuffer buffer = ByteBuffer.allocate(1024 * 1024); // 1MB</span><br><span class="line">                int bytesRead = clientChannel.read(buffer);</span><br><span class="line">                </span><br><span class="line">                if (bytesRead &gt; 0) &#123;</span><br><span class="line">                    buffer.flip();</span><br><span class="line">                    byte[] data = new byte[buffer.remaining()];</span><br><span class="line">                    buffer.get(data);</span><br><span class="line">                    </span><br><span class="line">                    String request = new String(data, StandardCharsets.UTF_8);</span><br><span class="line">                    String response = processRequest(session, request);</span><br><span class="line">                    </span><br><span class="line">                    if (response != null) &#123;</span><br><span class="line">                        ByteBuffer responseBuffer = ByteBuffer.wrap(</span><br><span class="line">                            response.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">                        clientChannel.write(responseBuffer);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else if (bytesRead == -1) &#123;</span><br><span class="line">                    // 客户端断开连接</span><br><span class="line">                    clientChannel.close();</span><br><span class="line">                    clientSessions.remove(clientChannel);</span><br><span class="line">                    System.out.println(&quot;Client disconnected: &quot; + </span><br><span class="line">                        clientChannel.getRemoteAddress());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private String processRequest(ClientSession session, String request) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            String[] parts = request.split(&quot;\\|&quot;, 4);</span><br><span class="line">            if (parts.length &lt; 2) &#123;</span><br><span class="line">                return &quot;ERROR|Invalid request format&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            String command = parts[0];</span><br><span class="line">            String topic = parts[1];</span><br><span class="line">            </span><br><span class="line">            switch (command) &#123;</span><br><span class="line">                case &quot;SEND&quot;:</span><br><span class="line">                    if (parts.length &lt; 3) &#123;</span><br><span class="line">                        return &quot;ERROR|Missing message body&quot;;</span><br><span class="line">                    &#125;</span><br><span class="line">                    return handleSend(topic, parts[2]);</span><br><span class="line">                    </span><br><span class="line">                case &quot;PULL&quot;:</span><br><span class="line">                    if (parts.length &lt; 4) &#123;</span><br><span class="line">                        return &quot;ERROR|Missing consumer group or batch size&quot;;</span><br><span class="line">                    &#125;</span><br><span class="line">                    String consumerGroup = parts[2];</span><br><span class="line">                    int batchSize = Integer.parseInt(parts[3]);</span><br><span class="line">                    return handlePull(session, topic, consumerGroup, batchSize);</span><br><span class="line">                    </span><br><span class="line">                case &quot;ACK&quot;:</span><br><span class="line">                    if (parts.length &lt; 4) &#123;</span><br><span class="line">                        return &quot;ERROR|Missing consumer group or offset&quot;;</span><br><span class="line">                    &#125;</span><br><span class="line">                    String ackGroup = parts[2];</span><br><span class="line">                    long offset = Long.parseLong(parts[3]);</span><br><span class="line">                    return handleAck(topic, ackGroup, offset);</span><br><span class="line">                    </span><br><span class="line">                case &quot;CREATE_TOPIC&quot;:</span><br><span class="line">                    int queueNum = parts.length &gt; 2 ? Integer.parseInt(parts[2]) : DEFAULT_QUEUE_NUM;</span><br><span class="line">                    return handleCreateTopic(topic, queueNum);</span><br><span class="line">                    </span><br><span class="line">                default:</span><br><span class="line">                    return &quot;ERROR|Unknown command: &quot; + command;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            return &quot;ERROR|&quot; + e.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private String handleSend(String topic, String messageBody) throws IOException &#123;</span><br><span class="line">        byte[] body = messageBody.getBytes(StandardCharsets.UTF_8);</span><br><span class="line">        Message message = new Message(topic, body);</span><br><span class="line">        message.setStoreTimestamp(System.currentTimeMillis());</span><br><span class="line">        </span><br><span class="line">        storageEngine.putMessage(topic, message);</span><br><span class="line">        return &quot;SUCCESS|&quot; + message.getMessageId();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private String handlePull(ClientSession session, String topic, </span><br><span class="line">                             String consumerGroup, int batchSize) throws IOException &#123;</span><br><span class="line">        long offset = offsetManager.getOffset(topic, consumerGroup);</span><br><span class="line">        List&lt;Message&gt; messages = storageEngine.getMessages(topic, offset, batchSize);</span><br><span class="line">        </span><br><span class="line">        if (messages.isEmpty()) &#123;</span><br><span class="line">            return &quot;EMPTY&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        StringBuilder result = new StringBuilder();</span><br><span class="line">        result.append(&quot;SUCCESS|&quot;);</span><br><span class="line">        </span><br><span class="line">        for (int i = 0; i &lt; messages.size(); i++) &#123;</span><br><span class="line">            Message msg = messages.get(i);</span><br><span class="line">            result.append(msg.getMessageId()).append(&quot;:&quot;)</span><br><span class="line">                  .append(new String(msg.getBody(), StandardCharsets.UTF_8));</span><br><span class="line">            </span><br><span class="line">            if (i &lt; messages.size() - 1) &#123;</span><br><span class="line">                result.append(&quot;;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 更新session中的消息映射</span><br><span class="line">            session.addPendingMessage(msg.getMessageId(), offset + i);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return result.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private String handleAck(String topic, String consumerGroup, long offset) &#123;</span><br><span class="line">        offsetManager.updateOffset(topic, consumerGroup, offset);</span><br><span class="line">        return &quot;SUCCESS&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private String handleCreateTopic(String topic, int queueNum) &#123;</span><br><span class="line">        if (!topicQueues.containsKey(topic)) &#123;</span><br><span class="line">            List&lt;MessageQueue&gt; queues = new ArrayList&lt;&gt;();</span><br><span class="line">            for (int i = 0; i &lt; queueNum; i++) &#123;</span><br><span class="line">                queues.add(new MessageQueue(topic, i));</span><br><span class="line">            &#125;</span><br><span class="line">            topicQueues.put(topic, queues);</span><br><span class="line">            return &quot;SUCCESS|Topic created with &quot; + queueNum + &quot; queues&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;ERROR|Topic already exists&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void shutdown() throws IOException &#123;</span><br><span class="line">        running.set(false);</span><br><span class="line">        if (serverChannel != null) &#123;</span><br><span class="line">            serverChannel.close();</span><br><span class="line">        &#125;</span><br><span class="line">        if (selector != null) &#123;</span><br><span class="line">            selector.close();</span><br><span class="line">        &#125;</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        offsetManager.persist();</span><br><span class="line">        System.out.println(&quot;JMQ Broker shutdown&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 内部类</span><br><span class="line">    static class ClientSession &#123;</span><br><span class="line">        private final SocketChannel channel;</span><br><span class="line">        private final Map&lt;String, Long&gt; pendingMessages; // messageId -&gt; offset</span><br><span class="line">        </span><br><span class="line">        public ClientSession(SocketChannel channel) &#123;</span><br><span class="line">            this.channel = channel;</span><br><span class="line">            this.pendingMessages = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        public void addPendingMessage(String messageId, long offset) &#123;</span><br><span class="line">            pendingMessages.put(messageId, offset);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        public void removePendingMessage(String messageId) &#123;</span><br><span class="line">            pendingMessages.remove(messageId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    static class MessageQueue &#123;</span><br><span class="line">        private final String topic;</span><br><span class="line">        private final int queueId;</span><br><span class="line">        private final BlockingQueue&lt;Message&gt; queue;</span><br><span class="line">        </span><br><span class="line">        public MessageQueue(String topic, int queueId) &#123;</span><br><span class="line">            this.topic = topic;</span><br><span class="line">            this.queueId = queueId;</span><br><span class="line">            this.queue = new LinkedBlockingQueue&lt;&gt;(10000); // 队列容量</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        public boolean put(Message message) &#123;</span><br><span class="line">            return queue.offer(message);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        public Message take() throws InterruptedException &#123;</span><br><span class="line">            return queue.take();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        public Message poll(long timeout, TimeUnit unit) throws InterruptedException &#123;</span><br><span class="line">            return queue.poll(timeout, unit);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        public int size() &#123;</span><br><span class="line">            return queue.size();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-消费者偏移量管理器"><a href="#4-消费者偏移量管理器" class="headerlink" title="4. 消费者偏移量管理器"></a>4. 消费者偏移量管理器</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">// ConsumerOffsetManager.java</span><br><span class="line">package com.jmq.core.store;</span><br><span class="line"></span><br><span class="line">import java.io.*;</span><br><span class="line">import java.nio.file.Files;</span><br><span class="line">import java.nio.file.Path;</span><br><span class="line">import java.nio.file.Paths;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line">public class ConsumerOffsetManager &#123;</span><br><span class="line">    private final String offsetStorePath;</span><br><span class="line">    private final Map&lt;String, Long&gt; offsetMap; // key: topic@group, value: offset</span><br><span class="line">    private final Object persistLock = new Object();</span><br><span class="line">    </span><br><span class="line">    public ConsumerOffsetManager(String basePath) &#123;</span><br><span class="line">        this.offsetStorePath = basePath + File.separator + &quot;offsets&quot;;</span><br><span class="line">        this.offsetMap = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line">        initializeOffsetFile();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void initializeOffsetFile() &#123;</span><br><span class="line">        File offsetFile = new File(offsetStorePath);</span><br><span class="line">        if (!offsetFile.exists()) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                offsetFile.getParentFile().mkdirs();</span><br><span class="line">                offsetFile.createNewFile();</span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void load() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Path path = Paths.get(offsetStorePath);</span><br><span class="line">            if (!Files.exists(path)) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            try (BufferedReader reader = Files.newBufferedReader(path)) &#123;</span><br><span class="line">                String line;</span><br><span class="line">                while ((line = reader.readLine()) != null) &#123;</span><br><span class="line">                    String[] parts = line.split(&quot;:&quot;);</span><br><span class="line">                    if (parts.length == 2) &#123;</span><br><span class="line">                        String key = parts[0];</span><br><span class="line">                        long offset = Long.parseLong(parts[1]);</span><br><span class="line">                        offsetMap.put(key, offset);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void persist() &#123;</span><br><span class="line">        synchronized (persistLock) &#123;</span><br><span class="line">            try (BufferedWriter writer = Files.newBufferedWriter(Paths.get(offsetStorePath))) &#123;</span><br><span class="line">                for (Map.Entry&lt;String, Long&gt; entry : offsetMap.entrySet()) &#123;</span><br><span class="line">                    writer.write(entry.getKey() + &quot;:&quot; + entry.getValue());</span><br><span class="line">                    writer.newLine();</span><br><span class="line">                &#125;</span><br><span class="line">                writer.flush();</span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public long getOffset(String topic, String consumerGroup) &#123;</span><br><span class="line">        String key = generateKey(topic, consumerGroup);</span><br><span class="line">        return offsetMap.getOrDefault(key, 0L);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void updateOffset(String topic, String consumerGroup, long offset) &#123;</span><br><span class="line">        String key = generateKey(topic, consumerGroup);</span><br><span class="line">        offsetMap.put(key, offset);</span><br><span class="line">        </span><br><span class="line">        // 异步持久化</span><br><span class="line">        new Thread(() -&gt; &#123;</span><br><span class="line">            synchronized (persistLock) &#123;</span><br><span class="line">                persist();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private String generateKey(String topic, String consumerGroup) &#123;</span><br><span class="line">        return topic + &quot;@&quot; + consumerGroup;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-生产者客户端"><a href="#5-生产者客户端" class="headerlink" title="5. 生产者客户端"></a>5. 生产者客户端</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">// JMQProducer.java</span><br><span class="line">package com.jmq.client;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.net.InetSocketAddress;</span><br><span class="line">import java.nio.ByteBuffer;</span><br><span class="line">import java.nio.channels.SocketChannel;</span><br><span class="line">import java.nio.charset.StandardCharsets;</span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line">import java.util.concurrent.locks.Lock;</span><br><span class="line">import java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line">public class JMQProducer &#123;</span><br><span class="line">    private final String brokerAddress;</span><br><span class="line">    private final int brokerPort;</span><br><span class="line">    private SocketChannel channel;</span><br><span class="line">    private final Lock connectLock = new ReentrantLock();</span><br><span class="line">    private volatile boolean connected = false;</span><br><span class="line">    </span><br><span class="line">    public JMQProducer(String brokerAddress, int brokerPort) &#123;</span><br><span class="line">        this.brokerAddress = brokerAddress;</span><br><span class="line">        this.brokerPort = brokerPort;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void start() throws IOException &#123;</span><br><span class="line">        connect();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void connect() throws IOException &#123;</span><br><span class="line">        connectLock.lock();</span><br><span class="line">        try &#123;</span><br><span class="line">            if (!connected) &#123;</span><br><span class="line">                channel = SocketChannel.open();</span><br><span class="line">                channel.configureBlocking(true);</span><br><span class="line">                channel.connect(new InetSocketAddress(brokerAddress, brokerPort));</span><br><span class="line">                connected = true;</span><br><span class="line">                System.out.println(&quot;Producer connected to broker&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            connectLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public SendResult send(String topic, String message) throws IOException &#123;</span><br><span class="line">        return send(topic, message, 5000, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public SendResult send(String topic, String message, long timeout, TimeUnit unit) </span><br><span class="line">            throws IOException &#123;</span><br><span class="line">        connectIfNecessary();</span><br><span class="line">        </span><br><span class="line">        String request = String.format(&quot;SEND|%s|%s&quot;, topic, message);</span><br><span class="line">        ByteBuffer buffer = ByteBuffer.wrap(request.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        </span><br><span class="line">        long startTime = System.currentTimeMillis();</span><br><span class="line">        long timeoutMs = unit.toMillis(timeout);</span><br><span class="line">        </span><br><span class="line">        while (System.currentTimeMillis() - startTime &lt; timeoutMs) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                int bytesWritten = channel.write(buffer);</span><br><span class="line">                if (bytesWritten &gt; 0) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                Thread.sleep(10);</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">                return SendResult.failure(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 读取响应</span><br><span class="line">        ByteBuffer responseBuffer = ByteBuffer.allocate(1024);</span><br><span class="line">        channel.read(responseBuffer);</span><br><span class="line">        responseBuffer.flip();</span><br><span class="line">        String response = StandardCharsets.UTF_8.decode(responseBuffer).toString();</span><br><span class="line">        </span><br><span class="line">        if (response.startsWith(&quot;SUCCESS&quot;)) &#123;</span><br><span class="line">            String[] parts = response.split(&quot;\\|&quot;);</span><br><span class="line">            if (parts.length &gt; 1) &#123;</span><br><span class="line">                return SendResult.success(parts[1]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return SendResult.failure(new RuntimeException(&quot;Send failed: &quot; + response));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void connectIfNecessary() throws IOException &#123;</span><br><span class="line">        if (!connected) &#123;</span><br><span class="line">            connect();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void shutdown() throws IOException &#123;</span><br><span class="line">        if (channel != null &amp;&amp; channel.isOpen()) &#123;</span><br><span class="line">            channel.close();</span><br><span class="line">            connected = false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public static class SendResult &#123;</span><br><span class="line">        private final boolean success;</span><br><span class="line">        private final String messageId;</span><br><span class="line">        private final Exception exception;</span><br><span class="line">        </span><br><span class="line">        private SendResult(boolean success, String messageId, Exception exception) &#123;</span><br><span class="line">            this.success = success;</span><br><span class="line">            this.messageId = messageId;</span><br><span class="line">            this.exception = exception;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        public static SendResult success(String messageId) &#123;</span><br><span class="line">            return new SendResult(true, messageId, null);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        public static SendResult failure(Exception exception) &#123;</span><br><span class="line">            return new SendResult(false, null, exception);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        public boolean isSuccess() &#123; return success; &#125;</span><br><span class="line">        public String getMessageId() &#123; return messageId; &#125;</span><br><span class="line">        public Exception getException() &#123; return exception; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-消费者客户端"><a href="#6-消费者客户端" class="headerlink" title="6. 消费者客户端"></a>6. 消费者客户端</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">// JMQConsumer.java</span><br><span class="line">package com.jmq.client;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.net.InetSocketAddress;</span><br><span class="line">import java.nio.ByteBuffer;</span><br><span class="line">import java.nio.channels.SocketChannel;</span><br><span class="line">import java.nio.charset.StandardCharsets;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.concurrent.BlockingQueue;</span><br><span class="line">import java.util.concurrent.LinkedBlockingQueue;</span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">public class JMQConsumer &#123;</span><br><span class="line">    private final String brokerAddress;</span><br><span class="line">    private final int brokerPort;</span><br><span class="line">    private final String consumerGroup;</span><br><span class="line">    private SocketChannel channel;</span><br><span class="line">    private volatile boolean running = false;</span><br><span class="line">    private final BlockingQueue&lt;Message&gt; messageQueue = new LinkedBlockingQueue&lt;&gt;(1000);</span><br><span class="line">    private Thread pollThread;</span><br><span class="line">    </span><br><span class="line">    public JMQConsumer(String brokerAddress, int brokerPort, String consumerGroup) &#123;</span><br><span class="line">        this.brokerAddress = brokerAddress;</span><br><span class="line">        this.brokerPort = brokerPort;</span><br><span class="line">        this.consumerGroup = consumerGroup;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void start() throws IOException &#123;</span><br><span class="line">        connect();</span><br><span class="line">        running = true;</span><br><span class="line">        </span><br><span class="line">        pollThread = new Thread(() -&gt; &#123;</span><br><span class="line">            while (running) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    pollMessages();</span><br><span class="line">                    Thread.sleep(100); // 轮询间隔</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    if (running) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        pollThread.start();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void connect() throws IOException &#123;</span><br><span class="line">        channel = SocketChannel.open();</span><br><span class="line">        channel.configureBlocking(true);</span><br><span class="line">        channel.connect(new InetSocketAddress(brokerAddress, brokerPort));</span><br><span class="line">        System.out.println(&quot;Consumer connected to broker&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void subscribe(String topic) &#123;</span><br><span class="line">        // 订阅逻辑，这里简化处理</span><br><span class="line">        System.out.println(&quot;Subscribed to topic: &quot; + topic);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void pollMessages() throws IOException &#123;</span><br><span class="line">        String request = String.format(&quot;PULL|test-topic|%s|10&quot;, consumerGroup);</span><br><span class="line">        ByteBuffer buffer = ByteBuffer.wrap(request.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        channel.write(buffer);</span><br><span class="line">        </span><br><span class="line">        ByteBuffer responseBuffer = ByteBuffer.allocate(1024 * 1024); // 1MB</span><br><span class="line">        int bytesRead = channel.read(responseBuffer);</span><br><span class="line">        </span><br><span class="line">        if (bytesRead &gt; 0) &#123;</span><br><span class="line">            responseBuffer.flip();</span><br><span class="line">            String response = StandardCharsets.UTF_8.decode(responseBuffer).toString();</span><br><span class="line">            </span><br><span class="line">            if (response.startsWith(&quot;SUCCESS&quot;)) &#123;</span><br><span class="line">                String[] parts = response.split(&quot;\\|&quot;, 2);</span><br><span class="line">                if (parts.length &gt; 1) &#123;</span><br><span class="line">                    String[] messages = parts[1].split(&quot;;&quot;);</span><br><span class="line">                    for (String msg : messages) &#123;</span><br><span class="line">                        String[] msgParts = msg.split(&quot;:&quot;, 2);</span><br><span class="line">                        if (msgParts.length == 2) &#123;</span><br><span class="line">                            Message message = new Message(msgParts[0], msgParts[1]);</span><br><span class="line">                            messageQueue.offer(message);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public List&lt;Message&gt; poll(long timeout, TimeUnit unit) throws InterruptedException &#123;</span><br><span class="line">        List&lt;Message&gt; messages = new ArrayList&lt;&gt;();</span><br><span class="line">        Message message = messageQueue.poll(timeout, unit);</span><br><span class="line">        if (message != null) &#123;</span><br><span class="line">            messages.add(message);</span><br><span class="line">        &#125;</span><br><span class="line">        return messages;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void commitSync(String topic) throws IOException &#123;</span><br><span class="line">        // 提交消费偏移量</span><br><span class="line">        String request = String.format(&quot;ACK|%s|%s|%d&quot;, topic, consumerGroup, 0);</span><br><span class="line">        ByteBuffer buffer = ByteBuffer.wrap(request.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        channel.write(buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void shutdown() throws IOException, InterruptedException &#123;</span><br><span class="line">        running = false;</span><br><span class="line">        if (pollThread != null) &#123;</span><br><span class="line">            pollThread.join(5000);</span><br><span class="line">        &#125;</span><br><span class="line">        if (channel != null &amp;&amp; channel.isOpen()) &#123;</span><br><span class="line">            channel.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public static class Message &#123;</span><br><span class="line">        private final String messageId;</span><br><span class="line">        private final String body;</span><br><span class="line">        </span><br><span class="line">        public Message(String messageId, String body) &#123;</span><br><span class="line">            this.messageId = messageId;</span><br><span class="line">            this.body = body;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        public String getMessageId() &#123; return messageId; &#125;</span><br><span class="line">        public String getBody() &#123; return body; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-启动类"><a href="#7-启动类" class="headerlink" title="7. 启动类"></a>7. 启动类</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">// JMQLauncher.java</span><br><span class="line">package com.jmq;</span><br><span class="line"></span><br><span class="line">import com.jmq.core.broker.JMQBroker;</span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">public class JMQLauncher &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        if (args.length &lt; 1) &#123;</span><br><span class="line">            System.out.println(&quot;Usage: java JMQLauncher [broker|producer|consumer]&quot;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        String mode = args[0];</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            switch (mode) &#123;</span><br><span class="line">                case &quot;broker&quot;:</span><br><span class="line">                    startBroker();</span><br><span class="line">                    break;</span><br><span class="line">                case &quot;producer&quot;:</span><br><span class="line">                    startProducer();</span><br><span class="line">                    break;</span><br><span class="line">                case &quot;consumer&quot;:</span><br><span class="line">                    startConsumer();</span><br><span class="line">                    break;</span><br><span class="line">                default:</span><br><span class="line">                    System.out.println(&quot;Unknown mode: &quot; + mode);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private static void startBroker() throws IOException &#123;</span><br><span class="line">        JMQBroker broker = new JMQBroker(8888, &quot;./jmq-store&quot;);</span><br><span class="line">        broker.start();</span><br><span class="line">        </span><br><span class="line">        // 添加关闭钩子</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(new Thread(() -&gt; &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                broker.shutdown();</span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">        </span><br><span class="line">        // 保持运行</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(Long.MAX_VALUE);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private static void startProducer() throws IOException &#123;</span><br><span class="line">        JMQProducer producer = new JMQProducer(&quot;localhost&quot;, 8888);</span><br><span class="line">        producer.start();</span><br><span class="line">        </span><br><span class="line">        // 示例：发送10条消息</span><br><span class="line">        for (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">            String message = &quot;Test Message &quot; + i;</span><br><span class="line">            JMQProducer.SendResult result = producer.send(&quot;test-topic&quot;, message);</span><br><span class="line">            if (result.isSuccess()) &#123;</span><br><span class="line">                System.out.println(&quot;Message sent successfully: &quot; + result.getMessageId());</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                System.out.println(&quot;Failed to send message: &quot; + </span><br><span class="line">                    result.getException().getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            try &#123;</span><br><span class="line">                Thread.sleep(1000);</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private static void startConsumer() throws Exception &#123;</span><br><span class="line">        JMQConsumer consumer = new JMQConsumer(&quot;localhost&quot;, 8888, &quot;test-group&quot;);</span><br><span class="line">        consumer.start();</span><br><span class="line">        consumer.subscribe(&quot;test-topic&quot;);</span><br><span class="line">        </span><br><span class="line">        // 消费消息</span><br><span class="line">        for (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">            List&lt;JMQConsumer.Message&gt; messages = consumer.poll(5, TimeUnit.SECONDS);</span><br><span class="line">            for (JMQConsumer.Message msg : messages) &#123;</span><br><span class="line">                System.out.println(&quot;Received message: &quot; + msg.getMessageId() + </span><br><span class="line">                    &quot; - &quot; + msg.getBody());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 提交偏移量</span><br><span class="line">            consumer.commitSync(&quot;test-topic&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        consumer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="四、使用说明"><a href="#四、使用说明" class="headerlink" title="四、使用说明"></a>四、使用说明</h2><h3 id="1-编译和运行"><a href="#1-编译和运行" class="headerlink" title="1. 编译和运行"></a>1. 编译和运行</h3><p>bash</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 1. 编译项目</span><br><span class="line">javac -d . com/jmq/*.java com/jmq/core/**/*.java com/jmq/client/*.java</span><br><span class="line"></span><br><span class="line"># 2. 启动Broker</span><br><span class="line">java com.jmq.JMQLauncher broker</span><br><span class="line"></span><br><span class="line"># 3. 启动生产者（新终端）</span><br><span class="line">java com.jmq.JMQLauncher producer</span><br><span class="line"></span><br><span class="line"># 4. 启动消费者（新终端）</span><br><span class="line">java com.jmq.JMQLauncher consumer</span><br></pre></td></tr></table></figure>



<h3 id="2-Maven项目配置"><a href="#2-Maven项目配置" class="headerlink" title="2. Maven项目配置"></a>2. Maven项目配置</h3><p>xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- pom.xml --&gt;</span><br><span class="line">&lt;project&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">    &lt;groupId&gt;com.jmq&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;jmq&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0.0&lt;/version&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;maven.compiler.source&gt;8&lt;/maven.compiler.source&gt;</span><br><span class="line">        &lt;maven.compiler.target&gt;8&lt;/maven.compiler.target&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;!-- 添加需要的依赖 --&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>



<h3 id="3-API使用示例"><a href="#3-API使用示例" class="headerlink" title="3. API使用示例"></a>3. API使用示例</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">// 生产者示例</span><br><span class="line">public class ProducerExample &#123;</span><br><span class="line">    public static void main(String[] args) throws IOException &#123;</span><br><span class="line">        JMQProducer producer = new JMQProducer(&quot;localhost&quot;, 8888);</span><br><span class="line">        producer.start();</span><br><span class="line">        </span><br><span class="line">        // 发送消息</span><br><span class="line">        for (int i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">            String message = &quot;Order-&quot; + i;</span><br><span class="line">            JMQProducer.SendResult result = producer.send(&quot;orders&quot;, message);</span><br><span class="line">            </span><br><span class="line">            if (result.isSuccess()) &#123;</span><br><span class="line">                System.out.println(&quot;Message sent: &quot; + result.getMessageId());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 消费者示例</span><br><span class="line">public class ConsumerExample &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        JMQConsumer consumer = new JMQConsumer(&quot;localhost&quot;, 8888, &quot;order-processor&quot;);</span><br><span class="line">        consumer.start();</span><br><span class="line">        consumer.subscribe(&quot;orders&quot;);</span><br><span class="line">        </span><br><span class="line">        while (true) &#123;</span><br><span class="line">            List&lt;JMQConsumer.Message&gt; messages = consumer.poll(1, TimeUnit.SECONDS);</span><br><span class="line">            </span><br><span class="line">            for (JMQConsumer.Message msg : messages) &#123;</span><br><span class="line">                System.out.println(&quot;Processing order: &quot; + msg.getBody());</span><br><span class="line">                // 业务处理逻辑</span><br><span class="line">                </span><br><span class="line">                // 处理成功后确认消息</span><br><span class="line">                // consumer.commitSync(&quot;orders&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            Thread.sleep(100);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="五、测试用例"><a href="#五、测试用例" class="headerlink" title="五、测试用例"></a>五、测试用例</h2><h3 id="1-单元测试"><a href="#1-单元测试" class="headerlink" title="1. 单元测试"></a>1. 单元测试</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">// JMQBrokerTest.java</span><br><span class="line">package com.jmq.test;</span><br><span class="line"></span><br><span class="line">import com.jmq.core.broker.JMQBroker;</span><br><span class="line">import com.jmq.client.JMQProducer;</span><br><span class="line">import com.jmq.client.JMQConsumer;</span><br><span class="line">import org.junit.*;</span><br><span class="line"></span><br><span class="line">import java.io.File;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">import static org.junit.Assert.*;</span><br><span class="line"></span><br><span class="line">public class JMQBrokerTest &#123;</span><br><span class="line">    private static JMQBroker broker;</span><br><span class="line">    private static final String STORE_PATH = &quot;./test-store&quot;;</span><br><span class="line">    </span><br><span class="line">    @BeforeClass</span><br><span class="line">    public static void setUp() throws Exception &#123;</span><br><span class="line">        // 清理测试存储</span><br><span class="line">        cleanStore();</span><br><span class="line">        </span><br><span class="line">        // 启动Broker</span><br><span class="line">        broker = new JMQBroker(8889, STORE_PATH);</span><br><span class="line">        broker.start();</span><br><span class="line">        Thread.sleep(1000); // 等待broker启动</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @AfterClass</span><br><span class="line">    public static void tearDown() throws Exception &#123;</span><br><span class="line">        if (broker != null) &#123;</span><br><span class="line">            broker.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">        cleanStore();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private static void cleanStore() &#123;</span><br><span class="line">        File storeDir = new File(STORE_PATH);</span><br><span class="line">        if (storeDir.exists()) &#123;</span><br><span class="line">            deleteDirectory(storeDir);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private static void deleteDirectory(File dir) &#123;</span><br><span class="line">        if (dir.isDirectory()) &#123;</span><br><span class="line">            File[] children = dir.listFiles();</span><br><span class="line">            if (children != null) &#123;</span><br><span class="line">                for (File child : children) &#123;</span><br><span class="line">                    deleteDirectory(child);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        dir.delete();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Test</span><br><span class="line">    public void testSendAndConsume() throws Exception &#123;</span><br><span class="line">        // 创建生产者</span><br><span class="line">        JMQProducer producer = new JMQProducer(&quot;localhost&quot;, 8889);</span><br><span class="line">        producer.start();</span><br><span class="line">        </span><br><span class="line">        // 发送消息</span><br><span class="line">        String testMessage = &quot;Test Message 1&quot;;</span><br><span class="line">        JMQProducer.SendResult result = producer.send(&quot;test-topic&quot;, testMessage);</span><br><span class="line">        </span><br><span class="line">        assertTrue(&quot;Message should be sent successfully&quot;, result.isSuccess());</span><br><span class="line">        assertNotNull(&quot;Message ID should not be null&quot;, result.getMessageId());</span><br><span class="line">        </span><br><span class="line">        // 创建消费者</span><br><span class="line">        JMQConsumer consumer = new JMQConsumer(&quot;localhost&quot;, 8889, &quot;test-group&quot;);</span><br><span class="line">        consumer.start();</span><br><span class="line">        consumer.subscribe(&quot;test-topic&quot;);</span><br><span class="line">        </span><br><span class="line">        // 消费消息</span><br><span class="line">        List&lt;JMQConsumer.Message&gt; messages = consumer.poll(5, TimeUnit.SECONDS);</span><br><span class="line">        </span><br><span class="line">        assertFalse(&quot;Should receive messages&quot;, messages.isEmpty());</span><br><span class="line">        assertEquals(&quot;Should receive 1 message&quot;, 1, messages.size());</span><br><span class="line">        assertEquals(&quot;Message content should match&quot;, </span><br><span class="line">            testMessage, messages.get(0).getBody());</span><br><span class="line">        </span><br><span class="line">        // 清理</span><br><span class="line">        producer.shutdown();</span><br><span class="line">        consumer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Test</span><br><span class="line">    public void testBatchMessages() throws Exception &#123;</span><br><span class="line">        JMQProducer producer = new JMQProducer(&quot;localhost&quot;, 8889);</span><br><span class="line">        producer.start();</span><br><span class="line">        </span><br><span class="line">        // 发送10条消息</span><br><span class="line">        for (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">            producer.send(&quot;batch-topic&quot;, &quot;Batch Message &quot; + i);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        JMQConsumer consumer = new JMQConsumer(&quot;localhost&quot;, 8889, &quot;batch-group&quot;);</span><br><span class="line">        consumer.start();</span><br><span class="line">        consumer.subscribe(&quot;batch-topic&quot;);</span><br><span class="line">        </span><br><span class="line">        int receivedCount = 0;</span><br><span class="line">        for (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">            List&lt;JMQConsumer.Message&gt; messages = consumer.poll(2, TimeUnit.SECONDS);</span><br><span class="line">            receivedCount += messages.size();</span><br><span class="line">            </span><br><span class="line">            for (JMQConsumer.Message msg : messages) &#123;</span><br><span class="line">                System.out.println(&quot;Received: &quot; + msg.getBody());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        assertEquals(&quot;Should receive all 10 messages&quot;, 10, receivedCount);</span><br><span class="line">        </span><br><span class="line">        producer.shutdown();</span><br><span class="line">        consumer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Test</span><br><span class="line">    public void testConsumerOffset() throws Exception &#123;</span><br><span class="line">        JMQProducer producer = new JMQProducer(&quot;localhost&quot;, 8889);</span><br><span class="line">        producer.start();</span><br><span class="line">        </span><br><span class="line">        // 发送消息</span><br><span class="line">        producer.send(&quot;offset-topic&quot;, &quot;Message 1&quot;);</span><br><span class="line">        producer.send(&quot;offset-topic&quot;, &quot;Message 2&quot;);</span><br><span class="line">        </span><br><span class="line">        JMQConsumer consumer1 = new JMQConsumer(&quot;localhost&quot;, 8889, &quot;offset-group&quot;);</span><br><span class="line">        consumer1.start();</span><br><span class="line">        consumer1.subscribe(&quot;offset-topic&quot;);</span><br><span class="line">        </span><br><span class="line">        // 消费第一条消息</span><br><span class="line">        List&lt;JMQConsumer.Message&gt; messages = consumer1.poll(2, TimeUnit.SECONDS);</span><br><span class="line">        assertEquals(1, messages.size());</span><br><span class="line">        </span><br><span class="line">        consumer1.shutdown();</span><br><span class="line">        </span><br><span class="line">        // 重启消费者</span><br><span class="line">        JMQConsumer consumer2 = new JMQConsumer(&quot;localhost&quot;, 8889, &quot;offset-group&quot;);</span><br><span class="line">        consumer2.start();</span><br><span class="line">        consumer2.subscribe(&quot;offset-topic&quot;);</span><br><span class="line">        </span><br><span class="line">        // 应该从第二条消息开始消费</span><br><span class="line">        messages = consumer2.poll(2, TimeUnit.SECONDS);</span><br><span class="line">        assertEquals(&quot;Should start from second message&quot;, </span><br><span class="line">            &quot;Message 2&quot;, messages.get(0).getBody());</span><br><span class="line">        </span><br><span class="line">        producer.shutdown();</span><br><span class="line">        consumer2.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-性能测试"><a href="#2-性能测试" class="headerlink" title="2. 性能测试"></a>2. 性能测试</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">// PerformanceTest.java</span><br><span class="line">package com.jmq.test;</span><br><span class="line"></span><br><span class="line">import com.jmq.client.JMQProducer;</span><br><span class="line">import com.jmq.core.broker.JMQBroker;</span><br><span class="line">import org.junit.*;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line">public class PerformanceTest &#123;</span><br><span class="line">    private static JMQBroker broker;</span><br><span class="line">    private static final int PORT = 8890;</span><br><span class="line">    private static final String STORE_PATH = &quot;./perf-store&quot;;</span><br><span class="line">    </span><br><span class="line">    @BeforeClass</span><br><span class="line">    public static void setUp() throws Exception &#123;</span><br><span class="line">        broker = new JMQBroker(PORT, STORE_PATH);</span><br><span class="line">        broker.start();</span><br><span class="line">        Thread.sleep(2000);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @AfterClass</span><br><span class="line">    public static void tearDown() throws Exception &#123;</span><br><span class="line">        broker.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Test</span><br><span class="line">    public void testProducerThroughput() throws Exception &#123;</span><br><span class="line">        int messageCount = 10000;</span><br><span class="line">        ExecutorService executor = Executors.newFixedThreadPool(10);</span><br><span class="line">        CountDownLatch latch = new CountDownLatch(messageCount);</span><br><span class="line">        </span><br><span class="line">        long startTime = System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        for (int i = 0; i &lt; messageCount; i++) &#123;</span><br><span class="line">            final int index = i;</span><br><span class="line">            executor.submit(() -&gt; &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    JMQProducer producer = new JMQProducer(&quot;localhost&quot;, PORT);</span><br><span class="line">                    producer.start();</span><br><span class="line">                    producer.send(&quot;perf-topic&quot;, &quot;Message &quot; + index);</span><br><span class="line">                    producer.shutdown();</span><br><span class="line">                    latch.countDown();</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        latch.await();</span><br><span class="line">        long endTime = System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        long duration = endTime - startTime;</span><br><span class="line">        double throughput = (double) messageCount / duration * 1000;</span><br><span class="line">        </span><br><span class="line">        System.out.println(&quot;Total messages: &quot; + messageCount);</span><br><span class="line">        System.out.println(&quot;Total time: &quot; + duration + &quot;ms&quot;);</span><br><span class="line">        System.out.println(&quot;Throughput: &quot; + throughput + &quot; messages/second&quot;);</span><br><span class="line">        </span><br><span class="line">        executor.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Test</span><br><span class="line">    public void testLatency() throws Exception &#123;</span><br><span class="line">        JMQProducer producer = new JMQProducer(&quot;localhost&quot;, PORT);</span><br><span class="line">        producer.start();</span><br><span class="line">        </span><br><span class="line">        int samples = 1000;</span><br><span class="line">        long totalLatency = 0;</span><br><span class="line">        </span><br><span class="line">        for (int i = 0; i &lt; samples; i++) &#123;</span><br><span class="line">            long startTime = System.nanoTime();</span><br><span class="line">            producer.send(&quot;latency-topic&quot;, &quot;Test &quot; + i);</span><br><span class="line">            long endTime = System.nanoTime();</span><br><span class="line">            </span><br><span class="line">            totalLatency += (endTime - startTime);</span><br><span class="line">            </span><br><span class="line">            if (i % 100 == 0) &#123;</span><br><span class="line">                System.out.println(&quot;Sent &quot; + i + &quot; messages&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        double avgLatency = totalLatency / (double) samples / 1_000_000; // 转换为毫秒</span><br><span class="line">        System.out.println(&quot;Average latency: &quot; + avgLatency + &quot; ms&quot;);</span><br><span class="line">        </span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-集成测试"><a href="#3-集成测试" class="headerlink" title="3. 集成测试"></a>3. 集成测试</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">// IntegrationTest.java</span><br><span class="line">package com.jmq.test;</span><br><span class="line"></span><br><span class="line">import com.jmq.client.JMQProducer;</span><br><span class="line">import com.jmq.client.JMQConsumer;</span><br><span class="line">import org.junit.*;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.*;</span><br><span class="line">import java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line">public class IntegrationTest &#123;</span><br><span class="line">    private static JMQBroker broker;</span><br><span class="line">    </span><br><span class="line">    @BeforeClass</span><br><span class="line">    public static void setUp() throws Exception &#123;</span><br><span class="line">        broker = new JMQBroker(8891, &quot;./integration-store&quot;);</span><br><span class="line">        broker.start();</span><br><span class="line">        Thread.sleep(2000);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @AfterClass</span><br><span class="line">    public static void tearDown() throws Exception &#123;</span><br><span class="line">        broker.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Test</span><br><span class="line">    public void testMultipleProducersConsumers() throws Exception &#123;</span><br><span class="line">        int producerCount = 5;</span><br><span class="line">        int consumerCount = 3;</span><br><span class="line">        int messagesPerProducer = 100;</span><br><span class="line">        </span><br><span class="line">        ExecutorService producerExecutor = Executors.newFixedThreadPool(producerCount);</span><br><span class="line">        ExecutorService consumerExecutor = Executors.newFixedThreadPool(consumerCount);</span><br><span class="line">        </span><br><span class="line">        AtomicInteger totalProduced = new AtomicInteger(0);</span><br><span class="line">        AtomicInteger totalConsumed = new AtomicInteger(0);</span><br><span class="line">        CountDownLatch producerLatch = new CountDownLatch(producerCount);</span><br><span class="line">        CountDownLatch consumerLatch = new CountDownLatch(consumerCount);</span><br><span class="line">        </span><br><span class="line">        BlockingQueue&lt;String&gt; messageQueue = new LinkedBlockingQueue&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        // 启动生产者</span><br><span class="line">        for (int p = 0; p &lt; producerCount; p++) &#123;</span><br><span class="line">            final int producerId = p;</span><br><span class="line">            producerExecutor.submit(() -&gt; &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    JMQProducer producer = new JMQProducer(&quot;localhost&quot;, 8891);</span><br><span class="line">                    producer.start();</span><br><span class="line">                    </span><br><span class="line">                    for (int i = 0; i &lt; messagesPerProducer; i++) &#123;</span><br><span class="line">                        String message = String.format(&quot;Producer-%d-Message-%d&quot;, </span><br><span class="line">                            producerId, i);</span><br><span class="line">                        producer.send(&quot;integration-topic&quot;, message);</span><br><span class="line">                        totalProduced.incrementAndGet();</span><br><span class="line">                        messageQueue.put(message);</span><br><span class="line">                        </span><br><span class="line">                        if (i % 20 == 0) &#123;</span><br><span class="line">                            Thread.sleep(10);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    producer.shutdown();</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    producerLatch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 启动消费者</span><br><span class="line">        for (int c = 0; c &lt; consumerCount; c++) &#123;</span><br><span class="line">            final int consumerId = c;</span><br><span class="line">            consumerExecutor.submit(() -&gt; &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    JMQConsumer consumer = new JMQConsumer(&quot;localhost&quot;, 8891, </span><br><span class="line">                        &quot;integration-group-&quot; + consumerId);</span><br><span class="line">                    consumer.start();</span><br><span class="line">                    consumer.subscribe(&quot;integration-topic&quot;);</span><br><span class="line">                    </span><br><span class="line">                    int consumed = 0;</span><br><span class="line">                    long startTime = System.currentTimeMillis();</span><br><span class="line">                    long timeout = 30000; // 30秒超时</span><br><span class="line">                    </span><br><span class="line">                    while (consumed &lt; messagesPerProducer * 2 &amp;&amp; </span><br><span class="line">                           System.currentTimeMillis() - startTime &lt; timeout) &#123;</span><br><span class="line">                        var messages = consumer.poll(1, TimeUnit.SECONDS);</span><br><span class="line">                        </span><br><span class="line">                        for (var msg : messages) &#123;</span><br><span class="line">                            totalConsumed.incrementAndGet();</span><br><span class="line">                            consumed++;</span><br><span class="line">                            </span><br><span class="line">                            // 验证消息格式</span><br><span class="line">                            assertTrue(&quot;Message should contain Producer prefix&quot;,</span><br><span class="line">                                msg.getBody().startsWith(&quot;Producer-&quot;));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    consumer.shutdown();</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    consumerLatch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 等待所有任务完成</span><br><span class="line">        producerLatch.await(60, TimeUnit.SECONDS);</span><br><span class="line">        consumerLatch.await(60, TimeUnit.SECONDS);</span><br><span class="line">        </span><br><span class="line">        System.out.println(&quot;Total produced: &quot; + totalProduced.get());</span><br><span class="line">        System.out.println(&quot;Total consumed: &quot; + totalConsumed.get());</span><br><span class="line">        </span><br><span class="line">        // 验证消息不丢失</span><br><span class="line">        assertTrue(&quot;Should produce all messages&quot;, </span><br><span class="line">            totalProduced.get() &gt;= producerCount * messagesPerProducer);</span><br><span class="line">        </span><br><span class="line">        producerExecutor.shutdown();</span><br><span class="line">        consumerExecutor.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Test</span><br><span class="line">    public void testMessageOrder() throws Exception &#123;</span><br><span class="line">        JMQProducer producer = new JMQProducer(&quot;localhost&quot;, 8891);</span><br><span class="line">        producer.start();</span><br><span class="line">        </span><br><span class="line">        // 发送顺序消息</span><br><span class="line">        for (int i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">            producer.send(&quot;order-topic&quot;, &quot;Message-&quot; + i);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        JMQConsumer consumer = new JMQConsumer(&quot;localhost&quot;, 8891, &quot;order-group&quot;);</span><br><span class="line">        consumer.start();</span><br><span class="line">        consumer.subscribe(&quot;order-topic&quot;);</span><br><span class="line">        </span><br><span class="line">        int lastNumber = -1;</span><br><span class="line">        for (int i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">            var messages = consumer.poll(2, TimeUnit.SECONDS);</span><br><span class="line">            </span><br><span class="line">            for (var msg : messages) &#123;</span><br><span class="line">                String body = msg.getBody();</span><br><span class="line">                int currentNumber = Integer.parseInt(body.substring(&quot;Message-&quot;.length()));</span><br><span class="line">                </span><br><span class="line">                // 验证消息顺序</span><br><span class="line">                assertEquals(&quot;Messages should be in order&quot;, </span><br><span class="line">                    lastNumber + 1, currentNumber);</span><br><span class="line">                </span><br><span class="line">                lastNumber = currentNumber;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        producer.shutdown();</span><br><span class="line">        consumer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="六、部署和生产建议"><a href="#六、部署和生产建议" class="headerlink" title="六、部署和生产建议"></a>六、部署和生产建议</h2><h3 id="1-配置文件"><a href="#1-配置文件" class="headerlink" title="1. 配置文件"></a>1. 配置文件</h3><p>properties</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># jmq.properties</span><br><span class="line">broker.port=8888</span><br><span class="line">store.path=/data/jmq/store</span><br><span class="line">log.level=INFO</span><br><span class="line"></span><br><span class="line"># 网络配置</span><br><span class="line">network.io.threads=8</span><br><span class="line">network.worker.threads=16</span><br><span class="line"></span><br><span class="line"># 存储配置</span><br><span class="line">store.max.file.size=1073741824  # 1GB</span><br><span class="line">store.flush.interval=1000      # 1秒刷盘一次</span><br><span class="line">store.cleanup.policy=DELETE</span><br><span class="line">store.retention.hours=72</span><br><span class="line"></span><br><span class="line"># 内存配置</span><br><span class="line">memory.page.cache.size=536870912  # 512MB</span><br><span class="line">memory.queue.size=10000</span><br><span class="line"></span><br><span class="line"># 集群配置（如果启用集群）</span><br><span class="line">cluster.enabled=false</span><br><span class="line">cluster.nodes=node1:8888,node2:8888,node3:8888</span><br><span class="line">cluster.replication.factor=2</span><br></pre></td></tr></table></figure>



<h3 id="2-监控指标"><a href="#2-监控指标" class="headerlink" title="2. 监控指标"></a>2. 监控指标</h3><p>java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// 可以添加的监控指标</span><br><span class="line">public class JMQMetrics &#123;</span><br><span class="line">    // 消息吞吐量</span><br><span class="line">    private volatile long messagesInPerSecond;</span><br><span class="line">    private volatile long messagesOutPerSecond;</span><br><span class="line">    </span><br><span class="line">    // 延迟指标</span><br><span class="line">    private volatile long avgProduceLatency;</span><br><span class="line">    private volatile long avgConsumeLatency;</span><br><span class="line">    </span><br><span class="line">    // 存储指标</span><br><span class="line">    private volatile long diskUsageBytes;</span><br><span class="line">    private volatile int topicCount;</span><br><span class="line">    </span><br><span class="line">    // 连接指标</span><br><span class="line">    private volatile int activeConnections;</span><br><span class="line">    private volatile int totalConnections;</span><br><span class="line">    </span><br><span class="line">    // 队列深度</span><br><span class="line">    private volatile Map&lt;String, Integer&gt; topicQueueDepths;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-扩展建议"><a href="#3-扩展建议" class="headerlink" title="3. 扩展建议"></a>3. 扩展建议</h3><ol>
<li><strong>集群支持</strong>：实现主从复制、故障转移</li>
<li><strong>事务消息</strong>：支持分布式事务</li>
<li><strong>消息过滤</strong>：基于SQL92或tag过滤</li>
<li><strong>死信队列</strong>：处理无法消费的消息</li>
<li><strong>监控报警</strong>：集成Prometheus和Grafana</li>
<li><strong>管理控制台</strong>：Web UI管理界面</li>
<li><strong>多协议支持</strong>：支持HTTP、gRPC等协议</li>
</ol>
<p>这个实现提供了一个生产级消息队列的基础框架，具有完整的核心功能。实际生产环境中，还需要考虑更多的优化和安全措施。</p>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">
    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/25278399.html" rel="prev" title="Java RPC框架设计与实现">
                  <i class="fa fa-angle-left"></i> Java RPC框架设计与实现
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/9f126af1.html" rel="next" title="C语言HTTP服务器设计与实现">
                  C语言HTTP服务器设计与实现 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa-regular fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder"></span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Word count total">344k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">20:53</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>

  <script class="next-config" data-name="wavedrom" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/wavedrom.min.js","integrity":"sha256-INLAoJc6quTNfiMWkGZniYO2cxE8mHpddnLow1m6RFs="}}</script>
  <script class="next-config" data-name="wavedrom_skin" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/skins/default.js","integrity":"sha256-fduc/Zszk5ezWws2uInY/ALWVmIrmV6VTgXbsYSReFI="}}</script>
  <script src="/js/third-party/tags/wavedrom.js"></script>




  





</body>
</html>
